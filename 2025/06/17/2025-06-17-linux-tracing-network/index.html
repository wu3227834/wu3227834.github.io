<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><meta property="og:description" content="这里是小布丁的私有小屋"><meta property="og:type" content="website"><meta name="keywords" content="Linux网络性能, 带宽吞吐量, C10K问题, iperf3, 网络调优,"><meta name="description" content="本文介绍 Linux 网络性能指标、调优方法及 C10K/C1000K 问题的应对策略"><link rel="shortcut icon" href="/img/favicon.ico"><title>Linux性能调优：网络</title><link rel="stylesheet" href="/css/aircloud.css"><link rel="stylesheet" href="/css/gitment.css"><link rel="stylesheet" href="/css/prism.css"><link href="//at.alicdn.com/t/font_620856_28hi1hpxx24.css" rel="stylesheet" type="text/css"><script></script><script defer src="https://cloud.umami.is/script.js" data-website-id="bad0a741-25cb-4dd6-bbcf-f5710aeb243c"></script><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="Pudding 日常" type="application/atom+xml"></head><body><div class="site-nav-toggle" id="site-nav-toggle"><button><span class="btn-bar"></span> <span class="btn-bar"></span> <span class="btn-bar"></span></button></div><div class="index-about"><i>a week is 2% of the year</i></div><div class="index-container"><div class="index-left"><div class="nav" id="nav"><div class="avatar-name"><div class="avatar"><img src="/img/avatar.png"></div><div class="name"><i>Pudding</i></div></div><div class="contents" id="nav-content"><ul><li><a href="/"><i class="iconfont icon-shouye1"></i> <span>主页</span></a></li><li><a href="/tags"><i class="iconfont icon-biaoqian1"></i> <span>标签</span></a></li><li><a href="/archive"><i class="iconfont icon-guidang2"></i> <span>存档</span></a></li><li><a href="/about/"><i class="iconfont icon-guanyu2"></i> <span>关于</span></a></li><li><a id="search"><i class="iconfont icon-sousuo1"></i> <span>搜索</span></a></li></ul></div><div id="toc" class="toc-article"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Linux%E7%BD%91%E7%BB%9C%E6%80%A7%E8%83%BD%E6%8C%87%E6%A0%87"><span class="toc-text">Linux网络性能指标</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%80%A7%E8%83%BD%E6%8C%87%E6%A0%87"><span class="toc-text">性能指标</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BD%91%E7%BB%9C%E9%85%8D%E7%BD%AE"><span class="toc-text">网络配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B5%8C%E5%A5%97%E5%AD%97%E4%BF%A1%E6%81%AF"><span class="toc-text">嵌套字信息</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8D%8F%E8%AE%AE%E6%A0%88%E7%BB%9F%E8%AE%A1%E4%BF%A1%E6%81%AF"><span class="toc-text">协议栈统计信息</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BD%91%E7%BB%9C%E5%90%9E%E5%90%90-%E5%92%8C-PPS"><span class="toc-text">网络吞吐 和 PPS</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BF%9E%E9%80%9A%E6%80%A7%E5%92%8C%E5%BB%B6%E6%97%B6"><span class="toc-text">连通性和延时</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#C10K%E5%92%8CC100K%E9%97%AE%E9%A2%98"><span class="toc-text">C10K和C100K问题</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#C10K"><span class="toc-text">C10K</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#I-O-%E6%A8%A1%E5%9E%8B%E4%BC%98%E5%8C%96"><span class="toc-text">I&#x2F;O 模型优化</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B7%A5%E4%BD%9C%E6%A8%A1%E5%9E%8B%E4%BC%98%E5%8C%96"><span class="toc-text">工作模型优化</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#C1000K"><span class="toc-text">C1000K</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#C10M"><span class="toc-text">C10M</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%8E%E4%B9%88%E8%AF%84%E4%BC%B0%E7%B3%BB%E7%BB%9F%E7%9A%84%E7%BD%91%E7%BB%9C%E6%80%A7%E8%83%BD"><span class="toc-text">怎么评估系统的网络性能</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%84%E5%8D%8F%E8%AE%AE%E5%B1%82%E7%9A%84%E6%80%A7%E8%83%BD%E6%B5%8B%E8%AF%95"><span class="toc-text">各协议层的性能测试</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BD%AC%E5%8F%91%E6%80%A7%E8%83%BD"><span class="toc-text">转发性能</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#TCP-UDP-%E6%80%A7%E8%83%BD"><span class="toc-text">TCP&#x2F;UDP 性能</span></a></li></ol></li></ol></li></ol></div></div><div class="search-field" id="search-field"><div class="search-bg" id="search-bg"></div><div class="search-container"><div class="search-input"><span id="esc-search"><i class="icon-fanhui iconfont"></i></span> <input id="search-input"> <span id="begin-search">搜索</span></div><div class="search-result-container" id="search-result-container"></div></div></div><div class="index-about-mobile"><i>a week is 2% of the year</i></div></div><div class="index-middle"><div class="post-container"><div class="post-title">Linux性能调优：网络</div><div class="post-meta"><span class="attr">发布于：<span>2025-06-17</span></span> <span class="attr">标签：/ <a class="tag" href="/tags/#Linux" title="Linux">Linux</a> <span>/</span> <a class="tag" href="/tags/#性能测试" title="性能测试">性能测试</a> <span>/</span> </span><span class="attr">访问：<span id="busuanzi_value_page_pv"></span></span></div><div class="post-content no-indent"><h2 id="Linux网络性能指标"><a href="#Linux网络性能指标" class="headerlink" title="Linux网络性能指标"></a>Linux网络性能指标</h2><h3 id="性能指标"><a href="#性能指标" class="headerlink" title="性能指标"></a>性能指标</h3><ul><li>带宽，表示链路的<strong>最大传输速率</strong>，单位通常为 b/s（比特/秒）</li><li>吞吐量，表示单位时间内成功传输的数据量，单位通常为 b/s（比特/秒）或者 B/s(字节/秒)。<strong>吞吐量受带宽限制</strong>，而吞吐量/带宽，也就是该网络的使用率</li><li>延时，表示从网络请求发出后，一直到收到远端响应，所需要的时间延迟。在不同场景中，这一指标可能会有不同的涵义。比如，它可以表示，建立连接需要的时间（比如 TCP 握手延时），或一个数据包往返所需的时间（比如 RTT）</li><li>PSS，是 Packet Per Second（包/秒）的缩写，表示以<strong>网络包为单位的传输速率</strong>。PSS 通常用来评估<strong>网络的转发能力</strong>，比如硬件交换机，通常可以达到线性转发（即 PPS 可以达到或者接近理论最大值）。而基于 Linux 服务器的转发，则容易受网络包大小的影响</li></ul><p>另外，<strong>网络的可用性</strong>（网络能否正常通信）、<strong>并发连接数</strong>（TCP 连接数量）、<strong>丢包率</strong>（丢包百分比）、<strong>重传率</strong>（重新传输的网络包比例）等也是常用的性能指标。</p><h3 id="网络配置"><a href="#网络配置" class="headerlink" title="网络配置"></a>网络配置</h3><p>使用命令 ifconfig 或者 ip 查看</p><figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">$ ifconfig eth1</span><br><span class="line">eth1: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500</span><br><span class="line">        inet 9.134.194.74  netmask 255.255.248.0  broadcast 9.134.199.255</span><br><span class="line">        ether 52:54:00:82:12:e8  txqueuelen<span class="number"> 1000 </span> (Ethernet)</span><br><span class="line">        RX packets<span class="number"> 70297502 </span> bytes<span class="number"> 34143392231 </span>(31.7 GiB)</span><br><span class="line">        RX errors<span class="number"> 0 </span> dropped<span class="number"> 0 </span> overruns<span class="number"> 0 </span> frame 0</span><br><span class="line">        TX packets<span class="number"> 78816203 </span> bytes<span class="number"> 45528648722 </span>(42.4 GiB)</span><br><span class="line">        TX errors<span class="number"> 0 </span> dropped<span class="number"> 0 </span>overruns<span class="number"> 0 </span> carrier<span class="number"> 0 </span> collisions 0</span><br><span class="line"></span><br><span class="line">$ ip -s  addr show dev eth1</span><br><span class="line">2: eth1: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu<span class="number"> 1500 </span>qdisc mq state UP qlen 1000</span><br><span class="line">    link/ether 52:54:00:82:12:e8 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 9.134.194.74/21 brd 9.134.199.255 scope global eth1</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    RX: bytes  packets  errors  dropped overrun mcast   </span><br><span class="line">   <span class="number"> 34143407013 </span>70297654<span class="number"> 0 </span>     <span class="number"> 0 </span>     <span class="number"> 0 </span>     <span class="number"> 0 </span>      </span><br><span class="line">    TX: bytes  packets  errors  dropped carrier collsns </span><br><span class="line">   <span class="number"> 45528723929 </span>78816328<span class="number"> 0 </span>     <span class="number"> 0 </span>     <span class="number"> 0 </span>     <span class="number"> 0 </span> </span><br></pre></td></tr></table></figure><p>第一，网络接口的状态标志。ifconfig 输出 RUNNING，或者 ip 输出中的 LOWER_UP，都表示物理网络是连通，即网卡已经连接到了交换机或者路由器中。如果你看不到它们，通常表示网线被拔掉了。</p><p>第二，MTU 的大小。MTU 默认大小是 1500，根据网络架构的不同（比如是否使用了 VXLAN 等叠加网络），你可能需要调大或者调小 MTU 的数值。</p><p>第三，网络接口的 IP 地址、子网以及 MAC 地址。这些地址都是保障网络功能正常工作所必须的，你需要确保配置正确。</p><p>第四，网络收发的字节数、包数、错误数以及丢包情况，特别是 TX 和 RX 部分的 errors、dropped、overruns、carrier 以及 collisions 等指标不为 0 时，通常表示出现了网络 I/O 问题。其中：</p><ul><li>errors 表示发生错误的数据包数，比如校验错误、帧同步错误等</li><li>dropped 表示丢弃的数据包数，即数据包已经收到了 Ring Buffer，但因为内存不足等原因丢包</li><li>overruns 表示超限数据丢包数，即网络 I/O 速度过快，导致 Ring Buffer 中的数据包来不及处理（队列满）而导致的丢包</li><li>carrier 表示发生 carrirer 错误的数据报数，比如双工模式不匹配、物理电缆出现问题等</li><li>collisions 表示碰撞数据包数</li></ul><h3 id="嵌套字信息"><a href="#嵌套字信息" class="headerlink" title="嵌套字信息"></a>嵌套字信息</h3><p>使用 netstat 或 ss 来表示<strong>嵌套字、网络栈、网络接口以及路由表的信息</strong></p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ netstat -nlp | head -n <span class="number">3</span></span><br><span class="line">Active Internet connections (<span class="keyword">only</span> servers)</span><br><span class="line">Proto Recv-Q Send-Q <span class="keyword">Local</span> Address           <span class="keyword">Foreign</span> Address         State       PID/Program <span class="type">name</span></span><br><span class="line">tcp        <span class="number">0</span>      <span class="number">0</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">10248</span>         <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>:*               <span class="keyword">LISTEN</span>      <span class="number">624565</span>/kubelet</span><br><span class="line"></span><br><span class="line">$ ss -ltnp | head -n <span class="number">3</span></span><br><span class="line">State      Recv-Q Send-Q <span class="keyword">Local</span> Address:Port               Peer Address:Port</span><br><span class="line"><span class="keyword">LISTEN</span>     <span class="number">0</span>      <span class="number">65535</span>  <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">10248</span>                    *:*                   users:((&quot;kubelet&quot;,pid=<span class="number">624565</span>,fd=<span class="number">29</span>))</span><br><span class="line"><span class="keyword">LISTEN</span>     <span class="number">0</span>      <span class="number">65535</span>  <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">10249</span>                    *:*                   users:((&quot;kube-proxy&quot;,pid=<span class="number">624952</span>,fd=<span class="number">12</span>))</span><br></pre></td></tr></table></figure><p>其中，<strong>接收队列（Recv-Q）和发送队列（Send-Q）</strong>需要关注，它们通常是 0。当你发现它们不是 0 时，说明有网络包的堆积发生</p><p>当嵌套字处于连接状态（Established）时，</p><ul><li>Recv-Q 表示嵌套字缓冲还没有被应用程序取走的字节数（即接收队列长度）</li><li>Send-Q 表示还没有被远端主机确认的字节数（即发送队列长度）</li></ul><p>当嵌套字处于监听状态（Listening）时，</p><ul><li>Recv-Q 表示当前全连接队列（accept 队列）长度</li><li>Send-Q 表示全连接队列的最大长度</li></ul><h3 id="协议栈统计信息"><a href="#协议栈统计信息" class="headerlink" title="协议栈统计信息"></a>协议栈统计信息</h3><p>使用 netstat 或 ss 命令</p><figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">$ netstat -s</span><br><span class="line">Ip:</span><br><span class="line">   <span class="number"> 11236847787 </span>total packets received</span><br><span class="line">   <span class="number"> 76906 </span>forwarded</span><br><span class="line">   <span class="number"> 0 </span>incoming packets discarded</span><br><span class="line">   <span class="number"> 10964584370 </span>incoming packets delivered</span><br><span class="line">   <span class="number"> 10948611259 </span>requests sent out</span><br><span class="line">   <span class="number"> 448 </span>outgoing packets dropped</span><br><span class="line">   <span class="number"> 4 </span>dropped because of missing route</span><br><span class="line">Icmp:</span><br><span class="line">   <span class="number"> 37370022 </span>ICMP messages received</span><br><span class="line">   <span class="number"> 158 </span>input ICMP message failed.</span><br><span class="line">    ICMP input histogram:</span><br><span class="line">        destination unreachable: 141016</span><br><span class="line">        echo requests: 20256273</span><br><span class="line">        echo replies: 16972733</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">[root@pudding-161 ~]<span class="comment"># ss -s</span></span><br><span class="line">Total:<span class="number"> 1434 </span>(kernel 1816)</span><br><span class="line">TCP:  <span class="number"> 1144 </span>(estab 894, closed 164, orphaned 0, synrecv 0, timewait 158/0), ports 0</span><br><span class="line"></span><br><span class="line">Transport Total     IP        IPv6</span><br><span class="line">*        <span class="number"> 1816 </span>     -         -</span><br><span class="line">RAW      <span class="number"> 2 </span>       <span class="number"> 1 </span>        1</span><br><span class="line">UDP      <span class="number"> 13 </span>      <span class="number"> 7 </span>        6</span><br><span class="line">TCP      <span class="number"> 980 </span>     <span class="number"> 349 </span>      631</span><br><span class="line">INET     <span class="number"> 995 </span>     <span class="number"> 357 </span>      638</span><br><span class="line">FRAG     <span class="number"> 0 </span>       <span class="number"> 0 </span>        0</span><br></pre></td></tr></table></figure><h3 id="网络吞吐-和-PPS"><a href="#网络吞吐-和-PPS" class="headerlink" title="网络吞吐 和 PPS"></a>网络吞吐 和 PPS</h3><p>使用 sar 命令，加上 -n 参数，可以查看网络的统计信息，比如网络接口（DEV）、网络接口错误（EDEV）、TCP、UDP、ICMP 等</p><figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ sar <span class="operator">-</span>n DEV <span class="number">1</span></span><br><span class="line">Linux <span class="number">3.10</span>.<span class="number">0</span><span class="operator">-</span><span class="number">957</span>.el7.x86_64 (xxx)       <span class="number">06</span><span class="symbol">/18/2025</span>      _x86_64_        (<span class="number">8</span> CPU)</span><br><span class="line"></span><br><span class="line"><span class="number">07</span>:<span class="number">20</span>:<span class="number">42</span> PM     IFACE   rxpck<span class="symbol">/s</span>   txpck<span class="symbol">/s</span>    rxkB<span class="symbol">/s</span>    txkB<span class="symbol">/s</span>   rxcmp<span class="symbol">/s</span>   txcmp<span class="symbol">/s</span>  rxmcst<span class="symbol">/s</span></span><br><span class="line"><span class="number">07</span>:<span class="number">20</span>:<span class="number">43</span> PM    dummy0      <span class="number">0.00</span>      <span class="number">0.00</span>      <span class="number">0.00</span>      <span class="number">0.00</span>      <span class="number">0.00</span>      <span class="number">0.00</span>      <span class="number">0.00</span></span><br><span class="line"><span class="number">07</span>:<span class="number">20</span>:<span class="number">43</span> PM      eth0    <span class="number">695.00</span>    <span class="number">663.00</span>   <span class="number">6938.75</span>   <span class="number">3796.65</span>      <span class="number">0.00</span>      <span class="number">0.00</span>      <span class="number">0.00</span></span><br><span class="line"><span class="number">07</span>:<span class="number">20</span>:<span class="number">43</span> PM        lo    <span class="number">112.00</span>    <span class="number">112.00</span>     <span class="number">39.30</span>     <span class="number">39.30</span>      <span class="number">0.00</span>      <span class="number">0.00</span>      <span class="number">0.00</span></span><br><span class="line"><span class="number">07</span>:<span class="number">20</span>:<span class="number">43</span> PM kube-ipvs0      <span class="number">0.00</span>      <span class="number">0.00</span>      <span class="number">0.00</span>      <span class="number">0.00</span>      <span class="number">0.00</span>      <span class="number">0.00</span>      <span class="number">0.00</span></span><br></pre></td></tr></table></figure><ul><li>rxpck/s 和 txpck/s 分别是接收和发送的 PPS，单位为包/秒</li><li>rxkB/s 和 txkB/s 分别是接收和发送的吞吐量，单位是 KB/s</li><li>rxcmp/s 和 txcmp/s 分别是接收和发送的压缩数据包数，单位是包/秒</li></ul><p>带宽可以用 ethtool 来查询，它的单位通常是 Gb/s 或者 Mb/s（千兆网卡或者万兆网卡的单位都是 bit）</p><figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ ethtool enp4s0f0 <span class="string">| grep Speed</span></span><br><span class="line">        Speed<span class="punctuation">:</span> <span class="number">1000</span>Mb/s</span><br></pre></td></tr></table></figure><h3 id="连通性和延时"><a href="#连通性和延时" class="headerlink" title="连通性和延时"></a>连通性和延时</h3><p>使用命令 ping，来测试远程主机的连通性和延时（基于 ICMP 协议）</p><p>如下，测试本机到 baidu.com 这个地址的连通性和延时</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$<span class="built_in"> ping </span>-c3 baidu.com<span class="built_in"></span></span><br><span class="line"><span class="built_in">PING </span>baidu.com (182.61.201.211) 56(84) bytes of data.</span><br><span class="line">64 bytes <span class="keyword">from</span> 182.61.201.211 (182.61.201.211): <span class="attribute">icmp_seq</span>=1 <span class="attribute">ttl</span>=49 <span class="attribute">time</span>=29.1 ms</span><br><span class="line">64 bytes <span class="keyword">from</span> 182.61.201.211 (182.61.201.211): <span class="attribute">icmp_seq</span>=2 <span class="attribute">ttl</span>=49 <span class="attribute">time</span>=27.2 ms</span><br><span class="line">64 bytes <span class="keyword">from</span> 182.61.201.211 (182.61.201.211): <span class="attribute">icmp_seq</span>=3 <span class="attribute">ttl</span>=49 <span class="attribute">time</span>=27.8 ms</span><br><span class="line"></span><br><span class="line">--- baidu.com<span class="built_in"> ping </span>statistics ---</span><br><span class="line">3 packets transmitted, 3 received, 0% packet loss, time 2002ms</span><br><span class="line">rtt min/avg/max/mdev = 27.280/28.097/29.158/0.785 ms</span><br></pre></td></tr></table></figure><p>ping 的输出，可以分为两部分：</p><ul><li>每个 ICMP 请求的信息，包括 ICMP 序列号（icmp_seq）、TTL（生存时间，或者跳数）以及往返延时</li><li>三次 ICMP 请求的汇总</li></ul><h2 id="C10K和C100K问题"><a href="#C10K和C100K问题" class="headerlink" title="C10K和C100K问题"></a>C10K和C100K问题</h2><h3 id="C10K"><a href="#C10K" class="headerlink" title="C10K"></a>C10K</h3><p>C10K 代表同时处理 10000 个请求</p><p>从资源上来说，对 2GB 内存和千兆网卡的服务器来说，同时处理 10000 个请求，只要每个请求处理占用不到 200KB（2GB/10000）的内存和 100Kbit（1000Mbit/10000）的网络带宽就可以。</p><p>从软件上来看，主要是网络 I/O 模型的问题，在 C10K 之前，Linux 主要是<strong>同步阻塞</strong>的方式，每个请求都分配一个进程或者线程，而 10000 个进程或者线程的调度、上下文切换和内存，都可能成为瓶颈。</p><p>需要解决的问题：</p><ul><li>怎样在一个线程内处理多个请求，也就是要在一个线程内响应多个网络 I/O？</li></ul><h4 id="I-O-模型优化"><a href="#I-O-模型优化" class="headerlink" title="I/O 模型优化"></a>I/O 模型优化</h4><p>异步、非阻塞 I/O 的思路：I/O 多路复用</p><blockquote><p>两种 I/O 时间通知的方式：水平触发和边缘触发<br>水平触发：只要文件描述符可以非阻塞地执行 I/O，就会触发通知。也就是说，应用程序可以随时检查文件描述符地状态，然后再根据状态，进行 I/O 操作。<br>边缘触发：只有在文件描述符的状态发生改变（也就是 I/O 请求达到）时，才会发送一次通知。这时候，应用程序需要尽可能多地执行 I/O，知道无法继续读写，才可以停止。如果 I/O 没执行完，或者因为某种原因没来得及处理，那么这次通知也就丢失了</p></blockquote><ul><li>第一种，使用非阻塞 I/O 和水平触发通知，比如使用 select 或者 poll</li><li>第二种，使用非阻塞 I/O 和边缘触发通知，比如 epoll（在 select 和 poll 基础上进行优化）</li><li>第三种，使用异步 I/O（Asynchronous I/O，简称为 AIO）</li></ul><h4 id="工作模型优化"><a href="#工作模型优化" class="headerlink" title="工作模型优化"></a>工作模型优化</h4><p>I/O 多路复用有两种主要的工作模式：</p><p><strong>第一种</strong>：主进程 + 多个 worker 子进程（比如 nginx），主要流程是：</p><ul><li>主进程执行 bind() + listen() 后，创建多个子进程；</li><li>在每个子进程中，都通过 accept() 或 epoll_wait() ，来处理相同的套接字</li></ul><p><img src="/img/2025-06-17-linux_tracing_network/image.png" alt="示意图"></p><p><strong>注意</strong>：accept() 和 epoll_wait() 调用，还存在一个<strong>惊群</strong>的问题（当网络 I/O 事件发生时，多个进程被同时唤醒，但实际上只有一个进程来响应这个事件，其他被唤醒的进程都会重新休眠）</p><p>为了避免<strong>惊群问题</strong>，Nginx 在每个 worker 进程中，都会增加一个全局锁（accept_mutex）。这些 worder 进程需要首先竞争到锁，只有竞争到锁的进程，才会加入到 epoll 中，这样就确保只有一个 worker 子进程被唤醒</p><p><strong>第二种</strong>：监听到相同端口的多进程模型，所有的进程都监听相同的端口，有各自的套接字，开启 SO_REUSEPORT 选项（Linux 3.9+ 才支持），由内核负责将请求负载均衡到这些监听进程中去</p><p><img src="/img/2025-06-17-linux_tracing_network/image2.png" alt="示意图"></p><h3 id="C1000K"><a href="#C1000K" class="headerlink" title="C1000K"></a>C1000K</h3><p>C1000K 代表同时 100w 个请求</p><ul><li>从物理资源上来说，100 万个请求需要大量的系统资源<ul><li>内存：假设每个请求需要 16KB 内存的化，那么总共就需要大约 15GB 内存</li><li>带宽：假设只有 20% 活跃连接，即使每个连接只需要 1KB/s 的吞吐量，总共需要 200000 * 8 / 1024 / 1024 = 1.6 Gb/s 的吞吐量，千兆网卡已经不能够满足，需要配置万兆网卡</li></ul></li><li>从软件资源上来说，大量的连接也会占用大量的软件资源，比如<strong>文件描述符的数据、连接状态的跟踪（CONNTRACK）、网络协议栈的缓存大小（比如套接字读写缓存、TCP 读写缓存）</strong>等等，也会带来<strong>大量的中断处理</strong></li></ul><p><strong>优化</strong>：在 I/O 多路复用的基础上，需要多队列网卡、硬中断负载均衡、CPU 绑定、RPS/RFS（软中断负载均衡到多个 CPU 核上），以及将网络包的处理卸载（Offload）到网络设备（如 TSO/GSO、LRO/GRO、VXLAN OFFLOAD）等各种硬件和软件的优化。</p><h3 id="C10M"><a href="#C10M" class="headerlink" title="C10M"></a>C10M</h3><p>同时有 1000w 个请求，解决方法是<strong>跳过内核协议栈</strong>，将网络包直接发送到要处理的应用程序</p><p>第一种机制：DPDK（Data Plane Development Kit），用户网络的标准，跳过内核协议栈，直接由用户态进程通过轮询的方式来处理网络请求</p><p><img src="/img/2025-06-17-linux_tracing_network/image3.png" alt="示意图"></p><p>第二种机制：XDP（eXpress Data Path），Linux 内核提供的一种高性能网络数据路径，它允许网络包，在进入内核协议栈之前，就进行处理</p><p><img src="/img/2025-06-17-linux_tracing_network/image4.png" alt="示意图"></p><h2 id="怎么评估系统的网络性能"><a href="#怎么评估系统的网络性能" class="headerlink" title="怎么评估系统的网络性能"></a>怎么评估系统的网络性能</h2><h3 id="各协议层的性能测试"><a href="#各协议层的性能测试" class="headerlink" title="各协议层的性能测试"></a>各协议层的性能测试</h3><h4 id="转发性能"><a href="#转发性能" class="headerlink" title="转发性能"></a>转发性能</h4><p>hping3 工具，测试网络包的处理能力：<a target="_blank" rel="noopener external nofollow noreferrer" href="https://wangchujiang.com/linux-command/c/hping3.html"> hping3 手册</a></p><h4 id="TCP-UDP-性能"><a href="#TCP-UDP-性能" class="headerlink" title="TCP/UDP 性能"></a>TCP/UDP 性能</h4><p>iperf 网络性能测试工具：<a target="_blank" rel="noopener external nofollow noreferrer" href="https://wangchujiang.com/linux-command/c/iperf.html"> iperf 手册</a></p><p>iperf3 是 iperf 的重写版本，一些常用参数：</p><table><thead><tr><th>主要参数</th><th>参数说明</th></tr></thead><tbody><tr><td>-s</td><td>服务端专用参数，表示 iperf3 以服务端模式运行</td></tr><tr><td>-c</td><td>客户端专用参数，表示 iperf3 以客户端模式运行</td></tr><tr><td>-i</td><td>设置每次报告之间的时间间隔，单位为秒</td></tr><tr><td>-p</td><td>服务端：指定服务端监听的端口，默认为 5201，同时监听 TCP/UDP。<br>客户端：指定客户端连接服务端的端口，默认为 5201。如果同时有 -u 参数，表示通过 UDP 发起连接，否则默认使用 TCP 连接</td></tr><tr><td>-u</td><td>表示使用 UDP 协议发送报文。若不指定该参数则表示使用 TCP 协议</td></tr><tr><td>-l</td><td>设置读写缓冲区的长度。通常测试包转发性能时建议该值设为 16，测试带宽时建议该值设为 1400</td></tr><tr><td>-b</td><td>UDP 模式使用的带宽，单位 bit/s</td></tr><tr><td>-t</td><td>设置传输的总时间。iperf3 在指定时间内，重复发送指定长度数据包的时间，默认值为 10 秒</td></tr><tr><td>-A</td><td>设置 CPU 亲和性，可以将 iperf3 进程绑定对应编号的逻辑 CPU，避免 iperf3 进程在不同的 CPU 间被调度</td></tr></tbody></table><br><div id="comment-container"></div><div id="disqus_thread"></div><div id="lv-container"></div><div class="giscus"></div></div></div></div></div><footer class="footer"><ul class="list-inline text-center"><li><a target="_blank" href="https://github.com/wu3227834" rel="external nofollow noreferrer"><span class="fa-stack fa-lg"><i class="iconfont icon-github"></i></span></a></li></ul><p><span id="busuanzi_container_site_pv"><span id="busuanzi_value_site_pv"></span>PV </span><span id="busuanzi_container_site_uv"><span id="busuanzi_value_site_uv"></span>UV </span>Created By <a target="_blank" rel="noopener external nofollow noreferrer" href="https://hexo.io/">Hexo</a> Theme <a target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/aircloud/hexo-theme-aircloud">AirCloud</a></p></footer><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.js"></script><script type="text/javascript" src="https://apps.bdimg.com/libs/jquery/2.1.4/jquery.min.js"></script><script type="text/javascript" src="/js/clipboard.js"></script><script type="text/x-mathjax-config">MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [ ["$","$"], ["\\(","\\)"] ],
            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'],
            processEscapes: true
        }
    });
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax();
        for (var i = 0; i < all.length; ++i)
            all[i].SourceElement().parentNode.className += ' has-jax';
    });</script><script src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script></body><script>window.hexo_search_path="search.json",window.hexo_root="/",window.isPost=!0</script><script src="/js/index.js"></script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="/js/jquery.min.js"></script><script src="/js/prism.js"></script><script src="https://giscus.app/client.js" data-repo="wu3227834/wu3227834.github.io" data-repo-id="R_kgDOIh8vuA" data-category="General" data-category-id="DIC_kwDOIh8vuM4CpDjz" data-mapping="pathname" data-strict="0" data-reactions-enabled="1" data-emit-metadata="0" data-input-position="bottom" data-theme="preferred_color_scheme" data-lang="zh-CN" crossorigin="anonymous" async></script></html><script src="/js/fancybox/jquery.fancybox.min.js" key="fancybox_js"></script><script src="/js/fancybox/wrapImage.js" key="wrap_image_js"></script><link rel="stylesheet" href="/js/fancybox/jquery.fancybox.min.css" key="fancybox_css">