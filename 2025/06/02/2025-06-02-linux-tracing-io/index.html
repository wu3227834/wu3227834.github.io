<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><meta property="og:description" content="这里是小布丁的私有小屋"><meta property="og:type" content="website"><meta name="keywords" content="Linux, 文件系统, 磁盘I/O, 性能调优, 虚拟文件系统,"><meta name="description" content="本文深入探讨Linux文件系统与磁盘I/O的工作原理，分析缓存I/O与直接I/O的差异，详解索引节点、虚拟文件系统及I/O调度算法，并提供df、iostat等工具的性能观测方法，助力系统性能调优。"><link rel="shortcut icon" href="/img/favicon.ico"><title>Linux性能调优：I/O</title><link rel="stylesheet" href="/css/aircloud.css"><link rel="stylesheet" href="/css/gitment.css"><link rel="stylesheet" href="/css/prism.css"><link href="//at.alicdn.com/t/font_620856_28hi1hpxx24.css" rel="stylesheet" type="text/css"><script></script><script defer src="https://cloud.umami.is/script.js" data-website-id="bad0a741-25cb-4dd6-bbcf-f5710aeb243c"></script><script>((e,t,s,n,r,a)=>{e[s]=e[s]||function(){(e[s].q=e[s].q||[]).push(arguments)},(r=t.createElement(n)).async=1,r.src="https://www.clarity.ms/tag/sgs1vujgeb?ref=bwt",(a=t.getElementsByTagName(n)[0]).parentNode.insertBefore(r,a)})(window,document,"clarity","script")</script><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="Pudding 日常" type="application/atom+xml"></head><body><div class="site-nav-toggle" id="site-nav-toggle"><button><span class="btn-bar"></span> <span class="btn-bar"></span> <span class="btn-bar"></span></button></div><div class="index-about"><i>a week is 2% of the year</i></div><div class="index-container"><div class="index-left"><div class="nav" id="nav"><div class="avatar-name"><div class="avatar"><img src="/img/avatar.png"></div><div class="name"><i>Pudding</i></div></div><div class="contents" id="nav-content"><ul><li><a href="/"><i class="iconfont icon-shouye1"></i> <span>主页</span></a></li><li><a href="/tags"><i class="iconfont icon-biaoqian1"></i> <span>标签</span></a></li><li><a href="/archive"><i class="iconfont icon-guidang2"></i> <span>存档</span></a></li><li><a href="/about/"><i class="iconfont icon-guanyu2"></i> <span>关于</span></a></li><li><a id="search"><i class="iconfont icon-sousuo1"></i> <span>搜索</span></a></li></ul></div><div id="toc" class="toc-article"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E5%92%8C%E7%A3%81%E7%9B%98%E7%9A%84%E5%8C%BA%E5%88%AB"><span class="toc-text">文件系统和磁盘的区别</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Linux-%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E5%A6%82%E4%BD%95%E5%B7%A5%E4%BD%9C"><span class="toc-text">Linux 文件系统如何工作</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%B4%A2%E5%BC%95%E8%8A%82%E7%82%B9%E5%92%8C%E7%9B%AE%E5%BD%95%E9%A1%B9"><span class="toc-text">索引节点和目录项</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%99%9A%E6%8B%9F%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F"><span class="toc-text">虚拟文件系统</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F-I-O"><span class="toc-text">文件系统 I&#x2F;O</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%80%A7%E8%83%BD%E8%A7%82%E6%B5%8B"><span class="toc-text">性能观测</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%B9%E9%87%8F"><span class="toc-text">容量</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BC%93%E5%AD%98"><span class="toc-text">缓存</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Linux-%E7%A3%81%E7%9B%98-I-O-%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86"><span class="toc-text">Linux 磁盘 I&#x2F;O 工作原理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A3%81%E7%9B%98"><span class="toc-text">磁盘</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%80%9A%E7%94%A8%E5%9D%97%E5%B1%82"><span class="toc-text">通用块层</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#I-O-%E6%A0%88"><span class="toc-text">I&#x2F;O 栈</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A3%81%E7%9B%98%E6%80%A7%E8%83%BD%E6%8C%87%E6%A0%87"><span class="toc-text">磁盘性能指标</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A3%81%E7%9B%98-I-O-%E8%A7%82%E6%B5%8B"><span class="toc-text">磁盘 I&#x2F;O 观测</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BF%9B%E7%A8%8B-I-O-%E8%A7%82%E6%B5%8B"><span class="toc-text">进程 I&#x2F;O 观测</span></a></li></ol></li></ol></div></div><div class="search-field" id="search-field"><div class="search-bg" id="search-bg"></div><div class="search-container"><div class="search-input"><span id="esc-search"><i class="icon-fanhui iconfont"></i></span> <input id="search-input"> <span id="begin-search">搜索</span></div><div class="search-result-container" id="search-result-container"></div></div></div><div class="index-about-mobile"><i>a week is 2% of the year</i></div></div><div class="index-middle"><div class="post-container"><div class="post-title">Linux性能调优：I/O</div><div class="post-meta"><span class="attr">发布于：<span>2025-06-02</span></span> <span class="attr">标签：/ <a class="tag" href="/tags/#Linux" title="Linux">Linux</a> <span>/</span> <a class="tag" href="/tags/#性能测试" title="性能测试">性能测试</a> <span>/</span> </span><span class="attr">访问：<span id="busuanzi_value_page_pv"></span></span></div><div class="post-content no-indent"><h2 id="文件系统和磁盘的区别"><a href="#文件系统和磁盘的区别" class="headerlink" title="文件系统和磁盘的区别"></a>文件系统和磁盘的区别</h2><p>磁盘是一个存储设备（确切来说是块设备），可以划分为不同的磁盘分区。而在磁盘或者磁盘分区上，还可以在创建文件系统，并挂载到系统的某个目录。这样，系统就可以通过这个挂载目录，来读写文件。</p><p>换句话说，磁盘是存储数据的块设备，也是文件系统的载体。所以，文件系统确实还是要通过磁盘，来保证数据的持久化存储。</p><p><strong>Linux 中一切皆文件</strong>。可以通过相同的文件接口，来访问磁盘和文件（比如 open、read、write、close 等）</p><ul><li>通常说的“文件”，是指普通文件</li><li>磁盘和分区，是指块设备文件</li></ul><p>在读写普通文件时，I/O 请求会首先经过文件系统，然后由文件系统负责，来与磁盘进行交互。而读写块设备文件时，会跳过文件系统，直接与磁盘交互，也就是所谓的“裸 I/O”。文件系统管理的缓存，是 Cache 的一部分；而裸磁盘的缓存，用的正是 Buffer。</p><blockquote><p>裸磁盘，也称为原始磁盘，是一种未被任何文件系统（如NTFS、FAT32）格式化或管理的磁盘。换句话说，它是直接与磁盘硬件交互，而不通过操作系统的文件系统层进行访问。</p></blockquote><p>缓存 I/O 与直接 I/O（裸磁盘 I/O ）的对比</p><table><thead><tr><th>特性</th><th>缓存I/O（文件系统）</th><th>直接I/O（裸磁盘）</th></tr></thead><tbody><tr><td>数据流</td><td>磁盘 → 内核缓冲区 → 应用程序地址空间</td><td>磁盘 → 直接应用程序地址空间</td></tr><tr><td>缓存使用</td><td>使用文件系统管理的Cache</td><td>使用磁盘的Buffer</td></tr><tr><td>性能</td><td>适合常规文件操作，减少磁盘读写次数</td><td>适合高性能场景，如数据库，减少文件系统开销</td></tr><tr><td>应用场景</td><td>普通文件读写，系统默认方式</td><td>虚拟化、数据库优化、低级别磁盘操作</td></tr><tr><td>优点</td><td>保护系统安全，减少直接磁盘访问风险</td><td>降低数据复制开销，提高I/O效率</td></tr><tr><td>缺点</td><td>数据复制开销高，CPU和内存占用多</td><td>需要应用程序管理缓存，可能增加复杂性</td></tr></tbody></table><h2 id="Linux-文件系统如何工作"><a href="#Linux-文件系统如何工作" class="headerlink" title="Linux 文件系统如何工作"></a>Linux 文件系统如何工作</h2><h3 id="索引节点和目录项"><a href="#索引节点和目录项" class="headerlink" title="索引节点和目录项"></a>索引节点和目录项</h3><ul><li>索引节点（inode），和文件一一对应，存储在磁盘中，记录文件的元数据</li><li>目录项（dentry），记录文件的名字、索引节点以及其他目录项的关联关系</li></ul><p>举例说明，为文件创建的硬链接，会对应不同的目录项，他们都连接到同一个文件，索引节点相同。</p><p>磁盘的最小单位是<strong>扇区</strong>，文件系统将连续的扇区组成逻辑块，以逻辑块为最小单位，来读写磁盘数据。常见的逻辑块 4KB，由连续的 8 个扇区组成。</p><p><img src="/img/2025-06-02-linux_tracing_io/image.png" alt="示意图"></p><p>磁盘在执行文件系统格式化时，分为三个区域：超级块、索引节点和数据块：</p><ul><li>超级块：整个文件系统的状态</li><li>索引节点区：存储索引节点</li><li>数据块区：存储文件数据</li></ul><h3 id="虚拟文件系统"><a href="#虚拟文件系统" class="headerlink" title="虚拟文件系统"></a>虚拟文件系统</h3><p><img src="/img/2025-06-02-linux_tracing_io/image2.png" alt="示意图"></p><p>文件系统分类：</p><ul><li>基于磁盘的文件系统：常见的 ext4、XFS、OverlayFS 等，都是这类文件系统</li><li>基于内存的文件系统：常说的虚拟文件系统，不需要磁盘空间，但是占用内存。比如，/proc 和 /sys</li><li>网络文件系统：用于访问其他计算机的文件系统，比如 NFS、SMB、ISCSI 等</li></ul><p><strong>注意</strong>：这些文件系统，要先挂载到 VFS 目录树中的某个子目录（称为<strong>挂载点</strong>），然后才能访问其中的文件。</p><h3 id="文件系统-I-O"><a href="#文件系统-I-O" class="headerlink" title="文件系统 I/O"></a>文件系统 I/O</h3><p>根据是否利用标准库缓存，分为<strong>缓冲 I/O 和非缓冲 I/O</strong>：</p><ul><li>缓存 I/O：利用标准库缓存，加速文件访问，标准库内部利用系统调用访问文件</li><li>非缓存 I/O：直接通过系统调用访问文件，不再经过标准库缓存</li></ul><p><strong>注意</strong>：这里的“缓冲”，是指<strong>标准库内部实现的缓存</strong>，最终还是需要通过系统调用，而系统调用还会通过<strong>页缓存</strong>，来较少磁盘的 I/O 操作</p><p>根据是否利用操作系统的<strong>页缓存</strong>，分为<strong>直接 I/O 和非直接 I/O</strong>：</p><ul><li>直接 I/O：跳过操作系统的页缓存，直接和<strong>文件系统</strong>交互来访问文件</li><li>非直接 I/O：先通过页缓存，再通过内核或者额外的系统调用，真正和磁盘交互（O_DIRECT 标志）</li></ul><p>根据应用程序是否阻塞自身，分为<strong>阻塞 I/O 和非阻塞 I/O</strong>：</p><ul><li>阻塞 I/O：是指应用程序执行 I/O 操作后，如果没有获得响应，就会阻塞当前线程</li><li>非阻塞 I/O：是指应用程序执行 I/O 操作后，不会阻塞当前的线程，可以继续执行其他的任务，随后再通过<strong>轮询或者事件通知</strong>的形式，获取调用的结果</li></ul><p>根据是否等待相应结果，分为<strong>同步 I/O 和异步 I/O</strong>：</p><ul><li>同步 I/O：应用程序执行 I/O 操作之后，要等到整个 I/O 完成后，才能获得 I/O 响应</li><li>异步 I/O：应用程序不用等待 I/O 完成，会继续执行，等到 I/O 执行完成，会以事件的方式通知应用程序</li></ul><p>设置 O_SYNC 或者 O_DSYNC，代表同步 I/O。如果是 O_DSYNC，要等到文件数据写入磁盘之后，才能返回，如果是 O_SYNC，是在 O_DSYNC 的基础上，要求文件<strong>元数据</strong>写入磁盘，才返回。</p><p>设置 O_ASYNC，代表异步 I/O，系统会再通过 SIGIO 或者 SIFPOLL 通知进程。</p><h3 id="性能观测"><a href="#性能观测" class="headerlink" title="性能观测"></a>性能观测</h3><h4 id="容量"><a href="#容量" class="headerlink" title="容量"></a>容量</h4><p>df 命令查看磁盘空间</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">df</span> -h /dev/vdb</span><br><span class="line">Filesystem      Size  Used Avail Use% Mounted on</span><br><span class="line">/dev/vdb        400G   95G  306G  24% /var/lib/docker</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看索引节点所占的空间</span></span><br><span class="line">$ <span class="built_in">df</span> -i /dev/vdb</span><br><span class="line">Filesystem        Inodes  IUsed     IFree IUse% Mounted on</span><br><span class="line">/dev/vdb       209715200 546727 209168473    1% /var/lib/docker</span><br></pre></td></tr></table></figure><p>当索引节点空间不足，但是索引空间充足时，可能是过多小文件导致的。<strong>解决方法</strong>一般是删除这些小文件，或者移动到索引节点充足的其他磁盘区。</p><h4 id="缓存"><a href="#缓存" class="headerlink" title="缓存"></a>缓存</h4><p>可以使用 free 或者 vmstat，观察页缓存的大小；也可以查看 /proc/meminfo</p><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ cat <span class="keyword">/proc/</span>meminfo | grep -E <span class="string">&quot;SReclaimable|Cached&quot;</span></span><br><span class="line"><span class="symbol">Cached:</span>          <span class="number">3987272</span> kB</span><br><span class="line"><span class="symbol">SwapCached:</span>       <span class="number">109532</span> kB</span><br><span class="line"><span class="symbol">SReclaimable:</span>    <span class="number">4095228</span> kB</span><br></pre></td></tr></table></figure><p>内核使用 slab 机制，管理目录项和索引节点的缓存，/proc/meminfo 给出了整体的 slab 大小，/proc/slabinfo 可以查看每一种 slab 的缓存</p><figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@pudding-160 ~]<span class="comment"># cat /proc/slabinfo | grep -E &#x27;^#|dentry|inode&#x27;</span></span><br><span class="line"><span class="comment"># name            &lt;active_objs&gt; &lt;num_objs&gt; &lt;objsize&gt; &lt;objperslab&gt; &lt;pagesperslab&gt; : tunables &lt;limit&gt; &lt;batchcount&gt; &lt;sharedfactor&gt; : slabdata &lt;active_slabs&gt; &lt;num_slabs&gt; &lt;sharedavail&gt;</span></span><br><span class="line">fuse_inode          <span class="number"> 189 </span>  <span class="number"> 189 </span>  <span class="number"> 768 </span> <span class="number"> 21 </span>  <span class="number"> 4 </span>: tunables   <span class="number"> 0 </span>  <span class="number"> 0 </span>  <span class="number"> 0 </span>: slabdata     <span class="number"> 9 </span>    <span class="number"> 9 </span>     0</span><br><span class="line">ovl_inode         <span class="number"> 11534 </span><span class="number"> 15600 </span>  <span class="number"> 680 </span> <span class="number"> 24 </span>  <span class="number"> 4 </span>: tunables   <span class="number"> 0 </span>  <span class="number"> 0 </span>  <span class="number"> 0 </span>: slabdata   <span class="number"> 650 </span>  <span class="number"> 650 </span>     0</span><br><span class="line">xfs_inode        <span class="number"> 175054 </span>175372   <span class="number"> 960 </span> <span class="number"> 34 </span>  <span class="number"> 8 </span>: tunables   <span class="number"> 0 </span>  <span class="number"> 0 </span>  <span class="number"> 0 </span>: slabdata  <span class="number"> 5158 </span> <span class="number"> 5158 </span>     0</span><br><span class="line">mqueue_inode_cache   <span class="number"> 288 </span>  <span class="number"> 288 </span>  <span class="number"> 896 </span> <span class="number"> 36 </span>  <span class="number"> 8 </span>: tunables   <span class="number"> 0 </span>  <span class="number"> 0 </span>  <span class="number"> 0 </span>: slabdata     <span class="number"> 8 </span>    <span class="number"> 8 </span>     0</span><br><span class="line">hugetlbfs_inode_cache    <span class="number"> 52 </span>   <span class="number"> 52 </span>  <span class="number"> 608 </span> <span class="number"> 26 </span>  <span class="number"> 4 </span>: tunables   <span class="number"> 0 </span>  <span class="number"> 0 </span>  <span class="number"> 0 </span>: slabdata     <span class="number"> 2 </span>    <span class="number"> 2 </span>     0</span><br><span class="line">sock_inode_cache   <span class="number"> 2255 </span> <span class="number"> 2475 </span>  <span class="number"> 640 </span> <span class="number"> 25 </span>  <span class="number"> 4 </span>: tunables   <span class="number"> 0 </span>  <span class="number"> 0 </span>  <span class="number"> 0 </span>: slabdata    <span class="number"> 99 </span>   <span class="number"> 99 </span>     0</span><br><span class="line">shmem_inode_cache  <span class="number"> 6783 </span> <span class="number"> 7056 </span>  <span class="number"> 680 </span> <span class="number"> 24 </span>  <span class="number"> 4 </span>: tunables   <span class="number"> 0 </span>  <span class="number"> 0 </span>  <span class="number"> 0 </span>: slabdata   <span class="number"> 294 </span>  <span class="number"> 294 </span>     0</span><br><span class="line">proc_inode_cache  <span class="number"> 28816 </span><span class="number"> 29688 </span>  <span class="number"> 656 </span> <span class="number"> 24 </span>  <span class="number"> 4 </span>: tunables   <span class="number"> 0 </span>  <span class="number"> 0 </span>  <span class="number"> 0 </span>: slabdata  <span class="number"> 1237 </span> <span class="number"> 1237 </span>     0</span><br><span class="line">inode_cache       <span class="number"> 34463 </span><span class="number"> 35208 </span>  <span class="number"> 592 </span> <span class="number"> 27 </span>  <span class="number"> 4 </span>: tunables   <span class="number"> 0 </span>  <span class="number"> 0 </span>  <span class="number"> 0 </span>: slabdata  <span class="number"> 1304 </span> <span class="number"> 1304 </span>     0</span><br><span class="line">dentry           <span class="number"> 20014134 </span>20014134   <span class="number"> 192 </span> <span class="number"> 21 </span>  <span class="number"> 1 </span>: tunables   <span class="number"> 0 </span>  <span class="number"> 0 </span>  <span class="number"> 0 </span>: slabdata<span class="number"> 953054 </span>953054      0</span><br><span class="line">selinux_inode_security <span class="number"> 15708 </span><span class="number"> 15708 </span>   <span class="number"> 40 </span><span class="number"> 102 </span>  <span class="number"> 1 </span>: tunables   <span class="number"> 0 </span>  <span class="number"> 0 </span>  <span class="number"> 0 </span>: slabdata   <span class="number"> 154 </span>  <span class="number"> 154 </span>     0</span><br></pre></td></tr></table></figure><p>其中 dentry 代表目录项缓存，inode_cache 代表 VFS 索引节点缓存，其他的就是各种文件系统的索引节点缓存。</p><p>实际性能分析中，更常使用 slabtop 命令，来找出占用内存最多的缓存类型。</p><p>示例如下：可以看到，目录项占用了最多的 Slab 缓存，大约 3.91 G</p><figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 按下c按照缓存大小排序，按下a按照活跃对象数排序 </span></span><br><span class="line">$ slabtop</span><br><span class="line"> Active / Total Objects (% used)    :<span class="number"> 22757396 </span>/<span class="number"> 23018218 </span>(98.9%)</span><br><span class="line"> Active / Total Slabs (% used)      :<span class="number"> 1067320 </span>/<span class="number"> 1067320 </span>(100.0%)</span><br><span class="line"> Active / Total Caches (% used)     :<span class="number"> 72 </span>/<span class="number"> 103 </span>(69.9%)</span><br><span class="line"> Active / Total Size (% used)       : 4462258.28K / 4545420.86K (98.2%)</span><br><span class="line"> Minimum / Average / Maximum Object : 0.01K / 0.20K / 8.00K</span><br><span class="line"></span><br><span class="line">  OBJS ACTIVE  USE OBJ SIZE  SLABS OBJ/SLAB CACHE SIZE NAME</span><br><span class="line">21574896<span class="number"> 21574735 </span> 99%    0.19K<span class="number"> 1027376 </span>     <span class="number"> 21 </span>  4109504K dentry</span><br><span class="line">355914<span class="number"> 286236 </span> 80%    0.10K  <span class="number"> 9126 </span>     <span class="number"> 39 </span>    36504K buffer_head</span><br><span class="line">223872<span class="number"> 205323 </span> 91%    0.06K  <span class="number"> 3498 </span>     <span class="number"> 64 </span>    13992K kmalloc-64</span><br><span class="line">175372<span class="number"> 175125 </span> 99%    0.94K  <span class="number"> 5158 </span>     <span class="number"> 34 </span>   165056K xfs_inode</span><br><span class="line"><span class="number"> 57600 </span><span class="number"> 57529 </span> 99%    0.16K  <span class="number"> 2400 </span>     <span class="number"> 24 </span>     9600K xfs_ili</span><br><span class="line">136528 <span class="number"> 53170 </span> 38%    0.57K  <span class="number"> 4876 </span>     <span class="number"> 28 </span>    78016K radix_tree_node</span><br><span class="line">...</span><br></pre></td></tr></table></figure><h2 id="Linux-磁盘-I-O-工作原理"><a href="#Linux-磁盘-I-O-工作原理" class="headerlink" title="Linux 磁盘 I/O 工作原理"></a>Linux 磁盘 I/O 工作原理</h2><h3 id="磁盘"><a href="#磁盘" class="headerlink" title="磁盘"></a>磁盘</h3><p>根据存储介质，磁盘分为：</p><ul><li>机械磁盘，也称为硬盘驱动器（Hard Disk Driver），通常缩写为 HDD。机械磁盘主要有盘片和读写磁头组成，数据就存储在盘片的环状磁道中。在读写数据前，需要移动读写磁头，定位数据所在的磁道，才能访问数据。如果 I/O 请求刚好连续，就不需要磁道寻址，可以获得最佳性能。这就是连续 I/O 的工作原理。与之对应的是随机 I/O，它需要不停地移动磁头，来定位数据位置，读写速度就会比较慢。</li><li>固态磁盘（Silid State Disk），通常缩写为 SSD，由固态电子元件组成。固态磁盘不需要磁盘寻址，不管是连续 I/O，还是随机 I/O 的性能，都比机械磁盘要好得多。</li></ul><p>无论是机械磁盘，还是固态磁盘，相同磁盘的随机 I/O 都要比连续 I/O 慢得多，原因是：</p><ul><li>随机 I/O 需要更多的磁头寻道和盘片旋转，它的性能自然要比连续 I/O 慢</li><li>对于固态硬盘来说，虽然它的随机性能比机械磁盘好很多，但同样存在“先擦除再写入”的限制。随机读写会导致大量的垃圾回收，所以相对应的，随机 I/O 的性能比起连续 I/O 来，也还差了很多</li><li>连续 I/O 还可以通过预读的方式，来减少 I/O 请求的次数，这也是其性能优异的一个原因</li></ul><p>最小读写单位：</p><ul><li>机械硬盘的最小读写单位是扇区，一般是 512 字节</li><li>固态硬盘的最小读写单位是页，一般是 4KB 或者 8KB</li></ul><p>按照接口，磁盘可分为 IDE（Integrated Drive Electronics）、SCSI（Small Computer System Interface） 、SAS（Serial Attached SCSI） 、SATA（Serial ATA） 、FC（Fibre Channel）等。</p><p>磁盘介入服务器时，按照不通的使用方式，会划分为不用的架构：</p><ul><li>最简单的直接作为独立磁盘设备来使用</li><li>将多块磁盘组合成一个逻辑磁盘，构成冗余独立磁盘阵列（RAID），提高数据访问的性能，并增强数据存储的可靠性</li><li>最后一种，是将磁盘组合成网络存储集群，再通过 NFS、SMB、ISCSI 等网络存储协议，暴露给服务器使用</li></ul><p>在 Linux 中，磁盘是作为一个块设备来管理，以块为单位来读写，支持随机读写。每个块设备赋予两个设备号，分别是主、次设备号，主设备号用在驱动程序中，用来区分设备类型；次设备号用来在多个同类设备编号。</p><h3 id="通用块层"><a href="#通用块层" class="headerlink" title="通用块层"></a>通用块层</h3><p>和 VFS 类似，为了减少不同设备的差异带来的影响，Linux 通过统一的通用块（块 I/O 层），管理不同的块设备。</p><p>块设备层是处在文件系统和磁盘驱动中间的一个块设备抽象层，主要功能是：</p><ul><li>向上为文件系统和应用程序提供访问块设备的标准接口；向下，把各种异构的磁盘块设备抽象为统一的块设备，提供统一框架管理这些设备的驱动程序</li><li>通用块层还会给文件系统和应用程序发来 I/O 请求排队，并通过重新排序、请求合并等方式，提高磁盘读写的效率</li></ul><p>对 I/O 请求排序的过程就是 I/0 调度，Linux 支持的四种 I/O 调度算法，分别是 NONE、NOOP、CFQ 以及 DeadLine：</p><ul><li>NONE，不适用任何调度，对 I/O 不做任何处理（常用在虚拟机，此时磁盘 I/O 完全由物理机复杂）</li><li>NOOP，先入先出调度（常用在 SSD）</li><li>CFQ（Completely Fair Schedule）完全公平调度器，很多 Linux 发行版的默认调度器，它为每个进程维护了一个 I/O 调度队列，按照时间片来均匀分配每个进程的 I/O 请求；还支持优先级调度，适用于大量进程的系统（如桌面、多媒体应用等）</li><li>DeadLine 调度算法，分别为读、写请求创建了不同的 I/O 队列，可以提高机械磁盘的吞吐量，并确保打到最终期限（deadline）的请求被优化处理，多用在 I/O 压力比较重的场景，比如数据库等</li></ul><h3 id="I-O-栈"><a href="#I-O-栈" class="headerlink" title="I/O 栈"></a>I/O 栈</h3><p><img src="/img/2025-06-02-linux_tracing_io/image3.png" alt="示意图"></p><p>根据这张 I/O 栈的全景图，可以看出存储系统 I/O 的工作原理</p><ul><li>文件系统层，包括虚拟文件系统和其他文件系统的具体实现。它为上层的应用程序，提供标准的文件访问接口；对下会通过快层，来存储和管理磁盘资源</li><li>通用块层，包括块设备 I/O 队列和 I/O 调度器。他会对文件系统的 I/O 请求进行排队，再通过重新排序和请求合并，然后才要发给下一级的设备层</li><li>设备层，包括存储设备和相应的驱动程序，负责最终物理设备的 I/O 操作</li></ul><p>存储系统的 I/O，通常是整个系统最慢的一环。</p><p>Linux 通过多种缓存机制来优化 I/O 效率。为了优化文件访问的性能，会使用页缓存、索引节点缓存等多种机制，以减少对下层块设配的直接调用。同样，为了优化块设备，会使用缓冲区，来缓存块设备的数据。</p><h3 id="磁盘性能指标"><a href="#磁盘性能指标" class="headerlink" title="磁盘性能指标"></a>磁盘性能指标</h3><p>使用率、饱和度、IOPS、吞吐量以及响应时间五个指标，是磁盘性能的基本指标</p><ul><li>使用率，是指磁盘处理 I/O 的时间百分比。过高的使用率（比如超过 80%），通常意味着磁盘 I/O 存在性能瓶颈</li><li>饱和度，是指磁盘处理 I/O 的繁忙程度。过高的饱和度，意味着存在严重的性能瓶颈。当饱和度为 100% 时，磁盘无法接受新的 I/O 请求</li><li>IOPS（Input/Output Per Second），是指每秒的 I/O 请求数</li><li>吞吐量，是指每秒 I/O 请求大小</li><li>响应时间，是指 I/O 请求从发出到收到响应的间隔时间</li></ul><p>注意：</p><ol><li>使用率只考虑有没有 I/O，而不考虑 I/O 的大小。换句话说，当使用率是 100% 的时候，磁盘依然有可能接受到新的 I/O 请求</li><li>随即读写多（如数据库、大量小文件）的情况下主要关注 IOPS，而顺序读写（如流媒体）的情况下，主要关注吞吐量</li></ol><p>在为应用程序的服务器选型时，要先对磁盘的 I/O 性能进行基准测试，以便可以准确评估，磁盘性能是否可以满足应用程序的需求</p><h3 id="磁盘-I-O-观测"><a href="#磁盘-I-O-观测" class="headerlink" title="磁盘 I/O 观测"></a>磁盘 I/O 观测</h3><p>使用 iostat 观测每块磁盘的使用情况，提供了每个磁盘的使用率、IOPS、吞吐量等各种常见的性能指标，这些指标实际上来自 /proc/diskstats</p><figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">$ iostat <span class="operator">-</span>dx <span class="number">1</span></span><br><span class="line">Linux <span class="number">3.10</span>.<span class="number">0</span><span class="operator">-</span><span class="number">1160.76</span>.<span class="number">1</span>.el7.x86_64 (idc16)       <span class="number">2025</span>年<span class="number">06</span>月<span class="number">16</span>日  _x86_64_        (<span class="number">40</span> CPU)</span><br><span class="line"></span><br><span class="line"><span class="params">Device:</span>         rrqm<span class="symbol">/s</span>   wrqm<span class="symbol">/s</span>     r<span class="symbol">/s</span>     w<span class="symbol">/s</span>    rkB<span class="symbol">/s</span>    wkB<span class="symbol">/s</span> avgrq-sz avgqu-sz   await r_await w_await  svctm  %util</span><br><span class="line">sda               <span class="number">0.00</span>     <span class="number">0.69</span>    <span class="number">1.56</span>   <span class="number">25.12</span>    <span class="number">62.56</span>   <span class="number">270.97</span>    <span class="number">25.01</span>     <span class="number">0.27</span>   <span class="number">10.01</span>    <span class="number">0.84</span>   <span class="number">10.58</span>   <span class="number">1.18</span>   <span class="number">3.14</span></span><br><span class="line">sdd               <span class="number">0.00</span>     <span class="number">0.27</span>    <span class="number">0.17</span>    <span class="number">1.33</span>    <span class="number">10.66</span>    <span class="number">42.08</span>    <span class="number">70.12</span>     <span class="number">0.01</span>    <span class="number">8.48</span>    <span class="number">6.95</span>    <span class="number">8.68</span>   <span class="number">0.26</span>   <span class="number">0.04</span></span><br><span class="line">sdc               <span class="number">0.00</span>     <span class="number">0.61</span>    <span class="number">0.27</span>    <span class="number">9.80</span>    <span class="number">13.02</span>   <span class="number">193.43</span>    <span class="number">41.03</span>     <span class="number">0.04</span>    <span class="number">3.52</span>    <span class="number">0.82</span>    <span class="number">3.59</span>   <span class="number">0.06</span>   <span class="number">0.06</span></span><br><span class="line">sde               <span class="number">0.00</span>     <span class="number">0.22</span>    <span class="number">0.21</span>    <span class="number">1.38</span>    <span class="number">11.79</span>    <span class="number">43.80</span>    <span class="number">70.07</span>     <span class="number">0.01</span>    <span class="number">8.43</span>    <span class="number">7.23</span>    <span class="number">8.61</span>   <span class="number">0.26</span>   <span class="number">0.04</span></span><br><span class="line">sdf               <span class="number">0.00</span>     <span class="number">0.24</span>    <span class="number">0.07</span>    <span class="number">1.29</span>    <span class="number">13.02</span>    <span class="number">18.95</span>    <span class="number">47.09</span>     <span class="number">0.00</span>    <span class="number">3.29</span>   <span class="number">17.06</span>    <span class="number">2.56</span>   <span class="number">0.20</span>   <span class="number">0.03</span></span><br><span class="line">sdh               <span class="number">0.00</span>     <span class="number">0.26</span>    <span class="number">0.01</span>    <span class="number">1.32</span>     <span class="number">1.49</span>    <span class="number">19.72</span>    <span class="number">31.78</span>     <span class="number">0.00</span>    <span class="number">1.70</span>    <span class="number">9.23</span>    <span class="number">1.63</span>   <span class="number">0.09</span>   <span class="number">0.01</span></span><br><span class="line">sdg               <span class="number">0.00</span>     <span class="number">0.23</span>    <span class="number">0.05</span>    <span class="number">1.30</span>    <span class="number">11.18</span>    <span class="number">21.33</span>    <span class="number">48.10</span>     <span class="number">0.01</span>    <span class="number">4.07</span>   <span class="number">24.12</span>    <span class="number">3.28</span>   <span class="number">0.21</span>   <span class="number">0.03</span></span><br><span class="line">sdi               <span class="number">0.00</span>     <span class="number">0.28</span>    <span class="number">0.04</span>    <span class="number">1.67</span>     <span class="number">9.65</span>    <span class="number">19.50</span>    <span class="number">33.96</span>     <span class="number">0.00</span>    <span class="number">1.86</span>   <span class="number">25.33</span>    <span class="number">1.26</span>   <span class="number">0.15</span>   <span class="number">0.03</span></span><br><span class="line">sdj               <span class="number">0.00</span>     <span class="number">0.24</span>    <span class="number">0.36</span>    <span class="number">2.35</span>    <span class="number">21.61</span>   <span class="number">247.35</span>   <span class="number">198.58</span>     <span class="number">0.14</span>   <span class="number">51.46</span>    <span class="number">4.47</span>   <span class="number">58.60</span>   <span class="number">0.49</span>   <span class="number">0.13</span></span><br><span class="line">sdb               <span class="number">0.00</span>     <span class="number">0.46</span>    <span class="number">1.66</span>    <span class="number">8.00</span>   <span class="number">180.35</span>   <span class="number">210.13</span>    <span class="number">80.81</span>     <span class="number">0.08</span>    <span class="number">8.74</span>    <span class="number">2.84</span>    <span class="number">9.97</span>   <span class="number">0.20</span>   <span class="number">0.19</span></span><br><span class="line">dm-<span class="number">0</span>              <span class="number">0.00</span>     <span class="number">0.00</span>    <span class="number">0.85</span>   <span class="number">18.11</span>    <span class="number">38.11</span>   <span class="number">144.32</span>    <span class="number">19.24</span>     <span class="number">0.17</span>    <span class="number">8.82</span>    <span class="number">0.56</span>    <span class="number">9.21</span>   <span class="number">1.14</span>   <span class="number">2.16</span></span><br><span class="line">dm-<span class="number">1</span>              <span class="number">0.00</span>     <span class="number">0.00</span>    <span class="number">0.00</span>    <span class="number">0.00</span>     <span class="number">0.00</span>     <span class="number">0.00</span>    <span class="number">49.16</span>     <span class="number">0.00</span>   <span class="number">11.10</span>   <span class="number">11.10</span>    <span class="number">0.00</span>   <span class="number">9.62</span>   <span class="number">0.00</span></span><br><span class="line">scd0              <span class="number">0.00</span>     <span class="number">0.00</span>    <span class="number">0.00</span>    <span class="number">0.00</span>     <span class="number">0.00</span>     <span class="number">0.00</span>    <span class="number">80.31</span>     <span class="number">0.00</span>  <span class="number">813.35</span>  <span class="number">813.35</span>    <span class="number">0.00</span> <span class="number">809.27</span>   <span class="number">0.00</span></span><br><span class="line">dm-<span class="number">2</span>              <span class="number">0.00</span>     <span class="number">0.00</span>    <span class="number">0.00</span>    <span class="number">0.21</span>     <span class="number">0.04</span>    <span class="number">16.16</span>   <span class="number">155.78</span>     <span class="number">0.02</span>   <span class="number">99.54</span>    <span class="number">2.63</span>  <span class="number">100.60</span>   <span class="number">1.79</span>   <span class="number">0.04</span></span><br><span class="line">dm-<span class="number">3</span>              <span class="number">0.00</span>     <span class="number">0.00</span>    <span class="number">0.68</span>    <span class="number">4.54</span>    <span class="number">22.80</span>    <span class="number">72.63</span>    <span class="number">36.54</span>     <span class="number">0.07</span>   <span class="number">14.35</span>    <span class="number">1.04</span>   <span class="number">16.35</span>   <span class="number">1.31</span>   <span class="number">0.69</span></span><br><span class="line">dm-<span class="number">4</span>              <span class="number">0.00</span>     <span class="number">0.00</span>    <span class="number">0.02</span>    <span class="number">2.93</span>     <span class="number">0.38</span>    <span class="number">37.73</span>    <span class="number">25.90</span>     <span class="number">0.03</span>   <span class="number">10.70</span>    <span class="number">4.72</span>   <span class="number">10.73</span>   <span class="number">1.32</span>   <span class="number">0.39</span></span><br></pre></td></tr></table></figure><p>各个指标解读如下</p><p><img src="/img/2025-06-02-linux_tracing_io/image4.png" alt="iostat 指标解读图"></p><p>注意：</p><ul><li>%util，就是我们前面提到的磁盘 I/O 使用率</li><li>r/s + w/s，就是 IOPS</li><li>rkB/s + wkB/s，就是吞吐量</li><li>r_await+w_await，就是响应时间</li></ul><p>在观测指标时，可以结合请求的大小（rareq-sz 和 wareq-sz）一起分析。</p><h3 id="进程-I-O-观测"><a href="#进程-I-O-观测" class="headerlink" title="进程 I/O 观测"></a>进程 I/O 观测</h3><p>pidstat 可以实时查看某个进程的 I/O 情况</p><figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">$ pidstat -d 1</span><br><span class="line">Linux 3.10.0-957.el7.x86_64 (xxx)       06/17/2025      _x86_64_        (8 CPU)</span><br><span class="line"></span><br><span class="line">07:12:18 PM   UID       PID   kB_rd/s   kB_wr/s kB_ccwr/s  Command</span><br><span class="line">07:12:19 PM   <span class="number"> 27 </span>  <span class="number"> 362006 </span>     0.00    594.17    590.29  mysqld</span><br><span class="line">07:12:19 PM    <span class="number"> 0 </span>  <span class="number"> 362323 </span>     0.00      3.88      3.88  docker-containe</span><br><span class="line">07:12:19 PM    <span class="number"> 0 </span>  <span class="number"> 362403 </span>     0.00      7.77      0.00  kundb-meta-serv</span><br><span class="line">07:12:19 PM    <span class="number"> 0 </span>  <span class="number"> 362518 </span>     0.00      3.88      0.00  java</span><br><span class="line">07:12:19 PM<span class="number"> 65534 </span>  <span class="number"> 363123 </span>     0.00      3.88      0.00  prometheus</span><br><span class="line">07:12:19 PM    <span class="number"> 0 </span>  <span class="number"> 372218 </span>     0.00      7.77      0.00  java</span><br><span class="line">07:12:19 PM    <span class="number"> 0 </span>  <span class="number"> 383196 </span>     0.00     19.42      0.00  dockerd</span><br><span class="line">07:12:19 PM    <span class="number"> 0 </span>  <span class="number"> 389626 </span>     0.00     23.30      0.00  kube-apiserver</span><br><span class="line">07:12:19 PM    <span class="number"> 0 </span>  <span class="number"> 389731 </span>     0.00     62.14      0.00  etcd</span><br><span class="line">07:12:19 PM    <span class="number"> 0 </span>  <span class="number"> 391157 </span>     0.00     11.65      0.00  kubelet</span><br><span class="line">07:12:19 PM    <span class="number"> 0 </span>  <span class="number"> 760300 </span>     0.00     11.65      0.00  kundb-meta-serv</span><br></pre></td></tr></table></figure><p>指标如下：</p><ul><li>用户 ID（UID）和进程 ID（PID）</li><li>每秒读取的数据大小（kB_rd/s），单位是 KB</li><li>每秒发出的写请求数据大小（kB_wr/s），单位是 KB</li><li>每秒取消的写请求数据大小（KB_ccwr/s），单位是 KB</li></ul><br><div id="comment-container"></div><div id="disqus_thread"></div><div id="lv-container"></div><div class="giscus"></div></div></div></div></div><footer class="footer"><ul class="list-inline text-center"><li><a target="_blank" href="https://github.com/wu3227834" rel="external nofollow noreferrer"><span class="fa-stack fa-lg"><i class="iconfont icon-github"></i></span></a></li></ul><p><span id="busuanzi_container_site_pv"><span id="busuanzi_value_site_pv"></span>PV </span><span id="busuanzi_container_site_uv"><span id="busuanzi_value_site_uv"></span>UV </span>Created By <a target="_blank" rel="noopener external nofollow noreferrer" href="https://hexo.io/">Hexo</a> Theme <a target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/aircloud/hexo-theme-aircloud">AirCloud</a></p></footer><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.js"></script><script type="text/javascript" src="https://apps.bdimg.com/libs/jquery/2.1.4/jquery.min.js"></script><script type="text/javascript" src="/js/clipboard.js"></script><script type="text/x-mathjax-config">MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [ ["$","$"], ["\\(","\\)"] ],
            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'],
            processEscapes: true
        }
    });
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax();
        for (var i = 0; i < all.length; ++i)
            all[i].SourceElement().parentNode.className += ' has-jax';
    });</script><script src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script></body><script>window.hexo_search_path="search.json",window.hexo_root="/",window.isPost=!0</script><script src="/js/index.js"></script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="/js/jquery.min.js"></script><script src="/js/prism.js"></script><script src="https://giscus.app/client.js" data-repo="wu3227834/wu3227834.github.io" data-repo-id="R_kgDOIh8vuA" data-category="General" data-category-id="DIC_kwDOIh8vuM4CpDjz" data-mapping="pathname" data-strict="0" data-reactions-enabled="1" data-emit-metadata="0" data-input-position="bottom" data-theme="preferred_color_scheme" data-lang="zh-CN" crossorigin="anonymous" async></script></html><script src="/js/fancybox/jquery.fancybox.min.js" key="fancybox_js"></script><script src="/js/fancybox/wrapImage.js" key="wrap_image_js"></script><link rel="stylesheet" href="/js/fancybox/jquery.fancybox.min.css" key="fancybox_css">