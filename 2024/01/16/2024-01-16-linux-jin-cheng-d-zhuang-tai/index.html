<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><meta property="og:description" content="这里是小布丁的私有小屋"><meta property="og:type" content="website"><meta name="description" content="这里是小布丁的私有小屋"><link rel="shortcut icon" href="/img/favicon.ico"><title>一文让你应对 Linux 进程 &#34;D&#34; 状态</title><link rel="stylesheet" href="/css/aircloud.css"><link rel="stylesheet" href="/css/gitment.css"><link rel="stylesheet" href="/css/prism.css"><link href="//at.alicdn.com/t/font_620856_28hi1hpxx24.css" rel="stylesheet" type="text/css"><script></script><script defer src="https://cloud.umami.is/script.js" data-website-id="bad0a741-25cb-4dd6-bbcf-f5710aeb243c"></script><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="Pudding 日常" type="application/atom+xml"></head><body><div class="site-nav-toggle" id="site-nav-toggle"><button><span class="btn-bar"></span> <span class="btn-bar"></span> <span class="btn-bar"></span></button></div><div class="index-about"><i>a week is 2% of the year</i></div><div class="index-container"><div class="index-left"><div class="nav" id="nav"><div class="avatar-name"><div class="avatar"><img src="/img/avatar.png"></div><div class="name"><i>Pudding</i></div></div><div class="contents" id="nav-content"><ul><li><a href="/"><i class="iconfont icon-shouye1"></i> <span>主页</span></a></li><li><a href="/tags"><i class="iconfont icon-biaoqian1"></i> <span>标签</span></a></li><li><a href="/archive"><i class="iconfont icon-guidang2"></i> <span>存档</span></a></li><li><a href="/about/"><i class="iconfont icon-guanyu2"></i> <span>关于</span></a></li><li><a id="search"><i class="iconfont icon-sousuo1"></i> <span>搜索</span></a></li></ul></div><div id="toc" class="toc-article"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%8E%AF%E5%A2%83"><span class="toc-text">环境</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%97%AE%E9%A2%98"><span class="toc-text">问题</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%A7%A3%E5%86%B3"><span class="toc-text">解决</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A0%B9%E6%9C%AC%E5%8E%9F%E5%9B%A0"><span class="toc-text">根本原因</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AF%8A%E6%96%AD%E6%AD%A5%E9%AA%A4"><span class="toc-text">诊断步骤</span></a></li></ol></div></div><div class="search-field" id="search-field"><div class="search-bg" id="search-bg"></div><div class="search-container"><div class="search-input"><span id="esc-search"><i class="icon-fanhui iconfont"></i></span> <input id="search-input"> <span id="begin-search">搜索</span></div><div class="search-result-container" id="search-result-container"></div></div></div><div class="index-about-mobile"><i>a week is 2% of the year</i></div></div><div class="index-middle"><div class="post-container"><div class="post-title">一文让你应对 Linux 进程 &quot;D&quot; 状态</div><div class="post-meta"><span class="attr">发布于：<span>2024-01-16</span></span> <span class="attr">标签：/ <a class="tag" href="/tags/#linux" title="linux">linux</a> <span>/</span> </span><span class="attr">访问：<span id="busuanzi_value_page_pv"></span></span></div><div class="post-content no-indent"><h2 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h2><p>红帽企业 linux 4、5、6、7、8、9</p><h2 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h2><ul><li>什么是 “D” 状态（或 dstate 或 d-state）?</li><li>什么是进程的 “D” 状态</li></ul><h2 id="解决"><a href="#解决" class="headerlink" title="解决"></a>解决</h2><ul><li>Linux 遵循传统 UNIX 的标准，将其平均负荷计算为指定时间间隔内可运行或正在运行的进程（R 状态）的平均数量，以及处于不可中断睡眠（D 状态）中的进程数量。</li><li>"D" 状态（TASK_UNINTERRUPTIBLE）是发生在内核代码路径中的一种状态，在这种状态下，在处理任务时执行不能被中断。我们希望这应该是一个短暂的过程，且在正常操作中，内核线程应该快速地从 TASK_UNINTERRUPTIBLE 状态中出来。<ul><li><b>"D" 状态进程通常被阻塞等待资源</b>，磁盘 IO 和锁是进程可能阻塞的几种常见资源。</li><li>一个例子可能是与硬件通信的 low level 驱动程序，可能从 NIC 固件检索网络数据包数据或访问硬盘驱动器上的数据块--读写 IO。</li><li>通常，这种情况发生得非常快，并且线程保持这种状态的时间非常短（因此通常不会观察到，尤其是在用户空间中）。</li><li>"D" 状态名称有历史原因，因为最初认为这种状态是进程处于“磁盘等待”状态。但现在，与“磁盘 IO”分离的网络、锁和其他资源可能导致进程处于不可中断的等待状态。有关进程状态的更多背景信息，请参阅 "<a target="_blank" rel="noopener external nofollow noreferrer" href="https://access.redhat.com/sites/default/files/attachments/processstates_20120831.pdf">了解 Linux 进程状态</a>"。具体来说，我们总结了 "D" 状态过程如下：“不可中断睡眠状态是不会立即处理信号的状态。它只有在等待资源变得可用或者在等待期间发生超时(如果在进程进入睡眠时指定了超时)时才会被唤醒。”</li></ul></li><li>当线程进入 "D" 状态并且未能在合理的时间内退出该状态时，就会出现问题。这个进程现在被“卡住”，任何等待它的进程（可能在它后面的队列中访问相同的硬件）或依赖它的进程也同样被卡住。<ul><li>虽然“合理的时间”是主观的，但如果一个任务在 D 状态下停滞太久，那么 "<a target="_blank" rel="noopener external nofollow noreferrer" href="https://access.redhat.com/solutions/31453">INFO: task<process>:<pid>blocked for more than ... seconds</pid></process></a>" 的消息就会输出，通知系统管理员需要调查或可能需要<a target="_blank" rel="noopener external nofollow noreferrer" href="https://access.redhat.com/solutions/39188">系统调优</a>的潜在情况。</li></ul></li><li>要查看哪个进程/线程保持在 "D" 状态：<ul><li>获取处于 "D" 状态的线程列表： <code>ps auxH | awk '$8 ~ /^D/&#123;print&#125;'</code></li><li>显示每个线程<code>sudo cat /proc/&lt;PID&gt;/stack</code> 的堆栈：<br><code>for D_PID in $(ps auxH | awk '$8 ~ /^D/&#123;print $2&#125;');do ps -Llp $D_PID;sudo cat /proc/$D_PID/stack;echo;done</code></li></ul></li></ul><h2 id="根本原因"><a href="#根本原因" class="headerlink" title="根本原因"></a>根本原因</h2><ul><li>发现处于 D 状态的进程是相当普遍和正常的</li><li>在大多数情况下，这是由于对 I/O 资源（通常是本地或远程存储、网络文件系统等）的访问中断造成的</li><li>如果一个进程在 D 状态停滞太久，那么内核中的“<a target="_blank" rel="noopener external nofollow noreferrer" href="https://access.redhat.com/solutions/31453">停滞任务</a>”逻辑将被启用</li></ul><h2 id="诊断步骤"><a href="#诊断步骤" class="headerlink" title="诊断步骤"></a>诊断步骤</h2><ul><li>检查 ps 输出中是否有处于 D 状态的线程，可以使用类似于以下内容的内容：<code>ps auxH | awk '$8 ~ /^D/&#123;print&#125;'</code></li><li>负载可能很高而且还在增加（可能有成百甚至到数千，1 分钟负载始终高于 5 分钟，5 分钟始终高于 15 分钟，暗示报告的负载不断增加）；机器的响应能力与这个高数字不匹配（机器还能响应命令，但是如果所有核心都被占据之后，可能系统就不再响应）</li><li>解决问题的第一步（假设前两个步骤得到了验证）是隔离导致这种情况的资源（最有可能的存储/文件系统），例如查看处于 d 状态（当前工作）的进程的共同使用的文件或者目录等</li><li>一旦确定了所涉及的资源，就应采取措施恢复对它的访问；根据具体情况，可能会重新获得对在线文件系统/存储的访问，或者可能需要重新启动机器才能完全恢复（最有可能的情况）</li></ul><blockquote><p>参考链接</p><ul><li><a href>What is “D” state (or dstate, d-state)?</a></li><li><a target="_blank" rel="noopener external nofollow noreferrer" href="https://mp.weixin.qq.com/s?__biz=MzI0OTIzOTMzMA==&mid=2247485072&idx=1&sn=c9bd418f4dcb9ce2cffd9dfb20461640&chksm=e995c4dddee24dcbc6450633da0627cf65ec92ca61e4e487b774882c5a51db0210a79f3f890a&scene=21#wechat_redirect">一文让你应对Linux 进程“D”状态</a></li></ul></blockquote><br><div id="comment-container"></div><div id="disqus_thread"></div><div id="lv-container"></div><div class="giscus"></div></div></div></div></div><footer class="footer"><ul class="list-inline text-center"><li><a target="_blank" href="https://github.com/wu3227834" rel="external nofollow noreferrer"><span class="fa-stack fa-lg"><i class="iconfont icon-github"></i></span></a></li></ul><p><span id="busuanzi_container_site_pv"><span id="busuanzi_value_site_pv"></span>PV </span><span id="busuanzi_container_site_uv"><span id="busuanzi_value_site_uv"></span>UV </span>Created By <a target="_blank" rel="noopener external nofollow noreferrer" href="https://hexo.io/">Hexo</a> Theme <a target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/aircloud/hexo-theme-aircloud">AirCloud</a></p></footer><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.js"></script><script type="text/javascript" src="https://apps.bdimg.com/libs/jquery/2.1.4/jquery.min.js"></script><script type="text/javascript" src="/js/clipboard.js"></script><script type="text/x-mathjax-config">MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [ ["$","$"], ["\\(","\\)"] ],
            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'],
            processEscapes: true
        }
    });
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax();
        for (var i = 0; i < all.length; ++i)
            all[i].SourceElement().parentNode.className += ' has-jax';
    });</script><script src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script></body><script>window.hexo_search_path="search.json",window.hexo_root="/",window.isPost=!0</script><script src="/js/index.js"></script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="/js/jquery.min.js"></script><script src="/js/prism.js"></script><script src="https://giscus.app/client.js" data-repo="wu3227834/wu3227834.github.io" data-repo-id="R_kgDOIh8vuA" data-category="General" data-category-id="DIC_kwDOIh8vuM4CpDjz" data-mapping="pathname" data-strict="0" data-reactions-enabled="1" data-emit-metadata="0" data-input-position="bottom" data-theme="preferred_color_scheme" data-lang="zh-CN" crossorigin="anonymous" async></script></html><script src="/js/fancybox/jquery.fancybox.min.js" key="fancybox_js"></script><script src="/js/fancybox/wrapImage.js" key="wrap_image_js"></script><link rel="stylesheet" href="/js/fancybox/jquery.fancybox.min.css" key="fancybox_css">