[{"title":"å®¹å™¨ overlay æ–‡ä»¶ç³»ç»Ÿç®€è¿°","url":"/2024/08/28/2024-08-28-å®¹å™¨ overlay æ–‡ä»¶ç³»ç»Ÿç®€è¿°/","content":"\nğŸ’¡ è½¬è½½è‡ª\n- https://www.zsythink.net/archives/4345\n- https://blog.csdn.net/qq_24433609/article/details/130430322\n- https://blog.csdn.net/m0_49023005/article/details/121583100\n\n## ç›®çš„\n\næœ‰ä¸ªé—®é¢˜å›°æƒ‘ç€æˆ‘ï¼šå®¹å™¨åˆ é™¤ docker rm åï¼Œdocker cp åˆ°å®¹å™¨å†…çš„æ–‡ä»¶ï¼Œåœ¨ /var/lib/docker/overlay2 ç›®å½•ä¸­æ˜¯å¦è¿˜ä¼šå­˜åœ¨\n\nç­”æ¡ˆï¼šå®¹å™¨åˆ é™¤å docker rm åï¼Œä¼šè‡ªåŠ¨åˆ é™¤ /var/lib/docker/overlay2 ä¸­çš„å¯¹åº”æ–‡ä»¶\n\nå®éªŒæ­¥éª¤\n\n```bash\ndocker run --name test-container -it busybox:latest sh\n## ä¸»æœºæ‹·è´æ–‡ä»¶åˆ°å®¹å™¨\ndocker cp test-file.txt  test-container:/tmp\n## å»  /var/lib/docker/overlay2  æŸ¥çœ‹æ˜¯å¦æœ‰æ­¤æ–‡ä»¶\ncd  /var/lib/docker/overlay2 \nfind ./ -name test-file.txt\n## å‘ç°åœ¨å®¹å™¨è¿è¡Œæ—¶ï¼Œè¯¥æ–‡ä»¶å­˜åœ¨ä¸ diff å’Œ merged ç›®å½•\n## å®¹å™¨å†…æ‰§è¡Œ exit é€€å‡ºå®¹å™¨ï¼Œå®¹å™¨ä¼šå¤„äº exited çŠ¶æ€ï¼Œæˆ–è€… docker stop \n## å‘ç°åœ¨å®¹å™¨åœæ­¢æˆ– exited çŠ¶æ€ï¼Œæ­¤æ—¶è¯¥æ–‡ä»¶ä¼šå­˜åœ¨äº diff æ–‡ä»¶ä¸­\n## åˆ é™¤å®¹å™¨åï¼Œæ­¤æ–‡ä»¶å°±ä¸å­˜åœ¨äº†\n\n## å› æ­¤å°±å¥½å¥‡è¿™å‡ ä¸ªç›®å½•çš„æ„ä¹‰\n## åŒæ—¶å‘ç° /var/lib/docker/overlay2  ä¸­çš„ hash id ä¸å®¹å™¨ id å¹¶ä¸å¯¹åº”ï¼Œå› æ­¤è€ƒè™‘å°±å’Œ overlay æ–‡ä»¶ç³»ç»Ÿæœ‰å…³äº†\n```\n\nç®€å•è§£é‡Šï¼Œä¾‹å¦‚ä¸‹è¾¹å®¹å™¨çš„ä¿¡æ¯ï¼š\n\n```bash\n## docker inspect 0fcfdcf1b5ff |jq '.[].GraphDriver'\n{\n  \"Data\": {\n    \"LowerDir\": \"/var/lib/docker/overlay2/3cc96d59abc8c7653b124c39277c4da2830640a1a7b0939175ab3b41b1983303-init/diff:/var/lib/docker/overlay2/27ac3a1da2eea77dd8ecfcbb10dda293196408630099796c77bbf71840163759/diff:/var/lib/docker/overlay2/0ca615083cdc29e27697c00bd1ab6ce548760a3101f83bb6f697cb6c63ffcc55/diff:/var/lib/docker/overlay2/d11260c6a8a656e6c689417a2eabf2a097e65935da20b979b3f143ff5b0e7d92/diff:/var/lib/docker/overlay2/ff38b128d890e22b98851afcd608d4e70980d5e2a67a074e65fc68d40fb11f9b/diff:/var/lib/docker/overlay2/c1764658c479cfb45edac77699a4da0d2e481e6999db23854a40d54369fb132c/diff:/var/lib/docker/overlay2/b853ec37273e73902d6e9d3aa9fcc5aa4215b2ef8d56e7076d5673c699c34820/diff:/var/lib/docker/overlay2/e8d350b0980d01b145a7ce8dcf68f66d66c89d1f8b043a73e1d073896c20cdac/diff:/var/lib/docker/overlay2/2f69b30f1e7f26b4dfcaf483306b66bff6d2a9f301f49f02c0847bddc413caaa/diff:/var/lib/docker/overlay2/fbc7a7f9c03dbcd7fd507b802186a563c10d70718c019138d0f04389b9acf2bb/diff:/var/lib/docker/overlay2/1902c5596c2e232ecd2f74c1485e9742b8aa36cffb17abca756efb5020fba82c/diff:/var/lib/docker/overlay2/fdacc494a2fc86b92a1b6fdcec7074f985e0ff07b94be74baeb86399dd7187e1/diff:/var/lib/docker/overlay2/ad913d5690c729d32aef928345f8f84dc5fe9df3fb8d6b1eaf38ecb541408a82/diff:/var/lib/docker/overlay2/3f9061393985ee37edb071aac649af44bc7d19fa71861517d83000f69ba0a889/diff:/var/lib/docker/overlay2/0160cfc728093c0d737eeee1ce87ee7dbb36c27f41fa8301e6a966dee3205fe7/diff:/var/lib/docker/overlay2/d56448445573eb1d2236fd855c13a322b817ceb8482e9a64a8afa1423fbe859d/diff:/var/lib/docker/overlay2/2c8c22223361f41b06da49379023c8be1812dad70acbd0fff4b98508d813a343/diff:/var/lib/docker/overlay2/eb90ded5e398c49c6127187b68d7cf6a878f686cb4475bfd427ada9521905191/diff:/var/lib/docker/overlay2/aa4b8e69ae8ba46ddf2cbaa1db9bb63dc630471f829360f540a774533249c060/diff:/var/lib/docker/overlay2/acfea1fe0ce15416c5efac6bab4b52a27aec7205f7fa899e568e1d9dda9fc03c/diff:/var/lib/docker/overlay2/f843b96cc41cb5948dd88233fa961ad2433889bb2765c8737cd0408e999bacf9/diff:/var/lib/docker/overlay2/45f0eafde0438ec844886856ed68e07b2eb65fe8133353aa4240489d074e6e74/diff:/var/lib/docker/overlay2/3bbb18f0ad656534f45b20e6c8a3a869f3a4f177c2859e39121244737b5bd4cb/diff:/var/lib/docker/overlay2/7de504f0fd3c6aa359ec06ded02d3153405f1c4f7fac29d1b88e351d166364bc/diff:/var/lib/docker/overlay2/bb25f883772fc8502362a124574b3a741090502eaed6268e869843087f98cbe4/diff:/var/lib/docker/overlay2/b93a3576a6fa85ad54890c6163ad26b5c6fda0f403a8e8768a6c052cfad39c93/diff:/var/lib/docker/overlay2/023afc8e2f044ac2d55a804d577b4b5a9f93ff67c5e041f02dc45636ae66d949/diff:/var/lib/docker/overlay2/15573352d289785a83a1ecaa3b65168e68185125e395478e66ca4d71dc5c8e34/diff:/var/lib/docker/overlay2/5d149bcd3163486f89923e9dbc7d067909fd4c2328b3693ee9b4cd2bacb7b5d3/diff:/var/lib/docker/overlay2/9a6e123d5b2659c82fa6955cfd3e689ec0b43cedf8cce3586d11f5b9de31377d/diff:/var/lib/docker/overlay2/ab95d820e29c009efc444c6a3caff6b0cdb7c56bdd18c3fefeac35fdc2048074/diff:/var/lib/docker/overlay2/1ae1804931b744310f3410ce5dedcc3910839fb9e5b55f0483a6bd4abef51521/diff\",\n    \"MergedDir\": \"/var/lib/docker/overlay2/3cc96d59abc8c7653b124c39277c4da2830640a1a7b0939175ab3b41b1983303/merged\",\n    \"UpperDir\": \"/var/lib/docker/overlay2/3cc96d59abc8c7653b124c39277c4da2830640a1a7b0939175ab3b41b1983303/diff\",\n    \"WorkDir\": \"/var/lib/docker/overlay2/3cc96d59abc8c7653b124c39277c4da2830640a1a7b0939175ab3b41b1983303/work\"\n  },\n  \"Name\": \"overlay2\"\n}\n```\n\nåœ¨ Docker  ä¸­ï¼Œä¸€ä¸ªå¾ˆé‡è¦çš„æ¦‚å¿µå°±æ˜¯ GraphDriverï¼Œå®ƒä¸»è¦ç”¨äºç®¡ç†å’Œç»´æŠ¤é•œåƒï¼ŒåŒ…æ‹¬æŠŠé•œåƒä»ä»“åº“ä¸‹è½½ä¸‹æ¥ï¼Œåˆ°è¿è¡Œæ—¶æŠŠé•œåƒæŒ‚è½½èµ·æ¥å¯ä»¥è¢«å®¹å™¨è®¿é—®ç­‰ï¼Œéƒ½æ˜¯ GraphDriver å»å®Œæˆçš„ã€‚\n\n- \"Name\": \"overlay2\"ï¼šdockerå­˜å‚¨é©±åŠ¨æ˜¯overlay2\n- LowerDirï¼šåŒ…å«å®¹å™¨å†…æ‰€æœ‰å±‚çš„æ–‡ä»¶ç³»ç»Ÿï¼Œæœ€åä¸€å±‚é™¤å¤–\n    - åŸºç¡€é•œåƒï¼Œå¯ä»¥çœ‹åˆ°æœ‰å¾ˆå¤š initï¼Œè¿™æ˜¯å¯¹åº” From çš„åŸºç¡€é•œåƒï¼ˆæ‰€æœ‰åªè¯»å±‚ï¼‰\n- UpperDirï¼šå®¹å™¨æœ€ä¸Šå±‚çš„æ–‡ä»¶ç³»ç»Ÿã€‚è¿™ä¹Ÿæ˜¯åæ˜ ä»»ä½•è¿è¡Œæ—¶ä¿®æ”¹çš„åœ°æ–¹\n    - å®¹å™¨è¯»å†™å±‚\n- MergedDirï¼šæ–‡ä»¶ç³»ç»Ÿæ‰€æœ‰å±‚çš„ç»„åˆè§†å›¾\n    - è”åˆæŒ‚è½½å±‚ ï¼šå°† åŸºç¡€å±‚å’Œå®¹å™¨è¯»å†™å±‚  æŒ‚è½½åœ¨ä¸€èµ· ï¼Œå±•ç¤ºä¸€ä¸ªç»Ÿä¸€çš„è§†å›¾\n- WorkDirï¼šç”¨äºç®¡ç†æ–‡ä»¶ç³»ç»Ÿçš„å†…éƒ¨å·¥ä½œç›®å½•\n\n![GraphDriver ç¤ºæ„å›¾](/img/2024-08-28-äº†è§£å®¹å™¨overlayæ–‡ä»¶ç³»ç»Ÿ/Untitled.png)\n\n## å®ä¾‹\n\né€šè¿‡ä¸Šè¿°å®éªŒï¼Œæˆ‘ä»¬å·²ç»å¯¹ overlay2 æœ‰äº†ä¸€å®šè®¤è¯†äº†ï¼Œç°åœ¨ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹ overlay2 æ˜¯æ€æ ·å’Œ docker ä¸­çš„é•œåƒå±‚ä»¥åŠå®¹å™¨å±‚ç»“åˆåœ¨ä¸€èµ·çš„ã€‚\n\nå½“æˆ‘ä»¬é€šè¿‡ docker pull å‘½ä»¤æ‹‰å»ç¬¬ä¸€ä¸ªé•œåƒæ—¶ï¼Œå¯ä»¥çœ‹åˆ°é•œåƒæ¯ä¸€å±‚è¢«æ‹‰å–çš„è¿‡ç¨‹ï¼Œä¾‹å¦‚\n\n```bash\n[root@pudding-160 ~]## docker pull 172.16.1.99/hippo/runtime/x86/faiss_benchmark:20240712_68ba1e1\n20240712_68ba1e1: Pulling from hippo/runtime/x86/faiss_benchmark\n648c0ccfae96: Pull complete\nd77e7370c4fa: Pull complete\n00701f0aa522: Pull complete\nd4516580db57: Pull complete\nfca65a19a3bf: Pull complete\nDigest: sha256:e9b215174cd7a01eafd1913d2bd1c59aafd797649de906dea53eda3582dfdc6b\nStatus: Downloaded newer image for 172.16.1.99/hippo/runtime/x86/faiss_benchmark:20240712_68ba1e1\n```\n\nå¦‚ä¸Šæ‰€è§ï¼Œæ­¤å¤„æ‹‰å–çš„ `faiss_benchmark:20240712_68ba1e1` é•œåƒä¸€å…±æœ‰ 5 å±‚ï¼Œæ¯ä¸€å±‚æ‹‰å–å®Œæ¯•åï¼Œéƒ½ä¼šæ˜¾ç¤º Pull completeï¼ˆAlready exists åˆ™è¡¨ç¤ºæœ¬åœ°ç›®å½•å·²ç»æœ‰è¯¥å±‚çš„æ–‡ä»¶ï¼‰ï¼›æ¯ä¸€å±‚éƒ½æœ‰ä¸€ä¸ª ID å·ï¼Œæ¯”å¦‚ä¸Šåˆ—ä¸­çš„ 648c0ccfae96 å°±æ˜¯å±‚çš„å“ˆå¸Œå€¼å‰ 12 ä½ã€‚\n\nä¸‹è½½é•œåƒåï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ docker inspect å‘½ä»¤æŸ¥çœ‹é•œåƒçš„è¯¦ç»†ä¿¡æ¯ï¼Œåœ¨é•œåƒçš„è¯¦ç»†ä¿¡æ¯ä¸­æ‰¾åˆ° RootFS æ®µï¼Œå¯ä»¥æŸ¥çœ‹å½“å‰é•œåƒåŒ…å«çš„å±‚ï¼Œå¦‚ä¸‹ï¼š\n\n```bash\n[root@pudding-160 ~]## docker inspect 172.16.1.99/hippo/runtime/x86/faiss_benchmark:20240712_68ba1e1 | jq '.[].RootFS'\n{\n  \"Type\": \"layers\",\n  \"Layers\": [\n    \"sha256:4f118a86fef9debde65113068bd2b85f9c5fd65250ac6af2e8281a502cc0a724\",\n    \"sha256:004114a8d0e34895acdd9c1c370b1184b239d538e3951887d04d1bda771bd441\",\n    \"sha256:0d5cae34765c1f89a17e5e8e7e6f6f9ddc541151e3efab2487b013faeecac3a6\",\n    \"sha256:fbc981c1f97f7139dd25bc0924272ae4f8f9e07d8c57a1ca4b0c9344266a93ff\",\n    \"sha256:457b93dcc46ca598ce9378e015aae678218bb9a699c4e373250e4021b60c0566\"\n  ]\n}\n```\n\nå¦‚ä¸Šæ‰€ç¤ºï¼Œfaiss_benchmark é•œåƒçš„ RootFS æ®µä¸­ä¸€å…±æœ‰ 5 å±‚ï¼Œè¿™ 5 ä¸ªå±‚å°±æ˜¯åˆšæ‰ docker pull æ‹‰å–ä¸‹æ¥çš„å±‚ï¼ŒRootFS ä¸­çš„æ¯ä¸ªå±‚ä¹Ÿæ˜¯ç”¨ä¸€ä¸ªå“ˆå¸Œå€¼è¡¨ç¤ºï¼ŒRootFS ä¸­çš„å±‚çš„å“ˆå¸Œå€¼çš„å‰ 12 ä½å’Œåˆšæ‰ docker pull å‘½ä»¤ä¸­çš„ ID æ ¹æœ¬å¯¹åº”ä¸ä¸Šï¼Œè¿™æ˜¯å› ä¸º dcoker pull ä¸­æ˜¾ç¤ºçš„ ID æ˜¯å±‚åœ¨å‹ç¼©çŠ¶æ€ä¸‹è®¡ç®—å‡ºçš„å“ˆå¸Œå€¼ï¼Œå½“å±‚è¢«ä¸‹è½½åˆ°æœ¬åœ°ï¼Œä¼šè‡ªåŠ¨è§£å‹ï¼Œè€Œ RootFS ä¸­çš„å±‚å“ˆå¸Œå€¼ä¸æ˜¯åœ¨å‹ç¼©çŠ¶æ€ä¸‹è®¡ç®—çš„ï¼Œæ˜¾ç„¶å®ƒä»¬ä¸¤ä¸ªçš„å€¼ä¸ä¼šä¸€æ ·ã€‚å¦‚æœæƒ³è¦ç¡®å®šå®ƒä»¬ä¹‹é—´çš„å¯¹åº”å…³ç³»ï¼Œå¯ä»¥é€šè¿‡ `diffid-by-digestæˆ–è€…v2metadata-by-diffid/sha256/`ç›®å½•ä¸­çš„æ–‡ä»¶æ¥æŸ¥çœ‹å®ƒä»¬ä¹‹é—´çš„å¯¹åº”å…³ç³»\n\n```bash\n[root@pudding-160 distribution]## pwd\n/var/lib/docker/image/overlay2/distribution\n[root@pudding-160 distribution]## tree -L 2\n.\nâ”œâ”€â”€ diffid-by-digest\nâ”‚Â Â  â””â”€â”€ sha256\nâ””â”€â”€ v2metadata-by-diffid\n    â””â”€â”€ sha256\n\n4 directories, 0 files\n```\n\n- `diffid-by-digest/sha256`ï¼š\n    - è¿™ä¸ªç›®å½•å­˜å‚¨äº†æŒ‰é•œåƒå±‚çš„ Digest (SHA256) è®¡ç®—çš„æ˜ å°„åˆ° DiffID çš„ä¿¡æ¯ã€‚\n    - Digest æ˜¯ä¸€ä¸ªå”¯ä¸€æ ‡è¯†ç¬¦ï¼Œç”¨äºè¯†åˆ«é•œåƒå±‚çš„å†…å®¹ã€‚\n    - DiffID æ˜¯é•œåƒå±‚çš„ä¸€ä¸ªå˜åŒ– IDï¼Œè¡¨ç¤ºè¿™ä¸€å±‚å’Œå®ƒä¸‹é¢ä¸€å±‚ä¹‹é—´çš„å·®å¼‚ã€‚\n    - è¿™ä¸ªæ˜ å°„æ–‡ä»¶å¯ä»¥å¸®åŠ© Docker å¿«é€ŸæŸ¥æ‰¾ç‰¹å®šå±‚çš„å˜åŒ–ä¿¡æ¯ã€‚\n- `v2metadata-by-diffid/sha256`ï¼š\n    - è¿™ä¸ªç›®å½•å­˜å‚¨äº†æŒ‰ DiffID (SHA256) è®¡ç®—çš„æ˜ å°„åˆ° v2 å…ƒæ•°æ®çš„æ–‡ä»¶ã€‚\n    - è¿™äº›å…ƒæ•°æ®åŒ…æ‹¬å…³äºé•œåƒå±‚çš„å„ç§ä¿¡æ¯ï¼Œå¦‚åˆ›å»ºæ—¶é—´ã€å¤§å°ã€æ ‡ç­¾ç­‰ã€‚\n    - è¿™ä¸ªç›®å½•æœ‰åŠ©äº Docker ç®¡ç†å’Œæ£€ç´¢ä¸ç‰¹å®šå±‚ç›¸å…³çš„å…ƒæ•°æ®ã€‚\n\nä¾‹å¦‚ 289ce7e41289 çš„å¯¹åº”å…³ç³»ï¼š\n\n```bash\n[root@pudding-160 sha256]## find . -name \"648c0ccfae96*\"\n./648c0ccfae963a8b0d71c267d8cb5bb4fc6f26f5e9bd05ab7a6f82db8e95332e\n[root@pudding-160 sha256]## cat ./648c0ccfae963a8b0d71c267d8cb5bb4fc6f26f5e9bd05ab7a6f82db8e95332e\nsha256:4f118a86fef9debde65113068bd2b85f9c5fd65250ac6af2e8281a502cc0a724\n\nè¿™æ˜¯æˆ‘ä»¬å¯ä»¥çœ‹åˆ° docker pull ä¸­çš„ 648c0ccfae96 å’Œ docker insepct ä¸­çš„ 648c0ccfae96 è”ç³»äº†èµ·æ¥\n```\n\nåœ¨ RootFS æ‰€æ˜¾ç¤ºçš„å±‚ä¸­ï¼Œç¬¬ä¸€å±‚æ˜¯æœ€åº•å±‚ï¼Œæœ€åä¸€è¡Œæ˜¯æœ€ä¸Šå±‚ï¼ŒRootFS æ˜¾ç¤ºçš„å±‚é¡ºåºå’Œåœ¨é•œåƒä¸­çš„å®é™…é¡ºåºæ˜¯ç›¸åçš„ï¼Œåœ¨ä¸Šä¾‹ä¸­ 4f118a86fef9d æ˜¯é•œåƒæœ€åº•å±‚ï¼Œ457b93dcc46 æ˜¯é•œåƒçš„æœ€ä¸Šå±‚ã€‚\n\næ—¢ç„¶è¿™äº›å±‚å·²ç»ä¸‹è½½åˆ°æœ¬åœ°ï¼Œé‚£ä¹ˆè¿™äº›å±‚å¯¹åº”çš„æ–‡ä»¶åˆ°åº•å­˜æ”¾åˆ°é‚£é‡Œå‘¢ï¼Ÿæˆ‘ä»¬å¯ä»¥é€šè¿‡å¦‚ä¸‹å‘½ä»¤ï¼Œå¯ä»¥æŸ¥çœ‹è¿™äº›å±‚çš„å®é™…å­˜æ”¾ä½ç½®ã€‚\n\n```bash\n[root@pudding-160 sha256]## docker inspect 172.16.1.99/hippo/runtime/x86/faiss_benchmark:20240712_68ba1e1 -f '{{.GraphDriver.Data}}' | awk -v RS=' ' '{print}' | nl | sort -nr | cut -f2 | awk -v RS=':' '{print}' | grep diff\n/var/lib/docker/overlay2/43722a4a12628179c70d588fcc7f64b86aa92cbd30c8599035d0433059423dcf/diff\n/var/lib/docker/overlay2/0fed41f6f307ef92b1b1d475108575f0130d224eb008dfa3ff4383c8fa506de6/diff\n/var/lib/docker/overlay2/cd5c2d405030b7ed966d1b78c3b038c1c6b313b8be7d0033835bf9ae20c34c37/diff\n/var/lib/docker/overlay2/784dc7dce7d8625dc10a4fa065f2a1f27ff65e19def543c9f491f32575ec09dd/diff\n/var/lib/docker/overlay2/0fee07bf5795a78e666b18059a4f64eb84d184d07eb6a5d1118ed487338e9edf/diff\n```\n\nå¦‚ä¸Šæ‰€ç¤ºï¼Œè¿™äº›å±‚å®é™…å­˜æ”¾åœ¨ `/var/lib/docker/overlay2/å±‚å“ˆå¸Œå€¼/diff`ç›®å½•ä¸­ï¼Œå¾ˆæ˜æ˜¾ï¼Œä¸Šè¿°å‘½ä»¤æŸ¥è¯¢å‡ºçš„è·¯å¾„ä¸­çš„å±‚å“ˆå¸Œå€¼å’Œä¹‹å‰`docker pull`æˆ–è€…`RootFS`ä¸­æ˜¾ç¤ºçš„å“ˆå¸Œå€¼éƒ½ä¸ä¸€æ ·ï¼Œä¸Šè¿°è·¯å¾„ä¸­çš„å“ˆå¸Œå€¼æ˜¯æ ¹æ®ä¸€å®šçš„è§„å¾‹ï¼Œå±‚å±‚é€’è¿›è®¡ç®—å‡ºæ¥çš„ï¼Œå¦‚æœå¯¹è¿™äº›å“ˆå¸Œå€¼ä¹‹é—´çš„å…³ç³»å’Œè®¡ç®—æ–¹æ³•æ„Ÿå…´è¶£ï¼Œå¯ä»¥å»æœç´¢â€œdocker layerID diffID chainID cacheIDâ€è¿™äº›å…³é”®å­—ï¼Œè¿™å¹¶ä¸æ˜¯æ­¤å¤„è¦å…³æ³¨çš„é‡ç‚¹ï¼Œæ‰€ä»¥ä¸ç”¨çº ç»“è¿™äº›ç»†èŠ‚ï¼Œæˆ‘ä»¬åªè¦çŸ¥é“ï¼Œè¿™äº›æŸ¥å‡ºæ¥è·¯å¾„å°±æ˜¯é•œåƒå±‚å®é™…çš„å­˜æ”¾è·¯å¾„å³å¯ã€‚\n\nç”±äºä¸Šè¿°å‘½ä»¤å·²ç»å®Œæˆäº†æ’åºï¼Œæ‰€ä»¥æˆ‘ä»¬çœ‹åˆ°çš„å±‚çš„é¡ºåºå°±æ˜¯å¯¹åº”å±‚åœ¨é•œåƒä¸­çš„ä½ç½®ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œä¸Šä¾‹ä¸­æŸ¥è¯¢å‡ºæ¥çš„ 43722a4a12628 æ˜¯æœ€ä¸Šå±‚ï¼Œå¯¹åº” RootFS ä¸­çš„ 457b93dcc46 ï¼Œä¸Šä¾‹ä¸­çš„ 0fee07bf5795a7 æ˜¯æœ€ä¸‹å±‚ï¼Œå¯¹åº” RootFS ä¸­çš„ 4f118a86fef9d ï¼Œæ€»ä¹‹ï¼Œé•œåƒçš„å±‚å¯¹åº”çš„æ–‡ä»¶å®é™…å­˜æ”¾åœ¨ diff ç›®å½•ä¸­ã€‚\n\nå…¶å®èŠäº†åŠå¤©ï¼Œæ— ééƒ½æ˜¯åœ¨è¯´é•œåƒçš„å±‚è€Œå·²ï¼Œç°åœ¨å’±ä»¬åŸºäºé•œåƒï¼Œåˆ›å»ºä¸€ä¸ªå®¹å™¨ï¼Œçœ‹çœ‹å®¹å™¨å±‚æ˜¯æ€ä¹ˆå’Œé•œåƒå±‚ç»“åˆçš„ã€‚\n\næ­¤å¤„åŸºäº faiss_benchmark é•œåƒåˆ›å»ºä¸€ä¸ª faiss-demo1 å®¹å™¨ï¼š\n\n```bash\ndocker run --name faiss-demo1 -dit 172.16.1.99/hippo/runtime/x86/faiss_benchmark:20240712_68ba1e1 bash\n```\n\nä½¿ç”¨ docker inspect å‘½ä»¤æŸ¥çœ‹å®¹å™¨çš„è¯¦ç»†ä¿¡æ¯ï¼Œåœ¨è¯¦ç»†ä¿¡æ¯çš„ GraphDriver æ®µå¯ä»¥çœ‹åˆ°å®¹å™¨çš„å±‚ä¿¡æ¯ï¼š\n\n```bash\n[root@pudding-160 ~]## docker inspect faiss-demo1 | jq '.[].GraphDriver'\n{\n  \"Data\": {\n    \"LowerDir\": \"/var/lib/docker/overlay2/c156d03c1532a2efce8670b7d665e0d4840e1b798c47998b8f746c3aaf8d82b4-init/diff:/var/lib/docker/overlay2/0fee07bf5795a78e666b18059a4f64eb84d184d07eb6a5d1118ed487338e9edf/diff:/var/lib/docker/overlay2/43722a4a12628179c70d588fcc7f64b86aa92cbd30c8599035d0433059423dcf/diff:/var/lib/docker/overlay2/0fed41f6f307ef92b1b1d475108575f0130d224eb008dfa3ff4383c8fa506de6/diff:/var/lib/docker/overlay2/cd5c2d405030b7ed966d1b78c3b038c1c6b313b8be7d0033835bf9ae20c34c37/diff:/var/lib/docker/overlay2/784dc7dce7d8625dc10a4fa065f2a1f27ff65e19def543c9f491f32575ec09dd/diff\",\n    \"MergedDir\": \"/var/lib/docker/overlay2/c156d03c1532a2efce8670b7d665e0d4840e1b798c47998b8f746c3aaf8d82b4/merged\",\n    \"UpperDir\": \"/var/lib/docker/overlay2/c156d03c1532a2efce8670b7d665e0d4840e1b798c47998b8f746c3aaf8d82b4/diff\",\n    \"WorkDir\": \"/var/lib/docker/overlay2/c156d03c1532a2efce8670b7d665e0d4840e1b798c47998b8f746c3aaf8d82b4/work\"\n  },\n  \"Name\": \"overlay2\"\n}\n```\n\nä»”ç»†è§‚å¯Ÿä¸Šåˆ—çš„è¿”å›ä¿¡æ¯ï¼Œä½ ä¼šå‘ç°ï¼Œfaiss-demo1 å®¹å™¨å…¶å®å°±æ˜¯ä½¿ç”¨äº† overlay2 æ–‡ä»¶ç³»ç»Ÿï¼Œå°† faiss_benchmark é•œåƒå„ä¸ªå±‚çš„ diff ç›®å½•ä½œä¸º LowerDir åªè¯»å±‚ï¼ˆåœ¨è¿™ä¸ªåŸºç¡€ä¸Šæ·»åŠ äº†ä¸€å±‚ init åªè¯»å±‚ï¼Œä¹‹åå†èŠå®ƒï¼‰ï¼Œå°†å®¹å™¨çš„ diff ç›®å½•ï¼ˆc156d03c1532 æ–‡ä»¶å¤¹ä¸­çš„ diff ç›®å½•ï¼‰ä½œä¸º UpperDir å¯è¯»å†™å±‚ï¼Œå åŠ åå‘ˆç°åœ¨äº† MergedDir å±‚ï¼ˆMergedDir æ˜¯ c156d03c1532 æ–‡ä»¶å¤¹ä¸­çš„ merged ç›®å½•ï¼‰ï¼Œè€Œæˆ‘ä»¬åœ¨å®¹å™¨ä¸­çœ‹åˆ°çš„ã€æ“ä½œçš„æ–‡ä»¶ï¼Œå…¶å®å°±æ˜¯ MergedDir ä¸­çš„å†…å®¹ã€‚\n\næˆ‘ä»¬ä»å®¿ä¸»æœºçš„æŒ‚è½½ä¿¡æ¯ä¸­ï¼Œä¹Ÿå¯ä»¥ä¾§é¢éªŒè¯è¿™ä¸€ç‚¹ï¼Œåœ¨å®¹å™¨å¯åŠ¨çš„æƒ…å†µä¸‹ï¼Œæ‰§è¡Œå¦‚ä¸‹å‘½ä»¤ï¼ŒæŸ¥çœ‹å¯¹åº”çš„ overlay2æŒ‚è½½ç‚¹ä¿¡æ¯ï¼š\n\n```bash\n[root@pudding-160 ~]## mount | grep overlay | grep c156d03c1532\noverlay on /var/lib/docker/overlay2/c156d03c1532a2efce8670b7d665e0d4840e1b798c47998b8f746c3aaf8d82b4/merged type overlay (rw,relatime,lowerdir=/var/lib/docker/overlay2/l/62APW7R2QAZIKL2JBXGDL2SZFX:/var/lib/docker/overlay2/l/VHFAUXFFYMW7NZ5S3SKLFYMS6R:/var/lib/docker/overlay2/l/FUWWJ73CD3TWQY4ESCXJSQD3Y7:/var/lib/docker/overlay2/l/V2E4YYCC3PEBB4VYHJ3P2E7JMA:/var/lib/docker/overlay2/l/5FRUEQSAL6URPMBZ4V5VHEOJDR:/var/lib/docker/overlay2/l/54MNMNIOUGOPX7SLOTKFTZHE5R,upperdir=/var/lib/docker/overlay2/c156d03c1532a2efce8670b7d665e0d4840e1b798c47998b8f746c3aaf8d82b4/diff,workdir=/var/lib/docker/overlay2/c156d03c1532a2efce8670b7d665e0d4840e1b798c47998b8f746c3aaf8d82b4/work)\n\n#ä¸Šè¿°æŒ‚è½½ç‚¹ä¸­çš„æœ‰å¾ˆå¤š/var/lib/docker/overlay2/l/ä¸‹çš„è·¯å¾„ï¼ŒæŸ¥çœ‹è¿™äº›è·¯å¾„ï¼Œä¼šå‘ç°è¿™äº›è·¯å¾„éƒ½æ˜¯è½¯é“¾æ¥ï¼Œè½¯è¿æ¥æŒ‡å‘çš„è·¯å¾„å°±æ˜¯é‚£äº›diffç›®å½•\n[root@pudding-160 ~]## ll /var/lib/docker/overlay2/l/62APW7R2QAZIKL2JBXGDL2SZFX\nlrwxrwxrwx 1 root root 77 Jul 29 15:47 /var/lib/docker/overlay2/l/62APW7R2QAZIKL2JBXGDL2SZFX -> ../c156d03c1532a2efce8670b7d665e0d4840e1b798c47998b8f746c3aaf8d82b4-init/diff\n[root@pudding-160 ~]#\n[root@pudding-160 ~]## ll /var/lib/docker/overlay2/l/VHFAUXFFYMW7NZ5S3SKLFYMS6R\nlrwxrwxrwx 1 root root 72 Jul 29 15:38 /var/lib/docker/overlay2/l/VHFAUXFFYMW7NZ5S3SKLFYMS6R -> ../0fee07bf5795a78e666b18059a4f64eb84d184d07eb6a5d1118ed487338e9edf/diff\n```\n\nçœ‹åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬åº”è¯¥èƒ½å¤Ÿå®Œå…¨ç†è§£é•œåƒå±‚ã€å®¹å™¨å±‚ã€overlay2 æ–‡ä»¶ç³»ç»Ÿæ—¶æ€ä¹ˆèåˆåœ¨ä¸€èµ·çš„äº†ã€‚é¦–å…ˆï¼Œé•œåƒä¸‹è½½åˆ°æœ¬åœ°åï¼Œå„ä¸ªé•œåƒå±‚çš„æ–‡ä»¶å­˜æ”¾åœ¨å¯¹åº”çš„ diff ç›®å½•ä¸­ï¼Œå½“æˆ‘ä»¬åŸºäºé•œåƒåˆ›å»ºå®¹å™¨æ—¶ï¼Œdocekr å¼•æ“ä¼šä¸ºå®¹å™¨åˆ›å»ºå¯¹åº”çš„å„ä¸ªç›®å½•ï¼Œæ¯”å¦‚ diffã€workã€merged ç›®å½•ï¼Œç„¶åæŠŠé•œåƒå±‚çš„ diff ç›®å½•ä½œä¸º overlay ä¸­çš„ lowerDirï¼Œå°†å®¹å™¨çš„ diff ç›®å½•ä½œä¸º overlay ä¸­ upperDirï¼Œå°†æŠ˜å åçš„ç»“æœæŒ‚è½½åˆ°äº† merge ç›®å½•ä¸­ï¼Œæœ€åï¼Œdocekr é€šè¿‡ `mount namespace` æŠ€æœ¯ï¼Œå°† merged ç›®å½•éš”ç¦»æŒ‚è½½åˆ°å®¹å™¨ä¸­ã€‚\n\nç°åœ¨ï¼Œå†çœ‹ä¸‹å›¾æ˜¯ä¸æ˜¯ä¸€ç›®äº†ç„¶äº†\n\n![é•œåƒå±‚ã€å®¹å™¨å±‚ä¹‹é—´çš„å…³ç³»](/img/2024-08-28-äº†è§£å®¹å™¨overlayæ–‡ä»¶ç³»ç»Ÿ/Untitled1.png)\n\nä½ å¯ä»¥åšä¸€äº›å®éªŒï¼Œæ¯”å¦‚ï¼Œåœ¨å®¹å™¨ä¸­åˆ›å»ºä¸€äº›æ–‡ä»¶ï¼Œä¿®æ”¹ä¸€äº›æ–‡ä»¶ï¼Œçœ‹çœ‹å®¹å™¨çš„ diff ç›®å½•ä¸­çš„å˜åŒ–æƒ…å†µï¼Œå› ä¸ºå®¹å™¨çš„ diff ç›®å½•å°±æ˜¯è¯»å†™å±‚ï¼Œå½“åœ¨å®¹å™¨ä¸­è¿›è¡Œå†™æ“ä½œæ—¶ï¼Œæœ€ç›´æ¥çš„å˜åŒ–ä¼šä½“ç°åˆ°å®¹å™¨çš„ diff ç›®å½•ä¸­ï¼Œä½†æ˜¯ï¼Œä½ å¯èƒ½ä¼šé‡åˆ°ä¸€äº›â€œæ„å¤–æƒ…å†µâ€ï¼Œæ¯”å¦‚ï¼Œä½ åœ¨å®¹å™¨ä¸­ä¿®æ”¹äº†/etc/hosts æ–‡ä»¶ï¼Œå‘ç°å®¹å™¨çš„ diff ç›®å½•ä¸­å¹¶æ²¡æœ‰å¯¹åº”çš„ /etc/hosts æ–‡ä»¶å‡ºç°ï¼Œè¿™æ˜¯å› ä¸ºæœ‰ä¸€ä¸ªç‰¹æ®Šçš„å±‚å­˜åœ¨ï¼Œè¿™ä¸ªå±‚å°±æ˜¯æˆ‘ä»¬åˆšæ‰çœ‹åˆ°çš„â€-initå±‚â€ã€‚å½“æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªå®¹å™¨æ—¶ï¼Œdocker ä¼šä¸ºå®¹å™¨è¿›è¡Œä¸€äº›åˆå§‹åŒ–å·¥ä½œï¼Œå…¶ä¸­å°±åŒ…æ‹¬ç”Ÿæˆ hosts ä¿¡æ¯ã€ç”Ÿæˆ hostname ç­‰ï¼Œä½ ä¼šå‘ç°ï¼Œå³ä½¿ä½ åœ¨å®¹å™¨ä¸­ä¿®æ”¹äº† /etc/host æ–‡ä»¶ï¼Œé‡å¯å®¹å™¨åï¼Œhosts æ–‡ä»¶ä¹Ÿä¼šå˜æˆåŸæ¥çš„æ ·å­ï¼ˆé€šè¿‡å…¶ä»–æ–¹æ³•å¯ä»¥æ°¸ä¹…ä¿®æ”¹ï¼‰ï¼Œå› ä¸º /etc/hostsã€/etc/hostnameã€/etc/resolv.conf æ–‡ä»¶ä¸­çš„ä¿¡æ¯éƒ½æ˜¯ docker ç”Ÿæˆçš„ï¼Œdocker è®¤ä¸ºè¿™äº›ä¿¡æ¯åº”è¯¥æ˜¯é’ˆå¯¹å®¹å™¨å½“å‰çš„çŠ¶æ€è€Œå­˜åœ¨çš„ï¼Œä»¥ hosts æ–‡ä»¶ä¸ºä¾‹æ¥è¯´ï¼Œå¦‚æœå®¹å™¨æ²¡æœ‰å›ºå®šçš„ IP åœ°å€ï¼Œé‚£ä¹ˆé‡å¯å®¹å™¨åï¼Œå®¹å™¨çš„ IP å¯èƒ½ä¼šå‘ç”Ÿå˜åŒ–ï¼Œæ‰€ä»¥æ¯æ¬¡é‡å¯å®¹å™¨æ—¶ docker éƒ½ä¼šé‡æ–°ç”Ÿæˆ hosts å†…å®¹ï¼Œé¿å…ä¹‹å‰ç”Ÿæˆçš„ hosts ä¸å½“å‰çŠ¶æ€æ‰€éœ€è¦çš„ hosts ä¸ç¬¦ï¼Œå½“æˆ‘ä»¬åœ¨å®¹å™¨ä¸­ä¿®æ”¹  /etc/hosts æ–‡ä»¶æ—¶ï¼Œä¼šå‘ç°å®¿ä¸»æœºä¸­çš„`/var/lib/docker/containers/å®¹å™¨ID/`ç›®å½•ä¸‹çš„ hosts æ–‡ä»¶å†…å®¹ä¹Ÿå‘ç”Ÿäº†åŒæ ·çš„å˜åŒ–ï¼Œå…¶å®ï¼Œdocker å°±æ˜¯å°†å®¿ä¸»æœºä¸­çš„`/var/lib/docker/containers/å®¹å™¨ID/hosts`æ–‡ä»¶æŒ‚è½½åˆ°äº†å®¹å™¨ä¸­çš„ï¼Œæ—¢ç„¶è¿™äº›çŠ¶æ€åº”è¯¥å±äºå®¹å™¨ï¼Œé‚£ä¹ˆå½“æˆ‘ä»¬åŸºäºå®¹å™¨åˆ›å»ºé•œåƒæ—¶ï¼Œå°±ä¸åº”è¯¥æŠŠå®¹å™¨ä¸­çš„è¿™äº›ä¿¡æ¯å¸¦å…¥åˆ°æ–°åˆ›å»ºçš„é•œåƒä¸­ï¼Œå½“æˆ‘ä»¬ä½¿ç”¨`docker commit`å‘½ä»¤åŸºäºå®¹å™¨åˆ›å»ºé•œåƒæ—¶ï¼Œä¼šæŠŠå®¹å™¨çš„å¯è¯»å†™å±‚å˜æˆæ–°åˆ›å»ºå‡ºçš„é•œåƒçš„æœ€ä¸Šå±‚ï¼Œæ‰€ä»¥ï¼Œå¦‚æœå®¹å™¨çš„å¯è¯»å†™å±‚ä¸­åŒ…å« hosts æ–‡ä»¶ï¼Œæ–°é•œåƒä¸­å°±ä¼šå¸¦å…¥å®¹å™¨çš„ hosts ä¿¡æ¯ï¼Œè€Œå®¹å™¨å› ä¸º init å±‚å’ŒæŒ‚è½½æ“ä½œçš„å­˜åœ¨ï¼Œé¿å…äº†è¿™äº›ä¿¡æ¯è¿›å…¥åˆ°å®¹å™¨çš„å¯è¯»å†™å±‚ï¼Œæ‰€ä»¥å¯ä»¥ä¿éšœæˆ‘ä»¬åŸºäºå®¹å™¨åˆ›å»ºé•œåƒæ—¶ï¼Œå¾—åˆ°çš„é•œåƒæ˜¯â€œçº¯å‡€â€çš„ã€‚\n\n## å‰è¨€\n\n### rootfs\n\nåœ¨è®² overlay2 ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦å…ˆç®€å•äº†è§£ä¸€ä¸‹ä»€ä¹ˆæ˜¯ rootfsï¼š\n\nrootfs ä¹Ÿå« **æ ¹æ–‡ä»¶ç³»ç»Ÿ**ï¼Œæ˜¯ Linux ä½¿ç”¨çš„æœ€åŸºæœ¬çš„æ–‡ä»¶ç³»ç»Ÿï¼Œæ˜¯å†…æ ¸å¯åŠ¨æ—¶æŒ‚è½½çš„ç¬¬ä¸€ä¸ªæ–‡ä»¶ç³»ç»Ÿï¼Œæä¾›äº†æ ¹ç›®å½• `/` ï¼Œæ ¹æ–‡ä»¶ç³»ç»Ÿçš„å„ä¸ªç›®å½•ï¼Œä¾‹å¦‚ /binã€/etcã€/mnt ç­‰ï¼Œå†å°†å…¶ä»–åˆ†åŒºæŒ‚è½½åˆ° /mntï¼Œ/mnt ç›®å½•ä¸‹å°±æœ‰äº†è¿™ä¸ªåˆ†åŒºçš„å„ä¸ªç›®å½•å’Œæ–‡ä»¶ã€‚\n\ndocker å®¹å™¨ä¸­ä½¿ç”¨çš„åŒæ ·ä¹Ÿæ˜¯ rootfs è¿™ç§æ–‡ä»¶ç³»ç»Ÿï¼Œå½“æˆ‘ä»¬é€šè¿‡ `dockr exec` å‘½ä»¤è¿›å…¥åˆ°å®¹å™¨å†…éƒ¨æ—¶ä¹Ÿå¯ä»¥çœ‹åˆ°åœ¨æ ¹ç›®å½•ä¸‹æœ‰ /binã€/etcã€/tmp ç­‰ç›®å½•ï¼Œä½†æ˜¯åœ¨ docker å®¹å™¨ä¸­ä¸ Linux ä¸åŒçš„æ˜¯ï¼Œåœ¨æŒ‚è½½ rootfs åï¼Œdocker deamon ä¼šåˆ©ç”¨**è”åˆæŒ‚è½½æŠ€æœ¯**åœ¨å·²æœ‰çš„ rootfs ä¸Šå†æŒ‚è½½ä¸€ä¸ªè¯»å†™å±‚ï¼Œå®¹å™¨åœ¨è¿è¡Œè¿‡ç¨‹ä¸­æ–‡ä»¶ç³»ç»Ÿå‘ç”Ÿçš„å˜åŒ–åªä¼šåœ¨è¯»å†™å±‚è¿›è¡Œä¿®æ”¹ï¼Œå¹¶é€šè¿‡ whiteout æ–‡ä»¶éšè—åªè¯»å±‚ä¸­çš„æ—§ç‰ˆæœ¬æ–‡ä»¶ã€‚\n\n> whiteout æ–‡ä»¶ï¼š\nwhiteout æ¦‚å¿µå­˜åœ¨äºè”åˆæ–‡ä»¶ç³»ç»Ÿï¼ˆUnionFSï¼‰ä¸­ï¼Œä»£è¡¨æŸä¸€ç±»å ä½ç¬¦å½¢æ€çš„ç‰¹æ®Šæ–‡ä»¶ï¼Œå½“ç”¨æˆ·æ–‡ä»¶å¤¹çš„å…±é€šéƒ¨åˆ†è”åˆåˆ°ä¸€ä¸ªç›®å½•æ—¶ï¼ˆä¾‹å¦‚ binï¼‰ç›®å½•ï¼Œç”¨æˆ·å¯ä»¥åˆ é™¤å½’å±äºè‡ªå·±çš„æŸäº›ç³»ç»Ÿæ–‡ä»¶å‰¯æœ¬ï¼Œä½†å½’å±äºç³»ç»Ÿçº§çš„åŸä»¶ä»å­˜ç•™äºåŒä¸€ä¸ªè”åˆç›®å½•ï¼Œæ­¤æ—¶ç³»ç»Ÿå°†äº§ç”Ÿä¸€ä»½ whiteout æ–‡ä»¶ï¼Œè¡¨ç¤ºè¯¥æ–‡ä»¶åœ¨å½“å‰ç”¨æˆ·ç›®å½•ä¸­å·²åˆ é™¤ï¼Œä½†ç³»ç»Ÿç›®å½•ä¸­ä»ç„¶ä¿ç•™ã€‚\n> \n\n### è”åˆæŒ‚è½½æ–‡ä»¶\n\næ‰€è°“è”åˆæŒ‚è½½æ–‡ä»¶ï¼ˆUnion Mountï¼‰ï¼Œå°±æ˜¯å°†åŸæœ‰çš„æ–‡ä»¶ç³»ç»Ÿä¸­çš„ä¸åŒç›®å½•è¿›è¡Œ**åˆå¹¶ï¼ˆmergeï¼‰**ï¼Œæœ€åå‘æˆ‘ä»¬å‘ˆç°å‡ºä¸€ä¸ªåˆå¹¶åæ–‡ä»¶ç³»ç»Ÿã€‚åœ¨ overlay2 æ–‡ä»¶ç»“æ„ä¸­ï¼Œè”åˆæŒ‚è½½æŠ€æœ¯é€šè¿‡è”åˆä¸‰ä¸ªä¸åŒçš„ç›®å½•æ¥å®ç°ï¼šlower ç›®å½•ã€upper ç›®å½•å’Œ work ç›®å½•ï¼Œè¿™ä¸‰ä¸ªç›®å½•è”åˆæŒ‚è½½åå¾—åˆ° merged ç›®å½•ï¼š\n\n- lower ç›®å½•ï¼š**åªè¯»å±‚**ï¼Œå¯ä»¥æœ‰å¤šä¸ªï¼Œå¤„äºæœ€åº•å±‚ç›®å½•\n- upper ç›®å½•ï¼š**è¯»å†™å±‚**ï¼Œåªæœ‰ä¸€ä¸ª\n- work ç›®å½•ï¼šå·¥ä½œåŸºç¡€ç›®å½•ï¼ŒæŒ‚è½½åå†…å®¹è¢«æ¸…ç©ºï¼Œä¸”åœ¨ä½¿ç”¨è¿‡ç¨‹ä¸­å…¶å†…å®¹ä¸å¯è§\n- merged ç›®å½•ï¼šè”åˆæŒ‚è½½åå¾—åˆ°çš„**è§†å›¾**ï¼Œå…¶ä¸­æœ¬èº«å¹¶æ²¡æœ‰å®ä½“æ–‡ä»¶ï¼Œå®é™…æ–‡ä»¶éƒ½åœ¨ upper ç›®å½•å’Œ lower ç›®å½•ä¸­ã€‚åœ¨ merged ç›®å½•ä¸­å¯¹æ–‡ä»¶è¿›è¡Œç¼–è¾‘ï¼Œå®é™…ä¼šä¿®æ”¹ upper ç›®å½•ä¸­æ–‡ä»¶ï¼›è€Œåœ¨ upper ç›®å½•ä¸ lower ç›®å½•ä¸­ä¿®æ”¹æ–‡ä»¶ï¼Œéƒ½ä¼šå½±å“æˆ‘ä»¬åœ¨ merged ç›®å½•çœ‹åˆ°çš„ç»“æœã€‚\n\n## **overlayFS**\n\nåœ¨ä»‹ç» docker ä¸­ä½¿ç”¨çš„ overlay2 æ–‡ä»¶ç»“æ„å‰ï¼Œæˆ‘ä»¬å…ˆé€šè¿‡å¯¹ overlay æ–‡ä»¶ç³»ç»Ÿè¿›è¡Œç®€å•çš„æ“ä½œæ¼”ç¤ºä»¥ä¾¿æ›´æ·±å…¥ç†è§£ä¸åŒå±‚ä¸åŒç›®å½•ä¹‹é—´çš„å…³ç³»\n\nå…ˆåˆ›å»ºå‡ ä¸ªæ–‡ä»¶å¤¹å’Œæ–‡ä»¶\n\n```bash\npudding@DESKTOP-1QCHCU4:~$ mkdir A B C worker\npudding@DESKTOP-1QCHCU4:~$ sudo echo \"From A\" >> A/b.txt\npudding@DESKTOP-1QCHCU4:~$ sudo echo \"From A\" >> A/c.txt\npudding@DESKTOP-1QCHCU4:~$ sudo echo \"From B\" >> B/a.txt\npudding@DESKTOP-1QCHCU4:~$ sudo echo \"From B\" >> B/d.txt\npudding@DESKTOP-1QCHCU4:~$ sudo echo \"From C\" >> C/b.txt\npudding@DESKTOP-1QCHCU4:~$ sudo echo \"From C\" >> C/e.txt\npudding@DESKTOP-1QCHCU4:~$ tree\n```\n\n![ç›®å½• tree](/img/2024-08-28-äº†è§£å®¹å™¨overlayæ–‡ä»¶ç³»ç»Ÿ/image.png)\n\nä½¿ç”¨ mount å‘½ä»¤æŒ‚è½½æˆ overlayFS æ–‡ä»¶ç³»ç»Ÿï¼Œæ ¼å¼å¦‚ä¸‹\n\n```bash\nmount -t overlay overlay -o lowerdir=lower1:lower2:lower3,upperdir=upper,workdir=work merged_dir\n```\n\nåœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬ç”¨ A å’Œ B ä¸¤ä¸ªæ–‡ä»¶å¤¹ä½œä¸º lower ç›®å½•ï¼Œç”¨ C ä½œä¸º upper ç›®å½•ï¼Œworker ä½œä¸º work ç›®å½•ï¼ŒæŒ‚è½½åˆ° /home/pudding/merged ç›®å½•ä¸‹\n\n```bash\nmkdir merged\nsudo mount -t overlay overlay -o lowerdir=A:B,upperdir=C,workdir=worker /home/pudding/merged\n```\n\næŒ‚è½½åæˆ‘ä»¬å¯ä»¥æŸ¥çœ‹ä¸€ä¸‹ merged ç›®å½•ä¸‹çš„æ–‡ä»¶\n\n![merged tree](/img/2024-08-28-äº†è§£å®¹å™¨overlayæ–‡ä»¶ç³»ç»Ÿ/image1.png)\n\nå¯ä»¥çœ‹åˆ°æˆ‘ä»¬åŸæœ¬çš„ A B C ä¸‰ä¸ªç›®å½•ä¸‹çš„æ–‡ä»¶å·²ç»åˆå¹¶ï¼Œç›¸åŒçš„æ–‡ä»¶åçš„æ–‡ä»¶å°†ä¼šé€‰æ‹©æ€§çš„æ˜¾ç¤ºï¼Œåœ¨ merged ä¸­æ˜¾ç¤ºé‡Œ merged å±‚æ›´è¿‘çš„æ–‡ä»¶ï¼Œupper å±‚æ¯” lower å±‚æ›´è¿‘ï¼ŒåŒæ · lower å±‚ä¸­ï¼Œæ’åºé å‰çš„æ¯”æ’åºé åçš„æ›´è¿‘ï¼ˆå–å†³äºmount è„šæœ¬ä¸­ lowerdir=A:B ï¼‰ï¼Œåœ¨è¿™ä¸ªä¾‹å­ä¸­å°±æ˜¯ A æ¯” B æ›´é è¿‘ merged å±‚\n\næ ¹æ®è¿™ä¸ªè§„å¾‹ï¼Œæˆ‘ä»¬å¯ä»¥å…ˆåˆ†æä¸‹ merge å±‚ä¸­çš„æ–‡ä»¶æ¥æºï¼Œa.txt åœ¨ Aã€B ä¸­éƒ½æœ‰ï¼Œä½†æ˜¯ A æ¯” B æ›´é è¿‘ merged å±‚ï¼Œæ‰€ä»¥ merged å±‚çš„ a.txt åº”è¯¥æ¥è‡ª A ç›®å½•ï¼Œb.txt åœ¨ A å’Œ C ä¸­éƒ½æœ‰ï¼Œä½†æ˜¯ C æ˜¯ upper å±‚ï¼Œæ‰€ä»¥ b.txt åº”è¯¥æ¥è‡ª C ç›®å½•ï¼Œæˆ‘ä»¬å¯ä»¥æ ¸å®ä¸€ä¸‹\n\n![cat files](/img/2024-08-28-äº†è§£å®¹å™¨overlayæ–‡ä»¶ç³»ç»Ÿ/image2.png)\n\næ¥ä¸‹æ¥æˆ‘ä»¬å¯ä»¥çœ‹ä¸‹ upper å±‚ã€lower æ›¾å’Œ merged å±‚ä¹‹é—´çš„å…³ç³»ï¼Œä¸Šæ–‡å·²ç»æåˆ°äº† upper å±‚æ˜¯**è¯»å†™å±‚**è€Œ lower å±‚æ˜¯**åªè¯»å±‚**ï¼Œmerged å±‚æ˜¯è”åˆæŒ‚è½½åçš„è§†å›¾ï¼Œé‚£å¦‚æœæˆ‘ä»¬åœ¨ merged å±‚ä¸­å¯¹æ–‡ä»¶è¿›è¡Œæ“ä½œä¼šç”Ÿä»€ä¹ˆ\n\n![change merged file](/img/2024-08-28-äº†è§£å®¹å™¨overlayæ–‡ä»¶ç³»ç»Ÿ/image3.png)\n\næˆ‘ä»¬ä¿®æ”¹ merge å±‚çš„ a.txt æ–‡ä»¶ï¼Œå¯ä»¥çœ‹åˆ° merged å±‚çš„ a.txt å†…å®¹è™½ç„¶æ”¹å˜ï¼Œä½†æ˜¯ A ç›®å½•ï¼ˆåªè¯»å±‚ï¼‰ä¸‹çš„ a.txt å†…å®¹å¹¶æ²¡æœ‰å‘ç”Ÿå˜åŒ–ï¼Œè€Œåœ¨ C ç›®å½•ï¼ˆè¯»å†™å±‚ï¼‰ä¸‹å¤šäº†ä¸€ä¸ª a.txt æ–‡ä»¶ï¼Œå†…å®¹å°±æ˜¯æˆ‘ä»¬ä¿®æ”¹è¿‡çš„ a.txt çš„å†…å®¹ï¼Œè¿™å°±æ˜¯åªè¯»å±‚å’Œè¯»å†™å±‚çš„å…³ç³»ï¼Œ**åœ¨ merged ç›®å½•å¯¹æ–‡ä»¶è¿›è¡Œä¿®æ”¹å¹¶ä¸ä¼šå½±å“åˆ°åªè¯»å±‚çš„æºæ–‡ä»¶ï¼Œåªä¼šå¯¹è¯»å†™å±‚è¿›è¡Œç¼–è¾‘**ã€‚\n\nå¦‚æœæˆ‘ä»¬åœ¨ merged å±‚åˆ é™¤æ–‡ä»¶ä¼šå‘ç”Ÿä»€ä¹ˆ\n\n![delete file](/img/2024-08-28-äº†è§£å®¹å™¨overlayæ–‡ä»¶ç³»ç»Ÿ/image4.png)\n\nå¯ä»¥çœ‹åˆ°åœ¨ merged ç›®å½•ä¸­å·²ç»æ²¡æœ‰ c.txt æ–‡ä»¶äº†ï¼Œä½†æ˜¯ c ç›®å½•ä¸‹å´å¤šäº†ä¸€ä¸ª c.txtï¼Œè¿™ä¸ªæ–‡ä»¶å°±æ˜¯æˆ‘ä»¬åœ¨ä¸€å¼€å§‹æåˆ°çš„ **whiteout æ–‡ä»¶**ï¼Œå®ƒæ˜¯ä¸»/æ¬¡è®¾å¤‡å·éƒ½ä¸º 0 çš„å­—ç¬¦è®¾å¤‡ï¼Œoverlay æ–‡ä»¶ç»“æ„é€šè¿‡ä½¿ç”¨è¿™ç§ç‰¹æ®Šæ–‡ä»¶æ¥å®ç°æ–‡ä»¶åˆ é™¤åŠŸèƒ½ï¼Œåœ¨ merged ç›®å½•ä¸‹ä½¿ç”¨ ls å‘½ä»¤æŸ¥çœ‹æ–‡ä»¶æ—¶ï¼Œoverlay ä¼šè‡ªåŠ¨è¿‡æ»¤æ‰ upper ç›®å½•ä¸‹çš„ whiteout æ–‡ä»¶ä»¥åŠåœ¨ lower ç›®å½•ä¸‹çš„åŒåæ–‡ä»¶ï¼Œä»¥æ­¤å®ç°æ–‡ä»¶åˆ é™¤æ•ˆæœ\n\nè¿˜æœ‰ä¸€ä¸ªå€¼å¾—æåˆ°çš„ç‚¹ï¼šoverlay åœ¨æ–‡ä»¶è¿›è¡Œæ“ä½œæ—¶ç”¨åˆ°äº†**å†™æ—¶å¤åˆ¶ï¼ˆCopy on Writeï¼‰æŠ€æœ¯**ï¼Œåœ¨æ²¡æœ‰å¯¹æ–‡ä»¶è¿›è¡Œä¿®æ”¹æ—¶ï¼Œmerged ç›®å½•ç›´æ¥ä½¿ç”¨ lower ç›®å½•ä¸‹çš„æ–‡ä»¶ï¼Œåªæœ‰å½“æˆ‘ä»¬åœ¨ merged ç›®å½•å¯¹æ–‡ä»¶è¿›è¡Œä¿®æ”¹æ—¶ï¼Œæ‰ä¼šæŠŠä¿®æ”¹çš„æ–‡ä»¶å¤åˆ¶åˆ° upper ç›®å½•\n\n## **Docker overlay2**\n\næœ‰äº†å¯¹ overlayFS çš„åŸºæœ¬äº†è§£ï¼Œæˆ‘ä»¬æ¥ä¸‹æ¥å°±å¯ä»¥ç€æ‰‹åˆ†æ Docker çš„ overlay2 æ–‡ä»¶ç»“æ„äº†ï¼Œå®é™…ä¸Š Docker æ”¯æŒçš„å­˜å‚¨é©±åŠ¨æœ‰å¾ˆå¤šç§ï¼šoverlayã€overlay2ã€aufsã€vfs ç­‰ï¼Œåœ¨ Ubuntu è¾ƒæ–°ç‰ˆæœ¬ä¸­çš„ Docker ä¸­æ™®éé‡‡ç”¨äº† overlay2 è¿™ç§æ–‡ä»¶ç»“æ„ï¼Œå…¶å…·æœ‰æ›´ä¼˜è¶Šçš„é©±åŠ¨æ€§èƒ½ï¼Œè€Œ overlay å’Œ overlay2 çš„æœ¬è´¨åŒºåˆ«å°±æ˜¯äºŒè€…åœ¨é•œåƒå±‚ä¹‹é—´çš„å…±äº«æ•°æ®æ–¹æ³•ä¸åŒï¼š\n\n- overlay é€šè¿‡ ç¡¬é“¾æ¥ çš„æ–¹å¼å…±äº«æ•°æ®ï¼Œåªæ”¯æŒï¼Œå¢åŠ ç£ç›˜ inode è´Ÿæ‹…\n- overlay2 é€šè¿‡ å°†å¤šå±‚çš„ lower æ–‡ä»¶è”åˆåœ¨ä¸€èµ·\n\nç®€è€Œè¨€ä¹‹ï¼Œoverlay2 å°±æ˜¯ overlay çš„æ”¹è¿›ç‰ˆæœ¬ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ docker info å‘½ä»¤æŸ¥çœ‹\n\n```bash\npudding@DESKTOP-1QCHCU4:~$ sudo docker info | grep -i \"storage driver\"\n Storage Driver: overlay2\n```\n\nåœ¨ Docker ä¸­ï¼Œæˆ‘ä»¬æ—¥å¸¸æ“ä½œä¸»è¦æ¶‰åŠä¸¤ä¸ªæ–¹é¢ï¼šé•œåƒå±‚ä¸å®¹å™¨å±‚ï¼Œé•œåƒå±‚å°±æ˜¯æˆ‘ä»¬é€šè¿‡ **docker pull** ç­‰å‘½ä»¤ä¸‹è½½åˆ°æœ¬æœºä¸­çš„é•œåƒï¼Œè€Œå®¹å™¨å±‚åˆ™æ˜¯æˆ‘ä»¬é€šè¿‡ **docker exec** ç­‰å‘½ä»¤è¿›å…¥çš„äº¤äº’å¼ç»ˆç«¯ï¼Œå¦‚æœä½ ä½¿ç”¨è¿‡ Dockerï¼Œä½ ä¼šå‘ç°æˆ‘ä»¬åªç”¨ä¸€ä¸ªé•œåƒï¼Œé€šè¿‡ **docker run** å¯ä»¥äº§ç”Ÿå¾ˆå¤šä¸ªå®¹å™¨ï¼Œè¿™å°±å¯ä»¥ç±»æ¯” upper ä¸ lower ä¸¤å±‚ï¼Œé•œåƒä½œä¸º lower å±‚ï¼Œåªè¯»æä¾›æ–‡ä»¶ç³»ç»ŸåŸºç¡€ï¼Œè€Œå®¹å™¨ä½œä¸º upper å±‚ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨å…¶ä¸­è¿›è¡Œä»»æ„æ–‡ä»¶æ“ä½œï¼Œåªç”¨åŒä¸€ä¸ªé•œåƒå°±å¯ä»¥ç”³å¼•å‡ºä¸åŒçš„å®¹å™¨ï¼Œè¿™ä¹Ÿæ˜¯ä¸€ç§èŠ‚çº¦ç©ºé—´èµ„æºçš„æ–¹å¼å§ï¼ˆæˆ‘çš„æ¨æµ‹\n\næ¥ä¸‹æ¥æˆ‘ä»¬ç¨å¾®è¯¦ç»†åœ°æ¢è®¨ä¸‹é•œåƒå±‚ä¸å®¹å™¨å±‚ï¼Œè¿˜æœ‰ä»–ä»¬çš„å…ƒæ•°æ®\n\n### é•œåƒå±‚\n\næˆ‘ä»¬å¯ä»¥é€šè¿‡ `docker inspect [IMAGE ID]` æ¥æŸ¥çœ‹é•œåƒé…ç½®\n\n![image GraphDriver](/img/2024-08-28-äº†è§£å®¹å™¨overlayæ–‡ä»¶ç³»ç»Ÿ/image5.png)\n\nå…¶ä¸­çš„ GraphDriver å­—æ®µä¸­å…³äº overlay2 æ–‡ä»¶ç»“æ„çš„ç›®å½•ä¿¡æ¯\n\næ¯ä¸€å±‚çš„å¯¹åº”éƒ½åœ¨é…ç½®ä¿¡æ¯ä¸­ä½“ç°çš„éå¸¸æ¸…æ¥šï¼Œä½†æ˜¯æœ‰ä¸€ç‚¹é—®é¢˜ï¼Œæˆ‘ä»¬åœ¨å®é™…æŸ¥çœ‹æ–‡ä»¶å¤¹çš„æ—¶å€™ï¼Œå¯ä»¥å‘ç°é•œåƒå±‚å…¶å®å¹¶æ²¡æœ‰ /merged ç›®å½•ï¼Œ**æˆ‘çš„ç†è§£** /merged ç›®å½•åªåœ¨è¿è¡Œå®¹å™¨æ—¶å­˜åœ¨ï¼›è¿™ä¸ªç›®å½•æ˜¯ Docker ä¸ºå®¹å™¨æä¾›çš„ä¸€ä¸ªè§†å›¾ï¼Œå®ƒå°† lowerdir å’Œ upperdir å±‚åˆå¹¶ä¸ºä¸€ä¸ªç»Ÿä¸€çš„æ–‡ä»¶ç³»ç»Ÿä¾›å®¹å™¨è®¿é—®ï¼›è™½ç„¶ merged ç›®å½•ä¸å­˜åœ¨äºé•œåƒå±‚ï¼Œä½† Docker åœ¨ GraphDriver å­—æ®µä¸­æä¾›äº†è¿™äº›ä¿¡æ¯ï¼Œä»¥ç¡®ä¿æˆ‘ä»¬èƒ½å¤Ÿç†è§£æ•´ä¸ª overlay2 æ–‡ä»¶ç³»ç»Ÿçš„ç»“æ„ã€‚ï¼ˆä¸ä¸€å®šå¯¹\n\nå¯ä»¥çœ‹åˆ°é•œåƒçš„ç›®å½•æ˜¯åœ¨Â `/var/lib/docker/overlay2`Â ä¸‹ï¼Œæˆ‘ä»¬æ‰“å¼€ä¸€ä¸ªé•œåƒå±‚çœ‹ä¸€çœ‹å…¶ä¸­éƒ½æœ‰å“ªäº›æ–‡ä»¶\n\n![image overlay2](/img/2024-08-28-äº†è§£å®¹å™¨overlayæ–‡ä»¶ç³»ç»Ÿ/image6.png)\n\nå…¶ä¸­æˆ‘ä»¬å…³æ³¨ä¸€ä¸‹ diff ç›®å½•ã€link å’Œ lower æ–‡ä»¶\n\n#### diff ç›®å½•\n\n**åœ¨è¿™ä¸ªç›®å½•ä¸­å­˜æ”¾çš„æ˜¯å½“å‰é•œåƒå±‚çš„æ–‡ä»¶ï¼Œ**åˆšåˆšåœ¨ä»‹ç» overlay2 ä¸ overlay åŒºåˆ«çš„æ—¶å€™æåˆ°äº† overlay2 æ˜¯å°†å¤šä¸ª lower å±‚è”åˆåˆ°ä¸€èµ·ï¼Œåœ¨ä¸Šé¢çš„å›¾ä¸­ä¹Ÿå¯ä»¥çœ‹åˆ°ï¼Œå¤šä¸ª lower å±‚ä¹‹é—´ç”¨`:`åˆ†å‰²ï¼Œåœ¨è¿™äº›å±‚ä¸­æ¯ä¸€å±‚éƒ½æœ‰ä¸€éƒ¨åˆ†æ–‡ä»¶ï¼ŒæŠŠä»–ä»¬è”åˆåˆ°ä¸€èµ·å°±å¾—åˆ°äº†å®Œæ•´çš„ rootfs\n\n![image diff](/img/2024-08-28-äº†è§£å®¹å™¨overlayæ–‡ä»¶ç³»ç»Ÿ/image7.png)\n\n#### link æ–‡ä»¶\n\nlink æ–‡ä»¶ä¸­çš„å†…å®¹æ˜¯**å½“å‰å±‚çš„è½¯é“¾æ¥åç§°**\n\n![image link](/img/2024-08-28-äº†è§£å®¹å™¨overlayæ–‡ä»¶ç³»ç»Ÿ/image8.png)\n\nè¿™äº›é“¾æ¥éƒ½åœ¨ `/var/lib/docker/overlay2/l`Â ç›®å½•ä¸‹\n\n![image link](/img/2024-08-28-äº†è§£å®¹å™¨overlayæ–‡ä»¶ç³»ç»Ÿ/image9.png)\n\nä½¿ç”¨è½¯é“¾æ¥çš„ç›®çš„æ˜¯**ä¸ºäº†é¿å…å—åˆ° mount å‘½ä»¤å‚æ•°çš„é•¿åº¦é™åˆ¶**\n\n> `getconf ARG_MAX`\nè¯¥å€¼å†³å®šäº†ä¸€ä¸ªè¿›ç¨‹çš„å‘½ä»¤è¡Œå‚æ•°å’Œç¯å¢ƒå˜é‡çš„æ€»é•¿åº¦\né€šå¸¸åœ¨ Linux ç³»ç»Ÿä¸Šä¸º 2MBï¼ˆ2097152 å­—èŠ‚ï¼‰\n> \n\n#### lower æ–‡ä»¶\n\nlower æ–‡ä»¶ä¸­çš„å†…å®¹æ˜¯**åœ¨æ­¤å±‚ä¹‹ä¸‹çš„æ‰€æœ‰å±‚çš„è½¯è¿æ¥åç§°**ï¼Œæœ€åº•å±‚ä¸å­˜åœ¨è¯¥æ–‡ä»¶ï¼Œæˆ‘ä»¬çŸ¥é“ upper å±‚åœ¨ lower å±‚ä¹‹ä¸Šï¼Œè€Œ lower å±‚ä¸­è¶Šé åçš„åˆ™è¶Šåœ¨åº•å±‚\n\næˆ‘ä»¬æŸ¥çœ‹ upper å±‚å¯¹åº”ç›®å½•ä¸‹ lower æ–‡ä»¶ï¼Œå¯ä»¥çœ‹åˆ°å…¶ä¸­æœ‰ 4 ä¸ªè½¯é“¾æ¥\n\n![image lower](/img/2024-08-28-äº†è§£å®¹å™¨overlayæ–‡ä»¶ç³»ç»Ÿ/image10.png)\n\næ°å¥½ lower ç›®å½•ä¸­æœ‰ 4 ä¸ªé•œåƒå±‚\n\n![image GraphDriver lower](/img/2024-08-28-äº†è§£å®¹å™¨overlayæ–‡ä»¶ç³»ç»Ÿ/image11.png)\n\nåœ¨ lower å±‚ä¸­ï¼Œå¤„äºæœ€åº•å±‚çš„åˆ™æ˜¯åº”è¯¥åœ¨ `:` æœ€åçš„ç›®å½•ï¼Œå³ï¼Œ\n\n```bash\n/var/lib/docker/overlay2/784dc7dce7d8625dc10a4fa065f2a1f27ff65e19def543c9f491f32575ec09dd\n```\n\næŸ¥çœ‹è¿™ä¸€ç›®å½•ä¸‹çš„æ–‡ä»¶ï¼Œå¯ä»¥å‘ç°å®ƒå¹¶æ²¡æœ‰ lower æ–‡ä»¶\n\n![image lowest](/img/2024-08-28-äº†è§£å®¹å™¨overlayæ–‡ä»¶ç³»ç»Ÿ/image12.png)\n\nè¿™ä¸€å±‚å¯¹åº”çš„è½¯é“¾æ¥å³ link æ–‡ä»¶å†…å®¹ä¸ºÂ `54MNMNIOUGOPX7SLOTKFTZHE5R`ï¼Œæˆ‘ä»¬æŸ¥çœ‹å…¶ä¸Šä¸€å±‚çš„ lower æ–‡ä»¶å†…å®¹\n\n![image one floor up](/img/2024-08-28-äº†è§£å®¹å™¨overlayæ–‡ä»¶ç³»ç»Ÿ/image13.png)\n\nå¯ä»¥å‘ç°ç¡®å®å¯¹åº”äº†æœ€åº•å±‚ç›®å½•çš„è½¯é“¾æ¥\n\n### å…ƒæ•°æ®\n\nDocker çš„å…ƒæ•°æ®å­˜å‚¨ç›®å½•ä¸º `/var/lib/docker/image/overlay2` \n\n![image overlay2](/img/2024-08-28-äº†è§£å®¹å™¨overlayæ–‡ä»¶ç³»ç»Ÿ/image14.png)\n\næˆ‘ä»¬ä¸»è¦çœ‹ imagedb å’Œ layerdb è¿™ä¸¤ä¸ªæ–‡ä»¶å¤¹\n\n#### imagedb\n\nè¿™ä¸ªæ–‡ä»¶å¤¹ä¸­å­˜å‚¨äº†é•œåƒç›¸å…³çš„å…ƒæ•°æ®ï¼Œå…·ä½“ä½ç½®æ˜¯åœ¨ `/imagedb/content/sha256`  ç›®å½•ä¸‹ï¼Œè¿™ä¸ªç›®å½•ä¸‹çš„æ–‡ä»¶ä»¥ **IMAGE ID** æ¥å‘½ä»¤\n\n![image imagedb](/img/2024-08-28-äº†è§£å®¹å™¨overlayæ–‡ä»¶ç³»ç»Ÿ/image15.png)\n\nè¿™ä¸ªæ–‡ä»¶çš„å†…å®¹å°±æ˜¯æˆ‘ä»¬é€šè¿‡Â `docker inspect [IMAGE ID]`Â å‘½ä»¤æŸ¥çœ‹åˆ°çš„ä¿¡æ¯ï¼Œå…¶ä¸­æˆ‘ä»¬å…³æ³¨Â `RootFS`Â å­—æ®µ\n\n![image RootFS](/img/2024-08-28-äº†è§£å®¹å™¨overlayæ–‡ä»¶ç³»ç»Ÿ/Untitled2.png)\n\nå¯ä»¥çœ‹å‡ºè¿™ä¸ªå­—æ®µä¸­æœ‰å¾ˆå¤š sha256 å€¼ï¼Œè¿™äº›å“ˆå¸Œå€¼ç§°ä¸º **diff_id**ï¼Œå…¶ä»ä¸Šè‡³ä¸‹çš„é¡ºåºå°±è¡¨ç¤ºé•œåƒå±‚æœ€åº•å±‚åˆ°æœ€é¡¶å±‚ï¼Œä¹Ÿå°±æ˜¯è¯´æ¯ä¸ª diff_id å¯¹åº”äº†ä¸€ä¸ªé•œåƒå±‚ï¼Œå®é™…ä¸Šï¼Œå¯¹åº”æ¯ä¸€ä¸ªé•œåƒå±‚çš„è¿˜æœ‰å¦å¤–ä¸¤ä¸ª idï¼š**cache_id**Â å’ŒÂ **chain_id**\n\n- **cache_id**Â å°±æ˜¯åœ¨Â `docker/overlay2`Â ç›®å½•ä¸‹çœ‹åˆ°çš„æ–‡ä»¶å¤¹åç§°ï¼Œä¹Ÿæ˜¯æˆ‘ä»¬é€šè¿‡Â `docker inspect [IMAGE ID]`Â å‘½ä»¤æŸ¥çœ‹ GraphDriver å­—æ®µå¯¹åº”ä¸åŒçš„ Dirï¼Œå…¶æœ¬è´¨æ˜¯å®¿ä¸»æœºéšæœºç”Ÿæˆçš„ uuid\n    \n    ![image cache_id](/img/2024-08-28-äº†è§£å®¹å™¨overlayæ–‡ä»¶ç³»ç»Ÿ/image16.png)\n    \n- chain_id æ˜¯é€šè¿‡ diff_id è®¡ç®—å‡ºæ¥çš„ï¼Œæ˜¯ Docker å†…å®¹å¯»å€æœºåˆ¶é‡‡ç”¨çš„ç´¢å¼• ID\n    - chain_id åœ¨ç›®å½• `/var/lib/docker/image/overlay2/layerdb/sha256`Â æŸ¥çœ‹\n    - å¦‚æœå½“å‰é•œåƒå±‚ä¸ºæœ€åº•å±‚ï¼Œåˆ™å…¶ chain_id ä¸ diff_id ç›¸åŒ\n    - å¦‚æœå½“å‰é•œåƒå±‚ä¸æ˜¯æœ€åº•å±‚ï¼Œåˆ™å…¶ chain_id è®¡ç®—æ–¹å¼ä¸ºï¼š`sha256(ä¸Šå±‚chain_id + \" \" + æœ¬å±‚diff_id)`\n\nè¿™ä¸‰ä¸ª id ä¹‹é—´å­˜åœ¨ä¸€ä¸€å¯¹åº”çš„å…³ç³»ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ diff_id è®¡ç®—å¾—åˆ° chain_idï¼Œåˆå¯ä»¥é€šè¿‡ chain_id æ‰¾åˆ°å¯¹åº”çš„ cache_idï¼Œä¸‹é¢æˆ‘ä»¬ä¸¾ä¸ªæ —å­è¯´æ˜ä¸€ä¸‹ï¼š\n\næˆ‘ä»¬åˆšåˆšæåˆ°äº† diff_id ä»ä¸Šè‡³ä¸‹æ˜¯æœ€åº•å±‚åˆ°æœ€é¡¶å±‚\n\n![image RootFS](/img/2024-08-28-äº†è§£å®¹å™¨overlayæ–‡ä»¶ç³»ç»Ÿ/image17.png)\n\næŸ¥çœ‹ chain_id\n\n![image chain_id](/img/2024-08-28-äº†è§£å®¹å™¨overlayæ–‡ä»¶ç³»ç»Ÿ/image18.png)\n\nå¯ä»¥çœ‹åˆ°å…¶ä¸­ç¡®å®æœ‰ä¸€ä¸ª chain_id ä¸ æœ€åº•å±‚çš„ diff_id ç›¸åŒï¼Œæœ‰äº†æœ€åº•å±‚çš„ chain_id æˆ‘ä»¬å°±å¯ä»¥è®¡ç®—å‡ºä¸‹ä¸€å±‚çš„ chain_idï¼Œè‡³äºå…·ä½“å¦‚ä½•è®¡ç®—ï¼Œä»¥åŠå¦‚ä½•é€šè¿‡ chain_id æ‰¾åˆ°å¯¹åº”çš„ cache_idï¼Œæˆ‘ä»¬éœ€è¦å…ˆäº†è§£ layerdb ç›®å½•ä¸‹çš„å†…å®¹\n\n#### layerdb\n\næˆ‘ä»¬ç°åœ¨å·²çŸ¥ Docker çš„é•œåƒå±‚ä½œä¸ºåªè¯»å±‚ï¼Œå®¹å™¨æ›¾ä½œä¸ºè¯»å†™å±‚ï¼Œè€Œ Docekr å®é™…ä¸Šå®šä¹‰äº† roLayer æ¥å£ä¸ mountLayer æ¥å£ï¼Œåˆ†åˆ«ç”¨æ¥æè¿°ï¼ˆåªè¯»ï¼‰é•œåƒå±‚ä¸ï¼ˆè¯»å†™ï¼‰å®¹å™¨å±‚ï¼Œè¿™ä¸¤ä¸ªæ¥å£çš„å…ƒæ•°æ®å°±åœ¨ç›®å½• `/var/lib/docker/image/overlay2/layerdb` ä¸‹\n\n- **roLayer**\n    \n    rolayer æ¥å£ç”¨æ¥æè¿°é•œåƒå±‚ï¼Œå…ƒæ•°æ®çš„å…·ä½“ç›®å½•åœ¨Â `layerdb/sha256/`Â ä¸‹ï¼Œåœ¨æ­¤ç›®å½•ä¸‹æ¯ä¸ªæ–‡ä»¶å¤¹éƒ½ä»¥æ¯ä¸ªé•œåƒå±‚çš„ chain_id å‘½å\n    \n    ![image roLayer](/img/2024-08-28-äº†è§£å®¹å™¨overlayæ–‡ä»¶ç³»ç»Ÿ/image19.png)\n    \n    åœ¨æ–‡ä»¶å¤¹ä¸­ä¸»è¦æœ‰è¿™ 5 ä¸ªæ–‡ä»¶ï¼Œæˆ‘ä»¬ç®€å•ä»‹ç»ä¸€ä¸‹ï¼š\n    \n    - cache-idï¼šå½“å‰ chain_id å¯¹åº”çš„ cache_idï¼Œç”¨æ¥ç´¢å¼•é•œåƒå±‚\n    - diffï¼šå½“å‰ chain_id å¯¹åº”çš„ diff_id\n    - parentï¼šå½“å‰ chain_id å¯¹åº”çš„é•œåƒå±‚çš„ä¸‹ä¸€å±‚ï¼ˆçˆ¶å±‚ï¼‰é•œåƒ chain_idï¼Œæœ€åº•å±‚ä¸å­˜åœ¨è¯¥æ–‡ä»¶\n    - sizeï¼šå½“å‰ chain_id å¯¹åº”çš„é•œåƒå±‚ç‰©ç†å¤§å°ï¼Œå•ä½æ˜¯å­—èŠ‚\n    - tar-split.json.gzï¼šå½“å‰ chain_id å¯¹åº”é•œåƒå±‚å‹ç¼©åŒ…çš„ split æ–‡ä»¶ï¼Œå¯ä»¥ç”¨æ¥è¿˜åŸé•œåƒå±‚çš„ tar åŒ…ï¼Œé€šè¿‡Â `docker save`Â å‘½ä»¤å¯¼å‡ºé•œåƒæ—¶ä¼šç”¨åˆ°\n    \n    æˆ‘ä»¬åœ¨ä¸Šä¸€èŠ‚ä¸­å·²ç»åˆ¤æ–­å‡ºäº†æœ€åº•å±‚å¯¹åº”çš„ chain_idï¼Œä¸å¦¨æŸ¥çœ‹ä¸€ä¸‹å¯¹åº”ç›®å½•ä¸‹çš„æ–‡ä»¶\n    \n    ![image lowest chain_id](/img/2024-08-28-äº†è§£å®¹å™¨overlayæ–‡ä»¶ç³»ç»Ÿ/image20.png)\n    \n    å¯ä»¥çœ‹åˆ°è¯¥ç›®å½•ä¸‹ç¡®å®æ²¡æœ‰ parent æ–‡ä»¶ï¼Œé‚£ä¹ˆæˆ‘ä»¬å†æŸ¥çœ‹å…¶ä¸‹ä¸€å±‚ï¼Œé€šè¿‡ diff_id çš„é¡ºåºæˆ‘ä»¬å¯ä»¥å¾—çŸ¥å…¶ä¸‹ä¸€å±‚çš„ diff_id ä¸º `0d5cae34765c1f89a17e5e8e7e6f6f9ddc541151e3efab2487b013faeecac3a6` ï¼ˆä¸Šæ–‡æåˆ°çš„ inspect çš„ RootFS é‡Œ Layers çš„ sha256 ä¿¡æ¯ï¼‰ï¼Œé€šè¿‡è®¡ç®— sha256ï¼Œæˆ‘ä»¬å¯ä»¥å¾—å‡ºä¸‹ä¸€å±‚çš„ chain_id\n    \n    ![image one floor up chain_id](/img/2024-08-28-äº†è§£å®¹å™¨overlayæ–‡ä»¶ç³»ç»Ÿ/image21.png)\n    \n    è®¡ç®—å¾—åˆ°æœ€åº•å±‚çš„ä¸‹ä¸€å±‚é•œåƒ chain_id ä¸º `696245322de78f67f7f15ab9ade64bf0c35cf1f280a66d763230d9e99a3a6d39`\n    \n    ![image diff](/img/2024-08-28-äº†è§£å®¹å™¨overlayæ–‡ä»¶ç³»ç»Ÿ/image22.png)\n    \n    ç¡®å®å­˜åœ¨è¯¥ç›®å½•ï¼Œå¯ä»¥çœ‹åˆ°ï¼š\n    \n    - diff æ–‡ä»¶å†…å®¹æ˜¯ `004114a8d0e34895acdd9c1c370b1184b239d538e3951887d04d1bda771bd441`\n    - parent æ–‡ä»¶å†…å®¹æ˜¯ `4f118a86fef9debde65113068bd2b85f9c5fd65250ac6af2e8281a502cc0a724`\n    \n    å¯ä»¥çœ‹åˆ°ä¸æˆ‘ä»¬è®¡ç®—ç”¨åˆ°çš„ä¸¤ä¸ªå€¼ä¹Ÿå®Œå…¨ç›¸åŒ\n    \n- **mountLayer**\n    \n    mountLayer æ¥å£ç”¨æ¥æè¿°å®¹å™¨å±‚ï¼Œå…ƒæ•°æ®çš„å…·ä½“ç›®å½•åœ¨ `layerdb/mounts/` ï¼Œåœ¨æ­¤ç›®å½•ä¸‹çš„æ–‡ä»¶å¤¹ä»¥æ¯ä¸ªå®¹å™¨çš„å®¹å™¨ IDï¼ˆCONTAINER IDï¼‰å‘½å\n    \n    ![image contain](/img/2024-08-28-äº†è§£å®¹å™¨overlayæ–‡ä»¶ç³»ç»Ÿ/image23.png)\n    \n    åœ¨è¿™ä¸ªæ–‡ä»¶å¤¹ä¸‹åªæœ‰ 3 ä¸ªæ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸‹ï¼š\n    \n    ![image mountLayer](/img/2024-08-28-äº†è§£å®¹å™¨overlayæ–‡ä»¶ç³»ç»Ÿ/image24.png)\n    \n    ç®€å•ä»‹ç»ä¸€ä¸‹è¿™3ä¸ªæ–‡ä»¶ï¼š\n    \n    - init-idï¼šå¯¹åº”å®¹å™¨ init å±‚ç›®å½•åï¼Œæºæ–‡ä»¶åœ¨ `/var/lib/docker/overlay2`Â ç›®å½•ä¸‹\n    - mount-idï¼šå®¹å™¨å±‚å­˜å‚¨åœ¨ `/var/lib/docker/overlay2`Â ç›®å½•ä¸‹çš„åç§°\n    - parentï¼šå®¹å™¨çš„é•œåƒå±‚**æœ€é¡¶å±‚**é•œåƒçš„ chain_id\n    \n    æˆ‘ä»¬å¯ä»¥æŸ¥çœ‹ parent æ–‡ä»¶ä¸­ chain_id å¯¹åº”ç›®å½•ä¸‹çš„ diff æ–‡ä»¶\n    \n    ![image diff](/img/2024-08-28-äº†è§£å®¹å™¨overlayæ–‡ä»¶ç³»ç»Ÿ/image25.png)\n    \n    æ ¹æ® diff_id ä»ä¸Šè‡³ä¸‹çš„é¡ºåºï¼Œæˆ‘ä»¬å¯ä»¥ç¡®å®šè¿™ä¸ª diff_id çš„ç¡®æ˜¯é•œåƒå±‚çš„æœ€é¡¶å±‚\n    \n    ![image rootfs](/img/2024-08-28-äº†è§£å®¹å™¨overlayæ–‡ä»¶ç³»ç»Ÿ/image26.png)\n    \n    åœ¨è¿™é‡Œæˆ‘ä»¬å¼•å…¥äº†ä¸€ä¸ªå«åš **init å±‚** çš„æ¦‚å¿µï¼Œå®é™…ä¸Šï¼Œä¸€ä¸ªå®Œå–„çš„å®¹å™¨åˆ†ä¸º 3 å±‚ï¼šé•œåƒå±‚ã€init å±‚å’Œå®¹å™¨å±‚ï¼Œé•œåƒå±‚æä¾›å®Œæ•´çš„æ–‡ä»¶ç³»ç»ŸåŸºç¡€ï¼ˆrootfsï¼‰ï¼Œå®¹å™¨å±‚æä¾›ç»™ç”¨æˆ·è¿›è¡Œäº¤äº’æ“ä½œä¸è¯»å†™æƒé™ï¼Œè€Œ init å±‚åˆ™æ˜¯å¯¹åº”æ¯ä¸ªå®¹å™¨è‡ªå·±çš„ä¸€äº›ç³»ç»Ÿé…ç½®æ–‡ä»¶ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹ä¸€ä¸‹ ini å±‚çš„å†…å®¹\n    \n    ![image init](/img/2024-08-28-äº†è§£å®¹å™¨overlayæ–‡ä»¶ç³»ç»Ÿ/image27.png)\n    \n    å¯ä»¥çœ‹åˆ°åœ¨ diff ç›®å½•ä¸­æœ‰ä¸€äº› /etc/hostsã€/etc/resolv.conf ç­‰é…ç½®æ–‡ä»¶ï¼Œéœ€è¦è¿™ä¸€å±‚çš„åŸå› æ˜¯å½“å®¹å™¨å¯åŠ¨çš„æ—¶å€™ï¼Œä¼šæœ‰ä¸€äº›æ¯ä¸ªå®¹å™¨ç‰¹å®šçš„é…ç½®æ–‡ä»¶ï¼ˆä¾‹å¦‚ hostnameï¼‰ï¼Œä½†ç”±äºé•œåƒå±‚æ˜¯åªè¯»å±‚æ— æ³•è¿›è¡Œä¿®æ”¹ï¼Œæ‰€ä»¥å°±åœ¨é•œåƒå±‚ä¹‹ä¸Šå•ç‹¬æŒ‚è½½ä¸€å±‚ init å±‚ï¼Œç”¨æˆ·é€šè¿‡ä¿®æ”¹æ¯ä¸ªå®¹å™¨å¯¹åº”çš„ init å±‚ä¸­çš„ä¸€äº›é…ç½®æ–‡ä»¶ä»è€Œè¾¾åˆ°ä¿®æ”¹é•œåƒé…ç½®æ–‡ä»¶çš„ç›®çš„ï¼Œè€Œåœ¨ init å±‚ä¸­çš„é…ç½®æ–‡ä»¶ä¹Ÿä»…å¯¹å½“å‰å®¹å™¨ç”Ÿæ•ˆï¼Œé€šè¿‡ docker commit å‘½ä»¤åˆ›å»ºé•œåƒæ—¶ä¹Ÿä¸ä¼šæäº¤ init å±‚ã€‚\n    \n\n### å®¹å™¨å±‚\n\næœ€åæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹å®¹å™¨å±‚çš„æ„é€ ï¼Œåˆšåˆšæˆ‘ä»¬åœ¨ **mountLayer** ä¸€èŠ‚çš„è®²è¿°ä¸­æåˆ°äº† **mount-id** è¿™ä¸ªæ–‡ä»¶ï¼Œè€Œè¿™ä¸ªæ–‡ä»¶çš„å†…å®¹å°±æ˜¯å®¹å™¨ç›®å½•çš„åç§°ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ `docker inspect [CONTAINER ID]`Â å‘½ä»¤ä¹Ÿå¯ä»¥åˆ¤æ–­\n\n![image mount-id](/img/2024-08-28-äº†è§£å®¹å™¨overlayæ–‡ä»¶ç³»ç»Ÿ/image28.png)\n\n![image graphdriver](/img/2024-08-28-äº†è§£å®¹å™¨overlayæ–‡ä»¶ç³»ç»Ÿ/image29.png)\n\nå¯ä»¥çœ‹åˆ°å…¶å®å®¹å™¨å±‚çš„ç›®å½•ä¸é•œåƒå±‚ã€initå±‚éƒ½åœ¨åŒä¸€ç›®å½•ä¸‹ï¼Œå…¶å®ä¹Ÿå°±è¯´æ˜äº†ä»–ä»¬åœ¨æ–‡ä»¶ç»“æ„ä¸Šéƒ½æ˜¯ç›¸åŒçš„\n\n![image overlay2](/img/2024-08-28-äº†è§£å®¹å™¨overlayæ–‡ä»¶ç³»ç»Ÿ/image30.png)\n\nåŒæ ·éƒ½æ˜¯è¿™å‡ ä¸ªæ–‡ä»¶ï¼Œä½†ä¸åŒçš„æ˜¯ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°åœ¨å®¹å™¨å±‚ç¡®å®æœ‰äº† merge è¿™ä¸ªç›®å½•ï¼Œä¸æˆ‘ä»¬åœ¨æ–‡ç« ä¸€å¼€å§‹å®ç°çš„ overlayFS æ˜¯ç›¸åŒçš„\n\n![image merged](/img/2024-08-28-äº†è§£å®¹å™¨overlayæ–‡ä»¶ç³»ç»Ÿ/image31.png)\n\nåœ¨ merge ç›®å½•ä¸‹å±•ç°äº†å®Œæ•´çš„ rootfs æ–‡ä»¶ç³»ç»Ÿï¼Œè¿™å°±æ˜¯ overlay2 é€šè¿‡è”åˆæŒ‚è½½æŠ€æœ¯ï¼Œå°†é•œåƒå±‚ã€init å±‚ä¸å®¹å™¨å±‚æŒ‚è½½åˆ°ä¸€èµ·å‘ˆç°çš„ç»“æœï¼Œè¿™ä¹Ÿæ˜¯æˆ‘ä»¬é€šè¿‡ `docker exec` å‘½ä»¤è¿›å…¥å®¹å™¨çš„äº¤äº’å¼ç»ˆç«¯çœ‹åˆ°çš„ç»“æœï¼Œä¹Ÿå°±æ˜¯æ‰€è°“çš„**è§†å›¾**\n\n![image contain](/img/2024-08-28-äº†è§£å®¹å™¨overlayæ–‡ä»¶ç³»ç»Ÿ/image32.png)\n\n#### **link & lower æ–‡ä»¶**\n\næˆ‘ä»¬åœ¨é•œåƒå±‚çš„æ—¶å€™å·²ç»è®²è¿‡è¿™ä¸¤ä¸ªæ–‡ä»¶äº†ï¼Œåœ¨å®¹å™¨å±‚ä¸­è¿™ä¸¤ä¸ªæ–‡ä»¶ä¸é•œåƒå±‚ä½œç”¨æ˜¯ç›¸åŒçš„ï¼Œä¸è¿‡æˆ‘ä»¬å¯ä»¥çœ‹ä¸€ä¸‹ lower æ–‡ä»¶çš„å†…å®¹\n\n![image lower](/img/2024-08-28-äº†è§£å®¹å™¨overlayæ–‡ä»¶ç³»ç»Ÿ/image33.png)\n\nå‰é¢è®²è¿‡ï¼Œlower æ–‡ä»¶çš„å†…å®¹æ˜¯åœ¨æ­¤å±‚ä¹‹ä¸‹çš„æ‰€æœ‰å±‚çš„è½¯é“¾æ¥åç§°ï¼Œæˆ‘ä»¬å·²çŸ¥æ­¤é•œåƒçš„é•œåƒå±‚å…± 4 å±‚ï¼ˆlower å±‚ 3 ä¸ªï¼Œupper å±‚ 1 ä¸ªï¼‰ï¼Œä½†æ˜¯æˆ‘ä»¬ä»ä¸Šå›¾å¯ä»¥çœ‹åˆ°åœ¨å®¹å™¨å±‚ä¹‹ä¸‹æœ‰ 5 ä¸ªå…¶ä»–å±‚ï¼Œé‚£å¤šå‡ºæ¥çš„ä¸€ä¸ªå°±æ˜¯æˆ‘ä»¬åœ¨ä¸Šä¸€èŠ‚ä¸­æåˆ°çš„ init å±‚ï¼Œinit å±‚ä¹Ÿæœ‰å…¶å¯¹åº”çš„è½¯é“¾æ¥ï¼ˆçœ‹ä¸Šä¸€èŠ‚ä¸­çš„å›¾ï¼‰ï¼Œæ‰€ä»¥åœ¨Â `docker/overlay2/l`Â ç›®å½•ä¸‹å®é™…ä¸Šæœ‰ 6 ä¸ªè½¯è¿æ¥ï¼ˆ4ä¸ªé•œåƒå±‚ï¼Œ1ä¸ª init å±‚ï¼Œ1 ä¸ªå®¹å™¨å±‚ï¼‰\n\n![image link](/img/2024-08-28-äº†è§£å®¹å™¨overlayæ–‡ä»¶ç³»ç»Ÿ/image34.png)\n\nè€Œé€šè¿‡Â `docker inspect [CONTAINER ID]`Â å‘½ä»¤æˆ‘ä»¬ä¹Ÿå¯ä»¥åˆ¤æ–­å‡ºå®¹å™¨å±‚æ˜¯æœ€é¡¶å±‚ï¼Œå…¶æ¬¡æ˜¯ init å±‚ï¼Œæœ€ä¸‹é¢æ˜¯é•œåƒå±‚ï¼Œä¹Ÿå¯¹åº”äº† lower æ–‡ä»¶ä¸­è½¯é“¾æ¥çš„é¡ºåº\n\n![image graphdriver](/img/2024-08-28-äº†è§£å®¹å™¨overlayæ–‡ä»¶ç³»ç»Ÿ/image35.png)\n\n#### **diff ç›®å½•**\n\nè¿™ä¸ªç›®å½•å®é™…ä¸Šå°±æ˜¯ overlayFS æ–‡ä»¶ç»“æ„ä¸­çš„ upper å±‚ï¼ˆä¸Šå›¾ä¸­ä¹Ÿèƒ½çœ‹åˆ°ï¼‰ï¼Œæ‰€ä»¥å®ƒçš„ç”¨é€”å°±æ˜¯ä¿å­˜ç”¨æˆ·åœ¨å®¹å™¨ä¸­ï¼ˆmerged å±‚ï¼‰å¯¹æ–‡ä»¶è¿›è¡Œçš„ç¼–è¾‘\n\n![image diff](/img/2024-08-28-äº†è§£å®¹å™¨overlayæ–‡ä»¶ç³»ç»Ÿ/image36.png)\n\næˆ‘ä»¬åœ¨å®¹å™¨å†…çš„ /root/A ç›®å½•ä¸‹åˆ›å»ºäº†ä¸€ä¸ª a.txt æ–‡ä»¶ï¼Œå¯ä»¥çœ‹åˆ°åœ¨ diff ç›®å½•ä¸‹ä¹Ÿä½“ç°äº†å‡ºæ¥ï¼Œæˆ‘ä»¬å†å°è¯•åœ¨å®¹å™¨ä¸­åˆ é™¤åŸæœ¬é•œåƒè‡ªå¸¦çš„æ–‡ä»¶çœ‹ä¸€çœ‹æ•ˆæœ\n\n![image contain](/img/2024-08-28-äº†è§£å®¹å™¨overlayæ–‡ä»¶ç³»ç»Ÿ/image37.png)\n\næˆ‘ä»¬åœ¨å®¹å™¨ä¸­åˆ é™¤ /etc ç›®å½•ä¸‹çš„ shadow æ–‡ä»¶ï¼Œå¯ä»¥çœ‹åˆ°åœ¨ diff ç›®å½•ä¸‹çš„ /etc ä¸­å¤šäº†ä¸€ä¸ª shadow æ–‡ä»¶ï¼Œè€Œè¿™ä¸ªæ–‡ä»¶å®é™…ä¸Šå°±æ˜¯æˆ‘ä»¬åœ¨æ–‡ç« ä¸€å¼€å§‹è®²åˆ°çš„ whiteout æ–‡ä»¶ï¼Œç”¨æ¥éšè—æˆ‘ä»¬å·²ç»åˆ æ‰çš„ shadow æ–‡ä»¶ï¼Œè€Œå®é™…ä¸Šé•œåƒå±‚çš„ shadow æ–‡ä»¶å¹¶æ²¡æœ‰è¢«åˆ é™¤\n\n![image diff](/img/2024-08-28-äº†è§£å®¹å™¨overlayæ–‡ä»¶ç³»ç»Ÿ/image38.png)\n\nè‡³æ­¤ï¼Œæˆ‘ä»¬å¯¹äº Docker ä½¿ç”¨çš„ overlay2 æ–‡ä»¶ç»“æ„åˆ†æç»“æŸã€‚","tags":["docker","contain"]},{"title":"github å›½å†…ä»£ç†è®¿é—®ä¸‹è½½","url":"/2024/08/20/2024-08-20-github å›½å†…ä»£ç†è®¿é—®ä¸‹è½½/","content":"\n## **æ¼”ç¤ºä»£ç†**\n\n1. å‰ç¼€\n\n> https://github.jobcher.com/gh/\n> \n1. ä¸‹è½½ä»“åº“\n\n> git cloneÂ https://github.jobcher.com/gh/<ä½ è¦ä¸‹è½½çš„GitHubåœ°å€>\n> \n\n```bash\ngit clone https://github.jobcher.com/gh/https://github.com/wu3227834/ann-filtering-benchmark-datasets.git\n```\n\n## **å¦å¤–ä¸€ç§æ–¹æ³•**\n\nåœ¨ä½ æœ‰ç§‘å­¦ä¸Šç½‘çš„å‰æä¸‹ä½¿ç”¨ä»£ç†æ–¹å¼æ¥è¿æ¥github\n\n```bash\ngit config --global https.proxy http://127.0.0.1:1080\n#å–æ¶ˆè®¾ç½®\ngit config --global --unset https.proxy\n```\n\n[http://127.0.0.1:1080](http://127.0.0.1:1080/) æ˜¯ä½ çš„ä»£ç†æœåŠ¡åœ°å€","tags":["git"]},{"title":"python å¹¶å‘å‡½æ•°","url":"/2024/08/20/2024-08-20-python å¹¶å‘å‡½æ•°/","content":"\n## å‰è¨€\n\nå·¥ä½œéœ€è¦å‘å‡ åä¸‡è¡¨å†™å…¥äº¿çº§åˆ«æ•°æ®ï¼Œæƒ³ä½¿ç”¨ pyhon çš„å¹¶å‘æ‰§è¡Œã€‚æ‰å¼€å§‹ä½¿ç”¨ ThreadPoolExecutor å‘ç°å¥‡æ…¢æ— æ¯”ï¼Œå¤§ä½¬è¯´è¿™å…¶å®æ˜¯ä¸²è¡Œï¼Œå¹¶å‘å¾—ç”¨  multiprocessingï¼Œç«‹å¸–ç ”ç©¶ã€‚\n\næœ¬æ–‡ä»¥ python3.10 ä¸ºä¾‹ï¼Œå­¦ä¹ ä¸€ä¸‹ python çš„å¹¶å‘æ‰§è¡Œã€‚\n\n## å¹¶å‘æ‰§è¡Œ\n\npython å¹¶å‘æ‰§è¡Œåˆ†ä¸‰ä¸ªæ–¹é¢ï¼šå¤šçº¿ç¨‹ï¼ˆthreadingï¼‰ã€å¤šè¿›ç¨‹ï¼ˆmultiprocessingï¼‰ã€å¤šåç¨‹ï¼ˆasynicoï¼‰\n\né€‚å½“çš„å·¥å…·é€‰æ‹©ä¸»è¦å–å†³äºè¦æ‰§è¡Œçš„ä»»åŠ¡ï¼ˆCPU å¯†é›†å‹æˆ– IO å¯†é›†å‹ï¼‰ï¼š\n\n- CPU å¯†é›†å‹ï¼ˆCPU-boundï¼‰ï¼šä¹Ÿå«åšè®¡ç®—å¯†é›†å‹ï¼Œæ˜¯æŒ‡ I/O åœ¨å¾ˆçŸ­æ—¶é—´å†…å°±å¯ä»¥å®Œæˆï¼ŒCPU  éœ€è¦å¤§é‡çš„è®¡ç®—å’Œå¤„ç†ï¼Œç‰¹ç‚¹æ˜¯ CPU å ç”¨ç‡ç›¸å½“é«˜ï¼›ä¾‹å¦‚ï¼š**å‹ç¼©/è§£å‹ç¼©ã€åŠ å¯†è§£å¯†ã€æ­£åˆ™è¡¨è¾¾å¼æœç´¢ã€è®¡ç®—**ï¼›\n- IO å¯†é›†å‹ï¼ˆI/O boundï¼‰ï¼šæ˜¯æŒ‡ç³»ç»Ÿè¿ä½œå¤§éƒ¨åˆ†çš„çŠ¶å†µæ˜¯ CPU åœ¨ç­‰ I/Oï¼ˆç¡¬ç›˜ï¼Œå†…å­˜ï¼‰çš„è¯»å†™æ“ä½œï¼ŒCPU å ç”¨ç‡è¾ƒä½ï¼Œä¾‹å¦‚ï¼š**æ–‡ä»¶å¤„ç†ï¼Œç½‘ç»œçˆ¬è™«ï¼Œè¯»å†™æ•°æ®åº“ï¼›**\n\nåœ¨å¯¹æ¯”è¿™ä¸‰ç§æ–¹å¼ä¹‹å‰ï¼Œè®©æˆ‘ä»¬å…ˆäº†è§£ä¸¤ä¸ªæ¦‚å¿µï¼š**å¹¶è¡Œå’Œå¹¶å‘**\n\n### å¹¶è¡Œå’Œå¹¶å‘çš„åŒºåˆ«\n\nåœ¨ Python ä¸­ï¼Œ\"å¹¶å‘\"å’Œ\"å¹¶è¡Œ\"æ˜¯ä¸¤ä¸ªç›¸å…³ä½†ä¸åŒçš„æ¦‚å¿µã€‚\n\n> å¹¶å‘ ï¼ˆConcurrencyï¼‰æ˜¯æŒ‡ç¨‹åºçš„è®¾è®¡æ–¹å¼ï¼Œå…è®¸å¤šä¸ªä»»åŠ¡åœ¨é‡å çš„æ—¶é—´æ®µå†…æ‰§è¡Œã€‚è™½ç„¶åœ¨åŒä¸€æ—¶åˆ»åªèƒ½æ‰§è¡Œä¸€ä¸ªä»»åŠ¡ï¼Œä½†ä»»åŠ¡ä¹‹é—´å¯ä»¥é€šè¿‡åˆ‡æ¢ä¸Šä¸‹æ–‡æ¥å®ç°äº¤æ›¿æ‰§è¡Œã€‚è¿™ç§äº¤æ›¿æ‰§è¡Œçš„æ–¹å¼å¯ä»¥æé«˜ç¨‹åºçš„å“åº”æ€§å’Œæ•ˆç‡ï¼Œå°¤å…¶æ˜¯åœ¨å¤„ç† I/O å¯†é›†å‹ä»»åŠ¡æ—¶ã€‚åœ¨å¹¶å‘ç¼–ç¨‹ä¸­ï¼Œä»»åŠ¡ä¹‹é—´é€šå¸¸æ˜¯ç‹¬ç«‹çš„ï¼Œå®ƒä»¬å¯ä»¥é€šè¿‡å¤šçº¿ç¨‹ã€å¤šè¿›ç¨‹ã€åç¨‹æˆ–å¼‚æ­¥ç¼–ç¨‹ç­‰æ–¹å¼æ¥å®ç°ã€‚\n> \n> å¹¶è¡Œï¼ˆParallelismï¼‰æ˜¯æŒ‡å¤šä¸ªä»»åŠ¡åŒæ—¶æ‰§è¡Œçš„èƒ½åŠ›ã€‚åœ¨å¹¶è¡Œç¼–ç¨‹ä¸­ï¼Œå¤šä¸ªä»»åŠ¡çœŸæ­£åœ°åŒæ—¶æ‰§è¡Œï¼Œé€šå¸¸éœ€è¦å¤šä¸ªç‰©ç†æˆ–é€»è¾‘å¤„ç†å•å…ƒï¼ˆä¾‹å¦‚å¤šæ ¸ CPUï¼‰ã€‚å¹¶è¡Œæ‰§è¡Œä»»åŠ¡å¯ä»¥æ˜¾è‘—æé«˜è®¡ç®—å¯†é›†å‹ä»»åŠ¡çš„æ€§èƒ½ï¼Œä½†å¯¹äºI/Oå¯†é›†å‹ä»»åŠ¡åˆ™æ²¡æœ‰æ˜æ˜¾çš„ä¼˜åŠ¿ã€‚\n\nç®€å•æ¥è¯´ï¼Œ**å¹¶å‘æ˜¯æŒ‡å¤šä¸ªä»»åŠ¡åœ¨é‡å çš„æ—¶é—´æ®µå†…äº¤æ›¿æ‰§è¡Œï¼Œé€šè¿‡åˆ‡æ¢ä¸Šä¸‹æ–‡å®ç°ä»»åŠ¡ä¹‹é—´çš„äº¤æ›¿æ‰§è¡Œï¼Œä»¥æé«˜ç¨‹åºçš„å“åº”æ€§å’Œæ•ˆç‡ï¼›è€Œå¹¶è¡Œæ˜¯æŒ‡å¤šä¸ªä»»åŠ¡çœŸæ­£åœ°åŒæ—¶æ‰§è¡Œï¼Œé€šå¸¸éœ€è¦å¤šä¸ªç‰©ç†æˆ–é€»è¾‘å¤„ç†å•å…ƒï¼Œç”¨äºåŒæ—¶å¤„ç†ä¸åŒä»»åŠ¡ï¼Œä»¥æé«˜è®¡ç®—å¯†é›†å‹ä»»åŠ¡çš„æ€§èƒ½ã€‚**\n\n```python\nimport time\nimport concurrent.futures\n\n# å¹¶å‘æ‰§è¡Œä»»åŠ¡\ndef task(name):\n    print(f'Task {name} started')\n    time.sleep(2)\n    print(f'Task {name} completed')\n\n# å¹¶è¡Œæ‰§è¡Œä»»åŠ¡\ndef parallel_task(name):\n    print(f'Task {name} started')\n    time.sleep(2)\n    print(f'Task {name} completed')\n\n# å¹¶å‘ç¤ºä¾‹\nwith concurrent.futures.ThreadPoolExecutor() as executor:\n    tasks = ['A', 'B', 'C']\n    executor.map(task, tasks)\n\n# å¹¶è¡Œç¤ºä¾‹\nwith concurrent.futures.ProcessPoolExecutor() as executor:\n    tasks = ['X', 'Y', 'Z']\n    executor.map(parallel_task, tasks)\n```\n\nåœ¨ä¸Šé¢çš„ç¤ºä¾‹ä¸­ï¼Œ'task' å‡½æ•°æ¨¡æ‹Ÿäº†ä¸€ä¸ªè€—æ—¶ 2 ç§’çš„ä»»åŠ¡ï¼Œå¹¶ä½¿ç”¨çº¿ç¨‹æ± å®ç°äº†å¹¶å‘æ‰§è¡Œã€‚'parallel_task' å‡½æ•°ä¹Ÿæ˜¯ä¸€ä¸ªè€—æ—¶ 2 ç§’çš„ä»»åŠ¡ï¼Œä½†ä½¿ç”¨äº†è¿›ç¨‹æ± å®ç°äº†å¹¶è¡Œæ‰§è¡Œã€‚æˆ‘ä»¬å¯ä»¥è¿è¡Œè¿™æ®µä»£ç ï¼Œè§‚å¯Ÿä»»åŠ¡å¯åŠ¨æ—¶ python è¿›ç¨‹çš„æ•°ç›®ã€æ‰§è¡Œçš„é¡ºåºå’Œæ—¶é—´ï¼Œä»¥æ›´å¥½åœ°ç†è§£å¹¶å‘å’Œå¹¶è¡Œçš„åŒºåˆ«ã€‚\n\nç„¶åï¼Œæˆ‘ä»¬æ¥èŠ å¤šè¿›ç¨‹ã€å¤šçº¿ç¨‹ã€å¤šåç¨‹çš„ä¸åŒã€å…³ç³»ä»¥åŠæ€ä¹ˆé€‰æ‹©ã€‚\n\n### è¿›ç¨‹ã€çº¿ç¨‹ã€åç¨‹çš„å¯¹æ¯”\n\n- å¤šè¿›ç¨‹ï¼š\n    - ä¼˜ç‚¹ï¼šå¯ä»¥å®ç°å¹¶è¡Œï¼Œä¸”åªæœ‰å¤šè¿›ç¨‹å¯ä»¥å®ç°å¹¶è¡Œ\n    - ç¼ºç‚¹ï¼šå ç”¨èµ„æºå¤šï¼Œå¯å¯åŠ¨æ•°ç›®æœ€å°‘\n- å¤šçº¿ç¨‹ï¼š\n    - å ç”¨èµ„æºå°‘ï¼Œè½»é‡çº§\n    - python çš„çº¿ç¨‹æ˜¯æ— æ³•å¹¶è¡Œçš„ï¼ˆå ç”¨å¤šä¸ª cpuï¼‰ï¼Œåªèƒ½è¿›è¡Œå¹¶å‘\n    - åˆ‡æ¢çº¿ç¨‹ä¹Ÿæ˜¯æœ‰å¼€é”€çš„ã€‚\n    - é€‚åˆ IO å¯†é›†å‹è¿ç®—ã€åŒæ—¶è¿è¡Œä»»åŠ¡ä¸å¤šï¼ˆçº¿ç¨‹å¯å¯åŠ¨æ•°é‡ä¹Ÿæ˜¯æœ‰é™åˆ¶çš„ï¼‰\n- å¤šåç¨‹ï¼š\n    - ä¼˜ç‚¹ï¼šå†…å­˜å¼€é”€æœ€å°ï¼Œå¯å¯åŠ¨æ•°é‡æœ€å¤š\n    - ç¼ºç‚¹ï¼šæ”¯æŒçš„åº“æ¯”è¾ƒå°‘ï¼Œä»£ç å¤æ‚ï¼Œä¾‹å¦‚çˆ¬è™«ä¸æ”¯æŒï¼Œæ‰€ä»¥æƒ³ç”¨å¤šåç¨‹çˆ¬å–çš„è¯ï¼Œå¯ä»¥ç”¨ aiohttpï¼Œä¸èƒ½ç”¨ requests\n    - é€‚ç”¨äºï¼šIO å¯†é›†å‹ã€è¶…å¤šä»»åŠ¡è¿è¡Œ\n\n### è¿›ç¨‹ã€çº¿ç¨‹ã€åç¨‹çš„å…³ç³»\n\n- ä¸€ä¸ªè¿›ç¨‹ä¸­å¯ä»¥å¯åŠ¨å¾ˆå¤šçº¿ç¨‹\n- ä¸€ä¸ªçº¿ç¨‹ä¸­å¯ä»¥å¯åŠ¨å¾ˆå¤šåç¨‹\n\n### **python æ…¢çš„åŸå› **\n\nä¸¤ä¸ªåŸå› ï¼š\n\n- æ˜¯è§£é‡Šå‹è¯­è¨€ï¼Œè¾¹è§£é‡Šè¾¹æ‰§è¡Œ\n- GILï¼Œæ— æ³•åˆ©ç”¨å¤šæ ¸ CPU\n\nGIL æ˜¯ä»€ä¹ˆï¼Œä¸ºä»€ä¹ˆæœ‰ GILï¼Ÿ\n\nå…¨å±€è§£é‡Šå™¨é”ï¼ˆGlobal interpreter lockï¼‰ï¼Œæ˜¯è®¡ç®—æœºç¨‹åºè®¾è®¡è¯­è¨€è§£é‡Šå™¨ç”¨äºåŒæ­¥çº¿ç¨‹çš„ä¸€ç§æœºåˆ¶ï¼Œå®ƒä½¿å¾—ä»»ä½•æ—¶åˆ»ä»…æœ‰ä¸€ä¸ªçº¿ç¨‹åœ¨æ‰§è¡Œã€‚\n\npython è®¾è®¡åˆæœŸä¸ºäº†è§£å†³çº¿ç¨‹å¹¶å‘çš„é—®é¢˜å¼•å…¥äº† GILï¼Œä½†æ˜¯ç°åœ¨å¾ˆéš¾å»é™¤ï¼Œæœ¬è´¨æ˜¯ä¸€ç§é”ï¼Œå®ƒçš„å¥½å¤„åœ¨äºç®€åŒ–äº† python å¯¹å…±äº«èµ„æºçš„ç®¡ç†ï¼Œä½†æ˜¯å¯¼è‡´ python æ— æ³•å®ç°çœŸæ­£çš„å¤šçº¿ç¨‹æ‰§è¡Œã€‚\n\næ€æ ·è§„é¿ GIL å¸¦æ¥çš„é™åˆ¶ï¼š\n\n- IO æœŸé—´çº¿ç¨‹ä¼šé‡Šæ”¾ GILï¼Œå®ç° CPU å’Œ IO çš„å¹¶å‘ï¼Œå› æ­¤ GIL çš„å­˜åœ¨å¯¹äº IO å¯†é›†å‹è®¡ç®—æ˜¯æœ‰å¥½çš„ï¼Œä½†æ˜¯å¯¹ CPU å¯†é›†å‹åˆ™ä¼šæ‹–ç´¯é€Ÿåº¦\n- åˆ©ç”¨ multiprocessingï¼Œå¯ä»¥åˆ©ç”¨å¤šæ ¸ CPU çš„ä¼˜åŠ¿\n\n### **æ€æ ·é€‰æ‹©**\n\n- IO å¯†é›†å‹è¿ç®—ä¼˜å…ˆé€‰æ‹©å¤šè¿›ç¨‹\n- è‹¥æ»¡è¶³ä¸‰ç‚¹ï¼šéœ€è¦è¶…å¤šä»»åŠ¡é‡ã€æœ‰ç°æˆåç¨‹åº“æ”¯æŒ ã€ä»£ç å¤æ‚åº¦å¯ä»¥æ¥å—ï¼Œåˆ™é€‰æ‹©åç¨‹ï¼Œå¦åˆ™é€‰æ‹©çº¿ç¨‹\n\n## **threadingÂ --- åŸºäºçº¿ç¨‹çš„å¹¶è¡Œ**\n\n[3.10.13 Documentation Â» Python æ ‡å‡†åº“ Â» å¹¶å‘æ‰§è¡Œ Â» threading --- åŸºäºçº¿ç¨‹çš„å¹¶è¡Œ](https://docs.python.org/zh-cn/3.10/library/threading.html)\n\n## multiprocessing --- åŸºäºè¿›ç¨‹çš„å¹¶è¡Œ\n\n[3.10.13 Documentation Â» Python æ ‡å‡†åº“ Â» å¹¶å‘æ‰§è¡Œ Â» multiprocessing --- åŸºäºè¿›ç¨‹çš„å¹¶è¡Œ](https://docs.python.org/zh-cn/3.10/library/multiprocessing.html)\n\n## å‚è€ƒ\n\n- [3.10.13 Documentation Â» Python æ ‡å‡†åº“ Â» å¹¶å‘æ‰§è¡Œ](https://docs.python.org/zh-cn/3.10/library/concurrency.html)\n- [pythonå¹¶å‘ç¼–ç¨‹è¿™ä¸€ç¯‡å°±å¤Ÿäº†](https://blog.csdn.net/weixin_52906070/article/details/132317118)\n- [pythonå¹¶å‘ä»0åˆ°1](https://xz.aliyun.com/t/12766?time__1311=GqGxu7G%3DoYqWqGN4eeqBKIh4Rh%3D9kFda4D)\n- [Pythonä¸­çš„å¹¶å‘å’Œå¹¶è¡Œæ˜¯ä»€ä¹ˆæ„æ€?](https://www.itheima.com/news/20230710/103420.html)","tags":["python"]},{"title":"Javaå‘½ä»¤å­¦ä¹ ç³»åˆ—â€”Jps","url":"/2024/06/30/2024-06-30-Javaå‘½ä»¤å­¦ä¹ ç³»åˆ—â€”Jps/","content":"\n> jps ä½äº jdk çš„ bin ç›®å½•ä¸‹ï¼Œå…¶ä½œç”¨æ˜¯æ˜¾ç¤ºå½“å‰ç³»ç»Ÿçš„ java è¿›ç¨‹æƒ…å†µï¼ŒåŠå…¶ id å·ã€‚ jps ç›¸å½“äº Solaris è¿›ç¨‹å·¥å…· psã€‚ä¸åƒ â€pgrep javaâ€ æˆ– â€ps -ef grep javaâ€ ï¼Œjps å¹¶ä¸ä½¿ç”¨åº”ç”¨ç¨‹åºåæ¥æŸ¥æ‰¾ JVM å®ä¾‹ã€‚å› æ­¤ï¼Œå®ƒæŸ¥æ‰¾æ‰€æœ‰çš„ Java åº”ç”¨ç¨‹åºï¼ŒåŒ…æ‹¬å³ä½¿æ²¡æœ‰ä½¿ç”¨ java æ‰§è¡Œä½“çš„é‚£ç§ï¼ˆä¾‹å¦‚ï¼Œå®šåˆ¶çš„å¯åŠ¨ å™¨ï¼‰ã€‚å¦å¤–ï¼Œjps ä»…æŸ¥æ‰¾å½“å‰ç”¨æˆ·çš„ Java è¿›ç¨‹ï¼Œè€Œä¸æ˜¯å½“å‰ç³»ç»Ÿä¸­çš„æ‰€æœ‰è¿›ç¨‹ã€‚\n> \n\n## ä½ç½®\n\næˆ‘ä»¬çŸ¥é“ï¼Œå¾ˆå¤š JAVA å‘½ä»¤éƒ½åœ¨ jdk çš„ JAVA_HOME/bin/ ç›®å½•ä¸‹é¢ï¼Œjps ä¹Ÿä¸ä¾‹å¤–ï¼Œå®ƒå°±åœ¨ bin ç›®å½•ä¸‹ï¼Œå®ƒæ˜¯ java è‡ªå¸¦çš„ä¸€ä¸ªå‘½ä»¤ã€‚\n\n## åŠŸèƒ½\n\njpsï¼ˆJava Virtual Machine Process Status Toolï¼‰æ˜¯ JDK 1.5 æä¾›çš„ä¸€ä¸ªæ˜¾ç¤ºå½“å‰æ‰€æœ‰ java è¿›ç¨‹ pid çš„å‘½ä»¤ï¼Œç®€å•å®ç”¨ï¼Œéå¸¸é€‚åˆåœ¨ linux/unix å¹³å°ä¸Šç®€å•å¯Ÿçœ‹å½“å‰ java è¿›ç¨‹çš„ä¸€äº›ç®€å•æƒ…å†µã€‚\n\n## åŸç†\n\njdk ä¸­çš„ jps å‘½ä»¤å¯ä»¥æ˜¾ç¤ºå½“å‰è¿è¡Œçš„ java è¿›ç¨‹ä»¥åŠç›¸å…³å‚æ•°ï¼Œå®ƒçš„å®ç°æœºåˆ¶å¦‚ä¸‹ï¼š\n\njava ç¨‹åºåœ¨å¯åŠ¨ä»¥åï¼Œä¼šåœ¨ `java.io.tmpdir` æŒ‡å®šçš„ç›®å½•ä¸‹ï¼Œå°±æ˜¯ä¸´æ—¶æ–‡ä»¶å¤¹é‡Œï¼Œç”Ÿæˆä¸€ä¸ªç±»ä¼¼äº\n\n`hsperfdata_User` çš„æ–‡ä»¶å¤¹ï¼Œè¿™ä¸ªæ–‡ä»¶å¤¹é‡Œï¼ˆåœ¨ Linux ä¸­ä¸º /tmp/hsperfdata_{userName}/ï¼‰ï¼Œæœ‰å‡ ä¸ªæ–‡ä»¶ï¼Œåå­—å°±æ˜¯ java è¿›ç¨‹çš„ pidï¼Œå› æ­¤åˆ—å‡ºå½“å‰è¿è¡Œçš„ java è¿›ç¨‹ï¼Œåªæ˜¯æŠŠè¿™ä¸ªç›®å½•é‡Œçš„æ–‡ä»¶ååˆ—ä¸€ä¸‹è€Œå·²ã€‚ è‡³äºç³»ç»Ÿçš„å‚æ•°ä»€ä¹ˆï¼Œå°±å¯ä»¥è§£æè¿™å‡ ä¸ªæ–‡ä»¶è·å¾—ã€‚ä¾‹å¦‚ï¼š\n\n```bash\n[root@pudding-160 hsperfdata_root]## ll\ntotal 96\n-rw------- 1 root root 32768 Jun 25 21:28 372997\n-rw------- 1 root root 32768 Jun 25 21:27 49553\n-rw------- 1 root root 32768 Jun 25 21:27 5032\n[root@pudding-160 hsperfdata_root]## pwd\n/tmp/hsperfdata_root\n[root@pudding-160 hsperfdata_root]## jps\n372997 ManagerMaster\n49553 RunJar\n5032 ManagerAgent\n433884 Jps\n```\n\n## ä½¿ç”¨\n\næƒ³è¦å­¦ä¹ ä¸€ä¸ªå‘½ä»¤ï¼Œå…ˆæ¥çœ‹çœ‹å¸®åŠ©ï¼Œä½¿ç”¨ `jps -help` æŸ¥çœ‹å¸®åŠ©ï¼š\n\n```bash\n[root@pudding-160 ~]## jps -help\nusage: jps [-help]\n       jps [-q] [-mlvV] [<hostid>]\n\nDefinitions:\n    <hostid>:      <hostname>[:<port>]\n```\n\næ¥ä¸‹æ¥ï¼Œä¸ºäº†è¯¦ç»†ä»‹ç»è¿™äº›å‚æ•°ï¼Œæˆ‘ä»¬ç¼–å†™å‡ ä¸ªç±»ï¼Œåœ¨ main æ–¹æ³•é‡Œå†™ä¸€ä¸ª while(true) çš„å¾ªç¯ï¼ŒæŸ¥çœ‹ java è¿›ç¨‹æƒ…å†µã€‚ä»£ç å¦‚ä¸‹ï¼š\n\n```java\npackage com.JavaCommand;\n/**\n * @author pudding\n */\npublic class JpsDemo {\n    public static void main(String[] args) {\n        while(true){\n            System.out.println(1);\n        }\n    }\n}\n```\n\n**-q åªæ˜¾ç¤º pidï¼Œä¸æ˜¾ç¤º class åç§°ã€jar æ–‡ä»¶åå’Œä¼ é€’ç»™ main æ–¹æ³•çš„å‚æ•°**\n\n```bash\npudding@DESKTOP-1QCHCU4:/mnt/wsl/demo$ jps -q\n4167\n4312\n```\n\n**-m è¾“å‡ºä¼ é€’ç»™ main æ–¹æ³•çš„å‚æ•°ï¼Œåœ¨åµŒå…¥å¼ jvm ä¸Šå¯èƒ½æ˜¯nullï¼Œ**åœ¨è¿™é‡Œï¼Œåœ¨å¯åŠ¨ main æ–¹æ³•çš„æ—¶å€™ï¼Œæˆ‘ç»™ String[] args ä¼ é€’ä¸€ä¸ªå‚æ•°ï¼špuddingï¼Œæ‰§è¡Œ`jsp -m` ï¼š\n\n```bash\npudding@DESKTOP-1QCHCU4:/mnt/wsl/demo$ jps -m\n7760 Jps -m\n7674 JpsDemo pudding\n```\n\n**-l è¾“å‡ºåº”ç”¨ç¨‹åº main class çš„å®Œæ•´ package åæˆ–è€…åº”ç”¨ç¨‹åºçš„ jar æ–‡ä»¶å®Œæ•´è·¯å¾„åï¼š**\n\n```bash\npudding@DESKTOP-1QCHCU4:/mnt/wsl/demo$ jps -l\n4517 sun.tools.jps.Jps\n4167 com.JavaCommand.JpsDemo\n```\n\n**-v è¾“å‡ºä¼ é€’ç»™ JVM çš„å‚æ•°ï¼›**åœ¨è¿™é‡Œï¼Œåœ¨å¯åŠ¨ main æ–¹æ³•çš„æ—¶å€™ï¼Œæˆ‘ç»™ jvm ä¼ é€’ä¸€ä¸ªå‚æ•°ï¼š-Dfile.encoding=UTF-8ï¼Œæ‰§è¡Œ`jps -v`ï¼š\n\n```bash\npudding@DESKTOP-1QCHCU4:/mnt/wsl/demo$ jps -v\n9317 JpsDemo -Dfile.encoding=UTF-8\n9391 Jps -Dapplication.home=/usr/lib/jvm/java-8-openjdk-amd64 -Xms8m\n```\n\nPSï¼šjps å‘½ä»¤æœ‰ä¸ªåœ°æ–¹å¾ˆä¸å¥½ï¼Œä¼¼ä¹åªèƒ½æ˜¾ç¤ºå½“å‰ç”¨æˆ·çš„ java è¿›ç¨‹ï¼Œè¦æ˜¾ç¤ºå…¶ä»–ç”¨æˆ·çš„è¿˜æ˜¯åªèƒ½ç”¨ unix/linux çš„ ps å‘½ä»¤ã€‚\n\n> jps æ˜¯æˆ‘æœ€å¸¸ç”¨çš„ java å‘½ä»¤ã€‚ä½¿ç”¨ jps å¯ä»¥æŸ¥çœ‹å½“å‰æœ‰å“ªäº› Java è¿›ç¨‹å¤„äºè¿è¡ŒçŠ¶æ€ã€‚å¦‚æœæˆ‘è¿è¡Œäº†ä¸€ä¸ª web åº”ç”¨ï¼ˆä½¿ç”¨ tomcatã€jbossã€jetty ç­‰å¯åŠ¨ï¼‰çš„æ—¶å€™ï¼Œæˆ‘å°±å¯ä»¥ä½¿ç”¨ jps æŸ¥çœ‹å¯åŠ¨æƒ…å†µã€‚æœ‰çš„æ—¶å€™æˆ‘æƒ³çŸ¥é“è¿™ä¸ªåº”ç”¨çš„æ—¥å¿—ä¼šè¾“å‡ºåˆ°å“ªé‡Œï¼Œæˆ–è€…å¯åŠ¨çš„æ—¶å€™ä½¿ç”¨äº†å“ªäº› javaagentï¼Œé‚£ä¹ˆæˆ‘å¯ä»¥ä½¿ç”¨ jps -vÂ æŸ¥çœ‹è¿›ç¨‹çš„ jvm å‚æ•°æƒ…å†µã€‚\n> \n\n## jps å¤±æ•ˆå¤„ç†\n\n### ç°è±¡\n\nç”¨ `ps -ef|grep java` èƒ½çœ‹åˆ°å¯åŠ¨çš„ java è¿›ç¨‹ï¼Œä½†æ˜¯ç”¨ jps æŸ¥çœ‹å´ä¸å­˜åœ¨è¯¥è¿›ç¨‹çš„ idã€‚å¾…ä¼šå„¿è§£é‡Šè¿‡ä¹‹åå°±èƒ½çŸ¥é“åœ¨è¯¥æƒ…å†µä¸‹ï¼Œjconsoleã€jvisualvm å¯èƒ½æ— æ³•ç›‘æ§è¯¥è¿›ç¨‹ï¼Œå…¶ä»– java è‡ªå¸¦å·¥å…·ä¹Ÿå¯èƒ½æ— æ³•ä½¿ç”¨ã€‚\n\n### åˆ†æ\n\njpsã€jconsoleã€jvisualvm ç­‰å·¥å…·çš„æ•°æ®æ¥æºå°±æ˜¯è¿™ä¸ªæ–‡ä»¶ï¼ˆ/tmp/hsperfdata_${userName}/pid)ã€‚æ‰€ä»¥å½“è¯¥æ–‡ä»¶ä¸å­˜åœ¨æˆ–æ˜¯æ— æ³•è¯»å–æ—¶å°±ä¼šå‡ºç° jps æ— æ³•æŸ¥çœ‹è¯¥è¿›ç¨‹å·ï¼Œjconsole æ— æ³•ç›‘æ§ç­‰é—®é¢˜\n\n### åŸå› \n\n1. **ç£ç›˜è¯»å†™ã€ç›®å½•æƒé™é—®é¢˜**ï¼šè‹¥è¯¥ç”¨æˆ·æ²¡æœ‰æƒé™å†™/tmpç›®å½•æˆ–æ˜¯ç£ç›˜å·²æ»¡ï¼Œåˆ™æ— æ³•åˆ›å»º /tmp/hsperfdata_${userName}/pid æ–‡ä»¶ã€‚æˆ–è¯¥æ–‡ä»¶å·²ç»ç”Ÿæˆï¼Œä½†ç”¨æˆ·æ²¡æœ‰è¯»æƒé™\n2. **ä¸´æ—¶æ–‡ä»¶ä¸¢å¤±ï¼Œè¢«åˆ é™¤æˆ–æ˜¯å®šæœŸæ¸…ç†**ï¼šå¯¹äº linux æœºå™¨ï¼Œä¸€èˆ¬éƒ½ä¼šå­˜åœ¨å®šæ—¶ä»»åŠ¡å¯¹ä¸´æ—¶æ–‡ä»¶å¤¹è¿›è¡Œæ¸…ç†ï¼Œå¯¼è‡´ /tmp ç›®å½•è¢«æ¸…ç©ºã€‚è¿™ä¹Ÿæ˜¯æˆ‘ç¬¬ä¸€æ¬¡ç¢°åˆ°è¯¥ç°è±¡çš„åŸå› ã€‚å¸¸ç”¨çš„å¯èƒ½å®šæ—¶åˆ é™¤ä¸´æ—¶ç›®å½•çš„å·¥å…·ä¸º crontabã€redhat çš„ tmpwatchã€ubuntu çš„ tmpreaper ç­‰ç­‰\n    \n    > è¿™ä¸ªå¯¼è‡´çš„ç°è±¡å¯èƒ½ä¼šæ˜¯è¿™æ ·ï¼Œç”¨ jconsole ç›‘æ§è¿›ç¨‹ï¼Œå‘ç°åœ¨æŸä¸€æ—¶æ®µåè¿›ç¨‹ä»ç„¶å­˜åœ¨ï¼Œä½†æ˜¯å´æ²¡æœ‰ç›‘æ§ä¿¡æ¯äº†ã€‚\n    > \n3. **java è¿›ç¨‹ä¿¡æ¯æ–‡ä»¶å­˜å‚¨åœ°å€è¢«è®¾ç½®ï¼Œä¸åœ¨ /tmp ç›®å½•ä¸‹**ï¼šä¸Šé¢æˆ‘ä»¬åœ¨ä»‹ç»æ—¶è¯´é»˜è®¤ä¼šåœ¨ /tmp/hsperfdata_${userName} ç›®å½•ä¿å­˜è¿›ç¨‹ä¿¡æ¯ï¼Œä½†ç”±äºä»¥ä¸Š 1ã€2 æ‰€è¿°åŸå› ï¼Œå¯èƒ½å¯¼è‡´è¯¥æ–‡ä»¶æ— æ³•ç”Ÿæˆæˆ–æ˜¯ä¸¢å¤±ï¼Œæ‰€ä»¥ java å¯åŠ¨æ—¶æä¾›äº†å‚æ•°ï¼ˆ-Djava.io.tmpdirï¼‰ï¼Œå¯ä»¥å¯¹è¿™ä¸ªæ–‡ä»¶çš„ä½ç½®è¿›è¡Œè®¾ç½®ï¼Œè€Œ jpsã€jconsole éƒ½åªä¼šä» /tmp ç›®å½•è¯»å–ï¼Œè€Œæ— æ³•ä»è®¾ç½®åçš„ç›®å½•è¯»ç‰©ä¿¡æ¯ï¼Œè¿™æ˜¯æˆ‘ç¬¬äºŒæ¬¡ç¢°åˆ°è¯¥ç°è±¡çš„åŸå› ","tags":["æ€§èƒ½æµ‹è¯•","Java"]},{"title":"Javaå‘½ä»¤å­¦ä¹ ç³»åˆ—â€”Jstack","url":"/2024/06/30/2024-06-30-Javaå‘½ä»¤å­¦ä¹ ç³»åˆ—â€”Jstack/","content":"\n> jstack æ˜¯ java è™šæ‹Ÿæœºè‡ªå¸¦çš„ä¸€ç§å †æ ˆè·Ÿè¸ªå·¥å…·\n> \n\n## åŠŸèƒ½\n\njstack ç”¨äºç”Ÿæˆ java è™šæ‹Ÿæœºå½“å‰æ—¶åˆ»çš„çº¿ç¨‹å¿«ç…§ã€‚çº¿ç¨‹å¿«ç…§æ˜¯å½“å‰ java è™šæ‹Ÿæœºå†…æ¯ä¸€æ¡çº¿ç¨‹æ­£åœ¨æ‰§è¡Œçš„æ–¹æ³•å †æ ˆçš„é›†åˆï¼Œç”Ÿæˆçº¿ç¨‹å¿«ç…§çš„ä¸»è¦ç›®çš„æ˜¯**å®šä½çº¿ç¨‹å‡ºç°é•¿æ—¶é—´åœé¡¿çš„åŸå› **ï¼Œå¦‚**çº¿ç¨‹é—´æ­»é”ã€æ­»å¾ªç¯ã€è¯·æ±‚å¤–éƒ¨èµ„æºå¯¼è‡´çš„é•¿æ—¶é—´**ç­‰å¾…ç­‰ã€‚ çº¿ç¨‹å‡ºç°åœé¡¿çš„æ—¶å€™é€šè¿‡ jstack æ¥æŸ¥çœ‹å„ä¸ªçº¿ç¨‹çš„è°ƒç”¨å †æ ˆï¼Œå°±å¯ä»¥çŸ¥é“æ²¡æœ‰å“åº”çš„çº¿ç¨‹åˆ°åº•åœ¨åå°åšä»€ä¹ˆäº‹æƒ…ï¼Œæˆ–è€…ç­‰å¾…ä»€ä¹ˆèµ„æºã€‚ å¦‚æœ java ç¨‹åºå´©æºƒç”Ÿæˆ core æ–‡ä»¶ï¼Œjstack å·¥å…·å¯ä»¥ç”¨æ¥è·å¾— core æ–‡ä»¶çš„ java stac kå’Œ native stack çš„ä¿¡æ¯ï¼Œä»è€Œå¯ä»¥è½»æ¾åœ°çŸ¥é“ java ç¨‹åºæ˜¯å¦‚ä½•å´©æºƒå’Œåœ¨ç¨‹åºä½•å¤„å‘ç”Ÿé—®é¢˜ã€‚å¦å¤–ï¼Œjstack å·¥å…·è¿˜å¯ä»¥é™„å±åˆ°æ­£åœ¨è¿è¡Œçš„ java ç¨‹åºä¸­ï¼Œçœ‹åˆ°å½“æ—¶è¿è¡Œçš„ java ç¨‹åºçš„ java stack å’Œ native stack çš„ä¿¡æ¯, å¦‚æœç°åœ¨è¿è¡Œçš„ java ç¨‹åºå‘ˆç° hung çš„çŠ¶æ€ï¼Œjstack æ˜¯éå¸¸æœ‰ç”¨çš„ã€‚\n\n> Soï¼Œ**jstackå‘½ä»¤ä¸»è¦ç”¨æ¥æŸ¥çœ‹Javaçº¿ç¨‹çš„è°ƒç”¨å †æ ˆçš„ï¼Œå¯ä»¥ç”¨æ¥åˆ†æçº¿ç¨‹é—®é¢˜ï¼ˆå¦‚æ­»é”ï¼‰ã€‚**\n> \n\n## **çº¿ç¨‹çŠ¶æ€**\n\næƒ³è¦é€šè¿‡ jstack å‘½ä»¤æ¥åˆ†æçº¿ç¨‹çš„æƒ…å†µçš„è¯ï¼Œé¦–å…ˆè¦çŸ¥é“çº¿ç¨‹éƒ½æœ‰å“ªäº›çŠ¶æ€ï¼Œä¸‹é¢è¿™äº›çŠ¶æ€æ˜¯æˆ‘ä»¬ä½¿ç”¨ jstack å‘½ä»¤æŸ¥çœ‹çº¿ç¨‹å †æ ˆä¿¡æ¯æ—¶å¯èƒ½ä¼šçœ‹åˆ°çš„**çº¿ç¨‹çš„å‡ ç§çŠ¶æ€**ï¼š\n\n1. NEWï¼Œæœªå¯åŠ¨çš„ã€‚ä¸ä¼šå‡ºç°åœ¨ Dump ä¸­ã€‚\n2. RUNNABLEï¼Œåœ¨è™šæ‹Ÿæœºå†…æ‰§è¡Œçš„ã€‚\n3. BLOCKEDï¼Œå—é˜»å¡å¹¶ç­‰å¾…ç›‘è§†å™¨é”ã€‚\n4. WATINGï¼Œæ— é™æœŸç­‰å¾…å¦ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œç‰¹å®šæ“ä½œã€‚\n5. TIMED_WATINGï¼Œæœ‰æ—¶é™çš„ç­‰å¾…å¦ä¸€ä¸ªçº¿ç¨‹çš„ç‰¹å®šæ“ä½œã€‚\n6. TERMINATEDï¼Œå·²é€€å‡ºçš„ã€‚\n\n## Monitor\n\nåœ¨å¤šçº¿ç¨‹çš„ JAVA ç¨‹åºä¸­ï¼Œå®ç°çº¿ç¨‹ä¹‹é—´çš„åŒæ­¥ï¼Œå°±è¦è¯´è¯´ Monitorã€‚Monitor æ˜¯ Java ä¸­ç”¨æ¥å®ç°çº¿ç¨‹ä¹‹é—´çš„äº’æ–¥ä¸åä½œçš„ä¸»è¦æ‰‹æ®µï¼Œå®ƒå¯ä»¥çœ‹æˆæ˜¯å¯¹è±¡æˆ–è€… class çš„é”ã€‚æ¯ä¸€ä¸ªå¯¹è±¡éƒ½æœ‰ï¼Œä¹Ÿä»…æœ‰ä¸€ä¸ª monitorã€‚ä¸‹å›¾ï¼Œæè¿°äº†çº¿ç¨‹å’Œ Monitor ä¹‹é—´çš„å…³ç³»ï¼Œä»¥åŠçº¿ç¨‹çš„çŠ¶æ€è½¬æ¢å›¾ï¼š\n\n![monitor](/img/2024-06-30-Jstack/Untitled.png)\n\n**è¿›å…¥åŒºï¼ˆEntrt Setï¼‰**ï¼šè¡¨ç¤ºçº¿ç¨‹é€šè¿‡ synchronized è¦æ±‚è·å–å¯¹è±¡çš„é”ã€‚å¦‚æœå¯¹è±¡æœªè¢«é”ä½ï¼Œåˆ™è¿›å…¥æ‹¥æœ‰è€…ï¼›å¦åˆ™åˆ™åœ¨è¿›å…¥åŒºç­‰å¾…ã€‚ä¸€æ—¦å¯¹è±¡é”è¢«å…¶ä»–çº¿ç¨‹é‡Šæ”¾,ç«‹å³å‚ä¸ç«äº‰ã€‚\n\n**æ‹¥æœ‰è€…ï¼ˆThe Ownerï¼‰**ï¼šè¡¨ç¤ºæŸä¸€çº¿ç¨‹æˆåŠŸç«äº‰åˆ°å¯¹è±¡é”ã€‚\n\n**ç­‰å¾…åŒºï¼ˆWait Setï¼‰**ï¼šè¡¨ç¤ºçº¿ç¨‹é€šè¿‡å¯¹è±¡çš„ wait æ–¹æ³•ï¼Œé‡Šæ”¾å¯¹è±¡çš„é”ï¼Œå¹¶åœ¨ç­‰å¾…åŒºç­‰å¾…è¢«å”¤é†’ã€‚\n\nä»å›¾ä¸­å¯ä»¥çœ‹å‡ºï¼Œä¸€ä¸ª Monitor åœ¨æŸä¸ªæ—¶åˆ»ï¼Œåªèƒ½è¢«ä¸€ä¸ªçº¿ç¨‹æ‹¥æœ‰ï¼Œè¯¥çº¿ç¨‹å°±æ˜¯Â `â€œActive Threadâ€`ï¼Œè€Œå…¶å®ƒçº¿ç¨‹éƒ½æ˜¯Â `â€œWaiting Threadâ€`ï¼Œåˆ†åˆ«åœ¨ä¸¤ä¸ªé˜Ÿåˆ—Â `â€œEntry Setâ€` å’ŒÂ `â€œWait Setâ€` é‡Œé¢ç­‰å€™ã€‚åœ¨Â `â€œEntry Setâ€` ä¸­ç­‰å¾…çš„çº¿ç¨‹çŠ¶æ€æ˜¯Â `â€œWaiting for monitor entryâ€`ï¼Œè€Œåœ¨Â `â€œWait Setâ€` ä¸­ç­‰å¾…çš„çº¿ç¨‹çŠ¶æ€æ˜¯Â `â€œin Object.wait()â€`ã€‚ å…ˆçœ‹  `â€œEntry Setâ€` é‡Œé¢çš„çº¿ç¨‹ã€‚æˆ‘ä»¬ç§°è¢« synchronized ä¿æŠ¤èµ·æ¥çš„ä»£ç æ®µä¸ºä¸´ç•ŒåŒºã€‚å½“ä¸€ä¸ªçº¿ç¨‹ç”³è¯·è¿›å…¥ä¸´ç•ŒåŒºæ—¶ï¼Œå®ƒå°±è¿›å…¥äº† `â€œEntry Setâ€` é˜Ÿåˆ—ã€‚å¯¹åº”çš„ code å°±åƒï¼š\n\n```java\nsynchronized(obj) {\n\t.........\n}\n```\n\n## è°ƒç”¨ä¿®é¥°\n\nè¡¨ç¤ºçº¿ç¨‹åœ¨æ–¹æ³•è°ƒç”¨æ—¶ï¼Œé¢å¤–çš„é‡è¦çš„æ“ä½œã€‚çº¿ç¨‹ Dump åˆ†æçš„é‡è¦ä¿¡æ¯ã€‚ä¿®é¥°ä¸Šæ–¹çš„æ–¹æ³•è°ƒç”¨ã€‚\n\n> locked <åœ°å€> ç›®æ ‡ï¼šä½¿ç”¨ synchronized ç”³è¯·å¯¹è±¡é”æˆåŠŸï¼Œç›‘è§†å™¨çš„æ‹¥æœ‰è€…ã€‚\nwaiting to lock <åœ°å€> ç›®æ ‡ï¼šä½¿ç”¨ synchronized ç”³è¯·å¯¹è±¡é”æœªæˆåŠŸï¼Œåœ¨è¿šå…¥åŒºç­‰å¾…ã€‚\nwaiting on <åœ°å€> ç›®æ ‡ï¼šä½¿ç”¨ synchronized ç”³è¯·å¯¹è±¡é”æˆåŠŸåï¼Œé‡Šæ”¾é”å¹µåœ¨ç­‰å¾…åŒºç­‰å¾…ã€‚\nparking to wait for <åœ°å€> ç›®æ ‡\n> \n\n### **locked**\n\n```java\nat oracle.jdbc.driver.PhysicalConnection.prepareStatement\n- locked <0x00002aab63bf7f58> (a oracle.jdbc.driver.T4CConnection)\nat oracle.jdbc.driver.PhysicalConnection.prepareStatement\n- locked <0x00002aab63bf7f58> (a oracle.jdbc.driver.T4CConnection)\nat com.jiuqi.dna.core.internal.db.datasource.PooledConnection.prepareStatement\n```\n\né€šè¿‡ synchronized å…³é”®å­—ï¼ŒæˆåŠŸè·å–åˆ°äº†å¯¹è±¡çš„é”,æˆä¸ºç›‘è§†å™¨çš„æ‹¥æœ‰è€…ï¼Œåœ¨ä¸´ç•ŒåŒºå†…æ“ä½œã€‚å¯¹è±¡é”æ˜¯å¯ä»¥çº¿ç¨‹é‡å…¥çš„ã€‚\n\n### **waiting to lock**\n\n```java\nat com.jiuqi.dna.core.impl.CacheHolder.isVisibleIn(CacheHolder.java:165)\n- waiting to lock <0x0000000097ba9aa8> (a CacheHolder)\nat com.jiuqi.dna.core.impl.CacheGroup$Index.findHolder\nat com.jiuqi.dna.core.impl.ContextImpl.find\nat com.jiuqi.dna.bap.basedata.common.util.BaseDataCenter.findInfo\n```\n\né€šè¿‡ synchronized å…³é”®å­—ï¼Œæ²¡æœ‰è·å–åˆ°äº†å¯¹è±¡çš„é”ï¼Œçº¿ç¨‹åœ¨ç›‘è§†å™¨çš„è¿›å…¥åŒºç­‰å¾…ã€‚åœ¨è°ƒç”¨æ ˆé¡¶å‡ºç°ï¼Œçº¿ç¨‹çŠ¶æ€ä¸º Blockedã€‚\n\n### **waiting on**\n\n```java\nat java.lang.Object.wait(Native Method)\n- waiting on <0x00000000da2defb0> (a WorkingThread)\nat com.jiuqi.dna.core.impl.WorkingManager.getWorkToDo\n- locked <0x00000000da2defb0> (a WorkingThread)\nat com.jiuqi.dna.core.impl.WorkingThread.run\n```\n\né€šè¿‡ synchronized å…³é”®å­—ï¼ŒæˆåŠŸè·å–åˆ°äº†å¯¹è±¡çš„é”åï¼Œè°ƒç”¨äº† wait æ–¹æ³•ï¼Œè¿›å…¥å¯¹è±¡çš„ç­‰å¾…åŒºç­‰å¾…ã€‚åœ¨è°ƒç”¨æ ˆé¡¶å‡ºç°ï¼Œçº¿ç¨‹çŠ¶æ€ä¸º WAITING æˆ– TIMED_WATING ã€‚\n\n### **parking to wait for**\n\npark æ˜¯åŸºæœ¬çš„çº¿ç¨‹é˜»å¡åŸè¯­ï¼Œä¸é€šè¿‡ç›‘è§†å™¨åœ¨å¯¹è±¡ä¸Šé˜»å¡ã€‚éš concurrent åŒ…ä¼šå‡ºç°çš„æ–°çš„æœºåˆ¶ï¼Œsynchronized ä½“ç³»ä¸åŒã€‚\n\n## çº¿ç¨‹åŠ¨ä½œ\n\nçº¿ç¨‹çŠ¶æ€äº§ç”Ÿçš„åŸå› ï¼š\n\n> runnableï¼šçŠ¶æ€ä¸€èˆ¬ä¸ºRUNNABLEã€‚\n> \n> \n> in Object.wait()ï¼šç­‰å¾…åŒºç­‰å¾…ï¼ŒçŠ¶æ€ä¸º WAITING æˆ– TIMED_WAITINGã€‚\n> \n> waiting for monitor entryï¼šè¿›å…¥åŒºç­‰å¾…ï¼ŒçŠ¶æ€ä¸º BLOCKEDã€‚\n> \n> waiting on conditionï¼šç­‰å¾…åŒºç­‰å¾…ã€è¢« parkã€‚\n> \n> sleepingï¼šä¼‘çœ çš„çº¿ç¨‹ï¼Œè°ƒç”¨äº† Thread.sleep()ã€‚\n> \n\n**Wait on condition**Â è¯¥çŠ¶æ€å‡ºç°åœ¨çº¿ç¨‹ç­‰å¾…æŸä¸ªæ¡ä»¶çš„å‘ç”Ÿã€‚å…·ä½“æ˜¯ä»€ä¹ˆåŸå› ï¼Œå¯ä»¥ç»“åˆ stacktrace æ¥åˆ†æã€‚\n\n- æœ€å¸¸è§çš„æƒ…å†µå°±æ˜¯çº¿ç¨‹å¤„äº sleep çŠ¶æ€ï¼Œç­‰å¾…è¢«å”¤é†’ã€‚\n- å¸¸è§çš„æƒ…å†µè¿˜æœ‰ç­‰å¾…ç½‘ç»œ IOï¼šåœ¨ java å¼•å…¥ nio ä¹‹å‰ï¼Œå¯¹äºæ¯ä¸ªç½‘ç»œè¿æ¥ï¼Œéƒ½æœ‰ä¸€ä¸ªå¯¹åº”çš„çº¿ç¨‹æ¥å¤„ç†ç½‘ç»œçš„è¯»å†™æ“ä½œï¼Œå³ä½¿æ²¡æœ‰å¯è¯»å†™çš„æ•°æ®ï¼Œçº¿ç¨‹ä»ç„¶é˜»å¡åœ¨è¯»å†™æ“ä½œä¸Šï¼Œè¿™æ ·æœ‰å¯èƒ½é€ æˆèµ„æºæµªè´¹ï¼Œè€Œä¸”ç»™æ“ä½œç³»ç»Ÿçš„çº¿ç¨‹è°ƒåº¦ä¹Ÿå¸¦æ¥å‹åŠ›ã€‚åœ¨  NewIO é‡Œé‡‡ç”¨äº†æ–°çš„æœºåˆ¶ï¼Œç¼–å†™çš„æœåŠ¡å™¨ç¨‹åºçš„æ€§èƒ½å’Œå¯æ‰©å±•æ€§éƒ½å¾—åˆ°æé«˜ã€‚æ­£ç­‰å¾…ç½‘ç»œè¯»å†™ï¼Œè¿™å¯èƒ½æ˜¯ä¸€ä¸ªç½‘ç»œç“¶é¢ˆçš„å¾å…†ã€‚å› ä¸ºç½‘ç»œé˜»å¡å¯¼è‡´çº¿ç¨‹æ— æ³•æ‰§è¡Œã€‚\n    - ä¸€ç§æƒ…å†µæ˜¯ç½‘ç»œéå¸¸å¿™ï¼Œå‡ ä¹æ¶ˆè€—äº†æ‰€æœ‰çš„å¸¦å®½ï¼Œä»ç„¶æœ‰å¤§é‡æ•°æ®ç­‰å¾…ç½‘ç»œè¯»å†™ï¼›\n    - å¦ä¸€ç§æƒ…å†µä¹Ÿå¯èƒ½æ˜¯ç½‘ç»œç©ºé—²ï¼Œä½†ç”±äºè·¯ç”±ç­‰é—®é¢˜ï¼Œå¯¼è‡´åŒ…æ— æ³•æ­£å¸¸çš„åˆ°è¾¾ã€‚\n\næ‰€ä»¥è¦ç»“åˆç³»ç»Ÿçš„ä¸€äº›æ€§èƒ½è§‚å¯Ÿå·¥å…·æ¥ç»¼åˆåˆ†æï¼Œæ¯”å¦‚ netstat ç»Ÿè®¡å•ä½æ—¶é—´çš„å‘é€åŒ…çš„æ•°ç›®ï¼Œå¦‚æœå¾ˆæ˜æ˜¾è¶…è¿‡äº†æ‰€åœ¨ç½‘ç»œå¸¦å®½çš„é™åˆ¶ï¼›è§‚å¯Ÿ cpu çš„åˆ©ç”¨ç‡ï¼Œå¦‚æœç³»ç»Ÿæ€çš„ CPU æ—¶é—´ï¼Œç›¸å¯¹äºç”¨æˆ·æ€çš„ CPU æ—¶é—´æ¯”ä¾‹è¾ƒé«˜ï¼›å¦‚æœç¨‹åºè¿è¡Œåœ¨ Solaris 10 å¹³å°ä¸Šï¼Œå¯ä»¥ç”¨ dtrace å·¥å…·çœ‹ç³»ç»Ÿè°ƒç”¨çš„æƒ…å†µï¼Œå¦‚æœè§‚å¯Ÿåˆ°  read/write çš„ç³»ç»Ÿè°ƒç”¨çš„æ¬¡æ•°æˆ–è€…è¿è¡Œæ—¶é—´é¥é¥é¢†å…ˆï¼›è¿™äº›éƒ½æŒ‡å‘ç”±äºç½‘ç»œå¸¦å®½æ‰€é™å¯¼è‡´çš„ç½‘ç»œç“¶é¢ˆã€‚\n\n## çº¿ç¨‹ Dump çš„åˆ†æ\n\n### åŸåˆ™\n\nç»“åˆä»£ç é˜…è¯»çš„æ¨ç†ã€‚éœ€è¦çº¿ç¨‹ Dump å’Œæºç çš„ç›¸äº’æ¨åˆ°å’Œå°è¯ã€‚\n\né€ æˆ Bug çš„æ ¹æºå¾€å¾€ä¼šåœ¨è°ƒç”¨æ ˆä¸Šç›´æ¥ä½“ç°ï¼Œä¸€å®šè¦æ ¼å¤–æ³¨æ„çº¿ç¨‹å½“å‰è°ƒç”¨ä¹‹å‰çš„æ‰€æœ‰è°ƒç”¨ã€‚\n\n### å…¥æ‰‹ç‚¹\n\n**è¿›å…¥åŒºç­‰å¾…**\n\n```java\n\"d&a-3588\" daemon waiting for monitor entry [0x000000006e5d5000]\njava.lang.Thread.State: BLOCKED (on object monitor)\nat com.jiuqi.dna.bap.authority.service.UserService$LoginHandler.handle()\n- waiting to lock <0x0000000602f38e90> (a java.lang.Object)\nat com.jiuqi.dna.bap.authority.service.UserService$LoginHandler.handle()\n```\n\nçº¿ç¨‹çŠ¶æ€ BLOCKEDï¼Œçº¿ç¨‹åŠ¨ä½œ wait on monitor entryï¼Œè°ƒç”¨ä¿®é¥° waiting to lock æ€»æ˜¯ä¸€èµ·å‡ºç°ã€‚è¡¨ç¤ºåœ¨ä»£ç çº§åˆ«å·²ç»å­˜åœ¨å†²çªçš„è°ƒç”¨ã€‚å¿…ç„¶æœ‰é—®é¢˜çš„ä»£ç ï¼Œéœ€è¦å°½å¯èƒ½å‡å°‘å…¶å‘ç”Ÿã€‚\n\n**åŒæ­¥å—é˜»å¡**\n\nä¸€ä¸ªçº¿ç¨‹é”ä½æŸå¯¹è±¡,å¤§é‡å…¶ä»–çº¿ç¨‹åœ¨è¯¥å¯¹è±¡ä¸Šç­‰å¾…ã€‚\n\n```java\n\"blocker\" runnable\njava.lang.Thread.State: RUNNABLE\nat com.jiuqi.hcl.javadump.Blocker$1.run(Blocker.java:23)\n- locked <0x00000000eb8eff68> (a java.lang.Object)\n\"blockee-11\" waiting for monitor entry\njava.lang.Thread.State: BLOCKED (on object monitor)\nat com.jiuqi.hcl.javadump.Blocker$2.run(Blocker.java:41)\n- waiting to lock <0x00000000eb8eff68> (a java.lang.Object)\n\"blockee-86\" waiting for monitor entry\njava.lang.Thread.State: BLOCKED (on object monitor)\nat com.jiuqi.hcl.javadump.Blocker$2.run(Blocker.java:41)\n- waiting to lock <0x00000000eb8eff68> (a java.lang.Object)\n```\n\n**æŒç»­è¿è¡Œçš„IO**Â \n\nIOæ“ä½œæ˜¯ä¼šä»¥ RUNNABLE çŠ¶æ€è¾¾æˆé˜»å¡ã€‚ä¾‹å¦‚ï¼šæ•°æ®åº“æ­»é”ã€ç½‘ç»œè¯»å†™ã€‚ æ ¼å¤–æ³¨æ„å¯¹ IO çº¿ç¨‹çš„çœŸå®çŠ¶æ€çš„åˆ†æã€‚ä¸€èˆ¬æ¥è¯´ï¼Œè¢«æ•æ‰åˆ° RUNNABLE çš„ IO è°ƒç”¨ï¼Œéƒ½æ˜¯æœ‰é—®é¢˜çš„ã€‚\n\nä»¥ä¸‹å †æ ˆæ˜¾ç¤ºï¼š çº¿ç¨‹çŠ¶æ€ä¸º RUNNABLEã€‚ è°ƒç”¨æ ˆåœ¨ SocketInputStream æˆ– SocketImpl ä¸Šï¼ŒsocketRead0 ç­‰æ–¹æ³•ã€‚ è°ƒç”¨æ ˆåŒ…å«äº† jdbc ç›¸å…³çš„åŒ…ã€‚å¾ˆå¯èƒ½å‘ç”Ÿäº†æ•°æ®åº“æ­»é”\n\n```java\n\"d&a-614\" daemon prio=6 tid=0x0000000022f1f000 nid=0x37c8 runnable\n[0x0000000027cbd000]\njava.lang.Thread.State: RUNNABLE\nat java.net.SocketInputStream.socketRead0(Native Method)\nat java.net.SocketInputStream.read(Unknown Source)\nat oracle.net.ns.Packet.receive(Packet.java:240)\nat oracle.net.ns.DataPacket.receive(DataPacket.java:92)\nat oracle.net.ns.NetInputStream.getNextPacket(NetInputStream.java:172)\nat oracle.net.ns.NetInputStream.read(NetInputStream.java:117)\nat oracle.jdbc.driver.T4CMAREngine.unmarshalUB1(T4CMAREngine.java:1034)\nat oracle.jdbc.driver.T4C8Oall.receive(T4C8Oall.java:588)\n```\n\n**åˆ†çº¿ç¨‹è°ƒåº¦çš„ä¼‘çœ **\n\næ­£å¸¸çš„çº¿ç¨‹æ± ç­‰å¾…\n\n```java\n\"d&a-131\" in Object.wait()\njava.lang.Thread.State: TIMED_WAITING (on object monitor)\nat java.lang.Object.wait(Native Method)\nat com.jiuqi.dna.core.impl.WorkingManager.getWorkToDo(WorkingManager.java:322)\n- locked <0x0000000313f656f8> (a com.jiuqi.dna.core.impl.WorkingThread)\nat com.jiuqi.dna.core.impl.WorkingThread.run(WorkingThread.java:40)\n```\n\nå¯ç–‘çš„çº¿ç¨‹ç­‰å¾…\n\n```java\n\"d&a-121\" in Object.wait()\njava.lang.Thread.State: WAITING (on object monitor)\nat java.lang.Object.wait(Native Method)\nat java.lang.Object.wait(Object.java:485)\nat com.jiuqi.dna.core.impl.AcquirableAccessor.exclusive()\n- locked <0x00000003011678d8> (a com.jiuqi.dna.core.impl.CacheGroup)\nat com.jiuqi.dna.core.impl.Transaction.lock()\n```\n\n### **å…¥æ‰‹ç‚¹æ€»ç»“**\n\n**wait on monitor entry**ï¼šÂ è¢«é˜»å¡çš„ï¼Œè‚¯å®šæœ‰é—®é¢˜\n\n**runnable**ï¼š æ³¨æ„ IO çº¿ç¨‹\n\n**in Object.wait()**ï¼š æ³¨æ„éçº¿ç¨‹æ± ç­‰å¾…\n\n## ä½¿ç”¨\n\næƒ³è¦å­¦ä¹ ä¸€ä¸ªå‘½ä»¤ï¼Œå…ˆæ¥çœ‹çœ‹å¸®åŠ©ï¼Œä½¿ç”¨ `jstack -help` æŸ¥çœ‹å¸®åŠ©ï¼š\n\n```java\npudding@DESKTOP-1QCHCU4:~$ jstack -help\nUsage:\n    jstack [-l] <pid>\n        (to connect to running process)\n    jstack -F [-m] [-l] <pid>\n        (to connect to a hung process)\n    jstack [-m] [-l] <executable> <core>\n        (to connect to a core file)\n    jstack [-m] [-l] [server_id@]<remote server IP or hostname>\n        (to connect to a remote debug server)\n\nOptions:\n    -F  to force a thread dump. Use when jstack <pid> does not respond (process is hung)\n    -m  to print both java and native frames (mixed mode)\n    -l  long listing. Prints additional information about locks\n    -h or -help to print this help message\n```\n\n- -Fï¼šå½“ â€™jstack [-l] pidâ€™ æ²¡æœ‰ç›¸åº”çš„æ—¶å€™å¼ºåˆ¶æ‰“å°æ ˆä¿¡æ¯\n- -lï¼šé•¿åˆ—è¡¨ã€‚æ‰“å°å…³äºé”çš„é™„åŠ ä¿¡æ¯ï¼Œä¾‹å¦‚å±äº java.util.concurrent çš„ ownable synchronizers åˆ—è¡¨\n- -mï¼šæ‰“å° java å’Œ native c/c++ æ¡†æ¶çš„æ‰€æœ‰æ ˆä¿¡æ¯\n- -hï¼š-help æ‰“å°å¸®åŠ©ä¿¡æ¯\n- pidï¼šéœ€è¦è¢«æ‰“å°é…ç½®ä¿¡æ¯çš„ java è¿›ç¨‹ idï¼Œå¯ä»¥ç”¨ jps æŸ¥è¯¢\n\né¦–å…ˆï¼Œæˆ‘ä»¬åˆ†æè¿™ä¹ˆä¸€æ®µç¨‹åºçš„çº¿ç¨‹æƒ…å†µï¼š\n\n```java\n/**\n * @author pudding\n */\n\npublic class JStackDemo1 {\n    public static void main(String[] args) {\n        while (true) {\n            //Do Nothing\n        }\n    }\n}\n```\n\nå…ˆæ˜¯æœ‰ jps æŸ¥çœ‹è¿›ç¨‹å·ï¼š\n\n```java\npudding@DESKTOP-1QCHCU4:/mnt/wsl$ jps\n929 org.eclipse.equinox.launcher_1.6.800.v20240513-1750.jar\n1477 sun.tools.jcmd.JCmd\n1499 Jps\n1372 JStackDemo1\n```\n\nç„¶åä½¿ç”¨ jstack æŸ¥çœ‹å †æ ˆä¿¡æ¯ï¼š\n\n```java\npudding@DESKTOP-1QCHCU4:/mnt/wsl$ jstack 1372\n2024-06-26 21:41:40\nFull thread dump OpenJDK 64-Bit Server VM (25.412-b08 mixed mode):\n...æ­¤å¤„çœç•¥è‹¥å¹²å†…å®¹...\n\"main\" #1 prio=5 os_prio=0 tid=0x00007fc86c00a800 nid=0x55d runnable [0x00007fc873672000]\n   java.lang.Thread.State: RUNNABLE\n        at JStackDemo1.main(JStackDemo1.java:7)\n```\n\næˆ‘ä»¬å¯ä»¥ä»è¿™æ®µå †æ ˆä¿¡æ¯ä¸­çœ‹å‡ºä»€ä¹ˆæ¥å‘¢ï¼Ÿæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œå½“å‰ä¸€å…±æœ‰ä¸€æ¡ç”¨æˆ·çº§åˆ«çº¿ç¨‹ï¼Œçº¿ç¨‹å¤„äº runnable çŠ¶æ€ï¼Œæ‰§è¡Œåˆ° [JStackDemo1.java](/img/2024-06-30-Jstack/http://JStackDemo1.java) çš„ç¬¬ä¸ƒè¡Œã€‚ çœ‹ä¸‹é¢ä»£ç ï¼š\n\n```java\n/**\n * @author pudding\n */\n\npublic class JStackDemo1 {\n    public static void main(String[] args) {\n        while (true) {\n            Thread thread = new Thread(new Thread1());\n            thread.start();\n        }\n    }\n}\n\nclass Thread1 implements Runnable{\n    @Override\n    public void run() {\n        while(true){\n            System.out.println(1);\n        }\n    }\n}\n```\n\nçº¿ç¨‹å †æ ˆä¿¡æ¯å¦‚ä¸‹ï¼š\n\n```java\n\"Reference Handler\" daemon prio=10 tid=0x00007fbbcc06e000 nid=0x286c in Object.wait() [0x00007fbbc8dfc000]\n   java.lang.Thread.State: WAITING (on object monitor)\n    at java.lang.Object.wait(Native Method)\n    - waiting on <0x0000000783e066e0> (a java.lang.ref.Reference$Lock)\n    at java.lang.Object.wait(Object.java:503)\n    at java.lang.ref.Reference$ReferenceHandler.run(Reference.java:133)\n    - locked <0x0000000783e066e0> (a java.lang.ref.Reference$Lock)\n```\n\næˆ‘ä»¬èƒ½çœ‹åˆ°ï¼š\n\n> çº¿ç¨‹çš„çŠ¶æ€ï¼š WAITING çº¿ç¨‹çš„è°ƒç”¨æ ˆ\nçº¿ç¨‹çš„å½“å‰é”ä½çš„èµ„æºï¼š <0x0000000783e066e0>\nçº¿ç¨‹å½“å‰ç­‰å¾…çš„èµ„æºï¼š<0x0000000783e066e0>\n> \n\nä¸ºä»€ä¹ˆåŒæ—¶é”ä½çš„ç­‰å¾…åŒä¸€ä¸ªèµ„æºï¼š\n\n> çº¿ç¨‹çš„æ‰§è¡Œä¸­ï¼Œå…ˆè·å¾—äº†è¿™ä¸ªå¯¹è±¡çš„ Monitorï¼ˆå¯¹åº”äº locked <0x0000000783e066e0>ï¼‰ã€‚å½“æ‰§è¡Œåˆ° obj.wait()ï¼Œçº¿ç¨‹å³æ”¾å¼ƒäº† Monitor çš„æ‰€æœ‰æƒï¼Œè¿›å…¥ â€œwait setâ€ é˜Ÿåˆ—ï¼ˆå¯¹åº”äº waiting on <0x0000000783e066e0> ï¼‰ã€‚\n> \n\n### **æ­»é”åˆ†æ**\n\nå­¦ä¼šäº†æ€ä¹ˆä½¿ç”¨ jstack å‘½ä»¤ä¹‹åï¼Œæˆ‘ä»¬å°±å¯ä»¥çœ‹çœ‹ï¼Œå¦‚ä½•ä½¿ç”¨ jstack åˆ†ææ­»é”äº†ï¼Œè¿™ä¹Ÿæ˜¯æˆ‘ä»¬ä¸€å®šè¦æŒæ¡çš„å†…å®¹ã€‚Â **å•¥å«æ­»é”ï¼Ÿ**Â æ‰€è°“[æ­»é”](/img/2024-06-30-Jstack/http://zh.wikipedia.org/wiki/%E6%AD%BB%E9%94%81)ï¼š æ˜¯æŒ‡ä¸¤ä¸ªæˆ–ä¸¤ä¸ªä»¥ä¸Šçš„è¿›ç¨‹åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œç”±äºç«äº‰èµ„æºæˆ–è€…ç”±äºå½¼æ­¤é€šä¿¡è€Œé€ æˆçš„ä¸€ç§é˜»å¡çš„ç°è±¡ï¼Œè‹¥æ— å¤–åŠ›ä½œç”¨ï¼Œå®ƒä»¬éƒ½å°†æ— æ³•æ¨è¿›ä¸‹å»ã€‚æ­¤æ—¶ç§°ç³»ç»Ÿå¤„äºæ­»é”çŠ¶æ€æˆ–ç³»ç»Ÿäº§ç”Ÿäº†æ­»é”ï¼Œè¿™äº›æ°¸è¿œåœ¨äº’ç›¸ç­‰å¾…çš„è¿›ç¨‹ç§°ä¸ºæ­»é”è¿›ç¨‹ã€‚ \n\nè¯´ç™½äº†ï¼Œæˆ‘ç°åœ¨æƒ³åƒé¸¡è›‹çŒé¥¼ï¼Œæ¡Œå­ä¸Šæ”¾ç€é¸¡è›‹å’Œé¥¼ï¼Œä½†æ˜¯æˆ‘å’Œæˆ‘çš„æœ‹å‹åŒæ—¶åˆ†åˆ«æ‹¿èµ·äº†é¸¡è›‹å’Œç—…ï¼Œæˆ‘æ‰‹é‡Œæ‹¿ç€é¸¡è›‹ï¼Œä½†æ˜¯æˆ‘éœ€è¦ä»–æ‰‹é‡Œçš„é¥¼ã€‚ä»–æ‰‹é‡Œæ‹¿ç€é¥¼ï¼Œä½†æ˜¯ä»–æƒ³è¦æˆ‘æ‰‹é‡Œçš„é¸¡è›‹ã€‚å°±è¿™æ ·ï¼Œå¦‚æœä¸èƒ½åŒæ—¶æ‹¿åˆ°é¸¡è›‹å’Œé¥¼ï¼Œé‚£æˆ‘ä»¬å°±ä¸èƒ½ç»§ç»­åšåé¢çš„å·¥ä½œï¼ˆåšé¸¡è›‹çŒé¥¼ï¼‰ã€‚æ‰€ä»¥ï¼Œè¿™å°±é€ æˆäº†æ­»é”ã€‚Â **çœ‹ä¸€æ®µæ­»é”çš„ç¨‹åºï¼š**\n\n```java\n/**\n * @author pudding\n */\n\npublic class JStackDemo {\n    public static void main(String[] args) {\n        Thread t1 = new Thread(new DeadLockclass(true));\n        Thread t2 = new Thread(new DeadLockclass(false));\n        t1.start();\n        t2.start();\n    }\n}\nclass DeadLockclass implements Runnable {\n    public boolean falg;\n    DeadLockclass(boolean falg) {\n        this.falg = falg;\n    }\n    public void run() {\n        /**\n         * å¦‚æœfalgçš„å€¼ä¸ºtrueåˆ™è°ƒç”¨t1çº¿ç¨‹\n         */\n        if (falg) {\n            while (true) {\n                synchronized (Suo.o1) {\n                    System.out.println(\"o1 \" + Thread.currentThread().getName());\n                    synchronized (Suo.o2) {\n                        System.out.println(\"o2 \" + Thread.currentThread().getName());\n                    }\n                }\n            }\n        }\n        /**\n         * å¦‚æœfalgçš„å€¼ä¸ºfalseåˆ™è°ƒç”¨t2çº¿ç¨‹\n         */\n        else {\n            while (true) {\n                synchronized (Suo.o2) {\n                    System.out.println(\"o2 \" + Thread.currentThread().getName());\n                    synchronized (Suo.o1) {\n                        System.out.println(\"o1 \" + Thread.currentThread().getName());\n                    }\n                }\n            }\n        }\n    }\n}\n\nclass Suo {\n    static Object o1 = new Object();\n    static Object o2 = new Object();\n}\n```\n\nå½“æˆ‘å¯åŠ¨è¯¥ç¨‹åºæ—¶ï¼Œæˆ‘ä»¬çœ‹ä¸€ä¸‹æ§åˆ¶å°ï¼š\n\n![æ§åˆ¶å°](/img/2024-06-30-Jstack/Untitled1.png)\n\næˆ‘ä»¬å‘ç°ï¼Œç¨‹åºåªè¾“å‡ºäº†ä¸¤è¡Œå†…å®¹ï¼Œç„¶åç¨‹åºå°±ä¸å†æ‰“å°å…¶å®ƒçš„ä¸œè¥¿äº†ï¼Œä½†æ˜¯ç¨‹åºå¹¶æ²¡æœ‰åœæ­¢ã€‚è¿™æ ·å°±äº§ç”Ÿäº†æ­»é”ã€‚ å½“çº¿ç¨‹ 1 ä½¿ç”¨ `synchronized` é”ä½äº† o1 çš„åŒæ—¶ï¼Œçº¿ç¨‹ 2 ä¹Ÿæ˜¯ç”¨ `synchronized` é”ä½äº† o2ã€‚å½“ä¸¤ä¸ªçº¿ç¨‹éƒ½æ‰§è¡Œå®Œç¬¬ä¸€ä¸ªæ‰“å°ä»»åŠ¡çš„æ—¶å€™ï¼Œçº¿ç¨‹ 1 æƒ³é”ä½ o2ï¼Œçº¿ç¨‹ 2 æƒ³é”ä½ o1ã€‚ä½†æ˜¯ï¼Œçº¿ç¨‹ 1 å½“å‰é”ç€ o1ï¼Œçº¿ç¨‹ 2 é”ç€ o2ã€‚æ‰€ä»¥ä¸¤ä¸ªæƒ³æˆéƒ½æ— æ³•ç»§ç»­æ‰§è¡Œä¸‹å»ï¼Œå°±é€ æˆäº†æ­»é”ã€‚\nç„¶åï¼Œæˆ‘ä»¬ä½¿ç”¨ **jstack æ¥çœ‹ä¸€ä¸‹çº¿ç¨‹å †æ ˆä¿¡æ¯**ï¼š\n\n```java\nFound one Java-level deadlock:\n=============================\n\"Thread-1\":\n  waiting to lock monitor 0x00007f6274003ac8 (object 0x000000077e004ec0, a java.lang.Object),\n  which is held by \"Thread-0\"\n\"Thread-0\":\n  waiting to lock monitor 0x00007f62740050c8 (object 0x000000077e004ed0, a java.lang.Object),\n  which is held by \"Thread-1\"\n\nJava stack information for the threads listed above:\n===================================================\n\"Thread-1\":\n        at DeadLockclass.run(JStackDemo.java:40)\n        - waiting to lock <0x000000077e004ec0> (a java.lang.Object)\n        - locked <0x000000077e004ed0> (a java.lang.Object)\n        at java.lang.Thread.run(Thread.java:750)\n\"Thread-0\":\n        at DeadLockclass.run(JStackDemo.java:27)\n        - waiting to lock <0x000000077e004ed0> (a java.lang.Object)\n        - locked <0x000000077e004ec0> (a java.lang.Object)\n        at java.lang.Thread.run(Thread.java:750)\n\nFound 1 deadlock.\n```\n\nå“ˆå“ˆï¼Œå †æ ˆå†™çš„å¾ˆæ˜æ˜¾ï¼Œå®ƒå‘Šè¯‰æˆ‘ä»¬Â `Found one Java-level deadlock`ï¼Œç„¶åæŒ‡å‡ºé€ æˆæ­»é”çš„ä¸¤ä¸ªçº¿ç¨‹çš„å†…å®¹ã€‚ç„¶åï¼Œåˆé€šè¿‡Â `Java stack information for the threads listed above`æ¥æ˜¾ç¤ºæ›´è¯¦ç»†çš„æ­»é”çš„ä¿¡æ¯ã€‚ ä»–è¯´\n\n> Thread-1 åœ¨æƒ³è¦æ‰§è¡Œç¬¬ 40 è¡Œçš„æ—¶å€™ï¼Œå½“å‰é”ä½äº†èµ„æº `<0x00000007d6aa2ca8>`ï¼Œä½†æ˜¯ä»–åœ¨ç­‰å¾…èµ„æº `<0x00000007d6aa2c98>`Â ï¼›\nThread-0 åœ¨æƒ³è¦æ‰§è¡Œç¬¬ 27 è¡Œçš„æ—¶å€™ï¼Œå½“å‰é”ä½äº†èµ„æº `<0x00000007d6aa2c98>`ï¼Œä½†æ˜¯ä»–åœ¨ç­‰å¾…èµ„æº`<0x00000007d6aa2ca8>`Â ï¼›\nç”±äºè¿™ä¸¤ä¸ªçº¿ç¨‹éƒ½æŒæœ‰èµ„æºï¼Œå¹¶ä¸”éƒ½éœ€è¦å¯¹æ–¹çš„èµ„æºï¼Œæ‰€ä»¥é€ æˆäº†æ­»é”ã€‚ åŸå› æˆ‘ä»¬æ‰¾åˆ°äº†ï¼Œå°±å¯ä»¥å…·ä½“é—®é¢˜å…·ä½“åˆ†æï¼Œè§£å†³è¿™ä¸ªæ­»é”äº†ã€‚\n> \n\n### **å…¶ä»–**\n\n**è™šæ‹Ÿæœºæ‰§è¡Œ Full GC æ—¶ï¼Œä¼šé˜»å¡æ‰€æœ‰çš„ç”¨æˆ·çº¿ç¨‹ã€‚å› æ­¤ï¼Œå³æ—¶è·å–åˆ°åŒæ­¥é”çš„çº¿ç¨‹ä¹Ÿæœ‰å¯èƒ½è¢«é˜»å¡ã€‚**Â åœ¨æŸ¥çœ‹çº¿ç¨‹ Dump æ—¶ï¼Œé¦–å…ˆæŸ¥çœ‹å†…å­˜ä½¿ç”¨æƒ…å†µ","tags":["æ€§èƒ½æµ‹è¯•","Java"]},{"title":"Javaå‘½ä»¤å­¦ä¹ ç³»åˆ—â€”Jstat","url":"/2024/06/30/2024-06-30-Javaå‘½ä»¤å­¦ä¹ ç³»åˆ—â€”Jstat/","content":"\n> jstat (JVM Statistics Monitoring Tool) ç”¨äºç›‘æ§è™šæ‹Ÿæœºå„ç§è¿è¡ŒçŠ¶æ€ä¿¡æ¯çš„å‘½ä»¤è¡Œå·¥å…·ã€‚å®ƒå¯ä»¥æ˜¾ç¤ºæœ¬åœ°æˆ–è¿œç¨‹è™šæ‹Ÿæœºè¿›ç¨‹ä¸­ç±»åŠ è½½ã€å†…å­˜ã€åƒåœ¾æ”¶é›†ã€JIT ç¼–è¯‘ç­‰è¿è¡Œæ•°æ®ï¼Œå†æ²¡æœ‰ GUI å›¾å½¢çš„æœåŠ¡å™¨ä¸Šï¼Œå®ƒæ˜¯è¿è¡ŒæœŸé—´å®šä½è™šæ‹Ÿæœºæ€§èƒ½é—®é¢˜é¦–é€‰å·¥å…·ã€‚\n> \n\njstat ä½äº java çš„ bin ç›®å½•ä¸‹ï¼Œä¸»è¦åˆ©ç”¨ JVM å†…å»ºçš„æŒ‡ä»¤å¯¹ Java åº”ç”¨ç¨‹åºçš„èµ„æºå’Œæ€§èƒ½è¿›è¡Œå®æ–½çš„å‘½ä»¤è¡Œçš„ç›‘æ§ï¼ŒåŒ…æ‹¬äº†å¯¹ Heap size å’Œåƒåœ¾å›æ”¶çŠ¶å†µçš„ç›‘æ§ã€‚å¯è§ï¼ŒJstat æ˜¯è½»é‡çº§çš„ã€ä¸“é—¨é’ˆå¯¹ JVM çš„å·¥å…·ï¼Œéå¸¸é€‚ç”¨ã€‚\n\n## jstat å‘½ä»¤æ ¼å¼\n\n```bash\njstat -<option> [-t] [-h<lines>] <vmid> [<interval> [<count>]]\n```\n\n### **å‚æ•°è§£é‡Šï¼š**\n\n- Option â€” é€‰é¡¹ï¼Œæˆ‘ä»¬ä¸€èˆ¬ä½¿ç”¨ -gcutil æŸ¥çœ‹ gc æƒ…å†µ\n- vmid â€” VMçš„è¿›ç¨‹å·ï¼Œå³å½“å‰è¿è¡Œçš„javaè¿›ç¨‹å·\n- intervalâ€“ é—´éš”æ—¶é—´ï¼Œå•ä½ä¸ºç§’æˆ–è€…æ¯«ç§’\n- count â€” æ‰“å°æ¬¡æ•°ï¼Œå¦‚æœç¼ºçœåˆ™æ‰“å°æ— æ•°æ¬¡\n- å‚æ•° interval å’Œ count ä»£è¡¨æŸ¥è¯¢é—´éš”å’Œæ¬¡æ•°ï¼Œå¦‚æœçœç•¥è¿™ä¸¤ä¸ªå‚æ•°ï¼Œè¯´æ˜åªæŸ¥è¯¢ä¸€æ¬¡ã€‚å‡è®¾éœ€è¦æ¯ 250 æ¯«ç§’æŸ¥è¯¢ä¸€æ¬¡è¿›ç¨‹ 5828 åƒåœ¾æ”¶é›†çŠ¶å†µï¼Œä¸€å…±æŸ¥è¯¢ 5 æ¬¡ï¼Œé‚£å‘½ä»¤è¡Œå¦‚ä¸‹ï¼š\n    \n    ```bash\n    jstat -gc 5828 250 5\n    ```\n    \n\n```bash\nå¯¹äºå‘½ä»¤æ ¼å¼ä¸­çš„ VMID ä¸ LVMID éœ€è¦ç‰¹åˆ«è¯´æ˜ä¸‹ï¼š\nå¦‚æœæ˜¯æœ¬åœ°è™šæ‹Ÿæœºè¿›ç¨‹ï¼ŒVMID(Virtual Machine IDentifier,è™šæœºæ ‡è¯†ç¬¦) å’Œ LVMID(Local Virtual Machine IDentifierï¼Œè™šæœºæ ‡è¯†ç¬¦) æ˜¯ä¸€è‡´çš„ï¼›\nå¦‚æœæ˜¯è¿œç¨‹è™šæ‹Ÿæœºè¿›ç¨‹ï¼Œé‚£ VMID çš„æ ¼å¼åº”å½“æ˜¯ï¼š[protocol:][//] lvmid [@hostname[:port]/servername]\n```\n\n### **option**\n\né€‰é¡¹ option ä»£è¡¨è¿™ç”¨æˆ·å¸Œæœ›æŸ¥è¯¢çš„è™šæ‹Ÿæœºä¿¡æ¯ï¼Œä¸»è¦åˆ†ä¸º 3 ç±»ï¼šç±»è£…è½½ã€åƒåœ¾æ”¶é›†å’Œè¿è¡ŒæœŸç¼–è¯‘çŠ¶å†µï¼Œå…·ä½“é€‰é¡¹åŠä½œç”¨å¦‚ä¸‹ï¼š\n\n- `class`Â ç›‘è§†ç±»è£…è½½ã€å¸è½½æ•°é‡ã€æ€»ç©ºé—´åŠç±»è£…è½½æ‰€è€—è´¹çš„æ—¶é—´\n- `gc`Â ç›‘è§† Java å †çŠ¶å†µï¼ŒåŒ…æ‹¬ Eden åŒºã€2 ä¸ªSurvivoråŒºã€è€å¹´ä»£ã€æ°¸ä¹…ä»£ç­‰çš„å®¹é‡\n- `gccapacity`Â ç›‘è§†å†…å®¹ä¸ -gc åŸºæœ¬ç›¸åŒï¼Œä½†è¾“å‡ºä¸»è¦å…³æ³¨ Java å †å„ä¸ªåŒºåŸŸä½¿ç”¨åˆ°çš„æœ€å¤§å’Œæœ€å°ç©ºé—´\n- `gcutil`Â ç›‘è§†å†…å®¹ä¸ -gc åŸºæœ¬ç›¸åŒï¼Œä½†è¾“å‡ºä¸»è¦å…³æ³¨å·²ä½¿ç”¨ç©ºé—´å æ€»ç©ºé—´çš„ç™¾åˆ†æ¯”\n- `gccause`Â ä¸ -gcutil åŠŸèƒ½ä¸€æ ·ï¼Œä½†æ˜¯ä¼šé¢å¤–è¾“å‡ºå¯¼è‡´ä¸Šä¸€æ¬¡ GC äº§ç”Ÿçš„åŸå› \n- `gcnew`Â ç›‘è§†æ–°ç”Ÿä»£ GC çš„çŠ¶å†µ\n- `gcnewcapacity`ç›‘è§†å†…å®¹ä¸ -gcnew åŸºæœ¬ç›¸åŒï¼Œè¾“å‡ºä¸»è¦å…³æ³¨ä½¿ç”¨åˆ°çš„æœ€å¤§å’Œæœ€å°ç©ºé—´\n- `gcold`Â ç›‘è§†è€å¹´ä»£ GC çš„çŠ¶å†µ\n- `gcoldcapacity`Â ç›‘è§†å†…å®¹ä¸ -gcold åŸºæœ¬ç›¸åŒï¼Œè¾“å‡ºä¸»è¦å…³æ³¨ä½¿ç”¨åˆ°çš„æœ€å¤§å’Œæœ€å°ç©ºé—´\n- `gcpermcapacity`Â è¾“å‡ºæ°¸ä¹…ä»£ä½¿ç”¨åˆ°çš„æœ€å¤§å’Œæœ€å°ç©ºé—´\n- `compiler`Â è¾“å‡º JIT ç¼–è¯‘å™¨ç¼–è¯‘è¿‡çš„æ–¹æ³•ã€è€—æ—¶ç­‰ä¿¡æ¯\n- `printcompilation`Â è¾“å‡ºå·²ç»è¢« JIT ç¼–è¯‘çš„æ–¹æ³•\n\n## **å¸¸è§æœ¯è¯­**\n\n**1ã€`jstat â€“class<pid> :`Â æ˜¾ç¤ºåŠ è½½ class çš„æ•°é‡ï¼ŒåŠæ‰€å ç©ºé—´ç­‰ä¿¡æ¯ã€‚**\n\n> `Loaded` è£…è½½çš„ç±»çš„æ•°é‡\n`Bytes`Â è£…è½½ç±»æ‰€å ç”¨çš„å­—èŠ‚æ•°Â \n`Unloaded`Â å¸è½½ç±»çš„æ•°é‡Â \n`Bytes` å¸è½½ç±»çš„å­—èŠ‚æ•°Â \n`Time` è£…è½½å’Œå¸è½½ç±»æ‰€èŠ±è´¹çš„æ—¶é—´\n> \n\n**2ã€`jstat -compiler <pid>`æ˜¾ç¤º VM å®æ—¶ç¼–è¯‘çš„æ•°é‡ç­‰ä¿¡æ¯ã€‚**\n\n> `Compiled`Â ç¼–è¯‘ä»»åŠ¡æ‰§è¡Œæ•°é‡Â \n`Failed` ç¼–è¯‘ä»»åŠ¡æ‰§è¡Œå¤±è´¥æ•°é‡Â \n`Invalid` ç¼–è¯‘ä»»åŠ¡æ‰§è¡Œå¤±æ•ˆæ•°é‡Â \n`Time` ç¼–è¯‘ä»»åŠ¡æ¶ˆè€—æ—¶é—´Â \n`FailedType` æœ€åä¸€ä¸ªç¼–è¯‘å¤±è´¥ä»»åŠ¡çš„ç±»å‹Â \n`FailedMethod` æœ€åä¸€ä¸ªç¼–è¯‘å¤±è´¥ä»»åŠ¡æ‰€åœ¨çš„ç±»åŠæ–¹æ³•\n> \n\n**3ã€`jstat -gc <pid>`: å¯ä»¥æ˜¾ç¤º gc çš„ä¿¡æ¯ï¼ŒæŸ¥çœ‹ gc çš„æ¬¡æ•°ï¼ŒåŠæ—¶é—´ã€‚**\n\n> `S0C` å¹´è½»ä»£ä¸­ç¬¬ä¸€ä¸ª survivorï¼ˆå¹¸å­˜åŒºï¼‰çš„å®¹é‡ ï¼ˆå­—èŠ‚ï¼‰\n`S1C` å¹´è½»ä»£ä¸­ç¬¬äºŒä¸ª survivorï¼ˆå¹¸å­˜åŒºï¼‰çš„å®¹é‡ ï¼ˆå­—èŠ‚ï¼‰\n`S0U` å¹´è½»ä»£ä¸­ç¬¬ä¸€ä¸ª survivorï¼ˆå¹¸å­˜åŒºï¼‰ç›®å‰å·²ä½¿ç”¨ç©ºé—´ï¼ˆå­—èŠ‚ï¼‰\n`S1U` å¹´è½»ä»£ä¸­ç¬¬äºŒä¸ª survivorï¼ˆå¹¸å­˜åŒºï¼‰ç›®å‰å·²ä½¿ç”¨ç©ºé—´ï¼ˆå­—èŠ‚ï¼‰\n`EC` å¹´è½»ä»£ä¸­ Edenï¼ˆä¼Šç”¸å›­ï¼‰çš„å®¹é‡ï¼ˆå­—èŠ‚ï¼‰\n`EU` å¹´è½»ä»£ä¸­ Edenï¼ˆä¼Šç”¸å›­ï¼‰ç›®å‰å·²ä½¿ç”¨ç©ºé—´ï¼ˆå­—èŠ‚ï¼‰\n`OC` Old ä»£çš„å®¹é‡ï¼ˆå­—èŠ‚ï¼‰\n`OU` Old ä»£ç›®å‰å·²ä½¿ç”¨ç©ºé—´ï¼ˆå­—èŠ‚ï¼‰\n`PC` Permï¼ˆæŒä¹…ä»£ï¼‰çš„å®¹é‡ï¼ˆå­—èŠ‚ï¼‰Â \n`PU` Permï¼ˆæŒä¹…ä»£ï¼‰ç›®å‰å·²ä½¿ç”¨ç©ºé—´ï¼ˆå­—èŠ‚ï¼‰\n`YGC` ä»åº”ç”¨ç¨‹åºå¯åŠ¨åˆ°é‡‡æ ·æ—¶å¹´è½»ä»£ä¸­ gc æ¬¡æ•°\n`YGCT` ä»åº”ç”¨ç¨‹åºå¯åŠ¨åˆ°é‡‡æ ·æ—¶å¹´è½»ä»£ä¸­ gc æ‰€ç”¨æ—¶é—´ï¼ˆsï¼‰\n`FGC` ä»åº”ç”¨ç¨‹åºå¯åŠ¨åˆ°é‡‡æ ·æ—¶ old ä»£ï¼ˆå…¨ gcï¼‰gc æ¬¡æ•°\n`FGCT` ä»åº”ç”¨ç¨‹åºå¯åŠ¨åˆ°é‡‡æ ·æ—¶ old ä»£ï¼ˆå…¨ gcï¼‰gc æ‰€ç”¨æ—¶é—´ï¼ˆsï¼‰\n`GCT` ä»åº”ç”¨ç¨‹åºå¯åŠ¨åˆ°é‡‡æ ·æ—¶ gc ç”¨çš„æ€»æ—¶é—´ï¼ˆsï¼‰\n> \n\n**4ã€`jstat -gccapacity <pid>:`å¯ä»¥æ˜¾ç¤ºï¼ŒVMå†…å­˜ä¸­ä¸‰ä»£ï¼ˆyoung,old,permï¼‰å¯¹è±¡çš„ä½¿ç”¨å’Œå ç”¨å¤§å°**\n\n> `NGCMN`Â å¹´è½»ä»£ï¼ˆyoungï¼‰ä¸­åˆå§‹åŒ–ï¼ˆæœ€å°ï¼‰çš„å¤§å°ï¼ˆå­—èŠ‚ï¼‰Â \n`NGCMX`Â å¹´è½»ä»£ï¼ˆyoungï¼‰çš„æœ€å¤§å®¹é‡ï¼ˆå­—èŠ‚ï¼‰\n`NGC`Â å¹´è½»ä»£ï¼ˆyoungï¼‰ä¸­å½“å‰çš„å®¹é‡ï¼ˆå­—èŠ‚ï¼‰\n`S0C`Â å¹´è½»ä»£ä¸­ç¬¬ä¸€ä¸ª survivorï¼ˆå¹¸å­˜åŒºï¼‰çš„å®¹é‡ï¼ˆå­—èŠ‚ï¼‰Â \n`S1C`Â å¹´è½»ä»£ä¸­ç¬¬äºŒä¸ª survivorï¼ˆå¹¸å­˜åŒºï¼‰çš„å®¹é‡ï¼ˆå­—èŠ‚ï¼‰Â \n`EC`Â å¹´è½»ä»£ä¸­ Edenï¼ˆä¼Šç”¸å›­ï¼‰çš„å®¹é‡ï¼ˆå­—èŠ‚ï¼‰Â \n`OGCMN`Â old ä»£ä¸­åˆå§‹åŒ–ï¼ˆæœ€å°ï¼‰çš„å¤§å°ï¼ˆå­—èŠ‚ï¼‰\n`OGCMX`Â old ä»£çš„æœ€å¤§å®¹é‡ï¼ˆå­—èŠ‚ï¼‰\n`OGC`Â oldä»£å½“å‰æ–°ç”Ÿæˆçš„å®¹é‡ï¼ˆå­—èŠ‚ï¼‰\n`OC`Â Oldä»£çš„å®¹é‡ ï¼ˆå­—èŠ‚ï¼‰Â \n`PGCMN`Â perm ä»£ä¸­åˆå§‹åŒ–ï¼ˆæœ€å°ï¼‰çš„å¤§å° ï¼ˆå­—èŠ‚ï¼‰Â \n`PGCMX`Â perm ä»£çš„æœ€å¤§å®¹é‡ï¼ˆå­—èŠ‚ï¼‰\n`PGC`Â perm ä»£å½“å‰æ–°ç”Ÿæˆçš„å®¹é‡ï¼ˆå­—èŠ‚ï¼‰Â \n`PC`Â Permï¼ˆæŒä¹…ä»£ï¼‰çš„å®¹é‡ï¼ˆå­—èŠ‚ï¼‰Â \n`YGC`Â ä»åº”ç”¨ç¨‹åºå¯åŠ¨åˆ°é‡‡æ ·æ—¶å¹´è½»ä»£ä¸­ gc æ¬¡æ•°Â \n`FGC`Â ä»åº”ç”¨ç¨‹åºå¯åŠ¨åˆ°é‡‡æ ·æ—¶ old ä»£ï¼ˆå…¨gcï¼‰gc æ¬¡æ•°\n> \n\n**5ã€`jstat -gcutil <pid>`:ç»Ÿè®¡gcä¿¡æ¯**\n\n> `S0` å¹´è½»ä»£ä¸­ç¬¬ä¸€ä¸ª survivorï¼ˆå¹¸å­˜åŒºï¼‰å·²ä½¿ç”¨çš„å å½“å‰å®¹é‡ç™¾åˆ†æ¯”\n`S1` å¹´è½»ä»£ä¸­ç¬¬äºŒä¸ª survivorï¼ˆå¹¸å­˜åŒºï¼‰å·²ä½¿ç”¨çš„å å½“å‰å®¹é‡ç™¾åˆ†æ¯”\n`E` å¹´è½»ä»£ä¸­ Edenï¼ˆä¼Šç”¸å›­ï¼‰å·²ä½¿ç”¨çš„å å½“å‰å®¹é‡ç™¾åˆ†æ¯”\n`O` old ä»£å·²ä½¿ç”¨çš„å å½“å‰å®¹é‡ç™¾åˆ†æ¯”Â \n`P` perm ä»£å·²ä½¿ç”¨çš„å å½“å‰å®¹é‡ç™¾åˆ†æ¯”Â \n`YGC` ä»åº”ç”¨ç¨‹åºå¯åŠ¨åˆ°é‡‡æ ·æ—¶å¹´è½»ä»£ä¸­ gc æ¬¡æ•°Â \n`YGCT` ä»åº”ç”¨ç¨‹åºå¯åŠ¨åˆ°é‡‡æ ·æ—¶å¹´è½»ä»£ä¸­ gc æ‰€ç”¨æ—¶é—´ï¼ˆsï¼‰\n`FGC` ä»åº”ç”¨ç¨‹åºå¯åŠ¨åˆ°é‡‡æ ·æ—¶ old ä»£ï¼ˆå…¨ gcï¼‰gc æ¬¡æ•°Â \n`FGCT` ä»åº”ç”¨ç¨‹åºå¯åŠ¨åˆ°é‡‡æ ·æ—¶ old ä»£ï¼ˆå…¨ gcï¼‰gc æ‰€ç”¨æ—¶é—´ï¼ˆsï¼‰Â \n`GCT`Â ä»åº”ç”¨ç¨‹åºå¯åŠ¨åˆ°é‡‡æ ·æ—¶ gc ç”¨çš„æ€»æ—¶é—´ï¼ˆsï¼‰\n> \n\n**6ã€`jstat -gcnew <pid>`:å¹´è½»ä»£å¯¹è±¡çš„ä¿¡æ¯ã€‚**\n\n> `S0C`Â å¹´è½»ä»£ä¸­ç¬¬ä¸€ä¸ªsurvivorï¼ˆå¹¸å­˜åŒºï¼‰çš„å®¹é‡ï¼ˆå­—èŠ‚ï¼‰\n`S1C` å¹´è½»ä»£ä¸­ç¬¬äºŒä¸ªsurvivorï¼ˆå¹¸å­˜åŒºï¼‰çš„å®¹é‡ï¼ˆå­—èŠ‚ï¼‰\n`S0U` å¹´è½»ä»£ä¸­ç¬¬ä¸€ä¸ªsurvivorï¼ˆå¹¸å­˜åŒºï¼‰ç›®å‰å·²ä½¿ç”¨ç©ºé—´ï¼ˆå­—èŠ‚ï¼‰\n`S1U` å¹´è½»ä»£ä¸­ç¬¬äºŒä¸ªsurvivorï¼ˆå¹¸å­˜åŒºï¼‰ç›®å‰å·²ä½¿ç”¨ç©ºé—´ï¼ˆå­—èŠ‚ï¼‰\n`TT` æŒæœ‰æ¬¡æ•°é™åˆ¶\n`MTT` æœ€å¤§æŒæœ‰æ¬¡æ•°é™åˆ¶\n`EC` å¹´è½»ä»£ä¸­ Edenï¼ˆä¼Šç”¸å›­ï¼‰çš„å®¹é‡ï¼ˆå­—èŠ‚ï¼‰\n`EU` å¹´è½»ä»£ä¸­ Edenï¼ˆä¼Šç”¸å›­ï¼‰ç›®å‰å·²ä½¿ç”¨ç©ºé—´ï¼ˆå­—èŠ‚ï¼‰\n`YGC` ä»åº”ç”¨ç¨‹åºå¯åŠ¨åˆ°é‡‡æ ·æ—¶å¹´è½»ä»£ä¸­ gc æ¬¡æ•°\n`YGCT` ä»åº”ç”¨ç¨‹åºå¯åŠ¨åˆ°é‡‡æ ·æ—¶å¹´è½»ä»£ä¸­ gc æ‰€ç”¨æ—¶é—´ï¼ˆsï¼‰\n> \n\n**7ã€`jstat -gcnewcapacity<pid>`: å¹´è½»ä»£å¯¹è±¡çš„ä¿¡æ¯åŠå…¶å ç”¨é‡ã€‚**\n\n> `NGCMN`Â å¹´è½»ä»£ï¼ˆyoungï¼‰ä¸­åˆå§‹åŒ–ï¼ˆæœ€å°ï¼‰çš„å¤§å°ï¼ˆå­—èŠ‚ï¼‰\n`NGCMX`Â å¹´è½»ä»£ï¼ˆyoungï¼‰çš„æœ€å¤§å®¹é‡ï¼ˆå­—èŠ‚ï¼‰\n`NGC`Â å¹´è½»ä»£ï¼ˆyoungï¼‰ä¸­å½“å‰çš„å®¹é‡ï¼ˆå­—èŠ‚ï¼‰\n`S0CMX`Â å¹´è½»ä»£ä¸­ç¬¬ä¸€ä¸ª survivorï¼ˆå¹¸å­˜åŒºï¼‰çš„æœ€å¤§å®¹é‡ï¼ˆå­—èŠ‚ï¼‰\n`S0C`Â å¹´è½»ä»£ä¸­ç¬¬ä¸€ä¸ª survivorï¼ˆå¹¸å­˜åŒºï¼‰çš„å®¹é‡ï¼ˆå­—èŠ‚ï¼‰\n`S1CMX`Â å¹´è½»ä»£ä¸­ç¬¬äºŒä¸ª survivorï¼ˆå¹¸å­˜åŒºï¼‰çš„æœ€å¤§å®¹é‡ï¼ˆå­—èŠ‚ï¼‰\n`S1C`Â å¹´è½»ä»£ä¸­ç¬¬äºŒä¸ª survivorï¼ˆå¹¸å­˜åŒºï¼‰çš„å®¹é‡ï¼ˆå­—èŠ‚ï¼‰\n`ECMX`Â å¹´è½»ä»£ä¸­ Edenï¼ˆä¼Šç”¸å›­ï¼‰çš„æœ€å¤§å®¹é‡ï¼ˆå­—èŠ‚ï¼‰\n`EC`Â å¹´è½»ä»£ä¸­ Edenï¼ˆä¼Šç”¸å›­ï¼‰çš„å®¹é‡ï¼ˆå­—èŠ‚ï¼‰\n`YGC`Â ä»åº”ç”¨ç¨‹åºå¯åŠ¨åˆ°é‡‡æ ·æ—¶å¹´è½»ä»£ä¸­ gc æ¬¡æ•°\n`FGC`Â ä»åº”ç”¨ç¨‹åºå¯åŠ¨åˆ°é‡‡æ ·æ—¶ old ä»£ï¼ˆå…¨ gcï¼‰gc æ¬¡æ•°\n> \n\n**8ã€`jstat -gcold <pid>ï¼š`oldä»£å¯¹è±¡çš„ä¿¡æ¯ã€‚**\n\n> `PC`Â Permï¼ˆæŒä¹…ä»£ï¼‰çš„å®¹é‡ ï¼ˆå­—èŠ‚ï¼‰Â \n`PU`Â Permï¼ˆæŒä¹…ä»£ï¼‰ç›®å‰å·²ä½¿ç”¨ç©ºé—´ ï¼ˆå­—èŠ‚ï¼‰Â \n`OC`Â Oldä»£çš„å®¹é‡ ï¼ˆå­—èŠ‚ï¼‰Â OUÂ Old ä»£ç›®å‰å·²ä½¿ç”¨ç©ºé—´ ï¼ˆå­—èŠ‚ï¼‰Â \n`YGC`Â ä»åº”ç”¨ç¨‹åºå¯åŠ¨åˆ°é‡‡æ ·æ—¶å¹´è½»ä»£ä¸­ gc æ¬¡æ•°Â \n`FGC`Â ä»åº”ç”¨ç¨‹åºå¯åŠ¨åˆ°é‡‡æ ·æ—¶ old ä»£ï¼ˆå…¨gcï¼‰gc æ¬¡æ•°Â \n`FGCT`Â ä»åº”ç”¨ç¨‹åºå¯åŠ¨åˆ°é‡‡æ ·æ—¶ old ä»£ï¼ˆå…¨gcï¼‰gc æ‰€ç”¨æ—¶é—´ï¼ˆsï¼‰Â \n`GCT`Â ä»åº”ç”¨ç¨‹åºå¯åŠ¨åˆ°é‡‡æ ·æ—¶ gc ç”¨çš„æ€»æ—¶é—´ï¼ˆsï¼‰\n> \n\n**9ã€`stat -gcoldcapacity <pid>`: oldä»£å¯¹è±¡çš„ä¿¡æ¯åŠå…¶å ç”¨é‡ã€‚**\n\n> `OGCMN`Â old ä»£ä¸­åˆå§‹åŒ–ï¼ˆæœ€å°ï¼‰çš„å¤§å° ï¼ˆå­—èŠ‚ï¼‰\n`OGCMX`Â old ä»£çš„æœ€å¤§å®¹é‡ï¼ˆå­—èŠ‚ï¼‰\n`OGC`Â old ä»£å½“å‰æ–°ç”Ÿæˆçš„å®¹é‡ ï¼ˆå­—èŠ‚ï¼‰\n`OC`Â Old ä»£çš„å®¹é‡ ï¼ˆå­—èŠ‚ï¼‰\n`YGC`Â ä»åº”ç”¨ç¨‹åºå¯åŠ¨åˆ°é‡‡æ ·æ—¶å¹´è½»ä»£ä¸­ gc æ¬¡æ•°\n`FGC`Â ä»åº”ç”¨ç¨‹åºå¯åŠ¨åˆ°é‡‡æ ·æ—¶ old ä»£ï¼ˆå…¨gcï¼‰gc æ¬¡æ•°\n`FGCT`Â ä»åº”ç”¨ç¨‹åºå¯åŠ¨åˆ°é‡‡æ ·æ—¶ old ä»£ï¼ˆå…¨gcï¼‰gc æ‰€ç”¨æ—¶é—´ï¼ˆsï¼‰\n`GCT`Â ä»åº”ç”¨ç¨‹åºå¯åŠ¨åˆ°é‡‡æ ·æ—¶ gc ç”¨çš„æ€»æ—¶é—´ï¼ˆsï¼‰\n> \n\n**10ã€`jstat -gcpermcapacity<pid>`: permå¯¹è±¡çš„ä¿¡æ¯åŠå…¶å ç”¨é‡ã€‚**\n\n> `PGCMN`Â permä»£ä¸­åˆå§‹åŒ–ï¼ˆæœ€å°ï¼‰çš„å¤§å° ï¼ˆå­—èŠ‚ï¼‰\n`PGCMX`Â permä»£çš„æœ€å¤§å®¹é‡ ï¼ˆå­—èŠ‚ï¼‰\n`PGC` permä»£å½“å‰æ–°ç”Ÿæˆçš„å®¹é‡ ï¼ˆå­—èŠ‚ï¼‰\n`PC`Â Permï¼ˆæŒä¹…ä»£ï¼‰çš„å®¹é‡ ï¼ˆå­—èŠ‚ï¼‰\n`YGC`Â ä»åº”ç”¨ç¨‹åºå¯åŠ¨åˆ°é‡‡æ ·æ—¶å¹´è½»ä»£ä¸­ gc æ¬¡æ•°\n`FGC`Â ä»åº”ç”¨ç¨‹åºå¯åŠ¨åˆ°é‡‡æ ·æ—¶ old ä»£ï¼ˆå…¨gcï¼‰gc æ¬¡æ•°\n`FGCT`Â ä»åº”ç”¨ç¨‹åºå¯åŠ¨åˆ°é‡‡æ ·æ—¶ old ä»£ï¼ˆå…¨gcï¼‰gc æ‰€ç”¨æ—¶é—´ï¼ˆsï¼‰\n`GCT` ä»åº”ç”¨ç¨‹åºå¯åŠ¨åˆ°é‡‡æ ·æ—¶ gc ç”¨çš„æ€»æ—¶é—´ï¼ˆsï¼‰\n> \n\n**11ã€`jstat -printcompilation <pid>`ï¼šå½“å‰VMæ‰§è¡Œçš„ä¿¡æ¯ã€‚**\n\n> `Compiled`Â ç¼–è¯‘ä»»åŠ¡çš„æ•°ç›®\n`Size`Â æ–¹æ³•ç”Ÿæˆçš„å­—èŠ‚ç çš„å¤§å°\n`Type`Â ç¼–è¯‘ç±»å‹\n`Method` ç±»åå’Œæ–¹æ³•åç”¨æ¥æ ‡è¯†ç¼–è¯‘çš„æ–¹æ³•ã€‚\nç±»åä½¿ç”¨/åšä¸ºä¸€ä¸ªå‘½åç©ºé—´åˆ†éš”ç¬¦ã€‚æ–¹æ³•åæ˜¯ç»™å®šç±»ä¸­çš„æ–¹æ³•ã€‚ä¸Šè¿°æ ¼å¼æ˜¯ç”±-XX:+PrintComplationé€‰é¡¹è¿›è¡Œè®¾ç½®çš„\n>","tags":["æ€§èƒ½æµ‹è¯•","Java"]},{"title":"Javaå‘½ä»¤å­¦ä¹ ç³»åˆ—â€”Jmap","url":"/2024/06/30/2024-06-30-Javaå‘½ä»¤å­¦ä¹ ç³»åˆ—â€”map/","content":"\n> jmap æ˜¯ JDK è‡ªå¸¦çš„å·¥å…·è½¯ä»¶ï¼Œä¸»è¦ç”¨äºæ‰“å°æŒ‡å®š Java è¿›ç¨‹ï¼ˆæˆ–æ ¸å¿ƒæ–‡ä»¶ã€è¿œç¨‹è°ƒè¯•æœåŠ¡å™¨ï¼‰çš„å…±äº«å¯¹è±¡å†…å­˜æ˜ å°„æˆ–å †å†…å­˜ç»†èŠ‚ã€‚å¯ä»¥ä½¿ç”¨ jmap ç”Ÿæˆ Heap Dumpã€‚\n> \n\n## ä»€ä¹ˆæ˜¯å † dump\n\nå † dump æ˜¯ååº” Java å †ä½¿ç”¨æƒ…å†µçš„å†…å­˜é•œåƒï¼Œå…¶ä¸­ä¸»è¦åŒ…æ‹¬**ç³»ç»Ÿä¿¡æ¯ã€è™šæ‹Ÿæœºä¿¡æ¯ã€å®Œæ•´çš„çº¿ç¨‹ dumpã€æ‰€æœ‰ç±»å’Œå¯¹è±¡çš„çŠ¶æ€**ç­‰ã€‚ä¸€èˆ¬ï¼Œåœ¨å†…å­˜ä¸è¶³ã€GC å¼‚å¸¸ç­‰æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬æ€€ç–‘æœ‰å†…å­˜æ³„æ¼ã€‚è¿™ä¸ªæ—¶å€™æˆ‘ä»¬å°±å¯ä»¥åˆ¶ä½œå † Dump æ¥æŸ¥çœ‹å…·ä½“æƒ…å†µï¼Œåˆ†æåŸå› ã€‚\n\n## åŸºç¡€çŸ¥è¯†\n\nã€ŠJavaè™šæ‹Ÿæœºçš„å†…å­˜ç»„æˆä»¥åŠå †å†…å­˜ä»‹ç»ã€‹ã€ŠJava GCå·¥ä½œåŸç†ã€‹å¸¸è§å†…å­˜é”™è¯¯ï¼š\n\n> outOfMemoryErrorï¼šå¹´è€ä»£å†…å­˜ä¸è¶³\n> \n> \n> outOfMemoryError:PermGen Spaceï¼šæ°¸ä¹…ä»£å†…å­˜ä¸è¶³\n> \n> outOfMemoryError:GC overhead limit exceedï¼šåƒåœ¾å›æ”¶æ—¶é—´å ç”¨ç³»ç»Ÿè¿è¡Œæ—¶é—´çš„ 98% æˆ–ä»¥ä¸Š\n> \n\n## jmap\n\n### ç”¨æ³•æ‘˜è¦\n\n```java\nUsage:\n    jmap [option] <pid>\n        (to connect to running process)\n    jmap [option] <executable <core>\n        (to connect to a core file)\n    jmap [option] [server_id@]<remote server IP or hostname>\n        (to connect to remote debug server)\n\nwhere <option> is one of:\n    <none>               to print same info as Solaris pmap\n    -heap                to print java heap summary\n    -histo[:live]        to print histogram of java object heap; if the \"live\"\n                         suboption is specified, only count live objects\n    -permstat            to print permanent generation statistics\n    -finalizerinfo       to print information on objects awaiting finalization\n    -dump:<dump-options> to dump java heap in hprof binary format\n                         dump-options:\n                           live         dump only live objects; if not specified,\n                                        all objects in the heap are dumped.\n                           format=b     binary format\n                           file=<file>  dump heap to <file>\n                         Example: jmap -dump:live,format=b,file=heap.bin <pid>\n    -F                   force. Use with -dump:<dump-options> <pid> or -histo\n                         to force a heap dump or histogram when <pid> does not\n                         respond. The \"live\" suboption is not supported\n                         in this mode.\n    -h | -help           to print this help message\n    -J<flag>             to pass <flag> directly to the runtime system\n```\n\n#### å‚æ•°\n\n**optionï¼š**é€‰é¡¹å‚æ•°æ˜¯äº’æ–¥çš„(ä¸å¯åŒæ—¶ä½¿ç”¨)ã€‚æƒ³è¦ä½¿ç”¨é€‰é¡¹å‚æ•°ï¼Œç›´æ¥è·Ÿåœ¨å‘½ä»¤åç§°åå³å¯ã€‚\n\n**pidï¼š**éœ€è¦æ‰“å°é…ç½®ä¿¡æ¯çš„è¿›ç¨‹ IDã€‚è¯¥è¿›ç¨‹å¿…é¡»æ˜¯ä¸€ä¸ª Java è¿›ç¨‹ã€‚æƒ³è¦è·å–è¿è¡Œçš„ Java è¿›ç¨‹åˆ—è¡¨ï¼Œä½ å¯ä»¥ä½¿ç”¨ jpsã€‚\n\n**executableï¼š**äº§ç”Ÿæ ¸å¿ƒ dump çš„ Java å¯æ‰§è¡Œæ–‡ä»¶ã€‚\n\n**coreï¼š**éœ€è¦æ‰“å°é…ç½®ä¿¡æ¯çš„æ ¸å¿ƒæ–‡ä»¶ã€‚\n\n**remote-hostname-or-IPï¼š**è¿œç¨‹è°ƒè¯•æœåŠ¡å™¨çš„ï¼ˆè¯·æŸ¥çœ‹jsadebugdï¼‰ä¸»æœºåæˆ– IP åœ°å€ã€‚\n\n**server-idï¼š**å¯é€‰çš„å”¯ä¸€ idï¼Œå¦‚æœç›¸åŒçš„è¿œç¨‹ä¸»æœºä¸Šè¿è¡Œäº†å¤šå°è°ƒè¯•æœåŠ¡å™¨ï¼Œç”¨æ­¤é€‰é¡¹å‚æ•°æ ‡è¯†æœåŠ¡å™¨ã€‚\n\n#### é€‰é¡¹\n\n**\\<no option\\>ï¼š**å¦‚æœä½¿ç”¨ä¸å¸¦é€‰é¡¹å‚æ•°çš„ jmap æ‰“å°å…±äº«å¯¹è±¡æ˜ å°„ï¼Œå°†ä¼šæ‰“å°ç›®æ ‡è™šæ‹Ÿæœºä¸­åŠ è½½çš„æ¯ä¸ªå…±äº«å¯¹è±¡çš„èµ·å§‹åœ°å€ã€æ˜ å°„å¤§å°ä»¥åŠå…±äº«å¯¹è±¡æ–‡ä»¶çš„è·¯å¾„å…¨ç§°ã€‚è¿™ä¸ Solaris çš„ pmap å·¥å…·æ¯”è¾ƒç›¸ä¼¼ã€‚\n\n**-dump:[live,]format=b,file=<filename>ï¼š**ä»¥ hprof äºŒè¿›åˆ¶æ ¼å¼è½¬å‚¨ Java å †åˆ°æŒ‡å®š filename çš„æ–‡ä»¶ä¸­ã€‚live å­é€‰é¡¹æ˜¯å¯é€‰çš„ã€‚å¦‚æœæŒ‡å®šäº† live å­é€‰é¡¹ï¼Œå †ä¸­åªæœ‰æ´»åŠ¨çš„å¯¹è±¡ä¼šè¢«è½¬å‚¨ã€‚æƒ³è¦æµè§ˆ heap dumpï¼Œä½ å¯ä»¥ä½¿ç”¨ jhatï¼ˆJava å †åˆ†æå·¥å…·ï¼‰è¯»å–ç”Ÿæˆçš„æ–‡ä»¶ã€‚\n**-finalizerinfoï¼š**æ‰“å°ç­‰å¾…ç»ˆç»“çš„å¯¹è±¡ä¿¡æ¯ã€‚\n**-heapï¼š**æ‰“å°ä¸€ä¸ªå †çš„æ‘˜è¦ä¿¡æ¯ï¼ŒåŒ…æ‹¬ä½¿ç”¨çš„ GC ç®—æ³•ã€å †é…ç½®ä¿¡æ¯å’Œ generation wise heap usageã€‚\n**-histo[:live]ï¼š**æ‰“å°å †çš„æŸ±çŠ¶å›¾ã€‚å…¶ä¸­åŒ…æ‹¬æ¯ä¸ª Java ç±»ã€å¯¹è±¡æ•°é‡ã€å†…å­˜å¤§å°ï¼ˆå•ä½ï¼šå­—èŠ‚ï¼‰ã€å®Œå…¨é™å®šçš„ç±»åã€‚æ‰“å°çš„è™šæ‹Ÿæœºå†…éƒ¨çš„ç±»åç§°å°†ä¼šå¸¦æœ‰ä¸€ä¸ªâ€™*â€™å‰ç¼€ã€‚å¦‚æœæŒ‡å®šäº†liveå­é€‰é¡¹ï¼Œåˆ™åªè®¡ç®—æ´»åŠ¨çš„å¯¹è±¡ã€‚\n**-permstatï¼š**æ‰“å° Java å †å†…å­˜çš„æ°¸ä¹…ä¿å­˜åŒºåŸŸçš„ç±»åŠ è½½å™¨çš„æ™ºèƒ½ç»Ÿè®¡ä¿¡æ¯ã€‚å¯¹äºæ¯ä¸ªç±»åŠ è½½å™¨è€Œè¨€ï¼Œå®ƒçš„åç§°ã€æ´»è·ƒåº¦ã€åœ°å€ã€çˆ¶ç±»åŠ è½½å™¨ã€å®ƒæ‰€åŠ è½½çš„ç±»çš„æ•°é‡å’Œå¤§å°éƒ½ä¼šè¢«æ‰“å°ã€‚æ­¤å¤–ï¼ŒåŒ…å«çš„å­—ç¬¦ä¸²æ•°é‡å’Œå¤§å°ä¹Ÿä¼šè¢«æ‰“å°ã€‚\n**-Fï¼š**å¼ºåˆ¶æ¨¡å¼ã€‚å¦‚æœæŒ‡å®šçš„ pid æ²¡æœ‰å“åº”ï¼Œè¯·ä½¿ç”¨ jmap -dump æˆ– jmap -histo é€‰é¡¹ã€‚æ­¤æ¨¡å¼ä¸‹ï¼Œä¸æ”¯æŒ live å­é€‰é¡¹ã€‚\n**-hï¼š**æ‰“å°å¸®åŠ©ä¿¡æ¯ã€‚\n**-helpï¼š**æ‰“å°å¸®åŠ©ä¿¡æ¯ã€‚\n**-J<flag> ï¼š**æŒ‡å®šä¼ é€’ç»™è¿è¡Œjmapçš„JVMçš„å‚æ•°ã€‚\n\n### ä¸¾ä¾‹\n\n**æŸ¥çœ‹ java å †ï¼ˆheapï¼‰ä½¿ç”¨æƒ…å†µï¼Œ**æ‰§è¡Œå‘½ä»¤ï¼šÂ \n\n```bash\njmap -heap 31846\n\nAttaching to process ID 31846, please wait...\nDebugger attached successfully.\nServer compiler detected.\nJVM version is 24.71-b01\n\nusing thread-local object allocation.\nParallel GC with 4 thread(s) //GC æ–¹å¼\n\nHeap Configuration: //å †å†…å­˜åˆå§‹åŒ–é…ç½®\n   MinHeapFreeRatio = 0 //å¯¹åº”jvmå¯åŠ¨å‚æ•°-XX:MinHeapFreeRatioè®¾ç½®JVMå †æœ€å°ç©ºé—²æ¯”ç‡(default 40)\n   MaxHeapFreeRatio = 100 //å¯¹åº”jvmå¯åŠ¨å‚æ•° -XX:MaxHeapFreeRatioè®¾ç½®JVMå †æœ€å¤§ç©ºé—²æ¯”ç‡(default 70)\n   MaxHeapSize      = 2082471936 (1986.0MB) //å¯¹åº”jvmå¯åŠ¨å‚æ•°-XX:MaxHeapSize=è®¾ç½®JVMå †çš„æœ€å¤§å¤§å°\n   NewSize          = 1310720 (1.25MB) //å¯¹åº”jvmå¯åŠ¨å‚æ•°-XX:NewSize=è®¾ç½®JVMå †çš„â€˜æ–°ç”Ÿä»£â€™çš„é»˜è®¤å¤§å°\n   MaxNewSize       = 17592186044415 MB //å¯¹åº”jvmå¯åŠ¨å‚æ•°-XX:MaxNewSize=è®¾ç½®JVMå †çš„â€˜æ–°ç”Ÿä»£â€™çš„æœ€å¤§å¤§å°\n   OldSize          = 5439488 (5.1875MB) //å¯¹åº”jvmå¯åŠ¨å‚æ•°-XX:OldSize=<value>:è®¾ç½®JVMå †çš„â€˜è€ç”Ÿä»£â€™çš„å¤§å°\n   NewRatio         = 2 //å¯¹åº”jvmå¯åŠ¨å‚æ•°-XX:NewRatio=:â€˜æ–°ç”Ÿä»£â€™å’Œâ€˜è€ç”Ÿä»£â€™çš„å¤§å°æ¯”ç‡\n   SurvivorRatio    = 8 //å¯¹åº”jvmå¯åŠ¨å‚æ•°-XX:SurvivorRatio=è®¾ç½®å¹´è½»ä»£ä¸­EdenåŒºä¸SurvivoråŒºçš„å¤§å°æ¯”å€¼ \n   PermSize         = 21757952 (20.75MB)  //å¯¹åº”jvmå¯åŠ¨å‚æ•°-XX:PermSize=<value>:è®¾ç½®JVMå †çš„â€˜æ°¸ç”Ÿä»£â€™çš„åˆå§‹å¤§å°\n   MaxPermSize      = 85983232 (82.0MB) //å¯¹åº”jvmå¯åŠ¨å‚æ•°-XX:MaxPermSize=<value>:è®¾ç½®JVMå †çš„â€˜æ°¸ç”Ÿä»£â€™çš„æœ€å¤§å¤§å°\n   G1HeapRegionSize = 0 (0.0MB)\n\nHeap Usage: //å †å†…å­˜ä½¿ç”¨æƒ…å†µ\nPS Young Generation\nEden Space: //EdenåŒºå†…å­˜åˆ†å¸ƒ\n   capacity = 33030144 (31.5MB) //EdenåŒºæ€»å®¹é‡\n   used     = 1524040 (1.4534378051757812MB) //EdenåŒºå·²ä½¿ç”¨\n   free     = 31506104 (30.04656219482422MB) //EdenåŒºå‰©ä½™å®¹é‡\n   4.614088270399305% used //EdenåŒºä½¿ç”¨æ¯”ç‡\nFrom Space:  //å…¶ä¸­ä¸€ä¸ªSurvivoråŒºçš„å†…å­˜åˆ†å¸ƒ\n   capacity = 5242880 (5.0MB)\n   used     = 0 (0.0MB)\n   free     = 5242880 (5.0MB)\n   0.0% used\nTo Space:  //å¦ä¸€ä¸ªSurvivoråŒºçš„å†…å­˜åˆ†å¸ƒ\n   capacity = 5242880 (5.0MB)\n   used     = 0 (0.0MB)\n   free     = 5242880 (5.0MB)\n   0.0% used\nPS Old Generation //å½“å‰çš„OldåŒºå†…å­˜åˆ†å¸ƒ\n   capacity = 86507520 (82.5MB)\n   used     = 0 (0.0MB)\n   free     = 86507520 (82.5MB)\n   0.0% used\nPS Perm Generation//å½“å‰çš„ â€œæ°¸ç”Ÿä»£â€ å†…å­˜åˆ†å¸ƒ\n   capacity = 22020096 (21.0MB)\n   used     = 2496528 (2.3808746337890625MB)\n   free     = 19523568 (18.619125366210938MB)\n   11.337498256138392% used\n\n670 interned Strings occupying 43720 bytes.\n```\n\n**æŸ¥çœ‹å †å†…å­˜ï¼ˆhistogramï¼‰ä¸­çš„å¯¹è±¡æ•°é‡åŠå¤§å°**ã€‚æ‰§è¡Œå‘½ä»¤ï¼šÂ \n\n```bash\njmap -histo 3331\n\nnum     #instances         #bytes  class name\nç¼–å·     ä¸ªæ•°                å­—èŠ‚     ç±»å\n----------------------------------------------\n   1:             7        1322080  [I\n   2:          5603         722368  <methodKlass>\n   3:          5603         641944  <constMethodKlass>\n   4:         34022         544352  java.lang.Integer\n   5:           371         437208  <constantPoolKlass>\n   6:           336         270624  <constantPoolCacheKlass>\n   7:           371         253816  <instanceKlassKlass>\n```\n\n> **jmap -histo:live è¿™ä¸ªå‘½ä»¤æ‰§è¡Œï¼ŒJVMä¼šå…ˆè§¦å‘gcï¼Œç„¶åå†ç»Ÿè®¡ä¿¡æ¯ã€‚**\n> \n\n**å°†å†…å­˜ä½¿ç”¨çš„è¯¦ç»†æƒ…å†µè¾“å‡ºåˆ°æ–‡ä»¶**ï¼Œæ‰§è¡Œå‘½ä»¤ï¼š\n\n```bash\njmap -dump:format=b,file=heapDump 6900\n```\n\nç„¶åç”¨ `jhat` å‘½ä»¤å¯ä»¥å‚çœ‹Â `jhat -port 5000 heapDump`Â åœ¨æµè§ˆå™¨ä¸­è®¿é—®ï¼š`http://localhost:5000/`Â æŸ¥çœ‹è¯¦ç»†ä¿¡æ¯\n\n> è¿™ä¸ªå‘½ä»¤æ‰§è¡Œï¼ŒJVM ä¼šå°†æ•´ä¸ª heap çš„ä¿¡æ¯ dump å†™å…¥åˆ°ä¸€ä¸ªæ–‡ä»¶ï¼Œheap å¦‚æœæ¯”è¾ƒå¤§çš„è¯ï¼Œå°±ä¼šå¯¼è‡´è¿™ä¸ªè¿‡ç¨‹æ¯”è¾ƒè€—æ—¶ï¼Œå¹¶ä¸”æ‰§è¡Œçš„è¿‡ç¨‹ä¸­ä¸ºäº†ä¿è¯ dump çš„ä¿¡æ¯æ˜¯å¯é çš„ï¼Œæ‰€ä»¥ä¼šæš‚åœåº”ç”¨ã€‚\n> \n\n### æ€»ç»“\n\n1. å¦‚æœç¨‹åºå†…å­˜ä¸è¶³æˆ–è€…é¢‘ç¹GCï¼Œå¾ˆæœ‰å¯èƒ½å­˜åœ¨å†…å­˜æ³„éœ²æƒ…å†µï¼Œè¿™æ—¶å€™å°±è¦å€ŸåŠ© Java å † Dump æŸ¥çœ‹å¯¹è±¡çš„æƒ…å†µã€‚\n2. è¦åˆ¶ä½œå † Dump å¯ä»¥ç›´æ¥ä½¿ç”¨ jvm è‡ªå¸¦çš„ jmap å‘½ä»¤\n3. å¯ä»¥å…ˆä½¿ç”¨ `jmap -heap` å‘½ä»¤æŸ¥çœ‹å †çš„ä½¿ç”¨æƒ…å†µï¼Œçœ‹ä¸€ä¸‹å„ä¸ªå †ç©ºé—´çš„å ç”¨æƒ…å†µã€‚\n4. ä½¿ç”¨ `jmap -histo:[live]` æŸ¥çœ‹å †å†…å­˜ä¸­çš„å¯¹è±¡çš„æƒ…å†µã€‚å¦‚æœæœ‰å¤§é‡å¯¹è±¡åœ¨æŒç»­è¢«å¼•ç”¨ï¼Œå¹¶æ²¡æœ‰è¢«é‡Šæ”¾æ‰ï¼Œé‚£å°±äº§ç”Ÿäº†å†…å­˜æ³„éœ²ï¼Œå°±è¦ç»“åˆä»£ç ï¼ŒæŠŠä¸ç”¨çš„å¯¹è±¡é‡Šæ”¾æ‰ã€‚\n5. ä¹Ÿå¯ä»¥ä½¿ç”¨Â `jmap -dump:format=b,file=<fileName>`å‘½ä»¤å°†å †ä¿¡æ¯ä¿å­˜åˆ°ä¸€ä¸ªæ–‡ä»¶ä¸­ï¼Œå†å€ŸåŠ©jhatå‘½ä»¤æŸ¥çœ‹è¯¦ç»†å†…å®¹\n6. åœ¨å†…å­˜å‡ºç°æ³„éœ²ã€æº¢å‡ºæˆ–è€…å…¶å®ƒå‰ææ¡ä»¶ä¸‹ï¼Œå»ºè®®å¤š dump å‡ æ¬¡å†…å­˜ï¼ŒæŠŠå†…å­˜æ–‡ä»¶è¿›è¡Œç¼–å·å½’æ¡£ï¼Œä¾¿äºåç»­å†…å­˜æ•´ç†åˆ†æã€‚\n\n**Error attaching to process: sun.jvm.hotspot.debugger.DebuggerException: Canâ€™t attach to the process**\n\nåœ¨ubuntuä¸­ç¬¬ä¸€æ¬¡ä½¿ç”¨ jmap ä¼šæŠ¥é”™ï¼š`Error attaching to process: sun.jvm.hotspot.debugger.DebuggerException: Can't attach to the process`ï¼Œè¿™æ˜¯oraclaæ–‡æ¡£ä¸­æåˆ°çš„ä¸€ä¸ªbugï¼š[http://bugs.java.com/bugdatabase/view_bug.do?bug_id=7050524,è§£å†³æ–¹å¼å¦‚ä¸‹ï¼š](http://bugs.java.com/bugdatabase/view_bug.do?bug_id=7050524,%E8%A7%A3%E5%86%B3%E6%96%B9%E5%BC%8F%E5%A6%82%E4%B8%8B%EF%BC%9A)\n\n1. echo 0 | sudo tee /proc/sys/kernel/yama/ptrace_scope è¯¥æ–¹æ³•åœ¨ä¸‹æ¬¡é‡å¯å‰æœ‰æ•ˆã€‚\n2. æ°¸ä¹…æœ‰æ•ˆæ–¹æ³• sudo vi /etc/sysctl.d/10-ptrace.conf ç¼–è¾‘ä¸‹é¢è¿™è¡Œ `kernel.yama.ptrace_scope = 1` ä¿®æ”¹ä¸º `kernel.yama.ptrace_scope = 0` é‡å¯ç³»ç»Ÿï¼Œä½¿ä¿®æ”¹ç”Ÿæ•ˆã€‚","tags":["æ€§èƒ½æµ‹è¯•","Java"]},{"title":"Javaå¼€å‘å¿…é¡»æŒæ¡çš„çº¿ä¸Šé—®é¢˜æ’æŸ¥å‘½ä»¤","url":"/2024/06/30/2024-06-30-Javaå¼€å‘å¿…é¡»æŒæ¡çš„çº¿ä¸Šé—®é¢˜æ’æŸ¥å‘½ä»¤/","content":"\nä½œä¸ºä¸€ä¸ªåˆæ ¼çš„å¼€å‘äººå‘˜ï¼Œä¸ä»…è¦èƒ½å†™å¾—ä¸€æ‰‹ä»£ç ï¼Œè¿˜è¦æœ‰ä¸€é¡¹å¾ˆé‡è¦çš„æŠ€èƒ½å°±æ˜¯æ’æŸ¥é—®é¢˜ã€‚è¿™é‡Œæåˆ°çš„æ’æŸ¥é—®é¢˜ä¸ä»…ä»…æ˜¯åœ¨ coding çš„è¿‡ç¨‹ä¸­ debug ç­‰ï¼Œè¿˜åŒ…æ‹¬çš„å°±æ˜¯çº¿ä¸Šé—®é¢˜çš„æ’æŸ¥ã€‚ç”±äºåœ¨ç”Ÿæˆç¯å¢ƒä¸­ï¼Œä¸€èˆ¬æ²¡åŠæ³• debugï¼ˆå…¶å®æœ‰äº›é—®é¢˜ï¼Œdebug ä¹Ÿç™½æ‰¯â€¦ï¼‰ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦å€ŸåŠ©ä¸€äº›å¸¸è§å‘½ä»¤æ¥æŸ¥çœ‹è¿è¡Œæ—¶çš„å…·ä½“æƒ…å†µï¼Œè¿™äº›è¿è¡Œæ—¶ä¿¡æ¯åŒ…æ‹¬ä½†ä¸é™äºè¿è¡Œæ—¥å¿—ã€å¼‚å¸¸å †æ ˆã€å †ä½¿ç”¨æƒ…å†µã€GCæƒ…å†µã€JVMå‚æ•°æƒ…å†µã€çº¿ç¨‹æƒ…å†µç­‰ã€‚\n\nç»™ä¸€ä¸ªç³»ç»Ÿå®šä½é—®é¢˜çš„æ—¶å€™ï¼ŒçŸ¥è¯†ã€ç»éªŒæ˜¯å…³é”®ï¼Œæ•°æ®æ˜¯ä¾æ®ï¼Œå·¥å…·æ˜¯è¿ç”¨çŸ¥è¯†å¤„ç†æ•°æ®çš„æ‰‹æ®µã€‚ä¸ºäº†ä¾¿äºæˆ‘ä»¬æ’æŸ¥å’Œè§£å†³é—®é¢˜ï¼ŒSun å…¬å¸ä¸ºæˆ‘ä»¬æä¾›äº†ä¸€äº›å¸¸ç”¨å‘½ä»¤ã€‚è¿™äº›å‘½ä»¤ä¸€èˆ¬éƒ½æ˜¯ jdk/lib/tools.jar ä¸­ç±»åº“çš„ä¸€å±‚è–„åŒ…è£…ã€‚éšç€ JVM çš„å®‰è£…ä¸€èµ·è¢«å®‰è£…åˆ°æœºå™¨ä¸­ï¼Œåœ¨ bin ç›®å½•ä¸­ã€‚ä¸‹é¢å°±æ¥è®¤è¯†ä¸€ä¸‹è¿™äº›å‘½ä»¤ä»¥åŠå…·ä½“ä½¿ç”¨æ–¹å¼ã€‚\n\n## JPS\n\n**åŠŸèƒ½ï¼š**æ˜¾ç¤ºå½“å‰æ‰€æœ‰ java è¿›ç¨‹ pid çš„å‘½ä»¤ã€‚\n\n**å¸¸è§æŒ‡ä»¤ï¼š**\n\n`jps`ï¼šæ˜¾ç¤ºå½“å‰ç”¨æˆ·çš„æ‰€æœ‰javaè¿›ç¨‹çš„PID\n\n`jps -v 3331`ï¼šæ˜¾ç¤ºè™šæ‹Ÿæœºå‚æ•°\n\n`jps -m 3331`ï¼šæ˜¾ç¤ºä¼ é€’ç»™ main() å‡½æ•°çš„å‚æ•°\n\n`jps -l 3331`ï¼šæ˜¾ç¤ºä¸»ç±»çš„å…¨è·¯å¾„\n\n## jinfo\n\n**åŠŸèƒ½ï¼š**å®æ—¶æŸ¥çœ‹å’Œè°ƒæ•´è™šæ‹Ÿæœºå‚æ•°ï¼Œå¯ä»¥æ˜¾ç¤ºæœªè¢«æ˜¾ç¤ºæŒ‡å®šçš„å‚æ•°çš„é»˜è®¤å€¼ï¼ˆjps  -v åˆ™ä¸èƒ½ï¼‰\n\n> jdk8 ä¸­å·²ç»ä¸æ”¯æŒè¯¥å‘½ä»¤\n> \n\n**å¸¸ç”¨æŒ‡ä»¤ï¼š**\n\n`jinfo -flag CMSIniniatingOccupancyFration 1444`ï¼šæŸ¥è¯¢ CMSIniniatingOccupancyFration å‚æ•°å€¼\n\n## jstat\n\n**åŠŸèƒ½ï¼š**æ˜¾ç¤ºè¿›ç¨‹ä¸­çš„ç±»åŠ è½½ã€å†…å­˜ã€åƒåœ¾æ”¶é›†ã€JIT ç¼–è¯‘ç­‰è¿è¡Œæ•°æ®ã€‚\n\n**å¸¸ç”¨æŒ‡ä»¤ï¼š**\n\n`jstat -gc 3331 250 20`Â ï¼šæŸ¥è¯¢è¿›ç¨‹2764çš„åƒåœ¾æ”¶é›†æƒ…å†µï¼Œæ¯250æ¯«ç§’æŸ¥è¯¢ä¸€æ¬¡ï¼Œä¸€å…±æŸ¥è¯¢20æ¬¡ã€‚\n\n`jstat -gccause`ï¼šé¢å¤–è¾“å‡ºä¸Šæ¬¡GCåŸå› \n\n`jstat -calss`ï¼šä»¶äº‹ç±»è£…è½½ã€ç±»å¸è½½ã€æ€»ç©ºé—´ä»¥åŠæ‰€æ¶ˆè€—çš„æ—¶é—´\n\n## jmap\n\n**åŠŸèƒ½ï¼š**ç”Ÿæˆå †å‡†å‚¨å¿«ç…§ï¼ˆheapdumpï¼‰\n\n**å¸¸ç”¨æŒ‡ä»¤ï¼š**\n\n`jmap -heap 3331`ï¼šæŸ¥çœ‹java å †ï¼ˆheapï¼‰ä½¿ç”¨æƒ…å†µ\n\n`jmap -histo 3331`ï¼šæŸ¥çœ‹å †å†…å­˜ï¼ˆhistogramï¼‰ä¸­çš„å¯¹è±¡æ•°é‡åŠå¤§å°\n\n`jmap -histo:live 3331`ï¼šJVM ä¼šå…ˆè§¦å‘ gcï¼Œç„¶åå†ç»Ÿè®¡ä¿¡æ¯\n\n`jmap -dump:format=b,file=heapDump 3331`ï¼šå°†å†…å­˜ä½¿ç”¨çš„è¯¦ç»†æƒ…å†µè¾“å‡ºåˆ°æ–‡ä»¶ï¼Œä¹‹åä¸€èˆ¬ä½¿ç”¨å…¶ä»–å·¥å…·è¿›è¡Œåˆ†æã€‚\n\n## **jhat**\n\n**åŠŸèƒ½ï¼š**ä¸€èˆ¬ä¸ jmap æ­é…ä½¿ç”¨ï¼Œç”¨æ¥åˆ†æ jmap ç”Ÿæˆçš„å †è½¬å‚¨æ–‡ä»¶ã€‚\n\n> ç”±äºæœ‰å¾ˆå¤šå¯è§†åŒ–å·¥å…·ï¼ˆEclipse Memory Analyzer ã€IBM HeapAnalyzerï¼‰å¯ä»¥æ›¿ä»£ï¼Œæ‰€ä»¥å¾ˆå°‘ç”¨ã€‚ä¸è¿‡åœ¨æ²¡æœ‰å¯è§†åŒ–å·¥å…·çš„æœºå™¨ä¸Šä¹Ÿæ˜¯å¯ç”¨çš„ã€‚\n> \n\n**å¸¸ç”¨æŒ‡ä»¤ï¼š**\n\n`jmap -dump:format=b,file=heapDump 3331`Â +Â `jhat heapDump`ï¼šè§£æ Java å †è½¬å‚¨æ–‡ä»¶ï¼Œå¹¶å¯åŠ¨ä¸€ä¸ª web server\n\n## **jstack**\n\n**åŠŸèƒ½ï¼š**ç”Ÿæˆå½“å‰æ—¶åˆ»çš„çº¿ç¨‹å¿«ç…§ã€‚\n\n**å¸¸ç”¨æŒ‡ä»¤ï¼š**\n\n`jstack 3331`ï¼šæŸ¥çœ‹çº¿ç¨‹æƒ…å†µ\n\n`jstack -F 3331`ï¼šæ­£å¸¸è¾“å‡ºä¸è¢«å“åº”æ—¶ï¼Œä½¿ç”¨è¯¥æŒ‡ä»¤\n\n`jstack -l 3331`ï¼šé™¤å †æ ˆå¤–ï¼Œæ˜¾ç¤ºå…³äºé”çš„é™„ä»¶ä¿¡æ¯\n\n# å¸¸è§é—®é¢˜å®šä½è¿‡ç¨‹\n\n## é¢‘ç¹ GC é—®é¢˜æˆ–å†…å­˜æº¢å‡ºé—®é¢˜\n\n1. ä½¿ç”¨ `jps` æŸ¥çœ‹çº¿ç¨‹ ID\n2. ä½¿ç”¨ `jstat -gc xxx 250 20` æŸ¥çœ‹ gc æƒ…å†µï¼Œä¸€èˆ¬æ¯”è¾ƒå…³æ³¨ PERM åŒºçš„æƒ…å†µï¼ŒæŸ¥çœ‹ GC çš„å¢é•¿æƒ…å†µã€‚\n3. ä½¿ç”¨ `jstat -gccause` é¢å¤–è¾“å‡ºä¸Šæ¬¡ GC åŸå› \n4. ä½¿ç”¨ `jmap -dump:format=b,file=heapDump xxx`  ç”Ÿæˆå †è½¬å‚¨æ–‡ä»¶\n5. ä½¿ç”¨ jhat æˆ–è€…å¯è§†åŒ–å·¥å…·ï¼ˆEclipse Memory Analyzer ã€IBM HeapAnalyzerï¼‰åˆ†æå †æƒ…å†µã€‚\n6. ç»“åˆä»£ç è§£å†³å†…å­˜æº¢å‡ºæˆ–æ³„éœ²é—®é¢˜ã€‚\n\n## **æ­»é”é—®é¢˜**\n\n1. ä½¿ç”¨`jps`æŸ¥çœ‹çº¿ç¨‹ IDï¼Œè½¬æ¢ä¸º 16 è¿›åˆ¶\n    \n    ```python\n    printf %x çº¿ç¨‹å·\n    ```\n    \n2. ä½¿ç”¨`jstack xxx`ï¼šæŸ¥çœ‹çº¿ç¨‹æƒ…å†µ\n\n# **ç»“è¯­**\n\nç»å¸¸ä½¿ç”¨é€‚å½“çš„è™šæ‹Ÿæœºç›‘æ§å’Œåˆ†æå·¥å…·å¯ä»¥åŠ å¿«æˆ‘ä»¬åˆ†ææ•°æ®ã€å®šä½è§£å†³é—®é¢˜çš„é€Ÿåº¦ï¼Œä½†ä¹Ÿè¦çŸ¥é“ï¼Œå·¥å…·æ°¸è¿œéƒ½æ˜¯çŸ¥è¯†æŠ€èƒ½çš„ä¸€å±‚åŒ…è£…ï¼Œæ²¡æœ‰ä»€ä¹ˆå·¥å…·æ˜¯åŒ…æ²»ç™¾ç—…çš„ã€‚\n\n[**Javaå‘½ä»¤å­¦ä¹ ç³»åˆ—ï¼ˆä¸€ï¼‰â€” Jps**](https://wu3227834.github.io/2024/06/29/2026-06-30-java-ming-ling-xue-xi-xi-lie-yi-jps/)\n\n[**Javaå‘½ä»¤å­¦ä¹ ç³»åˆ—ï¼ˆäºŒï¼‰â€” Jstack**](https://wu3227834.github.io/2024/06/29/2026-06-30-java-ming-ling-xue-xi-xi-lie-er-jstack/)\n\n[**Javaå‘½ä»¤å­¦ä¹ ç³»åˆ—ï¼ˆä¸‰ï¼‰â€” Jmap**](https://wu3227834.github.io/2024/06/29/2026-06-30-java-ming-ling-xue-xi-xi-lie-san-jmap/)\n\n[**Javaå‘½ä»¤å­¦ä¹ ç³»åˆ—ï¼ˆå››ï¼‰â€” Jstat**](https://wu3227834.github.io/2024/06/29/2026-06-30-java-ming-ling-xue-xi-xi-lie-si-jstat/)\n\n[**Javaå‘½ä»¤å­¦ä¹ ç³»åˆ—ï¼ˆäº”ï¼‰â€” Jhat**](https://www.notion.so/Java-Jhat-e4da5c23fe34484093bcd8607fd14d07?pvs=21)","tags":["æ€§èƒ½æµ‹è¯•","Java"]},{"title":"æ€§èƒ½æµ‹è¯•â€”â€”ç«ç„°å›¾è¿›é˜¶","url":"/2024/04/22/2024-04-22-FlameGraph/","content":"\nå½“ç¨‹åºå‡ºç°æ€§èƒ½ç“¶é¢ˆæ—¶ï¼Œæˆ‘ä»¬é€šå¸¸é€šè¿‡è¡¨è±¡ï¼ˆæ¯”å¦‚è¯·æ±‚æŸä¸ªæ¥å£æ—¶ CPU ä½¿ç”¨ç‡é£™æ¶¨ï¼‰ç„¶åç»“åˆä»£ç å»æ¨æµ‹å¯èƒ½å‡ºé—®é¢˜çš„åœ°æ–¹ï¼Œå´ä¸çŸ¥é“é—®é¢˜åˆ°åº•æ˜¯ä»€ä¹ˆå¼•èµ·çš„ã€‚å¦‚æœæœ‰ä¸ªä¸€å¯è§†åŒ–çš„å·¥å…·ç›´è§‚åœ°å±•ç°ç¨‹åºçš„æ€§èƒ½ç“¶é¢ˆå°±å¥½äº†ï¼Œå¹¸å¥½ [Brendan D. Gregg](/img/2024-04-22-FlameGraph/http://www.brendangregg.com/) å‘æ˜äº†ç«ç„°å›¾ã€‚\n\n[ç«ç„°å›¾](/img/2024-04-22-FlameGraph/http://www.brendangregg.com/flamegraphs.html)ï¼ˆFlame Graphï¼‰çœ‹èµ·æ¥å°±åƒä¸€å›¢è·³åŠ¨çš„ç«ç„°ï¼Œå› æ­¤å¾—åã€‚ç«ç„°å›¾å¯ä»¥å°† CPU çš„ä½¿ç”¨æƒ…å†µå¯è§†åŒ–ï¼Œä½¿æˆ‘ä»¬ç›´è§‚åœ°äº†è§£åˆ°ç¨‹åºçš„æ€§èƒ½ç“¶é¢ˆï¼Œé€šå¸¸è¦ç»“åˆæ“ä½œç³»ç»Ÿçš„æ€§èƒ½åˆ†æå·¥å…·ï¼ˆprofiling tracerï¼‰ä½¿ç”¨ï¼Œå¸¸è§çš„æ“ä½œç³»ç»Ÿçš„æ€§èƒ½åˆ†æå·¥å…·å¦‚ä¸‹ï¼š\n\n- Linuxï¼šperf, eBPF, SystemTap, and ktapã€‚\n- Solaris, illumos, FreeBSDï¼šDTraceã€‚\n- Mac OS Xï¼šDTrace and Instrumentsã€‚\n- Windowsï¼šXperf.exeã€‚\n\n## 1.1.1 perf\n\n[perf_events](/img/2024-04-22-FlameGraph/http://www.brendangregg.com/linuxperf.html)ï¼ˆç®€ç§° perfï¼‰æ˜¯ Linux Kernal è‡ªå¸¦çš„ç³»ç»Ÿæ€§èƒ½åˆ†æå·¥å…·ï¼Œèƒ½å¤Ÿè¿›è¡Œå‡½æ•°çº§ä¸æŒ‡ä»¤çº§çš„çƒ­ç‚¹æŸ¥æ‰¾ã€‚å®ƒåŸºäºäº‹ä»¶é‡‡æ ·åŸç†ï¼Œä»¥æ€§èƒ½äº‹ä»¶ä¸ºåŸºç¡€ï¼Œæ”¯æŒé’ˆå¯¹å¤„ç†å™¨ç›¸å…³æ€§èƒ½æŒ‡æ ‡ä¸æ“ä½œç³»ç»Ÿç›¸å…³æ€§èƒ½æŒ‡æ ‡çš„æ€§èƒ½å‰–æï¼Œå¸¸ç”¨äºæŸ¥æ‰¾æ€§èƒ½ç“¶é¢ˆåŠå®šä½çƒ­ç‚¹ä»£ç ã€‚\n\næµ‹è¯•æœºå™¨ï¼š\n\n```sh\n$ uname -a\nLinux nswbmw-VirtualBox 4.10.0-28-generic #32~16.04.2-Ubuntu SMP Thu Jul 20 10:19:48 UTC 2017 x86_64 x86_64 x86_64 GNU/Linux\n```\n\n**æ³¨æ„**ï¼šé Linux ç”¨æˆ·éœ€è¦ç”¨è™šæ‹Ÿæœºå®‰è£… Ubuntu 16.04 å’Œ node@8.9.4 åè¿›è¡Œåé¢çš„æ“ä½œã€‚\n\nå®‰è£… perfï¼š\n\n```sh\n$ sudo apt install linux-tools-common\n$ perf # æ ¹æ®æç¤ºå®‰è£…å¯¹åº”çš„å†…æ ¸ç‰ˆæœ¬çš„ tools, å¦‚ä¸‹\n$ sudo apt install linux-tools-4.10.0-28-generic linux-cloud-tools-4.10.0-28-generic\n```\n\nåˆ›å»ºæµ‹è¯•ç›®å½• ~/test å’Œæµ‹è¯•ä»£ç ï¼š\n\n**app.js**\n\n```js\nconst crypto = require('crypto')\nconst Paloma = require('paloma')\nconst app = new Paloma()\nconst users = {}\n\napp.route({ method: 'GET', path: '/newUser', controller (ctx) {\n  const username = ctx.query.username || 'test'\n  const password = ctx.query.password || 'test'\n\n  const salt = crypto.randomBytes(128).toString('base64')\n  const hash = crypto.pbkdf2Sync(password, salt, 10000, 64, 'sha512').toString('hex')\n\n  users[username] = { salt, hash }\n\n  ctx.status = 204\n}})\n\napp.route({ method: 'GET', path: '/auth', controller (ctx) {\n  const username = ctx.query.username || 'test'\n  const password = ctx.query.password || 'test'\n\n  if (!users[username]) {\n    ctx.throw(400)\n  }\n  const hash = crypto.pbkdf2Sync(password, users[username].salt, 10000, 64, 'sha512').toString('hex')\n\n  if (users[username].hash === hash) {\n    ctx.status = 204\n  } else {\n    ctx.throw(403)\n  }\n}})\n \napp.listen(3000)\n```\n\næ·»åŠ  --perf_basic_profï¼ˆæˆ–è€… --perf-basic-profï¼‰å‚æ•°è¿è¡Œæ­¤ç¨‹åºï¼Œä¼šå¯¹åº”ç”Ÿæˆä¸€ä¸ª /tmp/perf-\\<PID\\>.map çš„æ–‡ä»¶ã€‚å‘½ä»¤å¦‚ä¸‹ï¼š\n\n```sh\n$ node --perf_basic_prof app.js &\n[1] 3590\n$ tail /tmp/perf-3590.map\n51b87a7b93e 18 Function:~emitListeningNT net.js:1375\n51b87a7b93e 18 LazyCompile:~emitListeningNT net.js:1375\n51b87a7bad6 39 Function:~emitAfterScript async_hooks.js:443\n51b87a7bad6 39 LazyCompile:~emitAfterScript async_hooks.js:443\n51b87a7bcbe 77 Function:~tickDone internal/process/next_tick.js:88\n51b87a7bcbe 77 LazyCompile:~tickDone internal/process/next_tick.js:88\n51b87a7bf36 12 Function:~clear internal/process/next_tick.js:42\n51b87a7bf36 12 LazyCompile:~clear internal/process/next_tick.js:42\n51b87a7c126 b8 Function:~emitPendingUnhandledRejections internal/process/promises.js:86\n51b87a7c126 b8 LazyCompile:~emitPendingUnhandledRejections internal/process/promises.js:86\n```\n\n**map æ–‡ä»¶å†…å®¹ä¸‰åˆ—ä¾æ¬¡ä¸º**ï¼š16è¿›åˆ¶çš„ç¬¦å·åœ°å€ï¼ˆsymbol addressesï¼‰ã€å¤§å°ï¼ˆsizesï¼‰å’Œç¬¦å·åï¼ˆsymbol namesï¼‰ã€‚perf ä¼šå°è¯•æŸ¥æ‰¾ /tmp/perf-\\<PID\\>.map æ–‡ä»¶ï¼Œç”¨æ¥åšç¬¦å·è½¬æ¢ï¼Œå³æŠŠ 16 è¿›åˆ¶çš„ç¬¦å·åœ°å€è½¬æ¢æˆäººèƒ½è¯»æ‡‚çš„ç¬¦å·åã€‚\n\n**æ³¨æ„**ï¼šä½¿ç”¨ --perf_basic_prof_only_functions å‚æ•°ä¹Ÿå¯ä»¥ï¼Œä½†ç»å°è¯•åå‘ç°ç”Ÿæˆçš„ç«ç„°å›¾ä¿¡æ¯ä¸å…¨ï¼ˆä¸å…¨çš„åœ°æ–¹æ˜¾ç¤º [perf-\\<PID\\>.map]ï¼‰ï¼Œæ‰€ä»¥è¿™é‡Œä½¿ç”¨ --perf_basic_profã€‚ä½†æ˜¯ï¼Œä½¿ç”¨ --perf_basic_prof  æœ‰ä¸ªç¼ºç‚¹ï¼Œå°±æ˜¯ä¼šå¯¼è‡´ map æ–‡ä»¶ä¸€ç›´å¢å¤§ï¼Œè¿™æ˜¯ç”±äºç¬¦å·ï¼ˆsymbolsï¼‰åœ°å€ä¸æ–­å˜æ¢å¯¼è‡´çš„ï¼Œç”¨ --perf_basic_prof_only_functions å¯ä»¥ç¼“è§£è¿™ä¸ªé—®é¢˜ã€‚å…³äºå¦‚ä½•å–èˆï¼Œè¿˜è¯·è¯»è€…è‡ªè¡Œå°è¯•ã€‚\n\næ¥ä¸‹æ¥ clone ç”¨æ¥ç”Ÿæˆç«ç„°å›¾çš„å·¥å…·ï¼š\n\n```sh\n$ git clone http://github.com/brendangregg/FlameGraph ~/FlameGraph\n```\n\næˆ‘ä»¬å…ˆç”¨ ab å‹æµ‹ï¼š\n\n```sh\n$ curl \"http://localhost:3000/newUser?username=admin&password=123456\"\n$ ab -k -c 10 -n 2000 \"http://localhost:3000/auth?username=admin&password=123456\"\n```\n\næ–°å¼€å¦ä¸€ä¸ªç»ˆç«¯ï¼Œåœ¨ ab å¼€å§‹å‹æµ‹åç«‹å³è¿è¡Œï¼š\n\n```sh\n$ sudo perf record -F 99 -p 3590 -g -- sleep 30\n$ sudo chown root /tmp/perf-3590.map\n$ sudo perf script > perf.stacks\n$ ~/FlameGraph/stackcollapse-perf.pl --kernel < ~/perf.stacks | ~/FlameGraph/flamegraph.pl --color=js --hash> ~/flamegraph.svg\n```\n\n**æ³¨æ„**ï¼šç¬¬ 1 æ¬¡ç”Ÿæˆçš„ svg å¯èƒ½ä¸å¤ªå‡†ç¡®ï¼Œæœ€å¥½é‡å¤å‡ æ¬¡ä»¥ä¸Šæ­¥éª¤ï¼Œä½¿ç”¨ç¬¬ 2 æ¬¡åŠä»¥åç”Ÿæˆçš„ flamegraph.svgã€‚\n\næœ‰å‡ ç‚¹éœ€è¦è§£é‡Šä¸€ä¸‹ï¼š\n\n- perf record\n  - -F æŒ‡å®šäº†é‡‡æ ·é¢‘ç‡ 99Hzï¼ˆå³æ¯ç§’ 99 æ¬¡ï¼Œå¦‚æœ 99 æ¬¡éƒ½è¿”å›åŒä¸€ä¸ªå‡½æ•°åï¼Œé‚£å°±è¯´æ˜ CPU åœ¨è¿™ä¸€ç§’é’Ÿéƒ½åœ¨æ‰§è¡ŒåŒä¸€ä¸ªå‡½æ•°ï¼Œå¯èƒ½å­˜åœ¨æ€§èƒ½é—®é¢˜ï¼‰ã€‚\n  - -p æŒ‡å®šè¿›ç¨‹çš„ pidã€‚\n  - -g å¯ç”¨ call-graph è®°å½•ã€‚\n  - -- sleep 30 æŒ‡å®šè®°å½• 30sã€‚\n\n- sudo chown root /tmp/perf-3009.mapï¼Œå°† map æ–‡ä»¶æ›´æ”¹ä¸º root æƒé™ï¼Œå¦åˆ™ä¼šæŠ¥å¦‚ä¸‹é”™è¯¯ï¼š\n\n  > File /tmp/perf-PID.map not owned by current user or root, ignoring it (use -f to override).\n  > Failed to open /tmp/perf-PID.map, continuing without symbols\n\n- perf record ä¼šå°†è®°å½•çš„ä¿¡æ¯ä¿å­˜åˆ°å½“å‰æ‰§è¡Œç›®å½•çš„ perf.data æ–‡ä»¶ä¸­ï¼Œç„¶åä½¿ç”¨ perf script è¯»å– perf.data çš„ trace ä¿¡æ¯å†™å…¥ perf.stacksã€‚\n\n- --color=js æŒ‡å®šç”Ÿæˆé’ˆå¯¹ JavaScript é…è‰²çš„ svgï¼Œå³ï¼š\n\n  - greenï¼šJavaScriptã€‚\n  - blueï¼šBuiltinã€‚\n  - yellowï¼šC++ã€‚\n  - redï¼šSystemï¼ˆnative user-level, and kernelï¼‰ã€‚\n\nab å‹æµ‹ç”¨äº† 30s å·¦å³ï¼Œç”¨æµè§ˆå™¨æ‰“å¼€ flamegraph.svgï¼Œæˆªå–å…³é”®çš„éƒ¨åˆ†å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š\n\n![flamegraph1.svg](/img/2024-04-22-FlameGraph/1.1.1.png)\n\n## 1.1.2 ç†è§£ç«ç„°å›¾\n\nç«ç„°å›¾å«ä¹‰ï¼š\n\n- æ¯ä¸€ä¸ªå°å—ä»£è¡¨äº†ä¸€ä¸ªå‡½æ•°åœ¨æ ˆä¸­çš„ä½ç½®ï¼ˆå³ä¸€ä¸ªæ ˆå¸§ï¼‰ã€‚\n- Y è½´ä»£è¡¨æ ˆçš„æ·±åº¦ï¼ˆæ ˆä¸Šçš„å¸§æ•°ï¼‰ï¼Œé¡¶ç«¯çš„å°å—æ˜¾ç¤ºäº†å æ® CPU çš„å‡½æ•°ã€‚æ¯ä¸ªå°å—çš„ä¸‹é¢æ˜¯å®ƒçš„ç¥–å…ˆï¼ˆå³çˆ¶å‡½æ•°ï¼‰ã€‚\n- X è½´ä»£è¡¨æ€»çš„æ ·ä¾‹ç¾¤ä½“ã€‚å®ƒä¸åƒç»å¤§å¤šæ•°å›¾è¡¨é‚£æ ·ä»å·¦åˆ°å³è¡¨ç¤ºæ—¶é—´çš„æµé€ï¼Œå…¶å·¦å³é¡ºåºæ²¡æœ‰ç‰¹æ®Šå«ä¹‰ï¼Œä»…ä»…æŒ‰ç…§å­—æ¯è¡¨çš„é¡ºåºæ’åˆ—ã€‚\n- å°å—çš„å®½åº¦ä»£è¡¨ CPU çš„ä½¿ç”¨æ—¶é—´ï¼Œæˆ–è€…è¯´ç›¸å¯¹äºçˆ¶å‡½æ•°è€Œè¨€ä½¿ç”¨ CPU çš„æ¯”ä¾‹ï¼ˆåŸºäºæ‰€æœ‰æ ·ä¾‹ï¼‰ï¼Œè¶Šå®½åˆ™ä»£è¡¨å ç”¨ CPU çš„æ—¶é—´è¶Šé•¿ï¼Œæˆ–è€…ä½¿ç”¨ CPU å¾ˆé¢‘ç¹ã€‚\n- å¦‚æœé‡‡å–å¤šçº¿ç¨‹å¹¶å‘è¿è¡Œå–æ ·ï¼Œåˆ™å–æ ·æ•°é‡ä¼šè¶…è¿‡è¿è¡Œæ—¶é—´ã€‚\n\n**ä»ä¸Šå›¾å¯ä»¥çœ‹å‡º**ï¼šæœ€ä¸Šé¢çš„ç»¿è‰²å°å—ï¼ˆå³ JavaScript ä»£ç ï¼‰æŒ‡å‘ test/app.js ç¬¬ 18 è¡Œï¼Œå³ `GET /auth` è¿™ä¸ªè·¯ç”±ã€‚å†å¾€ä¸Šçœ‹ï¼Œé»„è‰²çš„å°å—ï¼ˆå³ C++ ä»£ç ï¼‰ node::crypto::PBKDF2 å ç”¨äº†å¤§é‡çš„ CPU æ—¶é—´ã€‚\n\n**è§£å†³æ–¹æ³•**ï¼šå°†åŒæ­¥æ”¹ä¸ºå¼‚æ­¥ï¼Œå³å°† crypto.pbkdf2Sync æ”¹ä¸º crypto.pbkdf2ã€‚ä¿®æ”¹å¦‚ä¸‹ï¼š\n\n```js\napp.route({ method: 'GET', path: '/auth', async controller (ctx) {\n  const username = ctx.query.username || 'test'\n  const password = ctx.query.password || 'test'\n\n  if (!users[username]) {\n    ctx.throw(400)\n  }\n  const hash = await new Promise((resolve, reject) => {\n    crypto.pbkdf2(password, users[username].salt, 10000, 64, 'sha512', (err, derivedKey) => {\n      if (err) {\n        return reject(err)\n      }\n      resolve(derivedKey.toString('hex'))\n    })\n  })\n\n  if (users[username].hash === hash) {\n    ctx.status = 204\n  } else {\n    ctx.throw(403)\n  }\n}})\n```\n\nç”¨ ab é‡æ–°å‹æµ‹ï¼Œç»“æœç”¨äº† 16sã€‚é‡æ–°ç”Ÿæˆçš„ç«ç„°å›¾å¦‚ä¸‹ï¼š\n\n![flamegraph2.svg](/img/2024-04-22-FlameGraph/1.1.2.png)\n\n**å¯ä»¥çœ‹å‡º**ï¼šåªæœ‰åœ¨å·¦ä¾§æçª„çš„ç»¿è‰²å°å—å¯ä»¥çœ‹åˆ° JavaScript ä»£ç ï¼Œçº¢è‰²çš„éƒ¨åˆ†æˆ‘ä»¬ä¸å…³å¿ƒä¹Ÿæ— æ³•ä¼˜åŒ–ã€‚é‚£ä¹ˆï¼Œä¸ºä»€ä¹ˆå¼‚æ­¥æ¯”åŒæ­¥çš„ QPS è¦é«˜å‘¢ï¼ŸåŸå› æ˜¯ Node.js åº•å±‚çš„ libuv ç”¨äº†å¤šä¸ªçº¿ç¨‹è¿›è¡Œè®¡ç®—ï¼Œè¿™é‡Œå°±ä¸å†æ·±å…¥ä»‹ç»äº†ã€‚\n\nsvg ç«ç„°å›¾çš„å…¶ä»–å°æŠ€å·§å¦‚ä¸‹ï¼š\n\n1. å•å‡»ä»»æ„ä¸€ä¸ªå°å—å³å¯å±•å¼€ï¼Œå³è¢«å•å‡»çš„å°å—å®½åº¦å˜å®½ï¼Œå®ƒçš„å­å‡½æ•°ä¹ŸæŒ‰æ¯”ä¾‹å˜å®½ï¼Œæ–¹ä¾¿æŸ¥çœ‹ã€‚\n2. å¯å•å‡» svg å³ä¸Šè§’çš„ search æŒ‰é’®è¿›è¡Œæœç´¢ï¼Œè¢«æœç´¢çš„å…³é”®è¯ä¼šé«˜äº®æ˜¾ç¤ºï¼Œåœ¨æœ‰ç›®çš„åœ°æŸ¥æ‰¾æŸä¸ªå‡½æ•°æ—¶æ¯”è¾ƒæœ‰ç”¨ã€‚\n\n## 1.1.3 çº¢è“å·®åˆ†ç«ç„°å›¾\n\nè™½ç„¶æˆ‘ä»¬æœ‰äº†ç«ç„°å›¾ï¼Œä½†è¦å¤„ç†æ€§èƒ½å›é€€é—®é¢˜ï¼Œè¿˜éœ€è¦åœ¨ä¿®æ”¹ä»£ç å‰åçš„ç«ç„°å›¾ä¹‹é—´ï¼Œä¸æ–­åˆ‡æ¢å’Œå¯¹æ¯”ï¼Œæ¥æ‰¾å‡ºé—®é¢˜æ‰€åœ¨ï¼Œå¾ˆä¸æ–¹ä¾¿ã€‚äºæ˜¯ [Brendan D. Gregg](/img/2024-04-22-FlameGraph/http://www.brendangregg.com/index.html) åˆå‘æ˜äº†çº¢è“å·®åˆ†ç«ç„°å›¾ï¼ˆRed/Blue Differential Flame Graphsï¼‰ã€‚\n\n**å¦‚ä¸‹æ‰€ç¤º**ï¼šçº¢è‰²è¡¨ç¤ºå¢é•¿ï¼Œè“è‰²è¡¨ç¤ºè¡°å‡ã€‚\n\n![flamegraph3.svg](/img/2024-04-22-FlameGraph/1.1.3.png)\n\nçº¢è“å·®åˆ†ç«ç„°å›¾çš„å·¥ä½œåŸç†å¦‚ä¸‹ï¼š\n\n1. æŠ“å–ä¿®æ”¹å‰çš„æ ˆ profile1 æ–‡ä»¶ã€‚\n2. æŠ“å–ä¿®æ”¹åçš„æ ˆ profile2 æ–‡ä»¶ã€‚\n3. ä½¿ç”¨ profile2 æ¥ç”Ÿæˆç«ç„°å›¾ï¼Œè¿™æ ·æ ˆå¸§çš„å®½åº¦å°±æ˜¯ä»¥ profile2 æ–‡ä»¶ä¸ºåŸºå‡†çš„ã€‚\n4. ä½¿ç”¨ profile2 - profile1 çš„å·®å¼‚æ¥å¯¹ç«ç„°å›¾é‡æ–°ä¸Šè‰²ã€‚ä¸Šè‰²çš„åŸåˆ™æ˜¯ï¼šå¦‚æœæ ˆå¸§åœ¨ profile2 ä¸­å‡ºç°å‡ºç°çš„æ¬¡æ•°æ›´å¤šï¼Œåˆ™æ ‡ä¸ºçº¢è‰²ï¼Œå¦åˆ™æ ‡ä¸ºè“è‰²ã€‚è‰²å½©æ˜¯æ ¹æ®ä¿®æ”¹å‰åçš„å·®å¼‚æ¥å¡«å……çš„ã€‚\n\nè¿™æ ·ï¼Œé€šè¿‡çº¢è“å·®åˆ†ç«ç„°å›¾ï¼Œæˆ‘ä»¬å°±å¯ä»¥æ¸…æ¥šåœ°çœ‹åˆ°ç³»ç»Ÿæ€§èƒ½çš„å·®å¼‚ä¹‹å¤„ã€‚\n\nç”Ÿæˆçº¢è“å·®åˆ†ç«ç„°å›¾çš„æµç¨‹å¦‚ä¸‹ï¼š\n\n1. ä¿®æ”¹ä»£ç å‰è¿è¡Œï¼š\n\n   ```sh\n   $ sudo perf record -F 99 -p <PID> -g -- sleep 30\n   $ sudo chown root /tmp/perf-<PID>.map\n   $ sudo perf script > perf_before.stacks\n   ```\n\n2. ä¿®æ”¹ä»£ç åè¿è¡Œï¼š\n\n   ```sh\n   $ sudo perf record -F 99 -p <PID> -g -- sleep 30\n   $ sudo chown root /tmp/perf-<PID>.map\n   $ sudo perf script > perf_after.stacks\n   ```\n\n3. å°† profile æ–‡ä»¶è¿›è¡ŒæŠ˜å ï¼ˆfoldï¼‰ï¼Œç„¶åç”Ÿæˆå·®åˆ†ç«ç„°å›¾ï¼š\n\n   ```sh\n   $ ~/FlameGraph/stackcollapse-perf.pl ~/perf_before.stacks > perf_before.folded\n   $ ~/FlameGraph/stackcollapse-perf.pl ~/perf_after.stacks > perf_after.folded\n   $ ./FlameGraph/difffolded.pl perf_before.folded perf_after.folded | ./FlameGraph/flamegraph.pl > flamegraph_diff.svg\n   ```\n\n**å¦‚ä¸Šç¼ºç‚¹æ˜¯**ï¼šå¦‚æœä¸€ä¸ªä»£ç æ‰§è¡Œè·¯å¾„å®Œå…¨æ¶ˆå¤±äº†ï¼Œé‚£ä¹ˆåœ¨ç«ç„°å›¾ä¸­å°±æ‰¾ä¸åˆ°åœ°æ–¹æ¥æ ‡æ³¨è“è‰²ï¼Œæˆ‘ä»¬åªèƒ½çœ‹åˆ°å½“å‰çš„ CPU ä½¿ç”¨æƒ…å†µï¼Œå´ä¸çŸ¥é“ä¸ºä»€ä¹ˆä¼šå˜æˆè¿™æ ·ã€‚\n\nä¸€ç§è§£å†³åŠæ³•æ˜¯ï¼šç”Ÿæˆä¸€ä¸ªç›¸åçš„å·®åˆ†ç«ç„°å›¾ï¼Œå³åŸºäº profile1 ç”Ÿæˆ profile1 - profile2 çš„å·®åˆ†ç«ç„°å›¾ã€‚å¯¹åº”å‘½ä»¤å¦‚ä¸‹ï¼š\n\n```sh\n$ ./FlameGraph/difffolded.pl perf_after.folded perf_before.folded | ./FlameGraph/flamegraph.pl --negate > flamegraph_diff2.svg\n```\n\nå…¶ä¸­ï¼Œ--negate ç”¨äºé¢ å€’çº¢/è“é…è‰²ã€‚æœ€ç»ˆæˆ‘ä»¬å¾—åˆ°ï¼š\n\n- flamegraph_diff.svgï¼šå®½åº¦æ˜¯ä»¥ä¿®æ”¹å‰çš„ profile æ–‡ä»¶ä¸ºåŸºå‡†ï¼Œé¢œè‰²è¡¨æ˜å°†è¦å‘ç”Ÿçš„æƒ…å†µã€‚\n- flamegraph_diff2.svgï¼šå®½åº¦æ˜¯ä»¥ä¿®æ”¹åçš„ profile æ–‡ä»¶ä¸ºåŸºå‡†ï¼Œé¢œè‰²è¡¨æ˜å·²ç»å‘ç”Ÿçš„æƒ…å†µã€‚\n\næ€»ä¹‹ï¼Œçº¢è“å·®åˆ†ç«ç„°å›¾å¯èƒ½åªåœ¨ä»£ç å˜åŒ–ä¸å¤§çš„æƒ…å†µä¸‹ä½¿ç”¨æ—¶æ•ˆæœæ˜æ˜¾ï¼Œåœ¨ä»£ç å˜åŒ–è¾ƒå¤§çš„æƒ…å†µä¸‹ä½¿ç”¨æ—¶æ•ˆæœå¯èƒ½å°±ä¸æ˜æ˜¾äº†ã€‚\n\n## 1.1.4 å‚è€ƒé“¾æ¥\n\n- https://lidaohang.gitbooks.io/quick_location/content/huo-yan-tu/cpuji-bie-huo-yan-tu/hong-lan-cha-fen-huo-yan-tu.html\n- https://yunong.io/2015/11/23/generating-node-js-flame-graphs/\n- http://www.brendangregg.com/perf.html\n- http://www.brendangregg.com/blog/2014-09-17/node-flame-graphs-on-linux.html\n- https://linux.cn/article-4670-1.html\n- http://www.brendangregg.com/blog/2014-11-09/differential-flame-graphs.html\n- http://www.ruanyifeng.com/blog/2017/09/flame-graph.html\n","tags":["æ€§èƒ½æµ‹è¯•","ç«ç„°å›¾","pref"]},{"title":"Linux æ€§èƒ½è°ƒä¼˜åŸºç¡€ï¼štop","url":"/2024/04/07/2024-04-07-linux tracing basis/","content":"\ntop å‘½ä»¤æ˜¯ linux ä¸‹å¸¸ç”¨çš„æ€§èƒ½åˆ†æå·¥å…·ï¼Œèƒ½å¤Ÿå®æ—¶æ˜¾ç¤ºç³»ç»Ÿä¸­å„ä¸ªè¿›ç¨‹çš„èµ„æºå ç”¨ä½¿ç”¨æƒ…å†µï¼Œç±»ä¼¼äº windos çš„ä»»åŠ¡çª—å£ã€‚\n\n## top ç†è®º\n\n```shell\n#top - 16:55:39 up 220 days,  1:16,  4 users,  load average: 299.05, 217.84, 106.90\nTasks: 3355 total,  12 running, 3339 sleeping,   3 stopped,   1 zombie\n%Cpu(s): 40.7 us, 38.9 sy,  0.0 ni,  0.1 id,  0.0 wa, 20.1 hi,  0.2 si,  0.0 st\nMiB Mem : 257336.1 total,  17260.1 free,  77063.5 used, 163012.4 buff/cache\nMiB Swap:  32768.0 total,  19075.1 free,  13692.9 used.  42491.5 avail Mem\n\n    PID USER      PR  NI    VIRT    RES    SHR S  %CPU  %MEM     TIME+ COMMAND\n```\n\nç»Ÿè®¡ä¿¡æ¯åŒºå‰äº”è¡Œæ˜¯ç³»ç»Ÿæ•´ä½“çš„ç»Ÿè®¡ä¿¡æ¯ã€‚ç¬¬ä¸€è¡Œæ˜¯ä»»åŠ¡é˜Ÿåˆ—ä¿¡æ¯ï¼ŒåŒ uptime å‘½ä»¤çš„æ‰§è¡Œç»“æœã€‚å…¶å†…å®¹å¦‚ä¸‹ï¼š\n\n|å†…å®¹|è§£é‡Š|\n|--|--|\n|16:55:39|å½“å‰æ—¶é—´|\n|up 220 days|ç³»ç»Ÿè¿è¡Œæ—¶é—´|\n|4 users|å½“å‰ç™»å½•ç”¨æˆ·æ•°|\n|load average: 299.05, 217.84, 106.90|ç³»ç»Ÿè´Ÿè½½ï¼Œå³ä»»åŠ¡é˜Ÿåˆ—å¹³å‡é•¿åº¦ã€‚åˆ†åˆ«ä¸º 1ã€5ã€15 min å‰åˆ°ç°åœ¨å¹³å‡å€¼|\n\nç¬¬äºŒã€ä¸‰è¡Œä¸ºè¿›ç¨‹å’Œ CPU çš„ä¿¡æ¯ã€‚å½“æœ‰å¤šä¸ª CPU æ—¶ï¼Œè¿™äº›å†…å®¹å¯èƒ½ä¼šè¶…è¿‡ä¸¤è¡Œã€‚å†…å®¹å¦‚ä¸‹ï¼š\n\n|å†…å®¹|è§£é‡Š|\n|--|--|\n|Tasks: 3355 total|è¿›ç¨‹æ€»æ•°[é”®å…¥ H å¯æŸ¥çœ‹çº¿ç¨‹æ•°]|\n|12 running, 3339 sleeping, 3 stopped|æ­£åœ¨è¿è¡Œçš„è¿›ç¨‹ã€ç¡çœ è¿›ç¨‹ã€åœæ­¢çš„è¿›ç¨‹|\n|1 zombie|åƒµå°¸è¿›ç¨‹æ•°|\n|%Cpu(s): 40.7 us, 38.9 sy|ç”¨æˆ·ç©ºé—´å ç”¨ CPU ç™¾åˆ†æ¯”ã€å†…æ ¸ç©ºé—´å ç”¨ CPU ç™¾åˆ†æ¯”|\n|0.0 ni, 0.1 id|ç”¨æˆ·è¿›ç¨‹ç©ºé—´å†…æ”¹å˜è¿›ç¨‹ä¼˜å…ˆçº§å ç”¨ CPUã€ç©ºé—² CPU ç™¾åˆ†æ¯”|\n|0.0 wa, 20.1 hi, 0.2 si, 0.0 st|ç­‰å¾… IO çš„ CPU æ—¶é—´ç™¾åˆ†æ¯”ï¼Œæœ€åä¸‰ä¸ªæ˜¯ä¸­æ–­è¯·æ±‚ç›¸å…³|\n\nå€’æ•°ç¬¬äºŒã€ä¸‰è¡Œä¸ºå†…å­˜ç›¸å…³ä¿¡æ¯ï¼š\n\n|å†…å®¹|è§£é‡Š|\n|--|--|\n|MiB Mem|è¡¨ç¤ºç³»ç»Ÿå†…å­˜çš„ä½¿ç”¨æƒ…å†µ|\n|MiB Swap|è¡¨ç¤ºäº¤æ¢ç©ºé—´ï¼ˆè™šæ‹Ÿå†…å­˜ï¼‰çš„ä½¿ç”¨æƒ…å†µ|\n|xxx total, xxx free, xxx used|åˆ†åˆ«æ˜¯å†…å­˜æ€»é‡ã€ç©ºé—²å†…å­˜æ€»é‡ã€ä½¿ç”¨å†…å­˜æ€»é‡|\n|xxx buff/cache|è¢«ç”¨ä½œç¼“å†²æˆ–ç¼“å­˜çš„å†…å­˜é‡|\n|xxx avail Mem|å¯ç”¨çš„äº¤æ¢ç©ºé—´|\n\n- buffe [Difference between buffer and cache](http://wiki.answers.com/Q/Difference_between_buffer_and_cache)\n\n>ç”±ç¡¬ä»¶è®¾å¤‡æˆ–ç¨‹åºå…±äº«çš„æ•°æ®åŒºåŸŸç§°ä¸ºç¼“å†²åŒºã€‚å®ƒä»¬ä»¥ä¸åŒçš„é€Ÿåº¦è¿è¡Œï¼Œæˆ–è€…æœ‰ä¸åŒçš„ä¼˜å…ˆé¡ºåºã€‚ç¼“å†²åŒºå…è®¸æ¯ä¸ªè®¾å¤‡æˆ–è¿›ç¨‹åœ¨æ²¡æœ‰å…¶ä»–è®¾å¤‡æˆ–è¿›ç¨‹é˜»ç¢çš„æƒ…å†µä¸‹è¿è¡Œã€‚ä¸ºäº†ä½¿ç¼“å†²åŒºæœ‰æ•ˆï¼Œç¼“å†²åŒºè®¾è®¡å™¨éœ€è¦è€ƒè™‘ç¼“å†²åŒºçš„å¤§å°ã€‚ä¸ç¼“å­˜ä¸€æ ·ï¼Œç¼“å†²åŒºæ˜¯ä¸€ä¸ªâ€œä¸­ç‚¹ä¿å­˜ä½ç½®â€ï¼Œä½†å®ƒçš„å­˜åœ¨å¹¶ä¸æ˜¯ä¸ºäº†åŠ å¿«æ´»åŠ¨çš„é€Ÿåº¦ï¼Œè€Œæ˜¯ä¸ºäº†æ”¯æŒå•ç‹¬æ´»åŠ¨çš„åè°ƒã€‚\n\n>è¿™ä¸ªæœ¯è¯­ä¸ä»…ç”¨äºç¼–ç¨‹ï¼Œä¹Ÿç”¨äºç¡¬ä»¶ã€‚åœ¨ç¼–ç¨‹ä¸­ï¼Œç¼“å†²æœ‰æ—¶éœ€è¦ä»æ•°æ®çš„æœ€ç»ˆé¢„æœŸä½ç½®ç­›é€‰æ•°æ®ï¼Œä»¥ä¾¿åœ¨ç§»åŠ¨åˆ°å¸¸è§„æ–‡ä»¶æˆ–æ•°æ®åº“ä¹‹å‰å¯¹æ•°æ®è¿›è¡Œç¼–è¾‘æˆ–å¤„ç†ã€‚\n\n- cached\n\n>é«˜é€Ÿç¼“å†²å­˜å‚¨å™¨æ˜¯éšæœºå­˜å–å­˜å‚¨å™¨ï¼ˆRAMï¼‰çš„ä¸€ç§ã€‚è®¡ç®—æœºå¾®å¤„ç†å™¨å¯¹é«˜é€Ÿç¼“å†²å­˜å‚¨å™¨çš„è®¿é—®é€Ÿåº¦æ¯”æ™®é€š RAM çš„è®¿é—®é€Ÿåº¦æ›´å¿«ã€‚å°±åƒå¾®å¤„ç†å™¨å¤„ç†æ•°æ®ä¸€æ ·ï¼Œå®ƒé¦–å…ˆåœ¨é«˜é€Ÿç¼“å†²å­˜å‚¨å™¨ä¸­æŸ¥æ‰¾ï¼Œå¦‚æœåœ¨é‚£é‡Œï¼Œå®ƒä¼šä»ä¹‹å‰è¯»å–çš„æ•°æ®ä¸­æ‰¾åˆ°æ•°æ®ï¼Œå®ƒä¸éœ€è¦ä»æ›´å¤§çš„å†…å­˜ä¸­è¿›è¡Œæ›´è€—æ—¶çš„æ•°æ®è¯»å–ã€‚\n\n>æœ‰æ—¶ï¼Œé«˜é€Ÿç¼“å†²å­˜å‚¨å™¨æ˜¯æŒ‰ç…§ä¸å¾®å¤„ç†å™¨çš„æ¥è¿‘ç¨‹åº¦å’Œä¾¿åˆ©ç¨‹åº¦æ¥æè¿°çš„ã€‚L1 é«˜é€Ÿç¼“å­˜ä¸å¾®å¤„ç†å™¨ä½äºåŒä¸€èŠ¯ç‰‡ä¸Šã€‚\n\n>é™¤äº†é«˜é€Ÿç¼“å­˜ä¹‹å¤–ï¼ŒRAM æœ¬èº«ä¹Ÿæ˜¯ä¸€ç§ç”¨äºç¡¬ç›˜å­˜å‚¨çš„é«˜é€Ÿç¼“å­˜ï¼Œå› ä¸ºå½“ä½ æ‰“å¼€è®¡ç®—æœºå¹¶åŠ è½½æ­£åœ¨åŠ è½½çš„æ“ä½œç³»ç»Ÿæ—¶ï¼Œæ‰€æœ‰ RAM çš„å†…å®¹éƒ½ä¼šå…ˆåˆ°è¾¾ç¡¬ç›˜ï¼Œç¨åå½“ä½ å¯åŠ¨æ–°åº”ç”¨ç¨‹åºå¹¶è®¿é—®æ–°æ•°æ®ã€‚RAM è¿˜åŒ…å«ä¸€ä¸ªç§°ä¸ºç£ç›˜ç¼“å­˜çš„ç‰¹æ®ŠåŒºåŸŸï¼Œè¯¥åŒºåŸŸç”±æœ€è¿‘ä»ç¡¬ç›˜è¯»å–çš„æ•°æ®ç»„æˆã€‚\n\næœ€å 1 è¡Œåˆ™æ˜¯è¿›ç¨‹ç›¸å…³çš„èµ„æºå ç”¨ä¿¡æ¯:\n\n- PIDï¼šè¿›ç¨‹IDã€‚ç³»ç»Ÿä¸­æ¯ä¸ªè¿›ç¨‹éƒ½æœ‰ä¸€ä¸ªå”¯ä¸€çš„IDå·ï¼Œç§°ä¸ºè¿›ç¨‹IDã€‚\n- USERï¼šè¿›ç¨‹çš„æ‹¥æœ‰è€…ã€‚æ˜¾ç¤ºå¯åŠ¨è¿™ä¸ªè¿›ç¨‹çš„ç”¨æˆ·åç§°ã€‚\n- PRï¼šè¿›ç¨‹çš„ä¼˜å…ˆçº§ã€‚å†…æ ¸æ ¹æ®è¿™ä¸ªå€¼æ¥å†³å®šè¿›ç¨‹çš„æ‰§è¡Œä¼˜å…ˆçº§ã€‚\n- NIï¼šè¿›ç¨‹çš„niceå€¼ã€‚è¿™æ˜¯ä¸€ä¸ªç”¨æˆ·æ§åˆ¶çš„ä¸ºè¿›ç¨‹è®¾ç½®çš„ä¼˜å…ˆçº§çš„å€¼ã€‚æ•°å€¼å¯ä»-20ï¼ˆæœ€é«˜ä¼˜å…ˆçº§ï¼‰åˆ°19ï¼ˆæœ€ä½ä¼˜å…ˆçº§ï¼‰ã€‚\n- VIRTï¼šè™šæ‹Ÿå†…å­˜ä½¿ç”¨é‡ã€‚è¿›ç¨‹ä½¿ç”¨çš„æ‰€æœ‰è™šæ‹Ÿå†…å­˜çš„å’Œï¼ŒåŒ…æ‹¬è¿›ç¨‹ä½¿ç”¨çš„åº“ï¼Œä»¥åŠæ˜ å°„çš„æ–‡ä»¶å’Œäº¤æ¢ç©ºé—´çš„å¤§å°ã€‚\n- RESï¼šå¸¸é©»å†…å­˜å¤§å°ã€‚è¿™æ˜¯è¿›ç¨‹å½“å‰ä½¿ç”¨çš„ã€æœªè¢«è°ƒå‡ºçš„ç‰©ç†å†…å­˜é‡ï¼Œå•ä½é€šå¸¸æ˜¯KBã€‚\n- SHRï¼šå…±äº«å†…å­˜å¤§å°ã€‚è¿™æ˜¯å¤šä¸ªè¿›ç¨‹å¯èƒ½å…±äº«çš„å†…å­˜éƒ¨åˆ†ï¼Œé€šå¸¸åŒ…æ‹¬åº“ç­‰ã€‚\n- Sï¼šè¿›ç¨‹çš„çŠ¶æ€ã€‚é€šå¸¸çš„çŠ¶æ€æœ‰ï¼š\n  - Sï¼ˆç¡çœ ä¸­ï¼‰ï¼šç­‰å¾…äº‹ä»¶å®Œæˆï¼ˆå¦‚è¾“å…¥/è¾“å‡ºå®Œæˆï¼‰ã€‚\n  - Rï¼ˆè¿è¡Œä¸­ï¼‰ï¼šæ­£åœ¨è¿è¡Œæˆ–åœ¨è¿è¡Œé˜Ÿåˆ—ä¸­ç­‰å¾…ã€‚\n  - Tï¼ˆåœæ­¢ï¼‰ï¼šè¿›ç¨‹å·²åœæ­¢æ‰§è¡Œã€‚\n  - Zï¼ˆåƒµå°¸ï¼‰ï¼šè¿›ç¨‹å·²ç»ˆæ­¢ï¼Œä½†å…¶çˆ¶è¿›ç¨‹å°šæœªæ”¶åˆ°å…¶ç»ˆæ­¢çŠ¶æ€ã€‚\n- %CPUï¼šCPUä½¿ç”¨ç‡ã€‚å±•ç¤ºè¿›ç¨‹ä½¿ç”¨çš„CPUæ—¶é—´ç™¾åˆ†æ¯”ï¼Œè¿™ä¸ªå€¼æ˜¯åœ¨æœ€åä¸€æ¬¡æ›´æ–°çš„æ—¶å€™æ ·æœ¬é‡ŒCPUä½¿ç”¨æƒ…å†µçš„è¿‘ä¼¼å€¼ï¼Œå¯èƒ½è¶…è¿‡100%åœ¨å¤šæ ¸CPUçš„ç³»ç»Ÿã€‚\n- %MEMï¼šå†…å­˜ä½¿ç”¨ç‡ã€‚è¯¥è¿›ç¨‹ä½¿ç”¨çš„ç‰©ç†å†…å­˜å’Œæ€»ç‰©ç†å†…å­˜çš„ç™¾åˆ†æ¯”ã€‚\n- TIME+ï¼šè¿›ç¨‹ä½¿ç”¨çš„CPUæ—¶é—´æ€»è®¡ï¼Œæ ¼å¼é€šå¸¸ä¸ºåˆ†é’Ÿ:ç§’ã€‚\n- COMMANDï¼šå¯åŠ¨è¿›ç¨‹çš„å‘½ä»¤åç§°ã€‚\n\n## top æŠ€å·§\n\nç»ˆç«¯æ‰§è¡Œ top å‘½ä»¤ä¹‹åã€ä¹Ÿå¯åæ¥ä¸€äº›é€‰é¡¹ï¼Œæ¯”å¦‚ top -p 1 åªç›‘æ§ init è¿›ç¨‹ï¼Œtop -u root åªæ˜¾ç¤º root è¿è¡Œè¿›ç¨‹ç­‰ç­‰ã€‘ï¼Œå¯ä»¥æ•²å‡»å¦‚ä¸‹æŒ‰é”®ï¼Œå®ç°ä¸åŒåŠŸèƒ½ï¼š\n\n- hï¼šè·å– top çš„å‘½ä»¤å¸®åŠ©\n- 1ï¼ˆæ•°å­—1ï¼‰ï¼šåˆ—å‡ºæ‰€æœ‰çš„å•ä¸ª CPU è´Ÿè½½æƒ…å†µ\n- zï¼štop æ˜¾ç¤ºé¢œè‰²\n  - xï¼šç±»ä¼¼é«˜äº®æ˜¾ç¤ºï¼Œåœ¨ z æ¨¡å¼ä¸‹ä½¿ç”¨\n- P[å¤§å†™]ï¼šæŒ‰ CPU å ç”¨é«˜ä½é¡ºåºåˆ—å‡ºç¨‹åº\n- M[å¤§å†™]ï¼šæŒ‰å†…å­˜å ç”¨é«˜ä½é¡ºåºåˆ—å‡ºç¨‹åº\n- cï¼šæ˜¾ç¤ºè¿›ç¨‹å‘½ä»¤çš„å…¨è·¯å¾„ä¸å‚æ•°\n- Hï¼šæ˜¾ç¤ºçº¿ç¨‹ï¼Œé»˜è®¤åªæ˜¾ç¤ºè¿›ç¨‹\n- top é»˜è®¤æŒ‰ cpu å ç”¨æ’åºï¼ŒæŒ‰Fï¼ˆå¤§å†™ï¼‰å³å¯é€‰æ‹©ç›¸åº”æ’åº\n- dï¼štop é»˜è®¤åˆ·æ–°æ—¶é—´æ˜¯ 3s ï¼Œä½¿ç”¨dé”®å¯è‡ªå®šä¹‰åˆ·æ–°æ—¶é—´\n- top é€‰æ‹©åˆ—æ’åº[é«˜åˆ°ä½]çš„æ–¹æ³•[åœ¨zé¢œè‰²å’Œxé«˜äº®æ¨¡å¼ä¸‹æ˜¾ç¤ºæ•ˆæœæ˜æ˜¾]ï¼š\n  - shift+<ï¼šå·¦é€‰\n  - shift+>ï¼šå³é€‰\n- fï¼šå¯ä»¥æŒ‡å®š top æ˜¾ç¤ºçš„å†…å®¹ï¼Œå¦‚ ppidã€swap ç­‰éƒ½å¯ä»¥é€‰æ‹©æ˜¾ç¤º\n  - æ˜¾ç¤º Swap åˆ©ç”¨ç‡ï¼šæŒ‰ f é”®ï¼Œç„¶åæŒ‰ p é”®ï¼Œå›è½¦å³å¯çœ‹åˆ° Swap çŠ¶æ€\n- kï¼šè¾“å…¥ k ä¹‹åå¯ä»¥ kill æ‰æŒ‡å®šçš„è¿›ç¨‹\n- Aï¼šåˆ†ç±»æ˜¾ç¤ºå„ç§ç³»ç»Ÿèµ„æºé«˜çš„è¿›ç¨‹ã€‚å¯ç”¨äºå¿«é€Ÿè¯†åˆ«ç³»ç»Ÿä¸Šçš„æ€§èƒ½è¦æ±‚æé«˜çš„ä»»åŠ¡ï¼Œæ¨èä½¿ç”¨\n- W[å¤§å†™]:å°†å½“å‰è®¾ç½®å†™å…¥ ~/.toprc æ–‡ä»¶ä¸­ã€‚è¿™æ˜¯å†™ top é…ç½®æ–‡ä»¶çš„æ¨èæ–¹æ³•\n\n## å‚è€ƒ\n\n- [SourceWiki-æ€§èƒ½è°ƒä¼˜-top.md](https://github.com/linuxwiki/SourceWiki/blob/master/%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98/top.md)\n- [é¸Ÿå“¥Linuxç§æˆ¿èœ](http://linux.vbird.org/) \n- [top - Process Activity Command](http://www.cyberciti.biz/tips/top-linux-monitoring-tools.html)\n- [Learning Linux Commands: top](http://how-to.linuxcareer.com/learning-linux-commands-top)","tags":["linux","æ€§èƒ½æµ‹è¯•"]},{"title":"é‡åŒ–ç´¢å¼•ï¼šProduct Quantization ä¹˜ç§¯é‡åŒ–","url":"/2024/04/01/2024-04-01-Product Quantization/","content":"\n## å¼•è¨€\n\nProduct Quantizationï¼Œå›½å†…æœ‰äººç›´è¯‘ä¸ºä¹˜ç§¯é‡åŒ–ï¼Œè¿™é‡Œçš„ä¹˜ç§¯é‡åŒ–æ˜¯æŒ‡ç¬›å¡å°”ç§¯ï¼ˆCartesian productï¼‰ï¼Œæ„æ€æ˜¯æŒ‡æŠŠåŸå…ˆçš„å‘é‡ç©ºé—´åˆ†è§£ä¸ºè‹¥å¹²ä¸ªä½ç»´å‘é‡ç©ºé—´çš„ç¬›å¡å°”ç§¯ï¼Œå¹¶å¯¹åˆ†è§£å¾—åˆ°çš„ä½çº¬å‘é‡ç©ºé—´çš„åˆ†åˆ«åšé‡åŒ–ï¼ˆquantizationï¼‰ã€‚è¿™æ ·æ¯ä¸ªå‘é‡å°±èƒ½ç”±å¤šä¸ªä½çº¬ç©ºé—´çš„é‡åŒ– code ç»„åˆè¡¨ç¤ºã€‚ä¸ºç®€æ´æè¿°èµ·è§ï¼Œä¸‹æ–‡ç”¨ PQ ä½œä¸º Product Quantization çš„ç®€ç§°ã€‚\n\n> The idea is to decomposes the space into a Cartesian product of low dimensional subspaces and to quantize each subspace separately. A vector is represented by a short code composed of its subspace quantization indices.\n\nè¿‘å‡ å¹´ï¼Œæ·±åº¦å­¦ä¹ æŠ€æœ¯è¢«å¹¿æ³›ç”¨äºå›¾åƒè¯†åˆ«ã€è¯­éŸ³è¯†åˆ«ã€è‡ªç„¶è¯­è¨€å¤„ç†ç­‰é¢†åŸŸï¼Œèƒ½å¤ŸæŠŠæ¯ä¸ªå®ä½“ï¼ˆå›¾åƒã€è¯­éŸ³ã€æ–‡æœ¬ï¼‰è½¬æ¢ä¸ºå¯¹åº”çš„ embedding å‘é‡ã€‚ä¸€èˆ¬æ¥è¯´ï¼Œç›¸ä¼¼çš„å®ä½“è½¬æ¢å¾—åˆ°çš„ embedding å‘é‡ä¹Ÿæ˜¯ç›¸ä¼¼çš„ã€‚å¯¹äºç›¸ä¼¼æœç´¢é—®é¢˜ï¼Œæœ€ç®€å•çš„æƒ³æ³•æ˜¯æš´åŠ›ç©·ä¸¾æ³•ï¼Œå¦‚æœå…¨éƒ¨å®ä½“çš„ä¸ªæ•°æ˜¯ Nï¼ŒN æ˜¯åƒä¸‡é‡çº§ç”šè‡³æ˜¯ä¸Šäº¿çš„è§„æ¨¡ï¼Œæ¯ä¸ªå®ä½“å¯¹åº”çš„å‘é‡æ˜¯ Dï¼Œé‚£ä¹ˆå½“è¦ä»è¿™ä¸ªå®ä½“é›†åˆä¸­å¯»æ‰¾æŸä¸ªå®ä½“çš„ç›¸ä¼¼å®ä½“ï¼Œæš´åŠ›ç©·ä¸¾çš„è®¡ç®—å¤æ‚åº¦æ˜¯ O(ND)ï¼Œè¿™æ˜¯ä¸€ä¸ªéå¸¸å¤§çš„è®¡ç®—é‡ï¼Œè¯¥æ–¹æ³•æ˜¾ç„¶ä¸å¯å–ã€‚æ‰€ä»¥å¯¹å¤§æ•°æ®é‡ä¸‹é«˜ç»´åº¦æ•°æ®çš„ç›¸ä¼¼æœç´¢åœºæ™¯ï¼Œæˆ‘ä»¬å°±éœ€è¦ä¸€äº›é«˜æ•ˆçš„ç›¸ä¼¼æœç´¢æŠ€æœ¯ï¼Œè€Œ PQ å°±æ˜¯å…¶ä¸­ä¸€ç±»æ–¹æ³•ã€‚\n\n## Product Quantization\n\n### å®šä¹‰\n\nProduct Quantization æ˜¯å°†æ¯ä¸ªæ•°æ®é›†å‘é‡è½¬æ¢ä¸ºçŸ­å†…å­˜é«˜æ•ˆè¡¨ç¤ºï¼ˆç§°ä¸º PQ ä»£ç ï¼‰çš„è¿‡ç¨‹ã€‚ä¸æ˜¯å®Œå…¨ä¿ç•™æ‰€æœ‰å‘é‡ï¼Œè€Œæ˜¯å­˜å‚¨å®ƒä»¬çš„ç®€çŸ­è¡¨ç¤ºã€‚åŒæ—¶ï¼ŒPQ æ˜¯ä¸€ç§æœ‰æŸå‹ç¼©ç®—æ³•ï¼Œé¢„æµ‹ç²¾åº¦è¾ƒä½ï¼Œä½†åœ¨å®é™…åº”ç”¨ä¸­æ•ˆæœè¿˜ä¸é”™ã€‚\n\n>In general, quantization is the process of mapping infinite values to discrete ones.\n\n### è®­ç»ƒ\n\né¦–å…ˆï¼Œè¯¥ç®—æ³•å°†æ¯ä¸ªå‘é‡åˆ’åˆ†ä¸ºå‡ ä¸ªç›¸ç­‰çš„éƒ¨åˆ†â€”â€”å­å‘é‡ã€‚æ‰€æœ‰æ•°æ®é›†å‘é‡çš„å„ä¸ªéƒ¨åˆ†å½¢æˆç‹¬ç«‹çš„å­ç©ºé—´ï¼Œå¹¶åˆ†åˆ«è¿›è¡Œå¤„ç†ã€‚ç„¶åå¯¹å‘é‡çš„æ¯ä¸ªå­ç©ºé—´æ‰§è¡Œèšç±»ç®—æ³•ã€‚é€šè¿‡è¿™æ ·åšï¼Œåœ¨æ¯ä¸ªå­ç©ºé—´ä¸­åˆ›å»ºäº†å‡ ä¸ªè´¨å¿ƒã€‚æ¯ä¸ªå­å‘é‡éƒ½ä½¿ç”¨å®ƒæ‰€å±è´¨å¿ƒçš„ ID è¿›è¡Œç¼–ç ã€‚æ­¤å¤–ï¼Œå­˜å‚¨æ‰€æœ‰è´¨å¿ƒçš„åæ ‡ä»¥ä¾›ä»¥åä½¿ç”¨ã€‚\n\n>Subspace centroids are also called quantized vectors.\nIn product quantization, a cluster ID is often referred to as a reproduction value.\n\næ³¨æ„: åœ¨ä¸‹å›¾ä¸­ï¼Œä¸€ä¸ªçŸ©å½¢è¡¨ç¤ºä¸€ä¸ªåŒ…å«å¤šä¸ªå€¼çš„å‘é‡ï¼Œè€Œä¸€ä¸ªæ­£æ–¹å½¢è¡¨ç¤ºä¸€ä¸ªæ•°å­—ã€‚\n\n![é‡åŒ–ç¼–ç ](/img/2024-04-01-Product_Quantization/pho1.jpg)\n\nå› æ­¤ï¼Œå¦‚æœä¸€ä¸ªåŸå§‹å‘é‡è¢«åˆ†æˆ n ä¸ªéƒ¨åˆ†ï¼Œé‚£ä¹ˆå®ƒå°±å¯ä»¥ç”¨ n ä¸ªæ•°å­—è¿›è¡Œç¼–ç â€”â€”æ¯ä¸ªå­å‘é‡çš„å„ä¸ªè´¨å¿ƒçš„ IDã€‚é€šå¸¸ï¼Œä¸ºäº†æ›´æœ‰æ•ˆåœ°ä½¿ç”¨å†…å­˜ï¼Œåˆ›å»ºçš„è´¨å¿ƒ k çš„æ•°ç›®é€šå¸¸è¢«é€‰ä¸º 2 çš„å¹‚ã€‚è¿™æ ·ï¼Œå­˜å‚¨ç¼–ç å‘é‡æ‰€éœ€çš„å†…å­˜æ˜¯ n * log(k) bitsã€‚\n\n>The collection of all centroids inside a subspace is called a codebook. Running n clustering algorithms for all subspaces produces n separate codebooks.\n\n### å‹ç¼©ç¤ºä¾‹\n\nè®¾æƒ³ä¸€ä¸ªå¤§å°ä¸º 1024 çš„å­˜å‚¨æµ®ç‚¹æ•°ï¼ˆ32bitsï¼‰çš„åŸå§‹å‘é‡è¢«åˆ†æˆ n = 8 ä¸ªå­å‘é‡ï¼Œå…¶ä¸­æ¯ä¸ªå­å‘é‡ç”± k = 256 ä¸ªç°‡ä¸­çš„ä¸€ä¸ªè¿›è¡Œç¼–ç ã€‚å› æ­¤ï¼Œç¼–ç å•ä¸ªé›†ç¾¤çš„ ID å°†éœ€è¦ $\\log_2 256=8 bits$ã€‚è®©æˆ‘ä»¬æ¯”è¾ƒä¸¤ç§æƒ…å†µä¸‹å‘é‡è¡¨ç¤ºçš„å†…å­˜å¤§å°:\n\n- åŸå§‹å‘é‡: 1024 * 32 bits = 4096 bytes\n- ç¼–ç å‘é‡: 8 * 8 bits = 8 bytes\n\næœ€ç»ˆçš„å‹ç¼©æ˜¯ 512 å€! è¿™æ˜¯äº§å“é‡åŒ–çš„çœŸæ­£å¨åŠ›ã€‚\n\n![å‹ç¼©ç¤ºä¾‹ï¼šå‘é‡ä¸­çš„æ•°å­—æ˜¾ç¤ºå®ƒå­˜å‚¨äº†å¤šå°‘ä¸ªæ•°å­—](/img/2024-04-01-Product_Quantization/pho2.jpg)\n\nä»¥ä¸‹æ˜¯ä¸€äº›é‡è¦çš„æ³¨æ„äº‹é¡¹ï¼š\n\n- è¯¥ç®—æ³•å¯ä»¥åœ¨ä¸€ä¸ªå‘é‡å­é›†ä¸Šè¿›è¡Œè®­ç»ƒï¼ˆä¾‹å¦‚ï¼Œåˆ›å»ºèšç±»ï¼‰ï¼Œå¹¶ç”¨äºå¦ä¸€ä¸ªå‘é‡å­é›†ï¼šè®­ç»ƒå®Œç®—æ³•åï¼Œå°†ä¼ é€’å¦ä¸€ä¸ªå‘é‡æ•°æ®é›†ï¼Œç„¶åä½¿ç”¨æ¯ä¸ªå­ç©ºé—´å·²æ„é€ çš„è´¨å¿ƒå¯¹æ–°å‘é‡è¿›è¡Œç¼–ç ã€‚\n- é€šå¸¸ï¼Œé€‰æ‹© k-means ä½œä¸ºèšç±»ç®—æ³•ã€‚å®ƒçš„ä¼˜ç‚¹ä¹‹ä¸€æ˜¯é›†ç¾¤çš„æ•°é‡ k æ˜¯ä¸€ä¸ªè¶…å‚æ•°ï¼Œå¯ä»¥æ ¹æ®å†…å­˜ä½¿ç”¨éœ€æ±‚æ‰‹åŠ¨å®šä¹‰ã€‚\n\n### æ¨ç†\n\nä¸ºäº†æ›´å¥½åœ°ç†è§£ï¼Œè®©æˆ‘ä»¬é¦–å…ˆçœ‹çœ‹å‡ ç§æœ´ç´ æ–¹æ³•ï¼Œå¹¶æ‰¾å‡ºå®ƒä»¬çš„ç¼ºç‚¹ã€‚è¿™ä¹Ÿå°†å¸®åŠ©æˆ‘ä»¬è®¤è¯†åˆ°ä¸ºä»€ä¹ˆå®ƒä»¬ä¸åº”è¯¥è¢«æ­£å¸¸ä½¿ç”¨ã€‚\n\n#### æœ´ç´ æ–¹æ¡ˆ\n\nç¬¬ä¸€ç§æœ´ç´ çš„æ–¹æ³•åŒ…æ‹¬é€šè¿‡è¿æ¥æ¯ä¸ªå‘é‡ç›¸åº”çš„è´¨å¿ƒæ¥è§£å‹ç¼©æ‰€æœ‰å‘é‡ã€‚ä¹‹åï¼Œå¯ä»¥è®¡ç®—ä»æŸ¥è¯¢å‘é‡åˆ°æ‰€æœ‰æ•°æ®é›†å‘é‡çš„ L2 è·ç¦»ï¼ˆæˆ–å…¶ä»–åº¦é‡ï¼‰ã€‚æ˜¾ç„¶ï¼Œè¿™ç§æ–¹æ³•æ˜¯å¯è¡Œçš„ï¼Œä½†æ˜¯éå¸¸è€—æ—¶ï¼Œå› ä¸ºè¦å¯¹é«˜ç»´è§£å‹å‘é‡è¿›è¡Œæš´åŠ›æœç´¢å’Œè·ç¦»è®¡ç®—ã€‚\n\nå¦ä¸€ç§å¯èƒ½çš„æ–¹å¼æ˜¯å°†æŸ¥è¯¢å‘é‡åˆ†å‰²æˆå­å‘é‡ï¼Œå¹¶åŸºäºå…¶ PQ ç è®¡ç®—ä»æ¯ä¸ªæŸ¥è¯¢å­å‘é‡åˆ°æ•°æ®åº“å‘é‡çš„å„ä¸ªé‡åŒ–å‘é‡çš„è·ç¦»ä¹‹å’Œã€‚å› æ­¤ï¼Œè¿™é‡Œå†æ¬¡ä½¿ç”¨äº†æš´åŠ›æœç´¢æŠ€æœ¯ï¼Œå¹¶ä¸”è·ç¦»è®¡ç®—ä»ç„¶éœ€è¦åŸå§‹å‘é‡ç»´æ•°çš„çº¿æ€§æ—¶é—´ï¼Œå°±åƒå‰é¢çš„æƒ…å†µä¸€æ ·ã€‚\n\n![è®¡ç®—è¿‘ä¼¼è·ç¦»ï¼Œä»¥æ¬§å‡ é‡Œå¾—åº¦é‡ä¸ºä¾‹](/img/2024-04-01-Product_Quantization/pho3.jpg)\n\nå¦ä¸€ç§å¯èƒ½çš„æ–¹æ³•æ˜¯å°†æŸ¥è¯¢å‘é‡ç¼–ç æˆ PQ ç ã€‚ç„¶åè¿™ä¸ª PQ ç è¢«ç›´æ¥ç”¨æ¥è®¡ç®—åˆ°æ‰€æœ‰å…¶ä»– PQ ç çš„è·ç¦»ã€‚å°†è·ç¦»æœ€çŸ­çš„æ•°æ®é›†å‘é‡ä¸ç›¸åº”çš„ PQ ç ä½œä¸ºæŸ¥è¯¢çš„æœ€è¿‘é‚»ã€‚è¿™ç§æ–¹æ³•æ¯”å‰ä¸¤ç§æ–¹æ³•æ›´å¿«ï¼Œå› ä¸ºå®ƒæ€»æ˜¯è®¡ç®—ä½ç»´ PQ ç ä¹‹é—´çš„è·ç¦»ã€‚ç„¶è€Œï¼ŒPQ ç æ˜¯ç”±ç¾¤é›† ID ç»„æˆçš„ï¼Œè¿™ç§ç¾¤é›† ID æ²¡æœ‰å¤šå°‘è¯­ä¹‰æ„ä¹‰ï¼Œå¯ä»¥çœ‹ä½œæ˜¯ä¸€ä¸ªæ˜ç¡®ç”¨ä½œå®å˜é‡çš„èŒƒç•´å˜é‡ã€‚æ˜¾ç„¶ï¼Œè¿™æ˜¯ä¸€ä¸ªä¸å¥½çš„åšæ³•ï¼Œè¿™ç§æ–¹æ³•å¯èƒ½ä¼šå¯¼è‡´é¢„æµ‹è´¨é‡å·®ã€‚\n\n#### æœ€ä½³æ–¹æ¡ˆ\n\næŸ¥è¯¢å‘é‡è¢«åˆ’åˆ†ä¸ºå­å‘é‡ã€‚å¯¹äºæ¯ä¸ªå­å‘é‡ï¼Œè®¡ç®—åˆ°ç›¸åº”å­ç©ºé—´çš„æ‰€æœ‰è´¨å¿ƒçš„è·ç¦»ã€‚æœ€ç»ˆï¼Œè¯¥ä¿¡æ¯å­˜å‚¨åœ¨è¡¨ d ä¸­ã€‚\n\n![è·å–å­˜å‚¨éƒ¨åˆ†æŸ¥è¯¢å­å‘é‡åˆ°è´¨å¿ƒè·ç¦»çš„è¡¨ d](/img/2024-04-01-Product_Quantization/pho4.jpg)\n\n>Calculated subvector-to-centroid distances are often referred to as partial distances.\n\né€šè¿‡ä½¿ç”¨è¿™ä¸ªå­å‘é‡åˆ°è´¨å¿ƒè·ç¦»è¡¨ dï¼Œå¯ä»¥å¾ˆå®¹æ˜“åœ°é€šè¿‡å…¶ PQ ç è·å¾—ä»æŸ¥è¯¢åˆ°ä»»ä½•æ•°æ®åº“å‘é‡çš„è¿‘ä¼¼è·ç¦»:\n\n1. å¯¹äºæ•°æ®åº“å‘é‡çš„æ¯ä¸ªå­å‘é‡ï¼Œæ‰¾åˆ°æœ€è¿‘çš„è´¨å¿ƒ j (é€šè¿‡ä½¿ç”¨æ¥è‡ª PQ ç çš„æ˜ å°„å€¼) ï¼Œå¹¶è·å¾—ä»è¯¥è´¨å¿ƒåˆ°æŸ¥è¯¢å­å‘é‡ iï¼ˆé€šè¿‡ä½¿ç”¨è®¡ç®—çš„çŸ©é˜µ dï¼‰çš„åè·ï¼ˆpartial distanceï¼‰ d[i][j]ã€‚\n2. æ‰€æœ‰çš„åè·å‡è¢«å¹³æ–¹å¹¶æ±‚å’Œã€‚é€šè¿‡å¯¹è¯¥å€¼æ±‚å¹³æ–¹æ ¹ï¼Œå³å¯è·å¾—è¿‘ä¼¼çš„æ¬§æ°è·ç¦»ã€‚å¦‚æœæ‚¨è¿˜æƒ³çŸ¥é“å¦‚ä½•è·å¾—å…¶ä»–åº¦é‡çš„è¿‘ä¼¼ç»“æœï¼Œè¯·å¯¼èˆªåˆ°â€œå…¶ä»–è·ç¦»åº¦é‡çš„è¿‘ä¼¼å€¼â€éƒ¨åˆ†ã€‚\n\n![åˆ©ç”¨ PQ ç å’Œè·ç¦»è¡¨è®¡ç®—æŸ¥è¯¢åˆ°æ•°æ®åº“å‘é‡çš„è·ç¦»](/img/2024-04-01-Product_Quantization/pho5.jpg)\n\n>Using this method for calculating approximate distances assumes that partial distances d are very close to actual distances a between query and database subvectors.\n\nç„¶è€Œï¼Œè¿™ä¸ªæ¡ä»¶å¯èƒ½ä¸è¢«æ»¡è¶³ï¼Œç‰¹åˆ«æ˜¯å½“æ•°æ®åº“å­å‘é‡ä¸å…¶è´¨å¿ƒä¹‹é—´çš„è·ç¦» c å¾ˆå¤§æ—¶ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œè®¡ç®—ä¼šå¯¼è‡´ç²¾åº¦é™ä½ã€‚\n\n![å·¦è¾¹çš„ä¾‹å­å±•ç¤ºäº†å½“å®é™…è·ç¦»éå¸¸æ¥è¿‘åè·ï¼ˆc å¾ˆå°ï¼‰æ—¶çš„ä¸€ä¸ªå¾ˆå¥½çš„è¿‘ä¼¼æƒ…å†µã€‚åœ¨å³è¾¹ï¼Œæˆ‘ä»¬å¯ä»¥è§‚å¯Ÿåˆ°ä¸€ä¸ªç³Ÿç³•çš„åœºæ™¯ï¼Œå› ä¸ºåè·æ¯”å®é™…è·ç¦»é•¿å¾—å¤šï¼ˆc å¾ˆå¤§ï¼‰ã€‚](/img/2024-04-01-Product_Quantization/pho6.jpg)\n\nåœ¨è·å¾—æ‰€æœ‰æ•°æ®åº“è¡Œçš„è¿‘ä¼¼è·ç¦»åï¼Œæˆ‘ä»¬æœç´¢å…·æœ‰æœ€å°å€¼çš„å‘é‡ã€‚è¿™äº›å‘é‡å°†æ˜¯æŸ¥è¯¢çš„æœ€è¿‘é‚»ã€‚\n\n#### å…¶ä»–è·ç¦»åº¦é‡çš„è¿‘ä¼¼\n\nåˆ°ç›®å‰ä¸ºæ­¢ï¼Œæˆ‘ä»¬å·²ç»ç ”ç©¶äº†å¦‚ä½•é€šè¿‡ä½¿ç”¨åè·æ¥è¿‘ä¼¼æ¬§å‡ é‡Œå¾—åº¦é‡ã€‚è®©æˆ‘ä»¬å°†è¿™ä¸ªè§„åˆ™æ¨å¹¿åˆ°å…¶ä»–åº¦é‡æ ‡å‡†ã€‚\n\næƒ³è±¡ä¸€ä¸‹æˆ‘ä»¬æƒ³è¦è®¡ç®—ä¸€å¯¹å‘é‡ä¹‹é—´çš„è·ç¦»åº¦é‡ã€‚å¦‚æœæˆ‘ä»¬çŸ¥é“åº¦é‡çš„å…¬å¼ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥åº”ç”¨å®ƒæ¥å¾—åˆ°ç»“æœã€‚ä½†æ˜¯æœ‰æ—¶å€™æˆ‘ä»¬å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼åˆ†éƒ¨åˆ†çš„åšï¼š\n\n- ä¸¤ä¸ªå‘é‡è¢«åˆ†æˆ n ä¸ªå­å‘é‡\n- å¯¹äºæ¯å¯¹å„è‡ªçš„å­å‘é‡ï¼Œè®¡ç®—è·ç¦»åº¦é‡\n- ç„¶åå°†è®¡ç®—å‡ºçš„ n ä¸ªåº¦é‡ç»“åˆèµ·æ¥ç”ŸæˆåŸå§‹å‘é‡ä¹‹é—´çš„å®é™…è·ç¦»\n\n![è¯¥å›¾æ˜¾ç¤ºäº†è®¡ç®—åº¦é‡çš„ä¸¤ç§æ–¹æ³•ã€‚åœ¨å·¦è¾¹ï¼Œåº¦é‡å…¬å¼ç›´æ¥åº”ç”¨äºä¸¤ä¸ªå‘é‡ã€‚åœ¨å³è¾¹ï¼Œéƒ¨åˆ†è·ç¦»è®¡ç®—æ¯å¯¹å„è‡ªçš„å­å‘é‡ã€‚ç„¶åä½¿ç”¨èšåˆå‡½æ•° hã€g å’Œ f å¯¹å®ƒä»¬è¿›è¡Œç»„åˆã€‚](/img/2024-04-01-Product_Quantization/pho7.jpg)\n\næ¬§å‡ é‡Œå¾—åº¦é‡æ˜¯ä¸€ä¸ªå¯ä»¥æŒ‰éƒ¨åˆ†è®¡ç®—çš„åº¦é‡æ ‡å‡†çš„ä¾‹å­ã€‚æ ¹æ®ä¸Šå›¾ï¼Œæˆ‘ä»¬å¯ä»¥é€‰æ‹©èšåˆå‡½æ•° $h(z)=z^2$ï¼Œ$g(z_0,z_1...,z_n)=sum(z_0,z_1,...,z_n)$ å’Œ $f(z)=\\sqrt{z}$ã€‚\n\n![æ¬§å‡ é‡Œå¾—åº¦é‡å¯æŒ‰éƒ¨åˆ†è®¡ç®—](/img/2024-04-01-Product_Quantization/pho8.jpg)\n\nå†…ç§¯æ˜¯è¿™ç§åº¦é‡çš„å¦ä¸€ä¸ªä¾‹å­ï¼Œå…¶èšåˆå‡½æ•° $h(z)=z$ï¼Œ$g(z_0,z_1...,z_n)=sum(z_0,z_1,...,z_n)$ å’Œ $f(z)=z$ã€‚\n\nåœ¨ä¹˜ç§¯é‡åŒ–çš„èƒŒæ™¯ä¸‹ï¼Œè¿™æ˜¯ä¸€ä¸ªéå¸¸é‡è¦çš„å±æ€§ï¼Œå› ä¸ºåœ¨æ¨ç†è¿‡ç¨‹ä¸­ï¼Œç®—æ³•æŒ‰éƒ¨åˆ†è®¡ç®—è·ç¦»ã€‚**è¿™æ„å‘³ç€ï¼Œä½¿ç”¨ä¸å…·æœ‰æ­¤å±æ€§çš„æŒ‡æ ‡è¿›è¡Œä¹˜ç§¯é‡åŒ–ä¼šå‡ºç°æ›´å¤šé—®é¢˜ï¼Œä¾‹å¦‚ä½™å¼¦è·ç¦»**\n\n### æ¼”ç¤º\n\nä¹˜ç§¯é‡åŒ–çš„ä¸»è¦ä¼˜ç‚¹æ˜¯å¯¹å­˜å‚¨ä¸ºçŸ­ PQ ç çš„æ•°æ®åº“å‘é‡è¿›è¡Œå¤§è§„æ¨¡å‹ç¼©ã€‚å¯¹äºæŸäº›åº”ç”¨ç¨‹åºï¼Œè¿™æ ·çš„å‹ç¼©ç‡ç”šè‡³å¯èƒ½é«˜äº 95%ï¼ç„¶è€Œï¼Œé™¤äº† PQ ç ä¹‹å¤–ï¼Œè¿˜éœ€è¦å­˜å‚¨åŒ…å«å„å­ç©ºé—´é‡å­åŒ–å‘é‡çš„ kÃ—n çŸ©é˜µ dã€‚\n\n>Product quantization is a lossy-compression method, so the higher the compression is, the more likely that the prediction accuracy will decrease.\n\nå»ºç«‹ä¸€ä¸ªæœ‰æ•ˆçš„è¡¨ç¤ºç³»ç»Ÿéœ€è¦è®­ç»ƒå¤šä¸ªèšç±»ç®—æ³•ã€‚é™¤æ­¤ä¹‹å¤–ï¼Œåœ¨æ¨ç†è¿‡ç¨‹ä¸­ï¼Œk*n çš„åè·éœ€è¦ä»¥è›®åŠ›çš„æ–¹å¼è®¡ç®—ï¼Œå¹¶ä¸ºæ¯ä¸ªæ•°æ®åº“å‘é‡æ±‚å’Œï¼Œè¿™å¯èƒ½éœ€è¦ä¸€äº›æ—¶é—´ã€‚\n\n![Product Quantization æ€§èƒ½](/img/2024-04-01-Product_Quantization/pho9.jpg)\n\n#### Faiss æ‰§è¡Œ\n\n><a href=\"https://github.com/facebookresearch/faiss\">Faiss</a> (Facebook AI Search Similarity) is a Python library written in C++ used for optimised similarity search. This library presents different types of indexes which are data structures used to efficiently store the data and perform queries.\n\nåŸºäºæ¥è‡ª Faiss æ–‡æ¡£çš„ä¿¡æ¯ï¼Œæˆ‘ä»¬å°†çœ‹åˆ°å¦‚ä½•ä½¿ç”¨ PQã€‚\n\nPQ æ˜¯åœ¨ IndexPQ ç±»ä¸­å®ç°çš„ã€‚å¯¹äºåˆå§‹åŒ–ï¼Œæˆ‘ä»¬éœ€è¦æä¾›3ä¸ªå‚æ•°ï¼š\n\n- dï¼šæ•°æ®ç»´åº¦\n- Mï¼š æ¯ä¸ªå‘é‡çš„åˆ†å‰²æ•°ï¼ˆä¸ä¸Šé¢ä½¿ç”¨çš„ n ç›¸åŒçš„å‚æ•°ï¼‰\n- nbits: ç¼–ç å•ä¸ªé›†ç¾¤ ID æ‰€éœ€çš„ä½æ•°ã€‚è¿™æ„å‘³ç€ä¸€ä¸ªå­ç©ºé—´ä¸­çš„æ€»ç°‡æ•°ç­‰äº $k = 2^{nbit}$ã€‚\n\nå¯¹äºç­‰å­ç©ºé—´ç»´æ•°åˆ†è£‚ï¼Œå‚æ•° dim å¿…é¡»è¢« M æ•´é™¤ã€‚\n\nå­˜å‚¨å•ä¸ªå‘é‡æ‰€éœ€çš„æ€»å­—èŠ‚æ•°ç­‰äºï¼š\n\n$bytes = \\lceil \\frac {M*nbits}{8} \\rceil$\n\n>As we can see in the formula above, for more efficient memory usage the value of M * nbits should be divisible by 8.\n\n![IndexPQ çš„ Faiss å®ç°](/img/2024-04-01-Product_Quantization/pho10.jpg)\n\n## ç»“è®º\n\næˆ‘ä»¬å·²ç»ç ”ç©¶äº†ä¸€ç§åœ¨ä¿¡æ¯æ£€ç´¢ç³»ç»Ÿä¸­éå¸¸æµè¡Œçš„ç®—æ³•ï¼Œå®ƒå¯ä»¥æœ‰æ•ˆåœ°å‹ç¼©å¤§é‡æ•°æ®ã€‚å…¶ä¸»è¦ç¼ºç‚¹æ˜¯æ¨ç†é€Ÿåº¦ç¼“æ…¢ã€‚å°½ç®¡å¦‚æ­¤ï¼Œè¯¥ç®—æ³•åœ¨ç°ä»£å¤§æ•°æ®åº”ç”¨ä¸­å¾—åˆ°äº†å¹¿æ³›åº”ç”¨ï¼Œç‰¹åˆ«æ˜¯ä¸å…¶ä»–æœ€è¿‘é‚»æœç´¢æŠ€æœ¯ç›¸ç»“åˆæ—¶ã€‚\n\n## å‚è€ƒ\n\n- <a href=\"https://vividfree.github.io/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/2017/08/05/understanding-product-quantization\">ç†è§£ product quantization ç®—æ³•</a>\n- <a href=\"https://towardsdatascience.com/similarity-search-product-quantization-b2a1a6397701\">Similarity Search, Part 2: Product Quantization</a>\n\næ‰€æœ‰å›¾åƒå‡æ¥è‡ª ã€ŠSimilarity Search, Part 2: Product Quantizationã€‹\n","tags":["å‘é‡æ•°æ®åº“"]},{"title":"é‡åŒ–ç´¢å¼•ï¼šScalar Quantization æ ‡é‡é‡åŒ–","url":"/2024/02/19/2024-02-19-Scalar Quantization/","content":"\n>æœ¬æ–‡è½¬è½½ï¼šhttps://yongyuan.name/blog/scalar-quantization.html\næœ¬æ„ä¸ºäº†å½’çº³æ€»ç»“å‘é‡ç´¢å¼•ç›¸å…³çš„çŸ¥è¯†ï¼Œæ–¹ä¾¿æ—¥åç¿»é˜…ï¼Œè‡ªå·±åšäº†äº›è®¸çš„ä¿®æ”¹~\n\n## èƒŒæ™¯\n\nåœ¨å·¥ä½œä¸­é‡åˆ°è¿™æ ·ä¸€ä¸ªåœºæ™¯ï¼šé€šè¿‡å¤šæ¨¡æ€å­¦ä¹ åˆ°çš„ 64 ç»´ video embeddingï¼Œåœ¨æœç´¢ç«æ‹çš„æ—¶å€™ï¼Œéœ€è¦å®æ—¶å–åˆ°å‰ Kï¼ˆK>=300ï¼‰ä¸ªç»“æœå¯¹åº”å¾—çš„ video embeddingï¼Œç”±äºæ¨¡å‹æ¯”è¾ƒå¤§ï¼Œè¿™ä¸ª video embeddingï¼Œä¸æ”¯æŒå®æ—¶è®¡ç®—ï¼Œè€Œæ˜¯åœ¨è§†é¢‘ä¸Šä¼ æ—¶å€™ï¼Œå°±è¢«è®¡ç®—å¥½ã€‚å·¥ç¨‹æ¶æ„å¯¹å­˜å‚¨å’Œè¯»å–æ€§èƒ½æ˜¯æœ‰è¦æ±‚çš„ï¼Œæ—¢ä¸èƒ½ç›´æ¥å°†è¿™ 664 ç»´ embedding ç›´æ¥å†™åˆ° kiwiï¼ˆredisæ”¹é€ åçš„æ•°æ®åº“ï¼‰é‡Œé¢ã€‚\n\nè¿™ä¸ªé—®é¢˜ï¼Œå¯ä»¥ç®€åŒ–ä¸ºï¼šæœ‰æ²¡æœ‰ä¸€ç§é‡åŒ–æ–¹æ³•ï¼Œå°†ä¸€ä¸ª d ç»´ float å‹å‘é‡ï¼Œencode ä¸ºä¸€ä¸ª d ç»´ int8 å‹çš„å‘é‡ï¼Œè¿™ä¸ª d ç»´ int8 å‹çš„å‘é‡ç»è¿‡ decode åï¼Œä¸åŸå§‹å‘é‡çš„è¯¯å·®å°½å¯èƒ½å°ï¼Ÿè¿™æ ·ä¸€æ¥ï¼Œå­˜å‚¨ç©ºé—´é™ä½ä¸ºåŸæ¥çš„ 1/4 å€ï¼Œå¹¶ä¸”è¯»å– int8 çš„æ€§èƒ½æ¯” float å‹ä¼šå¿«å¾ˆå¤šã€‚ç­”æ¡ˆæ˜¯è‚¯å®šçš„ï¼Œè¿™å°±æ˜¯æœ¬ç¯‡åšæ–‡è¦ä»‹ç»æ€»ç»“çš„ Scalar Quantizationã€‚\n\nScalar Quantizationï¼Œå³æ ‡é‡é‡åŒ–ã€‚å…³äº Scalar Quantizationï¼Œç½‘ä¸Šèµ„æ–™æ¯”è¾ƒå¤šï¼ˆ<a href=\"https://www.google.com.hk/search?q=Scalar+Quantization&newwindow=1&safe=strict&biw=1389&bih=766&sxsrf=ALeKk01QFkem3Lrzgoe3vrfd5uyeVr2RPQ%3A1624178770171&ei=UgDPYOjkCMWxr7wP98CqkA0&oq=Scalar+Quantization&gs_lcp=Cgdnd3Mtd2l6EAMyBwgjEOoCECcyBwgjEOoCECcyBwgjEOoCECcyBwgjEOoCECcyBwgjEOoCECcyBwgjEOoCECcyBwgjEOoCECcyBwgjEOoCECcyBwgjEOoCECcyBwgjEOoCECdQ06k-WOSrPmDwrD5oAxACeACAAckBiAHJAZIBAzItMZgBAKABAaABAqoBB2d3cy13axqwAQrAAQE&sclient=gws-wiz&ved=0ahUKEwjo1ZW16axxAhxFy4sBHxegCtIQ4dUDCBI&uact=5\">Google</a>ï¼‰ä½†å°ç™½èœåœ¨æŸ¥è¿‡å¾ˆå¤šèµ„æ–™åï¼Œå‘è§‰èƒ½æŠŠ Scalar Quantization å‘é‡é‡åŒ–è¿‡ç¨‹è®²æ¸…æ¥šï¼Œå¹¶ä¸”è¿˜èƒ½å‰–æ faiss ä¸­å®ç°çš„ Scalar Quantizationã€‚ä¸ºäº†æ–¹ä¾¿åé¢çš„åŒå­¦ç†è§£ï¼Œå°ç™½èœç»“åˆè‡ªå·±å¯¹ Scalar Quantization åŸç†ä¸å®ç°ï¼Œåšäº†æ•´ç†ã€‚\n\n## Scalar Quantization åŸç†\n\nScalar Quantization æ ‡é‡é‡åŒ–ï¼Œåˆ†ä¸º 3 ä¸ªè¿‡ç¨‹ï¼š\n\n- training è¿‡ç¨‹ï¼Œä¸»è¦æ˜¯è®­ç»ƒ encode è¿‡ç¨‹ï¼Œéœ€è¦çš„ä¸€äº›å‚æ•°ï¼Œè¿™äº›çš„å‚æ•°ï¼Œä¸»è¦æ˜¯æ¯ 1 ç»´å¯¹åº”çš„æœ€å¤§å€¼ã€æœ€å°å€¼ï¼›\n- encode è¿‡ç¨‹ï¼Œå°† float å‘é‡é‡åŒ–ä¸º int8 å‘é‡ï¼ˆint8 æ˜¯å…¶ä¸­ä¸€ç§æ•°æ®å‹ç¼©å½¢å¼ï¼Œè¿˜æœ‰ 4 æ¯”ç‰¹ä¹‹ç±»çš„ï¼Œè¿™é‡Œä¸»è¦ä»¥ 8 æ¯”ç‰¹è¯´æ˜åŸç†ï¼‰\n- decode è¿‡ç¨‹ï¼Œå°† int8 å‘é‡è§£ç ä¸º float å‘é‡ï¼›\n\nä¸ºäº†æ›´å¥½çš„è¯´æ˜ Scalar Quantization çš„åŸç†ï¼Œå°ç™½èœç”»äº† Scalar Quantization æ ‡é‡é‡åŒ–åŸç†æ¡†å›¾ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š\n\n![Scalar Quantization æ ‡é‡é‡åŒ–åŸç†æ¡†å›¾ï¼ˆcopyright@yongyuan.nameï¼‰](/img/2024-02-19-Scalar_Quantization/pho1.jpg)\n\næ•´ä¸ª Scalar Quantization è¿‡ç¨‹ï¼Œå…¶å®æ˜¯å¾ˆå®¹æ˜“ç†è§£çš„ï¼Œä¸‹é¢å¯¹è®­ç»ƒã€ç¼–ç å’Œè§£ç åšäº›è¯´æ˜ã€‚\n\n### è®­ç»ƒè¿‡ç¨‹\n\nScalar Quantization è®­ç»ƒè¿‡ç¨‹ï¼Œå¦‚ä¸Šå›¾æœ€å·¦è¾¹æ‰€ç¤ºï¼Œä»æ ·æœ¬ä¸­éšæœºé‡‡æ ·å‡º N ä¸ªæ ·æœ¬åï¼Œè®­ç»ƒè¿‡ç¨‹ä¸»è¦æ˜¯å¾—åˆ° N ä¸ªæ ·æœ¬ä¸­æ¯ 1 ç»´çš„æœ€å¤§å€¼ã€æœ€å°å€¼ã€‚å¾—åˆ°æœ€å¤§å€¼ã€æœ€å°å€¼åï¼Œå°†å®ƒä»¬ä¿å­˜ä¸‹æ¥å³å¯ã€‚å®é™…åœ¨è®­ç»ƒçš„æ—¶å€™ï¼ŒN èƒ½å¤§çš„æ—¶å€™ï¼Œå°½é‡å¤§ç‚¹ã€‚\n> N ä¸ªæ ·æœ¬ä¸­æ¯ 1 ç»´çš„æœ€å¤§å€¼ã€æœ€å°å€¼ï¼šå¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œå°† 64 ç»´åº¦å‘é‡åˆ‡æˆ 64 ä»½ï¼Œæ±‚ N ä¸ªå‘é‡ï¼Œåœ¨ç¬¬ i ç»´åº¦çš„æœ€å¤§å€¼ã€æœ€å°å€¼ã€‚\n\n### ç¼–ç è¿‡ç¨‹\n\nScalar Quantization åœ¨ç¼–ç çš„æ—¶å€™ï¼Œå¯¹äºä¸€ä¸ª d ç»´çš„å¾…ç¼–ç çš„ float å‹å‘é‡ $x=\\lbrace x_1,x_2,â€¦,x_d \\rbrace$ï¼Œç¼–ç è¿‡ç¨‹ä¸»è¦åŒ…å«å¦‚ä¸‹æ­¥éª¤ï¼š\n\n- å¯¹æ¯ 1 ç»´ï¼Œæ±‚ $value_i=\\frac{x_i-min_i}{max_i-min_i}$ï¼›\n- å¯¹æ¯ 1 ç»´ï¼Œå¦‚æœ $value_i<0$ï¼Œåˆ™ $value_i$ é‡ç½®ä¸º 0ï¼›å¦‚æœ $value_i>1$ï¼Œåˆ™ $value_i$ é‡ç½®ä¸º 1ã€‚è¿™é‡Œä¸»è¦æ˜¯å¯¹è¾¹ç•Œæƒ…å†µåšå¼‚å¸¸å¤„ç†ï¼Œç†è®ºæƒ…å†µä¸‹ï¼Œæ˜¯ä¸ä¼šå‡ºç°$value_i<0$ æˆ–è€… $value_i>0$ çš„æƒ…å†µï¼›\n- å¯¹æ¯ 1 ç»´ï¼Œå¯¹åº”çš„ç¼–ç  $code_i=int(255*value_i)$ã€‚ä¸ºä»€ä¹ˆ 255ï¼Ÿå¯ä»¥æ€è€ƒä¸‹ï¼›\n\n> å½’ä¸€åŒ–ï¼šå¯¹äºæ¯ä¸ªç»´åº¦ï¼Œå°†åŸå§‹å€¼æ˜ å°„åˆ° [0, 1] èŒƒå›´å†…\næˆªæ–­ï¼šå°†å½’ä¸€åŒ–åçš„å€¼æˆªæ–­åˆ° [0, 1] èŒƒå›´å†…\né‡åŒ–ï¼šå°†æˆªæ–­åçš„å€¼ä¹˜ä»¥ 255 å¹¶è¿›è¡Œå–æ•´ï¼Œå¾—åˆ°æœ€ç»ˆçš„ç¼–ç å€¼\n\"255\"ï¼š8 ä½æ•´æ•°ï¼Œé‡åŒ–èŒƒå›´ä¸º [0, 255]\n\næ•´ä¸ªè¿‡ç¨‹ï¼Œå¦‚ä¸Šå›¾ä¸­çš„ä¸­é—´å›¾æ‰€ç¤ºã€‚è¿™æ ·å°±å®Œæˆäº† float å‹å‘é‡ $x=\\lbrace x_1,x_2,â€¦,x_d \\rbrace$ çš„ç¼–ç ï¼Œå°†å‘é‡çš„æ¯ 1 ç»´ï¼Œéƒ½å˜æˆäº†ä¸€ä¸ªç”¨ int8 è¡¨ç¤ºçš„æ•´å‹æ•°æ®ï¼Œä¹Ÿå°±æ˜¯å¯¹åº”çš„ Scalar Quantization çš„ç¼–ç ã€‚\n\n### è§£ç è¿‡ç¨‹\n\nScalar Quantization è§£ç è¿‡ç¨‹ï¼Œæ˜¯è§£ç çš„é€†è¿‡ç¨‹ã€‚è§£ç è¿‡ç¨‹æ­¥éª¤å¦‚ä¸‹ï¼š\n\n- å¯¹æ¯ 1 ç»´ï¼Œ$x_i=min_i+\\frac{(code_i+0.5)*(max_i-min_i)}{255}$ï¼Œé€šè¿‡è¯¥å¼å­ï¼Œå³å¯å®Œæˆå¯¹ç¬¬iç»´çš„è§£ç ã€‚ç•™ä¸ªé—®é¢˜ï¼šä¸ºå•¥ $code_i$ éœ€è¦åŠ ä¸Š 0.5ï¼Ÿ\n\n> **åŠ  0.5 çš„ä½œç”¨æ˜¯å°†è¿™ä¸¤ç§è¯¯å·®å¹³å‡åˆ°æ¯ä¸ªå–å€¼åŒºé—´å†…**\nä¾‹å¦‚ï¼Œå¯¹äºå–å€¼åŒºé—´ [0, 1]ï¼Œå¦‚æœä¸å¯¹ç¼–ç å€¼åŠ  0.5ï¼Œé‚£ä¹ˆæ‰€æœ‰è½åœ¨è¯¥åŒºé—´å†…çš„æµ®ç‚¹å‹æ•°æ®éƒ½ä¼šè¢«æ˜ å°„åˆ°åŒä¸€ä¸ªç¦»æ•£å€¼ 0ã€‚è¿™ä¼šå¯¼è‡´é‡åŒ–è¯¯å·®è¿‡å¤§ã€‚è€ŒåŠ  0.5 åï¼Œæ‰€æœ‰è½åœ¨è¯¥åŒºé—´å†…çš„æµ®ç‚¹å‹æ•°æ®éƒ½ä¼šè¢«æ˜ å°„åˆ° 0 æˆ– 1ï¼Œå¹¶å°†é‡åŒ–è¯¯å·®å¹³å‡åˆ°è¿™ä¸¤ä¸ªç¦»æ•£å€¼ä¸Šã€‚\n\n## Scalar Quantization å®ç°\n\nScalar Quantization çš„è®­ç»ƒã€ç¼–ç ã€è§£ç å®ç°ï¼Œå¯ä»¥å‚è€ƒå°ç™½èœçš„å®ç°<a href=\"https://github.com/willard-yuan/cvt/tree/master/scalar_quantization\">scalar_quantization</a>ã€‚è®­ç»ƒè¿‡ç¨‹ï¼Œå°±æ˜¯è®¡ç®—å„ç»´æœ€å¤§å€¼ã€æœ€å°å€¼ï¼Œè‡ªå·±å®ç°çš„è¯ï¼Œå…·ä½“å¯ä»¥çœ‹ <a href=\"https://github.com/willard-yuan/cvt/blob/master/scalar_quantization/train/src/sq_train.cpp#L68\">L68-L97</a> ã€‚ä½¿ç”¨faissçš„è¯ï¼Œå¦‚ä¸‹ï¼š\n\n```cpp\nfaiss::IndexScalarQuantizer SQuantizer(d, faiss::ScalarQuantizer::QT_8bit, faiss::METRIC_L2);\nSQuantizer.train(num_db, xb);\n// SQuantizer.add(num_db, xb);    \nfaiss::write_index(&SQuantizer, model_path.c_str());\n```\n\nåœ¨ `sq_train.cpp` é‡Œé¢ï¼Œå¯¹æ¯”äº†è‡ªå·±å®ç°çš„è®­ç»ƒè¿‡ç¨‹ç»“æœå’Œ faiss è®­ç»ƒå‡ºæ¥çš„ç»“æœï¼Œè®­ç»ƒå‡ºæ¥çš„å‚æ•°ç»“æœï¼Œä¸¤è€…æ˜¯ä¸€è‡´çš„ã€‚\n\nfaiss encode çš„å®ç°ï¼Œå¦‚ <a href=\"https://github.com/facebookresearch/faiss/blob/master/faiss/impl/ScalarQuantizer.cpp#L328\">L328</a> æ‰€ç¤ºï¼š\n\n```cpp\nvoid encode_vector(const float* x, uint8_t* code) const final {\n    for (size_t i = 0; i < d; i++) {\n        float xi = 0;\n        if (vdiff != 0) {\n            xi = (x[i] - vmin) / vdiff;\n            if (xi < 0) {\n                xi = 0;\n            }\n            if (xi > 1.0) {\n                xi = 1.0;\n            }\n        }\n        Codec::encode_component(xi, code, i);\n    }\n}\n```\n\nå…¶ä¸­ vdiff = max - minã€‚faiss decode çš„å®ç°ï¼Œå¦‚ <a hef=\"https://github.com/facebookresearch/faiss/blob/master/faiss/impl/ScalarQuantizer.cpp#L344\">L344</a> æ‰€ç¤ºï¼š\n\n```cpp\nvoid decode_vector(const uint8_t* code, float* x) const final {\n    for (size_t i = 0; i < d; i++) {\n        float xi = Codec::decode_component(code, i);\n        x[i] = vmin + xi * vdiff;\n    }\n}\n```\n\né’ˆå¯¹å°ç™½èœ Scalar Quantizationï¼Œå°ç™½èœå®ç°çš„ç¼–è§£ç è¿‡ç¨‹ï¼ŒåŒæ—¶æä¾›äº† faiss å®ç°çš„æ¥å£è°ƒç”¨ï¼Œä¹Ÿæä¾›äº†è‡ªå·±å®ç°çš„æ¥å£è°ƒç”¨ï¼Œå…·ä½“å¯ä»¥é˜…è¯» <a href=\"https://github.com/willard-yuan/cvtk/blob/master/scalar_quantization/scalar_quantization/int8_quan.cc\">int8_quan.cc</a>ã€‚\n\nå¦å¤–ï¼Œå…³äº Faiss å®ç°çš„ decode æ¥å£ï¼Œç”±äºé‡‡ç”¨äº†å¤šçº¿ç¨‹æ–¹å¼ï¼Œåœ¨å®é™…ä½¿ç”¨çš„æ—¶å€™ï¼Œ**å½“è¯·æ±‚è§£ç çš„æ•°æ®é‡ä¸å¤Ÿå¤§çš„æ—¶å€™ï¼Œå¤šçº¿ç¨‹çš„æ–¹å¼ï¼Œæ€§èƒ½åè€Œä¸‹é™**ï¼Œå…·ä½“å¯ä»¥çœ‹è¿™é‡Œæåˆ°çš„<a href=\"https://github.com/facebookresearch/faiss/issues/1530\">Issue: Scale quantization decodes does not fast</a>ã€‚","tags":["å‘é‡æ•°æ®åº“"]},{"title":"HDF5 æ–‡ä»¶è½¬ vecs æ–‡ä»¶","url":"/2024/02/06/2024-02-06-HDF5æ–‡ä»¶è½¬vecsæ–‡ä»¶/","content":"\n## HDF5 æ–‡ä»¶çš„ç»“æ„\n\nä¸€ä¸ª HDF5 æ ¼å¼çš„æ–‡ä»¶æ˜¯ä¸€ä¸ªåŒ…å«ä¸¤ä¸ªå¯¹è±¡çš„å®¹å™¨ï¼Œä¸€ä¸ªæ˜¯**æ•°æ®é›†**ï¼ˆdatasetsï¼‰ï¼Œå¦ä¸€ä¸ªæ˜¯**ç»„**ï¼ˆgroupsï¼‰ã€‚æ•°æ®é›†çš„ç»“æ„éå¸¸ç±»ä¼¼äº Numpy çš„ **array**ï¼Œç»„çš„ç»“æ„éå¸¸ç±»ä¼¼äº python çš„å­—å…¸ï¼Œå®ƒåƒä¸€ä¸ªæ–‡ä»¶å¤¹ä¸€æ ·ï¼Œå®ƒå¯ä»¥åŒ…å«æ•°æ®é›†å’Œå…¶å®ƒçš„ç»„ã€‚æ€»ç»“èµ·æ¥ï¼š**ç»„åƒå­—å…¸ä¸€æ ·å·¥ä½œï¼Œæ•°æ®é›†åƒ NumPy æ•°ç»„ä¸€æ ·å·¥ä½œ**ã€‚\n\næ‹¿ HDF5 æ ¼å¼æ•°æ®é›† **gist-960-euclidean.hdf5** ä¸ºä¾‹ï¼ˆ<a href=\"http://ann-benchmarks.com/gist-960-euclidean.hdf5\">ä¸‹è½½åœ°å€</a>ï¼‰ï¼Œæ•´ä¸ªæ–‡ä»¶æœ‰ä¸€ä¸ªæ ¹ç»„ï¼Œå°±æ˜¯ä¸‹å›¾çš„\"/\"ã€‚\n\n![HDF5 æ–‡ä»¶ç»“æ„ç¤ºæ„å›¾](/img/2024-02-06-HDF5æ–‡ä»¶è½¬vecsæ–‡ä»¶/pho1.jpg)\n\næ ¹ç»„ä¸‹æœ‰å››ä¸ªé”®ï¼Œåˆ†åˆ«ä¸º **distances**ã€**neighbors**ã€**test** å’Œ **train**ï¼Œç±»æ¯”äºä¸Šå›¾ä¸­çš„ Aã€B å’Œ Cã€‚\n\n- **distances** å¯¹åº”çš„æ˜¯ shape ä¸º (**1000**, **100**) çš„æ•°æ®é›†ï¼ˆç±»æ¯”äº Numpy çš„ **array**ï¼‰ï¼Œä¸ºæ¯ä¸ªæŸ¥è¯¢å‘é‡æœ€è¿‘çš„ 100 ä¸ªå‘é‡è·è¯¥æŸ¥è¯¢å‘é‡çš„è·ç¦»ï¼Œæ•°æ®ç±»å‹ä¸º **float32**\n- **neighbors** å¯¹åº”çš„æ˜¯ shape ä¸º (**1000, 100**) çš„æ•°æ®é›†ï¼Œä¸ºæ¯ä¸ªæŸ¥è¯¢å‘é‡æœ€è¿‘çš„ 100 ä¸ªå‘é‡ï¼Œæ•°æ®ç±»å‹ä¸º **int32**\n- **test** å¯¹åº”çš„æ˜¯ shape ä¸º (**1000000, 960**) çš„æ•°æ®é›†ï¼Œè¿™æ˜¯åŸºæ•°æ®ï¼ˆåŸå§‹æ•°æ®ï¼‰ï¼Œä¸€å…± 1000000 ä¸ªå‘é‡ï¼Œæ¯ä¸ªå‘é‡çš„ç»´åº¦ä¸º 960 ç»´ï¼Œæ•°æ®ç±»å‹ä¸º **float32**\n- **train** å¯¹åº”çš„æ˜¯ shape ä¸º (**1000, 960**) çš„æ•°æ®é›†ï¼Œåªæ˜¯æŸ¥è¯¢æ•°æ®ï¼Œä¸€å…± 1000 ä¸ªå‘é‡ï¼Œå‘é‡çš„ç»´åº¦ä¸º 960 ç»´ï¼Œæ•°æ®ç±»å‹ä¸º **float32**\n\n## vecs æ–‡ä»¶çš„ç»“æ„\n\n![vecs æ–‡ä»¶ç»“æ„ç¤ºæ„å›¾](/img/2024-02-06-HDF5æ–‡ä»¶è½¬vecsæ–‡ä»¶/pho2.jpg)\n\nåœ¨å¸¸ç”¨çš„å…¬å¼€æ•°æ®é›†ä¸­ï¼Œ**æ•°æ®é›†æ–‡ä»¶ã€æŸ¥è¯¢æ–‡ä»¶**å¾€å¾€ä½¿ç”¨ fvecs æ ¼å¼å­˜å‚¨ã€‚è€Œ**çœŸå€¼é›†ï¼ˆå³æŸ¥è¯¢çš„ç­”æ¡ˆï¼‰æ–‡ä»¶**ä½¿ç”¨ ivecs æ ¼å¼å­˜å‚¨ã€‚å…¶å®è¿™ä¸¤ç§æ ¼å¼ååˆ†ç›¸ä¼¼ã€‚\n\n### fvecs\n\næ•°æ®é›†ã€æŸ¥è¯¢é›†é‡‡ç”¨fvecsæ ¼å¼ï¼Œå…¶å®ä»–ä»¬æ˜¯å®Œå…¨ç›¸åŒçš„ä¸œè¥¿ã€‚åœ¨æ•°æ®é›†ä¸­ï¼Œå­˜å‚¨çš„æ˜¯æ‰€æœ‰å‘é‡ï¼Œè€ŒæŸ¥è¯¢é›†ä¸­ï¼Œå­˜å‚¨çš„åŒæ ·æ˜¯å‘é‡ï¼Œåªæ˜¯å‘é‡æ•°é‡ä¼šå°‘ä¸€äº›ã€‚\n\nfvecs é‡‡ç”¨**äºŒè¿›åˆ¶**æ¥å­˜å‚¨ï¼Œç›´æ¥æ‰“å¼€ä¾¿æ˜¯ä¹±ç ã€‚\n\nä¸‹é¢ç”¨ä¸€å¼ å›¾æ¥è¡¨ç¤º fvecs çš„å¤§è‡´æ ¼å¼ï¼š\n\n![fvecs æ–‡ä»¶æ ¼å¼ç¤ºæ„å›¾](/img/2024-02-06-HDF5æ–‡ä»¶è½¬vecsæ–‡ä»¶/pho3.jpg)\n\næ¯ä¸€â€œè¡Œâ€ä¸­ï¼Œ**ç¬¬ä¸€ä¸ªæ•°è¡¨ç¤ºæ•°æ®çš„ç»´åº¦ dimï¼Œåé¢è·Ÿç€çš„ dim ä¸ªæ•°ä¾¿æ˜¯å‘é‡å„ç»´åº¦çš„å€¼**ã€‚(æ³¨ï¼šfvecs ä¸­çš„ f æŒ‡ **float32**)\n\nå› æ­¤ï¼Œä¸€â€œè¡Œâ€è¡¨ç¤ºçš„ä¾¿æ˜¯ä¸€ä¸ªå‘é‡ã€‚\n\n### ivecs\n\nivecs å…¶å®å’Œ fvecs çš„æ ¼å¼æ˜¯ä¸€æ ·çš„ï¼Œåªä¸è¿‡å®ƒå­˜å‚¨çš„ä¸æ˜¯å‘é‡ï¼Œè€Œæ˜¯æ¯ä¸€æ¡æŸ¥è¯¢çš„ç­”æ¡ˆã€‚\n\nå°±æ˜¯è¯´ï¼Œivecs é‡Œçš„æ¯ä¸€â€œè¡Œâ€é‡Œï¼Œ**ç¬¬ä¸€ä¸ªæ•°æ®æ˜¯æŸ¥è¯¢ç­”æ¡ˆçš„æ•°é‡ nï¼Œåé¢ n ä¸ªæ•°æ˜¯ç­”æ¡ˆå‘é‡çš„ id**ã€‚(æ³¨ï¼šivecs ä¸­çš„ i æŒ‡ **int32**)\n\n## HDF5 è½¬ vecs è„šæœ¬\n\n```python\n'''\nAuthor: pudding\nDate: 2024-02-02 10:15:39\n'''\nimport argparse\nimport os\nimport h5py\nimport numpy as np\nimport struct\n\nimport sklearn.preprocessing\n\ndef load_hdf5_file(filename):\n    print('loadingï¼š'+ filename)\n    hdf5_f = h5py.File(filename, 'r')\n    print('load done !')\n    return hdf5_f\n\ndef to_fvecs(filename, data):\n    with open(filename, 'wb') as fp:\n        for y in data:\n            # å°† y.sizeï¼ˆdimï¼‰ ä»¥ C++ çš„ unsigned int çš„å½¢å¼å†™å…¥äºŒè¿›åˆ¶æ–‡ä»¶\n            d = struct.pack('I', y.size)\n            fp.write(d)\n            for x in y:\n                # å°† xï¼ˆvectorï¼‰ä»¥ C++ çš„ float çš„å½¢å¼å†™å…¥äºŒè¿›åˆ¶æ–‡ä»¶\n                a = struct.pack('f', x)\t\n                fp.write(a)\n\ndef to_ivecs(filename, data):\n    with open(filename, 'wb') as fp:\n        for y in data:\n            d = struct.pack('I', y.size)\n            fp.write(d)\n            for x in y:\n                a = struct.pack('I', x)\n                fp.write(a)\n\n\ndef run(file_path):\n    dataset = load_hdf5_file(file_path)\n\n    dimension = int(dataset.attrs[\"dimension\"]) if \"dimension\" in dataset.attrs else len(dataset[\"train\"][0])\n    print('======== HDF5 Basic Information ========')\n    print('dataset dimensionï¼š'+ str(dimension))\n    filename = file_path.split('/')[-1]\n    dataname = filename.split('.')[0]\n\n    X_train = np.array(dataset[\"train\"])\n    X_test = np.array(dataset[\"test\"])\n    distance = dataset.attrs[\"distance\"]\n\n    # if distance == \"angular\":\n    #     X_train = sklearn.preprocessing.normalize(X_train, axis=1, norm=\"l2\")\n    #     X_test /= np.linalg.norm(X_test)\n    \n    print(\"Datanameï¼š\" + dataname)\n    print(\"distanceï¼š\", distance)\n    print(\"got a train set of size (%d * %d)\" % (X_train.shape[0], dimension))\n    print(\"got %d queries\" % len(X_test))\n\n    print('======== HDF5 to vesc ========')\n    dataset_dir = os.path.join('./vecs', dataname)\n    if not os.path.exists(dataset_dir):\n        os.makedirs(dataset_dir)\n    \n    to_fvecs(os.path.join(dataset_dir, dataname+'_base.fvecs'), X_train)\n    to_fvecs(os.path.join(dataset_dir, dataname+'_query.fvecs'), X_test)\n\n    to_ivecs(os.path.join(dataset_dir, dataname+'_groundtruth.ivecs'), dataset['neighbors'])\n\n    print(\"dataset['train'] to \"+ str(os.path.join(dataset_dir, dataname+'_base.fvecs')))\n    print(\"dataset['test'] to \"+ str(os.path.join(dataset_dir, dataname+'_query.fvecs')))\n    print(\"dataset['neighbors'] to \"+ str(os.path.join(dataset_dir, dataname+'_groundtruth.ivecs')))\n\n\nif __name__ == \"__main__\":\n    parser = argparse.ArgumentParser(description=\"Run the script with file path input\")\n    parser.add_argument(\"--file_path\", type=str, required=True, help=\"Path to the input file\")\n    args = parser.parse_args()\n\n    run(args.file_path)\n```\n","tags":["å‘é‡æ•°æ®åº“"]},{"title":"ä¸€æ–‡è®©ä½ åº”å¯¹ Linux è¿›ç¨‹ \"D\" çŠ¶æ€","url":"/2024/01/16/2024-01-16-Linux è¿›ç¨‹ D çŠ¶æ€/","content":"\n## ç¯å¢ƒ\n\nçº¢å¸½ä¼ä¸š linux 4ã€5ã€6ã€7ã€8ã€9\n\n## é—®é¢˜\n\n- ä»€ä¹ˆæ˜¯ \"D\" çŠ¶æ€ï¼ˆæˆ– dstate æˆ– d-stateï¼‰?\n- ä»€ä¹ˆæ˜¯è¿›ç¨‹çš„ \"D\" çŠ¶æ€\n\n## è§£å†³\n\n<ul>\n  <li>Linux éµå¾ªä¼ ç»Ÿ UNIX çš„æ ‡å‡†ï¼Œå°†å…¶å¹³å‡è´Ÿè·è®¡ç®—ä¸ºæŒ‡å®šæ—¶é—´é—´éš”å†…å¯è¿è¡Œæˆ–æ­£åœ¨è¿è¡Œçš„è¿›ç¨‹ï¼ˆR çŠ¶æ€ï¼‰çš„å¹³å‡æ•°é‡ï¼Œä»¥åŠå¤„äºä¸å¯ä¸­æ–­ç¡çœ ï¼ˆD çŠ¶æ€ï¼‰ä¸­çš„è¿›ç¨‹æ•°é‡ã€‚</li>\n  <li>\"D\" çŠ¶æ€ï¼ˆTASK_UNINTERRUPTIBLEï¼‰æ˜¯å‘ç”Ÿåœ¨å†…æ ¸ä»£ç è·¯å¾„ä¸­çš„ä¸€ç§çŠ¶æ€ï¼Œåœ¨è¿™ç§çŠ¶æ€ä¸‹ï¼Œåœ¨å¤„ç†ä»»åŠ¡æ—¶æ‰§è¡Œä¸èƒ½è¢«ä¸­æ–­ã€‚æˆ‘ä»¬å¸Œæœ›è¿™åº”è¯¥æ˜¯ä¸€ä¸ªçŸ­æš‚çš„è¿‡ç¨‹ï¼Œä¸”åœ¨æ­£å¸¸æ“ä½œä¸­ï¼Œå†…æ ¸çº¿ç¨‹åº”è¯¥å¿«é€Ÿåœ°ä» TASK_UNINTERRUPTIBLE çŠ¶æ€ä¸­å‡ºæ¥ã€‚\n    <ul>\n      <li><b>\"D\" çŠ¶æ€è¿›ç¨‹é€šå¸¸è¢«é˜»å¡ç­‰å¾…èµ„æº</b>ï¼Œç£ç›˜ IO å’Œé”æ˜¯è¿›ç¨‹å¯èƒ½é˜»å¡çš„å‡ ç§å¸¸è§èµ„æºã€‚</li>\n      <li>ä¸€ä¸ªä¾‹å­å¯èƒ½æ˜¯ä¸ç¡¬ä»¶é€šä¿¡çš„ low level é©±åŠ¨ç¨‹åºï¼Œå¯èƒ½ä» NIC å›ºä»¶æ£€ç´¢ç½‘ç»œæ•°æ®åŒ…æ•°æ®æˆ–è®¿é—®ç¡¬ç›˜é©±åŠ¨å™¨ä¸Šçš„æ•°æ®å—--è¯»å†™ IOã€‚</li>\n      <li>é€šå¸¸ï¼Œè¿™ç§æƒ…å†µå‘ç”Ÿå¾—éå¸¸å¿«ï¼Œå¹¶ä¸”çº¿ç¨‹ä¿æŒè¿™ç§çŠ¶æ€çš„æ—¶é—´éå¸¸çŸ­ï¼ˆå› æ­¤é€šå¸¸ä¸ä¼šè§‚å¯Ÿåˆ°ï¼Œå°¤å…¶æ˜¯åœ¨ç”¨æˆ·ç©ºé—´ä¸­ï¼‰ã€‚</li>\n      <li>\"D\" çŠ¶æ€åç§°æœ‰å†å²åŸå› ï¼Œå› ä¸ºæœ€åˆè®¤ä¸ºè¿™ç§çŠ¶æ€æ˜¯è¿›ç¨‹å¤„äºâ€œç£ç›˜ç­‰å¾…â€çŠ¶æ€ã€‚ä½†ç°åœ¨ï¼Œä¸â€œç£ç›˜ IOâ€åˆ†ç¦»çš„ç½‘ç»œã€é”å’Œå…¶ä»–èµ„æºå¯èƒ½å¯¼è‡´è¿›ç¨‹å¤„äºä¸å¯ä¸­æ–­çš„ç­‰å¾…çŠ¶æ€ã€‚æœ‰å…³è¿›ç¨‹çŠ¶æ€çš„æ›´å¤šèƒŒæ™¯ä¿¡æ¯ï¼Œè¯·å‚é˜… \"<a href=\"https://access.redhat.com/sites/default/files/attachments/processstates_20120831.pdf\">äº†è§£ Linux è¿›ç¨‹çŠ¶æ€</a>\"ã€‚å…·ä½“æ¥è¯´ï¼Œæˆ‘ä»¬æ€»ç»“äº† \"D\" çŠ¶æ€è¿‡ç¨‹å¦‚ä¸‹ï¼šâ€œä¸å¯ä¸­æ–­ç¡çœ çŠ¶æ€æ˜¯ä¸ä¼šç«‹å³å¤„ç†ä¿¡å·çš„çŠ¶æ€ã€‚å®ƒåªæœ‰åœ¨ç­‰å¾…èµ„æºå˜å¾—å¯ç”¨æˆ–è€…åœ¨ç­‰å¾…æœŸé—´å‘ç”Ÿè¶…æ—¶(å¦‚æœåœ¨è¿›ç¨‹è¿›å…¥ç¡çœ æ—¶æŒ‡å®šäº†è¶…æ—¶)æ—¶æ‰ä¼šè¢«å”¤é†’ã€‚â€</li>\n    </ul>\n  </li>\n  <li>å½“çº¿ç¨‹è¿›å…¥ \"D\" çŠ¶æ€å¹¶ä¸”æœªèƒ½åœ¨åˆç†çš„æ—¶é—´å†…é€€å‡ºè¯¥çŠ¶æ€æ—¶ï¼Œå°±ä¼šå‡ºç°é—®é¢˜ã€‚è¿™ä¸ªè¿›ç¨‹ç°åœ¨è¢«â€œå¡ä½â€ï¼Œä»»ä½•ç­‰å¾…å®ƒçš„è¿›ç¨‹ï¼ˆå¯èƒ½åœ¨å®ƒåé¢çš„é˜Ÿåˆ—ä¸­è®¿é—®ç›¸åŒçš„ç¡¬ä»¶ï¼‰æˆ–ä¾èµ–å®ƒçš„è¿›ç¨‹ä¹ŸåŒæ ·è¢«å¡ä½ã€‚\n    <ul>\n      <li>è™½ç„¶â€œåˆç†çš„æ—¶é—´â€æ˜¯ä¸»è§‚çš„ï¼Œä½†å¦‚æœä¸€ä¸ªä»»åŠ¡åœ¨ D çŠ¶æ€ä¸‹åœæ»å¤ªä¹…ï¼Œé‚£ä¹ˆ \"<a href=\"https://access.redhat.com/solutions/31453\">INFO: task <process>:<pid> blocked for more than ... seconds</a>\" çš„æ¶ˆæ¯å°±ä¼šè¾“å‡ºï¼Œé€šçŸ¥ç³»ç»Ÿç®¡ç†å‘˜éœ€è¦è°ƒæŸ¥æˆ–å¯èƒ½éœ€è¦<a href=\"https://access.redhat.com/solutions/39188\">ç³»ç»Ÿè°ƒä¼˜</a>çš„æ½œåœ¨æƒ…å†µã€‚</li>\n    </ul>\n  </li>\n  <li>è¦æŸ¥çœ‹å“ªä¸ªè¿›ç¨‹/çº¿ç¨‹ä¿æŒåœ¨ \"D\" çŠ¶æ€ï¼š\n    <ul>\n      <li>è·å–å¤„äº \"D\" çŠ¶æ€çš„çº¿ç¨‹åˆ—è¡¨ï¼š\n        <code>ps auxH | awk '$8 ~ /^D/{print}'</code>\n      </li>\n      <li>æ˜¾ç¤ºæ¯ä¸ªçº¿ç¨‹<code>sudo cat /proc/&lt;PID&gt;/stack</code> çš„å †æ ˆï¼š<br>\n        <code>for D_PID in $(ps auxH | awk '$8 ~ /^D/{print $2}');do ps -Llp $D_PID;sudo cat /proc/$D_PID/stack;echo;done</code>\n      </li>\n    </ul>\n  </li>\n</ul>\n\n## æ ¹æœ¬åŸå› \n\n- å‘ç°å¤„äº D çŠ¶æ€çš„è¿›ç¨‹æ˜¯ç›¸å½“æ™®éå’Œæ­£å¸¸çš„\n- åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œè¿™æ˜¯ç”±äºå¯¹ I/O èµ„æºï¼ˆé€šå¸¸æ˜¯æœ¬åœ°æˆ–è¿œç¨‹å­˜å‚¨ã€ç½‘ç»œæ–‡ä»¶ç³»ç»Ÿç­‰ï¼‰çš„è®¿é—®ä¸­æ–­é€ æˆçš„\n- å¦‚æœä¸€ä¸ªè¿›ç¨‹åœ¨ D çŠ¶æ€åœæ»å¤ªä¹…ï¼Œé‚£ä¹ˆå†…æ ¸ä¸­çš„â€œ<a href=\"https://access.redhat.com/solutions/31453\">åœæ»ä»»åŠ¡</a>â€é€»è¾‘å°†è¢«å¯ç”¨\n\n## è¯Šæ–­æ­¥éª¤\n\n- æ£€æŸ¥ ps è¾“å‡ºä¸­æ˜¯å¦æœ‰å¤„äº D çŠ¶æ€çš„çº¿ç¨‹ï¼Œå¯ä»¥ä½¿ç”¨ç±»ä¼¼äºä»¥ä¸‹å†…å®¹çš„å†…å®¹ï¼š<code>ps auxH | awk '$8 ~ /^D/{print}'</code>\n- è´Ÿè½½å¯èƒ½å¾ˆé«˜è€Œä¸”è¿˜åœ¨å¢åŠ ï¼ˆå¯èƒ½æœ‰æˆç™¾ç”šè‡³åˆ°æ•°åƒï¼Œ1 åˆ†é’Ÿè´Ÿè½½å§‹ç»ˆé«˜äº 5 åˆ†é’Ÿï¼Œ5 åˆ†é’Ÿå§‹ç»ˆé«˜äº 15 åˆ†é’Ÿï¼Œæš—ç¤ºæŠ¥å‘Šçš„è´Ÿè½½ä¸æ–­å¢åŠ ï¼‰ï¼›æœºå™¨çš„å“åº”èƒ½åŠ›ä¸è¿™ä¸ªé«˜æ•°å­—ä¸åŒ¹é…ï¼ˆæœºå™¨è¿˜èƒ½å“åº”å‘½ä»¤ï¼Œä½†æ˜¯å¦‚æœæ‰€æœ‰æ ¸å¿ƒéƒ½è¢«å æ®ä¹‹åï¼Œå¯èƒ½ç³»ç»Ÿå°±ä¸å†å“åº”ï¼‰\n- è§£å†³é—®é¢˜çš„ç¬¬ä¸€æ­¥ï¼ˆå‡è®¾å‰ä¸¤ä¸ªæ­¥éª¤å¾—åˆ°äº†éªŒè¯ï¼‰æ˜¯éš”ç¦»å¯¼è‡´è¿™ç§æƒ…å†µçš„èµ„æºï¼ˆæœ€æœ‰å¯èƒ½çš„å­˜å‚¨/æ–‡ä»¶ç³»ç»Ÿï¼‰ï¼Œä¾‹å¦‚æŸ¥çœ‹å¤„äº d çŠ¶æ€ï¼ˆå½“å‰å·¥ä½œï¼‰çš„è¿›ç¨‹çš„å…±åŒä½¿ç”¨çš„æ–‡ä»¶æˆ–è€…ç›®å½•ç­‰\n- ä¸€æ—¦ç¡®å®šäº†æ‰€æ¶‰åŠçš„èµ„æºï¼Œå°±åº”é‡‡å–æªæ–½æ¢å¤å¯¹å®ƒçš„è®¿é—®ï¼›æ ¹æ®å…·ä½“æƒ…å†µï¼Œå¯èƒ½ä¼šé‡æ–°è·å¾—å¯¹åœ¨çº¿æ–‡ä»¶ç³»ç»Ÿ/å­˜å‚¨çš„è®¿é—®ï¼Œæˆ–è€…å¯èƒ½éœ€è¦é‡æ–°å¯åŠ¨æœºå™¨æ‰èƒ½å®Œå…¨æ¢å¤ï¼ˆæœ€æœ‰å¯èƒ½çš„æƒ…å†µï¼‰\n\n\n> å‚è€ƒé“¾æ¥\n> - <a href>What is \"D\" state (or dstate, d-state)?</a>\n> - <a href=\"https://mp.weixin.qq.com/s?__biz=MzI0OTIzOTMzMA==&mid=2247485072&idx=1&sn=c9bd418f4dcb9ce2cffd9dfb20461640&chksm=e995c4dddee24dcbc6450633da0627cf65ec92ca61e4e487b774882c5a51db0210a79f3f890a&scene=21#wechat_redirect\">ä¸€æ–‡è®©ä½ åº”å¯¹Linux è¿›ç¨‹â€œDâ€çŠ¶æ€</a>","tags":["linux"]},{"title":"çº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢ä¸è¿›ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢çš„åŒºåˆ«","url":"/2023/12/14/2023-12-14-çº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢ä¸è¿›ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢çš„åŒºåˆ«/","content":"\nä¸Šä¸‹æ–‡åˆ‡æ¢æ˜¯æ“ä½œç³»ç»Ÿåœ¨å¤šä»»åŠ¡ç¯å¢ƒä¸­ç®¡ç†å¤šä¸ªçº¿ç¨‹æˆ–è¿›ç¨‹çš„åŸºæœ¬æ“ä½œã€‚å®ƒæ¶‰åŠåˆ°ä¿å­˜ä¸€ä¸ªçº¿ç¨‹æˆ–è¿›ç¨‹çš„å½“å‰æ‰§è¡Œä¸Šä¸‹æ–‡ï¼Œå¹¶æ¢å¤å¦ä¸€ä¸ªçº¿ç¨‹æˆ–è¿›ç¨‹çš„æ‰§è¡Œä¸Šä¸‹æ–‡ã€‚è¿™å…è®¸æ“ä½œç³»ç»Ÿåœ¨ä¸åŒçš„çº¿ç¨‹ä¹‹é—´å¿«é€Ÿåˆ‡æ¢ï¼Œç»™äººä¸€ç§å¹¶å‘æ‰§è¡Œçš„é”™è§‰ã€‚\n\næœ‰ä¸¤ç§ç±»å‹çš„ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼šâ€œçº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢â€å’Œâ€œè¿›ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢â€ã€‚è®©æˆ‘ä»¬æ¥çœ‹çœ‹å®ƒä»¬ä¹‹é—´çš„åŒºåˆ«ã€‚\n\n## ä»€ä¹ˆæ˜¯çº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Ÿ\n\nçº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢æŒ‡çš„æ˜¯ä¿å­˜æ­£åœ¨è¿›è¡Œçš„çº¿ç¨‹çš„å½“å‰æ‰§è¡Œä¸Šä¸‹æ–‡ï¼Œå¹¶æ¢å¤å¦ä¸€ä¸ªçº¿ç¨‹çš„æ‰§è¡Œä¸Šä¸‹æ–‡ä»¥å…è®¸å®ƒåœ¨è¿è¡Œçš„è¿‡ç¨‹ã€‚åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸­ï¼Œå•ä¸ªè¿›ç¨‹ä¸­çš„å¤šä¸ªçº¿ç¨‹å¯ä»¥å¹¶å‘æ‰§è¡Œï¼Œæ“ä½œç³»ç»Ÿæ‰§è¡Œçº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢ä»¥åœ¨ä¸åŒçº¿ç¨‹ä¹‹é—´åˆ‡æ¢æ‰§è¡Œã€‚ä¸‹é¢æ˜¯çº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢çš„å…³é”®ç‰¹å¾ï¼š\n\n- **ç²’åº¦ï¼ˆGranularityï¼‰**ï¼šçº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢æ“ä½œçš„ç²’åº¦æ¯”è¿›ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢æ›´ç»†ã€‚å®ƒä»¬æ¶‰åŠåœ¨åŒä¸€è¿›ç¨‹å†…çš„çº¿ç¨‹ä¹‹é—´åˆ‡æ¢ï¼Œä¸è¿›ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢ç›¸æ¯”ï¼Œå…è®¸æ›´å¿«çš„åˆ‡æ¢å’Œæ›´ä½çš„å¼€é”€ã€‚\n\n- **æ‰§è¡Œä¸Šä¸‹æ–‡ï¼ˆExecution Contextï¼‰**ï¼šåœ¨çº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢æœŸé—´ï¼Œä¿å­˜å½“å‰çº¿ç¨‹çš„æ‰§è¡Œä¸Šä¸‹æ–‡ï¼ŒåŒ…æ‹¬ç¨‹åºè®¡æ•°å™¨ã€å †æ ˆæŒ‡é’ˆå’Œå¯„å­˜å™¨å€¼ã€‚ç„¶åæ¢å¤å¦ä¸€ä¸ªçº¿ç¨‹çš„ä¸Šä¸‹æ–‡ï¼Œå…è®¸å®ƒä»åœæ­¢çš„åœ°æ–¹ç»§ç»­æ‰§è¡Œã€‚\n\n- **å…±äº«å†…å­˜ï¼ˆShared Memoryï¼‰**ï¼šè¿›ç¨‹ä¸­çš„çº¿ç¨‹å…±äº«ç›¸åŒçš„å†…å­˜ç©ºé—´ã€‚å› æ­¤ï¼Œåœ¨çº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢æœŸé—´ï¼Œä¸éœ€è¦åˆ‡æ¢å†…å­˜åœ°å€ç©ºé—´æˆ–æ›´æ–°å†…å­˜ç®¡ç†ç»“æ„ã€‚å†…å­˜ä¿æŒå®Œæ•´ï¼Œçº¿ç¨‹å¯ä»¥ç›´æ¥è®¿é—®å…±äº«æ•°æ®ï¼Œè€Œä¸éœ€è¦ä»»ä½•é¢å¤–çš„å¼€é”€ã€‚\n\n## ä»€ä¹ˆæ˜¯è¿›ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Ÿ\n\nå¦ä¸€æ–¹é¢ï¼Œè¿›ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢æ¶‰åŠåˆ°ä¿å­˜æ­£åœ¨è¿è¡Œçš„è¿›ç¨‹çš„å½“å‰æ‰§è¡Œä¸Šä¸‹æ–‡å’Œæ¢å¤å¦ä¸€ä¸ªè¿›ç¨‹çš„æ‰§è¡Œä¸Šä¸‹æ–‡ã€‚å®ƒå…è®¸æ“ä½œç³»ç»Ÿåœ¨ä¸åŒçš„ç‹¬ç«‹è¿›ç¨‹ä¹‹é—´åˆ‡æ¢ï¼Œæ¯ä¸ªè¿›ç¨‹éƒ½æœ‰è‡ªå·±çš„å†…å­˜ç©ºé—´å’Œèµ„æºã€‚ä»¥ä¸‹æ˜¯è¿›ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢çš„å…³é”®ç‰¹å¾:\n\n- **ç²’åº¦ï¼ˆGranularityï¼‰**ï¼šè¿›ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢æ“ä½œçš„ç²’åº¦æ¯”çº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢æ“ä½œçš„ç²’åº¦æ›´ç²—ã€‚å®ƒä»¬æ¶‰åŠåœ¨ä¸åŒè¿›ç¨‹ä¹‹é—´åˆ‡æ¢ï¼Œè¿™äº›è¿›ç¨‹é€šå¸¸æœ‰è‡ªå·±çš„å†…å­˜ç©ºé—´å’Œèµ„æºåˆ†é…ã€‚ç”±äºéœ€è¦å†…å­˜ç®¡ç†æ›´æ–°å’Œæ½œåœ¨çš„ç¼“å­˜åˆ·æ–°ï¼Œè¿›ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢é€šå¸¸æ¯”çº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢æ›´åŠ æ˜‚è´µå’Œè€—æ—¶ã€‚\n\n- **æ‰§è¡Œä¸Šä¸‹æ–‡ï¼ˆExecution Contextï¼‰**ï¼šåœ¨è¿›ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢æœŸé—´ï¼Œä¿å­˜å½“å‰è¿›ç¨‹çš„æ‰§è¡Œä¸Šä¸‹æ–‡ï¼ŒåŒ…æ‹¬ç¨‹åºè®¡æ•°å™¨ã€å †æ ˆæŒ‡é’ˆã€å¯„å­˜å™¨å€¼å’Œå†…å­˜ç®¡ç†ç»“æ„ã€‚ç„¶åè¿˜åŸå¦ä¸€ä¸ªè¿›ç¨‹çš„æ‰§è¡Œä¸Šä¸‹æ–‡ï¼Œå…è®¸å®ƒä»ä¸­æ–­çš„åœ°æ–¹ç»§ç»­æ‰§è¡Œã€‚\n\n- **å…±äº«å†…å­˜ï¼ˆShared Memoryï¼‰**ï¼šè¿›ç¨‹æœ‰å…¶ç‹¬ç«‹çš„å†…å­˜ç©ºé—´ï¼Œå…¶ä¸­å¯èƒ½åŒ…æ‹¬è™šæ‹Ÿåœ°å€ç©ºé—´ã€é¡µè¡¨å’Œå†…å­˜ä¿æŠ¤æœºåˆ¶ã€‚åœ¨è¿›ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢æœŸé—´ï¼Œå†…å­˜ç®¡ç†ç»“æ„éœ€è¦æ›´æ–°ï¼Œä»¥åæ˜ æ–°è¿›ç¨‹çš„å†…å­˜ç©ºé—´ï¼Œä¸çº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢ç›¸æ¯”ï¼Œè¿™ä¼šå¸¦æ¥é¢å¤–çš„å¼€é”€ã€‚\n\n- **ä¿æŠ¤å’Œéš”ç¦»ï¼ˆProtection and Isolationï¼‰**ï¼šè¿›ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢åœ¨è¿›ç¨‹ä¹‹é—´æä¾›æ›´é«˜çº§åˆ«çš„ä¿æŠ¤å’Œéš”ç¦»ã€‚æ¯ä¸ªè¿›ç¨‹åœ¨è‡ªå·±çš„å†…å­˜ç©ºé—´ä¸­è¿è¡Œï¼Œæä¾›æ›´å¥½çš„å®‰å…¨æ€§å’Œæ•…éšœéš”ç¦»ã€‚è¿›ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢ç¡®ä¿è¿›ç¨‹ä¸èƒ½ç›´æ¥è®¿é—®æˆ–å¹²æ‰°å½¼æ­¤çš„å†…å­˜æˆ–èµ„æºã€‚\n\n## çº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢å’Œè¿›ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢\n\nçº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢å’Œè¿›ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼š\n\n| ç‰¹å¾ | çº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢ | è¿›ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢ |\n|--|--|--|\n| å®šä¹‰ | ä¿å­˜æ­£åœ¨è¿è¡Œçš„çº¿ç¨‹çš„å½“å‰çŠ¶æ€(ä¸Šä¸‹æ–‡)å¹¶åŠ è½½å¦ä¸€ä¸ªçº¿ç¨‹çš„ä¿å­˜çŠ¶æ€ä»¥ä¾›æ‰§è¡Œçš„è¿‡ç¨‹ | ä¿å­˜æ­£åœ¨è¿è¡Œçš„è¿›ç¨‹çš„å½“å‰çŠ¶æ€(ä¸Šä¸‹æ–‡)å¹¶åŠ è½½å¦ä¸€ä¸ªè¿›ç¨‹çš„ä¿å­˜çŠ¶æ€ä»¥ä¾›æ‰§è¡Œçš„è¿›ç¨‹ |\n| ç²’åº¦ | åœ¨è¿›ç¨‹çš„çº¿ç¨‹çº§åˆ«ä¸Šå‘ç”Ÿï¼Œä¸€ä¸ªè¿›ç¨‹ä¸­å¯ä»¥å­˜åœ¨å¤šä¸ªçº¿ç¨‹ | åœ¨è¿›ç¨‹çº§åˆ«å‘ç”Ÿï¼Œæ¯ä¸ªè¿›ç¨‹å¯ä»¥æœ‰ä¸€ä¸ªæˆ–å¤šä¸ªçº¿ç¨‹ã€‚ |\n| æ‰§è¡Œç¯å¢ƒ | åœ¨åŒä¸€ä¸ªè¿›ç¨‹ä¸­ï¼Œçº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢å‘ç”Ÿåœ¨ç›¸åŒçš„å†…å­˜ç©ºé—´ä¸­ï¼Œå¹¶å…±äº«ç›¸åŒçš„èµ„æº | è¿›ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢æ¶‰åŠä¸åŒçš„è¿›ç¨‹ï¼Œå®ƒä»¬æœ‰è‡ªå·±çš„å†…å­˜ç©ºé—´å’Œèµ„æº |\n| å¼€é”€ | çº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢é€šå¸¸æ¯”è¿›ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢å…·æœ‰æ›´ä½çš„å¼€é”€ï¼Œå› ä¸ºå®ƒä»¬æ¶‰åŠåœ¨åŒä¸€è¿›ç¨‹å†…çš„çº¿ç¨‹ä¹‹é—´è¿›è¡Œåˆ‡æ¢ | ç”±äºéœ€è¦åœ¨ä¸åŒè¿›ç¨‹ä¹‹é—´è¿›è¡Œåˆ‡æ¢ï¼Œå› æ­¤è¿›ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢çš„å¼€é”€è¾ƒé«˜ï¼Œéœ€è¦å¯¹å†…å­˜å’Œèµ„æºæ˜ å°„è¿›è¡Œæ›´å¹¿æ³›çš„æ›´æ”¹ |\n| è°ƒåº¦ | çº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢é€šå¸¸ç”±æ“ä½œç³»ç»Ÿçš„çº¿ç¨‹è°ƒåº¦ç¨‹åºç®¡ç† | è¿›ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢ç”±æ“ä½œç³»ç»Ÿçš„è¿›ç¨‹è°ƒåº¦ç¨‹åºç®¡ç† |\n| æ—¶é—´å¤æ‚æ€§ | çº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢é€šå¸¸å…·æœ‰è¾ƒä½çš„æ—¶é—´å¤æ‚æ€§ï¼Œå› ä¸ºå®ƒä»¬æ¶‰åŠåœ¨åŒä¸€è¿›ç¨‹å†…çš„çº¿ç¨‹ä¹‹é—´è¿›è¡Œåˆ‡æ¢ | ç”±äºéœ€è¦ä¸ºä¸åŒçš„è¿›ç¨‹æ‰§è¡Œæ›´å¹¿æ³›çš„ä¸Šä¸‹æ–‡ä¿å­˜å’Œæ¢å¤æ“ä½œï¼Œè¿›ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢çš„æ—¶é—´å¤æ‚åº¦è¾ƒé«˜ |\n| å¯¹ç³»ç»Ÿèµ„æºçš„å½±å“ | çº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢å¯¹ç³»ç»Ÿèµ„æºçš„å½±å“ç›¸å¯¹è¾ƒå°ï¼Œå› ä¸ºè¿›ç¨‹ä¸­çš„çº¿ç¨‹å…±äº«è®¸å¤šèµ„æº | è¿›ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢å¯¹ç³»ç»Ÿèµ„æºçš„å½±å“æ›´å¤§ï¼Œå› ä¸ºä¸åŒçš„è¿›ç¨‹æœ‰è‡ªå·±çš„å†…å­˜ç©ºé—´å’Œèµ„æºåˆ†é… |\n| é€šè®¯ä¸åŒæ­¥ | åŒä¸€è¿›ç¨‹ä¸­çš„çº¿ç¨‹å¯ä»¥ä½¿ç”¨å…±äº«å†…å­˜æˆ–åŒæ­¥åŸè¯­è½»æ¾åœ°è¿›è¡Œé€šä¿¡å’ŒåŒæ­¥ | è¿›ç¨‹é€šå¸¸ä½¿ç”¨è¿›ç¨‹é—´é€šä¿¡æœºåˆ¶(å¦‚ç®¡é“ã€å¥—æ¥å­—æˆ–æ¶ˆæ¯é˜Ÿåˆ—)å½¼æ­¤è¿›è¡Œé€šä¿¡å’ŒåŒæ­¥ |\n| ä¾‹å­ | åœ¨ Web æœåŠ¡å™¨ä¸­çš„ä¸åŒçº¿ç¨‹ä¹‹é—´åˆ‡æ¢ä»¥åŒæ—¶å¤„ç†å¤šä¸ªå®¢æˆ·ç«¯è¯·æ±‚ã€‚ | åœ¨å¤šä»»åŠ¡æ“ä½œç³»ç»Ÿä¸Šè¿è¡Œä¸åŒåº”ç”¨ç¨‹åºçš„ä¸åŒè¿›ç¨‹ä¹‹é—´åˆ‡æ¢ |\n\n## ç»“è®º\n\n1. çº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢æ¶‰åŠåœ¨åŒä¸€è¿›ç¨‹å†…çš„çº¿ç¨‹ä¹‹é—´åˆ‡æ¢æ‰§è¡Œï¼Œè€Œè¿›ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢æ¶‰åŠåœ¨ä¸åŒç‹¬ç«‹è¿›ç¨‹ä¹‹é—´åˆ‡æ¢æ‰§è¡Œã€‚\n2. çº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢é€Ÿåº¦æ›´å¿«ï¼Œå¼€é”€æ›´ä½ï¼Œå› ä¸ºå®ƒä»¬ä¸éœ€è¦æ›´æ–°å†…å­˜ç®¡ç†ç»“æ„ã€‚\n3. è¿›ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢è¾ƒæ…¢ï¼Œæ¶‰åŠæ›´æ–°å†…å­˜ç®¡ç†ç»“æ„ï¼Œä»¥ä¾¿åœ¨ä¸åŒçš„å†…å­˜ç©ºé—´ä¹‹é—´åˆ‡æ¢ï¼Œå¹¶åœ¨è¿›ç¨‹ä¹‹é—´æä¾›æ›´å¥½çš„éš”ç¦»\n\n> å‚è€ƒé“¾æ¥\n> - https://www.tutorialspoint.com/difference-between-thread-context-switch-and-process-context-switch","tags":["æ€§èƒ½æµ‹è¯•"]},{"title":"çº¿ç¨‹å’Œè¿›ç¨‹çš„åŒºåˆ«","url":"/2023/12/14/2023-12-14-çº¿ç¨‹å’Œè¿›ç¨‹çš„åŒºåˆ«/","content":"\n**è¿›ç¨‹**ï¼ˆprocessï¼‰å’Œ**çº¿ç¨‹**ï¼ˆthreadï¼‰å½¼æ­¤ç›¸å…³ï¼Œéå¸¸ç›¸ä¼¼ï¼Œå› ä¸ºå®ƒä»¬æ˜¯ç‹¬ç«‹çš„æ‰§è¡Œé¡ºåºã€‚è¿›ç¨‹å’Œçº¿ç¨‹çš„åŸºæœ¬åŒºåˆ«åœ¨äºï¼Œè¿›ç¨‹å‘ç”Ÿåœ¨ä¸åŒçš„å†…å­˜ç©ºé—´ï¼Œè€Œçº¿ç¨‹åœ¨ç›¸åŒçš„å†…å­˜ç©ºé—´ä¸­æ‰§è¡Œã€‚\n\né€šè¯»æœ¬æ–‡ï¼Œå¸Œæœ›ä½ èƒ½æ‰¾å‡ºåœ¨æ“ä½œç³»ç»Ÿä¸Šä¸‹æ–‡ä¸­è¿›ç¨‹ä¸çº¿ç¨‹çš„ä¸åŒä¹‹å¤„ã€‚è®©æˆ‘ä»¬ä»çº¿ç¨‹å’Œè¿›ç¨‹çš„ä¸€äº›åŸºæœ¬çŸ¥è¯†å¼€å§‹ã€‚\n\n## ä»€ä¹ˆæ˜¯è¿›ç¨‹ï¼Ÿ\n\n**è¿›ç¨‹**æ˜¯ä¸€ä¸ªæ´»åŠ¨çš„ç¨‹åºï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œä¸€ä¸ªæ­£åœ¨æ‰§è¡Œçš„ç¨‹åºã€‚å®ƒä¸ä»…ä»…æ˜¯ç¨‹åºä»£ç ï¼Œå› ä¸ºå®ƒåŒ…æ‹¬ç¨‹åºè®¡æ•°å™¨ã€è¿›ç¨‹å †æ ˆã€å¯„å­˜å™¨ã€ç¨‹åºä»£ç ç­‰ã€‚ä¸æ­¤ç›¸æ¯”ï¼Œç¨‹åºä»£ç åªæ˜¯æ–‡æœ¬éƒ¨åˆ†ã€‚\n\nå½“è®¡ç®—æœºç¨‹åºè¢«è§¦å‘æ‰§è¡Œæ—¶ï¼Œå®ƒå¹¶ä¸æ˜¯ç›´æ¥è¿è¡Œï¼Œè€Œæ˜¯é¦–å…ˆç¡®å®šç¨‹åºæ‰§è¡Œæ‰€éœ€çš„æ­¥éª¤ï¼Œè€Œéµå¾ªè¿™äº›æ­¥éª¤æ‰§è¡Œçš„è¿‡ç¨‹ç§°ä¸ºè¿›ç¨‹ã€‚\n\nè¿›ç¨‹å¯ä»¥åˆ†ä¸ºä¸¤ç§ç±»å‹ï¼Œå³**å…‹éš†è¿›ç¨‹**å’Œ**çˆ¶è¿›ç¨‹**ã€‚å…‹éš†è¿›ç¨‹ä¹Ÿç§°ä¸ºå­è¿›ç¨‹ï¼Œæ˜¯ç”±å¦ä¸€ä¸ªè¿›ç¨‹åˆ›å»ºçš„è¿›ç¨‹ï¼Œè€Œä¸»è¿›ç¨‹æ˜¯è´Ÿè´£åˆ›å»ºå…¶ä»–è¿›ç¨‹ï¼Œä»¥åŒæ—¶æ‰§è¡Œå¤šä¸ªä»»åŠ¡çš„è¿›ç¨‹ï¼Œç§°ä¸ºçˆ¶è¿›ç¨‹ã€‚\n\n## ä»€ä¹ˆæ˜¯çº¿ç¨‹ï¼Ÿ\n\n**çº¿ç¨‹**æ˜¯å¯ç”±è°ƒåº¦ç¨‹åºç‹¬ç«‹ç®¡ç†çš„è½»é‡çº§è¿›ç¨‹ã€‚å®ƒä½¿ç”¨å¹¶è¡Œæ€§æé«˜äº†åº”ç”¨ç¨‹åºçš„æ€§èƒ½ã€‚çº¿ç¨‹ä¸å…¶å¯¹ç­‰çº¿ç¨‹å…±äº«æ•°æ®æ®µã€ä»£ç æ®µã€æ–‡ä»¶ç­‰ä¿¡æ¯ï¼ŒåŒæ—¶åŒ…å«è‡ªå·±çš„å¯„å­˜å™¨ã€å †æ ˆã€è®¡æ•°å™¨ç­‰ã€‚\n\nçº¿ç¨‹åŸºæœ¬ä¸Šæ˜¯å¤§å‹è¿›ç¨‹çš„ä¸€ä¸ªå­éƒ¨åˆ†ã€‚åœ¨è¿›ç¨‹ä¸­ï¼Œè¿›ç¨‹ä¸­çš„æ‰€æœ‰çº¿ç¨‹éƒ½æ˜¯ç›¸äº’å…³è”çš„ã€‚å…¸å‹çš„çº¿ç¨‹åŒ…å«ä¸€äº›ä¿¡æ¯ï¼Œå¦‚æ•°æ®æ®µã€ä»£ç æ®µç­‰ã€‚è¿™äº›ä¿¡æ¯å°†åœ¨æ‰§è¡ŒæœŸé—´å…±äº«ç»™å®ƒä»¬çš„å¯¹ç­‰çº¿ç¨‹ã€‚\n\nçº¿ç¨‹æœ€é‡è¦çš„ç‰¹æ€§æ˜¯å®ƒä»¬ä¸å®ƒä»¬æ‰€å±çš„è¿›ç¨‹ä¸­çš„å¯¹ç­‰çº¿ç¨‹å…±äº«å†…å­˜ã€æ•°æ®ã€èµ„æºç­‰ã€‚æ­¤å¤–ï¼Œè¿›ç¨‹ä¸­çš„æ‰€æœ‰çº¿ç¨‹éƒ½éœ€è¦è¿›è¡ŒåŒæ­¥ï¼Œä»¥é¿å…æ„å¤–çš„ç»“æœã€‚\n\n## è¿›ç¨‹ä¸çº¿ç¨‹çš„åŒºåˆ«\n\nä¸‹è¡¨çªå‡ºæ˜¾ç¤ºäº†è¿›ç¨‹å’Œçº¿ç¨‹ä¹‹é—´çš„ä¸»è¦åŒºåˆ«ï¼š\n\n| æ¯”è¾ƒ | è¿›ç¨‹ | çº¿ç¨‹ |\n|--|--|--|\n| å®šä¹‰ | è¿›ç¨‹æ˜¯ä¸€ä¸ªæ­£åœ¨æ‰§è¡Œçš„ç¨‹åºï¼Œä¹Ÿå°±æ˜¯æ´»åŠ¨çš„ç¨‹åº | çº¿ç¨‹æ˜¯å¯ç”±è°ƒåº¦ç¨‹åºç‹¬ç«‹ç®¡ç†çš„è½»é‡çº§è¿›ç¨‹ |\n| ä¸Šä¸‹æ–‡åˆ‡æ¢æ—¶é—´ | è¿›ç¨‹éœ€è¦æ›´å¤šçš„æ—¶é—´è¿›è¡Œä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œå› ä¸ºå®ƒä»¬æ¯”è¾ƒç¹é‡ | çº¿ç¨‹éœ€è¦æ›´å°‘çš„æ—¶é—´è¿›è¡Œä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œå› ä¸ºå®ƒä»¬æ¯”è¿›ç¨‹è½» |\n| å†…å­˜å…±äº« | è¿›ç¨‹æ˜¯å®Œå…¨ç‹¬ç«‹çš„ï¼Œä¸å…±äº«å†…å­˜ | è¿›ç¨‹æ˜¯å®Œå…¨ç‹¬ç«‹çš„ï¼Œä¸å…±äº«å†…å­˜ã€‚ |\n| é€šä¿¡è€—æ—¶ | è¿›ç¨‹ä¹‹é—´çš„é€šä¿¡æ¯”çº¿ç¨‹ä¹‹é—´çš„é€šä¿¡éœ€è¦æ›´å¤šçš„æ—¶é—´ | çº¿ç¨‹ä¹‹é—´çš„é€šä¿¡æ¯”è¿›ç¨‹ä¹‹é—´çš„é€šä¿¡éœ€è¦æ›´å°‘çš„æ—¶é—´ |\n| é˜»å¡å¤„ç† | å¦‚æœä¸€ä¸ªè¿›ç¨‹è¢«é˜»å¡ï¼Œå…¶ä½™è¿›ç¨‹å¯ä»¥ç»§ç»­æ‰§è¡Œ | å¦‚æœç”¨æˆ·çº§çº¿ç¨‹è¢«é˜»å¡ï¼Œå®ƒçš„æ‰€æœ‰å¯¹ç­‰çº¿ç¨‹ä¹Ÿä¼šè¢«é˜»å¡ |\n| èµ„æºæ¶ˆè€— | è¿›ç¨‹æ¯”çº¿ç¨‹éœ€è¦æ›´å¤šçš„èµ„æº | çº¿ç¨‹é€šå¸¸æ¯”è¿›ç¨‹éœ€è¦æ›´å°‘çš„èµ„æº |\n| ä¾èµ–æ€§ | å„ä¸ªè¿‡ç¨‹æ˜¯ç›¸äº’ç‹¬ç«‹çš„ | çº¿ç¨‹æ˜¯è¿›ç¨‹çš„ä¸€éƒ¨åˆ†ï¼Œå› æ­¤æ˜¯ä¾èµ–çš„ |\n| æ•°æ®å’Œä»£ç å…±äº« | è¿›ç¨‹å…·æœ‰ç‹¬ç«‹çš„æ•°æ®å’Œä»£ç æ®µ | çº¿ç¨‹ä¸å…¶å¯¹ç­‰çº¿ç¨‹å…±äº«æ•°æ®æ®µã€ä»£ç æ®µã€æ–‡ä»¶ç­‰ |\n| åˆ›å»ºæ—¶é—´ | è¿›ç¨‹åˆ›å»ºéœ€è¦æ›´å¤šçš„æ—¶é—´ | çº¿ç¨‹åˆ›å»ºæ‰€éœ€çš„æ—¶é—´æ›´å°‘ |\n| ç»ˆæ­¢æ—¶é—´ | è¿›ç¨‹éœ€è¦æ›´å¤šçš„æ—¶é—´æ¥ç»ˆæ­¢ | è¿›ç¨‹éœ€è¦æ›´å¤šçš„æ—¶é—´æ¥ç»ˆæ­¢ |\n\n## ç»“è®º\n\nè¿›ç¨‹å’Œçº¿ç¨‹ä¹‹é—´æœ€æ˜¾è‘—çš„åŒºåˆ«åœ¨äºï¼Œè¿›ç¨‹è¢«å®šä¹‰ä¸ºç”±è®¡ç®—æœºå®Œæˆçš„ä»»åŠ¡ï¼Œè€Œçº¿ç¨‹æ˜¯å¯ç”±è°ƒåº¦ç¨‹åºç‹¬ç«‹ç®¡ç†çš„è½»é‡çº§è¿›ç¨‹ã€‚\n\n> å‚è€ƒé“¾æ¥\n> - https://www.tutorialspoint.com/difference-between-process-and-thread\n","tags":["æ€§èƒ½æµ‹è¯•"]},{"title":"é¢å‘å¼€å‘äººå‘˜çš„å‘é‡åµŒå…¥ï¼šåŸºç¡€çŸ¥è¯†","url":"/2023/12/13/2023-12-13-vector_embeddings_for_developers/","content":"\n> æœ¬æ–‡æ˜¯ä¸€ç¯‡è‹±æ–‡ç¿»è¯‘è½¬è½½æ–‡ç« ï¼Œä¸»è¦ä»‹ç»äº†å‘é‡åµŒå…¥çš„ä¸€äº›åŸºç¡€çŸ¥è¯†ã€‚<br>\nåŸè‹±æ–‡é“¾æ¥ï¼šhttps://www.pinecone.io/learn/vector-embeddings-for-developers/<br>\n\nä½ å¯èƒ½è¿˜ä¸çŸ¥é“ï¼Œä½†æ˜¯å‘é‡å·²ç»åµŒå…¥æ— å¤„ä¸åœ¨ã€‚å®ƒä»¬æ˜¯è®¸å¤šæœºå™¨å­¦ä¹ å’Œæ·±åº¦å­¦ä¹ ç®—æ³•çš„åŸºçŸ³ï¼Œä»æœç´¢åˆ°äººå·¥æ™ºèƒ½åŠ©æ‰‹ç­‰åº”ç”¨ç¨‹åºéƒ½æ˜¯ç”¨è¿™äº›ç®—æ³•ã€‚å¦‚æœä½ æ­£åœ¨è€ƒè™‘åœ¨è¿™äº›é¢†åŸŸä¸­æ„å»ºè‡ªå·±çš„åº”ç”¨ç¨‹åºï¼Œé‚£ä¹ˆæœªæ¥ä½ å¯èƒ½ä¼šé‡åˆ°å‘é‡åµŒå…¥ã€‚åœ¨è¿™ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬å°†å°è¯•ä»‹ç»å‘é‡åµŒå…¥æ˜¯ä»€ä¹ˆä»¥åŠå¦‚ä½•ä½¿ç”¨å®ƒä»¬ã€‚\n\n## æˆ‘ä»¬è¦è§£å†³ä»€ä¹ˆé—®é¢˜ï¼Ÿ\n\nåœ¨æ„å»ºä¼ ç»Ÿåº”ç”¨ç¨‹åºæ—¶ï¼Œæ•°æ®ç»“æ„è¡¨ç¤ºä¸ºå¯èƒ½æ¥è‡ªæ•°æ®åº“çš„å¯¹è±¡ã€‚è¿™äº›å¯¹è±¡å…·æœ‰ä¸ä½ æ­£åœ¨æ„å»ºçš„åº”ç”¨ç¨‹åºç›¸åŒçš„å±æ€§ï¼ˆæˆ–æ•°æ®åº“ä¸­çš„åˆ—ï¼‰ã€‚\n\néšç€æ—¶é—´çš„æ¨ç§»ï¼Œè¿™äº›å¯¹è±¡çš„å±æ€§æ•°é‡ä¸æ–­å¢å¼ºï¼Œä»¥è‡³äºä½ å¯èƒ½éœ€è¦æ›´åŠ è°¨æ…åœ°é€‰æ‹©å®Œæˆç»™å®šä»»åŠ¡æ‰€éœ€çš„å±æ€§ã€‚ä½ ç”šè‡³å¯èƒ½æœ€ç»ˆæ„å»ºè¿™äº›å¯¹è±¡çš„ä¸“é—¨è¡¨ç¤ºæ¥è§£å†³ç‰¹å®šçš„ä»»åŠ¡ï¼Œè€Œä¸å¿…æ”¯ä»˜å¿…é¡»å¤„ç†éå¸¸â€œèƒ–â€çš„å¯¹è±¡å¼€é”€ã€‚è¿™ä¸ªè¿‡ç¨‹è¢«ç§°ä¸ºç‰¹å¾å·¥ç¨‹ï¼ˆFeature Engineeringï¼‰â€”â€”é€šè¿‡åªæŒ‘é€‰ä¸æ‰‹å¤´ä»»åŠ¡ç›¸å…³çš„åŸºæœ¬ç‰¹å¾æ¥ä¼˜åŒ–åº”ç”¨ç¨‹åºã€‚\n\nå½“ä½ å¤„ç†**éç»“æ„åŒ–**æ•°æ®æ—¶ï¼Œä½ å°†ä¸å¾—ä¸ç»å†ç›¸åŒçš„ç‰¹å¾å·¥ç¨‹è¿‡ç¨‹ã€‚ç„¶è€Œï¼Œéç»“æ„åŒ–æ•°æ®å¯èƒ½æœ‰æ›´å¤šç›¸å…³ç‰¹å¾ï¼Œè€Œæ‰§è¡Œæ‰‹åŠ¨ç‰¹å¾å·¥ç¨‹æ³¨å®šæ˜¯ä¸å¯è¡Œçš„ã€‚\n\nåœ¨è¿™äº›æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨**å‘é‡åµŒå…¥**ä½œä¸ºä¸€ç§å½¢å¼çš„è‡ªåŠ¨ç‰¹å¾å·¥ç¨‹ã€‚æˆ‘ä»¬ä¸å†ä»æ•°æ®ä¸­æ‰‹åŠ¨æŒ‘é€‰æ‰€éœ€çš„ç‰¹å¾ï¼Œè€Œæ˜¯åº”ç”¨ä¸€ä¸ªé¢„å…ˆè®­ç»ƒå¥½çš„æœºå™¨å­¦ä¹ æ¨¡å‹ï¼Œè¯¥æ¨¡å‹å°†ç”Ÿæˆä¸€ä¸ªæ›´ç´§å‡‘çš„æ•°æ®è¡¨ç¤ºï¼ŒåŒæ—¶ä¿ç•™æ•°æ®çš„æœ‰æ„ä¹‰ä¹‹å¤„ã€‚\n\n## ä»€ä¹ˆæ˜¯å‘é‡åµŒå…¥ï¼Ÿ\n\nåœ¨æˆ‘ä»¬æ·±å…¥ç ”ç©¶å‘é‡åµŒå…¥ä¹‹å‰ï¼Œè®©æˆ‘ä»¬å…ˆè®¨è®ºä¸€ä¸‹å‘é‡ã€‚å‘é‡æ˜¯ä¸€ç§å…·æœ‰å¤§å°å’Œæ–¹å‘çš„æ•°æ®ç»“æ„ã€‚ä¾‹å¦‚ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠå‘é‡çœ‹ä½œç©ºé—´ä¸­çš„ä¸€ä¸ªç‚¹ï¼Œâ€œæ–¹å‘â€æ˜¯ä» (0,0,0) åˆ°å‘é‡ç©ºé—´ä¸­è¯¥ç‚¹çš„ç®­å¤´ã€‚\n\n![å‘é‡](/img/2023-12-13-vector_embeddings_for_developers/pho1.png)\n\nä½œä¸ºå¼€å‘äººå‘˜ï¼Œå¯èƒ½æ›´å®¹æ˜“æŠŠå‘é‡æƒ³è±¡æˆä¸€ä¸ªåŒ…å«æ•°å€¼çš„æ•°ç»„ã€‚ä¾‹å¦‚ï¼š\n\n```py\nvector = [0,-2,...4]\n```\n\nä½†æˆ‘ä»¬åœ¨ä¸€ä¸ªç©ºé—´ä¸­è§‚å¯Ÿä¸€ç»„å‘é‡æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥è¯´æ˜¯æœ‰äº›å‘é‡å½¼æ­¤æ¥è¿‘ï¼Œè€Œæœ‰äº›åˆ™ç›¸è·ç”šè¿œã€‚ä¸€äº›å‘é‡ä¼¼ä¹å¯ä»¥èšé›†åœ¨ä¸€èµ·ï¼Œè€Œå…¶ä»–å‘é‡å¯ä»¥ç¨€ç–åœ°åˆ†å¸ƒåœ¨ç©ºé—´ä¸­ï¼š\n\n![å‘é‡åˆ†å¸ƒ](/img/2023-12-13-vector_embeddings_for_developers/pho2.png)\n\næˆ‘ä»¬å°†å¾ˆå¿«æ¢ç´¢å‘é‡ä¹‹é—´çš„è¿™äº›å…³ç³»æ˜¯å¦‚ä½•æœ‰ç”¨çš„ã€‚\n\nå‘é‡æ˜¯æœºå™¨å­¦ä¹ ç®—æ³•çš„ç†æƒ³æ•°æ®ç»“æ„â€”â€”ç°ä»£ CPU å’Œ GPU éƒ½è¿›è¡Œäº†ä¼˜åŒ–ï¼Œä»¥æ‰§è¡Œå¤„ç†å®ƒä»¬æ‰€éœ€çš„æ•°å­¦è¿ç®—ã€‚ä½†æ˜¯æˆ‘ä»¬çš„æ•°æ®å¾ˆå°‘ç”¨çŸ¢é‡è¡¨ç¤ºã€‚è¿™å°±æ˜¯å‘é‡åµŒå…¥å‘æŒ¥ä½œç”¨çš„åœ°æ–¹ã€‚è¿™ç§æŠ€æœ¯å…è®¸æˆ‘ä»¬è·å–å‡ ä¹ä»»ä½•æ•°æ®ç±»å‹ï¼Œå¹¶å°†å…¶è¡¨ç¤ºä¸ºå‘é‡ã€‚\n\nä½†æ˜¯è¿™ä¸ä»…ä»…æ˜¯æŠŠæ•°æ®è½¬æ¢ä¸ºå‘é‡é‚£ä¹ˆç®€å•ã€‚æˆ‘ä»¬å¸Œæœ›ç¡®ä¿èƒ½å¤Ÿåœ¨è½¬æ¢åçš„æ•°æ®ä¸Šæ‰§è¡Œä»»åŠ¡ï¼Œè€Œä¸ä¼šä¸¢å¤±æ•°æ®çš„åŸå§‹å«ä¹‰ã€‚ä¾‹å¦‚ï¼Œå¦‚æœæˆ‘ä»¬è¦æ¯”è¾ƒä¸¤ä¸ªå¥å­â€”â€”æˆ‘ä»¬ä¸ä»…è¦æ¯”è¾ƒå®ƒä»¬æ‰€åŒ…å«çš„å•è¯ï¼Œè€Œä¸”è¦æ¯”è¾ƒå®ƒä»¬æ˜¯å¦æ„å‘³ç€åŒä¸€ä»¶äº‹ã€‚ä¸ºäº†ä¿æŒæ•°æ®çš„å«ä¹‰ï¼Œæˆ‘ä»¬éœ€è¦äº†è§£å¦‚ä½•åœ¨å‘é‡ä¹‹é—´çš„å…³ç³»æœ‰æ„ä¹‰çš„åœ°æ–¹ç”Ÿæˆå‘é‡ã€‚\n\nè¦åšåˆ°è¿™ä¸€ç‚¹ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªæ‰€è°“çš„**åµŒå…¥æ¨¡å‹**ã€‚è®¸å¤šç°ä»£åµŒå…¥æ¨¡å‹éƒ½æ˜¯é€šè¿‡å°†å¤§é‡çš„æ ‡è®°æ•°æ®ä¼ é€’ç»™ç¥ç»ç½‘ç»œæ¥å»ºç«‹çš„ã€‚ä½ å¯èƒ½ä»¥å‰å¬è¯´è¿‡ç¥ç»ç½‘ç»œâ€”â€”å®ƒä»¬æ˜¯ç”¨æ¥è§£å†³å„ç§å¤æ‚é—®é¢˜çš„æµè¡Œç®—æ³•ã€‚ç”¨éå¸¸ç®€å•çš„æœ¯è¯­æ¥è¯´ï¼Œç¥ç»ç½‘ç»œæ˜¯ç”±å‡½æ•°è¿æ¥çš„èŠ‚ç‚¹å±‚ç»„æˆçš„ï¼›ç„¶åæˆ‘ä»¬è®­ç»ƒè¿™äº›ç¥ç»ç½‘ç»œæ¥æ‰§è¡Œå„ç§ä»»åŠ¡ã€‚\n\næˆ‘ä»¬é€šè¿‡ç›‘ç£å¼å­¦ä¹ è®­ç»ƒç¥ç»ç½‘ç»œâ€”â€”å‘ç¥ç»ç½‘ç»œæä¾›ç”±æˆå¯¹è¾“å…¥å’Œæ ‡è®°è¾“å‡ºç»„æˆçš„å¤§é‡è®­ç»ƒæ•°æ®ã€‚æˆ–è€…ï¼Œæˆ‘ä»¬å¯ä»¥åº”ç”¨è‡ªæˆ‘ç›‘ç£æˆ–éç›‘ç£å¼å­¦ä¹ ï¼Œå…¶ä¸­ä»»ä½•ä¸€ä¸ªéƒ½ä¸éœ€è¦æ ‡è®°è¾“å‡ºã€‚è¿™äº›å€¼é€šè¿‡ç½‘ç»œæ¿€æ´»å’Œæ“ä½œçš„æ¯ä¸€å±‚è¿›è¡Œè½¬æ¢ã€‚é€šè¿‡æ¯æ¬¡è¿­ä»£è®­ç»ƒï¼Œç¥ç»ç½‘ç»œä¿®æ”¹æ¯ä¸€å±‚çš„æ¿€æ´»ã€‚æœ€ç»ˆï¼Œå®ƒå¯ä»¥é¢„æµ‹ç»™å®šè¾“å…¥çš„è¾“å‡ºæ ‡ç­¾åº”è¯¥æ˜¯ä»€ä¹ˆâ€”â€”å³ä½¿å®ƒä»¥å‰ä»æ¥æœªè§è¿‡è¿™ç§ç‰¹å®šè¾“å…¥ã€‚\n\nåµŒå…¥æ¨¡å‹åŸºæœ¬ä¸Šæ˜¯å»æ‰æœ€åä¸€å±‚çš„ç¥ç»ç½‘ç»œã€‚æˆ‘ä»¬å¾—åˆ°çš„ä¸æ˜¯è¾“å…¥çš„ç‰¹å®šæ ‡è®°å€¼ï¼Œè€Œæ˜¯å‘é‡åµŒå…¥ã€‚\n\nåµŒå…¥æ¨¡å‹çš„ä¸€ä¸ªå¾ˆå¥½çš„ä¾‹å­æ˜¯æµè¡Œçš„ <a href=\"https://en.wikipedia.org/wiki/Word2vec\">word2vec</a>ï¼Œå®ƒç»å¸¸ç”¨äºå„ç§åŸºäºæ–‡æœ¬çš„ä»»åŠ¡ã€‚è®©æˆ‘ä»¬çœ‹çœ‹<a href=\"https://projector.tensorflow.org/\"> TensorFlow çš„æŠ•å½±ä»ªå·¥å…·</a>äº§ç”Ÿçš„å¯è§†åŒ–ï¼Œå®ƒä½¿åµŒå…¥æ›´å®¹æ˜“å¯è§†åŒ–ã€‚\n\n![TensorFlow's projector tool](/img/2023-12-13-vector_embeddings_for_developers/pho3.png)\n\nå°½ç®¡è¿™ç§å¯è§†åŒ–åªè¡¨ç¤ºåµŒå…¥çš„ä¸‰ä¸ªç»´åº¦ï¼Œä½†å®ƒå¯ä»¥å¸®åŠ©æˆ‘ä»¬ç†è§£åµŒå…¥æ¨¡å‹æ˜¯å¦‚ä½•å·¥ä½œçš„ã€‚å¯è§†åŒ–ä¸­çªå‡ºæ˜¾ç¤ºäº†å¤šä¸ªæ•°æ®ç‚¹ï¼Œæ¯ä¸ªæ•°æ®ç‚¹è¡¨ç¤ºä¸€ä¸ªå•è¯çš„å‘é‡åµŒå…¥ã€‚é¡¾åæ€ä¹‰ï¼Œword2vec åµŒå…¥äº†å•è¯ã€‚ç›¸é‚»çš„è¯è¯­åœ¨è¯­ä¹‰ä¸Šæ˜¯ç›¸ä¼¼çš„ï¼Œè€Œç›¸è·è¾ƒè¿œçš„è¯è¯­åœ¨è¯ä¹‰ä¸Šæ˜¯ä¸åŒçš„ã€‚\n\nç»è¿‡è®­ç»ƒï¼ŒåµŒå…¥æ¨¡å‹å¯ä»¥å°†åŸå§‹æ•°æ®è½¬æ¢ä¸ºå‘é‡åµŒå…¥ã€‚è¿™æ„å‘³ç€å®ƒçŸ¥é“åœ¨å‘é‡ç©ºé—´ä¸­æ”¾ç½®æ–°çš„æ•°æ®ç‚¹ã€‚\n\n![word2vec æµç¨‹](/img/2023-12-13-vector_embeddings_for_developers/pho4.png)\n\næ­£å¦‚æˆ‘ä»¬åœ¨ word2vec ä¸­çœ‹åˆ°çš„ï¼Œåœ¨æ¨¡å‹çš„ä¸Šä¸‹æ–‡ä¸­ï¼Œç´§å¯†ç›¸è¿çš„å‘é‡å…·æœ‰ä¸Šä¸‹æ–‡ç›¸ä¼¼æ€§ï¼Œè€Œç›¸è·è¾ƒè¿œçš„å‘é‡å½¼æ­¤ä¸åŒã€‚è¿™å°±æ˜¯èµ‹äºˆå‘é‡æ„ä¹‰çš„ä¸œè¥¿â€”â€”å®ƒä¸å‘é‡ç©ºé—´ä¸­å…¶ä»–å‘é‡çš„å…³ç³»å–å†³äºåµŒå…¥æ¨¡å‹å¦‚ä½•â€œç†è§£â€å®ƒæ‰€è®­ç»ƒçš„é¢†åŸŸã€‚\n\n## æˆ‘èƒ½ç”¨å‘é‡åµŒå…¥åšä»€ä¹ˆï¼Ÿ\n\nå‘é‡åµŒå…¥æ˜¯ä¸€ä¸ªéå¸¸é€šç”¨çš„å·¥å…·ï¼Œå¯ä»¥åº”ç”¨äºè®¸å¤šé¢†åŸŸã€‚ä¸€èˆ¬æ¥è¯´ï¼Œåº”ç”¨ç¨‹åºä¼šä½¿ç”¨ä¸€ä¸ªå‘é‡åµŒå…¥ä½œä¸ºå®ƒçš„æŸ¥è¯¢ï¼Œå¹¶äº§ç”Ÿå…¶ä»–ç±»ä¼¼çš„å‘é‡åµŒå…¥ï¼Œå…¶ç›¸åº”çš„å€¼ã€‚æ¯ä¸ªé¢†åŸŸçš„åº”ç”¨ç¨‹åºä¹‹é—´çš„å·®å¼‚å°±æ˜¯è¿™ç§ç›¸ä¼¼æ€§çš„é‡è¦æ€§ã€‚\n\nä¸‹é¢æ˜¯ä¸€äº›ä¾‹å­ï¼š\n\n- è¯­ä¹‰æœç´¢ï¼šä¼ ç»Ÿçš„æœç´¢å¼•æ“é€šè¿‡æœç´¢å…³é”®å­—çš„é‡å æ¥å·¥ä½œã€‚é€šè¿‡åˆ©ç”¨å‘é‡åµŒå…¥ï¼Œè¯­ä¹‰æœç´¢å¯ä»¥è¶…è¶Šå…³é”®è¯åŒ¹é…ï¼ŒåŸºäºæŸ¥è¯¢çš„è¯­ä¹‰è¿›è¡ŒæŸ¥è¯¢ã€‚\n- é—®ç­”åº”ç”¨ç¨‹åºï¼šé€šè¿‡è®­ç»ƒä¸€ä¸ªåµŒå…¥å¼æ¨¡å‹ï¼Œå…¶ä¸­åŒ…å«æˆå¯¹çš„é—®é¢˜å’Œç›¸åº”çš„ç­”æ¡ˆï¼Œæˆ‘ä»¬å¯ä»¥åˆ›å»ºä¸€ä¸ªåº”ç”¨ç¨‹åºæ¥å›ç­”ä»¥å‰ä»æœªè§è¿‡çš„é—®é¢˜ã€‚\n- å›¾åƒæœç´¢ï¼šå‘é‡åµŒå…¥éå¸¸é€‚åˆä½œä¸ºå›¾åƒæ£€ç´¢ä»»åŠ¡çš„åŸºç¡€ã€‚æœ‰å¤šç§ç°æˆçš„æ¨¡å‹ï¼Œå¦‚ CLIPã€ ResNet ç­‰ã€‚ä¸åŒçš„æ¨¡å‹å¯ä»¥å¤„ç†ä¸åŒç±»å‹çš„ä»»åŠ¡ï¼Œæ¯”å¦‚å›¾åƒç›¸ä¼¼æ€§ã€ç›®æ ‡æ£€æµ‹ç­‰ç­‰ã€‚\n- éŸ³é¢‘æœç´¢ï¼šé€šè¿‡å°†éŸ³é¢‘è½¬æ¢æˆä¸€ç»„æ¿€æ´»(éŸ³é¢‘å…‰è°±å›¾) ï¼Œæˆ‘ä»¬ç”Ÿæˆå¯ç”¨äºéŸ³é¢‘æœ€è¿‘é‚»æœç´¢çš„å‘é‡åµŒå…¥ã€‚\n- æ¨èç³»ç»Ÿï¼šæˆ‘ä»¬å¯ä»¥åˆ›å»ºåµŒå…¥çš„ç»“æ„åŒ–æ•°æ®ï¼Œå…³è”åˆ°ä¸åŒçš„å®ä½“ï¼Œå¦‚äº§å“ï¼Œæ–‡ç« ï¼Œç­‰ã€‚åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œä½ å¿…é¡»åˆ›å»ºè‡ªå·±çš„åµŒå…¥æ¨¡å‹ï¼Œå› ä¸ºå®ƒæ˜¯ç‰¹å®šäºä½ çš„ç‰¹å®šåº”ç”¨ç¨‹åºçš„ã€‚æœ‰æ—¶ï¼Œå½“æ‰¾åˆ°å›¾åƒæˆ–æ–‡æœ¬æè¿°æ—¶ï¼Œè¿™å¯ä»¥ä¸éç»“æ„åŒ–åµŒå…¥æ–¹æ³•ç»“åˆä½¿ç”¨ã€‚\n- å¼‚å¸¸æ£€æµ‹ï¼šæˆ‘ä»¬å¯ä»¥åˆ›å»ºåµŒå…¥å¼‚å¸¸æ£€æµ‹ä½¿ç”¨æ ‡è®°ä¼ æ„Ÿå™¨ä¿¡æ¯çš„å¤§æ•°æ®é›†ï¼Œè¯†åˆ«å¼‚å¸¸äº‹ä»¶ã€‚","tags":["å‘é‡æ•°æ®åº“"]},{"title":"åƒå…‰ä¸€æ ·æœç´¢â€”â€”HNSWç®—æ³•ä»‹ç»","url":"/2023/11/20/2023-11-20-hnsw/","content":"\n> æœ¬æ–‡æ˜¯ä¸€ç¯‡è‹±æ–‡ç¿»è¯‘è½¬è½½æ–‡ç« ï¼Œä¸»è¦ä»‹ç»äº†HNSWç®—æ³•ã€‚<br>\nåŸè‹±æ–‡é“¾æ¥ï¼šhttps://dataman-ai.medium.com/search-like-light-speed-1-hnsw-c5b0d4665926<br>\nå‚è€ƒä¸­æ–‡è½¬è½½é“¾æ¥ï¼šhttps://luxiangdong.com/2023/11/06/hnsw/\n\næˆ‘å–œæ¬¢ã€Šç©å…·æ€»åŠ¨å‘˜ã€‹ä¸­çš„å¤ªç©ºå·¡é€»å‘˜â€œå·´æ–¯å…‰å¹´â€ï¼Œæˆ‘ä¹Ÿå–œæ¬¢ä»–çš„å£å·â€œé£å‘æ— é™ï¼Œé£å‘æ›´è¿œ!â€å½“æˆ‘æœç´¢ä¿¡æ¯æ—¶ï¼Œæˆ‘ä¹Ÿå–œæ¬¢å¿«é€Ÿæ‰¾åˆ°æ­£ç¡®çš„ä¿¡æ¯ã€‚è¿™ä¸€åˆ‡éƒ½æ˜¯å…³äºé«˜é€Ÿäº’è”ç½‘å’Œè¶³å¤Ÿçš„å¸¦å®½å—ï¼Ÿä¸å®Œå…¨æ˜¯ï¼**äº‹å®ä¸Šï¼Œè¿‘ä¹å³æ—¶æœç´¢ç»“æœçš„ç®—æ³•æ˜¯è‡³å…³é‡è¦çš„ã€‚**ä¿¡æ¯æ£€ç´¢çš„é€Ÿåº¦æ˜¯è®¡ç®—æœºç§‘å­¦ä¸­çš„ä¸€ä¸ªé‡è¦è¯¾é¢˜ã€‚éšç€æ–‡æœ¬ã€å›¾åƒæˆ–éŸ³é¢‘æ•°æ®çš„é«˜ç»´åµŒå…¥å¼å¤§è¯­è¨€æ¨¡å‹ï¼ˆLLMï¼‰ï¼Œä¿¡æ¯æ£€ç´¢çš„é€Ÿåº¦æˆä¸ºæ•°æ®ç§‘å­¦çš„ä¼˜å…ˆè¯é¢˜ã€‚\n\nåœ¨è¿™ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘å°†è°ˆè®º: \n- NLPä¸­çš„å‘é‡åµŒå…¥ï¼ˆEmbeddingsï¼‰\n- KNNï¼ˆK-Nearest Neighborsï¼‰æ— æ³•è·Ÿä¸Šé€Ÿåº¦\n- è¿‘ä¼¼æœ€è¿‘é‚»ï¼ˆANNï¼‰æ„Ÿè§‰å°±åƒå…‰é€Ÿ\n- å¿«é€Ÿæœç´¢çš„åˆå§‹ç®—æ³•\n- ç†è§£åˆ†å±‚å¯¼èˆªå°ä¸–ç•Œå›¾ç®—æ³•ï¼ˆHNSWï¼‰\n- ä»£ç ç¤ºä¾‹ï¼šEmbedding æ–°é—»æ–‡ç« \n- ä»£ç ç¤ºä¾‹ï¼šFAISS ç”¨äº HNSW æœç´¢\n\n## NLP ä¸­çš„å‘é‡åµŒå…¥\n\nå‘é‡åµŒå…¥æ˜¯è‡ªç„¶è¯­è¨€å¤„ç†ä¸­çš„ä¸€ä¸ªåŸºæœ¬æ¦‚å¿µï¼Œæ˜¯å¯¹è¯ã€å¥å­ã€æ–‡æ¡£ã€å›¾åƒã€éŸ³é¢‘æˆ–è§†é¢‘æ•°æ®ç­‰å¯¹è±¡çš„æ•°å­—è¡¨ç¤ºã€‚è¿™äº›å‘é‡åµŒå…¥è¢«è®¾è®¡ç”¨æ¥æ•è·å®ƒä»¬æ‰€è¡¨ç¤ºçš„å¯¹è±¡çš„è¯­ä¹‰å’Œä¸Šä¸‹æ–‡ä¿¡æ¯ã€‚\n\nè®©æˆ‘ä»¬é¦–å…ˆæè¿°è¯åµŒå…¥ã€‚2014å¹´ï¼Œä¸€ä¸ªçªç ´æ€§çš„åˆ›æ„ Word2Vec å‡ºç°åœ¨ NLP ä¸­ï¼Œå®ƒå°†å•è¯æˆ–çŸ­è¯­è½¬æ¢æˆ–â€œåµŒå…¥â€ä¸ºæ•°å€¼å‹çš„é«˜ç»´å‘é‡ï¼Œç§°ä¸ºè¯åµŒå…¥ã€‚è¿™äº›è¯åµŒå…¥æ•è·å•è¯ä¹‹é—´çš„è¯­ä¹‰å’Œä¸Šä¸‹æ–‡å…³ç³»ï¼Œä½¿æœºå™¨èƒ½å¤Ÿç†è§£å¹¶ä½¿ç”¨äººç±»è¯­è¨€ã€‚ä¾‹å¦‚å›¾ 1 æ˜¾ç¤ºäº†ä¸‰ç»´ç©ºé—´ä¸­çš„é«˜ç»´å‘é‡ï¼šâ€œé“ï¼ˆironï¼‰â€è¿™ä¸ªè¯ä¸â€œç«è¯ï¼ˆgunpowderï¼‰â€ã€â€œé‡‘å±ï¼ˆmetalsï¼‰â€å’Œâ€œé’¢é“ï¼ˆsteelï¼‰â€è¿™æ ·çš„è¯å¾ˆæ¥è¿‘ï¼Œä½†ä¸â€œæœ‰æœºï¼ˆorganicï¼‰â€ã€â€œç³–ï¼ˆsuugarï¼‰â€æˆ–â€œè°·ç‰©ï¼ˆgrainï¼‰â€ç­‰ä¸ç›¸å…³çš„è¯ç›¸å»ç”šè¿œã€‚\n\n![å›¾ 1 æ–‡å­—åµŒå…¥](/img/2023-11-20-hnsw/pho1.png)\n\nè¯åµŒå…¥å¯ä»¥è¡¨ç¤ºå•è¯ä¹‹é—´çš„ç›¸ä¼¼æˆ–ä¸ç›¸ä¼¼ã€‚è¿™æ˜¯ä¸€é¡¹äº†ä¸èµ·çš„åˆ›æ–°ã€‚æ—¢ç„¶å•è¯å¯ä»¥åµŒå…¥ï¼Œä¸ºä»€ä¹ˆå¥å­ä¸èƒ½å‘¢ï¼Ÿè¿™å°±æ˜¯å¥å­åµŒå…¥çš„è¯ç”Ÿã€‚å¥å­åµŒå…¥æ•æ‰æ•´ä¸ªå¥å­çš„è¯­ä¹‰å’Œä¸Šä¸‹æ–‡ï¼Œä½¿æœºå™¨èƒ½å¤Ÿç†è§£å’Œæ¯”è¾ƒå¥å­ã€‚ç”Ÿæˆå¥å­åµŒå…¥çš„å¸¸è§æ–¹æ³•æ˜¯ Doc2Vecã€‚å¼ºå¤§çš„åŸºäºå¤§è¯­è¨€æ¨¡å‹ï¼ˆLLMï¼‰çš„è¯åµŒå…¥æˆä¸º NLP çš„æ ‡å‡†ï¼Œå¦‚BERTï¼ˆåŸºäº Transformer çš„åŒå‘ç¼–ç å™¨è¡¨ç¤ºï¼‰ã€ELMoï¼ˆæ¥è‡ªè¯­è¨€æ¨¡å‹çš„åµŒå…¥ï¼‰ã€Llamaï¼ˆå¤§å‹è¯­è¨€æ¨¡å‹å…ƒAIï¼‰ï¼Œä»¥åŠOpenAIçš„å¤šä¸ªæ¨¡å‹ã€‚\n\næ—¢ç„¶æ–‡æœ¬å¯ä»¥ä½œä¸ºå‘é‡åµŒå…¥ï¼Œä¸ºä»€ä¹ˆä¸èƒ½åµŒå…¥å›¾åƒå‘¢ï¼Ÿè¿™å°±äº§ç”Ÿäº†å›¾åƒåµŒå…¥ã€‚å·ç§¯ç¥ç»ç½‘ç»œï¼ˆCNNsï¼‰å’Œè§†è§‰å‡ ä½•ç»„ï¼ˆVGGï¼‰å¸¸è¢«ç”¨äºç”Ÿæˆå›¾åƒåµŒå…¥ã€‚å›¾åƒåµŒå…¥ä½¿å›¾åƒæ£€ç´¢å’Œåˆ†ç±»æˆä¸ºå¯èƒ½ã€‚\n\næ—¢ç„¶å›¾åƒå¯ä»¥ä½œä¸ºè½½ä½“åµŒå…¥ï¼Œä¸ºä»€ä¹ˆæˆ‘ä»¬ä¸èƒ½åµŒå…¥éŸ³é¢‘å‘¢ï¼Ÿä½ æ˜¯å¯¹çš„ï¼éŸ³é¢‘åµŒå…¥å¯ä»¥æ•æ‰éŸ³é¢‘æ•°æ®çš„å£°å­¦ç‰¹å¾ï¼Œå¹¶å¯ä»¥è¿›è¡ŒéŸ³é¢‘åˆ†ç±»å’Œæ£€ç´¢ã€‚é‚£ä¹ˆè§†é¢‘åµŒå…¥å‘¢ï¼Ÿå®ƒä»¬æ•æ‰è§†é¢‘åˆ†ç±»æ‰€éœ€çš„å›¾åƒç‰¹å¾æµã€‚åœ°ç†ç©ºé—´åµŒå…¥å¦‚ä½•ï¼Ÿå½“ç„¶ã€‚åƒç»çº¬åº¦åæ ‡è¿™æ ·çš„åœ°ç†ç©ºé—´æ•°æ®å¯ä»¥åµŒå…¥åˆ°é«˜ç»´å‘é‡ä¸­è¿›è¡Œä¿¡æ¯æ£€ç´¢ã€‚\n\nåµŒå…¥æ˜¯çš„ä¸€åˆ‡å˜å¾—ç®€å•ã€‚å¦‚æœä½ æœ‰ä¸€ç¯‡æ–‡ç« ï¼Œéœ€è¦æ‰¾åˆ°ç±»ä¼¼çš„æ–‡ç« ï¼Œä½ åªéœ€è¦è®¡ç®—ä½ çš„æ–‡ç« å‘é‡å’Œå…¶ä»–æ–‡ç« å‘é‡ä¹‹é—´çš„â€œè·ç¦»â€ã€‚â€œè·ç¦»â€æœ€è¿‘çš„å‘é‡å°±æ˜¯ä½ çš„æœç´¢ç»“æœã€‚æˆ‘ä»¬å¯ä»¥ç”¨ K-æœ€è¿‘é‚»æ³•ï¼ˆKNNï¼‰å¯¹å§ï¼Ÿç„¶è€Œï¼Œé€Ÿåº¦æ˜¯ä¸ªé—®é¢˜ã€‚KNN çš„æœç´¢å°†ä½¿å…‰å¹´çš±çœ‰ï¼Œå¯¹äºå·´æ–¯å…‰å¹´æ¥è¯´ï¼Œå®Œæˆä¸€æ¬¡ç®€å•çš„æœç´¢éœ€è¦â€¦â€¦éœ€è¦ä¸çŸ¥é“å¤šå°‘å¹´ã€‚ç ”ç©¶çš„æŒ‘æˆ˜ä¸æ˜¯æœ€è¿‘çš„é‚»å±…åœ¨â€œå“ªé‡Œâ€ï¼Œè€Œæ˜¯â€œå¦‚ä½•â€æ‰¾åˆ°ä»–ä»¬ã€‚\n\n## K-æœ€è¿‘é‚»ï¼ˆKNNsï¼‰æ— æ³•è·Ÿä¸Šé€Ÿåº¦\n\nå‡å¦‚ä½ æœ‰ä¸€æœ¬æ–°ä¹¦ï¼Œä½ æƒ³åœ¨å›¾ä¹¦é¦†å†…æ‰¾åˆ°ç±»ä¼¼çš„ä¹¦ã€‚k-æœ€è¿‘é‚»ï¼ˆKNNï¼‰å°†æµè§ˆä¹¦æ¶ä¸Šçš„æ¯ä¸€æœ¬ä¹¦ï¼Œå¹¶å°†å®ƒä»¬ä»æœ€ç›¸ä¼¼åˆ°æœ€ä¸ç›¸ä¼¼çš„é¡ºåºæ’åºï¼Œä»¥ç¡®å®šæœ€ç›¸ä¼¼çš„ä¹¦ã€‚ä½ æœ‰è¶³å¤Ÿçš„è€å¿ƒå»å®Œæˆè¿™æ ·ä¸€é¡¹ç¹ççš„å·¥ä½œå—ï¼Ÿç›¸åï¼Œäººå·¥ç¥ç»ç½‘ç»œä¼šå…ˆå¯¹å›¾ä¹¦é¦†ä¸­çš„ä¹¦ç±è¿›è¡Œé¢„åˆ†ç±»å’Œç´¢å¼•ã€‚è¦æ‰¾åˆ°ä¸ä½ çš„æ–°ä¹¦ç›¸ä¼¼çš„ä¹¦ï¼Œä½ æ‰€éœ€è¦åšçš„å°±æ˜¯å»æ­£ç¡®çš„æ¥¼å±‚ï¼Œæ­£ç¡®çš„åŒºåŸŸï¼Œæ­£ç¡®çš„é€šé“æ‰¾åˆ°ç›¸ä¼¼çš„ä¹¦ã€‚æ­¤å¤–ï¼Œ**ä½ é€šå¸¸ä¸éœ€è¦å¯¹æ’åå‰ 10 ä½çš„ç±»ä¼¼ä¹¦ç±è¿›è¡Œç²¾ç¡®æ’åºï¼Œæ¯”å¦‚ 100%ã€99% æˆ– 95%çš„åŒ¹é…åº¦**ã€‚è¿™å°±æ˜¯è¿‘ä¼¼é‚»ï¼ˆANNï¼‰çš„æ€æƒ³ã€‚\n\n![-](/img/2023-11-20-hnsw/pho2.png)\n\nè®©æˆ‘ä»¬æ¥äº†è§£ä¸€ä¸‹ä¸ºä»€ä¹ˆäººå·¥ç¥ç»ç½‘ç»œå¯ä»¥æ›´æœ‰æ•ˆåœ°æœç´¢ã€‚\n\n## è¿‘ä¼¼æœ€è¿‘é‚»ï¼ˆANNï¼‰æ„Ÿè§‰åƒå…‰é€Ÿ\n\nANNï¼ˆApproximate Nearest Neighborsï¼‰å¯¹å¤§æ•°æ®è¿›è¡Œé¢„ç´¢å¼•ï¼Œä»¥æ–¹ä¾¿å¿«é€Ÿæœç´¢ã€‚åœ¨ç´¢å¼•æœŸé—´ï¼Œæ„å»ºæ•°æ®ç»“æ„ä»¥ä¿ƒè¿›æ›´å¿«çš„æŸ¥è¯¢ã€‚å½“ä½ æƒ³æ‰¾åˆ°ä¸€ä¸ªæŸ¥è¯¢ç‚¹çš„è¿‘ä¼¼æœ€è¿‘é‚»å±…æ—¶ï¼Œä½ å¯ä»¥å°†è¯¥ç‚¹æä¾›ç»™ ANN ç®—æ³•ã€‚ANN ç®—æ³•é¦–å…ˆä»æ•°æ®é›†ä¸­è¯†åˆ«ä¸€ç»„å¯èƒ½æ¥è¿‘æŸ¥è¯¢ç‚¹çš„å€™é€‰ç‚¹ï¼Œç„¶åä½¿ç”¨é¢„æ„å»ºçš„æ•°æ®æ¥ç»“æ„é€‰æ‹©å€™é€‰ç‚¹ã€‚è¿™ä¸€æ­¥éª¤å¤§å¤§å‡å°‘äº†éœ€è¦æ£€ç´¢æ¥è¿‘æ€§çš„æ•°æ®ç‚¹çš„æ•°é‡ã€‚åœ¨å€™é€‰ç‚¹è¢«é€‰ä¸­ä¹‹å‰ï¼ŒANN ä¼šè®¡ç®—æ¯ä¸ªå€™é€‰ç‚¹ä¸æŸ¥è¯¢ç‚¹ä¹‹é—´çš„å®é™…è·ç¦»ï¼ˆå¦‚æ¬§å‡ é‡Œå¾—è·ç¦»ã€ä½™å¼¦ç›¸ä¼¼åº¦ï¼‰ã€‚ç„¶åæ ¹æ®ä¸æŸ¥è¯¢ç‚¹çš„è·ç¦»/ç›¸ä¼¼åº¦å¯¹å€™é€‰ç‚¹é›†æ’åºã€‚æ’åé å‰çš„å€™é€‰ç‚¹ä½œä¸ºè¿‘ä¼¼æœ€è¿‘é‚»è¿”å›ã€‚åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œä½ è¿˜å¯ä»¥è®¾ç½®ä¸€ä¸ªè·ç¦»é˜ˆå€¼ï¼Œåªè¿”å›è¯¥é˜ˆå€¼å†…çš„å€™é€‰ç‚¹ã€‚äººå·¥ç¥ç»ç½‘ç»œèƒŒåçš„å…³é”®æ€æƒ³æ˜¯ï¼Œ**ä¸ºäº†æ˜¾è‘—é™ä½è®¡ç®—æˆæœ¬ï¼Œå®ƒç‰ºç‰²äº†æ‰¾åˆ°ç»å¯¹æœ€è¿‘é‚»çš„ä¿è¯ã€‚è¿™äº›ç®—æ³•çš„ç›®æ ‡æ˜¯åœ¨è®¡ç®—æ•ˆç‡å’Œå‡†ç¡®æ€§ç›´æ¥å–å¾—å¹³è¡¡ã€‚**\n\nç„¶è€Œï¼Œåœ¨é«˜ç»´ç©ºé—´ä¸­ï¼Œè¿‡å»çš„å®éªŒè¡¨æ˜ ANN å¹¶ä¸æ¯” KNN èŠ‚çœå¤šå°‘æ—¶é—´ï¼ˆè§[4]ï¼‰ã€‚æœ‰å‡ ç§åˆ›æ–°çš„äººå·¥ç¥ç»ç½‘ç»œç®—æ³•é€‚ç”¨äºé«˜ç»´ç©ºé—´ï¼š\n\n### æœ€å…ˆè¿›çš„å¿«é€Ÿæœç´¢ç®—æ³•\n\nè¿™äº›ä¸åŒçš„äººå·¥ç¥ç»ç½‘ç»œç®—æ³•æ˜¯ç”¨ä¸åŒçš„æ–¹æ³•ï¼Œå½¢æˆä¾¿äºæœ‰æ•ˆæ£€ç´¢çš„**æ•°æ®ç»“æ„**ã€‚æœ‰ä¸‰ç§ç±»å‹çš„ç®—æ³•ï¼šåŸºäºå›¾çš„ã€åŸºäºå“ˆå¸Œçš„å’ŒåŸºäºæ ‘çš„ï¼š\n\n**åŸºäºå›¾çš„ç®—æ³•åˆ›å»ºæ•°æ®çš„å›¾å½¢è¡¨ç¤º**ï¼šå…¶ä¸­æ¯ä¸ªæ•°æ®ç‚¹æ˜¯ä¸€ä¸ªèŠ‚ç‚¹ï¼Œè¾¹è¡¨ç¤ºæ•°æ®ç‚¹ä¹‹é—´çš„æ¥è¿‘æ€§æˆ–ç›¸ä¼¼æ€§ã€‚æœ€å¼•äººæ³¨ç›®çš„æ˜¯å±‚æ¬¡å¯¼èˆªå°ä¸–ç•Œå›¾ï¼ˆHNSWï¼‰\n\n**åŸºäºå“ˆå¸Œçš„ç®—æ³•**ï¼šä½¿ç”¨å“ˆå¸Œå‡½æ•°å°†æ•°æ®ç‚¹æ˜ å°„åˆ°å“ˆå¸Œå€¼æˆ–æ¡¶ã€‚æµè¡Œçš„ç®—æ³•åŒ…æ‹¬ï¼šä½ç½®æ•æ„Ÿå“ˆå¸Œï¼ˆLSHï¼‰ã€å¤šç´¢å¼•å“ˆå¸Œï¼ˆMIHï¼‰å’Œä¹˜ç§¯é‡åŒ–\n\n**åŸºäºæ ‘çš„ç®—æ³•**ï¼šå°†æ•°æ®é›†åˆ’åˆ†ä¸ºæ ‘çŠ¶ç»“æ„ï¼Œä»¥ä¾¿å¿«é€Ÿæœç´¢ã€‚æµè¡Œçš„æ˜¯ kdæ ‘ã€ç¯æ ‘å’ŒéšæœºæŠ•å½±æ ‘ï¼ˆRPæ ‘ï¼‰ã€‚å¯¹äºä½çº¬ç©ºé—´ï¼ˆâ‰¤10ï¼‰ï¼ŒåŸºäºæ ‘çš„ç®—æ³•æ˜¯éå¸¸æœ‰æ•ˆçš„\n\næœ‰å‡ ä¸ªæµè¡Œçš„ä»£ç åº“ï¼š\n\n- <a href=\"https://github.com/scikit-learn/scikit-learn\">Scikit-learn</a>ï¼šå®ƒçš„ NearestNeighbors ç±»æä¾›äº†ä¸€ä¸ªç®€å•çš„æ¥å£ï¼Œå¯ä»¥ä½¿ç”¨ LSH ç­‰æŠ€æœ¯è¿›è¡Œç²¾ç¡®å’Œè¿‘ä¼¼çš„æœ€è¿‘é‚»æœç´¢ã€‚\n- <a href=\"https://github.com/nmslib/hnswlib\">Hnwlib</a>ï¼šå®ƒæ˜¯HNSWçš„PythonåŒ…è£…å™¨ã€‚\n- <a href=\"https://github.com/facebookresearch/faiss\">faiss</a>ï¼šè¯¥åº“æ”¯æŒå¤šç§ ANN ç®—æ³•ï¼ŒåŒ…æ‹¬ HNSW, IVFADCï¼ˆå¸¦ADCé‡åŒ–çš„å€’ç½®æ–‡ä»¶ï¼‰å’ŒIVFPQï¼ˆå¸¦äº§å“é‡åŒ–çš„å€’ç½®æ–‡ä»¶ï¼‰ã€‚\n- <a href=\"https://github.com/spotify/annoy\">Annoyï¼ˆApproximate Nearest Neighbors Oh Yeahï¼‰</a>ï¼šAnnoyæ˜¯ä¸€ä¸ª c++ åº“ï¼Œä¹Ÿæä¾›äº† Python æ¥å£ã€‚\n- <a href=\"https://github.com/nmslib/nmslib\">NMSLIBï¼ˆéåº¦é‡ç©ºé—´åº“ï¼‰</a>ï¼šå®ƒæ˜¯ç”¨ c++ ç¼–å†™çš„ï¼Œå¹¶å…·æœ‰ Python åŒ…è£…å™¨ã€‚å®ƒå¯ä»¥æ‰§è¡Œ HNSWã€LSHã€MIH æˆ–éšæœºæŠ•å½±æ ‘ç­‰ç®—æ³•ã€‚\n\nä½¿ç”¨ä¸Šè¿°ä»£ç åº“ï¼Œä½ å¯ä»¥è¶…çº§å¿«é€Ÿåœ°æ‰§è¡Œæœç´¢æŸ¥è¯¢ã€‚è¿˜æœ‰ä¸€äº›åº“çš„å˜ä½“ä½ éœ€è¦æ³¨æ„ã€‚è¿™é‡Œæˆ‘åªæåˆ°å…¶ä¸­çš„ä¸‰ä¸ªï¼š\n\nç¬¬ä¸€ä¸ªæ˜¯ <a href=\"https://github.com/lmcinnes/pynndescent\">PyNNDescent</a>ã€‚PyNNDescent æ˜¯ä¸€ä¸ª Python åº“ï¼Œç”¨äºåŸºäº NN-descent çš„æœç´¢ç®—æ³•ï¼Œå®ƒæ˜¯ LSH çš„ä¸€ä¸ªå˜ä½“ã€‚\n\nç¬¬äºŒä¸ªæ˜¯ <a href=\"http://pixelogik.github.io/NearPy/\">NearPy</a>ã€‚å®ƒæ”¯æŒå¤šä¸ªè·ç¦»åº¦é‡å’Œå“ˆå¸Œæ—ã€‚\n\nç¬¬ä¸‰ä¸ªæ˜¯ <a href=\"https://github.com/storpipfugl/pykdtree\">PyKDTree</a>ã€‚PyKDTree æ˜¯ä¸€ä¸ª Python åº“ï¼Œç”¨äºåŸºäº kd æ ‘çš„æœ€è¿‘é‚»ï¼ˆKNNï¼‰æœç´¢ã€‚è™½ç„¶ kd æ ‘æ›´å¸¸ç”¨äºç²¾ç¡®æœç´¢ï¼Œä½† PyKDTree ä¹Ÿå¯ä»¥é€šè¿‡ä¸€äº›å¯å‘å¼ä¼˜åŒ–ç”¨äºè¿‘ä¼¼æœç´¢ã€‚\n\næ­¤å¤–ï¼Œå¦‚æœæ‚¨è¯¢é—®å“ªäº›ç®—æ³•å’Œåº“æ‰§è¡Œé€Ÿåº¦æœ€å¥½ï¼Œæ‚¨åªéœ€è¦äº†è§£ <a href=\"https://github.com/erikbern/ann-benchmarks\">**ANN-benchmark**</a> åº“ï¼Œä¸“é—¨ä¸ºå¯¹äººå·¥ç¥ç»ç½‘ç»œæœç´¢ç®—æ³•è¿›è¡ŒåŸºå‡†æµ‹è¯•è€Œè®¾è®¡ã€‚å®ƒæä¾›äº†ä¸€ä¸ªæ ‡å‡†åŒ–çš„æ¡†æ¶æ¥è¯„ä¼°ç®—æ³•ï¼Œå¦‚ Annoyã€FLANNã€scikit-learn (LSHForest, KDTree, BallTree)ã€PANNSã€NearPyã€KGraphã€NMSLIB(éåº¦é‡ç©ºé—´åº“)ã€hnswlibã€RPForestã€FAISSã€nndescentã€PyNNDescent ç­‰ç­‰ã€‚\n\nä½†æ˜¯â€œå·´æ–¯å…‰å¹´â€ä¸ä»…ä»…å…³æ³¨æœ€è¿‘é‚»åœ¨å“ªé‡Œï¼Œè¿˜æƒ³é«˜æ•ˆåœ°æ‰¾åˆ°ä»–ä»¬ã€‚é‚£è®©æˆ‘ä»¬å­¦ä¹ ç¬¬ä¸€ä¸ªç®—æ³•â€”â€”HNSWã€‚HNSW é€šå¸¸å¯ä»¥åœ¨å‡ æ¯«ç§’å†…ä»æ•°ç™¾ä¸‡ä¸ªæ•°æ®ç‚¹ä¸­æ‰¾åˆ°æœ€è¿‘é‚»ã€‚\n\n## äº†è§£ HNSWï¼ˆåˆ†å±‚å¯¼èˆªå°ä¸–ç•Œå›¾ï¼‰\n\nHNSW æ˜¯ä¸€ç§ç”¨äºé«˜ç»´ç©ºé—´ä¸­è¿›è¡Œé«˜æ•ˆäººå·¥ç¥ç»ç½‘ç»œæœç´¢çš„æ•°æ®ç»“æ„å’Œç®—æ³•ã€‚å®ƒæ˜¯**è·³è¡¨ï¼ˆSkip Listsï¼‰**å’Œ**å°ä¸–ç•Œï¼ˆSWGï¼‰**ç»“æ„çš„æ‹“å±•ï¼Œå¯ä»¥é«˜æ•ˆåœ°æ‰¾åˆ°è¿‘ä¼¼çš„æœ€è¿‘é‚»ã€‚å¦‚æœæˆ‘ä»¬å…ˆå­¦ä¹ è·³è¡¨å’Œå°ä¸–ç•Œå›¾ï¼Œå­¦ä¹  HNSW å°±ä¼šå¾ˆç®€å•ã€‚\n\nè·³è¡¨æ˜¯ä¸€ç§ç”¨äºç»´æŠ¤å·²æ’åºçš„å…ƒç´ é›†çš„æ•°æ®ç»“æ„ï¼Œå®ƒå…è®¸è¿›è¡Œé«˜æ•ˆçš„æœç´¢ã€æ’å…¥å’Œåˆ é™¤æ“ä½œã€‚å®ƒç”± William Pugh åœ¨ 1989 å¹´å‘æ˜ã€‚å›¾ï¼ˆ2ï¼‰æ˜¾ç¤ºäº†æ•°å­— [3,6,7,9,12,17,19,21,25,26] çš„æ’åºé“¾è¡¨ã€‚å‡è®¾æˆ‘ä»¬æƒ³æ‰¾åˆ°ç›®æ ‡ 19ã€‚å½“å€¼å°äºç›®æ ‡å€¼æ—¶ï¼Œæˆ‘ä»¬å‘å³ç§»åŠ¨ã€‚æ‰¾åˆ°å®ƒéœ€è¦ 6 ä¸ªæ­¥éª¤ã€‚\n\n![å›¾ï¼ˆ2ï¼‰æ’åºé“¾è¡¨](/img/2023-11-20-hnsw/pho3.png)\n\nç°åœ¨ï¼Œå¦‚æœåˆ—è¡¨ä¸­çš„æ¯ä¸ªå…¶ä»–èŠ‚ç‚¹éƒ½æœ‰ä¸€ä¸ªæŒ‡å‘å‰é¢ç¬¬äºŒä¸ªèŠ‚ç‚¹çš„æŒ‡é’ˆï¼Œå¦‚å›¾ï¼ˆ3ï¼‰æ‰€ç¤ºï¼Œå¯ä»¥å°†è¿™äº›æŒ‡é’ˆè§†ä¸ºâ€œé«˜é€Ÿå…¬è·¯â€ã€‚æ•°å­¦è§„åˆ™æ˜¯â€œå½“æ•°å€¼å°äºç›®æ ‡æ—¶å‘å³ç§»åŠ¨â€ã€‚éœ€è¦4ä¸ªæ­¥éª¤æ‰èƒ½è¾¾åˆ°19ã€‚\n\n![å›¾ï¼ˆ3ï¼‰è·³è¡¨ï¼ŒæŒ‡å‘å‰é¢ç¬¬äºŒä¸ªèŠ‚ç‚¹](/img/2023-11-20-hnsw/pho4.png)\n\nè¿™äº›é«˜é€Ÿå…¬è·¯åŠ å¿«äº†æœç´¢é€Ÿåº¦ã€‚æˆ‘ä»¬å¯ä»¥å¢åŠ æ›´å¤šã€‚ç°åœ¨ï¼Œå¦‚æœåˆ—è¡¨ä¸­æ¯ä¸‰ä¸ªå…¶ä»–èŠ‚ç‚¹éƒ½æœ‰ä¸€ä¸ªæŒ‡å‘å‰é¢ç¬¬ä¸‰ä¸ªèŠ‚ç‚¹çš„æŒ‡é’ˆï¼Œå¦‚å›¾ï¼ˆ4ï¼‰æ‰€ç¤ºï¼Œé‚£ä¹ˆåªéœ€è¦ 3 æ­¥å°±å¯ä»¥åˆ°è¾¾ 19ã€‚\n\nä½ å¯èƒ½ä¼šé—®ï¼Œå¦‚ä½•é€‰æ‹©è¿™äº›ç‚¹ä½œä¸ºâ€é«˜é€Ÿå…¬è·¯â€œï¼Ÿå®ƒä»¬å¯ä»¥æ˜¯é¢„å…ˆç¡®å®šçš„ï¼Œä¹Ÿå¯ä»¥æ˜¯éšæœºçš„ã€‚è¿™äº›èŠ‚ç‚¹çš„éšæœºé€‰æ‹©æ˜¯ Small World å’Œ NHSW ä¸­æ•°æ®æ„å»ºçš„é‡è¦æ­¥éª¤ï¼Œæˆ‘å°†åœ¨åé¢ä»‹ç»ã€‚\n\n![å›¾ï¼ˆ4ï¼‰è·³è¡¨å†å‡çº§ï¼ŒæŒ‡å‘å‰é¢ç¬¬ä¸‰ä¸ªèŠ‚ç‚¹](/img/2023-11-20-hnsw/pho5.png)\n\nç”±è·³è¡¨çš„æ€è·¯å»¶ä¼¸åˆ° Small Worldï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹æ˜¯æ€ä¹ˆåšçš„ã€‚\n\n## ä»è·³è¡¨åˆ° Small World\n\nå°ä¸–ç•Œç½‘ç»œæ˜¯ä¸€ç§ç‰¹æ®Šçš„ç½‘ç»œï¼Œåœ¨è¿™ç§ç½‘ç»œä¸­ï¼Œä½ å¯ä»¥è¿…é€Ÿè”ç³»åˆ°ç½‘ç»œä¸­çš„å…¶ä»–äººæˆ–ç‚¹ã€‚è¿™æœ‰ç‚¹åƒâ€œå‡¯æ–‡Â·åŸ¹æ ¹çš„å…­åº¦â€(Six Degrees of Kevin Bacon)æ¸¸æˆï¼Œåœ¨è¿™ä¸ªæ¸¸æˆä¸­ï¼Œä½ å¯ä»¥é€šè¿‡ä¸€ç³»åˆ—å…¶ä»–æ¼”å‘˜ï¼Œåœ¨ä¸åˆ°å…­ä¸ªæ­¥éª¤çš„æ—¶é—´é‡Œï¼Œå°†ä»»ä½•æ¼”å‘˜ä¸å‡¯æ–‡Â·åŸ¹æ ¹è”ç³»èµ·æ¥ã€‚\n\næƒ³è±¡ä¸€ä¸‹ï¼Œä½ æœ‰ä¸€ç¾¤æœ‹å‹æ’æˆä¸€ä¸ªåœ†åœˆï¼Œå¦‚å›¾ï¼ˆ5ï¼‰æ‰€ç¤ºã€‚æ¯ä¸ªæœ‹å‹éƒ½ä¸ååœ¨ä»–ä»¬æ—è¾¹çš„äººç›´æ¥ç›¸è¿ã€‚æˆ‘ä»¬ç§°å®ƒä¸ºâ€œåŸå§‹åœ†â€ã€‚\n\nç°åœ¨ï¼Œè¿™å°±æ˜¯å¥‡è¿¹å‘ç”Ÿçš„åœ°æ–¹ã€‚ä½ å¯ä»¥éšæœºé€‰æ‹©å°†å…¶ä¸­ä¸€äº›è¿æ¥äººæ”¹å˜æˆåœ†åœˆä¸­çš„å…¶ä»–äººï¼Œå°±åƒå›¾ï¼ˆ5ï¼‰ä¸­çš„çº¢è‰²è¿æ¥çº¿ä¸€æ ·ã€‚è¿™å°±åƒè¿™äº›è¿æ¥çš„â€œæŠ¢æ¤…å­â€æ¸¸æˆã€‚æœ‰äººè·³åˆ°å¦ä¸€æŠŠæ¤…å­ä¸Šçš„å‡ ç‡ç”¨æ¦‚ç‡ p è¡¨ç¤ºã€‚å¦‚æœ p å¾ˆå°ï¼Œç§»åŠ¨çš„äººå°±ä¸å¤šï¼Œç½‘ç»œçœ‹èµ·æ¥å°±å¾ˆåƒåŸæ¥çš„åœ†åœˆã€‚ä½†å¦‚æœ p å¾ˆå¤§ï¼Œå¾ˆå¤šäººå°±ä¼šè·³æ¥è·³å»ï¼Œç½‘ç»œå°±ä¼šå˜å¾—æœ‰ç‚¹æ··ä¹±ã€‚å½“æ‚¨é€‰æ‹©æ­£ç¡®çš„ p å€¼(ä¸å¤ªå°ä¹Ÿä¸å¤ªå¤§)æ—¶ï¼Œçº¢è‰²è¿æ¥æ˜¯æœ€ä¼˜çš„ã€‚ç½‘ç»œå˜æˆäº†ä¸€ä¸ªå°ä¸–ç•Œç½‘ç»œã€‚ä½ å¯ä»¥å¾ˆå¿«åœ°ä»ä¸€ä¸ªæœ‹å‹è½¬åˆ°å¦ä¸€ä¸ªæœ‹å‹ï¼ˆè¿™å°±æ˜¯â€œå°ä¸–ç•Œâ€çš„ç‰¹ç‚¹ï¼‰ã€‚\n\n![å›¾ï¼ˆ5ï¼‰Small World ç½‘ç»œ](/img/2023-11-20-hnsw/pho6.png)\n\nç°åœ¨è®©æˆ‘ä»¬å­¦ä¹ ä»å°ä¸–ç•Œç½‘ç»œåˆ°å¯å¯¼èˆªå°ä¸–ç•Œçš„è¿‡æ¸¡ã€‚\n\n## ä» Small World åˆ° HNSW\n\nç°åœ¨æˆ‘ä»¬è¦æ‰©å±•åˆ°é«˜ç»´ç©ºé—´ã€‚å›¾ä¸­çš„æ¯ä¸ªèŠ‚ç‚¹éƒ½æ˜¯ä¸€ä¸ªé«˜ç»´å‘é‡ã€‚åœ¨é«˜ç»´ç©ºé—´ä¸­ï¼Œæœç´¢é€Ÿåº¦ä¼šå˜æ…¢ã€‚è¿™æ˜¯ä¸å¯é¿å…çš„â€œç»´åº¦çš„è¯…å’’â€ã€‚HNSW æ˜¯ä¸€ç§é«˜çº§æ•°æ®ç»“æ„ï¼Œç”¨äºä¼˜åŒ–é«˜ç»´ç©ºé—´ä¸­çš„ç›¸ä¼¼æ€§æœç´¢ã€‚\n\nè®©æˆ‘ä»¬çœ‹çœ‹ HNSW å¦‚ä½•æ„å»ºå›¾çš„å±‚æ¬¡ç»“æ„ã€‚HNSW ä»å›¾ï¼ˆ6ï¼‰ä¸­çš„ç¬¬ 0 å±‚è¿™æ ·çš„åŸºç¡€å›¾å¼€å§‹ã€‚å®ƒé€šå¸¸æ˜¯ä½¿ç”¨éšæœºåˆå§‹åŒ–æ¥æ„é€ çš„æ•°æ®ç‚¹ã€‚\n\n![å›¾ï¼ˆ6ï¼‰HNSW](/img/2023-11-20-hnsw/pho7.png)\n\nHNSW åœ¨å±‚æ¬¡ç»“æ„ä¸­çš„åŸºç¡€å±‚ä¹‹ä¸Šæ„é€ é™„åŠ å±‚ã€‚æ¯ä¸ªå±‚å°†æœ‰æ›´å°‘çš„é¡¶ç‚¹å’Œè¾¹çš„æ•°é‡ã€‚å¯ä»¥æŠŠé«˜å±‚ä¸­çš„é¡¶ç‚¹çœ‹ä½œæ˜¯è·³è·ƒåˆ—è¡¨ä¸­è®¿é—®â€œé«˜é€Ÿå…¬è·¯â€çš„ç‚¹ã€‚ä½ ä¹Ÿå¯ä»¥å°†è¿™äº›é¡¶ç‚¹è§†ä¸ºæ¸¸æˆâ€œSix Degrees of Kevin Baconâ€ä¸­çš„æ¼”å‘˜ Kevin Baconï¼Œå…¶ä»–é¡¶ç‚¹å¯ä»¥åœ¨ä¸åˆ°å…­æ­¥çš„æ—¶é—´å†…è¿æ¥åˆ°è¯¥é¡¶ç‚¹ã€‚\n\nä¸€æ—¦æ„å»ºäº†ä¸Šé¢çš„å±‚æ¬¡ç»“æ„ï¼Œæ•°æ®ç‚¹å°±è¢«ç¼–å…¥ç´¢å¼•ï¼Œå¹¶å‡†å¤‡è¿›è¡ŒæŸ¥è¯¢æœç´¢ã€‚å‡è®¾æŸ¥è¯¢ç‚¹æ˜¯æ©˜è‰²æ•°æ®ç‚¹ã€‚ä¸ºäº†æ‰¾åˆ°ä¸€ä¸ªè¿‘ä¼¼æœ€è¿‘é‚»ï¼ŒHNSW ä»å…¥é—¨çº§ï¼ˆç¬¬ 2 å±‚ï¼‰å¼€å§‹ï¼Œå¹¶é€šè¿‡å±‚æ¬¡ç»“æ„å‘ä¸‹éå†ä»¥æ‰¾åˆ°æœ€è¿‘çš„é¡¶ç‚¹ã€‚åœ¨éå†çš„æ¯ä¸€æ­¥ï¼Œç®—æ³•ä¼šè®¡ç®—ä»æŸ¥è¯¢ç‚¹åˆ°å½“å‰èŠ‚ç‚¹é‚»å±…çš„è·ç¦»ï¼Œç„¶åé€‰æ‹©è·ç¦»æœ€å°çš„é‚»å±…èŠ‚ç‚¹ä½œä¸ºä¸‹ä¸€ä¸ªåŸºæœ¬èŠ‚ç‚¹ã€‚æŸ¥è¯¢ç‚¹åˆ°æœ€è¿‘é‚»å±…ä¹‹é—´çš„è·ç¦»æ˜¯å¸¸ç”¨çš„åº¦é‡ï¼Œå¦‚æ¬§å‡ é‡Œå¾—è·ç¦»æˆ–ä½™å¼¦ç›¸ä¼¼åº¦ã€‚å½“æ»¡è¶³æŸä¸ªåœæ­¢æ¡ä»¶ï¼ˆä¾‹å¦‚è·ç¦»è®¡ç®—æ¬¡æ•°ï¼‰æ—¶ï¼Œæœç´¢ç»ˆæ­¢ã€‚\n\nç°åœ¨è®©æˆ‘ä»¬çœ‹çœ‹ HNSW æ˜¯å¦‚ä½•æ„é€ å±‚çš„ã€‚\n\n### HNSW å¦‚ä½•æ„å»ºæ•°æ®æœºæ„\n\nHNSW é¦–å…ˆåˆå§‹åŒ–ä¸€ä¸ªç©ºå›¾ä½œä¸ºæ•°æ®ç»“æ„çš„åŸºç¡€ã€‚è¯¥å›¾è¡¨ç¤ºä¸€ä¸ªæ¥ä¸€ä¸ªæ’å…¥æ•°æ®ç‚¹çš„ç©ºé—´ã€‚HNSW å°†æ•°æ®ç‚¹ç»„ç»‡æˆå¤šå±‚ã€‚æ¯ä¸€å±‚è¡¨ç¤ºæ•°æ®ç»“æ„ä¸­ä¸åŒçº§åˆ«çš„ç²’åº¦ã€‚å±‚çš„æ•°é‡æ˜¯é¢„å…ˆå®šä¹‰çš„ï¼Œé€šå¸¸å–å†³äºæ•°æ®çš„ç‰¹å¾ã€‚\n\næ¯ä¸ªæ•°æ®ç‚¹ä¼šè¢«éšæœºåˆ†é…åˆ°ä¸€ä¸ªå±‚ã€‚æœ€é«˜çš„å±‚æ˜¯æœ€ç²—ç•¥çš„è¡¨ç¤ºï¼Œéšç€å±‚çš„å‘ä¸‹ç§»åŠ¨ï¼Œè¡¨ç¤ºå°±ä¼šå˜å¾—æ›´ç²¾ç»†ã€‚è¿™ä¸ªä»»åŠ¡æ˜¯ç”¨ä¸€ä¸ªç‰¹å®šçš„æ¦‚ç‡åˆ†å¸ƒæ¥å®Œæˆçš„ï¼Œè¿™ä¸ªæ¦‚ç‡åˆ†å¸ƒå«åš**æŒ‡æ•°è¡°å‡æ¦‚ç‡åˆ†å¸ƒï¼ˆexponential decaying probability distributionï¼‰**ã€‚è¿™ç§åˆ†å¸ƒä½¿å¾—æ•°æ®ç‚¹åˆ°è¾¾æ›´é«˜å±‚çš„å¯èƒ½æ€§å¤§å¤§é™ä½ã€‚å¦‚æœä½ è¿˜è®°å¾—è·³è·ƒåˆ—è¡¨ä¸­éšæœºé€‰æ‹©çš„æ•°æ®ç‚¹ä½œä¸ºâ€œé«˜é€Ÿå…¬è·¯â€ï¼Œè¿™é‡Œçš„ä¸€äº›æ•°æ®ç‚¹æ˜¯éšæœºé€‰æ‹©åˆ°æœ€é«˜å±‚çš„ã€‚åœ¨åé¢çš„ä»£ç ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬å°†çœ‹åˆ°æ¯å±‚ä¸­çš„æ•°æ®ç‚¹æ•°é‡ï¼Œå¹¶ä¸”æ•°æ®ç‚¹çš„æ•°é‡åœ¨æ›´é«˜å±‚ä¸­å‘ˆæŒ‡æ•°çº§å‡å°‘ã€‚\n\nä¸ºäº†åœ¨æ¯ä¸€å±‚å†…æœ‰æ•ˆåœ°æ„å»ºè¿æ¥ï¼ŒHNSW ä½¿ç”¨è´ªå©ªæœç´¢ç®—æ³•ã€‚å®ƒä»é¡¶å±‚å¼€å§‹ï¼Œè¯•å›¾å°†æ¯ä¸ªæ•°æ®ç‚¹è¿æ¥åˆ°åŒä¸€å±‚å†…æœ€è¿‘çš„é‚»å±…ã€‚ä¸€æ—¦å»ºç«‹äº†ä¸€å±‚ä¸­çš„è¿æ¥ï¼ŒHNSW å°†ä½¿ç”¨è¿æ¥ç‚¹ä½œä¸ºæœç´¢çš„èµ·ç‚¹ç»§ç»­å‘ä¸‹æ‰©å±•åˆ°ä¸‹ä¸€å±‚ã€‚æ„å»ºè¿‡ç¨‹ä¸€ç›´æŒç»­åˆ°å¤„ç†å®Œæ‰€æœ‰å±‚ï¼Œå¹¶ä¸”å®Œå…¨æ„å»ºäº†æ•°æ®ç»“æ„ã€‚\n\nè®©æˆ‘ä»¬ç®€å•æ€»ç»“ä¸€ä¸‹ HNSW ä¸­æ•°æ®ç»“æ„çš„æ„é€ ã€‚è®©æˆ‘ä¹Ÿå‚è€ƒ Malkov å’Œ Yashunin[3] ä¸­çš„ç¬¦å·ï¼Œå¹¶åœ¨é™„å½•ä¸­è§£é‡Š HNSW ç®—æ³•ã€‚ä½ å¯èƒ½ä¼šå‘ç°å®ƒä»¬æœ‰åŠ©äºæ›´æ˜ç¡®åœ°ç†è§£ HNSW çš„ç®—æ³•ã€‚HNSW å£°æ˜ä¸€ä¸ªç©ºç»“æ„å¹¶é€ä¸ªæ’å…¥æ•°æ®å…ƒç´ ã€‚å®ƒä¿æŒæ¯ä¸ªæ•°æ®ç‚¹æ¯å±‚æœ€å¤šæœ‰ M ä¸ªè¿æ¥çš„å±æ€§ï¼Œå¹¶ä¸”æ¯ä¸ªæ•°æ®ç‚¹çš„è¿æ¥æ€»æ•°ä¸è¶…è¿‡æœ€å¤§å€¼ï¼ˆMmaxï¼‰ã€‚åœ¨æ¯ä¸€å±‚ä¸­ï¼ŒHNSW æ‰¾åˆ°ä¸æ–°æ•°æ®ç‚¹æœ€è¿‘çš„ K ä¸ªé‚»å±…ã€‚ç„¶åï¼Œå®ƒæ ¹æ®è·ç¦»æ›´æ–°å€™é€‰æ•°æ®ç‚¹é›†å’Œæ‰¾åˆ°çš„æœ€è¿‘é‚»å±…åˆ—è¡¨ï¼ˆWï¼‰ã€‚å¦‚æœ W ä¸­çš„æ•°æ®ç‚¹æ•°é‡è¶…è¿‡äº†åŠ¨æ€å€™é€‰åˆ—è¡¨ï¼ˆefï¼‰çš„å¤§å°ï¼Œåˆ™è¯¥å‡½æ•°ä» W ä¸­åˆ é™¤æœ€è¿œçš„æ•°æ®ç‚¹ã€‚\n\næ¥ä¸‹æ¥ï¼Œæˆ‘å°†å‘ä½ å±•ç¤ºä»£ç ç¤ºä¾‹ã€‚è¯¥ç¬”è®°æœ¬å¯é€šè¿‡<a href=\"https://github.com/dataman-git/codes_for_articles/blob/master/HNSW.ipynb\">æ­¤é“¾æ¥</a>è·å¾—ã€‚\n\n### ä»£ç ç¤ºä¾‹\n\næ¥ä¸‹æ¥ï¼Œè®©æˆ‘ä»¬ä½¿ç”¨åº“ FAISS æ‰§è¡Œ HNSW æœç´¢ã€‚æˆ‘å°†ä½¿ç”¨ NLP ä¸­åŒ…å«æ–°é—»æ–‡ç« çš„æµè¡Œæ•°æ®é›†ã€‚ç„¶åï¼Œæˆ‘ä½¿ç”¨â€œSentenceTransformerâ€æ‰§è¡Œ Embeddingsã€‚ç„¶åï¼Œæˆ‘å°†å‘ä½ å±•ç¤ºå¦‚ä½•ä½¿ç”¨ HNSW é€šè¿‡æŸ¥è¯¢æœç´¢ç±»ä¼¼çš„æ–‡ç« ã€‚\n\n#### data\n\næ€»æ£€å¯Ÿé•¿çš„æ–°é—»æ–‡ç« è¯­æ–™åº“ç”± <a href=\"http://groups.di.unipi.it/~gulli/AG_corpus_of_news_articles.html\">A.Gulli</a>ï¼Œæ˜¯ä¸€ä¸ªä»2000å¤šä¸ªæ–°é—»æ¥æºæ”¶é›†100å¤šä¸‡ç¯‡æ–°é—»æ–‡ç« çš„å¤§å‹ç½‘ç«™ã€‚Zhangã€Zhaoå’ŒLeCunåœ¨è®ºæ–‡ä¸­æ„å»ºäº†ä¸€ä¸ªè¾ƒå°çš„é›†åˆï¼Œå…¶ä¸­é‡‡æ ·äº†â€œä¸–ç•Œâ€ã€â€œä½“è‚²â€ã€â€œå•†ä¸šâ€å’Œâ€œç§‘å­¦â€ç­‰æ–°é—»æ–‡ç« ï¼Œå¹¶å°†å…¶ç”¨ä½œæ–‡æœ¬åˆ†ç±»åŸºå‡†ã€‚è¿™ä¸ªæ•°æ®é›†â€œag_newsâ€å·²ç»æˆä¸ºä¸€ä¸ªç»å¸¸ä½¿ç”¨çš„æ•°æ®é›†ï¼Œå¯ä»¥åœ¨Kaggleã€PyTorchã€Huggingfaceå’ŒTensorflowä¸­ä½¿ç”¨ã€‚è®©æˆ‘ä»¬ä» Kaggle <a href=\"https://www.kaggle.com/datasets/amananandrai/ag-news-classification-dataset\">ä¸‹è½½æ•°æ®</a>ã€‚è®­ç»ƒæ ·æœ¬å’Œæµ‹è¯•æ ·æœ¬åˆ†åˆ«æœ‰ 12 ä¸‡ç¯‡å’Œ 7600 ç¯‡æ–°é—»æ–‡ç« ã€‚\n\n```py\nimport pandas as pd\nimport numpy as np\nimport faiss\npd.set_option('display.max_colwidth', None)\npath = \"/mnt/disk8/djw/anaconda_project/content/gdrive/data\"\n\ntrain = pd.read_csv(path + \"/train.csv\")\ntrain.shape\ntrain.head(5)\n```\nè¾“å‡ºå½¢çŠ¶ä¸º(120000,3)ï¼Œåˆ—ä¸º['Class Index','Title','Description']ã€‚æˆ‘ä»¬å¯¹â€œæè¿°â€æ æ„Ÿå…´è¶£ã€‚ä»¥ä¸‹æ˜¯æ’åå‰äº”çš„è®°å½•ï¼š\n\n![æ’åå‰äº”çš„è®°å½•](/img/2023-11-20-hnsw/pho7.png)\n\n#### æ•°æ®åµŒå…¥\n\nå‡ºäºè¯´æ˜çš„ç›®çš„ï¼Œæˆ‘åªä½¿ç”¨10,000æ¡è®°å½•è¿›è¡ŒEmbeddingsã€‚\n\n```py\nsentences = train['Description'][0:10000]\n```\n\næ‚¨éœ€è¦ pip å®‰è£…\"sentence_transformers\"åº“ã€‚\n\n```py\n!pip install sentence_transformers\nfrom sentence_transformers import SentenceTransformer\n```\n\nç„¶åè®©æˆ‘ä»¬ä½¿ç”¨é¢„è®­ç»ƒæ¨¡å‹\"bert-base-nli-mean-tokens\"æ¥å£°æ˜æ¨¡å‹ã€‚åœ¨<a href=\"https://www.sbert.net/docs/pretrained_models.html\">æœ¬é¡µ</a>ä¸Šæœ‰è®¸å¤šé¢„å…ˆè®­ç»ƒå¥½çš„æ¨¡å‹ã€‚\n\n```py\nmodel = SentenceTransformer('bert-base-nli-mean-tokens')\n```\n\nç„¶åæˆ‘ä»¬å°†â€œå¥å­â€ç¼–ç ä¸ºâ€œsentence_embeddingsâ€ã€‚\n```py\nsentence_embeddings = model.encode(sentences)\nprint(sentence_embeddings.shape)\nsentence_embeddings[0:5]\n```\n\nè¾“å‡ºæ˜¯10,000ä¸ªåˆ—è¡¨ã€‚æ¯ä¸ªåˆ—è¡¨æˆ–å‘é‡çš„ç»´æ•°ä¸º768ã€‚ä¸‹é¢æ˜¯å‰ 5 ä¸ª Embeddings çš„è¾“å‡ºã€‚\n\n![Embeddings](/img/2023-11-20-hnsw/pho8.png)\n\nè¿™æœ‰åŠ©äºä¿å­˜Embeddingsä»¥å¤‡å°†æ¥ä½¿ç”¨ã€‚\n\n```py\nwith open(path + '/AG_news.npy', 'wb') as file:\n    np.save(file, sentence_embeddings)\n```\n\nåœ¨ä¸Šé¢çš„ä»£ç ä¸­ï¼Œæˆ‘ä½¿ç”¨äº†â€œnpyâ€æ–‡ä»¶æ‰©å±•åï¼Œè¿™æ˜¯ NumPy æ•°ç»„æ–‡ä»¶çš„å¸¸è§„æ‰©å±•åã€‚ä¸‹é¢æ˜¯åŠ è½½æ•°æ®çš„ä»£ç :\n\n```py\nwith open (path + '/AG_news.npy', 'rb') as f:\n    sentence_embeddings = np.load(f, allow_pickle=True)\n```\n\næœ‰äº†è¿™äº› Embeddingsï¼Œæˆ‘ä»¬å°±å¯ä»¥åœ¨HNSWæ•°æ®ç»“æ„ä¸­ç»„ç»‡å®ƒä»¬äº†ã€‚\n\n#### ä½¿ç”¨FAISSæ„å»ºNHSWæ•°æ®ç»“æ„ç´¢å¼•\n\næ‚¨éœ€è¦åƒä¸‹é¢è¿™æ · pip å®‰è£… FAISS åº“ï¼š\n\n```py\n!pip install faiss-cpu --no-cache\n```\n\næˆ‘å°†ä½¿ç”¨ HNSWFlat(dim, m) ç±»æ¥æ„å»º HNSWã€‚å®ƒéœ€è¦é¢„å…ˆç¡®å®šçš„å‚æ•° dim è¡¨ç¤ºå‘é‡çš„ç»´æ•°ï¼Œm è¡¨ç¤ºæ•°æ®å…ƒç´ ä¸å…¶ä»–å…ƒç´ è¿æ¥çš„è¾¹æ•°ã€‚\n\n```py\nimport faiss\nm = 32\ndim = 768\nindex = faiss.IndexHNSWFlat(dim, m)\n```\n\nå¦‚ä¸Šæ‰€è¿°ï¼ŒHNSW æŒ‡æ•°çš„åˆ›å»ºåˆ†ä¸ºä¸¤ä¸ªä¸åŒçš„é˜¶æ®µã€‚åœ¨åˆå§‹é˜¶æ®µï¼Œè¯¥ç®—æ³•ä½¿ç”¨æ¦‚ç‡åˆ†å¸ƒæ¥é¢„æµ‹æœ€ä¸Šå±‚çš„æ–°æ•°æ®èŠ‚ç‚¹ã€‚åœ¨éšåçš„é˜¶æ®µä¸­ï¼Œå°†æ”¶é›†æ¯ä¸ªæ•°æ®ç‚¹çš„æœ€è¿‘é‚»å±…ï¼Œç„¶åä½¿ç”¨ä¸€ä¸ªè¡¨ç¤ºä¸º mï¼ˆåœ¨æˆ‘ä»¬çš„ç¤ºä¾‹ä¸­ä¸º m = 16ï¼‰çš„å€¼è¿›è¡Œå‰ªæã€‚æ•´ä¸ªè¿‡ç¨‹è¿­ä»£ï¼Œä»æ’å…¥å±‚å¼€å§‹ï¼Œä¸€ç›´åˆ°åº•å±‚ã€‚\n\nåœ¨ HNSW ä¸­æœ‰ä¸¤ä¸ªé‡è¦çš„å‚æ•° \"efConstruction\" å’Œ \"efSearch\"ã€‚è¿™ä¸¤ä¸ªå‚æ•°æ§åˆ¶ç€ç´¢å¼•ç»“æ„æ„å»ºçš„æ•ˆç‡å’Œæœ‰æ•ˆæ€§ã€‚å®ƒä»¬å¸®åŠ©æ‚¨åœ¨ HNSW ç´¢å¼•ç»“æ„ä¸­çš„ç´¢å¼•æ„é€ å’Œè¿‘é‚»æœç´¢æ“ä½œçš„é€Ÿåº¦å’Œè´¨é‡ä¹‹é—´å–å¾—å¹³è¡¡ã€‚\n\n1. \"efConstruction\": è¿™ä¸ªå‚æ•°åœ¨ HNSW æŒ‡æ•°çš„æ„å»ºè¿‡ç¨‹ä¸­ä½¿ç”¨ã€‚å®ƒæ§åˆ¶æ„å»ºæŒ‡æ•°ç»“æ„çš„é€Ÿåº¦å’Œç»“æ„çš„è´¨é‡ä¹‹é—´çš„å¹³è¡¡ã€‚\"efConstruction\" å€¼å†³å®šäº†åœ¨æ„å»ºé˜¶æ®µéœ€è¦è€ƒè™‘å¤šå°‘å€™é€‰é¡¹ã€‚è¾ƒ\né«˜çš„ \"efConstruction\" å€¼å°†äº§ç”Ÿæ›´ç²¾ç¡®çš„æŒ‡æ•°ç»“æ„ï¼Œä½†ä¹Ÿä¼šä½¿æ„å»ºè¿‡ç¨‹å˜æ…¢\n\n2. \"efSearch\": è¿™ä¸ªå‚æ•°ç”¨äºåœ¨ HNSW ç´¢å¼•ä¸­æŸ¥æ‰¾æŸ¥è¯¢ç‚¹çš„æœ€è¿‘é‚»å±…ã€‚\"efSearch\" å€¼æ§åˆ¶æœç´¢é€Ÿåº¦å’Œæœç´¢è´¨é‡ä¹‹é—´çš„å¹³è¡¡ã€‚è¾ƒé«˜çš„ \"efSearch\" å€¼å°†å¯¼è‡´æ›´ç²¾ç¡®å’Œç©·ä¸¾æœç´¢ï¼Œä½†ä¹Ÿä¼šæ›´æ…¢ã€‚\n\næˆ‘ä»¬ä¸º \"efConstruction\" å’Œ \"efSearch\" è®¾ç½®äº† 40 å’Œ 16:\n\n```py\nindex.hnsw.efConstruction = 40 \nindex.hnsw.efSearch = 16  \n```\n\næˆ‘ä»¬å·²ç»å£°æ˜äº†ä¸Šé¢çš„æ•°æ®ç»“æ„ã€‚ç°åœ¨æˆ‘ä»¬å‡†å¤‡å°†æ•°æ® \"sentence_embeddings\" ä¸€ä¸ªæ¥ä¸€ä¸ªåœ°æ’å…¥åˆ°æ•°æ®ç»“æ„ä¸­ï¼š\n\n```py\nindex.add(sentence_embeddings)\n```\n\nä¸€æ—¦å®Œæˆï¼Œæˆ‘ä»¬å¯ä»¥æ£€æŸ¥ HNSW æ•°æ®ç»“æ„ä¸­æœ‰å¤šå°‘æ•°æ®å…ƒç´ ï¼š\n\n```py\nindex.ntotal\n```\n\nè¾“å‡ºä¸º 10000ã€‚å®ƒæ˜¯ \"sentence_embeddings\" ä¸­çš„æ•°æ®ç‚¹æ•°ã€‚æ¥ä¸‹æ¥ï¼ŒHNSW å»ºé€ äº†å¤šå°‘å±‚ï¼Ÿè®©æˆ‘ä»¬æ¥æ£€æŸ¥æœ€å¤§çº§åˆ«ï¼š\n\n```py\n# the HNSW index starts with no levels\nindex.hnsw.max_level\n```\n\næœ€å¤§çº§åˆ«ä¸º 2.0ã€‚è¿™æ„å‘³ç€æœ‰ç¬¬ 0ã€1ã€2 å±‚ã€‚æ¥ä¸‹æ¥ï¼Œæ‚¨å¯èƒ½æƒ³çŸ¥é“æ¯å±‚ä¸­æ•°æ®å…ƒç´ çš„æ•°é‡ã€‚è®©æˆ‘ä»¬æ¥çœ‹çœ‹ï¼š\n\n```py\nlevels = faiss.vector_to_array(index.hnsw.levels)\nnp.bincount(levels)\n```\n\nè¾“å‡ºä¸º array([0,9713,280,7])ã€‚\"0\" æ²¡æœ‰æ„ä¹‰ï¼Œä½ å¯ä»¥å¿½ç•¥å®ƒã€‚å®ƒè¯´ç¬¬ 0 å±‚æœ‰ 9713 ä¸ªæ•°æ®å…ƒç´ ï¼Œç¬¬ 1 å±‚æœ‰ 280 ä¸ªå…ƒç´ ï¼Œç¬¬ 2 å±‚åªæœ‰ 7 ä¸ªå…ƒç´ ã€‚æ³¨æ„ï¼Œ9713 + 280 + 7 = 10000ã€‚æ‚¨æ˜¯å¦å‘ç°ï¼Œè¾ƒé«˜å±‚çš„æ•°æ®å…ƒç´ æ•°é‡æ¯”å‰å‡ å±‚å‘ˆæŒ‡æ•°çº§å‡å°‘ï¼Ÿè¿™æ˜¯å› ä¸ºæ•°æ®å…ƒç´ çš„å±‚åˆ†é…é‡‡ç”¨æŒ‡æ•°è¡°å‡æ¦‚ç‡åˆ†å¸ƒã€‚\n\n#### FAISSä¸ºHNSWæœç´¢ç¤ºä¾‹\n\nå‡è®¾æˆ‘ä»¬çš„æœç´¢æŸ¥è¯¢æ˜¯â€œç»æµç¹è£ä¸è‚¡å¸‚ï¼ˆeconomic booming and stock marketï¼‰â€ã€‚æˆ‘ä»¬å¸Œæœ›æ‰¾åˆ°ä¸æˆ‘ä»¬çš„æœç´¢æŸ¥è¯¢ç›¸å…³çš„æ–‡ç« ã€‚æˆ‘ä»¬å°†é¦–å…ˆåµŒå…¥æœç´¢æŸ¥è¯¢ï¼š\n\n```py\nqry1 = model.encode([\"economic booming and stock market\"])\n```\n\nä½¿ç”¨ä»£ç  index.search()ï¼Œæœç´¢è¿‡ç¨‹éå¸¸ç®€å•ã€‚è¿™é‡Œ k æ˜¯æœ€è¿‘é‚»å±…çš„ä¸ªæ•°ã€‚æˆ‘ä»¬å°†å…¶è®¾ç½®ä¸º 5ï¼Œå³è¿”å› 5 ä¸ªé‚»å±…ã€‚index.search()å‡½æ•°è¿”å›ä¸¤ä¸ªå€¼ \"d\" å’Œ \"I\"ã€‚\n\n- \"d\": æŸ¥è¯¢å‘é‡ä¸ k ä¸ªæœ€è¿‘é‚»ä¹‹é—´çš„è·ç¦»åˆ—è¡¨ã€‚é»˜è®¤çš„è·ç¦»åº¦é‡æ˜¯æ¬§å‡ é‡Œå¾—åº¦é‡ã€‚\n- \"i\": ç´¢å¼•ä¸­ k ä¸ªæœ€è¿‘é‚»å±…çš„ä½ç½®å¯¹åº”çš„ç´¢å¼•åˆ—è¡¨ã€‚è¿™äº›ç´¢å¼•å¯ä»¥ç”¨æ¥æŸ¥æ‰¾æ•°æ®é›†ä¸­çš„å®é™…æ•°æ®ç‚¹ã€‚\n\n```py\n%%time\nk=5\nd, I = index.search(qry1, k)\nprint(I)\nprint(d)\n```\n\nç´¢å¼•åˆ—è¡¨çš„è¾“å‡ºæ˜¯[[6412 6394 9103 3813 1467]]ã€‚æˆ‘ä»¬å°†ä½¿ç”¨è¿™äº›ç´¢å¼•æ‰“å°å‡ºæœç´¢ç»“æœã€‚\n\næ³¨æ„ï¼Œæˆ‘ä½¿ç”¨ \"%%time\" æ¥åº¦é‡æ‰§è¡Œæ—¶é—´ã€‚å®ƒè¾“å‡º\n\nCPU times: user 812 ms, sys: 42.6 ms, total: 855 ms\n\nè¿™æ„å‘³ç€æœç´¢åªéœ€è¦å‡ ç™¾æ¯«ç§’ã€‚è¿™ç¡®å®æ˜¯ä»¤äººéš¾ä»¥ç½®ä¿¡çš„å¿«!\n\nè·ç¦»è¾“å‡ºåˆ—è¡¨ä¸ºï¼š[[155.64159 169.03458 183.2863  190.07074 194.54048]]\n\n```py\nfor i in I[0]:\n  print(train['Description'][i])\n```\n\n![è¾“å‡º](/img/2023-11-20-hnsw/pho10.png)\n\nè¿™äº›æ–‡ç« éƒ½æ˜¯å…³äºç»æµå’Œè‚¡ç¥¨å¸‚åœºçš„æ–°é—»ã€‚æœç´¢é€Ÿåº¦ä»¥æ¯«ç§’è®¡éå¸¸å¿«ã€‚è¿™ä¸ä»…ä»…æ˜¯ç»“æœåœ¨å“ªé‡Œçš„é—®é¢˜ï¼Œè€Œæ˜¯å¦‚ä½•å¿«é€Ÿå¾—åˆ°ç»“æœçš„é—®é¢˜ï¼Œä¸æ˜¯å—?\n\næ‚¨å¯ä»¥é€šè¿‡<a href=\"https://github.com/dataman-git/codes_for_articles/blob/master/HNSW.ipynb\">æ­¤é“¾æ¥</a>ä¸‹è½½ç¬”è®°æœ¬è¿›è¡Œä¸Šè¿°æœç´¢ã€‚\n\n## æ€»ç»“\n\næˆ‘å¸Œæœ›è¿™ç¯‡æ–‡ç« èƒ½å¸®åŠ©ä½ ç†è§£è¿‘ä¼¼è¿‘é‚»ï¼ˆANNï¼‰ï¼Œä»¥åŠå®ƒæ˜¯å¦‚ä½•æä¾›é«˜æ•ˆæœç´¢çš„ã€‚æœ¬æ–‡ä»‹ç»äº†ä¸åŒçš„äººå·¥ç¥ç»ç½‘ç»œç®—æ³•ï¼ŒåŒ…æ‹¬åŸºäºå›¾çš„ HNSWï¼ŒåŸºäºå“ˆå¸Œçš„ LSH æˆ–ä¹˜ç§¯é‡åŒ–ï¼Œä»¥åŠåŸºäºæ ‘çš„ KD-Treesã€‚æ˜¯å¦‚ä½•æ„å»ºå®ƒçš„æ•°æ®ç»“æ„å¹¶é€ä¸ªæ’å…¥æ•°æ®å…ƒç´ çš„ã€‚è¿™ç¯‡æ–‡ç« æ¼”ç¤ºäº†å¦‚ä½•ä½¿ç”¨ FAISS åº“æ„å»ºç”¨äºæŸ¥è¯¢æœç´¢çš„ HNSWã€‚\n\n## é™„å½•\n\nåœ¨ Malkov å’Œ Yashunin [3]çš„è®ºæ–‡ä¸­ï¼Œç®—æ³• 1 åˆ° 5 ä¼ªä»£ç ä¸­ä»‹ç»äº† HNSW ç®—æ³•ã€‚ä¼ªä»£ç ç»™å‡ºäº†ç®—æ³•çš„å…·ä½“å®šä¹‰ã€‚æˆ‘åœ¨ä¼ªä»£ç ä¸­åŠ å…¥äº†ä»¥ä¸‹çš„æè¿°ï¼Œå¯èƒ½ä¼šå¸®åŠ©ä¸€äº›è¯»è€…æ›´è½»æ¾åœ°ç†è§£ HNSWã€‚ç®—æ³• 1ã€ç®—æ³• 2ã€ç®—æ³• 3 å’Œç®—æ³• 4 ä¸­çš„ä»»æ„ä¸€ä¸ªï¼Œéƒ½å¯è¢«ç”¨æ¥æ„å»ºæ•°æ®ç»“æ„ã€‚ä½†ä¸€æ—¦æ•°æ®ç»“æ„å®Œæˆï¼Œä»»ä½•æœªæ¥çš„æŸ¥è¯¢æœç´¢åªä½¿ç”¨ç®—æ³• 5ã€‚\n\n- ç®—æ³•1:\"INSERT\"å‡½æ•°æ„é€ æ•°æ®ç»“æ„\n- ç®—æ³•2:\"SEARCH-LAYER\"å‡½æ•°è®¡ç®— KNN å¹¶å­˜å‚¨é‚»å±…\n- ç®—æ³•3:\"SEARCH-NEIGHBORS-SIMPLE\"å‡½æ•°æ˜¯ä¸€ç§é€‰æ‹©é‚»å±…çš„ç®€å•æ–¹æ³•\n- ç®—æ³•4:\"SELECT-NEIGHBORS-HEURISTIC\"å‡½æ•°æ˜¯ä¸€ç§æ›´å¤æ‚çš„é€‰æ‹©é‚»å±…çš„æ–¹æ³•\n- ç®—æ³•5:\"KNN-SEARCH\"å‡½æ•°è¿›è¡ŒæŸ¥è¯¢æœç´¢\n\n### ç®—æ³•ä¸€ï¼šINSERT()\n\n```py\nAlgorithm 1: INSERT()\n\nINSERT(hnsw, q, M, Mmax, efConstruction, mL)\nInput: multilayer graph hnsw, new element q, number of established\nconnections M, maximum number of connections for each element\nper layer Mmax, size of the dynamic candidate list efConstruction, nor-\nmalization factor for level generation mL\nOutput: update hnsw inserting element q\n\n1 W â† âˆ… // list for the currently found nearest elements\n2 ep â† get enter point for hnsw\n3 L â† level of ep // top layer for hnsw\n4 l â† âŒŠ-ln(unif(0..1))âˆ™mLâŒ‹ // new elementâ€™s level\n5 for lc â† L â€¦ l+1\n6 W â† SEARCH-LAYER(q, ep, ef=1, lc)\n7 ep â† get the nearest element from W to q\n8 for lc â† min(L, l) â€¦ 0\n9 W â† SEARCH-LAYER(q, ep, efConstruction, lc)\n10 neighbors â† SELECT-NEIGHBORS(q, W, M, lc) // alg. 3 or alg. 4\n11 add bidirectionall connectionts from neighbors to q at layer lc\n12 for each e âˆˆ neighbors // shrink connections if needed\n13 eConn â† neighbourhood(e) at layer lc\n14 if â”‚eConnâ”‚ > Mmax // shrink connections of e\n// if lc = 0 then Mmax = Mmax0\n15 eNewConn â† SELECT-NEIGHBORS(e, eConn, Mmax, lc)\n// alg. 3 or alg. 4\n16 set neighbourhood(e) at layer lc to eNewConn\n17 ep â† W\n18 if l > L\n19 set enter point for hnsw to q\n20 return hnsw\n```\n\nå®ƒåœ¨å¤šå±‚å›¾ä¸­æ’å…¥ä¸€ä¸ªæ–°å…ƒç´  qï¼Œä¿è¯æ¯ä¸ªå…ƒç´ æ¯å±‚æœ€å¤šæœ‰ M ä¸ªè¿æ¥ï¼Œå¹¶ä¸”æ¯ä¸ªå…ƒç´ çš„è¿æ¥æ€»æ•°ä¸è¶…è¿‡ Mmaxã€‚è¯¥ç®—æ³•è¿˜ä¿è¯äº†è¿é€šå…ƒç´ ä¹‹é—´çš„è·ç¦»ä¸å¤§äºæŸä¸ªæœ€å¤§è·ç¦»ï¼Œå¹¶ä¸”æ¯å±‚çš„è¿é€šæ•°æ˜¯å‡è¡¡çš„ã€‚å…·ä½“æ­¥éª¤å¦‚ä¸‹:\n\n01. W â† âˆ…ï¼šåˆå§‹åŒ–ä¸€ä¸ªç©ºåˆ—è¡¨ W æ¥å­˜å‚¨å½“å‰æ‰¾åˆ°çš„æœ€è¿‘çš„å…ƒç´ ã€‚\n02. ep â† get enter point for hnswï¼šè·å–å¤šå±‚å›¾ HNSW çš„è¿›å…¥ç‚¹ï¼ˆå³åˆå§‹ç‚¹ï¼‰\n03. L â† level of epï¼šè·å–è¿›å…¥ç‚¹ ep çš„çº§åˆ«ã€‚\n04. l â† âŒŠ-ln(unif(0..1))âˆ™mLâŒ‹ï¼šä¸ºæ–°å…ƒç´  q ç”Ÿæˆä¸€ä¸ªä»‹äº 0 å’Œ mL ä¹‹é—´çš„éšæœºçº§åˆ«ï¼Œå…¶ä¸­ mL æ˜¯çº§åˆ«ç”Ÿæˆçš„å½’ä¸€åŒ–å› å­ã€‚\n05. for lc â† L â€¦ l+1ï¼šå¾ªç¯ä» L åˆ° l + 1 çš„å±‚ã€‚\n06. W â† SEARCH-LAYER(q, ep, ef=1, lc)ï¼šä½¿ç”¨è¿›å…¥ç‚¹ ep å’Œæœ€å¤§è·ç¦» ef=1 åœ¨ lc å±‚ä¸­æœç´¢ç¦» q æœ€è¿‘çš„å…ƒç´ ã€‚å°†æ‰¾åˆ°çš„å…ƒç´ å­˜å‚¨åœ¨åˆ—è¡¨ W ä¸­ã€‚\n07. ep â† get the nearest element from W to qï¼šå– W åˆ° q æœ€è¿‘çš„å…ƒç´ ã€‚\n08. for lc â† min(L, l) â€¦ 0ï¼šå¾ªç¯éå†ä» min(L, l) åˆ° 0 çš„å±‚ã€‚\n09. W â† SEARCH-LAYER(q, ep, efConstruction, lc)ï¼šä½¿ç”¨è¿›å…¥ç‚¹ ep å’Œæœ€å¤§è·ç¦» efConstruction åœ¨ lc å±‚ä¸­æœç´¢ç¦» q æœ€è¿‘çš„å…ƒç´ ã€‚å°†æ‰¾åˆ°çš„å…ƒç´ å­˜å‚¨åœ¨åˆ—è¡¨ w ä¸­ã€‚\n10. neighbors â† SELECT neighbors (q, W, M, lc)ï¼šé€‰æ‹© W åˆ° q æœ€è¿‘çš„ M ä¸ªé‚»å±…ï¼Œåªè€ƒè™‘ lc å±‚çš„å…ƒç´ ã€‚\n11. add bidirectionall connectionts from neighbors to q at layer lcï¼š åœ¨ lc å±‚çš„ q å’Œé€‰å®šçš„é‚»å±…ä¹‹é—´æ·»åŠ åŒå‘è¿æ¥ã€‚\n12. 12~14ï¼šå¯¹äºæ¯ä¸ªeâˆˆneighborsï¼Œå¦‚æœéœ€è¦æ”¶ç¼©è¿æ¥ï¼Œå¯¹äº q çš„æ¯ä¸ªé‚»å±… eï¼Œæ£€æŸ¥ e çš„è¿æ¥æ•°æ˜¯å¦è¶…è¿‡ Mmaxã€‚å¦‚æœè¶…è¿‡ï¼Œä½¿ç”¨SELECT neighbors (e, eConn, Mmax, lc) é€‰æ‹©ä¸€ç»„æ–°çš„é‚»å±…æ¥æ”¶ç¼© e çš„è¿æ¥ï¼Œå…¶ä¸­ eConn æ˜¯ e åœ¨ lc å±‚çš„å½“å‰è¿æ¥é›†ã€‚\n13. eNewConn â† SELECT-NEIGHBORS(e, eConn, Mmax, lc)ï¼šä¸º e é€‰æ‹©ä¸€ç»„æ–°çš„é‚»å±…ï¼Œåªè€ƒè™‘ lc å±‚çš„å…ƒç´ ï¼Œä¿è¯è¿æ¥æ•°ä¸è¶…è¿‡ Mmaxã€‚\n14. set neighbourhood(e) at layer lc to eNewConnï¼šå°†å±‚lc çš„ e çš„è¿æ¥é›†æ›´æ–°ä¸ºæ–°çš„é›†åˆ eNewConnã€‚\n15. ep â† Wï¼šè®¾ç½® hnsw çš„è¿›å…¥ç‚¹ä¸º qã€‚\n16. if l > Lï¼Œå°† hnsw çš„èµ·å§‹ç‚¹è®¾ä¸º qï¼Œå› ä¸ºæ–°å…ƒç´  q ç°åœ¨æ˜¯å›¾çš„ä¸€éƒ¨åˆ†ã€‚\n17. è¿”å›æ›´æ–°åçš„å¤šå±‚å›¾ hnswã€‚\n\n### ç®—æ³•äºŒï¼šSEARCH-LAYER()\n\nè¯¥ç®—æ³•å¯¹ HNSW æ•°æ®ç»“æ„è¿›è¡Œ k è¿‘é‚»æœç´¢ï¼Œä»¥æŸ¥æ‰¾ç‰¹å®šå±‚ lc ä¸­ä¸æŸ¥è¯¢å…ƒç´  q æœ€è¿‘çš„ k ä¸ªå…ƒç´ ã€‚ç„¶åï¼Œæ ¹æ®æŸ¥è¯¢å…ƒç´  q ä¸å€™é€‰å…ƒç´  C å’Œ e ä¹‹é—´çš„è·ç¦»æ›´æ–°å€™é€‰å…ƒç´ é›†åˆ C å’Œæ‰¾åˆ°çš„æœ€è¿‘é‚»å±…åˆ—è¡¨ Wï¼Œæœ€åï¼Œå¦‚æœ W ä¸­çš„å…ƒç´ ä¸ªæ•°è¶…è¿‡åŠ¨æ€å€™é€‰åˆ—è¡¨ ef çš„å¤§å°ï¼Œåˆ™å‡½æ•°ç§»é™¤ä» W åˆ° q çš„æœ€è¿œå…ƒç´ ã€‚\n\n```py\nAlgorithm 2: SEARCH-LAYER()\n\nSEARCH-LAYER(q, ep, ef, lc)\nInput: query element q, enter points ep, number of nearest to q ele-\nments to return ef, layer number lc\nOutput: ef closest neighbors to q\n1 v â† ep // set of visited elements\n2 C â† ep // set of candidates\n3 W â† ep // dynamic list of found nearest neighbors\n4 while â”‚Câ”‚ > 0\n5 c â† extract nearest element from C to q\n6 f â† get furthest element from W to q\n7 if distance(c, q) > distance(f, q)\n8 break // all elements in W are evaluated\n9 for each e âˆˆ neighbourhood(c) at layer lc // update C and W\n10 if e âˆ‰ v\n11 v â† v â‹ƒ e\n12 f â† get furthest element from W to q\n13 if distance(e, q) < distance(f, q) or â”‚Wâ”‚ < ef\n14 C â† C â‹ƒ e\n15 W â† W â‹ƒ e\n16 if â”‚Wâ”‚ > ef\n17 remove furthest element from W to q\n18 return W\n```\n\nä»¥ä¸‹æ˜¯ä¸Šè¿°ä»£ç çš„æ­¥éª¤ï¼š\n\n01. åˆå§‹åŒ–å˜é‡ v ä¸ºå½“å‰çš„å…¥å£ç‚¹ epã€‚\n02. åˆå§‹åŒ–é›†åˆ C ä¸ºå½“å‰å€™é€‰é›†åˆã€‚\n03. åˆå§‹åŒ–ä¸€ä¸ªç©ºåˆ—è¡¨ W æ¥å­˜å‚¨æ‰¾åˆ°çš„æœ€è¿‘é‚»ã€‚\n04. å¾ªç¯ç›´åˆ°å€™é€‰é›†åˆ C ä¸­çš„æ‰€æœ‰å…ƒç´ éƒ½è¢«è®¡ç®—å®Œæ¯•ã€‚\n05. ä»å€™é€‰å…ƒç´ é›†åˆ C ä¸­æå–ç¦»æŸ¥è¯¢å…ƒç´  q æœ€æ¥è¿‘çš„å…ƒç´  cã€‚\n06. è·å–ä»æ‰¾åˆ°çš„æœ€è¿‘é‚» W åˆ°æŸ¥è¯¢å…ƒç´  q çš„åˆ—è¡¨ä¸­æœ€è¿œçš„å…ƒç´  fã€‚\n07. å¦‚æœ c åˆ° q çš„è·ç¦»å¤§äº f åˆ° q çš„è·ç¦»ï¼š\n08. ç„¶åæ‰“ç ´è¿™ä¸ªå¾ªç¯ã€‚\n09. å¯¹äº lc å±‚ c é‚»åŸŸå†…çš„æ¯ä¸ªå…ƒç´  eï¼š\n10. å¦‚æœ e ä¸åœ¨è®¿é—®å…ƒç´  v çš„é›†åˆä¸­ï¼Œåˆ™ï¼š\n11. å°† e æ·»åŠ åˆ°è®¿é—®å…ƒç´  v çš„é›†åˆä¸­ã€‚\n12. è®¾ f ä¸ºä» W åˆ° q çš„æœ€è¿œçš„å…ƒç´ ã€‚\n13. å¦‚æœ e å’Œ q ä¹‹é—´çš„è·ç¦»å°äºç­‰äº f å’Œ q ä¹‹é—´çš„è·ç¦»ï¼Œæˆ–è€… W ä¸­çš„å…ƒç´ ä¸ªæ•°å¤§äºç­‰äº efï¼ˆåŠ¨æ€å€™é€‰åˆ—è¡¨çš„å¤§å°ï¼‰ï¼Œåˆ™ï¼š\n14. å°†å€™é€‰é›† C æ›´æ–°ä¸º Câˆˆeã€‚\n15. å°†å‘ç°çš„æœ€è¿‘é‚»å±… W çš„åˆ—è¡¨æ›´æ–°ä¸º Wâˆˆeã€‚\n16. å¦‚æœWä¸­çš„å…ƒç´ ä¸ªæ•°å¤§äºç­‰äº efï¼Œåˆ™:\n17. ç§»é™¤ä» W åˆ° q çš„æœ€è¿œçš„å…ƒç´ ã€‚\n18. è¿”å›æ‰¾åˆ°çš„æœ€è¿‘é‚»å±… W çš„åˆ—è¡¨ã€‚\n\n### ç®—æ³•ä¸‰ï¼šSELECT-NEIGHBORS-SIMPLE()\n\nè¿™æ˜¯ä¸€ä¸ªç®€å•çš„è¿‘é‚»é€‰æ‹©ç®—æ³•ï¼Œå®ƒä»¥ä¸€ä¸ªåŸºæœ¬å…ƒç´  qã€ä¸€ç»„å€™é€‰å…ƒç´  c å’Œè‹¥å¹²è¿‘é‚» m ä½œä¸ºè¾“å…¥ã€‚å®ƒä»å€™é€‰å…ƒç´  c çš„é›†åˆä¸­è¿”å› m ä¸ªç¦» q æœ€è¿‘çš„å…ƒç´ ã€‚\n\n```py\nAlgorithm 3: SELECT-NEIGHBORS-SIMPLE()\n\nSELECT-NEIGHBORS-SIMPLE(q, C, M)\nInput: base element q, candidate elements C, number of neighbors to\nreturn M\nOutput: M nearest elements to q\nreturn M nearest elements from C to q\n```\n\næ­¥éª¤å¦‚ä¸‹ï¼š\n\n01. åˆå§‹åŒ–ä¸€ä¸ªç©ºé›† R æ¥å­˜å‚¨é€‰ä¸­çš„é‚»å±…ã€‚\n02. åˆå§‹åŒ–ä¸€ä¸ªå·¥ä½œé˜Ÿåˆ— W æ¥å­˜å‚¨å€™é€‰å…ƒç´ ã€‚\n03. å¦‚æœè®¾ç½®äº† extendCandidates æ ‡å¿—ï¼ˆå³trueï¼‰ï¼Œåˆ™é€šè¿‡å°† C ä¸­æ¯ä¸ªå…ƒç´ çš„é‚»å±…æ·»åŠ åˆ°é˜Ÿåˆ— W æ¥æ‰©å±•å€™é€‰åˆ—è¡¨ã€‚\n04. è€Œ W çš„å¤§å°å¤§äº 0ï¼ŒR çš„å¤§å°å°äº Mï¼š\n05. ä» W åˆ° q ä¸­æå–æœ€è¿‘çš„å…ƒç´  eã€‚\n06. å¦‚æœ e æ¯” R ä¸­çš„ä»»ä½•å…ƒç´ æ›´æ¥è¿‘ qï¼ŒæŠŠ e åŠ åˆ° R ä¸­ã€‚\n07. å¦åˆ™ï¼Œå°† e æ·»åŠ åˆ°ä¸¢å¼ƒé˜Ÿåˆ— Wd ä¸­ã€‚\n08. å¦‚æœè®¾ç½®äº† keepPrunedConnections æ ‡å¿—ï¼ˆå³trueï¼‰ï¼Œåˆ™ä» Wd æ·»åŠ ä¸€äº›ä¸¢å¼ƒçš„è¿æ¥åˆ°Rã€‚\n09. è¿”å› Rã€‚\n\n### ç®—æ³•å››ï¼šSELECT-NEIGHBORS-HEURISTIC()\n\nè¿™æ˜¯ä¸€ä¸ªæ›´å¤æ‚çš„è¿‘é‚»é€‰æ‹©ç®—æ³•ï¼Œå®ƒæ¥å—ä¸€ä¸ªåŸºæœ¬å…ƒç´  qã€ä¸€ç»„å€™é€‰å…ƒç´  cã€ä¸€äº›é‚»å±… mã€ä¸€ä¸ªå±‚æ•° lc å’Œä¸¤ä¸ªæ ‡å¿— extend candidates å’Œ keepPrunedConnections ä½œä¸ºè¾“å…¥ã€‚å®ƒè¿”å›å¯å‘å¼é€‰æ‹©çš„ m ä¸ªå…ƒç´ ã€‚\n\n```py\nAlgorithm 4: SELECT-NEIGHBORS-HEURISTIC()\n\nSELECT-NEIGHBORS-HEURISTIC(q, C, M, lc, extendCandidates, keep-\nPrunedConnections)\nInput: base element q, candidate elements C, number of neighbors to\nreturn M, layer number lc, flag indicating whether or not to extend\ncandidate list extendCandidates, flag indicating whether or not to add\ndiscarded elements keepPrunedConnections\nOutput: M elements selected by the heuristic\n1 R â† âˆ…\n2 W â† C // working queue for the candidates\n3 if extendCandidates // extend candidates by their neighbors\n4 for each e âˆˆ C\n5 for each eadj âˆˆ neighbourhood(e) at layer lc\n6 if eadj âˆ‰ W\n7 W â† W â‹ƒ eadj\n8 Wd â† âˆ… // queue for the discarded candidates\n9 while â”‚Wâ”‚ > 0 and â”‚Râ”‚< M\n10 e â† extract nearest element from W to q\n11 if e is closer to q compared to any element from R\n12 R â† R â‹ƒ e\n13 else\n14 Wd â† Wd â‹ƒ e\n15 if keepPrunedConnections // add some of the discarded\n// connections from Wd\n16 while â”‚Wdâ”‚> 0 and â”‚Râ”‚< M\n17 R â† R â‹ƒ extract nearest element from Wd to q\n18 return R\n```\n\næ­¥éª¤å¦‚ä¸‹ï¼š\n\n01. åˆå§‹åŒ–ä¸‰ä¸ªé˜Ÿåˆ—ï¼šR ç”¨äºé€‰æ‹©çš„é‚»å±…ï¼ŒW ç”¨äºå·¥ä½œçš„å€™é€‰ï¼ŒWd ç”¨äºä¸¢å¼ƒçš„å€™é€‰ã€‚\n02. è®¾ç½® R çš„å¤§å°ä¸º 0ï¼ŒW çš„å¤§å°ä¸º C çš„å¤§å°ã€‚\n03. å¦‚æœ extendCandidates è¢«è®¾ç½®ï¼ˆå³ï¼Œtrueï¼‰ï¼š\n04. å¯¹äº C ä¸­çš„æ¯ä¸ªå…ƒç´  eï¼š\n05. å¯¹äºç¬¬ lc å±‚ e çš„æ¯ä¸€ä¸ªé‚»å±… eadjï¼š\n06. å¦‚æœ eadj ä¸åœ¨ W ä¸­ï¼Œåˆ™åœ¨ W ä¸­æ·»åŠ å®ƒã€‚\n07. è€Œ W çš„å¤§å°å¤§äº 0ï¼ŒR çš„å¤§å°å°äº Mï¼š\n08. ä» W åˆ° q ä¸­æå–æœ€è¿‘çš„å…ƒç´  eã€‚\n09. å¦‚æœ e æ¯” R ä¸­çš„ä»»ä½•å…ƒç´ æ›´æ¥è¿‘ qï¼ŒæŠŠ e åŠ åˆ° R ä¸­ã€‚\n10. å¦åˆ™ï¼Œå°† e åŠ åˆ° Wdã€‚\n11. å¦‚æœè®¾ç½®äº† keepPrunedConnectionsï¼ˆå³trueï¼‰ï¼š\n12. è€Œ Wd çš„å¤§å°å¤§äº 0ï¼ŒR çš„å¤§å°å°äº Mï¼š\n13. ä» Wd åˆ° q ä¸­æå–æœ€è¿‘çš„å…ƒç´  eã€‚\n14. å¦‚æœ e æ¯” R ä¸­çš„ä»»ä½•å…ƒç´ æ›´æ¥è¿‘ qï¼Œå°±æŠŠ e åŠ åˆ° R ä¸­ã€‚\n15. è¿”å› Rã€‚\n\n### ç®—æ³•äº”ï¼šK-NN-SEARCH()\n\nè¿™ä¸ªæœç´¢ç®—æ³•ä¸ç®—æ³•1åŸºæœ¬ç›¸åŒã€‚\n\n```py\nAlgorithm 5: K-NN-SEARCH()\n\nK-NN-SEARCH(hnsw, q, K, ef)\nInput: multilayer graph hnsw, query element q, number of nearest\nneighbors to return K, size of the dynamic candidate list ef\nOutput: K nearest elements to q\n1 W â† âˆ… // set for the current nearest elements\n2 ep â† get enter point for hnsw\n3 L â† level of ep // top layer for hnsw\n4 for lc â† L â€¦ 1\n5 W â† SEARCH-LAYER(q, ep, ef=1, lc)\n6 ep â† get nearest element from W to q\n7 W â† SEARCH-LAYER(q, ep, ef, lc =0)\n8 return K nearest elements from W to q\n```\n\næ­¥éª¤å¦‚ä¸‹ï¼š\n\n01. åˆå§‹åŒ–ä¸€ä¸ªç©ºé›†åˆ Wï¼ˆå½“å‰æœ€è¿‘å…ƒç´ çš„é›†åˆï¼‰ï¼Œå¹¶å°†è¿›å…¥ç‚¹ ep è®¾ç½®ä¸ºç½‘ç»œçš„é¡¶å±‚ã€‚\n02. è®¾ç½®è¿›å…¥ç‚¹ ep çš„çº§åˆ«è®¾ç½®ä¸ºé¡¶å±‚ Lã€‚\n03. å¯¹äºæ¯ä¸€å±‚ lcï¼Œä» L åˆ° 1ï¼ˆå³ä»é¡¶å±‚åˆ°åº•å±‚ï¼‰:\n04. ä½¿ç”¨æŸ¥è¯¢å…ƒç´  q å’Œå½“å‰æœ€è¿‘çš„å…ƒç´  W æœç´¢å½“å‰å±‚ï¼Œå¹¶å°†æœ€è¿‘çš„å…ƒç´ æ·»åŠ åˆ° W ä¸­ã€‚\n05. å°†è¿›å…¥ç‚¹ ep è®¾ç½®ä¸º W åˆ° q æœ€è¿‘çš„å…ƒç´ ã€‚\n06. ä½¿ç”¨æŸ¥è¯¢å…ƒç´  q å’Œå½“å‰æœ€è¿‘çš„å…ƒç´  W æœç´¢ä¸‹ä¸€å±‚ï¼Œå¹¶å°†æœ€è¿‘çš„å…ƒç´ æ·»åŠ åˆ° W ä¸­ã€‚\n07. è¿”å› W ä¸­æœ€æ¥è¿‘çš„ K ä¸ªå…ƒç´ ä½œä¸ºè¾“å‡ºã€‚\n\n## å‚è€ƒæ–‡çŒ®\n\n- [1] Pugh, W. (1990). Skip lists: A probabilistic alternative to balanced trees. Communications of the ACM, 33(6), 668â€“676. doi:10.1145/78973.78977. S2CID 207691558.\n- [2] Xiang Zhang, Junbo Zhao, & Yann LeCun. (2015). Character-level Convolutional Networks for Text Classification\n- [3] Yu. A. Malkov, & D. A. Yashunin. (2018). Efficient and robust approximate nearest neighbor search using Hierarchical Navigable Small World graphs.\n- [4] Aristides Gionis, Piotr Indyk, Rajeev Motwani, et al. 1999. Similarity search in high dimensions via hashing. In Vldb, Vol. 99. 518â€“529.","tags":["å‘é‡æ•°æ®åº“"]},{"title":"linux_centos å®‰è£… cmake","url":"/2023/11/06/2023-11-06-cmakeå®‰è£…/","content":"\n## å¸è½½å·²å®‰è£…çš„ cmake\n\n```c\ncmake --version\n\n# è‹¥å·²å®‰è£…ç‰ˆæœ¬ä»¥æ»¡è¶³æˆ‘ä»¬éœ€æ±‚ï¼Œåˆ™ä¸éœ€è¦æ›´æ–°å®‰è£…\n# å¦‚æœå·²å®‰è£…ç‰ˆæœ¬ä¸ç¬¦åˆæˆ‘ä»¬éœ€æ±‚ï¼Œåˆ™ä¸‹å¸è½½æ—§ç‰ˆ\n\nyum remove -y cmake\n```\n\n## ä¸‹è½½ cmake\n\nå‰å¾€å®˜ç½‘ <a href=\"https://cmake.org/\">CMake</a> ä¸‹è½½æˆ‘ä»¬éœ€è¦çš„ç‰ˆæœ¬ï¼Œæˆ‘ä»¬ <a href=\"https://cmake.org/files/v3.26/\">ä¸‹è½½æœ€æ–°ç¨³å®šç‰ˆ3.26.4</a> å¹¶å®‰å…¨éªŒè¯ã€‚\n\n```c\ncurl -OL https://cmake.org/files/v3.26/cmake-3.26.4-SHA-256.txt\ncurl -OL https://cmake.org/files/v3.26/cmake-3.26.4.tar.gz\n\n-- å®‰å…¨éªŒè¯ï¼š\n[root@pudding cmake]# sha256sum -c cmake-3.26.4-SHA-256.txt\n# å…¶ä»–ç‰ˆæœ¬æœªæ‰¾åˆ°æ—¥å¿—å·²å¿½ç•¥\ncmake-3.26.4.tar.gz: OK\nsha256sum: WARNING: 16 listed files could not be read\n```\n\n## è§£å‹ï¼Œç¼–è¯‘å®‰è£…\n\n```c\ntar zxvf cmake-3.26.4.tar.gz && cd cmake-3.26.4\n\n./bootstrap && gmake && gmake install\n```\n\n### ç¼ºå°‘ c/c++ ç¼–è¯‘ç¯å¢ƒï¼š\n\n```c\n[root@pudding cmake-3.26.4]# ./bootstrap && gmake && gmake install\n---------------------------------------------\nCMake 3.26.4, Copyright 2000-2023 Kitware, Inc. and Contributors\n---------------------------------------------\nError when bootstrapping CMake:\nCannot find appropriate C compiler on this system.\nPlease specify one using environment variable CC.\nSee cmake_bootstrap.log for compilers attempted.\n\n---------------------------------------------\nLog of errors: /home/work/cmake-3.26.4/Bootstrap.cmk/cmake_bootstrap.log\n---------------------------------------------\n```\n\n**å®‰è£… gcc|g++**\n\n```c\nsudo yum -y install gcc gcc-c++ kernel-devel\n\ngcc --version\ng++ --version\n```\n\n## å»ºç«‹è½¯é“¾æ¥\n\n```c\n[root@pudding cmake-3.26.4]# /usr/local/bin/cmake --version\ncmake version 3.26.4\n\nCMake suite maintained and supported by Kitware (kitware.com/cmake).\n[root@pudding cmake-3.26.4]# ln -s /usr/local/bin/cmake /usr/bin\n[root@pudding cmake-3.26.4]# cmake --version\ncmake version 3.26.4\n\nCMake suite maintained and supported by Kitware (kitware.com/cmake).\n```","tags":["linux"]},{"title":"linux å®‰è£… python 3.10","url":"/2023/10/26/2023-10-26-linuxå®‰è£…python-3.10/","content":"\n## ç›¸å…³å·¥å…·å®‰è£…\n\n```shell\nyum -y groupinstall \"Development tools\"\nyum -y install zlib-devel bzip2-devel openssl-devel ncurses-devel sqlite-devel readline-devel tk-devel gdbm-devel db4-devel libpcap-devel xz-devel\nyum install libffi-devel -y\n```\n\n## openssl å®‰è£…\n\n```shell\ncd /home/\n\nwget http://www.openssl.org/source/openssl-1.1.1.tar.gz\n\ntar -zxvf openssl-1.1.1.tar.gz\n\ncd openssl-1.1.1/\n\nmkdir /usr/local/openssl\n\n./config --prefix=/usr/local/openssl --openssldir=/usr/local/openssl\n\nmake && make install\n```\n\n## python 3.10 å®‰è£…\n\n```shell\ncd /home\n\nwget https://www.python.org/ftp/python/3.10.8/Python-3.10.8.tgz\n\ntar -zxvf Python-3.10.8.tgz\n\ncd Python-3.10.8\n\nmkdir /usr/local/python310\n\n./configure --prefix=/usr/local/python310 --with-openssl=/usr/local/openssl --with-openssl-rpath=auto\n\nmake && make install\n```\n\n## è®¾ç½®è½¯é“¾æ¥\n\n```shell\nsudo ln -s /usr/local/python310/bin/python3.10 /usr/bin/python310\nsudo ln -s /usr/local/python310/bin/pip3.10 /usr/bin/pip310\n```\n\n## ä¸€äº› pip æº\n\n```josn\nhttps://pypi.tuna.tsinghua.edu.cn/simple\nhttps://pypi.mirrors.ustc.edu.cn/simple\nhttp://pypi.douban.com/simple/\nhttp://mirrors.aliyun.com/pypi/simple/\n```","tags":["python"]},{"title":"å‘é‡æ£€ç´¢ç®€ä»‹","url":"/2023/10/11/2023-10-11-å‘é‡æ£€ç´¢ç®€ä»‹/","content":"\n1. å‘é‡æ£€ç´¢åœ¨æ¨èç³»ç»Ÿï¼Œå›¾ç‰‡æ£€ç´¢ï¼Œè¯­ä¹‰æ£€ç´¢ä¸­å‡æœ‰â¼¤é‡åº”ç”¨\n2. å‘é‡æ£€ç´¢çš„æ ¸å¿ƒæ˜¯ ANNï¼ˆApproximate Nearset Neighborï¼‰é—®é¢˜\n3. æ—¨åœ¨å‘é‡ç©ºé—´ä¸­æ‰¾åˆ°ä¸æŸ¥è¯¢å‘é‡è¿‘ä¼¼æœ€è¿‘é‚»çš„å‘é‡\n\n## 1 ä½•ä¸ºç›¸ä¼¼\n\nè¯„ä¼°ä¸¤ä¸ªå‘é‡çš„ç›¸ä¼¼ç¨‹åº¦æœ‰å¤šç§æŒ‡æ ‡ï¼ˆMetricsï¼‰\n\n- æ¬§å¼è·ç¦»ï¼ˆEuclidean Distanceï¼‰\n- ä½™å¼¦ç›¸ä¼¼åº¦ï¼ˆCosine Similarityï¼‰\n- æ°å¡å¾·ç›¸ä¼¼åº¦ï¼ˆJaccard Similariyï¼‰\n\n### 1.1 æ¬§æ°è·ç¦»ï¼ˆEuclidean Distanceï¼‰\n\n**å³æ¬§æ°ç©ºé—´ä¸­ï¼Œä¸¤ä¸ªå‘é‡çš„è·ç¦»**\n\n$$\\sum_{i=1}^{n} (x_i - y_i)^2 = \\sqrt{(x_1 - y_1)^2 + (x_2 - y_2)^2 + \\ldots + (x_n - y_n)^2}$$\n\n### 1.2 ä½™å¼¦ç›¸ä¼¼åº¦ï¼ˆCosine Similarityï¼‰\n\n**ä¸¤ä¸ªå‘é‡é—´çš„è§’è·ç¦»**\n\n$$cos(Î¸)=\\frac{x \\cdot y}{||x|| \\cdot ||y||}$$\n\n### 1.3 æ°å¡å¾·ç›¸ä¼¼åº¦ï¼ˆJaccard Similariyï¼‰\n\n**ä¸¤ä¸ªå‘é‡äº¤é›†å å¹¶é›†çš„æ¯”ä¾‹**\n\n$$J(A,B)=\\frac{|Aâˆ©B|}{|AâˆªB|}$$\n\nä¸åŒçš„è¯„ä»·æŒ‡æ ‡ä»ä¸åŒçš„â¾“åº¦åˆ†ææ•°æ®\n\n## 2 å‘é‡ç´¢å¼•ç®—æ³•\n\næœ€ç›´æ¥çš„æ–¹æ³•æ˜¯æŸ¥è¯¢å‘é‡éå†å‘é‡ç©ºé—´ä¸­æ‰€æœ‰çš„å‘é‡è®¡ç®—è·ç¦»æš´åŠ›è§£ï¼Œç¼ºç‚¹æ˜¯è®¡ç®—å¤æ‚åº¦è¿‡é«˜ã€‚\n\n**ä¸ºäº†åŠ å¿«æŸ¥æ‰¾çš„é€Ÿåº¦ï¼Œå‡ ä¹æ‰€æœ‰çš„ ANN æ–¹æ³•éƒ½æ˜¯é€šè¿‡å¯¹å…¨ç©ºé—´åˆ†å‰²ï¼Œå°†å…¶åˆ†å‰²æˆå¾ˆå¤šâ¼©çš„å­ç©ºé—´ï¼Œåœ¨æœç´¢çš„æ—¶å€™ï¼Œé€šè¿‡æŸç§æ–¹å¼ï¼Œå¿«é€Ÿé”å®šåœ¨æŸâ¼€ï¼ˆå¤šï¼‰ä¸ªå­ç©ºé—´ï¼Œç„¶ååœ¨è¯¥ï¼ˆå¤šä¸ªï¼‰å­ç©ºé—´é‡Œåšéå†ã€‚**\n\nç›®å‰ä¸»æµæ–¹æ³•åˆ†ä¸ºå››å¤§ç±»ï¼š\n\n### 2.1 åŸºäºæ ‘çš„æ–¹æ³•\n\n**KD æ ‘**\n\nä¸‹é¢æ˜¯ KD æ ‘å¯¹å…¨ç©ºé—´çš„åˆ’åˆ†è¿‡ç¨‹ï¼Œä»¥åŠç”¨æ ‘è¿™ç§æ•°æ®ç»“æ„ï¼š\n\n![KDæ ‘çš„å­åˆ’åˆ†ï¼ˆå·¦ï¼‰å’Œæ ‘ç»“æ„ï¼ˆå³ï¼‰](/img/2023-10-11-å‘é‡æ£€ç´¢ç®€ä»‹/pho1.png)\n\nKD æ ‘é€‰æ‹©ä»å“ªä¸€ç»´åº¦è¿›è¡Œå¼€å§‹åˆ’åˆ†çš„æ ‡å‡†ï¼Œé‡‡ç”¨çš„ç­–ç•¥æ˜¯ï¼šæ±‚æ¯ä¸€ä¸ªç»´åº¦çš„æ–¹å·®ï¼Œç„¶åé€‰æ‹©æ–¹å·®æœ€å¤§çš„é‚£ä¸ªç»´åº¦å¼€å§‹åˆ’åˆ†ã€‚\n\n**ä¸ºä½•è¦é€‰æ‹©æ–¹å·®ä½œä¸ºç»´åº¦åˆ’åˆ†é€‰å–çš„æ ‡å‡†ï¼Ÿ**\n\n- å› ä¸ºæ–¹å·®çš„å¤§å°å¯ä»¥åæ˜ æ•°æ®çš„æ³¢åŠ¨æ€§ã€‚æ–¹å·®å¤§è¡¨ç¤ºæ•°æ®æ³¢åŠ¨æ€§è¶Šå¤§ï¼Œé€‰æ‹©æ–¹å·®æœ€å¤§ä½œä¸ºåˆ’åˆ†ç©ºé—´æ ‡å‡†çš„å¥½å¤„åœ¨äºï¼Œå¯ä»¥ä½¿å¾—æ‰€éœ€çš„åˆ’åˆ†é¢æ•°æ®æœ€å°ï¼Œåæ˜ åˆ°æ ‘æ•°æ®ç»“æ„ä¸Šï¼Œå¯ä»¥ä½¿å¾—æˆ‘ä»¬æ„å»ºçš„ KD æ ‘çš„æ ‘æ·±åº¦å°½å¯èƒ½çš„å°ã€‚\n\nä¸€èˆ¬è€Œè¨€ï¼Œåœ¨ç©ºé—´ç»´åº¦æ¯”è¾ƒä½çš„æ—¶å€™ï¼ŒKDæ ‘æ˜¯æ¯”è¾ƒé«˜æ•ˆçš„ï¼Œå½“ç©ºé—´ç»´åº¦è¾ƒé«˜æ—¶ï¼Œå¯ä»¥ç”¨å°é¢å³å°†ä»‹ç»çš„å“ˆå¸Œæ–¹æ³•æˆ–è€…çŸ¢é‡é‡åŒ–æ–¹æ³•ã€‚\n\n### 2.2 å“ˆå¸Œæ–¹æ³•\n\né€šè¿‡å“ˆå¸Œå‡½æ•°å°†è¿ç»­çš„å®å€¼æ•£åˆ—åŒ–ä¸º 0ã€1 çš„ç¦»æ•£å€¼ï¼Œå°†å‘é‡ä»¥ç›¸ä¼¼æ€§ä¸ºåº¦é‡æŒ‡æ ‡è¿›è¡Œåˆ†å‰²ï¼Œå°†å‘é‡å½’ç±»åˆ°ä¸åŒçš„æ¡¶ï¼ˆcellï¼‰ä¸­ã€‚\n\næŸ¥æ‰¾æ—¶ï¼ŒæŸ¥è¯¢å‘é‡é€šè¿‡å“ˆå¸Œå‡½æ•°åï¼Œä¹Ÿä¼šå½’ç±»åˆ°ç›¸ä¼¼å‘é‡çš„æ¡¶ä¸­ï¼Œä»¥ç¼©å°æ£€ç´¢èŒƒå›´ã€‚\n\nå·¥ç¨‹ä¸­çš„ç»å…¸æ–¹æ³•æ˜¯**å±€éƒ¨æ•æ„Ÿå“ˆå¸Œï¼ˆLocal Sensitive Hashing, LSHï¼‰**ï¼Œå³ç›¸è¿‘çš„æ ·æœ¬ç‚¹å¯¹æ¯”è¾ƒè¿œçš„æ ·æœ¬ç‚¹æ›´å®¹æ˜“å‘ç”Ÿç¢°æ’ã€‚\n\n![Local Sensitive Hashing](/img/2023-10-11-å‘é‡æ£€ç´¢ç®€ä»‹/pho2.png)\n\n**LSH ä¸­é‡è¦çš„å‚æ•°ï¼š**\n\n- Kï¼Œæ¯ä¸€ä¸ªå“ˆå¸Œè¡¨çš„å“ˆå¸Œå‡½æ•°ï¼ˆç©ºé—´åˆ’åˆ†ï¼‰æ•°ç›®\n- Lï¼Œå“ˆå¸Œè¡¨ï¼ˆæ¯ä¸€ä¸ªå“ˆå¸Œè¡¨æœ‰ K ä¸ªå“ˆå¸Œå‡½æ•°ï¼‰çš„æ•°ç›®\n- Tï¼Œè¿‘é‚»å“ˆå¸Œæ¡¶çš„æ•°ç›®ï¼Œå³ the number of probes\n\nä¸ºäº†å¢åŠ  LSH å¬å›ç‡ç²¾åº¦ï¼Œåœ¨æŸ¥è¯¢å‘é‡è½å…¥æ¡¶å‘¨å›´æ—¶ï¼Œå†é€‰å‡ ä¸ªè¿‘é‚»çš„æ¡¶ï¼Œä»¥å¢åŠ å¬å›ç‡ã€‚\n\né€šå¸¸ K T ä¹‹é—´è¦åšå–èˆï¼Œå“ˆå¸Œå‡½æ•°æ•°ç›® K è¶Šå¤§ï¼Œç›¸åº”åœ°ï¼Œè¿‘é‚»å“ˆå¸Œæ¡¶çš„æ•°ç›®çš„æ•°ç›® T ä¹Ÿåº”è¯¥è®¾ç½®çš„è¶Šå¤§ï¼Œåä¹‹ K è¶Šå°ï¼ŒL ä¹Ÿå¯ä»¥ç›¸åº”çš„å‡å°ã€‚\n\n### 2.3 çŸ¢é‡é‡åŒ–æ–¹æ³•\n\nä¹˜ç§¯é‡åŒ–ï¼ˆProduct Quantizationï¼ŒPQï¼‰æ˜¯ Herve Jegou åœ¨ 2011 å¹´æå‡ºçš„ä¸€ç§éå¸¸ç»å…¸å®ç”¨çš„çŸ¢é‡é‡åŒ–ç´¢å¼•çš„æ–¹æ³•ï¼Œåœ¨å·¥ä¸šç•Œå‘é‡ç´¢å¼•ä¸­å·²å¾—åˆ°å¹¿æ³›çš„åº”ç”¨ï¼Œå¹¶ä½œä¸ºä¸»è¦çš„å‘é‡ç´¢å¼•æ–¹æ³•ï¼Œåœ¨ Fasis ä¸­æœ‰éå¸¸é«˜æ•ˆçš„å®ç°ã€‚ä¹˜ç§¯é‡åŒ–çš„æ ¸å¿ƒæ€æƒ³æ˜¯åˆ†æ®µï¼ˆåˆ’åˆ†å­ç©ºé—´ï¼‰å’Œèšç±»ï¼Œæˆ–è€…è¯´å…·ä½“åº”ç”¨åˆ° ANN è¿‘ä¼¼æœ€è¿‘é‚»æœç´¢ä¸Šï¼ŒKMeans æ˜¯ PQ ä¹˜ç§¯é‡åŒ–å­ç©ºé—´æ•°ç›®ä¸º 1 çš„ç‰¹ä¾‹ã€‚PQ ä¹˜ç§¯é‡åŒ–ç”Ÿæˆç æœ¬å’Œé‡åŒ–çš„è¿‡ç¨‹å¯ä»¥ç”¨å¦‚ä¸‹å›¾ç¤ºæ¥è¯´æ˜ï¼š\n\n![PQ ä¹˜ç§¯é‡åŒ–ç”Ÿæˆç æœ¬å’Œé‡åŒ–çš„è¿‡ç¨‹](/img/2023-10-11-å‘é‡æ£€ç´¢ç®€ä»‹/pho3.png)\n\nåœ¨è®­ç»ƒé˜¶æ®µï¼Œé’ˆå¯¹ N ä¸ªè®­ç»ƒæ ·æœ¬ï¼Œå‡è®¾æ ·æœ¬ç»´åº¦æ˜¯ 128 ç»´ï¼Œæˆ‘ä»¬å°†å…¶åˆ’åˆ†ä¸º 4 ä¸ªå­ç©ºé—´ï¼Œåˆ™æ¯ä¸€ä¸ªå­ç©ºé—´çš„ç»´åº¦ä¸º 32 ç»´ï¼Œç„¶åæˆ‘ä»¬åœ¨æ¯ä¸€ä¸ªå­ç©ºé—´ä¸­ï¼Œå¯¹å­å‘é‡é‡‡ç”¨ K-Means å¯¹å…¶è¿›è¡Œèšç±»ï¼ˆå›¾ä¸­ç¤ºæ„èšç±»ä¸º 256 ç±»ï¼‰ï¼Œè¿™æ ·æ¯ä¸€ä¸ªå­ç©ºé—´éƒ½èƒ½å¾—åˆ°ä¸€ä¸ªç æœ¬ã€‚è¿™æ ·è®­ç»ƒæ ·æœ¬çš„æ¯ä¸ªå­æ®µï¼Œéƒ½å¯ä»¥ç”¨å­æ ·æœ¬ä»…ä½¿ç”¨çš„æœ€çŸ­çš„ä¸€ä¸ªç¼–ç å¾—ä»¥è¡¨ç¤ºï¼Œä»è€Œè¾¾åˆ°é‡åŒ–çš„ç›®çš„ã€‚å¯¹äºå¾…ç¼–ç çš„æ ·æœ¬ï¼Œå°†å®ƒè¿›è¡Œç›¸åŒçš„åˆ‡åˆ†ï¼Œç„¶ååœ¨æ¯ä¸ªå­ç©ºé—´é‡Œé€ä¸€æ‰¾åˆ°è·ç¦»å®ƒä»¬æœ€è¿‘çš„ç±»ä¸­å¿ƒï¼Œç„¶åç”¨ç±»ä¸­å¿ƒçš„ id æ¥è¡¨ç¤ºå®ƒä»¬ï¼Œå³å®Œæˆäº†å¾…ç¼–ç æ ·æœ¬çš„ç¼–ç ã€‚\n\næŸ¥è¯¢é˜¶æ®µæœ‰ä¸¤ç§è®¡ç®—è·ç¦»æ–¹å¼ï¼š\n\n1. å¯¹ç§°è·ç¦»ï¼Œç”¨äºæŸ¥è¯¢å‘é‡å¯¹åº”çš„ç±»ä¸­å¿ƒä»£è¡¨æŸ¥è¯¢å‘é‡çš„ä½ç½®ï¼Œå„ä¸ªç±»ä¸­å¿ƒä»£è¡¨å„ä¸ªç±»ä¸­æ‰€æœ‰ç‚¹çš„ä½ç½®ï¼Œè®¡ç®—ç±»ä¸­å¿ƒé—´çš„è·ç¦»ã€‚è¯¥æ–¹å¼è®¡ç®—å¿«ï¼Œä½†æŸå¤±ç²¾åº¦å¤§ã€‚\n2. éå¯¹ç§°è·ç¦»ï¼Œç”¨äºæŸ¥è¯¢å‘é‡æœ¬èº«ä½ç½®ï¼Œå„ä¸ªç±»ä¸­å¿ƒä»£è¡¨å„ä¸ªç±»ä¸­æ‰€æœ‰ç‚¹çš„ä½ç½®ï¼Œè®¡ç®—æŸ¥è¯¢å‘é‡åˆ°æ¯ä¸ªç±»ä¸­å¿ƒçš„ä½ç½®ã€‚è¯¥æ–¹å¼è®¡ç®—è¾ƒå¿«ï¼Œä¸”æŸå¤±ç²¾åº¦è¾ƒä½ã€‚\n\nåŒæ—¶å¯¹ç‰¹å¾è¿›è¡Œç¼–ç åï¼Œå¯ä»¥ç”¨ä¸€ä¸ªç›¸å¯¹æ¯”è¾ƒçŸ­çš„ç¼–ç æ¥è¡¨ç¤ºæ ·æœ¬ï¼Œå¯¹äºå†…å­˜çš„æ¶ˆè€—è¦æ˜¾è‘—å‡å°‘ã€‚\n\nå€’æ’ PQ ä¹˜ç§¯é‡åŒ–ï¼ˆIVFPQï¼‰æ˜¯ PQ ä¹˜ç§¯é‡åŒ–çš„è¿›ä¸€æ­¥åŠ é€Ÿç‰ˆã€‚\n\nå…¶ç®—æ³•æ€æƒ³æ˜¯ï¼Œåœ¨ PQ ä¹˜ç§¯é‡åŒ–ä¹‹å‰ï¼Œå¢åŠ äº†ä¸€ä¸ªç²—é‡åŒ–è¿‡ç¨‹ã€‚å…ˆå¯¹ N ä¸ªè®­ç»ƒæ ·æœ¬é‡‡ç”¨ KMeans è¿›è¡Œèšç±»ï¼Œè¿™é‡Œèšç±»çš„æ•°ç›®ä¸€èˆ¬ä¸è¶…è¿‡ 1024ã€‚åœ¨å¾—åˆ°äº†èšç±»ä¸­å¿ƒåï¼Œé’ˆå¯¹æ¯ä¸€ä¸ªæ ·æœ¬æŸ¥è¯¢å‘é‡ï¼Œåœ¨å¯¹åº”çš„èšç±»ä¸­å¿ƒå†è¿›è¡Œ PQã€‚\n\n**IVFPQ ä¸­çš„ä¸»è¦å‚æ•°ï¼š**\n- nProbeï¼šIVF ä¸­èšç±»ä¸­å¿ƒæ•°ï¼Œèšç±»ä¸­å¿ƒè¶Šå¤šï¼Œåˆ†ç±»è¶Šç²¾ç»†ï¼ŒæŸ¥è¯¢è¶Šæ…¢\n- Nï¼šå°†å‘é‡å¹³å‡åˆ†ä¸º N ä¸ªå­å‘é‡ï¼Œå­å‘é‡æ®µæ•°è¶Šå¤šï¼Œåˆ†ç±»è¶Šç²¾ç»†ï¼ŒæŸ¥è¯¢è¶Šæ…¢\n- Kï¼šå°†æ¯ä¸ªå­å‘é‡èšç±»ä¸º $2^K$ ä¸ªèšç±»ä¸­å¿ƒï¼Œèšç±»ä¸­å¿ƒè¶Šå¤šï¼Œåˆ†ç±»è¶Šç²¾ç»†ï¼ŒæŸ¥è¯¢è¶Šæ…¢\n\n### 2.4 åŸºäºå›¾ç´¢å¼•é‡åŒ–æ–¹æ³•\n\nHierarchical Navigable Small World Graphsï¼ˆHNSWï¼‰æ˜¯ Yury A. Malkov æå‡ºçš„ä¸€ç§åŸºäºå›¾ç´¢å¼•çš„æ–¹æ³•ï¼Œå®ƒæ˜¯ Yury A. Malkov åœ¨ä»–æœ¬äººä¹‹å‰å·¥ä½œ NSW ä¸Šçš„ä¸€ç§æ”¹è¿›ï¼Œé€šè¿‡é‡‡ç”¨åˆ†å±‚çŠ¶ç»“æ„ï¼Œå°†è¾¹æŒ‰ç‰¹å¾åŠå¾„è¿›è¡Œåˆ†å±‚ï¼Œæ˜¯æ¯ä¸ªé¡¶ç‚¹åœ¨æ‰€æœ‰å±‚ä¸­å¹³å‡åº¦æ•°è¾¹ä¸ºå¸¸æ•°ï¼Œä»è€Œå°† NSW çš„è®¡ç®—å¤æ‚åº¦ç”±å¤šé‡å¯¹æ•°ï¼ˆPloylogarithmicï¼‰å¤æ‚åº¦é™ä½åˆ°äº†å¯¹æ•°ï¼ˆlogarithmicï¼‰å¤æ‚åº¦ã€‚\n\n![Hierarchicalç»“æ„](/img/2023-10-11-å‘é‡æ£€ç´¢ç®€ä»‹/pho4.png)\n\næ¯ä¸€ä¸ªæ’å…¥çš„å…ƒç´ å¯¹åº”çš„æœ€å¤§ layer ç”±æŒ‡æ•°è¡°å‡æ¦‚ç‡åˆ†å¸ƒå‡½æ•°ç»™å‡º\n\n```c\nmult_ = 1/log(1.0 * M_);\nrevSize_ = 1.0/mult_;\nstd:uniform_real_distribution<double> distribution(0.0,1.0);\ndouble r = -log(distribution(level generator_)) * revSize_\n```\n\n- ä»æœ€å¤§å±‚ layer å¼€å§‹è´ªå¿ƒéå†ï¼Œå¯»æ‰¾å±€éƒ¨æœ€å°å€¼ï¼ˆæœ€è¿‘é‚»ï¼‰\n- å°†å½“å‰å±‚æ‰¾åˆ°çš„æœ€è¿‘é‚»ä½œä¸ºè¿›å…¥ç‚¹ï¼ˆentry pointï¼‰åœ¨ä¸‹ä¸€å±‚å¯»æ‰¾å±€éƒ¨æœ€å°ã€‚\n\nä»è‹¥å¹²è¾“å…¥ç‚¹ï¼ˆéšæœºæŠ½å–æˆ–åˆ†å‰²ç®—æ³•ï¼‰å¼€å§‹è¿­ä»£æ•´ä¸ªè¿‘é‚»å›¾ã€‚æ•´ä¸ªæœç´¢è¿‡ç¨‹å¯ä»¥ç±»æ¯”åœ¨åœ°å›¾ä¸ŠæŸä¸ªä½ç½®ç©ºé—´çš„è¿‡ç¨‹ï¼šæˆ‘ä»¬å¯ä»¥æŠŠåœ°çƒå½“ä½œæœ€é¡¶å±‚ï¼Œäº”å¤§æ´²ä½œä¸ºç¬¬ä¸€å±‚ï¼Œå›½å®¶ä½œä¸ºç¬¬ä¸‰å±‚ï¼Œçœä»½ä½œä¸ºç¬¬å››å±‚â€¦â€¦ï¼Œç°åœ¨å¦‚æœè¦æ‰¾æµ·æ·€äº”é“å£ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡é¡¶å±‚ä»¥é€æ­¥é€’å‡çš„ç‰¹å¾åŠå¾„å¯¹å…¶è¿›è¡Œè·¯ç”±ï¼ˆç¬¬ä¸€å±‚åœ°çƒ->ç¬¬äºŒå±‚äºšæ´²->ç¬¬ä¸‰å±‚ä¸­å›½->ç¬¬å››å±‚åŒ—äº¬->æµ·æ·€åŒºï¼‰ï¼Œåˆ°äº†ç¬¬ 0 å±‚åï¼Œå†åœ¨å±€éƒ¨åŒºåŸŸåšæ›´ç»†è‡´çš„æœç´¢ã€‚\n\n**HNSW ç´¢å¼•çš„ä¸»è¦å‚æ•°ï¼š**\n\n- Mï¼šæ¯ä¸ªå‘é‡åœ¨å›¾ä¸­çš„é‚»å±…æ•°ï¼ŒMè¶Šå¤§ï¼Œå›¾ä¸­æ¯ä¸ªé¡¶ç‚¹é‚»å±…è¶Šå¤šï¼Œå›¾è¶Šç²¾ç»†ï¼Œå»ºç´¢å¼•æ—¶é—´è¶Šé•¿ï¼ŒæŸ¥è¯¢æ—¶é—´è¶Šä¹…ï¼Œå¬å›ç‡è¶Šé«˜ï¼Œæ¨èèŒƒå›´ 5~100\n- ef_constructionï¼šæ„å»ºå›¾æ—¶ï¼Œæ¯ä¸ªé¡¶ç‚¹å€™é€‰çš„æœ€è¿‘é‚»å±…ï¼Œå€¼è¶Šå¤§ï¼Œå›¾è¶Šç²¾ç»†ï¼Œå»ºç´¢å¼•æ—¶é—´è¶Šé•¿ï¼ŒæŸ¥è¯¢è¶Šä¹…ï¼Œå¬å›ç‡è¶Šé«˜ï¼Œæ¨èèŒƒå›´ 100~2000\n- num_candidatesï¼šæŸ¥è¯¢æ—¶ï¼Œè¦è¿”å›çš„æ€»å€™é€‰æœ€è¿‘å‘é‡æ•°ï¼Œå€¼è¶Šå¤§ï¼Œå¬å›ç‡è¶Šå¤§ï¼ŒæŸ¥è¯¢æ—¶é—´è¶Šä¹…ï¼Œå€¼ä¸èƒ½è¶…è¿‡ 10000\n- ef_searchï¼šæœç´¢æ—¶ï¼Œæ¯ä¸ªé¡¶ç‚¹å€™é€‰çš„æœ€è¿‘é‚»å±…æ•°ï¼Œå€¼è¶Šå¤§ï¼ŒæŸ¥è¯¢æ—¶é—´è¶Šä¹…ï¼Œå¬å›ç‡è¶Šé«˜ï¼Œæ¨èèŒƒå›´ 100~2000\n\n## 3 Faiss å‘é‡æ£€ç´¢åº“\n\n### 3.1 åŸºç¡€ç´¢å¼•ç±»å‹\n\n|ç´¢å¼•ç±»å‹|ç´¢å¼•ç®€ä»‹|å…¨é‡æ£€ç´¢|å†…å­˜å ç”¨|å¬å›ç‡|æŸ¥è¯¢é€Ÿç‡|é€‚ç”¨åœºæ™¯|\n|:--:|:--:|:--:|:--:|:--:|:--:|:--:|\n|IndexFlatL2|è®¡ç®—L2è·ç¦»æš´åŠ›æœç´¢|æ˜¯|ä¸­ç­‰|å‡†ç¡®ç»“æœ|ä½|ç™¾ä¸‡æ•°æ®é‡|\n|IndexFlatIP|è®¡ç®—å†…ç§¯æš´åŠ›æœç´¢|æ˜¯|ä¸­ç­‰|å‡†ç¡®ç»“æœ|ä½|ç™¾ä¸‡æ•°æ®é‡|\n|IndexHNSWFlat|ä½¿ç”¨HNSWå›¾ç»“æ„åŠ é€Ÿæœç´¢|å¦|é«˜|é«˜|ä¸­|åƒä¸‡æ•°æ®é‡|\n|IndexIVFFlat|ä½¿â½¤èšç±»ç¼©â¼©æ£€ç´¢èŒƒå›´|å¦|ä¸­ç­‰|é«˜|ä¸­|åƒä¸‡æ•°æ®é‡|\n|IndexLSH|ä½¿ç”¨å“ˆå¸Œæ–¹æ³•å°†å‘é‡äºŒè¿›åˆ¶åŒ–åŠ é€Ÿæœç´¢|å¦|ä½|é«˜|ä¸­|åƒä¸‡æ•°æ®é‡|\n|IndexScalarQuantizer|ä½¿â½¤æ ‡é‡é‡åŒ–å°†å‘é‡é™ç»´åŠ é€Ÿæœç´¢|æ˜¯|ä¸­ç­‰|ä¸­ç­‰|ä¸­|åƒä¸‡æ•°æ®é‡|\n|IndexPQ|ä½¿â½¤ä¹˜ç§¯é‡åŒ–å°†å‘é‡é™ç»´åŠ é€Ÿæœç´¢|æ˜¯|ä½|ä¸­ç­‰|é«˜|åƒä¸‡æ•°æ®é‡|\n|IndexIVFScalarQuantizer|å…ˆä½¿ç”¨èšç±»åœ¨ä½¿ç”¨æ ‡é‡é‡åŒ–é™ç»´|æ˜¯|ä¸­ç­‰|ä¸­ç­‰|é«˜|åƒä¸‡æ•°æ®é‡|\n|IndexIVFPQ|å…ˆä½¿ç”¨èšç±»å†ä½¿ç”¨ä¹˜ç§¯é‡åŒ–é™ç»´|å¦|ä½|ä½|é«˜|äº¿çº§æ•°æ®é‡|\n|IndexIVFPQR|å…ˆä½¿ç”¨èšç±»å†ä½¿ç”¨ä¹˜ç§¯é‡åŒ–é™ç»´æœ€åé‡æ’åº|å¦|ä½|ä½|ä¸­|äº¿çº§æ•°æ®é‡|\n\n### 3.2 Faiss ç´¢å¼•é€‰å–\n\nå‘é‡æ£€ç´¢ä¸»è¦æ˜¯æ£€ç´¢é€Ÿåº¦å’Œå¬å›ç‡ä¹‹é—´çš„æƒè¡¡\n\nL2 è·ç¦»æš´åŠ›æœç´¢ä¸€å®šå¯ä»¥å¾—åˆ°ç²¾å‡†ç»“æœï¼Œä½†ç”±äºå…¨åº“éå†çš„ L2 è®¡ç®—ï¼Œé€Ÿåº¦è¿‡æ…¢ï¼Œä¸€èˆ¬ä½œä¸ºè¯„ä¼°å¬å›ç‡çš„åŸºå‡†\n\nç›®å‰çš„ä¸»æµç®—æ³•å‡ä»ä»¥ä¸‹æ–¹é¢æˆ–ç»“åˆä¼˜åŒ–æ£€ç´¢é€Ÿåº¦ï¼š\n- ç¼©å°æœç´¢èŒƒå›´ï¼ˆIVF|LAS|HNSWï¼‰\n- å‘é‡é™ç»´ä»¥å‡å°‘å†…å­˜ä½¿ç”¨ï¼ˆPQ|SQï¼‰\n\nä½†è¿™ä¹Ÿä¸å¯é¿å…åœ°åœ¨ä¸åŒç¨‹åº¦ä¸Šç‰ºç‰²äº†æ£€ç´¢ç²¾åº¦ï¼Œæ¯ç§ç®—æ³•çš„å‚æ•°ä¹Ÿå†³å®šäº†é€Ÿåº¦ä¸ç²¾åº¦é—´çš„å¹³è¡¡\n\n#### 3.2.1 éœ€è¦ç²¾ç¡®ç»“æœ\n\n- ä½¿ç”¨ IndexFlatL2 æˆ– IndexFlatIPï¼Œä¸éœ€è¦å‹ç¼©æ•°æ®æˆ–è®­ç»ƒï¼Œå¸¸ä½œä¸ºå…¶ä»–ç´¢å¼•æ£€ç´¢ç»“æœçš„åŸºå‡†\n- æ”¯æŒ GPU åŠ é€Ÿ\n\n#### 3.3.2 éœ€è¦è€ƒè™‘å†…å­˜é™åˆ¶\n\n**å†…å­˜å……è£•**\n\n- IndexHNSWFlat æ˜¯æœ€ä¼˜é€‰ï¼Œé€Ÿåº¦ä¸ç²¾åº¦ä¿±ä½³ï¼Œç„¶è€Œååˆ†æ¶ˆè€—å†…å­˜ï¼Œä¸è®­ç»ƒä¸”ä¸æ”¯æŒåˆ é™¤\n- æ”¯æŒ GPU åŠ é€Ÿ\n\n**éœ€è¦è€ƒè™‘**\n\n- å¯ä»¥å…ˆèšç±»ï¼Œå†ä½¿ç”¨ FlatL2 æˆ– FlatIP\n- æ”¯æŒ GPU åŠ é€Ÿ\n\n**å†…å­˜æœ‰é™**\n\n- ä½¿ç”¨ OPQ é™ä½å‘é‡ç»´åº¦\n- ä½¿ç”¨ PQ é‡åŒ–å‘é‡\n- æ”¯æŒ GOU åŠ é€Ÿï¼ˆOPQ é™ç»´åœ¨ CPU ä¸­è¿›è¡Œï¼Œä½†ä¸æ˜¯æ€§èƒ½ç“¶é¢ˆï¼‰\n\n#### 3.3.3 éœ€è¦è€ƒè™‘æ•°æ®é›†å¤§å°\n\n**ä½äº 1 ç™¾ä¸‡**\n\n- IVF ä½¿ç”¨ K-means èšç±»\n- æ”¯æŒ CPU åŠ é€Ÿ\n\n**1 ç™¾ä¸‡ - 1åƒä¸‡**\n\n- IVF ä½¿ç”¨ HNSW èšç±»ï¼Œéœ€è¦ 30 Ã— 65536 åˆ° 256 Ã— 65536 ä¸ªå‘é‡è®­ç»ƒ\n- ä¸æ”¯æŒ GPU åŠ é€Ÿ\n\n**1 åƒä¸‡ - 1 äº¿**\n\n- ä¾ç„¶ä½¿ç”¨ HNSW èšç±»ï¼Œéœ€è¦ 30 Ã— 262144 ($2^{18}$) åˆ° 256 Ã— 262144 ($2^{18}$) ä¸ªå‘é‡è®­ç»ƒ\n- åªåœ¨ GPU ä¸Šè®­ç»ƒï¼Œå…¶ä»–æ­¥éª¤åœ¨ CPU è¿›è¡Œï¼Œå‚è€ƒ <a href=\"https://gist.github.com/mdouze/46d6bbbaabca0b9778fca37ed2bcccf6\"> train_ivf_with_gpu.ipynb</a>\n- ä½¿ç”¨äºŒçº§èšç±»ï¼Œ<a href=\"https://gist.github.com/mdouze/1b2483d72c0b8984dd152cd81354b7b4\">demo_two_level_clustering.ipynb</a>\n\n**1 äº¿ - 10 äº¿**\n\nåŒä¸Š 65536 æ›¿æ¢æˆ 1048576 ($2^{20}$)\n\n## å‚è€ƒé“¾æ¥\n- <a href=\"https://towardsdatascience.com/9-distance-measures-in-data-science-918109d069fa\">Distance Measures in Data Science</a>\n- <a href=\"https://github.com/FALCONN-LIB/FALCONN/wiki/LSH-Primer\">Locality-Sensitive Hashing: a Primer</a>\n- <a href=\"https://inria.hal.science/inria-00514462/document\">Product Quantizer</a>\n- <a href=\"https://arxiv.org/abs/1603.09320\">Hierarchical Navigable Small World Graphs</a>\n- <a href=\"https://github.com/facebookresearch/faiss\">faiss</a>\n","tags":["å‘é‡æ•°æ®åº“"],"categories":["å‘é‡æ•°æ®åº“"]},{"title":"å‘é‡ç›¸ä¼¼æ€§è§£é‡Š","url":"/2023/10/09/2023-10-09-vector_similarity_explained/","content":"\nåœ¨è‡ªç„¶è¯­è¨€å¤„ç†å’Œè®¡ç®—æœºè§†è§‰ç­‰é¢†åŸŸï¼Œå‘é‡åµŒå…¥å·²è¢«è¯æ˜æ˜¯ä¸€ä¸ªé«˜æ ¡çš„å·¥å…·ã€‚æ¯”è¾ƒé¡¹é“¾åµŒå…¥å¹¶ç¡®å®šå®ƒä»¬çš„ç›¸ä¼¼æ€§æ˜¯è¯­ä¹‰æ£€ç´¢ã€æ¨èç³»ç»Ÿå’Œå¼‚å¸¸æ£€æµ‹ç­‰ç­‰çš„é‡è¦ç»„æˆéƒ¨åˆ†ã€‚\n\nåœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»¬å°†æ›´æ·±å…¥åœ°äº†è§£è¿™äº›ç›¸ä¼¼åº¦é‡æ˜¯å¦‚ä½•å·¥ä½œçš„ï¼Œä»¥ç›´è§‚åœ°äº†è§£åœ¨ç‰¹å®šç”¨ä¾‹çš„ä¸Šä¸‹æ–‡ä¸­ä¸¤ä¸ªå‘é‡åµŒå…¥ç›¸ä¼¼æ„å‘³ç€ä»€ä¹ˆã€‚ä¾‹å¦‚ï¼Œåœ¨è‡ªç„¶è¯­è¨€å¤„ç†ä¸­ï¼Œå¦‚æœè¡¨ç¤ºè¯ä¹‰çš„ä¸¤ä¸ªå‘é‡å¦‚æœåœ¨ç›¸ä¼¼çš„ä¸Šä¸‹æ–‡ä¸­ä½¿ç”¨æˆ–æœ‰ç€ç›¸ä¼¼çš„å«ä¹‰ï¼Œé‚£ä¹ˆå®ƒä»¬å¯èƒ½æ˜¯â€œæ¥è¿‘â€çš„ï¼›åœ¨æ¨èç³»ç»Ÿçš„èƒŒæ™¯ä¸‹ï¼Œå¦‚æœè¡¨ç¤ºç”¨æˆ·åå¥½çš„ä¸¤ä¸ªå‘é‡æœ‰å…±åŒçš„å…´è¶£æˆ–è€…ä¹‹å‰åšå‡ºäº†ç›¸åŒçš„é€‰æ‹©ï¼Œé‚£ä¹ˆå®ƒä»¬å¯èƒ½æ˜¯ç›¸ä¼¼çš„ã€‚\n\nåœ¨ä¸‹é¢çš„è¡¨æ ¼ä¸­ï¼Œæ‚¨å¯ä»¥çœ‹åˆ°æˆ‘ä»¬å°†åœ¨æœ¬æ–‡ä¸­è®¨è®ºçš„ç›¸ä¼¼æ€§åº¦é‡ï¼Œä»¥åŠå½±å“åº¦é‡çš„å‘é‡çš„å±æ€§ã€‚\n\n**Table 1: Similarity metrics**\n\n| Similarity Metric | Vector properties considered |\n|:---:|:---:|\n| Euclidean distance | Magnitudes and direction |\n| Cosine similarity | Only direction |\n| Dot product similarity | Magnitudes and direction |\n\n## Euclidean distance\n\næ¬§å‡ é‡Œå¾—è·ç¦»ï¼ˆEuclidean distanceï¼‰æ˜¯å¤šç»´ç©ºé—´ä¸­ä¸¤ä¸ªå‘é‡ä¹‹é—´çš„ç›´çº¿è·ç¦»ã€‚\n\n![å›¾1: äºŒç»´æ¬§å‡ é‡Œå¾—åº¦é‡æµ‹é‡](/img/2023-10-09-vector_similarity_explained/pho1.png)\n\nå®ƒè¢«è®¡ç®—ä¸ºå‘é‡ç›¸åº”åˆ†é‡ä¹‹é—´å·®å€¼å¹³æ–¹å’Œçš„å¹³æ–¹æ ¹ã€‚ä»¥ä¸‹æ˜¯è®¡ç®—ä¸¤ä¸ªå‘é‡ a å’Œ b ä¹‹é—´çš„æ¬§å‡ é‡Œå¾—è·ç¦»çš„æ–¹ç¨‹ï¼š\n\n$$ d(a,b) = \\sqrt{(a_1-b_1)^2+(a_2-b_2)^2+...+(a_n-b_n)^2} $$\n\nè¦è®¡ç®—ä¸¤ä¸ªå‘é‡ a å’Œ b ä¹‹é—´çš„æ¬§å‡ é‡Œå¾·è·ç¦»ï¼Œè¯¥æ–¹ç¨‹é¦–å…ˆè®¡ç®—ä¸¤ä¸ªå‘é‡çš„ç¬¬ä¸€ä¸ªåˆ†é‡ $(a_1-b_1)$ ä¹‹é—´çš„å·®ï¼Œç„¶åè®¡ç®—ç¬¬äºŒä¸ªåˆ†é‡ $(a_2-b_2)$ ä¹‹é—´çš„å·®ï¼Œä¾æ­¤ç±»æ¨ï¼Œç›´åˆ°å®ƒåˆ°è¾¾ç¬¬ n ä¸ªåˆ†é‡ $(a_n-b_n)$ã€‚ç„¶åå°†å·®å€¼å¹³æ–¹å¹¶ç›¸åŠ ï¼Œå¹¶å–æ€»å’Œçš„å¹³æ–¹æ ¹å¾—å‡ºæœ€ç»ˆè·ç¦»ã€‚\n\nè¯¥åº¦é‡å¯¹å‘é‡å¤§å°ä»¥åŠå‘é‡åœ¨ç©ºé—´ä¸­çš„ç›¸å¯¹ä½ç½®æ•æ„Ÿã€‚è¿™æ„å‘³ç€å…·æœ‰å¤§å€¼çš„å‘é‡å°†æ¯”å…·æœ‰å°å€¼çš„å‘é‡å…·æœ‰æ›´å¤§çš„æ¬§å‡ é‡Œå¾—è·ç¦»ï¼Œå³ä½¿è¿™äº›å‘é‡åœ¨å…¶ä»–æ–¹é¢ç›¸ä¼¼ã€‚è¿™å¯ä»¥æ­£å¼è¡¨è¾¾å¦‚ä¸‹ï¼š\n\n$$d(É‘x,É‘y)=É‘d(x,y)$$\n\næ¬§å‡ é‡Œå¾·è·ç¦»æ˜¯ä¸€ä¸ªéå¸¸ç›´è§‚çš„ç›¸ä¼¼æ€§åº¦é‡ï¼Œå› ä¸ºå®ƒåæ˜ äº†è¢«æ¯”è¾ƒçš„å‘é‡çš„æ¯ä¸ªå€¼ä¹‹é—´çš„è·ç¦»: å¦‚æœæ¬§å‡ é‡Œå¾·è·ç¦»éå¸¸å°ï¼Œåˆ™å‘é‡ä¸­æ¯ä¸ªåæ ‡çš„å€¼éå¸¸æ¥è¿‘ã€‚å¯¹äºç‚¹ç§¯æˆ–ä½™å¼¦æ¥è¯´ï¼Œé€šå¸¸æƒ…å†µå¹¶éå¦‚æ­¤ã€‚\n\nåœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œæ‚¨ä¸ä¼šç›´æ¥å°†å…¶ç”¨äºæ·±åº¦å­¦ä¹ æ¨¡å‹ï¼Œè€Œæ˜¯ä¸ä½¿ç”¨æ›´åŸºæœ¬çš„å‘é‡ç¼–ç æ–¹æ³•ï¼ˆä¾‹å¦‚LSHï¼ˆå±€éƒ¨æ•æ„Ÿå“ˆå¸Œï¼‰ï¼‰åˆ›å»ºçš„æ¨¡å‹ä¸€èµ·ä½¿ç”¨ã€‚æ¢å¥è¯è¯´ï¼Œå½“æ¨¡å‹æ²¡æœ‰ä½¿ç”¨ç‰¹å®šçš„æŸå¤±å‡½æ•°è¿›è¡Œè®­ç»ƒæ—¶ï¼Œæ¬§å‡ é‡Œå¾·è·ç¦»æ˜¯ä¸€ä¸ªè‡ªç„¶çš„é€‰æ‹©ã€‚\n\nç”±äºæ¬§å‡ é‡Œå¾—è·ç¦»å¯¹å¤§å°æ•æ„Ÿï¼Œå› æ­¤å½“åµŒå…¥åŒ…å«ä¸äº‹ç‰©çš„è®¡æ•°æˆ–æµ‹é‡æœ‰å…³çš„ä¿¡æ¯æ—¶ï¼Œå®ƒä¼šå¾ˆæœ‰å¸®åŠ©ã€‚ä¾‹å¦‚ï¼Œåœ¨ç›®æ ‡æ˜¯æ¨èä¸ç”¨æˆ·ä¹‹å‰è´­ä¹°çš„å•†å“ç›¸ä¼¼çš„æ¨èç³»ç»Ÿä¸­ï¼šæ¬§å‡ é‡Œå¾—è·ç¦»å¯ä»¥ç”¨æ¥è¡¡é‡å•†å“è´­ä¹°æ—¶é—´åµŒå…¥é‡ä¹‹é—´çš„ç»å¯¹å·®å¼‚ã€‚\n\n## Dot product Similarity\n\nä¸¤ä¸ªå‘é‡çš„ç‚¹ç§¯ç›¸ä¼¼åº¦ï¼ˆDot product Similarityï¼‰åº¦é‡æ˜¯é€šè¿‡å°†å‘é‡å¯¹åº”åˆ†é‡çš„ä¹˜ç§¯ç›¸åŠ æ¥è®¡ç®—çš„ã€‚å‘é‡ a å’Œ b çš„ç‚¹ç§¯è®¡ç®—å¦‚ä¸‹ï¼š\n\n$$ a \\cdot b = \\displaystyle \\sum^{n}_{i=1}{a_ib_i} = a_1b_1+a_2b_2+...+a_nb_n $$\n\nå…¶ä¸­ a å’Œ b æ˜¯è¦æ¯”è¾ƒçš„å‘é‡ï¼Œ$a_i$ å’Œ $b_i$ æ˜¯å‘é‡çš„åˆ†é‡ã€‚ç‚¹ç§¯æ˜¯é€šè¿‡å°†å‘é‡åˆ†é‡ç›¸ä¹˜å¹¶å°†ç»“æœç›¸åŠ æ¥è®¡ç®—çš„ã€‚\n\nå¦‚ä¸‹æ‰€ç¤ºï¼Œç‚¹ç§¯ä¹Ÿå¯ä»¥è¡¨ç¤ºä¸ºå‘é‡çš„å¤§å°ä¸å®ƒä»¬ä¹‹é—´çš„è§’åº¦çš„ä½™å¼¦çš„ä¹˜ç§¯ï¼š\n\n$$ a \\cdot b = |a||b|cosÉ‘ $$\n\n![å›¾2: äºŒç»´ç‚¹ç§¯æµ‹é‡](/img/2023-10-09-vector_similarity_explained/pho2.png)\n\nç‚¹ç§¯æ˜¯æ ‡é‡å€¼ï¼Œè¿™æ„å‘³ç€å®ƒæ˜¯å•ä¸ªæ•°å­—è€Œä¸æ˜¯å‘é‡ã€‚å¦‚æœå‘é‡ä¹‹é—´çš„è§’åº¦å°äº 90 åº¦ï¼Œåˆ™ç‚¹ç§¯ä¸ºæ­£ï¼›å¦‚æœå‘é‡ä¹‹é—´çš„è§’åº¦å¤§äº 90 åº¦ï¼Œåˆ™ç‚¹ç§¯ä¸ºè´Ÿï¼›å¦‚æœå‘é‡æ­£äº¤ï¼Œåˆ™ç‚¹ç§¯ä¸ºé›¶ã€‚\n\nç‚¹ç§¯ä¼šå—åˆ°å‘é‡é•¿åº¦å’Œæ–¹å‘çš„å½±å“ã€‚å½“ä¸¤ä¸ªå‘é‡é•¿åº¦ç›¸åŒä½†æ–¹å‘ä¸åŒæ—¶ï¼Œå¦‚æœä¸¤ä¸ªå‘é‡æŒ‡å‘ç›¸åŒæ–¹å‘ï¼Œåˆ™ç‚¹ç§¯è¾ƒå¤§ï¼›å¦‚æœä¸¤ä¸ªå‘é‡æŒ‡å‘ç›¸åæ–¹å‘ï¼Œåˆ™ç‚¹ç§¯è¾ƒå°ã€‚æƒ³è±¡ç”±ç®­å¤´è¡¨ç¤ºçš„ä¸¤ä¸ªå‘é‡ï¼Œå‘é‡ a å’Œå‘é‡ b ã€‚å¦‚æœå‘é‡ a å’Œ b å½¼æ­¤æŒ‡å‘ç›¸åŒæ–¹å‘ï¼Œåˆ™ a å’Œ b çš„ç‚¹ç§¯å°†å¤§äº a å’Œ b æŒ‡å‘ç›¸åæ–¹å‘æ—¶çš„ç‚¹ç§¯ã€‚\n\næ‚¨å¯èƒ½ä¼šé‡åˆ°è®¸å¤šä½¿ç”¨ç‚¹ç§¯è¿›è¡Œè®­ç»ƒçš„å¤§å‹è¯­è¨€æ¨¡å‹ (LLM)ã€‚\n\nåœ¨åŸºäºååŒè¿‡æ»¤å’ŒçŸ©é˜µåˆ†è§£çš„æ¨èç³»ç»Ÿä¸­ï¼Œæ¯ä¸ªç”¨æˆ·å’Œæ¯ä¸ªé¡¹ç›®ï¼ˆä¾‹å¦‚ç”µå½±ï¼‰éƒ½æœ‰ä¸€ä¸ªåµŒå…¥ï¼Œå¹¶ä¸”å­¦ä¹ æ¨¡å‹åˆ†æç”¨æˆ·åµŒå…¥å’Œé¡¹ç›®åµŒå…¥ä¹‹é—´çš„ç‚¹ç§¯æ¥é¢„æµ‹ç”¨æˆ·å¯¹è¿™ä¸ªé¡¹ç›®çš„è¯„åˆ†ã€‚ç°åœ¨ï¼Œå¦‚æœä¸¤ä¸ªäº§å“çš„åµŒå…¥æ–¹å‘ç›¸åŒä½†å¤§å°ä¸åŒï¼Œè¿™å¯èƒ½æ„å‘³ç€è¿™ä¸¤ä¸ªäº§å“æ˜¯å…³äºåŒä¸€ä¸»é¢˜çš„ï¼Œä½†å¹…åº¦è¾ƒå¤§çš„ä¸€ä¸ªäº§å“æ¯”å¦ä¸€ä¸ªäº§å“æ›´å¥½/æ›´å—æ¬¢è¿ã€‚\n\n## Cosine Similarity\n\nä½™å¼¦ç›¸ä¼¼åº¦ï¼ˆCosine Similarityï¼‰æ˜¯ä¸¤ä¸ªå‘é‡ä¹‹é—´è§’åº¦çš„åº¦é‡ã€‚å®ƒæ˜¯é€šè¿‡å‘é‡çš„ç‚¹ç§¯é™¤ä»¥å®ƒä»¬çš„å¤§å°çš„ä¹˜ç§¯æ¥è®¡ç®—çš„ã€‚è¯¥åº¦é‡ä¸å—å‘é‡å¤§å°çš„å½±å“ï¼Œè€Œä»…å—å‘é‡ä¹‹é—´çš„è§’åº¦çš„å½±å“ã€‚è¿™æ„å‘³ç€å…·æœ‰å¤§å€¼æˆ–å°å€¼çš„å‘é‡åªè¦æŒ‡å‘ç›¸åŒçš„æ–¹å‘ï¼Œå°±ä¼šå…·æœ‰ç›¸åŒçš„ä½™å¼¦ç›¸ä¼¼åº¦ã€‚ä»¥ä¸‹æ˜¯è®¡ç®—å‘é‡aå’Œbçš„ä½™å¼¦ç›¸ä¼¼åº¦çš„æ–¹æ³•ï¼š\n\n$$ sim(a,b)= \\frac{a \\cdot b}{||a|| \\cdot ||b||} $$\n\nå…¶ä¸­ a å’Œ b æ˜¯è¦æ¯”è¾ƒçš„å‘é‡ï¼Œâ€œâ€¢â€ä»£è¡¨ç‚¹ç§¯ï¼Œ||a|| å’Œ||b|| ä»£è¡¨å‘é‡çš„é•¿åº¦ã€‚ä½™å¼¦ç›¸ä¼¼åº¦ä»‹äº -1 å’Œ 1 ä¹‹é—´ï¼Œå…¶ä¸­ 1 è¡¨ç¤ºè§’åº¦ä¸º 0ï¼ˆå‘é‡å°½å¯èƒ½æ¥è¿‘ï¼‰ï¼Œ0 è¡¨ç¤ºæ­£äº¤ï¼Œ-1 è¡¨ç¤ºå‘é‡æŒ‡å‘ç›¸åæ–¹å‘ã€‚\n\n![å›¾ 3ï¼šäºŒç»´ä½™å¼¦ç›¸ä¼¼åº¦æµ‹é‡](/img/2023-10-09-vector_similarity_explained/pho3.png)\n\né¦–å…ˆï¼Œè¯¥æ–¹ç¨‹é€šè¿‡å°†å‘é‡çš„åˆ†é‡ç›¸ä¹˜å¹¶å°†ç»“æœç›¸åŠ æ¥è®¡ç®—å‘é‡çš„ç‚¹ç§¯ã€‚ç„¶åå°†ç‚¹ç§¯é™¤ä»¥å‘é‡å¹…å€¼çš„ä¹˜ç§¯ï¼Œå‘é‡å¹…å€¼çš„ä¹˜ç§¯æ˜¯é€šè¿‡å¯¹å‘é‡åˆ†é‡çš„å¹³æ–¹å’Œæ±‚å¹³æ–¹æ ¹æ¥è®¡ç®—çš„ã€‚\n\nå¦‚æœæ¨¡å‹æ˜¯ä½¿ç”¨ä½™å¼¦ç›¸ä¼¼åº¦è¿›è¡Œè®­ç»ƒçš„ï¼Œåˆ™æ‚¨å¯ä»¥ä½¿ç”¨ä½™å¼¦ç›¸ä¼¼åº¦æˆ–æ ‡å‡†åŒ–å¹¶ä½¿ç”¨ç‚¹ç§¯ã€‚è¯·æ³¨æ„ï¼Œå®ƒä»¬åœ¨æ•°å­¦ä¸Šæ˜¯ç­‰æ•ˆçš„ã€‚åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œå½’ä¸€åŒ–å’Œä½¿ç”¨ç‚¹ç§¯æ›´å¥½ï¼Œè€Œåœ¨æŸäº›æƒ…å†µä¸‹ï¼Œä½¿ç”¨ä½™å¼¦ç›¸ä¼¼åº¦æ›´å¥½ã€‚\n\nä½™å¼¦ç›¸ä¼¼åº¦çš„ä¸€ä¸ªç¤ºä¾‹ç”¨ä¾‹æ˜¯è§£å†³è¯­ä¹‰æœç´¢å’Œæ–‡æ¡£åˆ†ç±»é—®é¢˜ï¼Œå› ä¸ºå®ƒå…è®¸æ‚¨æ¯”è¾ƒå‘é‡çš„æ–¹å‘ï¼ˆå³æ–‡æ¡£çš„æ•´ä½“å†…å®¹ï¼‰ã€‚åŒæ ·ï¼Œæ—¨åœ¨æ ¹æ®ç”¨æˆ·è¿‡å»çš„è¡Œä¸ºå‘ç”¨æˆ·æ¨èé¡¹ç›®çš„æ¨èç³»ç»Ÿå¯ä»¥ä½¿ç”¨è¿™ç§ç›¸ä¼¼æ€§åº¦é‡ã€‚\n\nå½“æ‚¨çš„æ•°æ®ä¸­å‘é‡çš„å¤§å°å¾ˆé‡è¦å¹¶ä¸”åœ¨ç¡®å®šç›¸ä¼¼æ€§æ—¶åº”è€ƒè™‘åˆ°æ—¶ï¼Œä½™å¼¦ç›¸ä¼¼åº¦å¯èƒ½ä¸é€‚åˆã€‚ä¾‹å¦‚ï¼Œå®ƒä¸é€‚åˆæ ¹æ®åƒç´ å¼ºåº¦æ¯”è¾ƒå›¾åƒåµŒå…¥çš„ç›¸ä¼¼åº¦ã€‚\n\n## æ€»ç»“ \n\nåœ¨ä¸ºç´¢å¼•é€‰æ‹©ç›¸ä¼¼åº¦é‡æ—¶ï¼Œè¯·è®°ä½æˆ‘ä»¬åœ¨æœ¬æ–‡ä»‹ç»ä¸­æåˆ°çš„ä¸€èˆ¬åŸåˆ™: ä½¿ç”¨ç”¨äºè®­ç»ƒåµŒå…¥æ¨¡å‹çš„ç›¸ä¼¼åº¦é‡ã€‚å¦åˆ™ï¼Œæ‚¨åº”è¯¥å°è¯•å„ç§å…¶ä»–çš„ç›¸ä¼¼æ€§åº¦é‡ï¼Œçœ‹çœ‹æ˜¯å¦å¯ä»¥äº§ç”Ÿæ›´å¥½çš„ç»“æœï¼ˆä¾‹å¦‚ï¼Œå¦‚æœæ‚¨ä¸çŸ¥é“åµŒå…¥æ¨¡å¼ä¸­ä½¿ç”¨äº†ä»€ä¹ˆç›¸ä¼¼æ€§åº¦é‡ï¼Œæˆ–è€…åˆ›å»ºå‘é‡çš„æ–¹æ³•åœ¨ç”Ÿæˆè¿‡ç¨‹ä¸­æ²¡æœ‰è¿™æ ·çš„åº¦é‡ï¼‰ã€‚\n\n## å‚è€ƒé“¾æ¥\n- <a href=\"https://www.pinecone.io/learn/vector-similarity/\">Vector Similarity Explained</a>\n","tags":["å‘é‡æ•°æ®åº“"]},{"title":"ä»€ä¹ˆæ˜¯å‘é‡åµŒå…¥","url":"/2023/09/22/2023-09-22-vector_embeddings/","content":"\n## ç®€ä»‹\n\nå‘é‡åµŒå…¥æ˜¯æœºå™¨å­¦ä¹ ä¸­æœ€æœ‰è¶£ã€æœ€æœ‰ç”¨çš„æ¦‚å¿µä¹‹ä¸€ã€‚å®ƒä»¬æ˜¯è®¸å¤š NLPã€æ¨èå’Œæœç´¢ç®—æ³•çš„æ ¸å¿ƒã€‚å¦‚æœä½ æ›¾ç»ä½¿ç”¨è¿‡æ¨èç®—æ³•ã€è¯­éŸ³åŠ©æ‰‹ã€è¯­éŸ³ç¿»è¯‘å™¨ç­‰å·¥å…·ï¼Œé‚£ä¹ˆä½ å¯èƒ½å°±å·²ç»é‡åˆ°è¿‡ä¾èµ–åµŒå…¥çš„ç³»ç»Ÿã€‚\n\nå’Œå¤§å¤šæ•°è½¯ä»¶ç®—æ³•ä¸€æ ·ï¼Œæœºå™¨å­¦ä¹ ç®—æ³•ä¹Ÿéœ€è¦æ•°æ®é›†ã€‚æœ‰æ—¶ï¼Œæˆ‘ä»¬çš„æ•°æ®é›†åŒ…å«æ•°å€¼åˆ—æˆ–å¯ä»¥è½¬æ¢ä¸ºæ•°å€¼çš„å€¼ï¼ˆåºæ•°ã€åˆ†ç±»ç­‰ï¼‰ã€‚å…¶ä»–æ—¶å€™ï¼Œæˆ‘ä»¬ä¼šé‡åˆ°ä¸€äº›æ›´æŠ½è±¡çš„ä¸œè¥¿ï¼Œæ¯”å¦‚æ•´ä¸ªæ–‡æœ¬æ–‡æ¡£ã€‚æˆ‘ä»¬å¯ä»¥åˆ›å»ºå‘é‡åµŒå…¥ï¼Œå°†æŠ½è±¡çš„æ•°æ®é›†è½¬æ¢ä¸ºæ•°å­—åˆ—è¡¨ï¼Œä¾¿äºåç»­æ“ä½œã€‚æ•´æ®µæ–‡æœ¬æˆ–å…¶ä»–ä»»ä½•å¯¹è±¡éƒ½å¯ä»¥ç®€åŒ–ä¸ºä¸€ä¸ªå‘é‡ã€‚\n\n![å‘é‡åµŒå…¥æ¨¡å‹](/img/2023-09-22-vector_embeddings/pho1.png)\n\nä½†å‘é‡æœ‰ä¸€äº›ç‰¹æ®Šä¹‹å¤„ï¼Œä½¿å¾—å®ƒä»¬å¦‚æ­¤æœ‰ç”¨ã€‚è¿™ç§è¡¨ç¤ºä½¿å¾—äººç±»æ„ŸçŸ¥çš„è¯­ä¹‰ç›¸ä¼¼æ€§è½¬åŒ–ä¸ºå‘é‡ç©ºé—´çš„é‚»è¿‘æ€§æˆä¸ºå¯èƒ½ã€‚\n\næ¢å¥è¯è¯´ï¼Œå½“æˆ‘ä»¬å°†ç°å®ä¸–ç•Œçš„å¯¹è±¡å’Œæ¦‚å¿µï¼ˆä¾‹å¦‚å›¾åƒã€å½•éŸ³ã€æ–°é—»æ–‡ç« ã€ç”¨æˆ·èµ„æ–™ã€å¤©æ°”é¢„æŠ¥å’Œæ”¿æ²»è§‚ç‚¹ï¼‰è¡¨ç¤ºä¸ºå‘é‡åµŒå…¥æ—¶ï¼Œè¿™äº›å¯¹è±¡å’Œæ¦‚å¿µçš„è¯­ä¹‰ç›¸ä¼¼æ€§å¯ä»¥é€šè¿‡å®ƒä»¬ä½œä¸ºå‘é‡ç©ºé—´ä¸­çš„ç‚¹å½¼æ­¤ä¹‹é—´çš„è·ç¦»æ¥é‡åŒ–ã€‚å› æ­¤ï¼Œå‘é‡åµŒå…¥è¡¨ç¤ºé€‚ç”¨äºå¸¸è§çš„æœºå™¨å­¦ä¹ ä»»åŠ¡ï¼Œä¾‹å¦‚èšç±»ã€æ¨èå’Œåˆ†ç±»ã€‚\n\n![Source: DeepAI](/img/2023-09-22-vector_embeddings/pho2.png)\n\nä¾‹å¦‚ï¼Œåœ¨èšç±»ä»»åŠ¡ä¸­ï¼Œèšç±»ç®—æ³•å°†ç›¸ä¼¼çš„ç‚¹åˆ†é…åˆ°åŒä¸€èšç±»ï¼ŒåŒæ—¶ä¿æŒä¸åŒèšç±»çš„ç‚¹å°½å¯èƒ½ä¸ç›¸ä¼¼ã€‚åœ¨æ¨èä»»åŠ¡ä¸­ï¼Œå½“å¯¹æœªè§è¿‡çš„å¯¹è±¡è¿›è¡Œæ¨èæ—¶ï¼Œæ¨èç³»ç»Ÿä¼šå¯»æ‰¾ä¸è¯¥å¯¹è±¡æœ€ç›¸ä¼¼çš„å¯¹è±¡ï¼Œé€šè¿‡å®ƒä»¬ä¸å‘é‡åµŒå…¥çš„ç›¸ä¼¼åº¦æ¥è¡¡é‡ã€‚åœ¨åˆ†ç±»ä»»åŠ¡ä¸­ï¼Œæˆ‘ä»¬é€šè¿‡å¯¹æœ€ç›¸ä¼¼å¯¹è±¡çš„æ ‡ç­¾è¿›è¡Œä¸»è¦æŠ•ç¥¨æ¥å¯¹æœªè§è¿‡çš„å¯¹è±¡çš„æ ‡ç­¾è¿›è¡Œåˆ†ç±»ã€‚\n\n## åˆ›å»ºå‘é‡åµŒå…¥\n\nåˆ›å»ºå‘é‡åµŒå…¥çš„ä¸€å¼ æ–¹æ³•æ˜¯ä½¿ç”¨é¢†åŸŸçŸ¥è¯†æ¥è®¾è®¡å‘é‡å€¼ã€‚è¿™å°±æ˜¯æ‰€è°“çš„ç‰¹å¾å·¥ç¨‹ã€‚ä¾‹å¦‚ï¼Œåœ¨åŒ»å­¦æˆåƒä¸­ï¼Œæˆ‘ä»¬åˆ©ç”¨åŒ»å­¦ä¸“ä¸šçŸ¥è¯†æ¥é‡åŒ–ä¸€ç»„ç‰¹å¾ï¼Œä¾‹å¦‚å›¾åƒä¸­æ•æ‰è¯­ä¹‰çš„å½¢çŠ¶ã€é¢œè‰²å’ŒåŒºåŸŸã€‚ç„¶è€Œï¼Œå·¥ç¨‹å‘é‡åµŒå…¥éœ€è¦é¢†åŸŸçŸ¥è¯†ï¼Œä½†æ˜¯æ‰©å±•æˆæœ¬å¤ªé«˜ã€‚\n\næˆ‘ä»¬é€šå¸¸è®­ç»ƒæ¨¡å‹å°†å¯¹è±¡è½¬åŒ–ä¸ºå‘é‡ï¼Œè€Œä¸æ˜¯è®¾è®¡å‘é‡åµŒå…¥ã€‚æ·±åº¦ç¥ç»ç½‘ç»œæ˜¯è®­ç»ƒæ­¤ç±»æ¨¡å‹çš„å¸¸è§å·¥å…·ã€‚ç”±æ­¤äº§ç”Ÿçš„åµŒå…¥é€šå¸¸æ˜¯é«˜çº¬åº¦çš„ï¼ˆé«˜è¾¾ä¸¤åƒç»´ï¼‰å’Œå¯†é›†çš„ï¼ˆæ‰€æœ‰å€¼éƒ½ä¸ä¸ºé›¶ï¼‰ã€‚å¯¹äºæ–‡æœ¬æ•°æ®æ¥è¯´ï¼ŒWord2Vecã€GLoVE å’Œ BERT ç­‰æ¨¡å‹å°†å•è¯ã€å¥å­æˆ–æ®µè½è½¬æ¢ä¸ºå‘é‡åµŒå…¥ã€‚\n\nå¯ä»¥ä½¿ç”¨å·ç§¯ç¥ç»ç½‘ç»œï¼ˆCNNï¼‰ç­‰æ¨¡å‹åµŒå…¥å›¾åƒï¼ŒCNN çš„ç¤ºä¾‹åŒ…æ‹¬ VGG å’Œ Inceptionã€‚å¯ä»¥ä½¿ç”¨éŸ³é¢‘è§†è§‰è¡¨ç¤ºä¸Šçš„å›¾åƒåµŒå…¥å˜æ¢å°†éŸ³é¢‘è®°å½•è½¬æ¢ä¸ºå‘é‡ï¼ˆä¾‹å¦‚ï¼Œä½¿ç”¨å…¶é¢‘è°±å›¾ï¼‰ã€‚\n\n## ä¾‹å¦‚: ç”¨å·ç§¯ç¥ç»ç½‘ç»œåµŒå…¥å›¾åƒ\n\næ€è€ƒä»¥ä¸‹ç¤ºä¾‹ï¼Œå…¶ä¸­åŸå§‹å›¾åƒè¡¨ç¤ºä¸ºç°åº¦åƒç´ ã€‚è¿™ç›¸å½“äº 0 åˆ° 255 èŒƒå›´å†…çš„æ•´æ•°å€¼çš„çŸ©é˜µï¼ˆæˆ–è¡¨ï¼‰ã€‚å…¶ä¸­ 0 å¯¹åº”é»‘è‰²ï¼Œ255 å¯¹åº”ç™½è‰²ã€‚ä¸‹å›¾æç»˜äº†ç°åº¦å›¾åƒåŠå…¶å¯¹åº”çš„çŸ©é˜µã€‚\n\n![Source: Serena Young](/img/2023-09-22-vector_embeddings/pho3.png)\n\nå·¦ä¾§å­å›¾åƒæç»˜ç°åº¦åƒç´ ï¼Œä¸­é—´å­å›¾åƒåŒ…æ‹¬åƒç´ ç°åº¦å€¼ï¼Œæœ€å³ä¾§å­å›¾åƒå®šä¹‰çŸ©é˜µã€‚è¯·æ³¨æ„ï¼ŒçŸ©é˜µå€¼å®šä¹‰äº†ä¸€ä¸ªå‘é‡åµŒå…¥ï¼Œå…¶ä¸­å®ƒçš„ç¬¬ä¸€ä¸ªå·¦è¾¹æ˜¯çŸ©é˜µå·¦ä¸Šè§’çš„å•å…ƒæ ¼ï¼Œç„¶åä»å·¦åˆ°å³ç›´åˆ°å¯¹åº”äºå³ä¸‹è§’çŸ©é˜µå•å…ƒæ ¼çš„æœ€åä¸€ä¸ªåæ ‡ã€‚\n\nè¿™ç§åµŒå…¥æŠ€æœ¯èƒ½æ›´å¥½åœ°ç»´æŠ¤å›¾åƒä¸­åƒç´ é¢†åŸŸåœ°è¯­ä¹‰ä¿¡æ¯ã€‚ç„¶è€Œï¼Œå®ƒä»¬å¯¹è¯¸å¦‚ç§»ä½ã€ç¼©æ”¾ã€è£å‰ªå’Œå…¶ä»–å›¾åƒå¤„ç†æ“ä½œä¹‹ç±»åœ°è½¬æ¢éå¸¸æ•æ„Ÿã€‚å› æ­¤ï¼Œå®ƒä»¬é€šå¸¸ä½œä¸ºåŸå§‹è¾“å…¥ï¼Œä»¥å­¦ä¹ æ›´å¥å£®åœ°åµŒå…¥ã€‚\n\nå·ç§¯ç¥ç»ç½‘ç»œï¼ˆCNNï¼‰æ˜¯ä¸€ç±»æ·±åº¦å­¦ä¹ æ¡†æ¶ï¼Œé€šå¸¸åº”ç”¨äºå°†å›¾åƒè½¬æ¢ä¸ºåµŒå…¥çš„è§†è§‰æ•°æ®ã€‚\n\nCNN é€šè¿‡åˆ†å±‚çš„å°å‹å±€éƒ¨å­è¾“å…¥ï¼ˆç§°ä¸ºæ„Ÿå—é‡ï¼‰æ¥å¤„ç†è¾“å…¥ã€‚æ¯ä¸ªç½‘ç»œå±‚ä¸­çš„æ¯ä¸ªç¥ç»å…ƒå¤„ç†æ¥è‡ªå‰ä¸€å±‚çš„ç‰¹å®šæ„Ÿå—é‡ã€‚æ¯å±‚è¦ä¹ˆåœ¨æ„Ÿå—é‡ä¸Šåº”ç”¨å·ç§¯ï¼Œè¦ä¹ˆå‡å°è¾“å…¥å¤§å°ï¼Œè¿™ç§°ä¸ºå­é‡‡æ ·ã€‚\n\nä¸‹å›¾æç»˜äº†ä¸€ä¸ªå…¸å‹çš„ CNN ç»“æ„ã€‚æ³¨æ„æ„Ÿå—é‡ï¼Œåœ¨æ¯ä¸€å±‚è¢«æç»˜æˆå­æ–¹å—ï¼Œä½œä¸ºå‰ä¸€å±‚ä¸­å•ä¸ªç¥ç»å…ƒçš„è¾“å…¥ã€‚è¿˜è¦æ³¨æ„ï¼Œå­é‡‡æ ·æ“ä½œä¼šå‡å°å±‚å¤§å°ï¼Œè€Œå·ç§¯æ“ä½œä¼šæ‰©å±•å±‚å¤§å°ã€‚ç”Ÿæˆçš„å‘é‡åµŒå…¥é€šè¿‡å…¨è¿æ¥å±‚æ¥æ”¶ã€‚\n\n![Source: Aphex34ï¼ŒCC BY-SA 4.0](/img/2023-09-22-vector_embeddings/pho4.png)\n\nå­¦ä¹ ç½‘ç»œæƒé‡ï¼ˆå³åµŒå…¥æ¨¡å‹ï¼‰éœ€è¦å¤§é‡æ ‡è®°å›¾åƒã€‚æƒé‡çš„ä¼˜åŒ–æ–¹å¼æ˜¯ï¼Œä¸å…·æœ‰ä¸åŒæ ‡ç­¾çš„å›¾åƒç›¸æ¯”ï¼Œå…·æœ‰ç›¸åŒæ ‡ç­¾çš„å›¾åƒåµŒå…¥å¾—æ›´è¿‘ã€‚ä¸€æ—¦æˆ‘ä»¬å­¦ä¹ äº† CNN åµŒå…¥æ¨¡å‹ï¼Œæˆ‘ä»¬å°±å¯ä»¥å°†å›¾åƒè½¬æ¢ä¸ºå‘é‡ï¼Œå¹¶ä½¿ç”¨ K æœ€è¿‘é‚»ç´¢å¼•æ¥å‚¨å­˜å®ƒä»¬ã€‚ç°åœ¨ï¼Œç»™å®šä¸€ä¸ªæ–°çš„æœªè§è¿‡çš„å›¾åƒï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ CNN æ¨¡å‹å¯¹å…¶è¿›è¡Œè½¬æ¢ï¼Œæ£€ç´¢å…¶ K ä¸ªæœ€ç›¸ä¼¼çš„å‘é‡ï¼Œä»è€Œå¾—åˆ°ç›¸åº”çš„ç›¸ä¼¼å›¾åƒã€‚\n\nå°½ç®¡æœ¬æ–‡ä½¿ç”¨å›¾åƒå’Œ CNN ä½œä¸ºç¤ºä¾‹ï¼Œä½†æˆ‘ä»¬å¯ä»¥ä¸ºä»»ä½•ç±»å‹çš„æ•°æ®åˆ›å»ºå‘é‡åµŒå…¥ï¼Œå¹¶ä¸”å¯ä»¥ä½¿ç”¨å¤šç§æ¨¡å‹/æ–¹æ³•æ¥åˆ›å»ºå®ƒä»¬ã€‚\n\n## ä½¿ç”¨å‘é‡åµŒå…¥\n\nåµŒå…¥å¯ä»¥å°†å¯¹è±¡è¡¨ç¤ºä¸ºä¸€ä¸ªåŒ…å«å…¶è¯­ä¹‰ä¿¡æ¯çš„å¯†é›†å‘é‡ï¼Œè¿™ä¸€äº‹å®ä½¿å¾—åµŒå…¥åœ¨æœºå™¨å­¦ä¹ åº”ç”¨ä¸­éå¸¸æœ‰ç”¨ã€‚\n\nç›¸ä¼¼æ€§æœç´¢æ˜¯å‘é‡åµŒå…¥æœ€å¸¸è§çš„ç”¨é€”ä¹‹ä¸€ã€‚KNN å’Œ ANN ç­‰æœç´¢ç®—æ³•è¦æ±‚æˆ‘ä»¬è®¡ç®—å‘é‡ä¹‹é—´çš„è·ç¦»ä»¥ç¡®å®šç›¸ä¼¼åº¦ã€‚å‘é‡åµŒå…¥å¯ç”¨äºè®¡ç®—è¿™äº›è·ç¦»ã€‚æœ€è¿‘é‚»æœç´¢åˆå¯ç”¨äºè¯¸å¦‚å»å¤åˆ¶ã€æ¨èã€å¼‚å¸¸æ£€æµ‹ã€åå‘å›¾åƒæœç´¢ç­‰ä»»åŠ¡ã€‚\n\nå³ä½¿æˆ‘ä»¬ä¸ç›´æ¥åœ¨åº”ç”¨ç¨‹åºä¸­ä½¿ç”¨åµŒå…¥ï¼Œè®¸å¤šæµè¡Œçš„ ML æ¨¡å‹å’Œæ–¹æ³•ä¹Ÿåœ¨å†…éƒ¨ä¾èµ–å®ƒä»¬ã€‚ä¾‹å¦‚ï¼Œåœ¨ç¼–ç å™¨-è§£ç å™¨æ¶æ„ä¸­ï¼Œç¼–ç å™¨ç”Ÿæˆçš„åµŒå…¥åŒ…å«è§£ç å™¨ç”Ÿæˆç»“æœæ‰€éœ€çš„ä¿¡æ¯ã€‚è¿™ç§æ¶æ„å¹¿æ³›åº”ç”¨äºæœºå™¨ç¿»è¯‘å’Œå­—å¹•ç”Ÿæˆç­‰åº”ç”¨ä¸­ã€‚\n\n## å‚è€ƒé“¾æ¥\n- <a href=\"https://www.pinecone.io/learn/vector-embeddings/\">What are Vector Embeddings</a>\n","tags":["å‘é‡æ•°æ®åº“"]},{"title":"ä»€ä¹ˆæ˜¯å‘é‡æ•°æ®åº“","url":"/2023/09/16/2023-09-16-vector_database/","content":"\næˆ‘ä»¬æ­£å¤„äº AI æ™ºèƒ½é©å‘½çš„ä¸­æœŸã€‚å‘é‡æ•°æ®åº“å¼•å¯¼äº†ä¼Ÿå¤§çš„åˆ›æ–°ï¼Œå¹¶æ­£åœ¨é¢ è¦†ä»»ä½•ä¸ä¹‹ç›¸å…³çš„è¡Œä¸šï¼Œä½†æ˜¯å®ƒä¹Ÿå¸¦äº†æ–°çš„æŒ‘æˆ˜ã€‚å¯¹äºæ¶‰åŠå¤§å‹è¯­è¨€æ¨¡å‹ã€ç”Ÿæˆå¼äººå·¥æ™ºèƒ½å’Œè¯­ä¹‰æœç´¢çš„åº”ç”¨ç¨‹åºæ¥è¯´ï¼Œé«˜æ•ˆçš„æ•°æ®å¤„ç†å˜å¾—æ¯”ä»¥å¾€ä»»ä½•æ—¶å€™éƒ½æ›´åŠ é‡è¦ã€‚\n\næ‰€æœ‰è¿™äº›æ–°å…´çš„åº”ç”¨ç¨‹åºéƒ½ä¾èµ–äº**å‘é‡åµŒå…¥ï¼ˆvector embeddingsï¼‰**ã€‚è¿™æ˜¯ä¸€ç§æ•°æ®è¡¨ç¤ºå½¢å¼ï¼Œå…¶ä¸­åŒ…å«è¯­ä¹‰ä¿¡æ¯ï¼Œè¿™æœ‰åŠ©äºäººå·¥æ™ºèƒ½è·å¾—ã€ç†è§£å¹¶ç»´æŒèƒ½å¤Ÿåº”ç”¨åœ¨å¤æ‚ä»»åŠ¡ä¸Šçš„é•¿æœŸè®°å¿†ã€‚\n\n**åµŒå…¥**æ˜¯ç”±äººå·¥æ™ºèƒ½æ¨¡å‹ï¼ˆå¦‚å¤§å‹è¯­è¨€æ¨¡å‹ï¼‰ç”Ÿæˆçš„ï¼Œå¹¶ä¸”å…·æœ‰å¤§é‡å±æ€§æˆ–ç‰¹æ€§ï¼Œè¿™ä½¿å¾—å®ƒä»¬éš¾ä»¥è¢«è¡¨ç¤ºã€‚åœ¨äººå·¥æ™ºèƒ½å’Œæœºå™¨å­¦ä¹ çš„èƒŒæ™¯ä¸‹ï¼Œè¿™äº›ç‰¹å¾ä»£è¡¨äº†æ•°æ®çš„ä¸åŒç»´åº¦ï¼Œå¦‚ä½•â€œç²¾å‡†â€åœ°è¡¨ç¤ºå®ƒä»¬ï¼Œè¿™å–å†³äºæ•°æ®åº“çš„ç†è§£æ¨¡å¼ã€å…³ç³»å’Œåº•å±‚ç»“æ„ã€‚\n\nè¿™å°±æ˜¯ä¸ºä»€ä¹ˆæˆ‘ä»¬éœ€è¦ä¸“é—¨ä¸ºå¤„ç†æ­¤ç±»æ•°æ®è€Œè®¾è®¡çš„ä¸“ç”¨æ•°æ®åº“ã€‚åƒ Pinecone è¿™æ ·çš„**å‘é‡æ•°æ®åº“**é€šè¿‡ä¸ºåµŒå…¥æä¾›ä¼˜åŒ–çš„å­˜å‚¨å’ŒæŸ¥è¯¢åŠŸèƒ½æ¥æ»¡è¶³è¿™ä¸€è¦æ±‚ã€‚å‘é‡æ•°æ®åº“ä¸ä»…ä¼ ç»Ÿæ ‡é‡æ•°æ®åº“æ‰€æ²¡æœ‰çš„ä¸“é—¨å¤„ç†å‘é‡åµŒå…¥çš„èƒ½åŠ›ï¼Œè¿˜å…·æœ‰ç‹¬ç«‹å‘é‡ç´¢å¼•çš„èƒ½åŠ›ã€‚\n\nä½¿ç”¨å‘é‡åµŒå…¥çš„æŒ‘æˆ˜åœ¨äºï¼Œä¼ ç»Ÿçš„åŸºäºæ ‡é‡çš„æ•°æ®åº“æ— æ³•è·Ÿä¸Šæ­¤ç±»æ•°æ®çš„å¤æ‚æ€§å’Œè§„æ¨¡ï¼Œæ‰€ä»¥éš¾ä»¥æ•æ‰å…³é”®è¯­ä¹‰å¹¶è¿›è¡Œå®æ—¶åˆ†æã€‚è¿™æ°å·§å°±æ˜¯å‘é‡æ•°æ®åº“çš„ä¼˜åŠ¿â€”â€”å®ƒä»¬ä¸“é—¨ä¸ºé«˜æ•ˆã€çµæ´»åœ°å¤„ç†æ­¤ç±»æ•°æ®è€Œç”Ÿã€‚\n\nå€ŸåŠ©å‘é‡æ•°æ®åº“ï¼Œæˆ‘ä»¬å¯ä»¥ä¸ºäººå·¥æ™ºèƒ½æ·»åŠ æ›´é«˜çº§çš„åŠŸèƒ½ï¼Œæ¯”å¦‚è¯­ä¹‰ä¿¡æ¯æ£€ç´¢ã€é•¿æœŸè®°å¿†ç­‰ç­‰ã€‚ä¸‹å›¾èƒ½å¤Ÿè®©æˆ‘ä»¬æ›´å¥½åœ°ç†è§£å‘é‡æ•°æ®åº“åœ¨æ­¤ç±»åº”ç”¨ä¸­çš„ä½œç”¨ï¼š\n\n![å‘é‡æ•°æ®åº“çš„åº”ç”¨](/img/2023-09-16-vector_database/image1.png)\n\nè®©æˆ‘ä»¬æ¥åˆ†æä¸€ä¸‹ï¼š\n1. é¦–å…ˆï¼Œæˆ‘ä»¬ä½¿ç”¨**åµŒå…¥æ¨¡å‹**ä¸ºæˆ‘ä»¬æƒ³è¦ç´¢å¼•çš„**å†…å®¹**åˆ›å»º**å‘é‡åµŒå…¥**ã€‚\n2. å‚è€ƒåˆ›å»ºåµŒå…¥çš„åŸå§‹å†…å®¹ï¼Œå°†å‘é‡**åµŒå…¥**å†™å…¥åˆ°**å‘é‡æ•°æ®åº“**ä¸­ã€‚\n3. å½“**åº”ç”¨ç¨‹åº**å‘å‡ºæŸ¥è¯¢æ—¶ï¼Œæˆ‘ä»¬ä½¿ç”¨ç›¸åŒçš„**åµŒå…¥æ¨¡å‹**ä¸ºæŸ¥è¯¢åˆ›å»ºåµŒå…¥ï¼Œå¹¶ä½¿ç”¨è¿™äº›åµŒå…¥åœ¨**æ•°æ®åº“**ä¸­æŸ¥è¯¢ç±»ä¼¼çš„å‘é‡åµŒå…¥ã€‚å¦‚å‰æ‰€è¿°ï¼Œè¿™äº›ç±»ä¼¼çš„åµŒå…¥ä¸ç”¨äºåˆ›å»ºå®ƒä»¬çš„åŸå§‹**å†…å®¹ç›¸å…³è”**ã€‚\n\n## å‘é‡ç´¢å¼•å’Œå‘é‡æ•°æ®åº“çš„åŒºåˆ«æ˜¯ä»€ä¹ˆ\n\nåƒ FAISSï¼ˆFacebook AI ç›¸ä¼¼æ€§æœç´¢ï¼‰è¿™æ ·çš„ç‹¬ç«‹å‘é‡ç´¢å¼•å¯ä»¥æ˜¾è‘—æ”¹å–„å‘é‡åµŒå…¥çš„æœç´¢å’Œæ£€ç´¢ï¼Œä½†å®ƒä»¬ç¼ºä¹æ•°æ®åº“æ‰€å…·å¤‡çš„åŸºç¡€èƒ½åŠ›ï¼Œä¾‹å¦‚å­˜å‚¨ã€‚å¦ä¸€æ–¹é¢ï¼Œå‘é‡æ•°æ®åº“æ˜¯ä¸“é—¨ä¸ºç®¡ç†å‘é‡åµŒå…¥è€Œæ„å»ºçš„ï¼Œä¸ä½¿ç”¨ç‹¬ç«‹å‘é‡ç´¢å¼•ç›¸æ¯”å…·æœ‰ä»¥ä¸‹ä¼˜åŠ¿ï¼š\n\n1. **æ•°æ®ç®¡ç†**ï¼šå‘é‡æ•°æ®åº“æä¾›ç®€å•æ˜“ç”¨çš„æ•°æ®å­˜å‚¨åŠŸèƒ½ï¼Œä¾‹å¦‚æ’å…¥ã€åˆ é™¤å’Œæ›´æ–°æ•°æ®ã€‚è¿™ä½¿å¾—ç®¡ç†å’Œç»´æŠ¤å‘é‡æ•°æ®æ¯”ä½¿ç”¨ FAISS ç­‰ç‹¬ç«‹å‘é‡ç´¢å¼•æ›´å®¹æ˜“ï¼Œåè€…éœ€è¦é¢å¤–çš„å·¥ä½œæ‰èƒ½ä¸å­˜å‚¨è§£å†³æ–¹æ¡ˆé›†æˆã€‚\n\n2. **å…ƒæ•°æ®å­˜å‚¨å’Œè¿‡æ»¤**ï¼šå‘é‡æ•°æ®åº“å¯ä»¥å­˜å‚¨ä¸æ¯ä¸ªå‘é‡æ¡ç›®å…³è”çš„å…ƒæ•°æ®ã€‚ç„¶åï¼Œç”¨æˆ·å¯ä»¥ä½¿ç”¨é™„åŠ çš„å…ƒæ•°æ®è¿‡æ»¤å™¨æ¥æŸ¥è¯¢æ•°æ®åº“ï¼Œä»¥è¿›è¡Œæ›´ç»†ç²’åº¦çš„æŸ¥è¯¢ã€‚\n\n3. **å¯æ‰©å±•æ€§**ï¼šå‘é‡æ•°æ®åº“èƒ½å¤Ÿéšç€æ•°æ®é‡å’Œç”¨æˆ·éœ€æ±‚çš„å¢é•¿è€Œæ‰©å±•ï¼Œä¸ºåˆ†å¸ƒå¼å’Œå¹¶è¡Œå¤„ç†æä¾›æ›´å¥½çš„æ”¯æŒã€‚ç‹¬ç«‹å‘é‡ç´¢å¼•å¯èƒ½éœ€è¦å®šåˆ¶è§£å†³æ–¹æ¡ˆæ¥å®ç°ç±»ä¼¼çº§åˆ«çš„å¯æ‰©å±•æ€§ï¼ˆä¾‹å¦‚åœ¨ Kubernetes é›†ç¾¤æˆ–å…¶ä»–ç±»ä¼¼ç³»ç»Ÿä¸Šéƒ¨ç½²å’Œç®¡ç†å®ƒä»¬ï¼‰ã€‚\n\n4. **å®æ—¶æ›´æ–°**ï¼šå‘é‡æ•°æ®åº“é€šå¸¸æ”¯æŒå®æ—¶æ•°æ®æ›´æ–°ï¼Œå…è®¸å¯¹æ•°æ®è¿›è¡ŒåŠ¨æ€æ›´æ”¹ï¼Œè€Œç‹¬ç«‹å‘é‡ç´¢å¼•å¯èƒ½éœ€è¦å®Œæ•´çš„é‡æ–°ç´¢å¼•è¿‡ç¨‹æ¥åˆå¹¶æ–°æ•°æ®ï¼Œè¿™å¯èƒ½éå¸¸è€—æ—¶ä¸”è®¡ç®—æˆæœ¬é«˜æ˜‚ã€‚\n\n5. **å¤‡ä»½å’Œæ”¶é›†**ï¼šå¯¹äºå‘é‡æ•°æ®åº“æ¥è¯´ï¼Œå¤„ç†å¤‡ä»½æ•°æ®åº“ä¸­å­˜å‚¨çš„æ‰€æœ‰æ•°æ®æ˜¯å¸¸è§„æ“ä½œã€‚Pinecone è¿˜å…è®¸ç”¨æˆ·é€‰æ‹©ç‰¹å®šçš„ç´¢å¼•ï¼Œé‡‡ç”¨â€œé›†åˆâ€çš„å½¢å¼è¿›è¡Œæ•°æ®å¤‡ä»½ã€‚\n\n6. **ç”Ÿæ€ç³»ç»Ÿé›†æˆ**ï¼šå‘é‡æ•°æ®åº“å¯ä»¥æ›´è½»æ¾åœ°ä¸æ•°æ®å¤„ç†ç”Ÿæ€ç³»ç»Ÿçš„å…¶ä»–ç»„ä»¶é›†æˆï¼Œä¾‹å¦‚ ETL ç®¡é“ï¼ˆå¦‚ Sparkï¼‰ã€åˆ†æå·¥å…·ï¼ˆå¦‚Tableau å’Œ Segmentï¼‰å’Œå¯è§†åŒ–å¹³å°ï¼ˆå¦‚ Grafanaï¼‰ï¼Œä»è€Œç®€åŒ–æ•°æ®ç®¡ç†å·¥ä½œæµç¨‹ã€‚å®ƒè¿˜å¯ä»¥ä¸å…¶ä»–äººå·¥æ™ºèƒ½ç›¸å…³å·¥å…·ï¼ˆä¾‹å¦‚LangChainã€LlamaIndex å’Œ ChatGPT çš„æ’ä»¶ï¼‰è½»æ¾é›†æˆã€‚\n\n7. **æ•°æ®å®‰å…¨å’Œè®¿é—®æ§åˆ¶**ï¼šå‘é‡æ•°æ®åº“é€šå¸¸æä¾›å†…ç½®æ•°æ®å®‰å…¨åŠŸèƒ½å’Œè®¿é—®æ§åˆ¶æœºåˆ¶æ¥ä¿æŠ¤æ•æ„Ÿä¿¡æ¯ï¼Œè¿™åœ¨ç‹¬ç«‹çš„å‘é‡ç´¢å¼•è§£å†³æ–¹æ¡ˆä¸­å¯èƒ½æ— æ³•å®ç°ã€‚\n\nç®€è€Œè¨€ä¹‹ï¼Œå‘é‡æ•°æ®åº“è§£å†³äº†ç‹¬ç«‹å‘é‡æŒ‡æ•°çš„å±€é™æ€§ï¼ˆä¾‹å¦‚å¯æ‰©å±•æ€§æŒ‘æˆ˜ã€ç¹ççš„é›†æˆè¿‡ç¨‹ä»¥åŠç¼ºä¹å®æ—¶æ›´æ–°å’Œå†…ç½®å®‰å…¨æªæ–½ï¼‰ï¼Œä»è€Œä¸ºå¤„ç†å‘é‡åµŒå…¥æä¾›äº†ä¸€ä¸ªä¼˜è¶Šçš„è§£å†³æ–¹æ¡ˆï¼Œç¡®ä¿æ›´æœ‰æ•ˆå’Œæ›´ç²¾ç®€çš„æ•°æ®ç®¡ç†ç»éªŒã€‚\n\n## å‘é‡æ•°æ®åº“æ˜¯å¦‚ä½•å·¥ä½œçš„\n\næˆ‘ä»¬éƒ½æˆ–å¤šæˆ–å°‘åœ°äº†è§£ä¼ ç»Ÿæ•°æ®åº“çš„å·¥ä½œåŸç†ï¼Œå®ƒä»¬åœ¨è¡Œå’Œåˆ—ä¸­å­˜å‚¨å­—ç¬¦ä¸²ã€æ•°å­—å’Œå…¶ä»–ç±»å‹çš„æ ‡é‡æ•°æ®ã€‚ä½†æ˜¯ï¼Œå‘é‡æ•°æ®åº“å¯¹å‘é‡è¿›è¡Œæ“ä½œï¼Œå› æ­¤å…¶ä¼˜åŒ–å’ŒæŸ¥è¯¢çš„æ–¹å¼å’Œä¼ ç»Ÿæ•°æ®åº“æœ‰å¾ˆå¤§çš„ä¸åŒã€‚\n\nåœ¨ä¼ ç»Ÿæ•°æ®åº“ä¸­ï¼Œæˆ‘ä»¬é€šå¸¸åœ¨æ•°æ®åº“ä¸­æ£€ç´¢ä¸æŸ¥è¯¢å€¼å®Œå…¨åŒ¹é…çš„è¡Œï¼›ä½†åœ¨å‘é‡æ•°æ®åº“ä¸­ï¼Œæˆ‘ä»¬åº”ç”¨ç›¸ä¼¼æ€§åº¦é‡æ¥æŸ¥æ‰¾ä¸æˆ‘ä»¬çš„æŸ¥è¯¢**æœ€ç›¸ä¼¼**çš„å‘é‡ã€‚\n\nå‘é‡æ•°æ®åº“ä½¿ç”¨ä¸åŒç®—æ³•çš„ç»„åˆï¼Œè¿™äº›ç®—æ³•éƒ½å‚ä¸äº†è¿‘ä¼¼æœ€è¿‘é‚» (ANN) æœç´¢ã€‚è¿™äº›ç®—æ³•é€šè¿‡æ•£åˆ—ã€é‡åŒ–æˆ–åŸºäºå›¾çš„æœç´¢æ¥ä¼˜åŒ–æœç´¢ã€‚\n\nè¿™äº›ç®—æ³•ç»„åˆæˆä¸€ä¸ªæµæ°´çº¿ï¼Œå¯ä»¥å¿«é€Ÿå‡†ç¡®åœ°æ£€ç´¢æ‰€æŸ¥è¯¢å‘é‡çš„é‚»å±…ã€‚ç”±äºå‘é‡æ•°æ®åº“æä¾›**è¿‘ä¼¼**ç»“æœï¼Œå› æ­¤ä¸»è¦æƒè¡¡æ˜¯ç²¾åº¦å’Œé€Ÿåº¦ã€‚ç»“æœè¶Šå‡†ç¡®ï¼ŒæŸ¥è¯¢çš„é€Ÿåº¦å°±è¶Šæ…¢ã€‚ç„¶è€Œï¼Œä¸€ä¸ªå¥½çš„ç³»ç»Ÿå¯ä»¥æä¾›è¿‘ä¹å®Œç¾çš„ç²¾åº¦è¶…å¿«æœç´¢ã€‚\n\nè¿™æ˜¯å‘é‡æ•°æ®åº“çš„å¸¸è§æµç¨‹ï¼š\n\n![å‘é‡æ•°æ®åº“å¸¸è§æµç¨‹](/img/2023-09-16-vector_database/image2.png)\n\n1. **ç´¢å¼•ï¼ˆindexingï¼‰**ï¼šå‘é‡æ•°æ®åº“ä½¿ç”¨ PQã€LSH æˆ– HNSW ç­‰ç®—æ³•å¯¹å‘é‡è¿›è¡Œç´¢å¼•ï¼ˆæ›´å¤šå†…å®¹è§ä¸‹æ–‡ï¼‰ã€‚æ­¤æ­¥éª¤å°†å‘é‡æ˜ å°„åˆ°èƒ½å¤Ÿæ›´å¿«æœç´¢çš„æ•°æ®ç»“æ„ä¸­ã€‚\n\n2. **æŸ¥è¯¢ï¼ˆqueryingï¼‰**ï¼šå‘é‡æ•°æ®åº“å°†ç´¢å¼•æŸ¥è¯¢å‘é‡ä¸æ•°æ®é›†ä¸­çš„ç´¢å¼•å‘é‡è¿›è¡Œæ¯”è¾ƒï¼Œä»¥æ‰¾åˆ°æœ€è¿‘çš„é‚»å±…ï¼ˆåº”ç”¨è¯¥ç´¢å¼•ä½¿ç”¨çš„ç›¸ä¼¼æ€§åº¦é‡ï¼‰\n\n3. **åæœŸå¤„ç†ï¼ˆpost processingï¼‰**ï¼šåœ¨æŸäº›æƒ…å†µä¸‹ï¼Œå‘é‡æ•°æ®åº“ä»æ•°æ®é›†ä¸­æ£€ç´¢æœ€ç»ˆçš„æœ€è¿‘é‚»ï¼Œå¹¶å¯¹å®ƒä»¬è¿›è¡Œåå¤„ç†ä»¥è¿”å›æœ€ç»ˆç»“æœã€‚è¯¥æ­¥éª¤å¯ä»¥åŒ…æ‹¬ä½¿ç”¨ä¸åŒçš„ç›¸ä¼¼æ€§åº¦é‡å¯¹æœ€è¿‘é‚»å±…é‡æ–°æ’åºã€‚\n\nä¸‹é¢ï¼Œæˆ‘ä»¬å°†æ›´è¯¦ç»†åœ°è®¨è®ºè¿™äº›ç®—æ³•ï¼Œå¹¶è§£é‡Šå®ƒä»¬å¦‚ä½•æå‡å‘é‡æ•°æ®åº“çš„æ•´ä½“æ€§èƒ½ã€‚\n\n### ç®—æ³•\n\næœ‰å¾ˆå¤šç®—æ³•å¯ä»¥ä¿ƒè¿›å‘é‡ç´¢å¼•çš„åˆ›å»ºã€‚ä»–ä»¬çš„å…±åŒç›®æ ‡æ˜¯é€šè¿‡åˆ›å»ºå¯å¿«é€Ÿéå†çš„æ•°æ®ç»“æ„æ¥å®ç°å¿«é€ŸæŸ¥è¯¢ã€‚å®ƒä»¬é€šå¸¸ä¼šå°†åŸå§‹å‘é‡çš„è¡¨ç¤ºå½¢å¼è½¬æ¢ä¸ºå‹ç¼©å½¢å¼ï¼Œä»¥ä¼˜åŒ–æŸ¥è¯¢è¿‡ç¨‹ã€‚\n\nç„¶è€Œï¼Œä½œä¸º Pinecone çš„ç”¨æˆ·ï¼Œæ‚¨æ— éœ€æ‹…å¿ƒè¿™äº›å„ç§ç®—æ³•çš„å¤æ‚æ€§å’Œé€‰æ‹©ã€‚Pinecone æ—¨åœ¨å¤„ç†å¹•åçš„æ‰€æœ‰å¤æ‚æ€§å’Œç®—æ³•å†³ç­–ï¼Œç¡®ä¿æ‚¨è½»æ¾è·å¾—æœ€ä½³æ€§èƒ½å’Œç»“æœã€‚é€šè¿‡åˆ©ç”¨ Pinecone çš„ä¸“ä¸šçŸ¥è¯†ï¼Œæ‚¨å¯ä»¥ä¸“æ³¨äºçœŸæ­£é‡è¦çš„äº‹æƒ…â€”â€”æå–æœ‰ä»·å€¼çš„è§è§£å¹¶æä¾›å¼ºå¤§çš„ AI è§£å†³æ–¹æ¡ˆã€‚\n\nä»¥ä¸‹éƒ¨åˆ†å°†æ¢è®¨å‡ ç§ç®—æ³•åŠå…¶å¤„ç†å‘é‡åµŒå…¥çš„ç‹¬ç‰¹æ–¹æ³•ã€‚\n\n#### éšå³æŠ•å½±\n\n**éšæœºæŠ•å½±èƒŒåçš„åŸºæœ¬æ€æƒ³æ˜¯ä½¿ç”¨éšæœºæŠ•å½±çŸ©é˜µ**å°†é«˜ç»´å‘é‡æŠ•å½±åˆ°ä½ç»´ç©ºé—´ã€‚æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªéšæœºæ•°çŸ©é˜µã€‚çŸ©é˜µçš„å¤§å°å°†æ˜¯æˆ‘ä»¬æƒ³è¦çš„ç›®æ ‡ä½ç»´å€¼ã€‚ç„¶åæˆ‘ä»¬è®¡ç®—è¾“å…¥å‘é‡å’ŒçŸ©é˜µçš„ç‚¹ç§¯ï¼Œè¿™ä¼šäº§ç”Ÿä¸€ä¸ªæŠ•å½±çŸ©é˜µï¼Œå…¶ç»´åº¦æ¯”åŸå§‹å‘é‡å°‘ï¼Œä½†ä»ä¿ç•™å®ƒä»¬çš„ç›¸ä¼¼æ€§ã€‚\n\n![éšè®°æŠ•å½±ç®—æ³•](/img/2023-09-16-vector_database/image3.png)\n\nå½“æˆ‘ä»¬æŸ¥è¯¢æ—¶ï¼Œæˆ‘ä»¬ä½¿ç”¨ç›¸åŒçš„æŠ•å½±çŸ©é˜µå°†æŸ¥è¯¢å‘é‡æŠ•å½±åˆ°ä½ç»´ç©ºé—´ã€‚ç„¶åï¼Œå°†æŠ•å½±æŸ¥è¯¢å‘é‡ä¸æ•°æ®åº“ä¸­çš„æŠ•å½±å‘é‡è¿›è¡Œæ¯”è¾ƒï¼Œå¯»æ‰¾æœ€è¿‘é‚»ã€‚ç”±äºæ•°æ®çš„ç»´æ•°é™ä½äº†ï¼Œå› æ­¤æœç´¢è¿‡ç¨‹æ¯”æœç´¢æ•´ä¸ªé«˜ç»´ç©ºé—´è¦å¿«å¾—å¤šã€‚\n\nè¯·è®°ä½ï¼ŒéšæœºæŠ•å½±æ˜¯ä¸€ç§è¿‘ä¼¼æ–¹æ³•ï¼ŒæŠ•å½±è´¨é‡å–å†³äºæŠ•å½±çŸ©é˜µçš„å±æ€§ã€‚ä¸€èˆ¬æ¥è¯´ï¼ŒæŠ•å½±çŸ©é˜µè¶Šéšæœºï¼ŒæŠ•å½±çš„è´¨é‡å°±è¶Šå¥½ã€‚ä½†ç”Ÿæˆä¸€ä¸ªçœŸæ­£éšæœºçš„æŠ•å½±çŸ©é˜µçš„è®¡ç®—æˆæœ¬å¯èƒ½å¾ˆé«˜ï¼Œå°¤å…¶æ˜¯å¯¹äºå¤§å‹æ•°æ®é›†ã€‚\n\n#### ä¹˜ç§¯é‡åŒ–\n\nå¦ä¸€ç§å»ºç«‹ç´¢å¼•çš„æ–¹æ³•æ˜¯ä¹˜ç§¯é‡åŒ–(product quulizationï¼ŒPQ) ï¼Œè¿™æ˜¯ä¸€ç§ç”¨äºé«˜ç»´å‘é‡ï¼ˆå¦‚å‘é‡åµŒå…¥ï¼‰çš„æœ‰æŸæ•°æ®å‹ç¼©æŠ€æœ¯ã€‚å®ƒè·å–åŸå§‹å‘é‡ï¼Œå°†å…¶åˆ†è§£æˆæ›´å°çš„å—ï¼Œé€šè¿‡ä¸ºæ¯ä¸ªå—åˆ›å»ºä¸€ä¸ªä»£è¡¨æ€§çš„â€ç¼–ç â€æ¥ç®€åŒ–æ¯ä¸ªå—çš„è¡¨ç¤ºï¼Œç„¶åå°†æ‰€æœ‰å—æ”¾å›åˆ°ä¸€èµ·â€”â€”è€Œä¸ä¼šä¸¢å¤±å¯¹ç›¸ä¼¼æ€§æ“ä½œè‡³å…³é‡è¦çš„ä¿¡æ¯ã€‚PQ çš„è¿‡ç¨‹å¯ä»¥åˆ†ä¸ºå››ä¸ªæ­¥éª¤: æ‹†åˆ†ã€è®­ç»ƒã€ç¼–ç å’ŒæŸ¥è¯¢ã€‚\n\n![ä¹˜ç§¯é‡åŒ–ç®—æ³•](/img/2023-09-16-vector_database/image4.png)\n\n1. **æ‹†åˆ†**ï¼šå‘é‡è¢«åˆ†æˆå¤šä¸ªç‰‡æ®µã€‚\n2. **è®­ç»ƒ**ï¼šæˆ‘ä»¬ä¸ºæ¯ä¸ªç‰‡æ®µå»ºç«‹ä¸€ä¸ªâ€œç¼–ç æœ¬â€ã€‚ç®€å•åœ°è¯´ï¼Œå°±æ˜¯è¯¥ç®—æ³•ä¼šç”Ÿæˆä¸€ä¸ªå¯ä»¥åˆ†é…ç»™å‘é‡çš„æ½œåœ¨â€œç¼–ç â€æ± ã€‚å®é™…ä¸Šï¼Œè¿™ä¸ªâ€œç¼–ç æœ¬â€æ˜¯ç”±å¯¹æ¯ä¸ªå‘é‡ç‰‡æ®µçš„æ‰§è¡Œ K å‡å€¼ç®—æ³•è€Œåˆ›å»ºçš„èšç±»ä¸­å¿ƒç‚¹ç»„æˆã€‚æˆ‘ä»¬åœ¨ç‰‡æ®µç¼–ç æœ¬ä¸­å€¼æ•°é‡ä¸ K å‡å€¼ç®—æ³•ä¸­ä½¿ç”¨çš„å€¼çš„æ•°é‡ç›¸åŒã€‚\n3. **ç¼–ç **ï¼šç®—æ³•ä¸ºæ¯ä¸ªç‰‡æ®µåˆ†é…æŒ‡å®šçš„ç¼–ç ã€‚å®é™…ä¸Šï¼Œæˆ‘ä»¬åœ¨è®­ç»ƒå®Œæˆåä¼šåœ¨ç¼–ç æœ¬ä¸­æ‰¾åˆ°ä¸æ¯ä¸ªå‘é‡æ®µæœ€æ¥è¿‘çš„å€¼ã€‚è¯¥ç‰‡æ®µçš„ PQ ç¼–ç å°†æ˜¯ç¼–ç æœ¬ä¸­ç›¸åº”å€¼çš„æ ‡è¯†ç¬¦ã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä»»æ„æ•°é‡çš„ PQ ç¼–ç ï¼Œè¿™æ„å‘³ç€æˆ‘ä»¬å¯ä»¥ä»ç¼–ç æœ¬ä¸­é€‰æ‹©å¤šä¸ªå€¼æ¥è¡¨ç¤ºæ¯ä¸ªæ®µã€‚\n4. **æŸ¥è¯¢**ï¼šå½“æˆ‘ä»¬æŸ¥è¯¢æ—¶ï¼Œç®—æ³•ä¼šå°†æŸ¥è¯¢å‘é‡åˆ†è§£æˆå¤šä¸ªå­å‘é‡ï¼Œå¹¶ä½¿ç”¨ç›¸åŒçš„ç¼–ç æœ¬å¯¹å®ƒä»¬è¿›è¡Œé‡åŒ–ã€‚ç„¶åï¼Œä½¿ç”¨ç´¢å¼•ç¼–ç æ¥æŸ¥æ‰¾æœ€æ¥è¿‘æŸ¥è¯¢å‘é‡çš„å‘é‡ã€‚\n\nç¼–ç æœ¬ä¸­ä»£è¡¨å‘é‡çš„æ•°ç›®æ˜¯è¡¨ç¤ºçš„å‡†ç¡®æ€§å’Œæœç´¢ç¼–ç æœ¬çš„è®¡ç®—æˆæœ¬ä¹‹é—´çš„æƒè¡¡ã€‚ç¼–ç æœ¬ä¸­çš„å…·æœ‰ä»£è¡¨æ€§çš„å‘é‡è¶Šå¤šï¼Œå­ç©ºé—´ä¸­å‘é‡çš„è¡¨ç¤ºå°±è¶Šç²¾å‡†ï¼Œä½†æ˜¯æœç´¢ç¼–ç æœ¬çš„è®¡ç®—æˆæœ¬å°±è¶Šé«˜ã€‚åä¹‹ï¼Œç¼–ç æœ¬ä¸­çš„ä»£è¡¨å‘é‡è¶Šå°‘ï¼Œè¡¨ç¤ºçš„ç²¾åº¦è¶Šä½ï¼Œä½†è®¡ç®—æˆæœ¬è¶Šä½ã€‚\n\n#### å±€éƒ¨æ•æ„Ÿå“ˆå¸Œ\n\nå±€éƒ¨æ•æ„Ÿå“ˆå¸Œï¼ˆLSHï¼‰æ˜¯ä¸€ç§åœ¨è¿‘ä¼¼æœ€è¿‘é‚»æœç´¢ä¸Šä¸‹æ–‡ä¸­å»ºç«‹ç´¢å¼•çš„æŠ€æœ¯ã€‚å®ƒä¸ä»…ä¼˜åŒ–äº†æŸ¥è¯¢é€Ÿåº¦ï¼Œè¿˜èƒ½æä¾›ä¸€ä¸ªè¿‘ä¼¼çš„ã€éè¯¦å°½çš„ç»“æœã€‚LSH ä½¿ç”¨ä¸€ç»„å“ˆå¸Œå‡½æ•°å°†ç›¸ä¼¼çš„å‘é‡æ˜ å°„é“â€œæ¡¶â€ä¸­ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š\n\n![å±€éƒ¨æ•æ„Ÿå“ˆå¸Œç®—æ³•](/img/2023-09-16-vector_database/image5.png)\n\nä¸ºäº†æ‰¾åˆ°ç»™å®šæŸ¥è¯¢å‘é‡çš„æœ€è¿‘é‚»ï¼Œæˆ‘ä»¬ä½¿ç”¨ä¸å°†ç›¸ä¼¼å‘é‡â€œå­˜å‚¨â€åˆ°å“ˆå¸Œè¡¨ä¸­ç›¸åŒçš„å“ˆå¸Œå‡½æ•°ã€‚æŸ¥è¯¢å‘é‡è¢«æ•£åˆ—åˆ°ç‰¹å®šçš„è¡¨ä¸­ï¼Œç„¶åä¸åŒä¸€è¡¨ä¸­çš„å…¶ä»–å‘é‡è¿›è¡Œæ¯”è¾ƒï¼Œä»¥æ‰¾åˆ°æœ€æ¥è¿‘çš„åŒ¹é…ã€‚è¿™ç§æ–¹æ³•æ¯”æœç´¢æ•´ä¸ªæ•°æ®é›†è¦å¿«å¾—å¤šï¼Œå› ä¸ºæ¯ä¸ªå“ˆå¸Œè¡¨ä¸­çš„å‘é‡æ¯”æ•´ä¸ªç©ºé—´ä¸­çš„å‘é‡è¦å°‘å¾—å¤šã€‚\n\nä½†æ˜¯ LSH æ˜¯ä¸€ç§è¿‘ä¼¼æ–¹æ³•ï¼Œè¿‘ä¼¼çš„è´¨é‡å–å†³äºå“ˆå¸Œå‡½æ•°çš„å±æ€§ã€‚ä¸€èˆ¬æ¥è¯´ï¼Œä½¿ç”¨çš„å“ˆå¸Œå‡½æ•°è¶Šå¤šï¼Œè¿‘ä¼¼è´¨é‡å°±è¶Šå¥½ã€‚ä½†æ˜¯ï¼Œä½¿ç”¨å¤§é‡å“ˆå¸Œå‡½æ•°çš„è®¡ç®—æˆæœ¬å¯èƒ½å¾ˆé«˜ï¼Œå¹¶ä¸” LSH å¯¹äºå¤§å‹æ•°æ®é›†å¯èƒ½ä¸å¯è¡Œã€‚\n\n#### åˆ†å±‚å¯å¯¼èˆªå°ä¸–ç•Œï¼ˆHNSWï¼‰\n\nHNSW åˆ›å»ºäº†ä¸€ä¸ªåˆ†å±‚çš„æ ‘çŠ¶ç»“æ„ï¼Œå…¶ä¸­æ ‘çš„æ¯ä¸ªèŠ‚ç‚¹ä»£è¡¨ä¸€ç»„å‘é‡ã€‚èŠ‚ç‚¹ç›´æ¥çš„è¾¹ä»£è¡¨å‘é‡ä¹‹é—´çš„ç›¸ä¼¼åº¦ã€‚è¯¥ç®—æ³•é¦–å…ˆåˆ›å»ºä¸€ç»„èŠ‚ç‚¹ï¼Œæ¯ä¸ªèŠ‚ç‚¹éƒ½å…·æœ‰å°‘é‡çš„å‘é‡ï¼›è¿™å¯ä»¥æ˜¯éšå³å®Œæˆï¼Œä¹Ÿå¯ä»¥é€šè¿‡ä½¿ç”¨ k å‡å€¼ç­‰ç®—æ³•å¯¹å‘é‡è¿›è¡Œèšç±»æ¥å®Œæˆï¼Œå…¶ä¸­æ¯ä¸ªèšç±»éƒ½æˆä¸ºä¸€ä¸ªèŠ‚ç‚¹ã€‚\n\n![èšç±»èŠ‚ç‚¹](/img/2023-09-16-vector_database/image6.png)\n\nç„¶åï¼Œè¯¥ç®—æ³•æ£€æŸ¥æ¯ä¸ªèŠ‚ç‚¹çš„å‘é‡ï¼Œå¹¶åœ¨è¯¥èŠ‚ç‚¹å’Œå…·æœ‰æœ€ç›¸ä¼¼å‘é‡çš„èŠ‚ç‚¹ä¹‹é—´ç»˜åˆ¶ä¸€æ¡è¾¹ã€‚\n\n![èšç±»æ ‘](/img/2023-09-16-vector_database/image7.png)\n\nå½“æˆ‘ä»¬æŸ¥è¯¢ HNSW ç´¢å¼•æ—¶ï¼Œå®ƒä½¿ç”¨æ­¤å›¾åœ¨æ ‘ä¸­å¯¼èˆªï¼Œè®¿é—®æœ€æœ‰å¯èƒ½åŒ…å«ä¸æŸ¥è¯¢å‘é‡æœ€æ¥è¿‘çš„å‘é‡çš„èŠ‚ç‚¹ã€‚\n\n#### ç›¸ä¼¼åº¦é‡\n\nåœ¨å‰é¢è®¨è®ºçš„ç®—æ³•çš„åŸºç¡€ä¸Šï¼Œæˆ‘ä»¬éœ€è¦äº†è§£ç›¸ä¼¼åº¦é‡åœ¨å‘é‡æ•°æ®åº“ä¸­çš„ä½œç”¨ã€‚è¿™äº›åº¦é‡æ˜¯å‘é‡æ•°æ®åº“å¦‚ä½•æ¯”è¾ƒå’Œè¯†åˆ«ç»™å®šæŸ¥è¯¢çš„æœ€ç›¸å…³ç»“æœçš„åŸºç¡€ã€‚\n\nç›¸ä¼¼æ€§åº¦é‡æ˜¯ç”¨äºç¡®å®šå‘é‡ç©ºé—´ä¸­ä¸¤ä¸ªå‘é‡ç›¸ä¼¼ç¨‹åº¦çš„æ•°å­¦æ–¹æ³•ã€‚åœ¨å‘é‡æ•°æ®åº“ä¸­ä½¿ç”¨ç›¸ä¼¼æ€§åº¦é‡æ¥æ¯”è¾ƒå­˜å‚¨åœ¨æ•°æ®åº“ä¸­çš„å‘é‡ï¼Œå¹¶æ‰¾å‡ºä¸ç»™å®šæŸ¥è¯¢å‘é‡æœ€ç›¸ä¼¼çš„å‘é‡ã€‚\n\nå¯ä»¥ä½¿ç”¨å¤šç§ç›¸ä¼¼æ€§åº¦é‡ï¼ŒåŒ…æ‹¬ï¼š\n\n- **ä½™å¼¦ç›¸ä¼¼åº¦**ï¼šè®¡ç®—å‘é‡ç©ºé—´ä¸­ä¸¤ä¸ªå‘é‡ä¹‹é—´å¤¹è§’çš„ä½™å¼¦ã€‚å–å€¼èŒƒå›´æ˜¯ -1 åˆ° 1ï¼Œå…¶ä¸­ 1 è¡¨ç¤ºç›¸åŒçš„å‘é‡ï¼Œ0 è¡¨ç¤ºæ­£äº¤å‘é‡ï¼Œ-1 è¡¨ç¤ºå®Œå…¨ç›¸åçš„å‘é‡ã€‚\n- **æ¬§å¼è·ç¦»**ï¼šè®¡ç®—å‘é‡ç©ºé—´å†…ä¸¤ä¸ªå‘é‡ä¹‹é—´çš„ç›´çº¿è·ç¦»ã€‚å®ƒçš„èŒƒå›´æ˜¯ä» 0 åˆ°æ— ç©·å¤§ï¼Œå…¶ä¸­ 0 è¡¨ç¤ºç›¸åŒçš„å‘é‡ï¼Œè¶Šå¤§çš„å€¼è¡¨ç¤ºè¶Šä¸ç›¸ä¼¼çš„å‘é‡ã€‚\n- **ç‚¹ç§¯**ï¼šè®¡ç®—ä¸¤ä¸ªå‘é‡çš„å¤§å°ç‰ä»–ä»¬ä¹‹é—´å¤¹è§’çš„ä¹˜ç§¯ã€‚èŒƒå›´ä¸º -âˆ åˆ° âˆï¼Œå…¶ä¸­æ­£å€¼è¡¨ç¤ºæŒ‡å‘ç›¸åŒæ–¹å‘çš„å‘é‡ï¼Œ0 è¡¨ç¤ºæ­£äº¤å‘é‡ï¼Œè´Ÿå€¼è¡¨ç¤ºæŒ‡å‘ç›¸åæ–¹å‘çš„å‘é‡ã€‚\n\nç›¸ä¼¼æ€§åº¦é‡çš„é€‰æ‹©ä¼šå¯¹ä»å‘é‡æ•°æ®åº“è·å¾—çš„ç»“æœäº§ç”Ÿå½±å“ã€‚è¿˜éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæ¯ç§ç›¸ä¼¼æ€§åº¦é‡éƒ½æœ‰å…¶è‡ªèº«çš„ä¼˜ç‚¹å’Œç¼ºç‚¹ï¼Œå› æ­¤æ ¹æ®ç”¨ä¾‹å’Œéœ€æ±‚é€‰æ‹©æ­£ç¡®çš„ç›¸ä¼¼æ€§åº¦é‡éå¸¸é‡è¦ã€‚\n\n#### è¿‡æ»¤\n\næ•°æ®åº“ä¸­å­˜å‚¨çš„æ¯ä¸ªå‘é‡è¿˜åŒ…æ‹¬å…ƒæ•°æ®ã€‚é™¤äº†èƒ½å¤ŸæŸ¥è¯¢ç›¸ä¼¼çš„å‘é‡ä¹‹å¤–ï¼Œå‘é‡æ•°æ®åº“è¿˜å¯ä»¥åŸºäºå…ƒæ•°æ®æŸ¥è¯¢è¿‡æ»¤ç»“æœã€‚ä¸ºæ­¤ï¼Œå‘é‡æ•°æ®åº“é€šå¸¸ç»´æŠ¤ä¸¤ä¸ªç´¢å¼•: å‘é‡ç´¢å¼•å’Œå…ƒæ•°æ®ç´¢å¼•ã€‚ç„¶åï¼Œåœ¨å‘é‡æœç´¢æœ¬èº«ä¹‹å‰æˆ–ä¹‹åæ‰§è¡Œå…ƒæ•°æ®è¿‡æ»¤ï¼Œä½†æ˜¯åœ¨è¿™ä¸¤ç§æƒ…å†µä¸‹ï¼Œéƒ½ä¼šå¯¼è‡´æŸ¥è¯¢è¿‡ç¨‹å˜æ…¢ã€‚\n\n![é¢„è¿‡æ»¤](/img/2023-09-16-vector_database/image8.png)\n\n![åè¿‡æ»¤](/img/2023-09-16-vector_database/image9.png)\n\nè¿‡æ»¤è¿‡ç¨‹å¯ä»¥åœ¨å‘é‡æœç´¢æœ¬èº«ä¹‹å‰æˆ–ä¹‹åæ‰§è¡Œï¼Œä½†æ¯ç§æ–¹æ³•éƒ½æœ‰å…¶è‡ªèº«çš„æŒ‘æˆ˜ï¼Œå¯èƒ½ä¼šå½±å“æŸ¥è¯¢æ€§èƒ½ï¼š\n1. **é¢„è¿‡æ»¤**ï¼šåœ¨è¿™ç§æ–¹æ³•ä¸­ï¼Œå…ƒæ•°æ®è¿‡æ»¤æ˜¯åœ¨å‘é‡æœç´¢ä¹‹å‰å®Œæˆçš„ã€‚è™½ç„¶è¿™æœ‰åŠ©äºå‡å°‘æœç´¢ç©ºé—´ï¼Œä½†ä¹Ÿå¯èƒ½å¯¼è‡´ç³»ç»Ÿå¿½ç•¥ä¸å…ƒæ•°æ®è¿‡æ»¤æ¡ä»¶ä¸åŒ¹é…çš„ç›¸å…³ç»“æœã€‚æ­¤å¤–ï¼Œå¹¿æ³›çš„å…ƒæ•°æ®è¿‡æ»¤å¯èƒ½ä¼šç”±äºå¢åŠ çš„è®¡ç®—å¼€é”€è€Œå‡æ…¢æŸ¥è¯¢è¿‡ç¨‹ã€‚\n2. **åè¿‡æ»¤**ï¼šåœ¨è¿™ç§æ–¹æ³•ä¸­ï¼Œå…ƒæ•°æ®è¿‡æ»¤æ˜¯åœ¨å‘é‡æœç´¢ä¹‹åå®Œæˆçš„ã€‚è¿™å¯ä»¥ç¡®ä¿è€ƒè™‘æ‰€æœ‰ç›¸å…³ç»“æœï¼Œä½†å› ä¸ºæœç´¢å®Œæˆåéœ€è¦è¿‡æ»¤æ‰ä¸ç›¸å…³çš„ç»“æœï¼Œå¯èƒ½ä¼šå¸¦æ¥é¢å¤–çš„å¼€é”€å¹¶å‡æ…¢æŸ¥è¯¢è¿‡ç¨‹ï¼Œ\n\nä¸ºäº†ä¼˜åŒ–è¿‡æ»¤è¿‡ç¨‹ï¼Œå‘é‡æ•°æ®åº“ä½¿ç”¨å„ç§æŠ€æœ¯ï¼Œä¾‹å¦‚åˆ©ç”¨é«˜çº§å…ƒæ•°æ®ç´¢å¼•æ–¹æ³•æˆ–ä½¿ç”¨å¹¶è¡Œå¤„ç†æ¥åŠ é€Ÿè¿‡æ»¤ä»»åŠ¡ã€‚å¹³è¡¡æœç´¢æ€§èƒ½å’Œè¿‡æ»¤ç²¾åº¦å¯¹äºåœ¨å‘é‡æ•°æ®åº“ä¸­æä¾›æœ‰æ•ˆå’Œç›¸å…³çš„æŸ¥è¯¢ç»“æœè‡³å…³é‡è¦ã€‚\n\n### æ•°æ®åº“æ“ä½œ\n\nä¸å‘é‡ç´¢å¼•ä¸åŒï¼Œå‘é‡æ•°æ®åº“é…å¤‡äº†ä¸€ç»„åŠŸèƒ½ï¼Œä½¿å…¶æ›´é€‚äºå¤§è§„æ¨¡ç”Ÿäº§ç¯å¢ƒã€‚è®©æˆ‘ä»¬çœ‹ä¸€ä¸‹æ“ä½œæ•°æ®åº“æ‰€æ¶‰åŠçš„ç»„ä»¶çš„æ€»ä½“æ¦‚è¿°ã€‚\n\n![æ•°æ®åº“æ“ä½œ](/img/2023-09-16-vector_database/image10.png)\n\n### æ€§èƒ½ä¸å®¹é”™\n\næ€§èƒ½ä¸å®¹é”™å¯†åˆ‡ç›¸å…³ã€‚æˆ‘ä»¬æ‹¥æœ‰çš„æ•°æ®è¶Šå¤šï¼Œéœ€è¦çš„èŠ‚ç‚¹å°±è¶Šå¤šï¼Œå‡ºç°é”™è¯¯å’Œå¤±è´¥çš„å¯èƒ½æ€§ä¹Ÿå°±è¶Šå¤§ã€‚ä¸å…¶ä»–ç±»å‹çš„æ•°æ®åº“ä¸€æ ·ï¼Œæˆ‘ä»¬å¸Œæœ›ç¡®ä¿å³ä½¿æŸäº›åº•å±‚èŠ‚ç‚¹å‘ç”Ÿæ•…éšœï¼ŒæŸ¥è¯¢ä¹Ÿèƒ½å°½å¿«æ‰§è¡Œã€‚è¿™å¯èƒ½æ˜¯ç”±äºç¡¬ä»¶æ•…éšœã€ç½‘ç»œæ•…éšœæˆ–å…¶ä»–ç±»å‹çš„æŠ€æœ¯é”™è¯¯é€ æˆçš„ã€‚è¿™ç§æ•…éšœå¯èƒ½å¯¼è‡´åœæœºï¼Œç”šè‡³æŸ¥è¯¢ç»“æœä¸æ­£ç¡®ã€‚\n\nä¸ºäº†ç¡®ä¿é«˜æ€§èƒ½å’Œå®¹é”™èƒ½åŠ›ï¼Œå‘é‡æ•°æ®åº“ä½¿ç”¨åˆ†ç‰‡å’Œå‰¯æœ¬ï¼š\n\n1. **åˆ†ç‰‡**ï¼šå°†æ•°æ®åˆ†ç‰‡ï¼Œå¹¶å­˜å‚¨åˆ°å¤šä¸ªèŠ‚ç‚¹ã€‚æœ‰ä¸åŒçš„æ–¹æ³•æ¥åˆ’åˆ†æ•°æ®ï¼Œä¾‹å¦‚å¯ä»¥é€šè¿‡ä¸åŒæ•°æ®ç°‡çš„ç›¸ä¼¼æ€§è¿›è¡Œåˆ†ç‰‡ï¼Œä»¥ä¾¿å°†ç›¸ä¼¼çš„å‘é‡å­˜å‚¨åœ¨åŒä¸€åˆ†ç‰‡ä¸­ã€‚å½“è¿›è¡ŒæŸ¥è¯¢æ—¶ï¼Œå®ƒä¼šè¢«å‘é€åˆ°æ‰€æœ‰åˆ†ç‰‡ï¼Œå¹¶æ£€ç´¢å’Œç»„åˆç»“æœã€‚è¿™ç§°ä¸ºâ€œåˆ†æ•£-èšé›†â€æ¨¡å¼ã€‚\n2. **å‰¯æœ¬**ï¼šè·¨ä¸åŒèŠ‚ç‚¹åˆ›å»ºæ•°æ®çš„å¤šä¸ªå‰¯æœ¬ã€‚è¿™ç¡®ä¿å³ä½¿ç‰¹å®šèŠ‚ç‚¹å‘ç”Ÿæ•…éšœï¼Œå…¶ä»–èŠ‚ç‚¹ä¹Ÿèƒ½å¤Ÿæ›¿ä»£å®ƒã€‚ä¸€è‡´æ€§æ¨¡å‹ä¸»è¦æœ‰ä¸¤ç§ï¼šæœ€ç»ˆä¸€è‡´æ€§å’Œå¼ºä¸€è‡´æ€§ã€‚æœ€ç»ˆä¸€è‡´æ€§å…è®¸ä¸åŒæ•°æ®å‰¯æœ¬ä¹‹é—´å‡ºç°ä¸´æ—¶ä¸ä¸€è‡´ï¼Œè¿™å°†æé«˜å¯ç”¨æ€§å¹¶å‡å°‘å»¶è¿Ÿï¼Œä½†å¯èƒ½ä¼šå¯¼è‡´å†²çªç”šè‡³æ•°æ®ä¸¢å¤±ï¼›å¼ºä¸€è‡´æ€§è¦æ±‚åœ¨å†™å…¥æ“ä½œè¢«è§†ä¸ºå®Œæˆä¹‹å‰æ›´æ–°æ‰€æœ‰æ•°æ®å‰¯æœ¬ï¼Œè¿™ç§æ–¹æ³•æä¾›äº†æ›´å¼ºçš„ä¸€è‡´æ€§ï¼Œä½†å¯èƒ½ä¼šå¯¼è‡´æ›´é«˜çš„å»¶è¿Ÿã€‚\n\n### ç›‘æ§\n\nä¸ºäº†æœ‰æ•ˆåœ°ç®¡ç†å’Œç»´æŠ¤å‘é‡æ•°æ®åº“ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªå¼ºå¤§çš„ç›‘æ§ç³»ç»Ÿæ¥è·Ÿè¸ªæ•°æ®åº“çš„æ€§èƒ½ã€å¥åº·çŠ¶å†µå’Œæ•´ä½“çŠ¶æ€ã€‚ç›‘æ§å¯¹äºå‘ç°æ½œåœ¨é—®é¢˜ã€ä¼˜åŒ–æ€§èƒ½å’Œç¡®ä¿ç”Ÿäº§é¡ºåˆ©è¿è¡Œè‡³å…³é‡è¦ã€‚ç›‘æ§å‘é‡æ•°æ®åº“çš„ä¸€äº›æ–¹é¢åŒ…æ‹¬ä»¥ä¸‹å†…å®¹ï¼š\n\n1. **èµ„æºä½¿ç”¨æƒ…å†µ**ï¼šç›‘è§†èµ„æºä½¿ç”¨æƒ…å†µï¼Œå¦‚ CPUã€å†…å­˜ã€ç£ç›˜ç©ºé—´å’Œç½‘ç»œæ´»åŠ¨ï¼Œå¯ä»¥è¯†åˆ«å¯èƒ½å½±å“æ•°æ®åº“æ€§èƒ½çš„æ½œåœ¨é—®é¢˜æˆ–èµ„æºé™åˆ¶ã€‚\n2. **æŸ¥è¯¢æ€§èƒ½**ï¼šæŸ¥è¯¢å»¶è¿Ÿã€ååé‡å’Œé”™è¯¯ç‡å¯èƒ½è¡¨æ˜éœ€è¦è§£å†³çš„æ½œåœ¨ç³»ç»Ÿé—®é¢˜ã€‚\n3. **ç³»ç»Ÿè¿è¡ŒçŠ¶å†µ**ï¼šæ•´ä¸ªç³»ç»Ÿå¥åº·çŠ¶å†µç›‘è§†åŒ…æ‹¬å„ä¸ªèŠ‚ç‚¹çš„çŠ¶æ€ã€å¤åˆ¶è¿‡ç¨‹å’Œå…¶ä»–å…³é”®ç»„ä»¶ã€‚\n\n### è®¿é—®æ§åˆ¶\n\nè®¿é—®æ§åˆ¶æ˜¯ç®¡ç†å’Œè§„èŒƒç”¨æˆ·å¯¹æ•°æ®å’Œèµ„æºçš„è®¿é—®çš„è¿‡ç¨‹ã€‚å®ƒæ˜¯æ•°æ®å®‰å…¨çš„é‡è¦ç»„æˆéƒ¨åˆ†ï¼Œç¡®ä¿åªæœ‰æˆæƒç”¨æˆ·æ‰èƒ½æŸ¥çœ‹ã€ä¿®æ”¹å‘é‡æ•°æ®åº“ä¸­å­˜å‚¨çš„æ•æ„Ÿæ•°æ®æˆ–ä¸ä¹‹äº¤äº’ã€‚\n\nè®¿é—®æ§åˆ¶å¾ˆé‡è¦ï¼ŒåŸå› å¦‚ä¸‹ï¼š\n\n1. **æ•°æ®ä¿æŠ¤**ï¼šç”±äºäººå·¥æ™ºèƒ½åº”ç”¨ç¨‹åºç»å¸¸å¤„ç†æ•æ„Ÿå’Œæœºå¯†ä¿¡æ¯ï¼Œå®æ–½ä¸¥æ ¼çš„è®¿é—®æ§åˆ¶æœºåˆ¶æœ‰åŠ©äºä¿æŠ¤æ•°æ®å…é­æœªç»æˆæƒçš„è®¿é—®å’Œæ½œåœ¨çš„æ³„éœ²ã€‚\n2. **åˆè§„æ€§**ï¼šè®¸å¤šè¡Œä¸šï¼Œä¾‹å¦‚åŒ»ç–—ä¿å¥å’Œé‡‘èï¼Œéƒ½å—åˆ°ä¸¥æ ¼çš„æ•°æ®éšç§æ³•è§„çš„çº¦æŸã€‚å®æ–½é€‚å½“çš„è®¿é—®æ§åˆ¶æœ‰åŠ©äºç»„ç»‡éµå®ˆè¿™äº›æ³•è§„ï¼Œä¿æŠ¤ä»–ä»¬å…å—æ³•å¾‹å’Œè´¢åŠ¡å½±å“ã€‚\n3. **é—®è´£åˆ¶å’Œå®¡è®¡**ï¼šè®¿é—®æ§åˆ¶æœºåˆ¶ä½¿ç»„ç»‡èƒ½å¤Ÿåœ¨å‘é‡æ•°æ®åº“ä¸­ç»´æŠ¤ç”¨æˆ·æ´»åŠ¨çš„è®°å½•ã€‚æ­¤ä¿¡æ¯å¯¹äºå®¡æ ¸ç›®çš„è‡³å…³é‡è¦ï¼Œå½“å‘ç”Ÿå®‰å…¨æ¼æ´æ—¶ï¼Œå®ƒæœ‰åŠ©äºè¿½è¸ªä»»ä½•æœªç»æˆæƒçš„è®¿é—®æˆ–ä¿®æ”¹ã€‚\n4. **å¯æ‰©å±•æ€§å’Œçµæ´»æ€§**ï¼šéšç€ç»„ç»‡çš„æˆé•¿å’Œå‘å±•ï¼Œä»–ä»¬çš„è®¿é—®æ§åˆ¶éœ€æ±‚å¯èƒ½ä¼šå‘ç”Ÿå˜åŒ–ã€‚å¼ºå¤§çš„è®¿é—®æ§åˆ¶ç³»ç»Ÿå…è®¸æ— ç¼ä¿®æ”¹å’Œæ‰©å±•ç”¨æˆ·æƒé™ï¼Œç¡®ä¿æ•°æ®å®‰å…¨åœ¨ç»„ç»‡çš„æ•´ä¸ªå‘å±•è¿‡ç¨‹ä¸­ä¿æŒå®Œæ•´ã€‚\n\n### å¤‡ä»½å’Œæ”¶è—\n\nå½“æ‰€æœ‰å…¶ä»–æ–¹æ³•éƒ½å¤±è´¥æ—¶ï¼Œå‘é‡æ•°æ®åº“æä¾›äº†ä¾èµ–å®šæœŸåˆ›å»ºå¤‡ä»½çš„èƒ½åŠ›ã€‚è¿™äº›å¤‡ä»½å¯ä»¥å­˜å‚¨åœ¨å¤–éƒ¨å­˜å‚¨ç³»ç»Ÿæˆ–åŸºäºäº‘çš„å­˜å‚¨æœåŠ¡ä¸Šï¼Œç¡®ä¿æ•°æ®çš„å®‰å…¨æ€§å’Œå¯æ¢å¤æ€§ã€‚å¦‚æœå‘ç”Ÿæ•°æ®ä¸¢å¤±æˆ–æŸåï¼Œè¿™äº›å¤‡ä»½å¯ç”¨äºå°†æ•°æ®åº“æ¢å¤åˆ°ä¹‹å‰çš„çŠ¶æ€ï¼Œä»è€Œæœ€å¤§é™åº¦åœ°å‡å°‘åœæœºæ—¶é—´å’Œå¯¹æ•´ä¸ªç³»ç»Ÿçš„å½±å“ã€‚\n\n### API å’Œ SDKs\n\nè¿™å°±æ˜¯æ©¡èƒ¶ä¸é“è·¯ç›¸é‡çš„åœ°æ–¹ï¼šä¸æ•°æ®åº“äº¤äº’çš„å¼€å‘äººå‘˜å¸Œæœ›é€šè¿‡æ˜“äºä½¿ç”¨çš„ APIã€ä½¿ç”¨ç†Ÿæ‚‰ä¸”èˆ’é€‚çš„å·¥å…·é›†æ¥å®Œæˆæ­¤æ“ä½œã€‚é€šè¿‡æä¾›ç”¨æˆ·å‹å¥½çš„ç•Œé¢ï¼Œå‘é‡æ•°æ®åº“ API å±‚ç®€åŒ–äº†é«˜æ€§èƒ½å‘é‡æœç´¢åº”ç”¨ç¨‹åºçš„å¼€å‘ã€‚\n\né™¤äº† API ä¹‹å¤–ï¼Œå‘é‡æ•°æ®åº“é€šå¸¸è¿˜ä¼šæä¾›åŒ…è£… API çš„ç‰¹å®šäºç¼–ç¨‹è¯­è¨€çš„ SDKã€‚SDK ä½¿å¼€å‘äººå‘˜å¯ä»¥æ›´è½»æ¾åœ°åœ¨åº”ç”¨ç¨‹åºä¸­ä¸æ•°æ®åº“è¿›è¡Œäº¤äº’ã€‚è¿™ä½¿å¾—å¼€å‘äººå‘˜èƒ½å¤Ÿä¸“æ³¨äºä»–ä»¬çš„ç‰¹å®šç”¨ä¾‹ï¼Œä¾‹å¦‚è¯­ä¹‰æ–‡æœ¬æœç´¢ã€ç”Ÿæˆé—®ç­”ã€æ··åˆæœç´¢ã€å›¾åƒç›¸ä¼¼æ€§æœç´¢æˆ–äº§å“æ¨èï¼Œè€Œä¸å¿…æ‹…å¿ƒåº•å±‚åŸºç¡€è®¾æ–½çš„å¤æ‚æ€§ã€‚\n\n## æ¦‚å†µ\n\nå‘é‡åµŒå…¥åœ¨è‡ªç„¶è¯­è¨€å¤„ç†ã€è®¡ç®—æœºè§†è§‰å’Œå…¶ä»–äººå·¥æ™ºèƒ½åº”ç”¨ç­‰é¢†åŸŸå‘ˆæŒ‡æ•°çº§å¢é•¿ï¼Œå¯¼è‡´äº†å‘é‡æ•°æ®åº“ä½œä¸ºè®¡ç®—å¼•æ“çš„å‡ºç°ï¼Œä½¿æˆ‘ä»¬èƒ½å¤Ÿä¸åº”ç”¨ç¨‹åºä¸­çš„å‘é‡åµŒå…¥è¿›è¡Œæœ‰æ•ˆäº¤äº’ã€‚\n\nå‘é‡æ•°æ®åº“æ˜¯ä¸“é—¨ç”¨æ¥å¤„ç†ç”Ÿäº§åœºæ™¯ä¸­ç®¡ç†å‘é‡åµŒå…¥æ—¶å‡ºç°çš„é—®é¢˜çš„æ•°æ®åº“ã€‚å› æ­¤ï¼Œä¸ä¼ ç»Ÿçš„åŸºäºæ ‡é‡çš„æ•°æ®åº“å’Œç‹¬ç«‹çš„å‘é‡ç´¢å¼•ç›¸æ¯”ï¼Œå®ƒä»¬å…·æœ‰æ˜æ˜¾çš„ä¼˜åŠ¿ã€‚\n\nåœ¨è¿™ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬å›é¡¾äº†å‘é‡æ•°æ®åº“çš„å…³é”®æ–¹é¢ï¼ŒåŒ…æ‹¬å®ƒçš„å·¥ä½œåŸç†ã€å®ƒä½¿ç”¨çš„ç®—æ³•ä»¥åŠä½¿å…¶ä¸ºç”Ÿäº§åœºæ™¯åšå¥½æ“ä½œå‡†å¤‡çš„é™„åŠ åŠŸèƒ½ã€‚æˆ‘ä»¬å¸Œæœ›è¿™å¯ä»¥å¸®åŠ©æ‚¨äº†è§£å‘é‡æ•°æ®åº“çš„å†…éƒ¨å·¥ä½œåŸç†ã€‚\n\n## å‚è€ƒé“¾æ¥\n- <a href=\"https://www.pinecone.io/learn/vector-database/\">What is a Vector Database?</a>\n","tags":["å‘é‡æ•°æ®åº“"]},{"title":"pycharm-2023.1 closing project window stuck","url":"/2023/09/11/2023-09-11-pycharm-2023.1 closing project stuck/","content":"\n## é—®é¢˜æè¿°\n\npycharm åˆ‡æ¢é¡¹ç›®/é‡å¯ï¼Œä¸€ç›´å¡åœ¨ closing project\n\n## åŸå› åˆ†æ\n\nhttps://youtrack.jetbrains.com/issue/PY-59980/PyCharm-2023.1-issue-closing-project-window-stuck-PyPIPackageUtil.lambdaparsePyPIListFromWeb\n\n## è§£å†³æ–¹æ¡ˆ\n\n1. å‡çº§ pycharm åˆ° 2023.3\n2. pycharm ä¸»é¡µ HELP -> Find Action -> è¾“å…¥ Registry -> ç¦ç”¨ ide.await.scope.completion","tags":["é‚£äº›å¹´é‡åˆ°çš„å‘"],"categories":["pycharm"]},{"title":"yum å¡ä½","url":"/2023/08/31/2023-08-31-yumå¡ä½/","content":"\n## é—®é¢˜æè¿°\n\næ‰§è¡Œ yum å¡ä½ï¼ŒCtrl + c ä¹Ÿé€€ä¸å‡ºæ¥\nåªèƒ½ kill -9 é€€å‡º\n\n## åŸå› åˆ†æ\n\nåœ¨Linuxä¸­ï¼Œé€šè¿‡rpm/yumå®‰è£…åº”ç”¨æ—¶æ²¡æœ‰ä»»ä½•å“åº”ï¼Œæ‰§è¡Œâ€œps -ef | grep rpmâ€å‘ç°ä¹‹å‰æ‰§è¡Œè¿‡çš„rpm/yumå‘½ä»¤å…¨è¢«æŒ‚èµ·ï¼Œæ•…éšœåŸå› æ˜¯rpmæ•°æ®åº“å¼‚å¸¸ï¼Œè§£å†³æ–¹æ³•æ˜¯é‡å»ºrpmæ•°æ®åº“ã€‚\n\n## è§£å†³æ–¹æ¡ˆ\n\n```bash\n# åˆ é™¤rpmæ•°æ®åº“\nrm -f /var/lib/rpm/__db.00*\n\n# é‡å»ºrpmæ•°æ®åº“\nrpm -vv --rebuilddb\n\n# æ¸…ç†yumèµ„æºé”\nrm -f /var/lib/rpm/.rpm.lock\nrm -f /var/lib/rpm/.dbenv.lock\n\n# æ¸…ç†yumç¼“å­˜\nyum clean all\n# æˆ–åˆ é™¤cacheç›®å½•\n# rm -rf /var/cache/yum/*\n```","tags":["linux","é‚£äº›å¹´é‡åˆ°çš„å‘"]},{"title":"è™šæ‹Ÿæœº Linux ä½¿ç”¨ perf stat æç¤º cycles not supported","url":"/2023/07/07/2023-07-07-perf_staté—®é¢˜/","content":"\n## é—®é¢˜æè¿°\n\né¡¹ç›®å¸Œæœ›è¯„ä¼°ç®—æ³•çš„ CPU å¼€é”€ï¼Œä½¿ç”¨ linux å¸¸ç”¨çš„ perf å·¥å…·ã€‚\næŸ¥çœ‹ perf stat åªæ˜¾ç¤º cpu-clock, context-switches, cpu-migrations\nå‰©ä½™ cycles, instructions, branches, branch-misses å‡ä¸º not supported\n\n![problem_test](/img/2023-07-07-perf_staté—®é¢˜/pho1.jpg)\n\n## åŸå› åˆ†æ\nè¯¥å‚æ•°ä½¿ç”¨ç‰©ç†æœºå¯æµ‹é‡ï¼ŒçŒœæµ‹é—®é¢˜å‡ºåœ¨è™šæ‹ŸåŒ–ã€‚\n\n## è§£å†³æ–¹æ¡ˆ\nå…³é—­ VMware è™šæ‹Ÿæœºç”µæºï¼Œæ‰¾åˆ°ç¡¬ä»¶é…ç½®é€‰é¡¹ä¸­ CPU\n\nå‹¾é€‰â˜‘ï¸è™šæ‹ŸåŒ–CPUæ€§èƒ½è®¡æ•°å™¨é‡å¯é—®é¢˜è§£å†³","tags":["linux","æ€§èƒ½æµ‹è¯•","perf"]},{"title":"æµè§ˆå™¨ä¸­å¦‚ä½•å¿«é€Ÿä¸‹è½½SVGå›¾ç‰‡","url":"/2023/07/07/2023-07-07-æµè§ˆå™¨å¦‚ä½•å¿«é€Ÿä¸‹è½½svgå›¾ç‰‡/","content":"\n## æ“ä½œæ­¥éª¤\n\n### 1. å³å‡»æµè§ˆå™¨é¡µé¢ï¼Œé€‰æ‹©æ£€æŸ¥ï¼Œæ‰“å¼€æµè§ˆå™¨çš„è°ƒè¯•å·¥å…·ã€‚æ‰¾åˆ°ä½ æƒ³ä¸‹è½½çš„ svg å›¾ç‰‡çš„ xmnlsï¼Œå¤åˆ¶å…ƒç´ ã€‚\n\n![svg1](/img/2023-07-07-æµè§ˆå™¨å¦‚ä½•å¿«é€Ÿä¸‹è½½svgå›¾ç‰‡/svg1.jpg)\n\n### 2. æ–°å»º txt æ–‡ä»¶ï¼Œå°†åˆšæ‰å¤åˆ¶çš„å…ƒç´ å¤åˆ¶åˆ°æ–‡æœ¬ä¸­ï¼Œæ›´æ”¹æ–‡ä»¶åç¼€ä¸º svg å³å¯ã€‚\n\n**æ³¨æ„ï¼š**\n\næœ‰çš„ svg å…ƒç´ æŠ¥é”™ä¸‹æ¥å¯èƒ½åªæœ‰ idï¼Œæ²¡æœ‰ xmlns=\"http://www.w3.org/2000/svg\" è¿™æ®µä»£ç \n\næ­¤æ—¶ï¼Œéœ€è¦å°†åŒ…å« id çš„æ•´æ®µä»£ç ï¼Œæ›´æ¢ä¸º xmlns=\"http://www.w3.org/2000/svg\"","tags":["æ€§èƒ½æµ‹è¯•","ç«ç„°å›¾"],"categories":["æ€§èƒ½æµ‹è¯•"]},{"title":"æ€§èƒ½æµ‹è¯•â€”â€”ç«ç„°å›¾","url":"/2023/07/07/2023-07-07-ç«ç„°å›¾/","content":"\n## 0. perf ç®€ä»‹\n\nPerf æ˜¯ä¸€ä¸ªç”¨äºè®¿é—®å¤„ç†å™¨æ€§èƒ½ç›‘è§†å•å…ƒ (PMU) ä»¥åŠè®°å½•å’Œæ˜¾ç¤ºè½¯ä»¶äº‹ä»¶ï¼ˆä¾‹å¦‚é¡µé”™è¯¯ï¼‰çš„ç•Œé¢ã€‚å®ƒæ”¯æŒç³»ç»ŸèŒƒå›´çš„ç›‘è§†ã€æŒ‰çº¿ç¨‹çš„ç›‘è§†å’Œ KVM è™šæ‹ŸåŒ– Guest ç›‘è§†ã€‚\n\nå¯ä»¥åœ¨æŠ¥å‘Šä¸­å‚¨å­˜ç”Ÿæˆçš„ä¿¡æ¯ã€‚ä¾‹å¦‚ï¼Œæ­¤æŠ¥å‘ŠåŒ…å«æœ‰å…³æŒ‡ä»¤æŒ‡é’ˆçš„ä¿¡æ¯ï¼Œæˆ–çº¿ç¨‹æ‰§è¡Œçš„ä»£ç çš„ä¿¡æ¯ã€‚\n\nPerf ç”±ä¸¤éƒ¨åˆ†ç»„æˆï¼š\n<ul>\n  <li>é›†æˆåˆ° Linux å†…æ ¸çš„ä»£ç ï¼Œè´Ÿè´£å‘ç¡¬ä»¶å‘å‡ºæŒ‡ä»¤ã€‚</li>\n  <li>perf ç”¨æˆ·ç©ºé—´å®ç”¨ç¨‹åºï¼Œå¯è®©æ‚¨ä½¿ç”¨å†…æ ¸ä»£ç å¹¶å¸®åŠ©æ‚¨åˆ†ææ”¶é›†çš„æ•°æ®ã€‚</li>\n</ul>\n\n## 1. å®‰è£… perf\n\n```bash\ncat /etc/redhat-release\nCentOS Linux release 7.6.1810 (Core)\n\nsudo yum install perf\n...\n```\n\n## 2. perf çš„ä½¿ç”¨\n\n### 2.1 perf åˆ†ææµç¨‹\n\nPerf è¿›è¡Œæ€§èƒ½åˆ†æçš„æ–¹å¼é€šå¸¸æœ‰ä¸¤ç§ï¼š\n\n<ul>\n  <li>ä½¿ç”¨ perf stat ç­‰å‘½ä»¤å¯¹ç‰¹å®šçš„äº‹ä»¶è®¡æ•°å™¨è¿›è¡Œè®¡ç®—ï¼Œå¹¶åœ¨ç¨‹åºç»“æŸåæ‰“å°æ•°å€¼</li>\n  <li>ä½¿ç”¨ perf record ç­‰å‘½ä»¤ä»¥è‹¥å¹²çš„äº‹ä»¶ä¸ºè§¦å‘é—´éš”å¯¹ç³»ç»Ÿè¿›è¡Œé‡‡æ ·ï¼Œå°†æ•°æ®ä¿å­˜è‡³ perf.data æ–‡ä»¶ä»¥ä¾›åç»­åˆ†æ</li>\n  <li>ä¹Ÿå°±æ˜¯è¯´ï¼Œperf stat å‘½ä»¤åªèƒ½è®°å½•äº‹ä»¶å‘ç”Ÿçš„æ¬¡æ•°ï¼Œperf record åœ¨æ­¤åŸºç¡€ä¹‹ä¸Šå¯ä»¥è®°å½•äº‹ä»¶å‘ç”Ÿæ—¶è¯¦ç»†çš„æ•°æ®(æ¯”å¦‚ IPã€å †æ ˆç­‰ç­‰)ã€‚</li>\n</ul>\n\nperf record æµç¨‹å›¾ï¼š\n\n![perf record æµç¨‹å›¾](/img/2023-07-07-ç«ç„°å›¾/perf_record.png)\n\nåœ¨è™šæ‹Ÿæœºä¸Šæ¼”ç¤ºï¼š\n```bash\nperf stat ls\n\n Performance counter stats for 'ls':\n\n          1.643793      task-clock (msec)         #    0.750 CPUs utilized\n                 0      context-switches          #    0.000 K/sec\n                 0      cpu-migrations            #    0.000 K/sec\n               265      page-faults               #    0.161 M/sec\n   <not supported>      cycles\n   <not supported>      instructions\n   <not supported>      branches\n   <not supported>      branch-misses\n\n       0.002190790 seconds time elapsed\n\nperf record ls\nperf.data\n[ perf record: Woken up 1 times to write data ]\n[ perf record: Captured and wrote 0.016 MB perf.data (7 samples) ]\n```\n\n## 2.2 perf äº‹ä»¶æ”¯æŒ\n\né€šè¿‡ perf list å¯ä»¥æŸ¥çœ‹å½“å‰æ”¯æŒçš„æ‰€æœ‰æ—¶é—´åŒ…æ‹¬ç¡¬ä»¶äº‹ä»¶ã€è½¯ä»¶äº‹ä»¶ã€ç¡¬ä»¶cacheäº‹ä»¶ã€PMUäº‹ä»¶ä»¥åŠé¢„è®¾Tracepointäº‹ä»¶\n\n![perf list](/img/2023-07-07-ç«ç„°å›¾/perf_2.png)\n\n## 2.3 perf statï¼ˆç»Ÿè®¡ç‰¹å®šç±»å‹çš„äº‹ä»¶ï¼‰\n\nè¦ç»Ÿè®¡æŸä¸ªäº‹ä»¶ï¼ˆä¾‹å¦‚ perf list æ˜¾ç¤ºçš„äº‹ä»¶ï¼‰çš„å‘ç”Ÿæ¬¡æ•°ï¼Œè¯·ä½¿ç”¨ï¼š\n\n```bash\nperf stat -e EVENT -a\n```\n\nè¦ä¸€æ¬¡æ€§ç»Ÿè®¡å¤šç§ç±»å‹çš„äº‹ä»¶ï¼Œè¯·åˆ—å‡ºè¿™äº›äº‹ä»¶å¹¶ä»¥é€—å·åˆ†éš”ã€‚ä¾‹å¦‚ï¼Œè¦ç»Ÿè®¡ cpu-cycles å’Œ instructionsï¼Œè¯·ä½¿ç”¨ï¼š\n\n```bash\nperf stat -e cpu-cycles,instructions -a\n```\n\nè¦åœæ­¢ä¼šè¯ï¼Œè¯·æŒ‰ Ctrl+Cã€‚\n\nè¿˜å¯ä»¥ç»Ÿè®¡æŸä¸ªäº‹ä»¶åœ¨ç‰¹å®šæ—¶é—´èŒƒå›´å†…å‘ç”Ÿçš„æ¬¡æ•°ï¼š\n\n```bash\nperf stat -e EVENT -a -- sleep TIME\n```\n\nè¯·å°† TIME æ›¿æ¢ä¸ºä»¥ç§’ä¸ºå•ä½çš„å€¼ã€‚\n\n## 2.4 perf recordï¼ˆè®°å½•ç‰¹å®šäºç‰¹å®šå‘½ä»¤çš„äº‹ä»¶ï¼‰\n\n1ã€å¯é€šè¿‡å„ç§æ–¹å¼æ¥å¯¹ç‰¹å®šäºç‰¹å®šå‘½ä»¤çš„äº‹ä»¶é‡‡æ ·ï¼š\n\n1ï¼‰è¦åˆ›å»ºæ–°è°ƒç”¨çš„å‘½ä»¤çš„æŠ¥å‘Šï¼Œè¯·ä½¿ç”¨ï¼š\n\n```bash\nperf record COMMAND\n```\n\nç„¶åæ­£å¸¸ä½¿ç”¨å¯åŠ¨çš„è¿›ç¨‹ã€‚é€€å‡ºè¯¥è¿›ç¨‹æ—¶ï¼ŒPerf ä¼šè¯ä¹Ÿä¼šåœæ­¢ã€‚\n\n2ï¼‰è¦åœ¨è¿è¡Œæ–°è°ƒç”¨çš„å‘½ä»¤æ—¶åˆ›å»ºæ•´ä¸ªç³»ç»Ÿçš„æŠ¥å‘Šï¼Œè¯·ä½¿ç”¨ï¼š\n\n```bash\nperf record -a COMMAND\n```\n\n3ï¼‰è¦åˆ›å»ºå·²è¿è¡Œçš„è¿›ç¨‹çš„æŠ¥å‘Šï¼Œè¯·ä½¿ç”¨ï¼š\n\n```bash\nperf record -p PID\n```\n\nè¯·å°† PID æ›¿æ¢ä¸ºè¿›ç¨‹ IDã€‚è¦åœæ­¢ä¼šè¯ï¼Œè¯·æŒ‰ Ctrlâ€“Cã€‚\n\n2ã€ç°åœ¨ï¼Œå¯ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤æŸ¥çœ‹æ”¶é›†åˆ°çš„æ•°æ® (perf.data)ï¼š\n\n```bash\nperf report\n```\n\nè¿™ä¼šæ‰“å¼€ä¸€ä¸ªä¼ªå›¾å½¢ç•Œé¢ã€‚è¦è·å¾—å¸®åŠ©ï¼Œè¯·æŒ‰ Hã€‚è¦é€€å‡ºï¼Œè¯·æŒ‰ Qã€‚\n\n3ã€å¦‚æœæ‚¨åå‘äºä½¿ç”¨å›¾å½¢ç•Œé¢ï¼Œè¯·å°è¯• Perf çš„ GTK+ ç•Œé¢ï¼š\n\n```bash\nperf report --gtk\n```\n\nä½†è¯·æ³¨æ„ï¼ŒGTK+ ç•Œé¢çš„åŠŸèƒ½å¾ˆæœ‰é™ã€‚\n\n## ç«ç„°å›¾\n\nç«ç„°å›¾æ˜¯ç”¨å›¾å½¢åŒ–çš„æ–¹å¼æ¥å±•ç°perfç­‰å·¥å…·é‡‡é›†çš„æ€§èƒ½æ•°æ®ï¼Œå¯¹æ•°æ®è¿›è¡Œç»Ÿè®¡å’Œåˆ†æï¼Œæ–¹ä¾¿æ‰¾å‡ºæ€§èƒ½çƒ­ç‚¹ã€‚\n\n```bash\ngit clone https://github.com/brendangregg/FlameGraph.git\n```\n\nåœ¨ <a herf=\"https://github.com/brendangregg/FlameGraph.git\">GitHub é¡¹ç›®ï¼šFlameGraph</a> ä¸»é¡µæœ‰ç”Ÿæˆç«ç„°å›¾çš„è¯¦ç»†è¯´æ˜ã€‚\n\nå…‹éš†é¡¹ç›®ï¼š\n```bash\ngit clone https://github.com/brendangregg/FlameGraph.git\n```\n\n![FlameGraph list](/img/2023-07-07-ç«ç„°å›¾/perf_3.png)\n\n## ä¸€ä¸ªå®ä¾‹ï¼š\n\n### 1.st ç”Ÿæˆ perf.data\n```bash\nperf record -F 99 -a -g -- sleep 60 \n\nä¸Šè¿°ä»£ç ä¸­ perf record è¡¨ç¤ºè®°å½•ï¼Œ\n-F 99 è¡¨ç¤ºæ¯ç§’99æ¬¡ï¼Œ\n-p 13204 æ˜¯è¿›ç¨‹å·ï¼Œå³å¯¹å“ªä¸ªè¿›ç¨‹è¿›è¡Œåˆ†æï¼Œ\n-g è¡¨ç¤ºè®°å½•è°ƒç”¨æ ˆï¼Œ\nsleep 30 åˆ™æ˜¯æŒç»­30ç§’ï¼Œ-a è¡¨ç¤ºè®°å½•æ‰€æœ‰cpuè°ƒç”¨ã€‚æ›´å¤šå‚æ•°å¯ä»¥æ‰§è¡Œ\n```\n\nè¿™æ¡æŒ‡ä»¤çš„æ„æ€æ˜¯ï¼Œå¯¹CPUæ‰€æœ‰è¿›ç¨‹ä»¥ 99Hz é‡‡é›†,å®ƒçš„æ‰§è¡Œé¢‘ç‡æ˜¯ 99Hzï¼ˆæ¯ç§’99æ¬¡ï¼‰ï¼Œå¦‚æœ 99 æ¬¡éƒ½è¿”å›åŒä¸€ä¸ªå‡½æ•°åï¼Œé‚£å°±è¯´æ˜ CPU è¿™ä¸€ç§’é’Ÿéƒ½åœ¨æ‰§è¡ŒåŒä¸€ä¸ªå‡½æ•°ï¼Œå¯èƒ½å­˜åœ¨æ€§èƒ½é—®é¢˜ã€‚æ‰§è¡Œ60ç§’åä¼šå¼¹å‡ºå¦‚ä¸‹å›¾æç¤ºè¡¨ç¤ºé‡‡é›†å®Œæˆï¼Œåœ¨å½“å‰ç›®å½•ä¼šç”Ÿæˆä¸€ä¸ªperf.dataçš„æ–‡ä»¶ã€‚\n\nperf.data æ–‡ä»¶ç”Ÿæˆåï¼Œè¡¨ç¤ºé‡‡é›†å®Œæˆã€‚**æœ€å¥½æ˜¯åœ¨ç«ç„°å›¾çš„ç›®å½•ä¸‹è¿›è¡Œé‡‡é›†ï¼Œæ–¹ä¾¿è½¬æ¢æˆSVGå›¾å½¢ã€‚**\n\n### 2.st ç”Ÿæˆç«ç„°å›¾\n\n```bash\n//ç”Ÿæˆè„šæœ¬æ–‡ä»¶\nperf script -i perf.data &> perf.unfold\n\n//ç”Ÿæˆç«ç‚¬å›¾\n./FlameGraph/stackcollapse-perf.pl perf.unfold &> perf.folded\n./FlameGraph/flamegraph.pl perf.folded > perf.svg\n```\n\næ‰§è¡Œå®Œæˆåç”Ÿæˆ perf.svg å›¾ç‰‡ï¼Œå¯ä»¥ä¸‹è½½åˆ°æœ¬åœ°ï¼Œç”¨æµè§ˆå™¨æ‰“å¼€ perf.svgï¼Œå¦‚ä¸‹å›¾\n\n![perf.svg](/img/2023-07-07-ç«ç„°å›¾/perf_4.png)\n\n## ç«ç„°å›¾çš„å«ä¹‰\n\nç«ç„°å›¾æ˜¯åŸºäº perf ç»“æœäº§ç”Ÿçš„ SVG å›¾ç‰‡ï¼Œç”¨æ¥å±•ç¤º CPU çš„è°ƒç”¨æ ˆã€‚\n\n![perf_5.svg](/img/2023-07-07-ç«ç„°å›¾/perf_5.svg)\n\ny è½´è¡¨ç¤ºè°ƒç”¨æ ˆï¼Œæ¯ä¸€å±‚éƒ½æ˜¯ä¸€ä¸ªå‡½æ•°ã€‚è°ƒç”¨æ ˆè¶Šæ·±ï¼Œç«ç„°å°±è¶Šé«˜ï¼Œé¡¶éƒ¨å°±æ˜¯æ­£åœ¨æ‰§è¡Œçš„å‡½æ•°ï¼Œä¸‹æ–¹éƒ½æ˜¯å®ƒçš„çˆ¶å‡½æ•°ã€‚\n\nx è½´è¡¨ç¤ºæŠ½æ ·æ•°ï¼Œå¦‚æœä¸€ä¸ªå‡½æ•°åœ¨ x è½´å æ®çš„å®½åº¦è¶Šå®½ï¼Œå°±è¡¨ç¤ºå®ƒè¢«æŠ½åˆ°çš„æ¬¡æ•°å¤šï¼Œå³æ‰§è¡Œçš„æ—¶é—´é•¿ã€‚æ³¨æ„ï¼Œx è½´ä¸ä»£è¡¨æ—¶é—´ï¼Œè€Œæ˜¯æ‰€æœ‰çš„è°ƒç”¨æ ˆåˆå¹¶åï¼ŒæŒ‰å­—æ¯é¡ºåºæ’åˆ—çš„ã€‚\n\nç«ç„°å›¾å°±æ˜¯çœ‹é¡¶å±‚çš„å“ªä¸ªå‡½æ•°å æ®çš„å®½åº¦æœ€å¤§ã€‚åªè¦æœ‰\"å¹³é¡¶\"ï¼ˆplateausï¼‰ï¼Œå°±è¡¨ç¤ºè¯¥å‡½æ•°å¯èƒ½å­˜åœ¨æ€§èƒ½é—®é¢˜ã€‚\n\né¢œè‰²æ²¡æœ‰ç‰¹æ®Šå«ä¹‰ï¼Œå› ä¸ºç«ç„°å›¾è¡¨ç¤ºçš„æ˜¯ CPU çš„ç¹å¿™ç¨‹åº¦ï¼Œæ‰€ä»¥ä¸€èˆ¬é€‰æ‹©æš–è‰²è°ƒã€‚\n\n## å·®åˆ†ç«ç„°å›¾\n\n\n```bash\n# ç¬¬ä¸€æ¬¡Profilingç»“æœ\nperf record -ag -F 999 -- sleep 20\nperf script -i perf.data &> A.stacks\n# ç¬¬äºŒæ¬¡Profilingç»“æœ\nperf record -ag -F 999 -- sleep 20\nperf script -i perf.data &> B.stacks\n# ä¸‹è½½FlameGraphä»“åº“\ngit clone --depth 1 http://github.com/brendangregg/FlameGraph \n# æŠ˜å A.stackså’ŒB.stacks\n./FlameGraph/stackcollapse-perf.pl A.stacks &> A.folded\n./FlameGraph/stackcollapse-perf.pl B.stacks &> B.folded\n# åŸºäºæŠ˜å ç»“æœåšå·®\n./FlameGraph/difffolded.pl A.folded B.folded > diff.folded\n# ç”Ÿæˆå·®åˆ†ç«ç„°å›¾\n./FlameGraph/flamegraph.pl diff.folded > diff.svg\n```\n\nå‚è€ƒèµ„æ–™ï¼š\n<ul>\n  <li>\n    <a href=\"https://documentation.suse.com/zh-cn/sles/15-SP3/html/SLES-all/cha-perf.html\">ä½¿ç”¨ Perf è¿›è¡ŒåŸºäºç¡¬ä»¶çš„æ€§èƒ½ç›‘è§†</a>\n    </li>\n  <li>\n    <a href=\"https://yoc.docs.t-head.cn/linuxbook/Chapter4/perf.html\">Perf ä½¿ç”¨è¯´æ˜</a>\n  </li>\n  <li>\n    <a href=\"https://www.cnblogs.com/wx170119/p/11459995.html\">ç«ç„°å›¾ï¼ˆFlame Graphsï¼‰çš„å®‰è£…å’ŒåŸºæœ¬ç”¨æ³•</a>\n  </li>\n  <li>\n    <a href=\"https://zhuanlan.zhihu.com/p/639996512\">å·®åˆ†ç«ç„°å›¾ï¼Œè®©ä½ çš„ä»£ç ä¼˜åŒ–éªŒè¯äº‹åŠåŠŸå€</a>\n  </li>\n</ul>","tags":["æ€§èƒ½æµ‹è¯•","ç«ç„°å›¾","pref"]},{"title":"å¯»æ‰¾ä¸€ç§æ˜“äºç†è§£çš„ä¸€è‡´æ€§ç®—æ³•ï¼ˆæ‰©å±•ç‰ˆï¼‰","url":"/2023/06/25/2023-06-25-raft-zh_cn/","content":"\n## æ‘˜è¦\n\nRaft æ˜¯ä¸€ç§ä¸ºäº†ç®¡ç†å¤åˆ¶æ—¥å¿—çš„ä¸€è‡´æ€§ç®—æ³•ã€‚å®ƒæä¾›äº†å’Œ Paxos ç®—æ³•ç›¸åŒçš„åŠŸèƒ½å’Œæ€§èƒ½ï¼Œä½†æ˜¯å®ƒçš„ç®—æ³•ç»“æ„å’Œ Paxos ä¸åŒï¼Œä½¿å¾— Raft ç®—æ³•æ›´åŠ å®¹æ˜“ç†è§£å¹¶ä¸”æ›´å®¹æ˜“æ„å»ºå®é™…çš„ç³»ç»Ÿã€‚ä¸ºäº†æå‡å¯ç†è§£æ€§ï¼ŒRaft å°†ä¸€è‡´æ€§ç®—æ³•åˆ†è§£æˆäº†å‡ ä¸ªå…³é”®æ¨¡å—ï¼Œä¾‹å¦‚é¢†å¯¼äººé€‰ä¸¾ã€æ—¥å¿—å¤åˆ¶å’Œå®‰å…¨æ€§ã€‚åŒæ—¶å®ƒé€šè¿‡å®æ–½ä¸€ä¸ªæ›´å¼ºçš„ä¸€è‡´æ€§æ¥å‡å°‘éœ€è¦è€ƒè™‘çš„çŠ¶æ€çš„æ•°é‡ã€‚ä¸€é¡¹ç”¨æˆ·ç ”ç©¶çš„ç»“æœè¡¨æ˜ï¼Œå¯¹äºå­¦ç”Ÿè€Œè¨€ï¼ŒRaft ç®—æ³•æ¯” Paxos ç®—æ³•æ›´åŠ å®¹æ˜“å­¦ä¹ ã€‚Raft ç®—æ³•è¿˜åŒ…æ‹¬ä¸€ä¸ªæ–°çš„æœºåˆ¶æ¥å…è®¸é›†ç¾¤æˆå‘˜çš„åŠ¨æ€æ”¹å˜ï¼Œå®ƒåˆ©ç”¨é‡å çš„å¤§å¤šæ•°æ¥ä¿è¯å®‰å…¨æ€§ã€‚\n\n## 1 ä»‹ç»\n\nä¸€è‡´æ€§ç®—æ³•å…è®¸ä¸€ç»„æœºå™¨åƒä¸€ä¸ªæ•´ä½“ä¸€æ ·å·¥ä½œï¼Œå³ä½¿å…¶ä¸­ä¸€äº›æœºå™¨å‡ºç°æ•…éšœä¹Ÿèƒ½å¤Ÿç»§ç»­å·¥ä½œä¸‹å»ã€‚æ­£å› ä¸ºå¦‚æ­¤ï¼Œä¸€è‡´æ€§ç®—æ³•åœ¨æ„å»ºå¯ä¿¡èµ–çš„å¤§è§„æ¨¡è½¯ä»¶ç³»ç»Ÿä¸­æ‰®æ¼”ç€é‡è¦çš„è§’è‰²ã€‚åœ¨è¿‡å»çš„ 10 å¹´é‡Œï¼ŒPaxos ç®—æ³•ç»Ÿæ²»ç€ä¸€è‡´æ€§ç®—æ³•è¿™ä¸€é¢†åŸŸï¼šç»å¤§å¤šæ•°çš„å®ç°éƒ½æ˜¯åŸºäº Paxos æˆ–è€…å—å…¶å½±å“ã€‚åŒæ—¶ Paxos ä¹Ÿæˆä¸ºäº†æ•™å­¦é¢†åŸŸé‡Œè®²è§£ä¸€è‡´æ€§é—®é¢˜æ—¶çš„ç¤ºä¾‹ã€‚\n\nä½†æ˜¯ä¸å¹¸çš„æ˜¯ï¼Œå°½ç®¡æœ‰å¾ˆå¤šå·¥ä½œéƒ½åœ¨å°è¯•é™ä½å®ƒçš„å¤æ‚æ€§ï¼Œä½†æ˜¯ Paxos ç®—æ³•ä¾ç„¶ååˆ†éš¾ä»¥ç†è§£ã€‚å¹¶ä¸”ï¼ŒPaxos è‡ªèº«çš„ç®—æ³•ç»“æ„éœ€è¦è¿›è¡Œå¤§å¹…çš„ä¿®æ”¹æ‰èƒ½å¤Ÿåº”ç”¨åˆ°å®é™…çš„ç³»ç»Ÿä¸­ã€‚å› æ­¤å·¥ä¸šç•Œå’Œå­¦æœ¯ç•Œéƒ½å¯¹ Paxos ç®—æ³•æ„Ÿåˆ°ååˆ†å¤´ç–¼ã€‚\n\nåŠªåŠ›ç ”ç©¶è¿‡ Paxos ç®—æ³•ä¹‹åï¼Œæˆ‘ä»¬å¼€å§‹å¯»æ‰¾ä¸€ç§æ–°çš„ä¸€è‡´æ€§ç®—æ³•ï¼Œå¯ä»¥ä¸ºæ„å»ºå®é™…çš„ç³»ç»Ÿå’Œæ•™å­¦æä¾›æ›´å¥½çš„åŸºç¡€ã€‚ä¸ Paxos ä¸åŒï¼Œæˆ‘ä»¬çš„é¦–è¦ç›®æ ‡æ˜¯å¯ç†è§£æ€§ï¼šæˆ‘ä»¬æ˜¯å¦å¯ä»¥åœ¨å®é™…ç³»ç»Ÿä¸­å®šä¹‰ä¸€ä¸ªä¸€è‡´æ€§ç®—æ³•ï¼Œå¹¶ä¸”æ¯” Paxos ç®—æ³•æ›´å®¹æ˜“å­¦ä¹ ã€‚æ­¤å¤–ï¼Œæˆ‘ä»¬å¸Œæœ›è¯¥ç®—æ³•æ–¹ä¾¿ç³»ç»Ÿæ„å»ºè€…çš„ç›´è§‰çš„å‘å±•ã€‚é‡è¦çš„ä¸ä»…ä»…æ˜¯ç®—æ³•èƒ½å¤Ÿå·¥ä½œï¼Œæ›´é‡è¦çš„æ˜¯èƒ½å¤Ÿå¾ˆæ¸…æ¥šåœ°çŸ¥é“å®ƒä¸ºä»€ä¹ˆèƒ½å·¥ä½œã€‚\n\nRaft ä¸€è‡´æ€§ç®—æ³•å°±æ˜¯è¿™äº›å·¥ä½œçš„ç»“æœã€‚åœ¨è®¾è®¡ Raft ç®—æ³•çš„æ—¶å€™ï¼Œæˆ‘ä»¬ä½¿ç”¨ä¸€äº›ç‰¹åˆ«çš„æŠ€å·§æ¥æå‡å®ƒçš„å¯ç†è§£æ€§ï¼ŒåŒ…æ‹¬ç®—æ³•åˆ†è§£ï¼ˆRaft ä¸»è¦è¢«åˆ†æˆäº†é¢†å¯¼äººé€‰ä¸¾ï¼Œæ—¥å¿—å¤åˆ¶å’Œå®‰å…¨ä¸‰ä¸ªæ¨¡å—ï¼‰å’Œå‡å°‘çŠ¶æ€æœºçš„çŠ¶æ€ï¼ˆç›¸å¯¹äº Paxosï¼ŒRaft å‡å°‘äº†éç¡®å®šæ€§å’ŒæœåŠ¡å™¨äº’ç›¸å¤„äºéä¸€è‡´æ€§çš„æ–¹å¼ï¼‰ã€‚ä¸€ä»½é’ˆå¯¹ä¸¤æ‰€å¤§å­¦ 43 ä¸ªå­¦ç”Ÿçš„ç ”ç©¶è¡¨æ˜ Raft æ˜æ˜¾æ¯” Paxos ç®—æ³•æ›´åŠ å®¹æ˜“ç†è§£ã€‚åœ¨è¿™äº›å­¦ç”ŸåŒæ—¶å­¦ä¹ äº†è¿™ä¸¤ç§ç®—æ³•ä¹‹åï¼Œå’Œ Paxos æ¯”èµ·æ¥ï¼Œå…¶ä¸­ 33 ä¸ªå­¦ç”Ÿèƒ½å¤Ÿå›ç­”æœ‰å…³äº Raft çš„é—®é¢˜ã€‚\n\nRaft ç®—æ³•åœ¨è®¸å¤šæ–¹é¢å’Œç°æœ‰çš„ä¸€è‡´æ€§ç®—æ³•éƒ½å¾ˆç›¸ä¼¼ï¼ˆä¸»è¦æ˜¯ Oki å’Œ Liskov çš„ Viewstamped Replicationï¼‰ï¼Œä½†æ˜¯å®ƒä¹Ÿæœ‰ä¸€äº›ç‹¬ç‰¹çš„ç‰¹æ€§ï¼š\n\n* **å¼ºé¢†å¯¼äºº**ï¼šå’Œå…¶ä»–ä¸€è‡´æ€§ç®—æ³•ç›¸æ¯”ï¼ŒRaft ä½¿ç”¨ä¸€ç§æ›´å¼ºçš„é¢†å¯¼èƒ½åŠ›å½¢å¼ã€‚æ¯”å¦‚ï¼Œæ—¥å¿—æ¡ç›®åªä»é¢†å¯¼äººå‘é€ç»™å…¶ä»–çš„æœåŠ¡å™¨ã€‚è¿™ç§æ–¹å¼ç®€åŒ–äº†å¯¹å¤åˆ¶æ—¥å¿—çš„ç®¡ç†å¹¶ä¸”ä½¿å¾— Raft ç®—æ³•æ›´åŠ æ˜“äºç†è§£ã€‚\n* **é¢†å¯¼é€‰ä¸¾**ï¼šRaft ç®—æ³•ä½¿ç”¨ä¸€ä¸ªéšæœºè®¡æ—¶å™¨æ¥é€‰ä¸¾é¢†å¯¼äººã€‚è¿™ç§æ–¹å¼åªæ˜¯åœ¨ä»»ä½•ä¸€è‡´æ€§ç®—æ³•éƒ½å¿…é¡»å®ç°çš„å¿ƒè·³æœºåˆ¶ä¸Šå¢åŠ äº†ä¸€ç‚¹æœºåˆ¶ã€‚åœ¨è§£å†³å†²çªçš„æ—¶å€™ä¼šæ›´åŠ ç®€å•å¿«æ·ã€‚\n* **æˆå‘˜å…³ç³»è°ƒæ•´**ï¼šRaft ä½¿ç”¨ä¸€ç§å…±åŒä¸€è‡´çš„æ–¹æ³•æ¥å¤„ç†é›†ç¾¤æˆå‘˜å˜æ¢çš„é—®é¢˜ï¼Œåœ¨è¿™ç§æ–¹æ³•ä¸‹ï¼Œå¤„äºè°ƒæ•´è¿‡ç¨‹ä¸­çš„ä¸¤ç§ä¸åŒçš„é…ç½®é›†ç¾¤ä¸­å¤§å¤šæ•°æœºå™¨ä¼šæœ‰é‡å ï¼Œè¿™å°±ä½¿å¾—é›†ç¾¤åœ¨æˆå‘˜å˜æ¢çš„æ—¶å€™ä¾ç„¶å¯ä»¥ç»§ç»­å·¥ä½œã€‚\n\næˆ‘ä»¬ç›¸ä¿¡ï¼ŒRaft ç®—æ³•ä¸è®ºå‡ºäºæ•™å­¦ç›®çš„è¿˜æ˜¯ä½œä¸ºå®è·µé¡¹ç›®çš„åŸºç¡€éƒ½æ˜¯è¦æ¯” Paxos æˆ–è€…å…¶ä»–ä¸€è‡´æ€§ç®—æ³•è¦ä¼˜å¼‚çš„ã€‚å®ƒæ¯”å…¶ä»–ç®—æ³•æ›´åŠ ç®€å•ï¼Œæ›´åŠ å®¹æ˜“ç†è§£ï¼›å®ƒçš„ç®—æ³•æè¿°è¶³ä»¥å®ç°ä¸€ä¸ªç°å®çš„ç³»ç»Ÿï¼›å®ƒæœ‰å¥½å¤šå¼€æºçš„å®ç°å¹¶ä¸”åœ¨å¾ˆå¤šå…¬å¸é‡Œä½¿ç”¨ï¼›å®ƒçš„å®‰å…¨ç‰¹æ€§å·²ç»è¢«æ­£å¼å®šä¹‰å’Œè¯æ˜ï¼›å®ƒçš„æ•ˆç‡å’Œå…¶ä»–ç®—æ³•æ¯”èµ·æ¥ä¹Ÿä¸ç›¸ä¸Šä¸‹ã€‚\n\næ¥ä¸‹æ¥ï¼Œè¿™ç¯‡è®ºæ–‡ä¼šä»‹ç»ä»¥ä¸‹å†…å®¹ï¼šå¤åˆ¶çŠ¶æ€æœºé—®é¢˜ï¼ˆç¬¬ 2 èŠ‚ï¼‰ï¼Œè®¨è®º Paxos çš„ä¼˜ç‚¹å’Œç¼ºç‚¹ï¼ˆç¬¬ 3 èŠ‚ï¼‰ï¼Œè®¨è®ºæˆ‘ä»¬ä¸ºäº†å¯ç†è§£æ€§è€Œé‡‡å–çš„æ–¹æ³•ï¼ˆç¬¬ 4 èŠ‚ï¼‰ï¼Œé˜è¿° Raft ä¸€è‡´æ€§ç®—æ³•ï¼ˆç¬¬ 5-8 èŠ‚ï¼‰ï¼Œè¯„ä»· Raft ç®—æ³•ï¼ˆç¬¬ 9 èŠ‚ï¼‰ï¼Œä»¥åŠä¸€äº›ç›¸å…³çš„å·¥ä½œï¼ˆç¬¬ 10 èŠ‚ï¼‰ã€‚\n\n## 2 å¤åˆ¶çŠ¶æ€æœº\n\nä¸€è‡´æ€§ç®—æ³•æ˜¯ä»å¤åˆ¶çŠ¶æ€æœºçš„èƒŒæ™¯ä¸‹æå‡ºçš„ï¼ˆå‚è€ƒè‹±æ–‡åŸæ–‡å¼•ç”¨37ï¼‰ã€‚åœ¨è¿™ç§æ–¹æ³•ä¸­ï¼Œä¸€ç»„æœåŠ¡å™¨ä¸Šçš„çŠ¶æ€æœºäº§ç”Ÿç›¸åŒçŠ¶æ€çš„å‰¯æœ¬ï¼Œå¹¶ä¸”åœ¨ä¸€äº›æœºå™¨å®•æ‰çš„æƒ…å†µä¸‹ä¹Ÿå¯ä»¥ç»§ç»­è¿è¡Œã€‚å¤åˆ¶çŠ¶æ€æœºåœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­è¢«ç”¨äºè§£å†³å¾ˆå¤šå®¹é”™çš„é—®é¢˜ã€‚ä¾‹å¦‚ï¼Œå¤§è§„æ¨¡çš„ç³»ç»Ÿä¸­é€šå¸¸éƒ½æœ‰ä¸€ä¸ªé›†ç¾¤é¢†å¯¼äººï¼Œåƒ GFSã€HDFS å’Œ RAMCloudï¼Œå…¸å‹åº”ç”¨å°±æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„å¤åˆ¶çŠ¶æ€æœºå»ç®¡ç†é¢†å¯¼é€‰ä¸¾å’Œå­˜å‚¨é…ç½®ä¿¡æ¯å¹¶ä¸”åœ¨é¢†å¯¼äººå®•æœºçš„æƒ…å†µä¸‹ä¹Ÿè¦å­˜æ´»ä¸‹æ¥ã€‚æ¯”å¦‚ Chubby å’Œ ZooKeeperã€‚\n\n![å›¾ 1 ](/img/2023-06-25-raft-zh_cn/raft-å›¾1.png)\n\n> å›¾ 1 ï¼šå¤åˆ¶çŠ¶æ€æœºçš„ç»“æ„ã€‚ä¸€è‡´æ€§ç®—æ³•ç®¡ç†ç€æ¥è‡ªå®¢æˆ·ç«¯æŒ‡ä»¤çš„å¤åˆ¶æ—¥å¿—ã€‚çŠ¶æ€æœºä»æ—¥å¿—ä¸­å¤„ç†ç›¸åŒé¡ºåºçš„ç›¸åŒæŒ‡ä»¤ï¼Œæ‰€ä»¥äº§ç”Ÿçš„ç»“æœä¹Ÿæ˜¯ç›¸åŒçš„ã€‚\n\nå¤åˆ¶çŠ¶æ€æœºé€šå¸¸éƒ½æ˜¯åŸºäºå¤åˆ¶æ—¥å¿—å®ç°çš„ï¼Œå¦‚å›¾ 1ã€‚æ¯ä¸€ä¸ªæœåŠ¡å™¨å­˜å‚¨ä¸€ä¸ªåŒ…å«ä¸€ç³»åˆ—æŒ‡ä»¤çš„æ—¥å¿—ï¼Œå¹¶ä¸”æŒ‰ç…§æ—¥å¿—çš„é¡ºåºè¿›è¡Œæ‰§è¡Œã€‚æ¯ä¸€ä¸ªæ—¥å¿—éƒ½æŒ‰ç…§ç›¸åŒçš„é¡ºåºåŒ…å«ç›¸åŒçš„æŒ‡ä»¤ï¼Œæ‰€ä»¥æ¯ä¸€ä¸ªæœåŠ¡å™¨éƒ½æ‰§è¡Œç›¸åŒçš„æŒ‡ä»¤åºåˆ—ã€‚å› ä¸ºæ¯ä¸ªçŠ¶æ€æœºéƒ½æ˜¯ç¡®å®šçš„ï¼Œæ¯ä¸€æ¬¡æ‰§è¡Œæ“ä½œéƒ½äº§ç”Ÿç›¸åŒçš„çŠ¶æ€å’ŒåŒæ ·çš„åºåˆ—ã€‚\n\nä¸€è‡´æ€§ç®—æ³•çš„ä»»åŠ¡æ˜¯ä¿è¯å¤åˆ¶æ—¥å¿—çš„ä¸€è‡´æ€§ã€‚æœåŠ¡å™¨ä¸Šçš„ä¸€è‡´æ€§æ¨¡å—æ¥æ”¶å®¢æˆ·ç«¯å‘é€çš„æŒ‡ä»¤ç„¶åæ·»åŠ åˆ°è‡ªå·±çš„æ—¥å¿—ä¸­ã€‚å®ƒå’Œå…¶ä»–æœåŠ¡å™¨ä¸Šçš„ä¸€è‡´æ€§æ¨¡å—è¿›è¡Œé€šä¿¡æ¥ä¿è¯æ¯ä¸€ä¸ªæœåŠ¡å™¨ä¸Šçš„æ—¥å¿—æœ€ç»ˆéƒ½ä»¥ç›¸åŒçš„é¡ºåºåŒ…å«ç›¸åŒçš„è¯·æ±‚ï¼Œå³ä½¿æœ‰äº›æœåŠ¡å™¨å‘ç”Ÿæ•…éšœã€‚ä¸€æ—¦æŒ‡ä»¤è¢«æ­£ç¡®çš„å¤åˆ¶ï¼Œæ¯ä¸€ä¸ªæœåŠ¡å™¨çš„çŠ¶æ€æœºæŒ‰ç…§æ—¥å¿—é¡ºåºå¤„ç†ä»–ä»¬ï¼Œç„¶åè¾“å‡ºç»“æœè¢«è¿”å›ç»™å®¢æˆ·ç«¯ã€‚å› æ­¤ï¼ŒæœåŠ¡å™¨é›†ç¾¤çœ‹èµ·æ¥å½¢æˆäº†ä¸€ä¸ªé«˜å¯é çš„çŠ¶æ€æœºã€‚\n\nå®é™…ç³»ç»Ÿä¸­ä½¿ç”¨çš„ä¸€è‡´æ€§ç®—æ³•é€šå¸¸å«æœ‰ä»¥ä¸‹ç‰¹æ€§ï¼š\n\n* å®‰å…¨æ€§ä¿è¯ï¼ˆç»å¯¹ä¸ä¼šè¿”å›ä¸€ä¸ªé”™è¯¯çš„ç»“æœï¼‰ï¼šåœ¨éæ‹œå åº­é”™è¯¯æƒ…å†µä¸‹ï¼ŒåŒ…æ‹¬ç½‘ç»œå»¶è¿Ÿã€åˆ†åŒºã€ä¸¢åŒ…ã€é‡å¤å’Œä¹±åºç­‰é”™è¯¯éƒ½å¯ä»¥ä¿è¯æ­£ç¡®ã€‚\n* å¯ç”¨æ€§ï¼šé›†ç¾¤ä¸­åªè¦æœ‰å¤§å¤šæ•°çš„æœºå™¨å¯è¿è¡Œå¹¶ä¸”èƒ½å¤Ÿç›¸äº’é€šä¿¡ã€å’Œå®¢æˆ·ç«¯é€šä¿¡ï¼Œå°±å¯ä»¥ä¿è¯å¯ç”¨ã€‚å› æ­¤ï¼Œä¸€ä¸ªå…¸å‹çš„åŒ…å« 5 ä¸ªèŠ‚ç‚¹çš„é›†ç¾¤å¯ä»¥å®¹å¿ä¸¤ä¸ªèŠ‚ç‚¹çš„å¤±è´¥ã€‚æœåŠ¡å™¨è¢«åœæ­¢å°±è®¤ä¸ºæ˜¯å¤±è´¥ã€‚å®ƒä»¬ç¨åå¯èƒ½ä¼šä»å¯é å­˜å‚¨çš„çŠ¶æ€ä¸­æ¢å¤å¹¶é‡æ–°åŠ å…¥é›†ç¾¤ã€‚\n* ä¸ä¾èµ–æ—¶åºæ¥ä¿è¯ä¸€è‡´æ€§ï¼šç‰©ç†æ—¶é’Ÿé”™è¯¯æˆ–è€…æç«¯çš„æ¶ˆæ¯å»¶è¿Ÿåªæœ‰åœ¨æœ€åæƒ…å†µä¸‹æ‰ä¼šå¯¼è‡´å¯ç”¨æ€§é—®é¢˜ã€‚\n* é€šå¸¸æƒ…å†µä¸‹ï¼Œä¸€æ¡æŒ‡ä»¤å¯ä»¥å°½å¯èƒ½å¿«çš„åœ¨é›†ç¾¤ä¸­å¤§å¤šæ•°èŠ‚ç‚¹å“åº”ä¸€è½®è¿œç¨‹è¿‡ç¨‹è°ƒç”¨æ—¶å®Œæˆã€‚å°éƒ¨åˆ†æ¯”è¾ƒæ…¢çš„èŠ‚ç‚¹ä¸ä¼šå½±å“ç³»ç»Ÿæ•´ä½“çš„æ€§èƒ½ã€‚\n\n## 3 Paxos ç®—æ³•çš„é—®é¢˜\n\nåœ¨è¿‡å»çš„ 10 å¹´é‡Œï¼ŒLeslie Lamport çš„ Paxos ç®—æ³•å‡ ä¹å·²ç»æˆä¸ºä¸€è‡´æ€§çš„ä»£åè¯ï¼šPaxos æ˜¯åœ¨è¯¾ç¨‹æ•™å­¦ä¸­æœ€ç»å¸¸ä½¿ç”¨çš„ç®—æ³•ï¼ŒåŒæ—¶ä¹Ÿæ˜¯å¤§å¤šæ•°ä¸€è‡´æ€§ç®—æ³•å®ç°çš„èµ·ç‚¹ã€‚Paxos é¦–å…ˆå®šä¹‰äº†ä¸€ä¸ªèƒ½å¤Ÿè¾¾æˆå•ä¸€å†³ç­–ä¸€è‡´çš„åè®®ï¼Œæ¯”å¦‚å•æ¡çš„å¤åˆ¶æ—¥å¿—é¡¹ã€‚æˆ‘ä»¬æŠŠè¿™ä¸€å­é›†å«åšå•å†³ç­– Paxosã€‚ç„¶åé€šè¿‡ç»„åˆå¤šä¸ª Paxos åè®®çš„å®ä¾‹æ¥ä¿ƒè¿›ä¸€ç³»åˆ—å†³ç­–çš„è¾¾æˆã€‚Paxos ä¿è¯å®‰å…¨æ€§å’Œæ´»æ€§ï¼ŒåŒæ—¶ä¹Ÿæ”¯æŒé›†ç¾¤æˆå‘˜å…³ç³»çš„å˜æ›´ã€‚Paxos çš„æ­£ç¡®æ€§å·²ç»è¢«è¯æ˜ï¼Œåœ¨é€šå¸¸æƒ…å†µä¸‹ä¹Ÿå¾ˆé«˜æ•ˆã€‚\n\nä¸å¹¸çš„æ˜¯ï¼ŒPaxos æœ‰ä¸¤ä¸ªæ˜æ˜¾çš„ç¼ºç‚¹ã€‚ç¬¬ä¸€ä¸ªç¼ºç‚¹æ˜¯ Paxos ç®—æ³•ç‰¹åˆ«çš„éš¾ä»¥ç†è§£ã€‚å®Œæ•´çš„è§£é‡Šæ˜¯å‡ºäº†åçš„ä¸é€æ˜ï¼›é€šè¿‡æå¤§çš„åŠªåŠ›ä¹‹åï¼Œä¹Ÿåªæœ‰å°‘æ•°äººæˆåŠŸç†è§£äº†è¿™ä¸ªç®—æ³•ã€‚å› æ­¤ï¼Œæœ‰äº†å‡ æ¬¡ç”¨æ›´ç®€å•çš„æœ¯è¯­æ¥è§£é‡Š Paxos çš„å°è¯•ã€‚å°½ç®¡è¿™äº›è§£é‡Šéƒ½åªå…³æ³¨äº†å•å†³ç­–çš„å­é›†é—®é¢˜ï¼Œä½†ä¾ç„¶å¾ˆå…·æœ‰æŒ‘æˆ˜æ€§ã€‚åœ¨ 2012 å¹´ NSDI çš„ä¼šè®®ä¸­çš„ä¸€æ¬¡è°ƒæŸ¥æ˜¾ç¤ºï¼Œå¾ˆå°‘æœ‰äººå¯¹ Paxos ç®—æ³•æ„Ÿåˆ°æ»¡æ„ï¼Œç”šè‡³åœ¨ç»éªŒè€é“çš„ç ”ç©¶è€…ä¸­ä¹Ÿæ˜¯å¦‚æ­¤ã€‚æˆ‘ä»¬è‡ªå·±ä¹Ÿå°è¯•å»ç†è§£ Paxosï¼›æˆ‘ä»¬ä¸€ç›´æ²¡èƒ½ç†è§£ Paxos ç›´åˆ°æˆ‘ä»¬è¯»äº†å¾ˆå¤šå¯¹ Paxos çš„ç®€åŒ–è§£é‡Šå¹¶ä¸”è®¾è®¡äº†æˆ‘ä»¬è‡ªå·±çš„ç®—æ³•ä¹‹åï¼Œè¿™ä¸€è¿‡ç¨‹èŠ±äº†è¿‘ä¸€å¹´æ—¶é—´ã€‚\n\næˆ‘ä»¬å‡è®¾ Paxos çš„ä¸é€æ˜æ€§æ¥è‡ªå®ƒé€‰æ‹©å•å†³ç­–é—®é¢˜ä½œä¸ºå®ƒçš„åŸºç¡€ã€‚å•å†³ç­– Paxos æ˜¯æ™¦æ¶©å¾®å¦™çš„ï¼Œå®ƒè¢«åˆ’åˆ†æˆäº†ä¸¤ç§æ²¡æœ‰ç®€å•ç›´è§‚è§£é‡Šå’Œæ— æ³•ç‹¬ç«‹ç†è§£çš„æƒ…æ™¯ã€‚å› æ­¤ï¼Œè¿™å¯¼è‡´äº†å¾ˆéš¾å»ºç«‹èµ·ç›´è§‚çš„æ„Ÿå—ä¸ºä»€ä¹ˆå•å†³ç­– Paxos ç®—æ³•èƒ½å¤Ÿå·¥ä½œã€‚æ„æˆå¤šå†³ç­– Paxos å¢åŠ äº†å¾ˆå¤šé”™ç»¼å¤æ‚çš„è§„åˆ™ã€‚æˆ‘ä»¬ç›¸ä¿¡ï¼Œåœ¨å¤šå†³ç­–ä¸Šè¾¾æˆä¸€è‡´æ€§çš„é—®é¢˜ï¼ˆä¸€ä»½æ—¥å¿—è€Œä¸æ˜¯å•ä¸€çš„æ—¥å¿—è®°å½•ï¼‰èƒ½å¤Ÿè¢«åˆ†è§£æˆå…¶ä»–çš„æ–¹å¼å¹¶ä¸”æ›´åŠ ç›´æ¥å’Œæ˜æ˜¾ã€‚\n\nPaxosç®—æ³•çš„ç¬¬äºŒä¸ªé—®é¢˜å°±æ˜¯å®ƒæ²¡æœ‰æä¾›ä¸€ä¸ªè¶³å¤Ÿå¥½çš„ç”¨æ¥æ„å»ºä¸€ä¸ªç°å®ç³»ç»Ÿçš„åŸºç¡€ã€‚ä¸€ä¸ªåŸå› æ˜¯è¿˜æ²¡æœ‰ä¸€ç§è¢«å¹¿æ³›è®¤åŒçš„å¤šå†³ç­–é—®é¢˜çš„ç®—æ³•ã€‚Lamport çš„æè¿°åŸºæœ¬ä¸Šéƒ½æ˜¯å…³äºå•å†³ç­– Paxos çš„ï¼›ä»–ç®€è¦æè¿°äº†å®æ–½å¤šå†³ç­– Paxos çš„æ–¹æ³•ï¼Œä½†æ˜¯ç¼ºä¹å¾ˆå¤šç»†èŠ‚ã€‚å½“ç„¶ä¹Ÿæœ‰å¾ˆå¤šå…·ä½“åŒ– Paxos çš„å°è¯•ï¼Œä½†æ˜¯ä»–ä»¬éƒ½äº’ç›¸ä¸ä¸€æ ·ï¼Œå’Œ Paxos çš„æ¦‚è¿°ä¹Ÿä¸åŒã€‚ä¾‹å¦‚ Chubby è¿™æ ·çš„ç³»ç»Ÿå®ç°äº†ä¸€ä¸ªç±»ä¼¼äº Paxos çš„ç®—æ³•ï¼Œä½†æ˜¯å¤§å¤šæ•°çš„ç»†èŠ‚å¹¶æ²¡æœ‰è¢«å…¬å¼€ã€‚\n\nè€Œä¸”ï¼ŒPaxos ç®—æ³•çš„ç»“æ„ä¹Ÿä¸æ˜¯ååˆ†æ˜“äºæ„å»ºå®è·µçš„ç³»ç»Ÿï¼›å•å†³ç­–åˆ†è§£ä¹Ÿä¼šäº§ç”Ÿå…¶ä»–çš„ç»“æœã€‚ä¾‹å¦‚ï¼Œç‹¬ç«‹åœ°é€‰æ‹©ä¸€ç»„æ—¥å¿—æ¡ç›®ç„¶ååˆå¹¶æˆä¸€ä¸ªåºåˆ—åŒ–çš„æ—¥å¿—å¹¶æ²¡æœ‰å¸¦æ¥å¤ªå¤šçš„å¥½å¤„ï¼Œä»…ä»…å¢åŠ äº†ä¸å°‘å¤æ‚æ€§ã€‚å›´ç»•ç€æ—¥å¿—æ¥è®¾è®¡ä¸€ä¸ªç³»ç»Ÿæ˜¯æ›´åŠ ç®€å•é«˜æ•ˆçš„ï¼›æ–°æ—¥å¿—æ¡ç›®ä»¥ä¸¥æ ¼é™åˆ¶çš„é¡ºåºå¢æ·»åˆ°æ—¥å¿—ä¸­å»ã€‚å¦ä¸€ä¸ªé—®é¢˜æ˜¯ï¼ŒPaxos ä½¿ç”¨äº†ä¸€ç§å¯¹ç­‰çš„ç‚¹å¯¹ç‚¹çš„æ–¹å¼ä½œä¸ºå®ƒçš„æ ¸å¿ƒï¼ˆå°½ç®¡å®ƒæœ€ç»ˆæè®®äº†ä¸€ç§å¼±é¢†å¯¼äººçš„æ–¹æ³•æ¥ä¼˜åŒ–æ€§èƒ½ï¼‰ã€‚åœ¨åªæœ‰ä¸€ä¸ªå†³ç­–ä¼šè¢«åˆ¶å®šçš„ç®€åŒ–ä¸–ç•Œä¸­æ˜¯å¾ˆæœ‰æ„ä¹‰çš„ï¼Œä½†æ˜¯å¾ˆå°‘æœ‰ç°å®çš„ç³»ç»Ÿä½¿ç”¨è¿™ç§æ–¹å¼ã€‚å¦‚æœæœ‰ä¸€ç³»åˆ—çš„å†³ç­–éœ€è¦è¢«åˆ¶å®šï¼Œé¦–å…ˆé€‰æ‹©ä¸€ä¸ªé¢†å¯¼äººï¼Œç„¶åè®©ä»–å»åè°ƒæ‰€æœ‰çš„å†³è®®ï¼Œä¼šæ›´åŠ ç®€å•å¿«é€Ÿã€‚\n\nå› æ­¤ï¼Œå®é™…çš„ç³»ç»Ÿä¸­å¾ˆå°‘æœ‰å’Œ Paxos ç›¸ä¼¼çš„å®è·µã€‚æ¯ä¸€ç§å®ç°éƒ½æ˜¯ä» Paxos å¼€å§‹ç ”ç©¶ï¼Œç„¶åå‘ç°å¾ˆå¤šå®ç°ä¸Šçš„éš¾é¢˜ï¼Œå†ç„¶åå¼€å‘äº†ä¸€ç§å’Œ Paxos æ˜æ˜¾ä¸ä¸€æ ·çš„ç»“æ„ã€‚è¿™æ ·æ˜¯éå¸¸è´¹æ—¶å’Œå®¹æ˜“å‡ºé”™çš„ï¼Œå¹¶ä¸”ç†è§£ Paxos çš„éš¾åº¦ä½¿å¾—è¿™ä¸ªé—®é¢˜æ›´åŠ ç³Ÿç³•ã€‚Paxos ç®—æ³•åœ¨ç†è®ºä¸Šè¢«è¯æ˜æ˜¯æ­£ç¡®å¯è¡Œçš„ï¼Œä½†æ˜¯ç°å®çš„ç³»ç»Ÿå’Œ Paxos å·®åˆ«æ˜¯å¦‚æ­¤çš„å¤§ï¼Œä»¥è‡³äºè¿™äº›è¯æ˜æ²¡æœ‰ä»€ä¹ˆå¤ªå¤§çš„ä»·å€¼ã€‚ä¸‹é¢æ¥è‡ª Chubby å®ç°éå¸¸å…¸å‹ï¼š\n\n> åœ¨Paxosç®—æ³•æè¿°å’Œå®ç°ç°å®ç³»ç»Ÿä¸­é—´æœ‰ç€å·¨å¤§çš„é¸¿æ²Ÿã€‚æœ€ç»ˆçš„ç³»ç»Ÿå»ºç«‹åœ¨ä¸€ç§æ²¡æœ‰ç»è¿‡è¯æ˜çš„ç®—æ³•ä¹‹ä¸Šã€‚\n\nç”±äºä»¥ä¸Šé—®é¢˜ï¼Œæˆ‘ä»¬è®¤ä¸º Paxos ç®—æ³•æ—¢æ²¡æœ‰æä¾›ä¸€ä¸ªè‰¯å¥½çš„åŸºç¡€ç»™å®è·µçš„ç³»ç»Ÿï¼Œä¹Ÿæ²¡æœ‰ç»™æ•™å­¦å¾ˆå¥½çš„å¸®åŠ©ã€‚åŸºäºä¸€è‡´æ€§é—®é¢˜åœ¨å¤§è§„æ¨¡è½¯ä»¶ç³»ç»Ÿä¸­çš„é‡è¦æ€§ï¼Œæˆ‘ä»¬å†³å®šçœ‹çœ‹æˆ‘ä»¬æ˜¯å¦å¯ä»¥è®¾è®¡ä¸€ä¸ªæ‹¥æœ‰æ›´å¥½ç‰¹æ€§çš„æ›¿ä»£ Paxos çš„ä¸€è‡´æ€§ç®—æ³•ã€‚Raft ç®—æ³•å°±æ˜¯è¿™æ¬¡å®éªŒçš„ç»“æœã€‚\n\n## 4 ä¸ºäº†å¯ç†è§£æ€§çš„è®¾è®¡\n\nè®¾è®¡ Raft ç®—æ³•æˆ‘ä»¬æœ‰å‡ ä¸ªåˆè¡·ï¼šå®ƒå¿…é¡»æä¾›ä¸€ä¸ªå®Œæ•´çš„å®é™…çš„ç³»ç»Ÿå®ç°åŸºç¡€ï¼Œè¿™æ ·æ‰èƒ½å¤§å¤§å‡å°‘å¼€å‘è€…çš„å·¥ä½œï¼›å®ƒå¿…é¡»åœ¨ä»»ä½•æƒ…å†µä¸‹éƒ½æ˜¯å®‰å…¨çš„å¹¶ä¸”åœ¨å¤§å¤šæ•°çš„æƒ…å†µä¸‹éƒ½æ˜¯å¯ç”¨çš„ï¼›å¹¶ä¸”å®ƒçš„å¤§éƒ¨åˆ†æ“ä½œå¿…é¡»æ˜¯é«˜æ•ˆçš„ã€‚ä½†æ˜¯æˆ‘ä»¬æœ€é‡è¦ä¹Ÿæ˜¯æœ€å¤§çš„æŒ‘æˆ˜æ˜¯å¯ç†è§£æ€§ã€‚å®ƒå¿…é¡»ä¿è¯å¯¹äºæ™®éçš„äººç¾¤éƒ½å¯ä»¥ååˆ†å®¹æ˜“çš„å»ç†è§£ã€‚å¦å¤–ï¼Œå®ƒå¿…é¡»èƒ½å¤Ÿè®©äººå½¢æˆç›´è§‚çš„è®¤è¯†ï¼Œè¿™æ ·ç³»ç»Ÿçš„æ„å»ºè€…æ‰èƒ½å¤Ÿåœ¨ç°å®ä¸­è¿›è¡Œå¿…ç„¶çš„æ‰©å±•ã€‚\n\nåœ¨è®¾è®¡ Raft ç®—æ³•çš„æ—¶å€™ï¼Œæœ‰å¾ˆå¤šçš„ç‚¹éœ€è¦æˆ‘ä»¬åœ¨å„ç§å¤‡é€‰æ–¹æ¡ˆä¸­è¿›è¡Œé€‰æ‹©ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬è¯„ä¼°å¤‡é€‰æ–¹æ¡ˆåŸºäºå¯ç†è§£æ€§åŸåˆ™ï¼šè§£é‡Šå„ä¸ªå¤‡é€‰æ–¹æ¡ˆæœ‰å¤šå¤§çš„éš¾åº¦ï¼ˆä¾‹å¦‚ï¼ŒRaft çš„çŠ¶æ€ç©ºé—´æœ‰å¤šå¤æ‚ï¼Œæ˜¯å¦æœ‰å¾®å¦™çš„æš—ç¤ºï¼‰ï¼Ÿå¯¹äºä¸€ä¸ªè¯»è€…è€Œè¨€ï¼Œå®Œå…¨ç†è§£è¿™ä¸ªæ–¹æ¡ˆå’Œæš—ç¤ºæ˜¯å¦å®¹æ˜“ï¼Ÿ\n\næˆ‘ä»¬æ„è¯†åˆ°å¯¹è¿™ç§å¯ç†è§£æ€§åˆ†æä¸Šå…·æœ‰é«˜åº¦çš„ä¸»è§‚æ€§ï¼›å°½ç®¡å¦‚æ­¤ï¼Œæˆ‘ä»¬ä½¿ç”¨äº†ä¸¤ç§é€šå¸¸é€‚ç”¨çš„æŠ€æœ¯æ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚ç¬¬ä¸€ä¸ªæŠ€æœ¯å°±æ˜¯ä¼—æ‰€å‘¨çŸ¥çš„é—®é¢˜åˆ†è§£ï¼šæˆ‘ä»¬å°½å¯èƒ½åœ°å°†é—®é¢˜åˆ†è§£æˆå‡ ä¸ªç›¸å¯¹ç‹¬ç«‹çš„ï¼Œå¯è¢«è§£å†³çš„ã€å¯è§£é‡Šçš„å’Œå¯ç†è§£çš„å­é—®é¢˜ã€‚ä¾‹å¦‚ï¼ŒRaft ç®—æ³•è¢«æˆ‘ä»¬åˆ†æˆé¢†å¯¼äººé€‰ä¸¾ï¼Œæ—¥å¿—å¤åˆ¶ï¼Œå®‰å…¨æ€§å’Œæˆå‘˜å˜æ›´å‡ ä¸ªéƒ¨åˆ†ã€‚\n\næˆ‘ä»¬ä½¿ç”¨çš„ç¬¬äºŒä¸ªæ–¹æ³•æ˜¯é€šè¿‡å‡å°‘çŠ¶æ€çš„æ•°é‡æ¥ç®€åŒ–éœ€è¦è€ƒè™‘çš„çŠ¶æ€ç©ºé—´ï¼Œä½¿å¾—ç³»ç»Ÿæ›´åŠ è¿è´¯å¹¶ä¸”åœ¨å¯èƒ½çš„æ—¶å€™æ¶ˆé™¤ä¸ç¡®å®šæ€§ã€‚ç‰¹åˆ«çš„ï¼Œæ‰€æœ‰çš„æ—¥å¿—æ˜¯ä¸å…è®¸æœ‰ç©ºæ´çš„ï¼Œå¹¶ä¸” Raft é™åˆ¶äº†æ—¥å¿—ä¹‹é—´å˜æˆä¸ä¸€è‡´çŠ¶æ€çš„å¯èƒ½ã€‚å°½ç®¡åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹æˆ‘ä»¬éƒ½è¯•å›¾æ¶ˆé™¤ä¸ç¡®å®šæ€§ï¼Œä½†æ˜¯ä¹Ÿæœ‰ä¸€äº›æƒ…å†µä¸‹ä¸ç¡®å®šæ€§å¯ä»¥æå‡å¯ç†è§£æ€§ã€‚å°¤å…¶æ˜¯ï¼ŒéšæœºåŒ–æ–¹æ³•å¢åŠ äº†ä¸ç¡®å®šæ€§ï¼Œä½†æ˜¯ä»–ä»¬æœ‰åˆ©äºå‡å°‘çŠ¶æ€ç©ºé—´æ•°é‡ï¼Œé€šè¿‡å¤„ç†æ‰€æœ‰å¯èƒ½é€‰æ‹©æ—¶ä½¿ç”¨ç›¸ä¼¼çš„æ–¹æ³•ã€‚æˆ‘ä»¬ä½¿ç”¨éšæœºåŒ–æ¥ç®€åŒ– Raft ä¸­é¢†å¯¼äººé€‰ä¸¾ç®—æ³•ã€‚\n\n## 5 Raft ä¸€è‡´æ€§ç®—æ³•\n\nRaft æ˜¯ä¸€ç§ç”¨æ¥ç®¡ç†ç« èŠ‚ 2 ä¸­æè¿°çš„å¤åˆ¶æ—¥å¿—çš„ç®—æ³•ã€‚å›¾ 2 ä¸ºäº†å‚è€ƒä¹‹ç”¨ï¼Œæ€»ç»“è¿™ä¸ªç®—æ³•çš„ç®€ç•¥ç‰ˆæœ¬ï¼Œå›¾ 3 åˆ—ä¸¾äº†è¿™ä¸ªç®—æ³•çš„ä¸€äº›å…³é”®ç‰¹æ€§ã€‚å›¾ä¸­çš„è¿™äº›å…ƒç´ ä¼šåœ¨å‰©ä¸‹çš„ç« èŠ‚é€ä¸€ä»‹ç»ã€‚\n\nRaft é€šè¿‡é€‰ä¸¾ä¸€ä¸ªæ°å‡ºçš„é¢†å¯¼äººï¼Œç„¶åç»™äºˆä»–å…¨éƒ¨çš„ç®¡ç†å¤åˆ¶æ—¥å¿—çš„è´£ä»»æ¥å®ç°ä¸€è‡´æ€§ã€‚é¢†å¯¼äººä»å®¢æˆ·ç«¯æ¥æ”¶æ—¥å¿—æ¡ç›®ï¼ˆlog entriesï¼‰ï¼ŒæŠŠæ—¥å¿—æ¡ç›®å¤åˆ¶åˆ°å…¶ä»–æœåŠ¡å™¨ä¸Šï¼Œå¹¶å‘Šè¯‰å…¶ä»–çš„æœåŠ¡å™¨ä»€ä¹ˆæ—¶å€™å¯ä»¥å®‰å…¨åœ°å°†æ—¥å¿—æ¡ç›®åº”ç”¨åˆ°ä»–ä»¬çš„çŠ¶æ€æœºä¸­ã€‚æ‹¥æœ‰ä¸€ä¸ªé¢†å¯¼äººå¤§å¤§ç®€åŒ–äº†å¯¹å¤åˆ¶æ—¥å¿—çš„ç®¡ç†ã€‚ä¾‹å¦‚ï¼Œé¢†å¯¼äººå¯ä»¥å†³å®šæ–°çš„æ—¥å¿—æ¡ç›®éœ€è¦æ”¾åœ¨æ—¥å¿—ä¸­çš„ä»€ä¹ˆä½ç½®è€Œä¸éœ€è¦å’Œå…¶ä»–æœåŠ¡å™¨å•†è®®ï¼Œå¹¶ä¸”æ•°æ®éƒ½ä»é¢†å¯¼äººæµå‘å…¶ä»–æœåŠ¡å™¨ã€‚ä¸€ä¸ªé¢†å¯¼äººå¯èƒ½ä¼šå‘ç”Ÿæ•…éšœï¼Œæˆ–è€…å’Œå…¶ä»–æœåŠ¡å™¨å¤±å»è¿æ¥ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ä¸€ä¸ªæ–°çš„é¢†å¯¼äººä¼šè¢«é€‰ä¸¾å‡ºæ¥ã€‚\n\né€šè¿‡é¢†å¯¼äººçš„æ–¹å¼ï¼ŒRaft å°†ä¸€è‡´æ€§é—®é¢˜åˆ†è§£æˆäº†ä¸‰ä¸ªç›¸å¯¹ç‹¬ç«‹çš„å­é—®é¢˜ï¼Œè¿™äº›é—®é¢˜ä¼šåœ¨æ¥ä¸‹æ¥çš„å­ç« èŠ‚ä¸­è¿›è¡Œè®¨è®ºï¼š\n\n* **é¢†å¯¼é€‰ä¸¾**ï¼šå½“ç°å­˜çš„é¢†å¯¼äººå‘ç”Ÿæ•…éšœçš„æ—¶å€™, ä¸€ä¸ªæ–°çš„é¢†å¯¼äººéœ€è¦è¢«é€‰ä¸¾å‡ºæ¥ï¼ˆç« èŠ‚ 5.2ï¼‰\n* **æ—¥å¿—å¤åˆ¶**ï¼šé¢†å¯¼äººå¿…é¡»ä»å®¢æˆ·ç«¯æ¥æ”¶æ—¥å¿—æ¡ç›®ï¼ˆlog entriesï¼‰ç„¶åå¤åˆ¶åˆ°é›†ç¾¤ä¸­çš„å…¶ä»–èŠ‚ç‚¹ï¼Œå¹¶å¼ºåˆ¶è¦æ±‚å…¶ä»–èŠ‚ç‚¹çš„æ—¥å¿—å’Œè‡ªå·±ä¿æŒä¸€è‡´ã€‚\n* **å®‰å…¨æ€§**ï¼šåœ¨ Raft ä¸­å®‰å…¨æ€§çš„å…³é”®æ˜¯åœ¨å›¾ 3 ä¸­å±•ç¤ºçš„çŠ¶æ€æœºå®‰å…¨ï¼šå¦‚æœæœ‰ä»»ä½•çš„æœåŠ¡å™¨èŠ‚ç‚¹å·²ç»åº”ç”¨äº†ä¸€ä¸ªç¡®å®šçš„æ—¥å¿—æ¡ç›®åˆ°å®ƒçš„çŠ¶æ€æœºä¸­ï¼Œé‚£ä¹ˆå…¶ä»–æœåŠ¡å™¨èŠ‚ç‚¹ä¸èƒ½åœ¨åŒä¸€ä¸ªæ—¥å¿—ç´¢å¼•ä½ç½®åº”ç”¨ä¸€ä¸ªä¸åŒçš„æŒ‡ä»¤ã€‚ç« èŠ‚ 5.4 é˜è¿°äº† Raft ç®—æ³•æ˜¯å¦‚ä½•ä¿è¯è¿™ä¸ªç‰¹æ€§çš„ï¼›è¿™ä¸ªè§£å†³æ–¹æ¡ˆæ¶‰åŠåˆ°é€‰ä¸¾æœºåˆ¶ï¼ˆ5.2 èŠ‚ï¼‰ä¸Šçš„ä¸€ä¸ªé¢å¤–é™åˆ¶ã€‚\n\nåœ¨å±•ç¤ºä¸€è‡´æ€§ç®—æ³•ä¹‹åï¼Œè¿™ä¸€ç« èŠ‚ä¼šè®¨è®ºä¸€äº›å¯ç”¨æ€§çš„é—®é¢˜å’Œè®¡æ—¶åœ¨ç³»ç»Ÿä¸­çš„ä½œç”¨ã€‚\n\n**çŠ¶æ€**ï¼š\n\næ‰€æœ‰æœåŠ¡å™¨ä¸Šçš„æŒä¹…æ€§çŠ¶æ€\n(åœ¨å“åº” RPC è¯·æ±‚ä¹‹å‰ï¼Œå·²ç»æ›´æ–°åˆ°äº†ç¨³å®šçš„å­˜å‚¨è®¾å¤‡)\n\n| å‚æ•° | è§£é‡Š |\n| --- | --- |\n| currentTerm | æœåŠ¡å™¨å·²çŸ¥æœ€æ–°çš„ä»»æœŸï¼ˆåœ¨æœåŠ¡å™¨é¦–æ¬¡å¯åŠ¨æ—¶åˆå§‹åŒ–ä¸º0ï¼Œå•è°ƒé€’å¢ï¼‰|\n| votedFor | å½“å‰ä»»æœŸå†…æ”¶åˆ°é€‰ç¥¨çš„ candidateIdï¼Œå¦‚æœæ²¡æœ‰æŠ•ç»™ä»»ä½•å€™é€‰äºº åˆ™ä¸ºç©º|\n| log[] | æ—¥å¿—æ¡ç›®ï¼›æ¯ä¸ªæ¡ç›®åŒ…å«äº†ç”¨äºçŠ¶æ€æœºçš„å‘½ä»¤ï¼Œä»¥åŠé¢†å¯¼äººæ¥æ”¶åˆ°è¯¥æ¡ç›®æ—¶çš„ä»»æœŸï¼ˆåˆå§‹ç´¢å¼•ä¸º1ï¼‰ |\n\næ‰€æœ‰æœåŠ¡å™¨ä¸Šçš„æ˜“å¤±æ€§çŠ¶æ€\n\n| å‚æ•° | è§£é‡Š |\n| --- | --- |\n| commitIndex | å·²çŸ¥å·²æäº¤çš„æœ€é«˜çš„æ—¥å¿—æ¡ç›®çš„ç´¢å¼•ï¼ˆåˆå§‹å€¼ä¸º0ï¼Œå•è°ƒé€’å¢ï¼‰|\n| lastApplied | å·²ç»è¢«åº”ç”¨åˆ°çŠ¶æ€æœºçš„æœ€é«˜çš„æ—¥å¿—æ¡ç›®çš„ç´¢å¼•ï¼ˆåˆå§‹å€¼ä¸º0ï¼Œå•è°ƒé€’å¢ï¼‰|\n\né¢†å¯¼äººï¼ˆæœåŠ¡å™¨ï¼‰ä¸Šçš„æ˜“å¤±æ€§çŠ¶æ€\n(é€‰ä¸¾åå·²ç»é‡æ–°åˆå§‹åŒ–)\n\n| å‚æ•° | è§£é‡Š |\n| --- | --- |\n| nextIndex[] | å¯¹äºæ¯ä¸€å°æœåŠ¡å™¨ï¼Œå‘é€åˆ°è¯¥æœåŠ¡å™¨çš„ä¸‹ä¸€ä¸ªæ—¥å¿—æ¡ç›®çš„ç´¢å¼•ï¼ˆåˆå§‹å€¼ä¸ºé¢†å¯¼äººæœ€åçš„æ—¥å¿—æ¡ç›®çš„ç´¢å¼•+1ï¼‰|\n| matchIndex[] | å¯¹äºæ¯ä¸€å°æœåŠ¡å™¨ï¼Œå·²çŸ¥çš„å·²ç»å¤åˆ¶åˆ°è¯¥æœåŠ¡å™¨çš„æœ€é«˜æ—¥å¿—æ¡ç›®çš„ç´¢å¼•ï¼ˆåˆå§‹å€¼ä¸º0ï¼Œå•è°ƒé€’å¢ï¼‰|\n\n**è¿½åŠ æ¡ç›®ï¼ˆAppendEntriesï¼‰RPC**ï¼š\n\nç”±é¢†å¯¼äººè°ƒç”¨ï¼Œç”¨äºæ—¥å¿—æ¡ç›®çš„å¤åˆ¶ï¼ŒåŒæ—¶ä¹Ÿè¢«å½“åšå¿ƒè·³ä½¿ç”¨\n\n| å‚æ•° | è§£é‡Š |\n| --- | --- |\n| term | é¢†å¯¼äººçš„ä»»æœŸ |\n| leaderId | é¢†å¯¼äºº ID å› æ­¤è·Ÿéšè€…å¯ä»¥å¯¹å®¢æˆ·ç«¯è¿›è¡Œé‡å®šå‘ï¼ˆè¯‘è€…æ³¨ï¼šè·Ÿéšè€…æ ¹æ®é¢†å¯¼äºº ID æŠŠå®¢æˆ·ç«¯çš„è¯·æ±‚é‡å®šå‘åˆ°é¢†å¯¼äººï¼Œæ¯”å¦‚æœ‰æ—¶å®¢æˆ·ç«¯æŠŠè¯·æ±‚å‘ç»™äº†è·Ÿéšè€…è€Œä¸æ˜¯é¢†å¯¼äººï¼‰ |\n| prevLogIndex | ç´§é‚»æ–°æ—¥å¿—æ¡ç›®ä¹‹å‰çš„é‚£ä¸ªæ—¥å¿—æ¡ç›®çš„ç´¢å¼• |\n| prevLogTerm | ç´§é‚»æ–°æ—¥å¿—æ¡ç›®ä¹‹å‰çš„é‚£ä¸ªæ—¥å¿—æ¡ç›®çš„ä»»æœŸ |\n| entries[] | éœ€è¦è¢«ä¿å­˜çš„æ—¥å¿—æ¡ç›®ï¼ˆè¢«å½“åšå¿ƒè·³ä½¿ç”¨æ—¶ï¼Œåˆ™æ—¥å¿—æ¡ç›®å†…å®¹ä¸ºç©ºï¼›ä¸ºäº†æé«˜æ•ˆç‡å¯èƒ½ä¸€æ¬¡æ€§å‘é€å¤šä¸ªï¼‰ |\n| leaderCommit | é¢†å¯¼äººçš„å·²çŸ¥å·²æäº¤çš„æœ€é«˜çš„æ—¥å¿—æ¡ç›®çš„ç´¢å¼• |\n\n<br>\n\n| è¿”å›å€¼ | è§£é‡Š |\n| --- | --- |\n| term | å½“å‰ä»»æœŸï¼Œå¯¹äºé¢†å¯¼äººè€Œè¨€ å®ƒä¼šæ›´æ–°è‡ªå·±çš„ä»»æœŸ |\n| success | å¦‚æœè·Ÿéšè€…æ‰€å«æœ‰çš„æ¡ç›®å’Œ prevLogIndex ä»¥åŠ prevLogTerm åŒ¹é…ä¸Šäº†ï¼Œåˆ™ä¸º true |\n\næ¥æ”¶è€…çš„å®ç°ï¼š\n\n1. è¿”å›å‡ å¦‚æœé¢†å¯¼äººçš„ä»»æœŸå°äºæ¥æ”¶è€…çš„å½“å‰ä»»æœŸï¼ˆè¯‘è€…æ³¨ï¼šè¿™é‡Œçš„æ¥æ”¶è€…æ˜¯æŒ‡è·Ÿéšè€…æˆ–è€…å€™é€‰äººï¼‰ï¼ˆ5.1 èŠ‚ï¼‰\n2. è¿”å›å‡ å¦‚æœæ¥æ”¶è€…æ—¥å¿—ä¸­æ²¡æœ‰åŒ…å«è¿™æ ·ä¸€ä¸ªæ¡ç›® å³è¯¥æ¡ç›®çš„ä»»æœŸåœ¨ prevLogIndex ä¸Šèƒ½å’Œ prevLogTerm åŒ¹é…ä¸Š\n    ï¼ˆè¯‘è€…æ³¨ï¼šåœ¨æ¥æ”¶è€…æ—¥å¿—ä¸­ å¦‚æœèƒ½æ‰¾åˆ°ä¸€ä¸ªå’Œ prevLogIndex ä»¥åŠ prevLogTerm ä¸€æ ·çš„ç´¢å¼•å’Œä»»æœŸçš„æ—¥å¿—æ¡ç›® åˆ™ç»§ç»­æ‰§è¡Œä¸‹é¢çš„æ­¥éª¤ å¦åˆ™è¿”å›å‡ï¼‰ï¼ˆ5.3 èŠ‚ï¼‰\n3. å¦‚æœä¸€ä¸ªå·²ç»å­˜åœ¨çš„æ¡ç›®å’Œæ–°æ¡ç›®ï¼ˆè¯‘è€…æ³¨ï¼šå³åˆšåˆšæ¥æ”¶åˆ°çš„æ—¥å¿—æ¡ç›®ï¼‰å‘ç”Ÿäº†å†²çªï¼ˆå› ä¸ºç´¢å¼•ç›¸åŒï¼Œä»»æœŸä¸åŒï¼‰ï¼Œé‚£ä¹ˆå°±åˆ é™¤è¿™ä¸ªå·²ç»å­˜åœ¨çš„æ¡ç›®ä»¥åŠå®ƒä¹‹åçš„æ‰€æœ‰æ¡ç›® ï¼ˆ5.3 èŠ‚ï¼‰\n4. è¿½åŠ æ—¥å¿—ä¸­å°šæœªå­˜åœ¨çš„ä»»ä½•æ–°æ¡ç›®\n5. å¦‚æœé¢†å¯¼äººçš„å·²çŸ¥å·²æäº¤çš„æœ€é«˜æ—¥å¿—æ¡ç›®çš„ç´¢å¼•å¤§äºæ¥æ”¶è€…çš„å·²çŸ¥å·²æäº¤æœ€é«˜æ—¥å¿—æ¡ç›®çš„ç´¢å¼•ï¼ˆ`leaderCommit > commitIndex`ï¼‰ï¼Œåˆ™æŠŠæ¥æ”¶è€…çš„å·²çŸ¥å·²ç»æäº¤çš„æœ€é«˜çš„æ—¥å¿—æ¡ç›®çš„ç´¢å¼•commitIndex é‡ç½®ä¸º é¢†å¯¼äººçš„å·²çŸ¥å·²ç»æäº¤çš„æœ€é«˜çš„æ—¥å¿—æ¡ç›®çš„ç´¢å¼• leaderCommit æˆ–è€…æ˜¯ ä¸Šä¸€ä¸ªæ–°æ¡ç›®çš„ç´¢å¼• å–ä¸¤è€…çš„æœ€å°å€¼\n\n**è¯·æ±‚æŠ•ç¥¨ï¼ˆRequestVoteï¼‰RPC**ï¼š\n\nç”±å€™é€‰äººè´Ÿè´£è°ƒç”¨ç”¨æ¥å¾é›†é€‰ç¥¨ï¼ˆ5.2 èŠ‚ï¼‰\n\n| å‚æ•° | è§£é‡Š |\n| --- | --- |\n| term | å€™é€‰äººçš„ä»»æœŸå· |\n| candidateId | è¯·æ±‚é€‰ç¥¨çš„å€™é€‰äººçš„ ID |\n| lastLogIndex | å€™é€‰äººçš„æœ€åæ—¥å¿—æ¡ç›®çš„ç´¢å¼•å€¼ |\n| lastLogTerm | å€™é€‰äººæœ€åæ—¥å¿—æ¡ç›®çš„ä»»æœŸå· |\n\n<br>\n\n| è¿”å›å€¼ | è§£é‡Š |\n| --- | --- |\n| term | å½“å‰ä»»æœŸå·ï¼Œä»¥ä¾¿äºå€™é€‰äººå»æ›´æ–°è‡ªå·±çš„ä»»æœŸå· |\n| voteGranted | å€™é€‰äººèµ¢å¾—äº†æ­¤å¼ é€‰ç¥¨æ—¶ä¸ºçœŸ |\n\næ¥æ”¶è€…å®ç°ï¼š\n\n1. å¦‚æœ`term < currentTerm`è¿”å› false ï¼ˆ5.2 èŠ‚ï¼‰\n2. å¦‚æœ votedFor ä¸ºç©ºæˆ–è€…ä¸º candidateIdï¼Œå¹¶ä¸”å€™é€‰äººçš„æ—¥å¿—è‡³å°‘å’Œè‡ªå·±ä¸€æ ·æ–°ï¼Œé‚£ä¹ˆå°±æŠ•ç¥¨ç»™ä»–ï¼ˆ5.2 èŠ‚ï¼Œ5.4 èŠ‚ï¼‰\n\n**æ‰€æœ‰æœåŠ¡å™¨éœ€éµå®ˆçš„è§„åˆ™**ï¼š\n\næ‰€æœ‰æœåŠ¡å™¨ï¼š\n\n* å¦‚æœ`commitIndex > lastApplied`ï¼Œåˆ™ lastApplied é€’å¢ï¼Œå¹¶å°†`log[lastApplied]`åº”ç”¨åˆ°çŠ¶æ€æœºä¸­ï¼ˆ5.3 èŠ‚ï¼‰\n* å¦‚æœæ¥æ”¶åˆ°çš„ RPC è¯·æ±‚æˆ–å“åº”ä¸­ï¼Œä»»æœŸå·`T > currentTerm`ï¼Œåˆ™ä»¤ `currentTerm = T`ï¼Œå¹¶åˆ‡æ¢ä¸ºè·Ÿéšè€…çŠ¶æ€ï¼ˆ5.1 èŠ‚ï¼‰\n\nè·Ÿéšè€…ï¼ˆ5.2 èŠ‚ï¼‰ï¼š\n\n* å“åº”æ¥è‡ªå€™é€‰äººå’Œé¢†å¯¼äººçš„è¯·æ±‚\n* å¦‚æœåœ¨è¶…è¿‡é€‰ä¸¾è¶…æ—¶æ—¶é—´çš„æƒ…å†µä¹‹å‰æ²¡æœ‰æ”¶åˆ°**å½“å‰é¢†å¯¼äºº**ï¼ˆå³è¯¥é¢†å¯¼äººçš„ä»»æœŸéœ€ä¸è¿™ä¸ªè·Ÿéšè€…çš„å½“å‰ä»»æœŸç›¸åŒï¼‰çš„å¿ƒè·³/é™„åŠ æ—¥å¿—ï¼Œæˆ–è€…æ˜¯ç»™æŸä¸ªå€™é€‰äººæŠ•äº†ç¥¨ï¼Œå°±è‡ªå·±å˜æˆå€™é€‰äºº\n\nå€™é€‰äººï¼ˆ5.2 èŠ‚ï¼‰ï¼š\n\n* åœ¨è½¬å˜æˆå€™é€‰äººåå°±ç«‹å³å¼€å§‹é€‰ä¸¾è¿‡ç¨‹\n\t* è‡ªå¢å½“å‰çš„ä»»æœŸå·ï¼ˆcurrentTermï¼‰\n\t* ç»™è‡ªå·±æŠ•ç¥¨\n\t* é‡ç½®é€‰ä¸¾è¶…æ—¶è®¡æ—¶å™¨\n\t* å‘é€è¯·æ±‚æŠ•ç¥¨çš„ RPC ç»™å…¶ä»–æ‰€æœ‰æœåŠ¡å™¨\n* å¦‚æœæ¥æ”¶åˆ°å¤§å¤šæ•°æœåŠ¡å™¨çš„é€‰ç¥¨ï¼Œé‚£ä¹ˆå°±å˜æˆé¢†å¯¼äºº\n* å¦‚æœæ¥æ”¶åˆ°æ¥è‡ªæ–°çš„é¢†å¯¼äººçš„é™„åŠ æ—¥å¿—ï¼ˆAppendEntriesï¼‰RPCï¼Œåˆ™è½¬å˜æˆè·Ÿéšè€…\n* å¦‚æœé€‰ä¸¾è¿‡ç¨‹è¶…æ—¶ï¼Œåˆ™å†æ¬¡å‘èµ·ä¸€è½®é€‰ä¸¾\n\né¢†å¯¼äººï¼š\n\n* ä¸€æ—¦æˆä¸ºé¢†å¯¼äººï¼šå‘é€ç©ºçš„é™„åŠ æ—¥å¿—ï¼ˆAppendEntriesï¼‰RPCï¼ˆå¿ƒè·³ï¼‰ç»™å…¶ä»–æ‰€æœ‰çš„æœåŠ¡å™¨ï¼›åœ¨ä¸€å®šçš„ç©ºä½™æ—¶é—´ä¹‹åä¸åœçš„é‡å¤å‘é€ï¼Œä»¥é˜²æ­¢è·Ÿéšè€…è¶…æ—¶ï¼ˆ5.2 èŠ‚ï¼‰\n*  å¦‚æœæ¥æ”¶åˆ°æ¥è‡ªå®¢æˆ·ç«¯çš„è¯·æ±‚ï¼šé™„åŠ æ¡ç›®åˆ°æœ¬åœ°æ—¥å¿—ä¸­ï¼Œåœ¨æ¡ç›®è¢«åº”ç”¨åˆ°çŠ¶æ€æœºåå“åº”å®¢æˆ·ç«¯ï¼ˆ5.3 èŠ‚ï¼‰\n*  å¦‚æœå¯¹äºä¸€ä¸ªè·Ÿéšè€…ï¼Œæœ€åæ—¥å¿—æ¡ç›®çš„ç´¢å¼•å€¼å¤§äºç­‰äº nextIndexï¼ˆ`lastLogIndex â‰¥ nextIndex`ï¼‰ï¼Œåˆ™å‘é€ä» nextIndex å¼€å§‹çš„æ‰€æœ‰æ—¥å¿—æ¡ç›®ï¼š\n\t* å¦‚æœæˆåŠŸï¼šæ›´æ–°ç›¸åº”è·Ÿéšè€…çš„ nextIndex å’Œ matchIndex\n\t* å¦‚æœå› ä¸ºæ—¥å¿—ä¸ä¸€è‡´è€Œå¤±è´¥ï¼Œåˆ™ nextIndex é€’å‡å¹¶é‡è¯•\n* å‡è®¾å­˜åœ¨ N æ»¡è¶³`N > commitIndex`ï¼Œä½¿å¾—å¤§å¤šæ•°çš„ `matchIndex[i] â‰¥ N`ä»¥åŠ`log[N].term == currentTerm` æˆç«‹ï¼Œåˆ™ä»¤ `commitIndex = N`ï¼ˆ5.3 å’Œ 5.4 èŠ‚ï¼‰\n\n![å›¾ 2](/img/2023-06-25-raft-zh_cn/raft-å›¾2.png)\n\n> å›¾ 2ï¼šä¸€ä¸ªå…³äº Raft ä¸€è‡´æ€§ç®—æ³•çš„æµ“ç¼©æ€»ç»“ï¼ˆä¸åŒ…æ‹¬æˆå‘˜å˜æ¢å’Œæ—¥å¿—å‹ç¼©ï¼‰ã€‚\n\n| ç‰¹æ€§ | è§£é‡Š |\n| --- | --- |\n|é€‰ä¸¾å®‰å…¨ç‰¹æ€§| å¯¹äºä¸€ä¸ªç»™å®šçš„ä»»æœŸå·ï¼Œæœ€å¤šåªä¼šæœ‰ä¸€ä¸ªé¢†å¯¼äººè¢«é€‰ä¸¾å‡ºæ¥ï¼ˆ5.2 èŠ‚ï¼‰|\n|é¢†å¯¼äººåªé™„åŠ åŸåˆ™| é¢†å¯¼äººç»å¯¹ä¸ä¼šåˆ é™¤æˆ–è€…è¦†ç›–è‡ªå·±çš„æ—¥å¿—ï¼Œåªä¼šå¢åŠ ï¼ˆ5.3 èŠ‚ï¼‰|\n|æ—¥å¿—åŒ¹é…åŸåˆ™| å¦‚æœä¸¤ä¸ªæ—¥å¿—åœ¨æŸä¸€ç›¸åŒç´¢å¼•ä½ç½®æ—¥å¿—æ¡ç›®çš„ä»»æœŸå·ç›¸åŒï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±è®¤ä¸ºè¿™ä¸¤ä¸ªæ—¥å¿—ä»å¤´åˆ°è¯¥ç´¢å¼•ä½ç½®ä¹‹é—´çš„å†…å®¹å®Œå…¨ä¸€è‡´ï¼ˆ5.3 èŠ‚ï¼‰|\n|é¢†å¯¼äººå®Œå…¨ç‰¹æ€§|å¦‚æœæŸä¸ªæ—¥å¿—æ¡ç›®åœ¨æŸä¸ªä»»æœŸå·ä¸­å·²ç»è¢«æäº¤ï¼Œé‚£ä¹ˆè¿™ä¸ªæ¡ç›®å¿…ç„¶å‡ºç°åœ¨æ›´å¤§ä»»æœŸå·çš„æ‰€æœ‰é¢†å¯¼äººä¸­ï¼ˆ5.4 èŠ‚ï¼‰|\n|çŠ¶æ€æœºå®‰å…¨ç‰¹æ€§| å¦‚æœæŸä¸€æœåŠ¡å™¨å·²å°†ç»™å®šç´¢å¼•ä½ç½®çš„æ—¥å¿—æ¡ç›®åº”ç”¨è‡³å…¶çŠ¶æ€æœºä¸­ï¼Œåˆ™å…¶ä»–ä»»ä½•æœåŠ¡å™¨åœ¨è¯¥ç´¢å¼•ä½ç½®ä¸ä¼šåº”ç”¨ä¸åŒçš„æ—¥å¿—æ¡ç›®ï¼ˆ5.4.3 èŠ‚ï¼‰|\n\n![å›¾ 3 ](/img/2023-06-25-raft-zh_cn/raft-å›¾3.png)\n\n> å›¾ 3ï¼šRaft åœ¨ä»»ä½•æ—¶å€™éƒ½ä¿è¯ä»¥ä¸Šçš„å„ä¸ªç‰¹æ€§ã€‚\n\n### 5.1 Raft åŸºç¡€\n\nä¸€ä¸ª Raft é›†ç¾¤åŒ…å«è‹¥å¹²ä¸ªæœåŠ¡å™¨èŠ‚ç‚¹ï¼›5 ä¸ªæœåŠ¡å™¨èŠ‚ç‚¹æ˜¯ä¸€ä¸ªå…¸å‹çš„ä¾‹å­ï¼Œè¿™å…è®¸æ•´ä¸ªç³»ç»Ÿå®¹å¿ 2 ä¸ªèŠ‚ç‚¹å¤±æ•ˆã€‚åœ¨ä»»ä½•æ—¶åˆ»ï¼Œæ¯ä¸€ä¸ªæœåŠ¡å™¨èŠ‚ç‚¹éƒ½å¤„äºè¿™ä¸‰ä¸ªçŠ¶æ€ä¹‹ä¸€ï¼šé¢†å¯¼äººã€è·Ÿéšè€…æˆ–è€…å€™é€‰äººã€‚åœ¨é€šå¸¸æƒ…å†µä¸‹ï¼Œç³»ç»Ÿä¸­åªæœ‰ä¸€ä¸ªé¢†å¯¼äººå¹¶ä¸”å…¶ä»–çš„èŠ‚ç‚¹å…¨éƒ¨éƒ½æ˜¯è·Ÿéšè€…ã€‚è·Ÿéšè€…éƒ½æ˜¯è¢«åŠ¨çš„ï¼šä»–ä»¬ä¸ä¼šå‘é€ä»»ä½•è¯·æ±‚ï¼Œåªæ˜¯ç®€å•çš„å“åº”æ¥è‡ªé¢†å¯¼äººæˆ–è€…å€™é€‰äººçš„è¯·æ±‚ã€‚é¢†å¯¼äººå¤„ç†æ‰€æœ‰çš„å®¢æˆ·ç«¯è¯·æ±‚ï¼ˆå¦‚æœä¸€ä¸ªå®¢æˆ·ç«¯å’Œè·Ÿéšè€…è”ç³»ï¼Œé‚£ä¹ˆè·Ÿéšè€…ä¼šæŠŠè¯·æ±‚é‡å®šå‘ç»™é¢†å¯¼äººï¼‰ã€‚ç¬¬ä¸‰ç§çŠ¶æ€ï¼Œå€™é€‰äººï¼Œæ˜¯ç”¨æ¥åœ¨ 5.2 èŠ‚æè¿°çš„é€‰ä¸¾æ–°é¢†å¯¼äººæ—¶ä½¿ç”¨ã€‚å›¾ 4 å±•ç¤ºäº†è¿™äº›çŠ¶æ€å’Œä»–ä»¬ä¹‹é—´çš„è½¬æ¢å…³ç³»ï¼›è¿™äº›è½¬æ¢å…³ç³»ä¼šåœ¨æ¥ä¸‹æ¥è¿›è¡Œè®¨è®ºã€‚\n\n![å›¾ 4 ](/img/2023-06-25-raft-zh_cn/raft-å›¾4.png)\n\n> å›¾ 4ï¼šæœåŠ¡å™¨çŠ¶æ€ã€‚è·Ÿéšè€…åªå“åº”æ¥è‡ªå…¶ä»–æœåŠ¡å™¨çš„è¯·æ±‚ã€‚å¦‚æœè·Ÿéšè€…æ¥æ”¶ä¸åˆ°æ¶ˆæ¯ï¼Œé‚£ä¹ˆä»–å°±ä¼šå˜æˆå€™é€‰äººå¹¶å‘èµ·ä¸€æ¬¡é€‰ä¸¾ã€‚è·å¾—é›†ç¾¤ä¸­å¤§å¤šæ•°é€‰ç¥¨çš„å€™é€‰äººå°†æˆä¸ºé¢†å¯¼äººã€‚åœ¨ä¸€ä¸ªä»»æœŸå†…ï¼Œé¢†å¯¼äººä¸€ç›´éƒ½ä¼šæ˜¯é¢†å¯¼äººï¼Œç›´åˆ°è‡ªå·±å®•æœºäº†ã€‚\n\n![å›¾ 5](/img/2023-06-25-raft-zh_cn/raft-å›¾5.png)\n\n> å›¾ 5ï¼šæ—¶é—´è¢«åˆ’åˆ†æˆä¸€ä¸ªä¸ªçš„ä»»æœŸï¼Œæ¯ä¸ªä»»æœŸå§‹äºä¸€æ¬¡é€‰ä¸¾ã€‚åœ¨é€‰ä¸¾æˆåŠŸåï¼Œé¢†å¯¼äººä¼šç®¡ç†æ•´ä¸ªé›†ç¾¤ç›´åˆ°ä»»æœŸç»“æŸã€‚æœ‰æ—¶å€™é€‰ä¸¾ä¼šå¤±è´¥ï¼Œé‚£ä¹ˆè¿™ä¸ªä»»æœŸå°±ä¼šæ²¡æœ‰é¢†å¯¼äººè€Œç»“æŸã€‚ä»»æœŸä¹‹é—´çš„åˆ‡æ¢å¯ä»¥åœ¨ä¸åŒçš„æ—¶é—´ä¸åŒçš„æœåŠ¡å™¨ä¸Šè§‚å¯Ÿåˆ°ã€‚\n\nRaft æŠŠæ—¶é—´åˆ†å‰²æˆä»»æ„é•¿åº¦çš„**ä»»æœŸ**ï¼Œå¦‚å›¾ 5ã€‚ä»»æœŸç”¨è¿ç»­çš„æ•´æ•°æ ‡è®°ã€‚æ¯ä¸€æ®µä»»æœŸä»ä¸€æ¬¡**é€‰ä¸¾**å¼€å§‹ï¼Œå°±åƒç« èŠ‚ 5.2 æè¿°çš„ä¸€æ ·ï¼Œä¸€ä¸ªæˆ–è€…å¤šä¸ªå€™é€‰äººå°è¯•æˆä¸ºé¢†å¯¼äººã€‚å¦‚æœä¸€ä¸ªå€™é€‰äººèµ¢å¾—é€‰ä¸¾ï¼Œç„¶åä»–å°±åœ¨æ¥ä¸‹æ¥çš„ä»»æœŸå†…å……å½“é¢†å¯¼äººçš„èŒè´£ã€‚åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œä¸€æ¬¡é€‰ä¸¾è¿‡ç¨‹ä¼šé€ æˆé€‰ç¥¨çš„ç“œåˆ†ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œè¿™ä¸€ä»»æœŸä¼šä»¥æ²¡æœ‰é¢†å¯¼äººç»“æŸï¼›ä¸€ä¸ªæ–°çš„ä»»æœŸï¼ˆå’Œä¸€æ¬¡æ–°çš„é€‰ä¸¾ï¼‰ä¼šå¾ˆå¿«é‡æ–°å¼€å§‹ã€‚Raft ä¿è¯äº†åœ¨ä¸€ä¸ªç»™å®šçš„ä»»æœŸå†…ï¼Œæœ€å¤šåªæœ‰ä¸€ä¸ªé¢†å¯¼äººã€‚\n\nä¸åŒçš„æœåŠ¡å™¨èŠ‚ç‚¹å¯èƒ½å¤šæ¬¡è§‚å¯Ÿåˆ°ä»»æœŸä¹‹é—´çš„è½¬æ¢ï¼Œä½†åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œä¸€ä¸ªèŠ‚ç‚¹ä¹Ÿå¯èƒ½è§‚å¯Ÿä¸åˆ°ä»»ä½•ä¸€æ¬¡é€‰ä¸¾æˆ–è€…æ•´ä¸ªä»»æœŸå…¨ç¨‹ã€‚ä»»æœŸåœ¨ Raft ç®—æ³•ä¸­å……å½“é€»è¾‘æ—¶é’Ÿçš„ä½œç”¨ï¼Œä»»æœŸä½¿å¾—æœåŠ¡å™¨å¯ä»¥æ£€æµ‹ä¸€äº›è¿‡æœŸçš„ä¿¡æ¯ï¼šæ¯”å¦‚è¿‡æœŸçš„é¢†å¯¼äººã€‚æ¯ä¸ªèŠ‚ç‚¹å­˜å‚¨ä¸€ä¸ªå½“å‰ä»»æœŸå·ï¼Œè¿™ä¸€ç¼–å·åœ¨æ•´ä¸ªæ—¶æœŸå†…å•è°ƒé€’å¢ã€‚æ¯å½“æœåŠ¡å™¨ä¹‹é—´é€šä¿¡çš„æ—¶å€™éƒ½ä¼šäº¤æ¢å½“å‰ä»»æœŸå·ï¼›å¦‚æœä¸€ä¸ªæœåŠ¡å™¨çš„å½“å‰ä»»æœŸå·æ¯”å…¶ä»–äººå°ï¼Œé‚£ä¹ˆä»–ä¼šæ›´æ–°è‡ªå·±çš„ä»»æœŸå·åˆ°è¾ƒå¤§çš„ä»»æœŸå·å€¼ã€‚å¦‚æœä¸€ä¸ªå€™é€‰äººæˆ–è€…é¢†å¯¼äººå‘ç°è‡ªå·±çš„ä»»æœŸå·è¿‡æœŸäº†ï¼Œé‚£ä¹ˆä»–ä¼šç«‹å³æ¢å¤æˆè·Ÿéšè€…çŠ¶æ€ã€‚å¦‚æœä¸€ä¸ªèŠ‚ç‚¹æ¥æ”¶åˆ°ä¸€ä¸ªåŒ…å«è¿‡æœŸçš„ä»»æœŸå·çš„è¯·æ±‚ï¼Œé‚£ä¹ˆä»–ä¼šç›´æ¥æ‹’ç»è¿™ä¸ªè¯·æ±‚ã€‚\n\nRaft ç®—æ³•ä¸­æœåŠ¡å™¨èŠ‚ç‚¹ä¹‹é—´é€šä¿¡ä½¿ç”¨è¿œç¨‹è¿‡ç¨‹è°ƒç”¨ï¼ˆRPCsï¼‰ï¼Œå¹¶ä¸”åŸºæœ¬çš„ä¸€è‡´æ€§ç®—æ³•åªéœ€è¦ä¸¤ç§ç±»å‹çš„ RPCsã€‚è¯·æ±‚æŠ•ç¥¨ï¼ˆRequestVoteï¼‰ RPCs ç”±å€™é€‰äººåœ¨é€‰ä¸¾æœŸé—´å‘èµ·ï¼ˆç« èŠ‚  5.2ï¼‰ï¼Œç„¶åé™„åŠ æ¡ç›®ï¼ˆAppendEntriesï¼‰RPCs ç”±é¢†å¯¼äººå‘èµ·ï¼Œç”¨æ¥å¤åˆ¶æ—¥å¿—å’Œæä¾›ä¸€ç§å¿ƒè·³æœºåˆ¶ï¼ˆç« èŠ‚ 5.3ï¼‰ã€‚ç¬¬ 7 èŠ‚ä¸ºäº†åœ¨æœåŠ¡å™¨ä¹‹é—´ä¼ è¾“å¿«ç…§å¢åŠ äº†ç¬¬ä¸‰ç§ RPCã€‚å½“æœåŠ¡å™¨æ²¡æœ‰åŠæ—¶çš„æ”¶åˆ° RPC çš„å“åº”æ—¶ï¼Œä¼šè¿›è¡Œé‡è¯•ï¼Œ å¹¶ä¸”ä»–ä»¬èƒ½å¤Ÿå¹¶è¡Œçš„å‘èµ· RPCs æ¥è·å¾—æœ€ä½³çš„æ€§èƒ½ã€‚\n\n### 5.2 é¢†å¯¼äººé€‰ä¸¾\n\nRaft ä½¿ç”¨ä¸€ç§å¿ƒè·³æœºåˆ¶æ¥è§¦å‘é¢†å¯¼äººé€‰ä¸¾ã€‚å½“æœåŠ¡å™¨ç¨‹åºå¯åŠ¨æ—¶ï¼Œä»–ä»¬éƒ½æ˜¯è·Ÿéšè€…èº«ä»½ã€‚ä¸€ä¸ªæœåŠ¡å™¨èŠ‚ç‚¹ç»§ç»­ä¿æŒç€è·Ÿéšè€…çŠ¶æ€åªè¦ä»–ä»é¢†å¯¼äººæˆ–è€…å€™é€‰äººå¤„æ¥æ”¶åˆ°æœ‰æ•ˆçš„ RPCsã€‚é¢†å¯¼äººå‘¨æœŸæ€§çš„å‘æ‰€æœ‰è·Ÿéšè€…å‘é€å¿ƒè·³åŒ…ï¼ˆå³ä¸åŒ…å«æ—¥å¿—é¡¹å†…å®¹çš„é™„åŠ æ¡ç›®ï¼ˆAppendEntriesï¼‰ RPCsï¼‰æ¥ç»´æŒè‡ªå·±çš„æƒå¨ã€‚å¦‚æœä¸€ä¸ªè·Ÿéšè€…åœ¨ä¸€æ®µæ—¶é—´é‡Œæ²¡æœ‰æ¥æ”¶åˆ°ä»»ä½•æ¶ˆæ¯ï¼Œä¹Ÿå°±æ˜¯**é€‰ä¸¾è¶…æ—¶**ï¼Œé‚£ä¹ˆä»–å°±ä¼šè®¤ä¸ºç³»ç»Ÿä¸­æ²¡æœ‰å¯ç”¨çš„é¢†å¯¼äºº,å¹¶ä¸”å‘èµ·é€‰ä¸¾ä»¥é€‰å‡ºæ–°çš„é¢†å¯¼äººã€‚\n\nè¦å¼€å§‹ä¸€æ¬¡é€‰ä¸¾è¿‡ç¨‹ï¼Œè·Ÿéšè€…å…ˆè¦å¢åŠ è‡ªå·±çš„å½“å‰ä»»æœŸå·å¹¶ä¸”è½¬æ¢åˆ°å€™é€‰äººçŠ¶æ€ã€‚ç„¶åä»–ä¼šå¹¶è¡Œåœ°å‘é›†ç¾¤ä¸­çš„å…¶ä»–æœåŠ¡å™¨èŠ‚ç‚¹å‘é€è¯·æ±‚æŠ•ç¥¨çš„ RPCs æ¥ç»™è‡ªå·±æŠ•ç¥¨ã€‚å€™é€‰äººä¼šç»§ç»­ä¿æŒç€å½“å‰çŠ¶æ€ç›´åˆ°ä»¥ä¸‹ä¸‰ä»¶äº‹æƒ…ä¹‹ä¸€å‘ç”Ÿï¼š(a) ä»–è‡ªå·±èµ¢å¾—äº†è¿™æ¬¡çš„é€‰ä¸¾ï¼Œ(b) å…¶ä»–çš„æœåŠ¡å™¨æˆä¸ºé¢†å¯¼äººï¼Œ(c) ä¸€æ®µæ—¶é—´ä¹‹åæ²¡æœ‰ä»»ä½•ä¸€ä¸ªè·èƒœçš„äººã€‚è¿™äº›ç»“æœä¼šåˆ†åˆ«çš„åœ¨ä¸‹é¢çš„æ®µè½é‡Œè¿›è¡Œè®¨è®ºã€‚\n\nå½“ä¸€ä¸ªå€™é€‰äººä»æ•´ä¸ªé›†ç¾¤çš„å¤§å¤šæ•°æœåŠ¡å™¨èŠ‚ç‚¹è·å¾—äº†é’ˆå¯¹åŒä¸€ä¸ªä»»æœŸå·çš„é€‰ç¥¨ï¼Œé‚£ä¹ˆä»–å°±èµ¢å¾—äº†è¿™æ¬¡é€‰ä¸¾å¹¶æˆä¸ºé¢†å¯¼äººã€‚æ¯ä¸€ä¸ªæœåŠ¡å™¨æœ€å¤šä¼šå¯¹ä¸€ä¸ªä»»æœŸå·æŠ•å‡ºä¸€å¼ é€‰ç¥¨ï¼ŒæŒ‰ç…§å…ˆæ¥å…ˆæœåŠ¡çš„åŸåˆ™ï¼ˆæ³¨æ„ï¼š5.4 èŠ‚åœ¨æŠ•ç¥¨ä¸Šå¢åŠ äº†ä¸€ç‚¹é¢å¤–çš„é™åˆ¶ï¼‰ã€‚è¦æ±‚å¤§å¤šæ•°é€‰ç¥¨çš„è§„åˆ™ç¡®ä¿äº†æœ€å¤šåªä¼šæœ‰ä¸€ä¸ªå€™é€‰äººèµ¢å¾—æ­¤æ¬¡é€‰ä¸¾ï¼ˆå›¾ 3 ä¸­çš„é€‰ä¸¾å®‰å…¨æ€§ï¼‰ã€‚ä¸€æ—¦å€™é€‰äººèµ¢å¾—é€‰ä¸¾ï¼Œä»–å°±ç«‹å³æˆä¸ºé¢†å¯¼äººã€‚ç„¶åä»–ä¼šå‘å…¶ä»–çš„æœåŠ¡å™¨å‘é€å¿ƒè·³æ¶ˆæ¯æ¥å»ºç«‹è‡ªå·±çš„æƒå¨å¹¶ä¸”é˜»æ­¢å‘èµ·æ–°çš„é€‰ä¸¾ã€‚\n\nåœ¨ç­‰å¾…æŠ•ç¥¨çš„æ—¶å€™ï¼Œå€™é€‰äººå¯èƒ½ä¼šä»å…¶ä»–çš„æœåŠ¡å™¨æ¥æ”¶åˆ°å£°æ˜å®ƒæ˜¯é¢†å¯¼äººçš„é™„åŠ æ¡ç›®ï¼ˆAppendEntriesï¼‰RPCã€‚å¦‚æœè¿™ä¸ªé¢†å¯¼äººçš„ä»»æœŸå·ï¼ˆåŒ…å«åœ¨æ­¤æ¬¡çš„ RPCä¸­ï¼‰ä¸å°äºå€™é€‰äººå½“å‰çš„ä»»æœŸå·ï¼Œé‚£ä¹ˆå€™é€‰äººä¼šæ‰¿è®¤é¢†å¯¼äººåˆæ³•å¹¶å›åˆ°è·Ÿéšè€…çŠ¶æ€ã€‚ å¦‚æœæ­¤æ¬¡ RPC ä¸­çš„ä»»æœŸå·æ¯”è‡ªå·±å°ï¼Œé‚£ä¹ˆå€™é€‰äººå°±ä¼šæ‹’ç»è¿™æ¬¡çš„ RPC å¹¶ä¸”ç»§ç»­ä¿æŒå€™é€‰äººçŠ¶æ€ã€‚\n\nç¬¬ä¸‰ç§å¯èƒ½çš„ç»“æœæ˜¯å€™é€‰äººæ—¢æ²¡æœ‰èµ¢å¾—é€‰ä¸¾ä¹Ÿæ²¡æœ‰è¾“ï¼šå¦‚æœæœ‰å¤šä¸ªè·Ÿéšè€…åŒæ—¶æˆä¸ºå€™é€‰äººï¼Œé‚£ä¹ˆé€‰ç¥¨å¯èƒ½ä¼šè¢«ç“œåˆ†ä»¥è‡³äºæ²¡æœ‰å€™é€‰äººå¯ä»¥èµ¢å¾—å¤§å¤šæ•°äººçš„æ”¯æŒã€‚å½“è¿™ç§æƒ…å†µå‘ç”Ÿçš„æ—¶å€™ï¼Œæ¯ä¸€ä¸ªå€™é€‰äººéƒ½ä¼šè¶…æ—¶ï¼Œç„¶åé€šè¿‡å¢åŠ å½“å‰ä»»æœŸå·æ¥å¼€å§‹ä¸€è½®æ–°çš„é€‰ä¸¾ã€‚ç„¶è€Œï¼Œæ²¡æœ‰å…¶ä»–æœºåˆ¶çš„è¯ï¼Œé€‰ç¥¨å¯èƒ½ä¼šè¢«æ— é™çš„é‡å¤ç“œåˆ†ã€‚\n\nRaft ç®—æ³•ä½¿ç”¨éšæœºé€‰ä¸¾è¶…æ—¶æ—¶é—´çš„æ–¹æ³•æ¥ç¡®ä¿å¾ˆå°‘ä¼šå‘ç”Ÿé€‰ç¥¨ç“œåˆ†çš„æƒ…å†µï¼Œå°±ç®—å‘ç”Ÿä¹Ÿèƒ½å¾ˆå¿«çš„è§£å†³ã€‚ä¸ºäº†é˜»æ­¢é€‰ç¥¨èµ·åˆå°±è¢«ç“œåˆ†ï¼Œé€‰ä¸¾è¶…æ—¶æ—¶é—´æ˜¯ä»ä¸€ä¸ªå›ºå®šçš„åŒºé—´ï¼ˆä¾‹å¦‚ 150-300 æ¯«ç§’ï¼‰éšæœºé€‰æ‹©ã€‚è¿™æ ·å¯ä»¥æŠŠæœåŠ¡å™¨éƒ½åˆ†æ•£å¼€ä»¥è‡³äºåœ¨å¤§å¤šæ•°æƒ…å†µä¸‹åªæœ‰ä¸€ä¸ªæœåŠ¡å™¨ä¼šé€‰ä¸¾è¶…æ—¶ï¼›ç„¶åä»–èµ¢å¾—é€‰ä¸¾å¹¶åœ¨å…¶ä»–æœåŠ¡å™¨è¶…æ—¶ä¹‹å‰å‘é€å¿ƒè·³åŒ…ã€‚åŒæ ·çš„æœºåˆ¶è¢«ç”¨åœ¨é€‰ç¥¨ç“œåˆ†çš„æƒ…å†µä¸‹ã€‚æ¯ä¸€ä¸ªå€™é€‰äººåœ¨å¼€å§‹ä¸€æ¬¡é€‰ä¸¾çš„æ—¶å€™ä¼šé‡ç½®ä¸€ä¸ªéšæœºçš„é€‰ä¸¾è¶…æ—¶æ—¶é—´ï¼Œç„¶ååœ¨è¶…æ—¶æ—¶é—´å†…ç­‰å¾…æŠ•ç¥¨çš„ç»“æœï¼›è¿™æ ·å‡å°‘äº†åœ¨æ–°çš„é€‰ä¸¾ä¸­å¦å¤–çš„é€‰ç¥¨ç“œåˆ†çš„å¯èƒ½æ€§ã€‚9.3 èŠ‚å±•ç¤ºäº†è¿™ç§æ–¹æ¡ˆèƒ½å¤Ÿå¿«é€Ÿçš„é€‰å‡ºä¸€ä¸ªé¢†å¯¼äººã€‚\n\né¢†å¯¼äººé€‰ä¸¾è¿™ä¸ªä¾‹å­ï¼Œä½“ç°äº†å¯ç†è§£æ€§åŸåˆ™æ˜¯å¦‚ä½•æŒ‡å¯¼æˆ‘ä»¬è¿›è¡Œæ–¹æ¡ˆè®¾è®¡çš„ã€‚èµ·åˆæˆ‘ä»¬è®¡åˆ’ä½¿ç”¨ä¸€ç§æ’åç³»ç»Ÿï¼šæ¯ä¸€ä¸ªå€™é€‰äººéƒ½è¢«èµ‹äºˆä¸€ä¸ªå”¯ä¸€çš„æ’åï¼Œä¾›å€™é€‰äººä¹‹é—´ç«äº‰æ—¶è¿›è¡Œé€‰æ‹©ã€‚å¦‚æœä¸€ä¸ªå€™é€‰äººå‘ç°å¦ä¸€ä¸ªå€™é€‰äººæ‹¥æœ‰æ›´é«˜çš„æ’åï¼Œé‚£ä¹ˆä»–å°±ä¼šå›åˆ°è·Ÿéšè€…çŠ¶æ€ï¼Œè¿™æ ·é«˜æ’åçš„å€™é€‰äººèƒ½å¤Ÿæ›´åŠ å®¹æ˜“çš„èµ¢å¾—ä¸‹ä¸€æ¬¡é€‰ä¸¾ã€‚ä½†æ˜¯æˆ‘ä»¬å‘ç°è¿™ç§æ–¹æ³•åœ¨å¯ç”¨æ€§æ–¹é¢ä¼šæœ‰ä¸€ç‚¹é—®é¢˜ï¼ˆå¦‚æœé«˜æ’åçš„æœåŠ¡å™¨å®•æœºäº†ï¼Œé‚£ä¹ˆä½æ’åçš„æœåŠ¡å™¨å¯èƒ½ä¼šè¶…æ—¶å¹¶å†æ¬¡è¿›å…¥å€™é€‰äººçŠ¶æ€ã€‚è€Œä¸”å¦‚æœè¿™ä¸ªè¡Œä¸ºå‘ç”Ÿå¾—è¶³å¤Ÿå¿«ï¼Œåˆ™å¯èƒ½ä¼šå¯¼è‡´æ•´ä¸ªé€‰ä¸¾è¿‡ç¨‹éƒ½è¢«é‡ç½®æ‰ï¼‰ã€‚æˆ‘ä»¬é’ˆå¯¹ç®—æ³•è¿›è¡Œäº†å¤šæ¬¡è°ƒæ•´ï¼Œä½†æ˜¯æ¯æ¬¡è°ƒæ•´ä¹‹åéƒ½ä¼šæœ‰æ–°çš„é—®é¢˜ã€‚æœ€ç»ˆæˆ‘ä»¬è®¤ä¸ºéšæœºé‡è¯•çš„æ–¹æ³•æ˜¯æ›´åŠ æ˜æ˜¾å’Œæ˜“äºç†è§£çš„ã€‚\n\n### 5.3 æ—¥å¿—å¤åˆ¶\n\nä¸€æ—¦ä¸€ä¸ªé¢†å¯¼äººè¢«é€‰ä¸¾å‡ºæ¥ï¼Œä»–å°±å¼€å§‹ä¸ºå®¢æˆ·ç«¯æä¾›æœåŠ¡ã€‚å®¢æˆ·ç«¯çš„æ¯ä¸€ä¸ªè¯·æ±‚éƒ½åŒ…å«ä¸€æ¡è¢«å¤åˆ¶çŠ¶æ€æœºæ‰§è¡Œçš„æŒ‡ä»¤ã€‚é¢†å¯¼äººæŠŠè¿™æ¡æŒ‡ä»¤ä½œä¸ºä¸€æ¡æ–°çš„æ—¥å¿—æ¡ç›®é™„åŠ åˆ°æ—¥å¿—ä¸­å»ï¼Œç„¶åå¹¶è¡Œåœ°å‘èµ·é™„åŠ æ¡ç›® RPCs ç»™å…¶ä»–çš„æœåŠ¡å™¨ï¼Œè®©ä»–ä»¬å¤åˆ¶è¿™æ¡æ—¥å¿—æ¡ç›®ã€‚å½“è¿™æ¡æ—¥å¿—æ¡ç›®è¢«å®‰å…¨åœ°å¤åˆ¶ï¼ˆä¸‹é¢ä¼šä»‹ç»ï¼‰ï¼Œé¢†å¯¼äººä¼šåº”ç”¨è¿™æ¡æ—¥å¿—æ¡ç›®åˆ°å®ƒçš„çŠ¶æ€æœºä¸­ç„¶åæŠŠæ‰§è¡Œçš„ç»“æœè¿”å›ç»™å®¢æˆ·ç«¯ã€‚å¦‚æœè·Ÿéšè€…å´©æºƒæˆ–è€…è¿è¡Œç¼“æ…¢ï¼Œå†æˆ–è€…ç½‘ç»œä¸¢åŒ…ï¼Œé¢†å¯¼äººä¼šä¸æ–­çš„é‡å¤å°è¯•é™„åŠ æ—¥å¿—æ¡ç›® RPCs ï¼ˆå°½ç®¡å·²ç»å›å¤äº†å®¢æˆ·ç«¯ï¼‰ç›´åˆ°æ‰€æœ‰çš„è·Ÿéšè€…éƒ½æœ€ç»ˆå­˜å‚¨äº†æ‰€æœ‰çš„æ—¥å¿—æ¡ç›®ã€‚\n\n![å›¾ 6](/img/2023-06-25-raft-zh_cn/raft-å›¾6.png)\n\n> å›¾ 6ï¼šæ—¥å¿—ç”±æœ‰åºåºå·æ ‡è®°çš„æ¡ç›®ç»„æˆã€‚æ¯ä¸ªæ¡ç›®éƒ½åŒ…å«åˆ›å»ºæ—¶çš„ä»»æœŸå·ï¼ˆå›¾ä¸­æ¡†ä¸­çš„æ•°å­—ï¼‰ï¼Œå’Œä¸€ä¸ªçŠ¶æ€æœºéœ€è¦æ‰§è¡Œçš„æŒ‡ä»¤ã€‚ä¸€ä¸ªæ¡ç›®å½“å¯ä»¥å®‰å…¨åœ°è¢«åº”ç”¨åˆ°çŠ¶æ€æœºä¸­å»çš„æ—¶å€™ï¼Œå°±è®¤ä¸ºæ˜¯å¯ä»¥æäº¤äº†ã€‚\n\næ—¥å¿—ä»¥å›¾ 6 å±•ç¤ºçš„æ–¹å¼ç»„ç»‡ã€‚æ¯ä¸€ä¸ªæ—¥å¿—æ¡ç›®å­˜å‚¨ä¸€æ¡çŠ¶æ€æœºæŒ‡ä»¤å’Œä»é¢†å¯¼äººæ”¶åˆ°è¿™æ¡æŒ‡ä»¤æ—¶çš„ä»»æœŸå·ã€‚æ—¥å¿—ä¸­çš„ä»»æœŸå·ç”¨æ¥æ£€æŸ¥æ˜¯å¦å‡ºç°ä¸ä¸€è‡´çš„æƒ…å†µï¼ŒåŒæ—¶ä¹Ÿç”¨æ¥ä¿è¯å›¾ 3 ä¸­çš„æŸäº›æ€§è´¨ã€‚æ¯ä¸€æ¡æ—¥å¿—æ¡ç›®åŒæ—¶ä¹Ÿéƒ½æœ‰ä¸€ä¸ªæ•´æ•°ç´¢å¼•å€¼æ¥è¡¨æ˜å®ƒåœ¨æ—¥å¿—ä¸­çš„ä½ç½®ã€‚\n\né¢†å¯¼äººæ¥å†³å®šä»€ä¹ˆæ—¶å€™æŠŠæ—¥å¿—æ¡ç›®åº”ç”¨åˆ°çŠ¶æ€æœºä¸­æ˜¯å®‰å…¨çš„ï¼›è¿™ç§æ—¥å¿—æ¡ç›®è¢«ç§°ä¸º**å·²æäº¤**ã€‚Raft ç®—æ³•ä¿è¯æ‰€æœ‰å·²æäº¤çš„æ—¥å¿—æ¡ç›®éƒ½æ˜¯æŒä¹…åŒ–çš„å¹¶ä¸”æœ€ç»ˆä¼šè¢«æ‰€æœ‰å¯ç”¨çš„çŠ¶æ€æœºæ‰§è¡Œã€‚åœ¨é¢†å¯¼äººå°†åˆ›å»ºçš„æ—¥å¿—æ¡ç›®å¤åˆ¶åˆ°å¤§å¤šæ•°çš„æœåŠ¡å™¨ä¸Šçš„æ—¶å€™ï¼Œæ—¥å¿—æ¡ç›®å°±ä¼šè¢«æäº¤ï¼ˆä¾‹å¦‚åœ¨å›¾ 6 ä¸­çš„æ¡ç›® 7ï¼‰ã€‚åŒæ—¶ï¼Œé¢†å¯¼äººçš„æ—¥å¿—ä¸­ä¹‹å‰çš„æ‰€æœ‰æ—¥å¿—æ¡ç›®ä¹Ÿéƒ½ä¼šè¢«æäº¤ï¼ŒåŒ…æ‹¬ç”±å…¶ä»–é¢†å¯¼äººåˆ›å»ºçš„æ¡ç›®ã€‚5.4 èŠ‚ä¼šè®¨è®ºæŸäº›å½“åœ¨é¢†å¯¼äººæ”¹å˜ä¹‹ååº”ç”¨è¿™æ¡è§„åˆ™çš„éšæ™¦å†…å®¹ï¼ŒåŒæ—¶ä»–ä¹Ÿå±•ç¤ºäº†è¿™ç§æäº¤çš„å®šä¹‰æ˜¯å®‰å…¨çš„ã€‚é¢†å¯¼äººè·Ÿè¸ªäº†æœ€å¤§çš„å°†ä¼šè¢«æäº¤çš„æ—¥å¿—é¡¹çš„ç´¢å¼•ï¼Œå¹¶ä¸”ç´¢å¼•å€¼ä¼šè¢«åŒ…å«åœ¨æœªæ¥çš„æ‰€æœ‰é™„åŠ æ—¥å¿— RPCs ï¼ˆåŒ…æ‹¬å¿ƒè·³åŒ…ï¼‰ï¼Œè¿™æ ·å…¶ä»–çš„æœåŠ¡å™¨æ‰èƒ½æœ€ç»ˆçŸ¥é“é¢†å¯¼äººçš„æäº¤ä½ç½®ã€‚ä¸€æ—¦è·Ÿéšè€…çŸ¥é“ä¸€æ¡æ—¥å¿—æ¡ç›®å·²ç»è¢«æäº¤ï¼Œé‚£ä¹ˆä»–ä¹Ÿä¼šå°†è¿™ä¸ªæ—¥å¿—æ¡ç›®åº”ç”¨åˆ°æœ¬åœ°çš„çŠ¶æ€æœºä¸­ï¼ˆæŒ‰ç…§æ—¥å¿—çš„é¡ºåºï¼‰ã€‚\n\næˆ‘ä»¬è®¾è®¡äº† Raft çš„æ—¥å¿—æœºåˆ¶æ¥ç»´æŠ¤ä¸åŒæœåŠ¡å™¨æ—¥å¿—ä¹‹é—´çš„é«˜å±‚æ¬¡çš„ä¸€è‡´æ€§ã€‚è¿™ä¹ˆåšä¸ä»…ç®€åŒ–äº†ç³»ç»Ÿçš„è¡Œä¸ºä¹Ÿä½¿å…¶æ›´å…·æœ‰å¯é¢„æµ‹æ€§ï¼ŒåŒæ—¶å®ƒä¹Ÿæ˜¯å®‰å…¨æ€§ä¿è¯çš„ä¸€ä¸ªé‡è¦ç»„ä»¶ã€‚Raft ç»´æŠ¤ç€ä»¥ä¸‹çš„ç‰¹æ€§ï¼Œè¿™äº›ç‰¹æ€§å…±åŒç»„æˆäº†å›¾ 3 ä¸­çš„**æ—¥å¿—åŒ¹é…ç‰¹æ€§ï¼ˆLog Matching Propertyï¼‰**ï¼š\n\n* å¦‚æœåœ¨ä¸åŒçš„æ—¥å¿—ä¸­çš„ä¸¤ä¸ªæ¡ç›®æ‹¥æœ‰ç›¸åŒçš„ç´¢å¼•å’Œä»»æœŸå·ï¼Œé‚£ä¹ˆä»–ä»¬å­˜å‚¨äº†ç›¸åŒçš„æŒ‡ä»¤ã€‚\n* å¦‚æœåœ¨ä¸åŒçš„æ—¥å¿—ä¸­çš„ä¸¤ä¸ªæ¡ç›®æ‹¥æœ‰ç›¸åŒçš„ç´¢å¼•å’Œä»»æœŸå·ï¼Œé‚£ä¹ˆä»–ä»¬ä¹‹å‰çš„æ‰€æœ‰æ—¥å¿—æ¡ç›®ä¹Ÿå…¨éƒ¨ç›¸åŒã€‚\n\nç¬¬ä¸€ä¸ªç‰¹æ€§æ¥è‡ªè¿™æ ·çš„ä¸€ä¸ªäº‹å®ï¼Œé¢†å¯¼äººæœ€å¤šåœ¨ä¸€ä¸ªä»»æœŸé‡Œåœ¨æŒ‡å®šçš„ä¸€ä¸ªæ—¥å¿—ç´¢å¼•ä½ç½®åˆ›å»ºä¸€æ¡æ—¥å¿—æ¡ç›®ï¼ŒåŒæ—¶æ—¥å¿—æ¡ç›®åœ¨æ—¥å¿—ä¸­çš„ä½ç½®ä¹Ÿä»æ¥ä¸ä¼šæ”¹å˜ã€‚ç¬¬äºŒä¸ªç‰¹æ€§ç”±é™„åŠ æ—¥å¿— RPC çš„ä¸€ä¸ªç®€å•çš„ä¸€è‡´æ€§æ£€æŸ¥æ‰€ä¿è¯ã€‚åœ¨å‘é€é™„åŠ æ—¥å¿— RPC çš„æ—¶å€™ï¼Œé¢†å¯¼äººä¼šæŠŠæ–°çš„æ—¥å¿—æ¡ç›®å‰ç´§æŒ¨ç€çš„æ¡ç›®çš„ç´¢å¼•ä½ç½®å’Œä»»æœŸå·åŒ…å«åœ¨æ—¥å¿—å†…ã€‚å¦‚æœè·Ÿéšè€…åœ¨å®ƒçš„æ—¥å¿—ä¸­æ‰¾ä¸åˆ°åŒ…å«ç›¸åŒç´¢å¼•ä½ç½®å’Œä»»æœŸå·çš„æ¡ç›®ï¼Œé‚£ä¹ˆä»–å°±ä¼šæ‹’ç»æ¥æ”¶æ–°çš„æ—¥å¿—æ¡ç›®ã€‚ä¸€è‡´æ€§æ£€æŸ¥å°±åƒä¸€ä¸ªå½’çº³æ­¥éª¤ï¼šä¸€å¼€å§‹ç©ºçš„æ—¥å¿—çŠ¶æ€è‚¯å®šæ˜¯æ»¡è¶³æ—¥å¿—åŒ¹é…ç‰¹æ€§çš„ï¼Œç„¶åä¸€è‡´æ€§æ£€æŸ¥åœ¨æ—¥å¿—æ‰©å±•çš„æ—¶å€™ä¿æŠ¤äº†æ—¥å¿—åŒ¹é…ç‰¹æ€§ã€‚å› æ­¤ï¼Œæ¯å½“é™„åŠ æ—¥å¿— RPC è¿”å›æˆåŠŸæ—¶ï¼Œé¢†å¯¼äººå°±çŸ¥é“è·Ÿéšè€…çš„æ—¥å¿—ä¸€å®šæ˜¯å’Œè‡ªå·±ç›¸åŒçš„äº†ã€‚\n\nåœ¨æ­£å¸¸çš„æ“ä½œä¸­ï¼Œé¢†å¯¼äººå’Œè·Ÿéšè€…çš„æ—¥å¿—ä¿æŒä¸€è‡´æ€§ï¼Œæ‰€ä»¥é™„åŠ æ—¥å¿— RPC çš„ä¸€è‡´æ€§æ£€æŸ¥ä»æ¥ä¸ä¼šå¤±è´¥ã€‚ç„¶è€Œï¼Œé¢†å¯¼äººå´©æºƒçš„æƒ…å†µä¼šä½¿å¾—æ—¥å¿—å¤„äºä¸ä¸€è‡´çš„çŠ¶æ€ï¼ˆè€çš„é¢†å¯¼äººå¯èƒ½è¿˜æ²¡æœ‰å®Œå…¨å¤åˆ¶æ‰€æœ‰çš„æ—¥å¿—æ¡ç›®ï¼‰ã€‚è¿™ç§ä¸ä¸€è‡´é—®é¢˜ä¼šåœ¨é¢†å¯¼äººå’Œè·Ÿéšè€…çš„ä¸€ç³»åˆ—å´©æºƒä¸‹åŠ å‰§ã€‚å›¾ 7 å±•ç¤ºäº†è·Ÿéšè€…çš„æ—¥å¿—å¯èƒ½å’Œæ–°çš„é¢†å¯¼äººä¸åŒã€‚è·Ÿéšè€…å¯èƒ½ä¼šä¸¢å¤±ä¸€äº›åœ¨æ–°çš„é¢†å¯¼äººä¸­å­˜åœ¨çš„æ—¥å¿—æ¡ç›®ï¼Œä»–ä¹Ÿå¯èƒ½æ‹¥æœ‰ä¸€äº›é¢†å¯¼äººæ²¡æœ‰çš„æ—¥å¿—æ¡ç›®ï¼Œæˆ–è€…ä¸¤è€…éƒ½å‘ç”Ÿã€‚ä¸¢å¤±æˆ–è€…å¤šå‡ºæ—¥å¿—æ¡ç›®å¯èƒ½ä¼šæŒç»­å¤šä¸ªä»»æœŸã€‚\n\n![å›¾ 7](/img/2023-06-25-raft-zh_cn/raft-å›¾7.png)\n\n> å›¾ 7ï¼šå½“ä¸€ä¸ªé¢†å¯¼äººæˆåŠŸå½“é€‰æ—¶ï¼Œè·Ÿéšè€…å¯èƒ½æ˜¯ä»»ä½•æƒ…å†µï¼ˆa-fï¼‰ã€‚æ¯ä¸€ä¸ªç›’å­è¡¨ç¤ºæ˜¯ä¸€ä¸ªæ—¥å¿—æ¡ç›®ï¼›é‡Œé¢çš„æ•°å­—è¡¨ç¤ºä»»æœŸå·ã€‚è·Ÿéšè€…å¯èƒ½ä¼šç¼ºå°‘ä¸€äº›æ—¥å¿—æ¡ç›®ï¼ˆa-bï¼‰ï¼Œå¯èƒ½ä¼šæœ‰ä¸€äº›æœªè¢«æäº¤çš„æ—¥å¿—æ¡ç›®ï¼ˆc-dï¼‰ï¼Œæˆ–è€…ä¸¤ç§æƒ…å†µéƒ½å­˜åœ¨ï¼ˆe-fï¼‰ã€‚ä¾‹å¦‚ï¼Œåœºæ™¯ f å¯èƒ½ä¼šè¿™æ ·å‘ç”Ÿï¼ŒæŸæœåŠ¡å™¨åœ¨ä»»æœŸ 2 çš„æ—¶å€™æ˜¯é¢†å¯¼äººï¼Œå·²é™„åŠ äº†ä¸€äº›æ—¥å¿—æ¡ç›®åˆ°è‡ªå·±çš„æ—¥å¿—ä¸­ï¼Œä½†åœ¨æäº¤ä¹‹å‰å°±å´©æºƒäº†ï¼›å¾ˆå¿«è¿™ä¸ªæœºå™¨å°±è¢«é‡å¯äº†ï¼Œåœ¨ä»»æœŸ 3 é‡æ–°è¢«é€‰ä¸ºé¢†å¯¼äººï¼Œå¹¶ä¸”åˆå¢åŠ äº†ä¸€äº›æ—¥å¿—æ¡ç›®åˆ°è‡ªå·±çš„æ—¥å¿—ä¸­ï¼›åœ¨ä»»æœŸ 2 å’Œä»»æœŸ 3 çš„æ—¥å¿—è¢«æäº¤ä¹‹å‰ï¼Œè¿™ä¸ªæœåŠ¡å™¨åˆå®•æœºäº†ï¼Œå¹¶ä¸”åœ¨æ¥ä¸‹æ¥çš„å‡ ä¸ªä»»æœŸé‡Œä¸€ç›´å¤„äºå®•æœºçŠ¶æ€ã€‚\n\nåœ¨ Raft ç®—æ³•ä¸­ï¼Œé¢†å¯¼äººæ˜¯é€šè¿‡å¼ºåˆ¶è·Ÿéšè€…ç›´æ¥å¤åˆ¶è‡ªå·±çš„æ—¥å¿—æ¥å¤„ç†ä¸ä¸€è‡´é—®é¢˜çš„ã€‚è¿™æ„å‘³ç€åœ¨è·Ÿéšè€…ä¸­çš„å†²çªçš„æ—¥å¿—æ¡ç›®ä¼šè¢«é¢†å¯¼äººçš„æ—¥å¿—è¦†ç›–ã€‚5.4 èŠ‚ä¼šé˜è¿°å¦‚ä½•é€šè¿‡å¢åŠ ä¸€äº›é™åˆ¶æ¥ä½¿å¾—è¿™æ ·çš„æ“ä½œæ˜¯å®‰å…¨çš„ã€‚\n\nè¦ä½¿å¾—è·Ÿéšè€…çš„æ—¥å¿—è¿›å…¥å’Œè‡ªå·±ä¸€è‡´çš„çŠ¶æ€ï¼Œé¢†å¯¼äººå¿…é¡»æ‰¾åˆ°æœ€åä¸¤è€…è¾¾æˆä¸€è‡´çš„åœ°æ–¹ï¼Œç„¶ååˆ é™¤è·Ÿéšè€…ä»é‚£ä¸ªç‚¹ä¹‹åçš„æ‰€æœ‰æ—¥å¿—æ¡ç›®ï¼Œå¹¶å‘é€è‡ªå·±åœ¨é‚£ä¸ªç‚¹ä¹‹åçš„æ—¥å¿—ç»™è·Ÿéšè€…ã€‚æ‰€æœ‰çš„è¿™äº›æ“ä½œéƒ½åœ¨è¿›è¡Œé™„åŠ æ—¥å¿— RPCs çš„ä¸€è‡´æ€§æ£€æŸ¥æ—¶å®Œæˆã€‚é¢†å¯¼äººé’ˆå¯¹æ¯ä¸€ä¸ªè·Ÿéšè€…ç»´æŠ¤äº†ä¸€ä¸ª **nextIndex**ï¼Œè¿™è¡¨ç¤ºä¸‹ä¸€ä¸ªéœ€è¦å‘é€ç»™è·Ÿéšè€…çš„æ—¥å¿—æ¡ç›®çš„ç´¢å¼•åœ°å€ã€‚å½“ä¸€ä¸ªé¢†å¯¼äººåˆšè·å¾—æƒåŠ›çš„æ—¶å€™ï¼Œä»–åˆå§‹åŒ–æ‰€æœ‰çš„ nextIndex å€¼ä¸ºè‡ªå·±çš„æœ€åä¸€æ¡æ—¥å¿—çš„ index åŠ  1ï¼ˆå›¾ 7 ä¸­çš„ 11ï¼‰ã€‚å¦‚æœä¸€ä¸ªè·Ÿéšè€…çš„æ—¥å¿—å’Œé¢†å¯¼äººä¸ä¸€è‡´ï¼Œé‚£ä¹ˆåœ¨ä¸‹ä¸€æ¬¡çš„é™„åŠ æ—¥å¿— RPC æ—¶çš„ä¸€è‡´æ€§æ£€æŸ¥å°±ä¼šå¤±è´¥ã€‚åœ¨è¢«è·Ÿéšè€…æ‹’ç»ä¹‹åï¼Œé¢†å¯¼äººå°±ä¼šå‡å° nextIndex å€¼å¹¶è¿›è¡Œé‡è¯•ã€‚æœ€ç»ˆ nextIndex ä¼šåœ¨æŸä¸ªä½ç½®ä½¿å¾—é¢†å¯¼äººå’Œè·Ÿéšè€…çš„æ—¥å¿—è¾¾æˆä¸€è‡´ã€‚å½“è¿™ç§æƒ…å†µå‘ç”Ÿï¼Œé™„åŠ æ—¥å¿— RPC å°±ä¼šæˆåŠŸï¼Œè¿™æ—¶å°±ä¼šæŠŠè·Ÿéšè€…å†²çªçš„æ—¥å¿—æ¡ç›®å…¨éƒ¨åˆ é™¤å¹¶ä¸”åŠ ä¸Šé¢†å¯¼äººçš„æ—¥å¿—ã€‚ä¸€æ—¦é™„åŠ æ—¥å¿— RPC æˆåŠŸï¼Œé‚£ä¹ˆè·Ÿéšè€…çš„æ—¥å¿—å°±ä¼šå’Œé¢†å¯¼äººä¿æŒä¸€è‡´ï¼Œå¹¶ä¸”åœ¨æ¥ä¸‹æ¥çš„ä»»æœŸé‡Œä¸€ç›´ç»§ç»­ä¿æŒã€‚\n\n> å¦‚æœéœ€è¦çš„è¯ï¼Œç®—æ³•å¯ä»¥é€šè¿‡å‡å°‘è¢«æ‹’ç»çš„é™„åŠ æ—¥å¿— RPCs çš„æ¬¡æ•°æ¥ä¼˜åŒ–ã€‚ä¾‹å¦‚ï¼Œå½“é™„åŠ æ—¥å¿— RPC çš„è¯·æ±‚è¢«æ‹’ç»çš„æ—¶å€™ï¼Œè·Ÿéšè€…å¯ä»¥(è¿”å›)å†²çªæ¡ç›®çš„ä»»æœŸå·å’Œè¯¥ä»»æœŸå·å¯¹åº”çš„æœ€å°ç´¢å¼•åœ°å€ã€‚å€ŸåŠ©è¿™äº›ä¿¡æ¯ï¼Œé¢†å¯¼äººå¯ä»¥å‡å° nextIndex ä¸€æ¬¡æ€§è¶Šè¿‡è¯¥å†²çªä»»æœŸçš„æ‰€æœ‰æ—¥å¿—æ¡ç›®ï¼›è¿™æ ·å°±å˜æˆæ¯ä¸ªä»»æœŸéœ€è¦ä¸€æ¬¡é™„åŠ æ¡ç›® RPC è€Œä¸æ˜¯æ¯ä¸ªæ¡ç›®ä¸€æ¬¡ã€‚åœ¨å®è·µä¸­ï¼Œæˆ‘ä»¬ååˆ†æ€€ç–‘è¿™ç§ä¼˜åŒ–æ˜¯å¦æ˜¯å¿…è¦çš„ï¼Œå› ä¸ºå¤±è´¥æ˜¯å¾ˆå°‘å‘ç”Ÿçš„å¹¶ä¸”ä¹Ÿä¸å¤§å¯èƒ½ä¼šæœ‰è¿™ä¹ˆå¤šä¸ä¸€è‡´çš„æ—¥å¿—ã€‚\n\né€šè¿‡è¿™ç§æœºåˆ¶ï¼Œé¢†å¯¼äººåœ¨è·å¾—æƒåŠ›çš„æ—¶å€™å°±ä¸éœ€è¦ä»»ä½•ç‰¹æ®Šçš„æ“ä½œæ¥æ¢å¤ä¸€è‡´æ€§ã€‚ä»–åªéœ€è¦è¿›è¡Œæ­£å¸¸çš„æ“ä½œï¼Œç„¶åæ—¥å¿—å°±èƒ½åœ¨å›å¤é™„åŠ æ—¥å¿— RPC çš„ä¸€è‡´æ€§æ£€æŸ¥å¤±è´¥çš„æ—¶å€™è‡ªåŠ¨è¶‹äºä¸€è‡´ã€‚é¢†å¯¼äººä»æ¥ä¸ä¼šè¦†ç›–æˆ–è€…åˆ é™¤è‡ªå·±çš„æ—¥å¿—ï¼ˆå›¾ 3 çš„é¢†å¯¼äººåªé™„åŠ ç‰¹æ€§ï¼‰ã€‚\n\næ—¥å¿—å¤åˆ¶æœºåˆ¶å±•ç¤ºå‡ºäº†ç¬¬ 2 èŠ‚ä¸­å½¢å®¹çš„ä¸€è‡´æ€§ç‰¹æ€§ï¼šRaft èƒ½å¤Ÿæ¥å—ï¼Œå¤åˆ¶å¹¶åº”ç”¨æ–°çš„æ—¥å¿—æ¡ç›®åªè¦å¤§éƒ¨åˆ†çš„æœºå™¨æ˜¯å·¥ä½œçš„ï¼›åœ¨é€šå¸¸çš„æƒ…å†µä¸‹ï¼Œæ–°çš„æ—¥å¿—æ¡ç›®å¯ä»¥åœ¨ä¸€æ¬¡ RPC ä¸­è¢«å¤åˆ¶ç»™é›†ç¾¤ä¸­çš„å¤§å¤šæ•°æœºå™¨ï¼›å¹¶ä¸”å•ä¸ªçš„ç¼“æ…¢çš„è·Ÿéšè€…ä¸ä¼šå½±å“æ•´ä½“çš„æ€§èƒ½ã€‚\n\n### 5.4 å®‰å…¨æ€§\n\nå‰é¢çš„ç« èŠ‚é‡Œæè¿°äº† Raft ç®—æ³•æ˜¯å¦‚ä½•é€‰ä¸¾å’Œå¤åˆ¶æ—¥å¿—çš„ã€‚ç„¶è€Œï¼Œåˆ°ç›®å‰ä¸ºæ­¢æè¿°çš„æœºåˆ¶å¹¶ä¸èƒ½å……åˆ†çš„ä¿è¯æ¯ä¸€ä¸ªçŠ¶æ€æœºä¼šæŒ‰ç…§ç›¸åŒçš„é¡ºåºæ‰§è¡Œç›¸åŒçš„æŒ‡ä»¤ã€‚ä¾‹å¦‚ï¼Œä¸€ä¸ªè·Ÿéšè€…å¯èƒ½ä¼šè¿›å…¥ä¸å¯ç”¨çŠ¶æ€åŒæ—¶é¢†å¯¼äººå·²ç»æäº¤äº†è‹¥å¹²çš„æ—¥å¿—æ¡ç›®ï¼Œç„¶åè¿™ä¸ªè·Ÿéšè€…å¯èƒ½ä¼šè¢«é€‰ä¸¾ä¸ºé¢†å¯¼äººå¹¶ä¸”è¦†ç›–è¿™äº›æ—¥å¿—æ¡ç›®ï¼›å› æ­¤ï¼Œä¸åŒçš„çŠ¶æ€æœºå¯èƒ½ä¼šæ‰§è¡Œä¸åŒçš„æŒ‡ä»¤åºåˆ—ã€‚\n\nè¿™ä¸€èŠ‚é€šè¿‡åœ¨é¢†å¯¼é€‰ä¸¾çš„æ—¶å€™å¢åŠ ä¸€äº›é™åˆ¶æ¥å®Œå–„ Raft ç®—æ³•ã€‚è¿™ä¸€é™åˆ¶ä¿è¯äº†ä»»ä½•çš„é¢†å¯¼äººå¯¹äºç»™å®šçš„ä»»æœŸå·ï¼Œéƒ½æ‹¥æœ‰äº†ä¹‹å‰ä»»æœŸçš„æ‰€æœ‰è¢«æäº¤çš„æ—¥å¿—æ¡ç›®ï¼ˆå›¾ 3 ä¸­çš„é¢†å¯¼äººå®Œæ•´ç‰¹æ€§ï¼‰ã€‚å¢åŠ è¿™ä¸€é€‰ä¸¾æ—¶çš„é™åˆ¶ï¼Œæˆ‘ä»¬å¯¹äºæäº¤æ—¶çš„è§„åˆ™ä¹Ÿæ›´åŠ æ¸…æ™°ã€‚æœ€ç»ˆï¼Œæˆ‘ä»¬å°†å±•ç¤ºå¯¹äº**é¢†å¯¼äººå®Œæ•´ç‰¹æ€§ï¼ˆLeader Completeness Propertyï¼‰** çš„ç®€è¦è¯æ˜ï¼Œå¹¶ä¸”è¯´æ˜è¯¥ç‰¹æ€§æ˜¯å¦‚ä½•å¼•å¯¼å¤åˆ¶çŠ¶æ€æœºåšå‡ºæ­£ç¡®è¡Œä¸ºçš„ã€‚\n\n#### 5.4.1 é€‰ä¸¾é™åˆ¶\n\nåœ¨ä»»ä½•åŸºäºé¢†å¯¼äººçš„ä¸€è‡´æ€§ç®—æ³•ä¸­ï¼Œé¢†å¯¼äººéƒ½å¿…é¡»å­˜å‚¨æ‰€æœ‰å·²ç»æäº¤çš„æ—¥å¿—æ¡ç›®ã€‚åœ¨æŸäº›ä¸€è‡´æ€§ç®—æ³•ä¸­ï¼Œä¾‹å¦‚ Viewstamped Replicationï¼ŒæŸä¸ªèŠ‚ç‚¹å³ä½¿æ˜¯ä¸€å¼€å§‹å¹¶æ²¡æœ‰åŒ…å«æ‰€æœ‰å·²ç»æäº¤çš„æ—¥å¿—æ¡ç›®ï¼Œå®ƒä¹Ÿèƒ½è¢«é€‰ä¸ºé¢†å¯¼äººã€‚è¿™äº›ç®—æ³•éƒ½åŒ…å«ä¸€äº›é¢å¤–çš„æœºåˆ¶æ¥è¯†åˆ«ä¸¢å¤±çš„æ—¥å¿—æ¡ç›®å¹¶æŠŠä»–ä»¬ä¼ é€ç»™æ–°çš„é¢†å¯¼äººï¼Œè¦ä¹ˆæ˜¯åœ¨é€‰ä¸¾é˜¶æ®µè¦ä¹ˆåœ¨ä¹‹åå¾ˆå¿«è¿›è¡Œã€‚ä¸å¹¸çš„æ˜¯ï¼Œè¿™ç§æ–¹æ³•ä¼šå¯¼è‡´ç›¸å½“å¤§çš„é¢å¤–çš„æœºåˆ¶å’Œå¤æ‚æ€§ã€‚Raft ä½¿ç”¨äº†ä¸€ç§æ›´åŠ ç®€å•çš„æ–¹æ³•ï¼Œå®ƒå¯ä»¥ä¿è¯åœ¨é€‰ä¸¾çš„æ—¶å€™æ–°çš„é¢†å¯¼äººæ‹¥æœ‰æ‰€æœ‰ä¹‹å‰ä»»æœŸä¸­å·²ç»æäº¤çš„æ—¥å¿—æ¡ç›®ï¼Œè€Œä¸éœ€è¦ä¼ é€è¿™äº›æ—¥å¿—æ¡ç›®ç»™é¢†å¯¼äººã€‚è¿™æ„å‘³ç€æ—¥å¿—æ¡ç›®çš„ä¼ é€æ˜¯å•å‘çš„ï¼Œåªä»é¢†å¯¼äººä¼ ç»™è·Ÿéšè€…ï¼Œå¹¶ä¸”é¢†å¯¼äººä»ä¸ä¼šè¦†ç›–è‡ªèº«æœ¬åœ°æ—¥å¿—ä¸­å·²ç»å­˜åœ¨çš„æ¡ç›®ã€‚\n\nRaft ä½¿ç”¨æŠ•ç¥¨çš„æ–¹å¼æ¥é˜»æ­¢ä¸€ä¸ªå€™é€‰äººèµ¢å¾—é€‰ä¸¾ï¼Œé™¤éè¿™ä¸ªå€™é€‰äººåŒ…å«äº†æ‰€æœ‰å·²ç»æäº¤çš„æ—¥å¿—æ¡ç›®ã€‚å€™é€‰äººä¸ºäº†èµ¢å¾—é€‰ä¸¾å¿…é¡»è”ç³»é›†ç¾¤ä¸­çš„å¤§éƒ¨åˆ†èŠ‚ç‚¹ï¼Œè¿™æ„å‘³ç€æ¯ä¸€ä¸ªå·²ç»æäº¤çš„æ—¥å¿—æ¡ç›®åœ¨è¿™äº›æœåŠ¡å™¨èŠ‚ç‚¹ä¸­è‚¯å®šå­˜åœ¨äºè‡³å°‘ä¸€ä¸ªèŠ‚ç‚¹ä¸Šã€‚å¦‚æœå€™é€‰äººçš„æ—¥å¿—è‡³å°‘å’Œå¤§å¤šæ•°çš„æœåŠ¡å™¨èŠ‚ç‚¹ä¸€æ ·æ–°ï¼ˆè¿™ä¸ªæ–°çš„å®šä¹‰ä¼šåœ¨ä¸‹é¢è®¨è®ºï¼‰ï¼Œé‚£ä¹ˆä»–ä¸€å®šæŒæœ‰äº†æ‰€æœ‰å·²ç»æäº¤çš„æ—¥å¿—æ¡ç›®ã€‚è¯·æ±‚æŠ•ç¥¨ï¼ˆRequestVoteï¼‰ RPC å®ç°äº†è¿™æ ·çš„é™åˆ¶ï¼šRPC ä¸­åŒ…å«äº†å€™é€‰äººçš„æ—¥å¿—ä¿¡æ¯ï¼Œç„¶åæŠ•ç¥¨äººä¼šæ‹’ç»æ‰é‚£äº›æ—¥å¿—æ²¡æœ‰è‡ªå·±æ–°çš„æŠ•ç¥¨è¯·æ±‚ã€‚\n\nRaft é€šè¿‡æ¯”è¾ƒä¸¤ä»½æ—¥å¿—ä¸­æœ€åä¸€æ¡æ—¥å¿—æ¡ç›®çš„ç´¢å¼•å€¼å’Œä»»æœŸå·å®šä¹‰è°çš„æ—¥å¿—æ¯”è¾ƒæ–°ã€‚å¦‚æœä¸¤ä»½æ—¥å¿—æœ€åçš„æ¡ç›®çš„ä»»æœŸå·ä¸åŒï¼Œé‚£ä¹ˆä»»æœŸå·å¤§çš„æ—¥å¿—æ›´åŠ æ–°ã€‚å¦‚æœä¸¤ä»½æ—¥å¿—æœ€åçš„æ¡ç›®ä»»æœŸå·ç›¸åŒï¼Œé‚£ä¹ˆæ—¥å¿—æ¯”è¾ƒé•¿çš„é‚£ä¸ªå°±æ›´åŠ æ–°ã€‚\n\n#### 5.4.2 æäº¤ä¹‹å‰ä»»æœŸå†…çš„æ—¥å¿—æ¡ç›®\n\nå¦‚åŒ 5.3 èŠ‚ä»‹ç»çš„é‚£æ ·ï¼Œé¢†å¯¼äººçŸ¥é“ä¸€æ¡å½“å‰ä»»æœŸå†…çš„æ—¥å¿—è®°å½•æ˜¯å¯ä»¥è¢«æäº¤çš„ï¼Œåªè¦å®ƒè¢«å­˜å‚¨åˆ°äº†å¤§å¤šæ•°çš„æœåŠ¡å™¨ä¸Šã€‚å¦‚æœä¸€ä¸ªé¢†å¯¼äººåœ¨æäº¤æ—¥å¿—æ¡ç›®ä¹‹å‰å´©æºƒäº†ï¼Œæœªæ¥åç»­çš„é¢†å¯¼äººä¼šç»§ç»­å°è¯•å¤åˆ¶è¿™æ¡æ—¥å¿—è®°å½•ã€‚ç„¶è€Œï¼Œä¸€ä¸ªé¢†å¯¼äººä¸èƒ½æ–­å®šä¸€ä¸ªä¹‹å‰ä»»æœŸé‡Œçš„æ—¥å¿—æ¡ç›®è¢«ä¿å­˜åˆ°å¤§å¤šæ•°æœåŠ¡å™¨ä¸Šçš„æ—¶å€™å°±ä¸€å®šå·²ç»æäº¤äº†ã€‚å›¾ 8 å±•ç¤ºäº†ä¸€ç§æƒ…å†µï¼Œä¸€æ¡å·²ç»è¢«å­˜å‚¨åˆ°å¤§å¤šæ•°èŠ‚ç‚¹ä¸Šçš„è€æ—¥å¿—æ¡ç›®ï¼Œä¹Ÿä¾ç„¶æœ‰å¯èƒ½ä¼šè¢«æœªæ¥çš„é¢†å¯¼äººè¦†ç›–æ‰ã€‚\n\n![å›¾ 8](/img/2023-06-25-raft-zh_cn/raft-å›¾8.png)\n\n> å›¾ 8ï¼šå¦‚å›¾çš„æ—¶é—´åºåˆ—å±•ç¤ºäº†ä¸ºä»€ä¹ˆé¢†å¯¼äººæ— æ³•å†³å®šå¯¹è€ä»»æœŸå·çš„æ—¥å¿—æ¡ç›®è¿›è¡Œæäº¤ã€‚åœ¨ (a) ä¸­ï¼ŒS1 æ˜¯é¢†å¯¼äººï¼Œéƒ¨åˆ†çš„(è·Ÿéšè€…)å¤åˆ¶äº†ç´¢å¼•ä½ç½® 2 çš„æ—¥å¿—æ¡ç›®ã€‚åœ¨ (b) ä¸­ï¼ŒS1 å´©æºƒäº†ï¼Œç„¶å S5 åœ¨ä»»æœŸ 3 é‡Œé€šè¿‡ S3ã€S4 å’Œè‡ªå·±çš„é€‰ç¥¨èµ¢å¾—é€‰ä¸¾ï¼Œç„¶åä»å®¢æˆ·ç«¯æ¥æ”¶äº†ä¸€æ¡ä¸ä¸€æ ·çš„æ—¥å¿—æ¡ç›®æ”¾åœ¨äº†ç´¢å¼• 2 å¤„ã€‚ç„¶ååˆ° (c)ï¼ŒS5 åˆå´©æºƒäº†ï¼›S1 é‡æ–°å¯åŠ¨ï¼Œé€‰ä¸¾æˆåŠŸï¼Œå¼€å§‹å¤åˆ¶æ—¥å¿—ã€‚åœ¨è¿™æ—¶ï¼Œæ¥è‡ªä»»æœŸ 2 çš„é‚£æ¡æ—¥å¿—å·²ç»è¢«å¤åˆ¶åˆ°äº†é›†ç¾¤ä¸­çš„å¤§å¤šæ•°æœºå™¨ä¸Šï¼Œä½†æ˜¯è¿˜æ²¡æœ‰è¢«æäº¤ã€‚å¦‚æœ S1 åœ¨ (d) ä¸­åˆå´©æºƒäº†ï¼ŒS5 å¯ä»¥é‡æ–°è¢«é€‰ä¸¾æˆåŠŸï¼ˆé€šè¿‡æ¥è‡ª S2ï¼ŒS3 å’Œ S4 çš„é€‰ç¥¨ï¼‰ï¼Œç„¶åè¦†ç›–äº†ä»–ä»¬åœ¨ç´¢å¼• 2 å¤„çš„æ—¥å¿—ã€‚åä¹‹ï¼Œå¦‚æœåœ¨å´©æºƒä¹‹å‰ï¼ŒS1 æŠŠè‡ªå·±ä¸»å¯¼çš„æ–°ä»»æœŸé‡Œäº§ç”Ÿçš„æ—¥å¿—æ¡ç›®å¤åˆ¶åˆ°äº†å¤§å¤šæ•°æœºå™¨ä¸Šï¼Œå°±å¦‚ (e) ä¸­é‚£æ ·ï¼Œé‚£ä¹ˆåœ¨åé¢ä»»æœŸé‡Œé¢è¿™äº›æ–°çš„æ—¥å¿—æ¡ç›®å°±ä¼šè¢«æäº¤ï¼ˆå› ä¸º S5 å°±ä¸å¯èƒ½é€‰ä¸¾æˆåŠŸï¼‰ã€‚ è¿™æ ·åœ¨åŒä¸€æ—¶åˆ»å°±åŒæ—¶ä¿è¯äº†ï¼Œä¹‹å‰çš„æ‰€æœ‰è€çš„æ—¥å¿—æ¡ç›®å°±ä¼šè¢«æäº¤ã€‚\n\nä¸ºäº†æ¶ˆé™¤å›¾ 8 é‡Œæè¿°çš„æƒ…å†µï¼ŒRaft æ°¸è¿œä¸ä¼šé€šè¿‡è®¡ç®—å‰¯æœ¬æ•°ç›®çš„æ–¹å¼å»æäº¤ä¸€ä¸ªä¹‹å‰ä»»æœŸå†…çš„æ—¥å¿—æ¡ç›®ã€‚åªæœ‰é¢†å¯¼äººå½“å‰ä»»æœŸé‡Œçš„æ—¥å¿—æ¡ç›®é€šè¿‡è®¡ç®—å‰¯æœ¬æ•°ç›®å¯ä»¥è¢«æäº¤ï¼›ä¸€æ—¦å½“å‰ä»»æœŸçš„æ—¥å¿—æ¡ç›®ä»¥è¿™ç§æ–¹å¼è¢«æäº¤ï¼Œé‚£ä¹ˆç”±äºæ—¥å¿—åŒ¹é…ç‰¹æ€§ï¼Œä¹‹å‰çš„æ—¥å¿—æ¡ç›®ä¹Ÿéƒ½ä¼šè¢«é—´æ¥çš„æäº¤ã€‚åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œé¢†å¯¼äººå¯ä»¥å®‰å…¨çš„çŸ¥é“ä¸€ä¸ªè€çš„æ—¥å¿—æ¡ç›®æ˜¯å¦å·²ç»è¢«æäº¤ï¼ˆä¾‹å¦‚ï¼Œè¯¥æ¡ç›®æ˜¯å¦å­˜å‚¨åˆ°æ‰€æœ‰æœåŠ¡å™¨ä¸Šï¼‰ï¼Œä½†æ˜¯ Raft ä¸ºäº†ç®€åŒ–é—®é¢˜ä½¿ç”¨ä¸€ç§æ›´åŠ ä¿å®ˆçš„æ–¹æ³•ã€‚\n\nå½“é¢†å¯¼äººå¤åˆ¶ä¹‹å‰ä»»æœŸé‡Œçš„æ—¥å¿—æ—¶ï¼ŒRaft ä¼šä¸ºæ‰€æœ‰æ—¥å¿—ä¿ç•™åŸå§‹çš„ä»»æœŸå·, è¿™åœ¨æäº¤è§„åˆ™ä¸Šäº§ç”Ÿäº†é¢å¤–çš„å¤æ‚æ€§ã€‚åœ¨å…¶ä»–çš„ä¸€è‡´æ€§ç®—æ³•ä¸­ï¼Œå¦‚æœä¸€ä¸ªæ–°çš„é¢†å¯¼äººè¦é‡æ–°å¤åˆ¶ä¹‹å‰çš„ä»»æœŸé‡Œçš„æ—¥å¿—æ—¶ï¼Œå®ƒå¿…é¡»ä½¿ç”¨å½“å‰æ–°çš„ä»»æœŸå·ã€‚Raft ä½¿ç”¨çš„æ–¹æ³•æ›´åŠ å®¹æ˜“è¾¨åˆ«å‡ºæ—¥å¿—ï¼Œå› ä¸ºå®ƒå¯ä»¥éšç€æ—¶é—´å’Œæ—¥å¿—çš„å˜åŒ–å¯¹æ—¥å¿—ç»´æŠ¤ç€åŒä¸€ä¸ªä»»æœŸç¼–å·ã€‚å¦å¤–ï¼Œå’Œå…¶ä»–çš„ç®—æ³•ç›¸æ¯”ï¼ŒRaft ä¸­çš„æ–°é¢†å¯¼äººåªéœ€è¦å‘é€æ›´å°‘æ—¥å¿—æ¡ç›®ï¼ˆå…¶ä»–ç®—æ³•ä¸­å¿…é¡»åœ¨ä»–ä»¬è¢«æäº¤ä¹‹å‰å‘é€æ›´å¤šçš„å†—ä½™æ—¥å¿—æ¡ç›®æ¥ä¸ºä»–ä»¬é‡æ–°ç¼–å·ï¼‰ã€‚\n\n#### 5.4.3 å®‰å…¨æ€§è®ºè¯\n\nåœ¨ç»™å®šäº†å®Œæ•´çš„ Raft ç®—æ³•ä¹‹åï¼Œæˆ‘ä»¬ç°åœ¨å¯ä»¥æ›´åŠ ç²¾ç¡®çš„è®¨è®ºé¢†å¯¼äººå®Œæ•´æ€§ç‰¹æ€§ï¼ˆè¿™ä¸€è®¨è®ºåŸºäº 9.2 èŠ‚çš„å®‰å…¨æ€§è¯æ˜ï¼‰ã€‚æˆ‘ä»¬å‡è®¾é¢†å¯¼äººå®Œå…¨æ€§ç‰¹æ€§æ˜¯ä¸å­˜åœ¨çš„ï¼Œç„¶åæˆ‘ä»¬æ¨å‡ºçŸ›ç›¾æ¥ã€‚å‡è®¾ä»»æœŸ T çš„é¢†å¯¼äººï¼ˆé¢†å¯¼äºº Tï¼‰åœ¨ä»»æœŸå†…æäº¤äº†ä¸€æ¡æ—¥å¿—æ¡ç›®ï¼Œä½†æ˜¯è¿™æ¡æ—¥å¿—æ¡ç›®æ²¡æœ‰è¢«å­˜å‚¨åˆ°æœªæ¥æŸä¸ªä»»æœŸçš„é¢†å¯¼äººçš„æ—¥å¿—ä¸­ã€‚è®¾å¤§äº T çš„æœ€å°ä»»æœŸ U çš„é¢†å¯¼äºº U æ²¡æœ‰è¿™æ¡æ—¥å¿—æ¡ç›®ã€‚\n\n![å›¾ 9](/img/2023-06-25-raft-zh_cn/raft-å›¾9.png)\n\n> å›¾ 9ï¼šå¦‚æœ S1 ï¼ˆä»»æœŸ T çš„é¢†å¯¼äººï¼‰åœ¨å®ƒçš„ä»»æœŸé‡Œæäº¤äº†ä¸€æ¡æ–°çš„æ—¥å¿—ï¼Œç„¶å S5 åœ¨ä¹‹åçš„ä»»æœŸ U é‡Œè¢«é€‰ä¸¾ä¸ºé¢†å¯¼äººï¼Œé‚£ä¹ˆè‡³å°‘ä¼šæœ‰ä¸€ä¸ªæœºå™¨ï¼Œå¦‚ S3ï¼Œæ—¢æ‹¥æœ‰æ¥è‡ª S1 çš„æ—¥å¿—ï¼Œä¹Ÿç»™ S5 æŠ•ç¥¨äº†ã€‚\n\n1. åœ¨é¢†å¯¼äºº U é€‰ä¸¾çš„æ—¶å€™ä¸€å®šæ²¡æœ‰é‚£æ¡è¢«æäº¤çš„æ—¥å¿—æ¡ç›®ï¼ˆé¢†å¯¼äººä»ä¸ä¼šåˆ é™¤æˆ–è€…è¦†ç›–ä»»ä½•æ¡ç›®ï¼‰ã€‚\n2. é¢†å¯¼äºº T å¤åˆ¶è¿™æ¡æ—¥å¿—æ¡ç›®ç»™é›†ç¾¤ä¸­çš„å¤§å¤šæ•°èŠ‚ç‚¹ï¼ŒåŒæ—¶ï¼Œé¢†å¯¼äºº U ä»é›†ç¾¤ä¸­çš„å¤§å¤šæ•°èŠ‚ç‚¹èµ¢å¾—äº†é€‰ç¥¨ã€‚å› æ­¤ï¼Œè‡³å°‘æœ‰ä¸€ä¸ªèŠ‚ç‚¹ï¼ˆæŠ•ç¥¨è€…ã€é€‰æ°‘ï¼‰åŒæ—¶æ¥å—äº†æ¥è‡ªé¢†å¯¼äºº T çš„æ—¥å¿—æ¡ç›®ï¼Œå¹¶ä¸”ç»™é¢†å¯¼äºº U æŠ•ç¥¨äº†ï¼Œå¦‚å›¾ 9ã€‚è¿™ä¸ªæŠ•ç¥¨è€…æ˜¯äº§ç”Ÿè¿™ä¸ªçŸ›ç›¾çš„å…³é”®ã€‚\n3. è¿™ä¸ªæŠ•ç¥¨è€…å¿…é¡»åœ¨ç»™é¢†å¯¼äºº U æŠ•ç¥¨ä¹‹å‰å…ˆæ¥å—äº†ä»é¢†å¯¼äºº T å‘æ¥çš„å·²ç»è¢«æäº¤çš„æ—¥å¿—æ¡ç›®ï¼›å¦åˆ™ä»–å°±ä¼šæ‹’ç»æ¥è‡ªé¢†å¯¼äºº T çš„é™„åŠ æ—¥å¿—è¯·æ±‚ï¼ˆå› ä¸ºæ­¤æ—¶ä»–çš„ä»»æœŸå·ä¼šæ¯” T å¤§ï¼‰ã€‚\n4. æŠ•ç¥¨è€…åœ¨ç»™é¢†å¯¼äºº U æŠ•ç¥¨æ—¶ä¾ç„¶ä¿å­˜æœ‰è¿™æ¡æ—¥å¿—æ¡ç›®ï¼Œå› ä¸ºä»»ä½•ä¸­é—´çš„é¢†å¯¼äººéƒ½åŒ…å«è¯¥æ—¥å¿—æ¡ç›®ï¼ˆæ ¹æ®ä¸Šè¿°çš„å‡è®¾ï¼‰ï¼Œé¢†å¯¼äººä»ä¸ä¼šåˆ é™¤æ¡ç›®ï¼Œå¹¶ä¸”è·Ÿéšè€…åªæœ‰åœ¨å’Œé¢†å¯¼äººå†²çªçš„æ—¶å€™æ‰ä¼šåˆ é™¤æ¡ç›®ã€‚\n5. æŠ•ç¥¨è€…æŠŠè‡ªå·±é€‰ç¥¨æŠ•ç»™é¢†å¯¼äºº U æ—¶ï¼Œé¢†å¯¼äºº U çš„æ—¥å¿—å¿…é¡»å’ŒæŠ•ç¥¨è€…è‡ªå·±ä¸€æ ·æ–°ã€‚è¿™å°±å¯¼è‡´äº†ä¸¤è€…çŸ›ç›¾ä¹‹ä¸€ã€‚\n6. é¦–å…ˆï¼Œå¦‚æœæŠ•ç¥¨è€…å’Œé¢†å¯¼äºº U çš„æœ€åä¸€æ¡æ—¥å¿—çš„ä»»æœŸå·ç›¸åŒï¼Œé‚£ä¹ˆé¢†å¯¼äºº U çš„æ—¥å¿—è‡³å°‘å’ŒæŠ•ç¥¨è€…ä¸€æ ·é•¿ï¼Œæ‰€ä»¥é¢†å¯¼äºº U çš„æ—¥å¿—ä¸€å®šåŒ…å«æ‰€æœ‰æŠ•ç¥¨è€…çš„æ—¥å¿—ã€‚è¿™æ˜¯å¦ä¸€å¤„çŸ›ç›¾ï¼Œå› ä¸ºæŠ•ç¥¨è€…åŒ…å«äº†é‚£æ¡å·²ç»è¢«æäº¤çš„æ—¥å¿—æ¡ç›®ï¼Œä½†æ˜¯åœ¨ä¸Šè¿°çš„å‡è®¾é‡Œï¼Œé¢†å¯¼äºº U æ˜¯ä¸åŒ…å«çš„ã€‚\n7. é™¤æ­¤ä¹‹å¤–ï¼Œé¢†å¯¼äºº U çš„æœ€åä¸€æ¡æ—¥å¿—çš„ä»»æœŸå·å°±å¿…é¡»æ¯”æŠ•ç¥¨äººå¤§äº†ã€‚æ­¤å¤–ï¼Œä»–ä¹Ÿæ¯” T å¤§ï¼Œå› ä¸ºæŠ•ç¥¨äººçš„æœ€åä¸€æ¡æ—¥å¿—çš„ä»»æœŸå·è‡³å°‘å’Œ T ä¸€æ ·å¤§ï¼ˆä»–åŒ…å«äº†æ¥è‡ªä»»æœŸ T çš„å·²æäº¤çš„æ—¥å¿—ï¼‰ã€‚åˆ›å»ºäº†é¢†å¯¼äºº U æœ€åä¸€æ¡æ—¥å¿—çš„ä¹‹å‰é¢†å¯¼äººä¸€å®šå·²ç»åŒ…å«äº†é‚£æ¡è¢«æäº¤çš„æ—¥å¿—ï¼ˆæ ¹æ®ä¸Šè¿°å‡è®¾ï¼Œé¢†å¯¼äºº U æ˜¯ç¬¬ä¸€ä¸ªä¸åŒ…å«è¯¥æ—¥å¿—æ¡ç›®çš„é¢†å¯¼äººï¼‰ã€‚æ‰€ä»¥ï¼Œæ ¹æ®æ—¥å¿—åŒ¹é…ç‰¹æ€§ï¼Œé¢†å¯¼äºº U ä¸€å®šä¹ŸåŒ…å«é‚£æ¡è¢«æäº¤çš„æ—¥å¿—ï¼Œè¿™é‡Œäº§ç”ŸçŸ›ç›¾ã€‚\n8. è¿™é‡Œå®Œæˆäº†çŸ›ç›¾ã€‚å› æ­¤ï¼Œæ‰€æœ‰æ¯” T å¤§çš„é¢†å¯¼äººä¸€å®šåŒ…å«äº†æ‰€æœ‰æ¥è‡ª T çš„å·²ç»è¢«æäº¤çš„æ—¥å¿—ã€‚\n9. æ—¥å¿—åŒ¹é…åŸåˆ™ä¿è¯äº†æœªæ¥çš„é¢†å¯¼äººä¹ŸåŒæ—¶ä¼šåŒ…å«è¢«é—´æ¥æäº¤çš„æ¡ç›®ï¼Œä¾‹å¦‚å›¾ 8 (e) ä¸­çš„ç´¢å¼• 2ã€‚\n\né€šè¿‡é¢†å¯¼äººå®Œå…¨ç‰¹æ€§ï¼Œæˆ‘ä»¬å°±èƒ½è¯æ˜å›¾ 3 ä¸­çš„çŠ¶æ€æœºå®‰å…¨ç‰¹æ€§ï¼Œå³å¦‚æœæœåŠ¡å™¨å·²ç»åœ¨æŸä¸ªç»™å®šçš„ç´¢å¼•å€¼åº”ç”¨äº†æ—¥å¿—æ¡ç›®åˆ°è‡ªå·±çš„çŠ¶æ€æœºé‡Œï¼Œé‚£ä¹ˆå…¶ä»–çš„æœåŠ¡å™¨ä¸ä¼šåº”ç”¨ä¸€ä¸ªä¸ä¸€æ ·çš„æ—¥å¿—åˆ°åŒä¸€ä¸ªç´¢å¼•å€¼ä¸Šã€‚åœ¨ä¸€ä¸ªæœåŠ¡å™¨åº”ç”¨ä¸€æ¡æ—¥å¿—æ¡ç›®åˆ°ä»–è‡ªå·±çš„çŠ¶æ€æœºä¸­æ—¶ï¼Œä»–çš„æ—¥å¿—å¿…é¡»å’Œé¢†å¯¼äººçš„æ—¥å¿—ï¼Œåœ¨è¯¥æ¡ç›®å’Œä¹‹å‰çš„æ¡ç›®ä¸Šç›¸åŒï¼Œå¹¶ä¸”å·²ç»è¢«æäº¤ã€‚ç°åœ¨æˆ‘ä»¬æ¥è€ƒè™‘åœ¨ä»»ä½•ä¸€ä¸ªæœåŠ¡å™¨åº”ç”¨ä¸€ä¸ªæŒ‡å®šç´¢å¼•ä½ç½®çš„æ—¥å¿—çš„æœ€å°ä»»æœŸï¼›æ—¥å¿—å®Œå…¨ç‰¹æ€§ä¿è¯æ‹¥æœ‰æ›´é«˜ä»»æœŸå·çš„é¢†å¯¼äººä¼šå­˜å‚¨ç›¸åŒçš„æ—¥å¿—æ¡ç›®ï¼Œæ‰€ä»¥ä¹‹åçš„ä»»æœŸé‡Œåº”ç”¨æŸä¸ªç´¢å¼•ä½ç½®çš„æ—¥å¿—æ¡ç›®ä¹Ÿä¼šæ˜¯ç›¸åŒçš„å€¼ã€‚å› æ­¤ï¼ŒçŠ¶æ€æœºå®‰å…¨ç‰¹æ€§æ˜¯æˆç«‹çš„ã€‚\n\næœ€åï¼ŒRaft è¦æ±‚æœåŠ¡å™¨æŒ‰ç…§æ—¥å¿—ä¸­ç´¢å¼•ä½ç½®é¡ºåºåº”ç”¨æ—¥å¿—æ¡ç›®ã€‚å’ŒçŠ¶æ€æœºå®‰å…¨ç‰¹æ€§ç»“åˆèµ·æ¥çœ‹ï¼Œè¿™å°±æ„å‘³ç€æ‰€æœ‰çš„æœåŠ¡å™¨ä¼šåº”ç”¨ç›¸åŒçš„æ—¥å¿—åºåˆ—é›†åˆ°è‡ªå·±çš„çŠ¶æ€æœºä¸­ï¼Œå¹¶ä¸”æ˜¯æŒ‰ç…§ç›¸åŒçš„é¡ºåºã€‚\n\n### 5.5 è·Ÿéšè€…å’Œå€™é€‰äººå´©æºƒ\n\nåˆ°ç›®å‰ä¸ºæ­¢ï¼Œæˆ‘ä»¬éƒ½åªå…³æ³¨äº†é¢†å¯¼äººå´©æºƒçš„æƒ…å†µã€‚è·Ÿéšè€…å’Œå€™é€‰äººå´©æºƒåçš„å¤„ç†æ–¹å¼æ¯”é¢†å¯¼äººè¦ç®€å•çš„å¤šï¼Œå¹¶ä¸”ä»–ä»¬çš„å¤„ç†æ–¹å¼æ˜¯ç›¸åŒçš„ã€‚å¦‚æœè·Ÿéšè€…æˆ–è€…å€™é€‰äººå´©æºƒäº†ï¼Œé‚£ä¹ˆåç»­å‘é€ç»™ä»–ä»¬çš„ RPCs éƒ½ä¼šå¤±è´¥ã€‚Raft ä¸­å¤„ç†è¿™ç§å¤±è´¥å°±æ˜¯ç®€å•åœ°é€šè¿‡æ— é™çš„é‡è¯•ï¼›å¦‚æœå´©æºƒçš„æœºå™¨é‡å¯äº†ï¼Œé‚£ä¹ˆè¿™äº› RPC å°±ä¼šå®Œæ•´çš„æˆåŠŸã€‚å¦‚æœä¸€ä¸ªæœåŠ¡å™¨åœ¨å®Œæˆäº†ä¸€ä¸ª RPCï¼Œä½†æ˜¯è¿˜æ²¡æœ‰å“åº”çš„æ—¶å€™å´©æºƒäº†ï¼Œé‚£ä¹ˆåœ¨ä»–é‡æ–°å¯åŠ¨ä¹‹åå°±ä¼šå†æ¬¡æ”¶åˆ°åŒæ ·çš„è¯·æ±‚ã€‚Raft çš„ RPCs éƒ½æ˜¯å¹‚ç­‰çš„ï¼Œæ‰€ä»¥è¿™æ ·é‡è¯•ä¸ä¼šé€ æˆä»»ä½•é—®é¢˜ã€‚ä¾‹å¦‚ä¸€ä¸ªè·Ÿéšè€…å¦‚æœæ”¶åˆ°é™„åŠ æ—¥å¿—è¯·æ±‚ä½†æ˜¯ä»–å·²ç»åŒ…å«äº†è¿™ä¸€æ—¥å¿—ï¼Œé‚£ä¹ˆä»–å°±ä¼šç›´æ¥å¿½ç•¥è¿™ä¸ªæ–°çš„è¯·æ±‚ã€‚\n\n### 5.6 æ—¶é—´å’Œå¯ç”¨æ€§\n\nRaft çš„è¦æ±‚ä¹‹ä¸€å°±æ˜¯å®‰å…¨æ€§ä¸èƒ½ä¾èµ–æ—¶é—´ï¼šæ•´ä¸ªç³»ç»Ÿä¸èƒ½å› ä¸ºæŸäº›äº‹ä»¶è¿è¡Œçš„æ¯”é¢„æœŸå¿«ä¸€ç‚¹æˆ–è€…æ…¢ä¸€ç‚¹å°±äº§ç”Ÿäº†é”™è¯¯çš„ç»“æœã€‚ä½†æ˜¯ï¼Œå¯ç”¨æ€§ï¼ˆç³»ç»Ÿå¯ä»¥åŠæ—¶çš„å“åº”å®¢æˆ·ç«¯ï¼‰ä¸å¯é¿å…çš„è¦ä¾èµ–äºæ—¶é—´ã€‚ä¾‹å¦‚ï¼Œå¦‚æœæ¶ˆæ¯äº¤æ¢æ¯”æœåŠ¡å™¨æ•…éšœé—´éš”æ—¶é—´é•¿ï¼Œå€™é€‰äººå°†æ²¡æœ‰è¶³å¤Ÿé•¿çš„æ—¶é—´æ¥èµ¢å¾—é€‰ä¸¾ï¼›æ²¡æœ‰ä¸€ä¸ªç¨³å®šçš„é¢†å¯¼äººï¼ŒRaft å°†æ— æ³•å·¥ä½œã€‚\n\né¢†å¯¼äººé€‰ä¸¾æ˜¯ Raft ä¸­å¯¹æ—¶é—´è¦æ±‚æœ€ä¸ºå…³é”®çš„æ–¹é¢ã€‚Raft å¯ä»¥é€‰ä¸¾å¹¶ç»´æŒä¸€ä¸ªç¨³å®šçš„é¢†å¯¼äºº,åªè¦ç³»ç»Ÿæ»¡è¶³ä¸‹é¢çš„æ—¶é—´è¦æ±‚ï¼š\n\n> å¹¿æ’­æ—¶é—´ï¼ˆbroadcastTimeï¼‰  <<  é€‰ä¸¾è¶…æ—¶æ—¶é—´ï¼ˆelectionTimeoutï¼‰ <<  å¹³å‡æ•…éšœé—´éš”æ—¶é—´ï¼ˆMTBFï¼‰\n\nåœ¨è¿™ä¸ªä¸ç­‰å¼ä¸­ï¼Œå¹¿æ’­æ—¶é—´æŒ‡çš„æ˜¯ä»ä¸€ä¸ªæœåŠ¡å™¨å¹¶è¡Œçš„å‘é€ RPCs ç»™é›†ç¾¤ä¸­çš„å…¶ä»–æœåŠ¡å™¨å¹¶æ¥æ”¶å“åº”çš„å¹³å‡æ—¶é—´ï¼›é€‰ä¸¾è¶…æ—¶æ—¶é—´å°±æ˜¯åœ¨ 5.2 èŠ‚ä¸­ä»‹ç»çš„é€‰ä¸¾çš„è¶…æ—¶æ—¶é—´é™åˆ¶ï¼›ç„¶åå¹³å‡æ•…éšœé—´éš”æ—¶é—´å°±æ˜¯å¯¹äºä¸€å°æœåŠ¡å™¨è€Œè¨€ï¼Œä¸¤æ¬¡æ•…éšœä¹‹é—´çš„å¹³å‡æ—¶é—´ã€‚å¹¿æ’­æ—¶é—´å¿…é¡»æ¯”é€‰ä¸¾è¶…æ—¶æ—¶é—´å°ä¸€ä¸ªé‡çº§ï¼Œè¿™æ ·é¢†å¯¼äººæ‰èƒ½å¤Ÿå‘é€ç¨³å®šçš„å¿ƒè·³æ¶ˆæ¯æ¥é˜»æ­¢è·Ÿéšè€…å¼€å§‹è¿›å…¥é€‰ä¸¾çŠ¶æ€ï¼›é€šè¿‡éšæœºåŒ–é€‰ä¸¾è¶…æ—¶æ—¶é—´çš„æ–¹æ³•ï¼Œè¿™ä¸ªä¸ç­‰å¼ä¹Ÿä½¿å¾—é€‰ç¥¨ç“œåˆ†çš„æƒ…å†µå˜å¾—ä¸å¯èƒ½ã€‚é€‰ä¸¾è¶…æ—¶æ—¶é—´åº”è¯¥è¦æ¯”å¹³å‡æ•…éšœé—´éš”æ—¶é—´å°ä¸Šå‡ ä¸ªæ•°é‡çº§ï¼Œè¿™æ ·æ•´ä¸ªç³»ç»Ÿæ‰èƒ½ç¨³å®šçš„è¿è¡Œã€‚å½“é¢†å¯¼äººå´©æºƒåï¼Œæ•´ä¸ªç³»ç»Ÿä¼šå¤§çº¦ç›¸å½“äºé€‰ä¸¾è¶…æ—¶çš„æ—¶é—´é‡Œä¸å¯ç”¨ï¼›æˆ‘ä»¬å¸Œæœ›è¿™ç§æƒ…å†µåœ¨æ•´ä¸ªç³»ç»Ÿçš„è¿è¡Œä¸­å¾ˆå°‘å‡ºç°ã€‚\n\nå¹¿æ’­æ—¶é—´å’Œå¹³å‡æ•…éšœé—´éš”æ—¶é—´æ˜¯ç”±ç³»ç»Ÿå†³å®šçš„ï¼Œä½†æ˜¯é€‰ä¸¾è¶…æ—¶æ—¶é—´æ˜¯æˆ‘ä»¬è‡ªå·±é€‰æ‹©çš„ã€‚Raft çš„ RPCs éœ€è¦æ¥æ”¶æ–¹å°†ä¿¡æ¯æŒä¹…åŒ–çš„ä¿å­˜åˆ°ç¨³å®šå­˜å‚¨ä¸­å»ï¼Œæ‰€ä»¥å¹¿æ’­æ—¶é—´å¤§çº¦æ˜¯ 0.5 æ¯«ç§’åˆ° 20 æ¯«ç§’ï¼Œå–å†³äºå­˜å‚¨çš„æŠ€æœ¯ã€‚å› æ­¤ï¼Œé€‰ä¸¾è¶…æ—¶æ—¶é—´å¯èƒ½éœ€è¦åœ¨ 10 æ¯«ç§’åˆ° 500 æ¯«ç§’ä¹‹é—´ã€‚å¤§å¤šæ•°çš„æœåŠ¡å™¨çš„å¹³å‡æ•…éšœé—´éš”æ—¶é—´éƒ½åœ¨å‡ ä¸ªæœˆç”šè‡³æ›´é•¿ï¼Œå¾ˆå®¹æ˜“æ»¡è¶³æ—¶é—´çš„éœ€æ±‚ã€‚\n\n## 6 é›†ç¾¤æˆå‘˜å˜åŒ–\n\nåˆ°ç›®å‰ä¸ºæ­¢ï¼Œæˆ‘ä»¬éƒ½å‡è®¾é›†ç¾¤çš„é…ç½®ï¼ˆåŠ å…¥åˆ°ä¸€è‡´æ€§ç®—æ³•çš„æœåŠ¡å™¨é›†åˆï¼‰æ˜¯å›ºå®šä¸å˜çš„ã€‚ä½†æ˜¯åœ¨å®è·µä¸­ï¼Œå¶å°”æ˜¯ä¼šæ”¹å˜é›†ç¾¤çš„é…ç½®çš„ï¼Œä¾‹å¦‚æ›¿æ¢é‚£äº›å®•æœºçš„æœºå™¨æˆ–è€…æ”¹å˜å¤åˆ¶çº§åˆ«ã€‚å°½ç®¡å¯ä»¥é€šè¿‡æš‚åœæ•´ä¸ªé›†ç¾¤ï¼Œæ›´æ–°æ‰€æœ‰é…ç½®ï¼Œç„¶åé‡å¯æ•´ä¸ªé›†ç¾¤çš„æ–¹å¼æ¥å®ç°ï¼Œä½†æ˜¯åœ¨æ›´æ”¹çš„æ—¶å€™é›†ç¾¤ä¼šä¸å¯ç”¨ã€‚å¦å¤–ï¼Œå¦‚æœå­˜åœ¨æ‰‹å·¥æ“ä½œæ­¥éª¤ï¼Œé‚£ä¹ˆå°±ä¼šæœ‰æ“ä½œå¤±è¯¯çš„é£é™©ã€‚ä¸ºäº†é¿å…è¿™æ ·çš„é—®é¢˜ï¼Œæˆ‘ä»¬å†³å®šè‡ªåŠ¨åŒ–é…ç½®æ”¹å˜å¹¶ä¸”å°†å…¶çº³å…¥åˆ° Raft ä¸€è‡´æ€§ç®—æ³•ä¸­æ¥ã€‚\n\nä¸ºäº†è®©é…ç½®ä¿®æ”¹æœºåˆ¶èƒ½å¤Ÿå®‰å…¨ï¼Œé‚£ä¹ˆåœ¨è½¬æ¢çš„è¿‡ç¨‹ä¸­ä¸èƒ½å¤Ÿå­˜åœ¨ä»»ä½•æ—¶é—´ç‚¹ä½¿å¾—ä¸¤ä¸ªé¢†å¯¼äººåœ¨åŒä¸€ä¸ªä»»æœŸé‡ŒåŒæ—¶è¢«é€‰ä¸¾æˆåŠŸã€‚ä¸å¹¸çš„æ˜¯ï¼Œä»»ä½•æœåŠ¡å™¨ç›´æ¥ä»æ—§çš„é…ç½®ç›´æ¥è½¬æ¢åˆ°æ–°çš„é…ç½®çš„æ–¹æ¡ˆéƒ½æ˜¯ä¸å®‰å…¨çš„ã€‚ä¸€æ¬¡æ€§åŸå­åœ°è½¬æ¢æ‰€æœ‰æœåŠ¡å™¨æ˜¯ä¸å¯èƒ½çš„ï¼Œæ‰€ä»¥åœ¨è½¬æ¢æœŸé—´æ•´ä¸ªé›†ç¾¤å­˜åœ¨åˆ’åˆ†æˆä¸¤ä¸ªç‹¬ç«‹çš„å¤§å¤šæ•°ç¾¤ä½“çš„å¯èƒ½æ€§ï¼ˆè§å›¾ 10ï¼‰ã€‚\n\n![å›¾ 10](/img/2023-06-25-raft-zh_cn/raft-å›¾10.png)\n\n> å›¾ 10ï¼šç›´æ¥ä»ä¸€ç§é…ç½®è½¬åˆ°æ–°çš„é…ç½®æ˜¯ååˆ†ä¸å®‰å…¨çš„ï¼Œå› ä¸ºå„ä¸ªæœºå™¨å¯èƒ½åœ¨ä»»ä½•çš„æ—¶å€™è¿›è¡Œè½¬æ¢ã€‚åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œé›†ç¾¤é…é¢ä» 3 å°æœºå™¨å˜æˆäº† 5 å°ã€‚ä¸å¹¸çš„æ˜¯ï¼Œå­˜åœ¨è¿™æ ·çš„ä¸€ä¸ªæ—¶é—´ç‚¹ï¼Œä¸¤ä¸ªä¸åŒçš„é¢†å¯¼äººåœ¨åŒä¸€ä¸ªä»»æœŸé‡Œéƒ½å¯ä»¥è¢«é€‰ä¸¾æˆåŠŸã€‚ä¸€ä¸ªæ˜¯é€šè¿‡æ—§çš„é…ç½®ï¼Œä¸€ä¸ªé€šè¿‡æ–°çš„é…ç½®ã€‚\n\nä¸ºäº†ä¿è¯å®‰å…¨æ€§ï¼Œé…ç½®æ›´æ”¹å¿…é¡»ä½¿ç”¨ä¸¤é˜¶æ®µæ–¹æ³•ã€‚ç›®å‰æœ‰å¾ˆå¤šç§ä¸¤é˜¶æ®µçš„å®ç°ã€‚ä¾‹å¦‚ï¼Œæœ‰äº›ç³»ç»Ÿåœ¨ç¬¬ä¸€é˜¶æ®µåœæ‰æ—§çš„é…ç½®æ‰€ä»¥é›†ç¾¤å°±ä¸èƒ½å¤„ç†å®¢æˆ·ç«¯è¯·æ±‚ï¼›ç„¶ååœ¨ç¬¬äºŒé˜¶æ®µåœ¨å¯ç”¨æ–°çš„é…ç½®ã€‚åœ¨ Raft ä¸­ï¼Œé›†ç¾¤å…ˆåˆ‡æ¢åˆ°ä¸€ä¸ªè¿‡æ¸¡çš„é…ç½®ï¼Œæˆ‘ä»¬ç§°ä¹‹ä¸ºå…±åŒä¸€è‡´ï¼ˆ*joint consensus*)ï¼›ä¸€æ—¦å…±åŒä¸€è‡´å·²ç»è¢«æäº¤äº†ï¼Œé‚£ä¹ˆç³»ç»Ÿå°±åˆ‡æ¢åˆ°æ–°çš„é…ç½®ä¸Šã€‚å…±åŒä¸€è‡´æ˜¯è€é…ç½®å’Œæ–°é…ç½®çš„ç»“åˆï¼š\n\n* æ—¥å¿—æ¡ç›®è¢«å¤åˆ¶ç»™é›†ç¾¤ä¸­æ–°ã€è€é…ç½®çš„æ‰€æœ‰æœåŠ¡å™¨ã€‚\n* æ–°ã€æ—§é…ç½®çš„æœåŠ¡å™¨éƒ½å¯ä»¥æˆä¸ºé¢†å¯¼äººã€‚\n* è¾¾æˆä¸€è‡´ï¼ˆé’ˆå¯¹é€‰ä¸¾å’Œæäº¤ï¼‰éœ€è¦åˆ†åˆ«åœ¨ä¸¤ç§é…ç½®ä¸Šè·å¾—å¤§å¤šæ•°çš„æ”¯æŒã€‚\n\nå…±åŒä¸€è‡´å…è®¸ç‹¬ç«‹çš„æœåŠ¡å™¨åœ¨ä¸å½±å“å®‰å…¨æ€§çš„å‰æä¸‹ï¼Œåœ¨ä¸åŒçš„æ—¶é—´è¿›è¡Œé…ç½®è½¬æ¢è¿‡ç¨‹ã€‚æ­¤å¤–ï¼Œå…±åŒä¸€è‡´å¯ä»¥è®©é›†ç¾¤åœ¨é…ç½®è½¬æ¢çš„è¿‡ç¨‹ä¸­ä¾ç„¶å“åº”å®¢æˆ·ç«¯çš„è¯·æ±‚ã€‚\n\né›†ç¾¤é…ç½®åœ¨å¤åˆ¶æ—¥å¿—ä¸­ä»¥ç‰¹æ®Šçš„æ—¥å¿—æ¡ç›®æ¥å­˜å‚¨å’Œé€šä¿¡ï¼›å›¾ 11 å±•ç¤ºäº†é…ç½®è½¬æ¢çš„è¿‡ç¨‹ã€‚å½“ä¸€ä¸ªé¢†å¯¼äººæ¥æ”¶åˆ°ä¸€ä¸ªæ”¹å˜é…ç½®ä» C-old åˆ° C-new çš„è¯·æ±‚ï¼Œä»–ä¼šä¸ºäº†å…±åŒä¸€è‡´å­˜å‚¨é…ç½®ï¼ˆå›¾ä¸­çš„ C-old,newï¼‰ï¼Œä»¥å‰é¢æè¿°çš„æ—¥å¿—æ¡ç›®å’Œå‰¯æœ¬çš„å½¢å¼ã€‚ä¸€æ—¦ä¸€ä¸ªæœåŠ¡å™¨å°†æ–°çš„é…ç½®æ—¥å¿—æ¡ç›®å¢åŠ åˆ°å®ƒçš„æ—¥å¿—ä¸­ï¼Œä»–å°±ä¼šç”¨è¿™ä¸ªé…ç½®æ¥åšå‡ºæœªæ¥æ‰€æœ‰çš„å†³å®šï¼ˆæœåŠ¡å™¨æ€»æ˜¯ä½¿ç”¨æœ€æ–°çš„é…ç½®ï¼Œæ— è®ºä»–æ˜¯å¦å·²ç»è¢«æäº¤ï¼‰ã€‚è¿™æ„å‘³ç€é¢†å¯¼äººè¦ä½¿ç”¨  C-old,new çš„è§„åˆ™æ¥å†³å®šæ—¥å¿—æ¡ç›® C-old,new ä»€ä¹ˆæ—¶å€™éœ€è¦è¢«æäº¤ã€‚å¦‚æœé¢†å¯¼äººå´©æºƒäº†ï¼Œè¢«é€‰å‡ºæ¥çš„æ–°é¢†å¯¼äººå¯èƒ½æ˜¯ä½¿ç”¨ C-old é…ç½®ä¹Ÿå¯èƒ½æ˜¯ C-old,new é…ç½®ï¼Œè¿™å–å†³äºèµ¢å¾—é€‰ä¸¾çš„å€™é€‰äººæ˜¯å¦å·²ç»æ¥æ”¶åˆ°äº† C-old,new é…ç½®ã€‚åœ¨ä»»ä½•æƒ…å†µä¸‹ï¼Œ C-new é…ç½®åœ¨è¿™ä¸€æ—¶æœŸéƒ½ä¸ä¼šå•æ–¹é¢çš„åšå‡ºå†³å®šã€‚\n\nä¸€æ—¦ C-old,new è¢«æäº¤ï¼Œé‚£ä¹ˆæ— è®ºæ˜¯ C-old è¿˜æ˜¯ C-newï¼Œå¦‚æœä¸ç»è¿‡å¦ä¸€ä¸ªé…ç½®çš„å…è®¸éƒ½ä¸èƒ½å•ç‹¬åšå‡ºå†³å®šï¼Œå¹¶ä¸”é¢†å¯¼äººå®Œå…¨ç‰¹æ€§ä¿è¯äº†åªæœ‰æ‹¥æœ‰ C-old,new æ—¥å¿—æ¡ç›®çš„æœåŠ¡å™¨æ‰æœ‰å¯èƒ½è¢«é€‰ä¸¾ä¸ºé¢†å¯¼äººã€‚è¿™ä¸ªæ—¶å€™ï¼Œé¢†å¯¼äººåˆ›å»ºä¸€æ¡å…³äº C-new é…ç½®çš„æ—¥å¿—æ¡ç›®å¹¶å¤åˆ¶ç»™é›†ç¾¤å°±æ˜¯å®‰å…¨çš„äº†ã€‚å†è€…ï¼Œæ¯ä¸ªæœåŠ¡å™¨åœ¨è§åˆ°æ–°çš„é…ç½®çš„æ—¶å€™å°±ä¼šç«‹å³ç”Ÿæ•ˆã€‚å½“æ–°çš„é…ç½®åœ¨ C-new çš„è§„åˆ™ä¸‹è¢«æäº¤ï¼Œæ—§çš„é…ç½®å°±å˜å¾—æ— å…³ç´§è¦ï¼ŒåŒæ—¶ä¸ä½¿ç”¨æ–°çš„é…ç½®çš„æœåŠ¡å™¨å°±å¯ä»¥è¢«å…³é—­äº†ã€‚å¦‚å›¾ 11ï¼ŒC-old å’Œ C-new æ²¡æœ‰ä»»ä½•æœºä¼šåŒæ—¶åšå‡ºå•æ–¹é¢çš„å†³å®šï¼›è¿™ä¿è¯äº†å®‰å…¨æ€§ã€‚\n\n![å›¾ 11](/img/2023-06-25-raft-zh_cn/raft-å›¾11.png)\n\n> å›¾ 11ï¼šä¸€ä¸ªé…ç½®åˆ‡æ¢çš„æ—¶é—´çº¿ã€‚è™šçº¿è¡¨ç¤ºå·²ç»è¢«åˆ›å»ºä½†æ˜¯è¿˜æ²¡æœ‰è¢«æäº¤çš„é…ç½®æ—¥å¿—æ¡ç›®ï¼Œå®çº¿è¡¨ç¤ºæœ€åè¢«æäº¤çš„é…ç½®æ—¥å¿—æ¡ç›®ã€‚é¢†å¯¼äººé¦–å…ˆåˆ›å»ºäº† C-old,new çš„é…ç½®æ¡ç›®åœ¨è‡ªå·±çš„æ—¥å¿—ä¸­ï¼Œå¹¶æäº¤åˆ° C-old,new ä¸­ï¼ˆC-old çš„å¤§å¤šæ•°å’Œ  C-new çš„å¤§å¤šæ•°ï¼‰ã€‚ç„¶åä»–åˆ›å»º C-new æ¡ç›®å¹¶æäº¤åˆ° C-new ä¸­çš„å¤§å¤šæ•°ã€‚è¿™æ ·å°±ä¸å­˜åœ¨  C-new å’Œ C-old å¯ä»¥åŒæ—¶åšå‡ºå†³å®šçš„æ—¶é—´ç‚¹ã€‚\n\nåœ¨å…³äºé‡æ–°é…ç½®è¿˜æœ‰ä¸‰ä¸ªé—®é¢˜éœ€è¦æå‡ºã€‚ç¬¬ä¸€ä¸ªé—®é¢˜æ˜¯ï¼Œæ–°çš„æœåŠ¡å™¨å¯èƒ½åˆå§‹åŒ–æ²¡æœ‰å­˜å‚¨ä»»ä½•çš„æ—¥å¿—æ¡ç›®ã€‚å½“è¿™äº›æœåŠ¡å™¨ä»¥è¿™ç§çŠ¶æ€åŠ å…¥åˆ°é›†ç¾¤ä¸­ï¼Œé‚£ä¹ˆä»–ä»¬éœ€è¦ä¸€æ®µæ—¶é—´æ¥æ›´æ–°è¿½èµ¶ï¼Œè¿™æ—¶è¿˜ä¸èƒ½æäº¤æ–°çš„æ—¥å¿—æ¡ç›®ã€‚ä¸ºäº†é¿å…è¿™ç§å¯ç”¨æ€§çš„é—´éš”æ—¶é—´ï¼ŒRaft åœ¨é…ç½®æ›´æ–°ä¹‹å‰ä½¿ç”¨äº†ä¸€ç§é¢å¤–çš„é˜¶æ®µï¼Œåœ¨è¿™ä¸ªé˜¶æ®µï¼Œæ–°çš„æœåŠ¡å™¨ä»¥æ²¡æœ‰æŠ•ç¥¨æƒèº«ä»½åŠ å…¥åˆ°é›†ç¾¤ä¸­æ¥ï¼ˆé¢†å¯¼äººå¤åˆ¶æ—¥å¿—ç»™ä»–ä»¬ï¼Œä½†æ˜¯ä¸è€ƒè™‘ä»–ä»¬æ˜¯å¤§å¤šæ•°ï¼‰ã€‚ä¸€æ—¦æ–°çš„æœåŠ¡å™¨è¿½èµ¶ä¸Šäº†é›†ç¾¤ä¸­çš„å…¶ä»–æœºå™¨ï¼Œé‡æ–°é…ç½®å¯ä»¥åƒä¸Šé¢æè¿°çš„ä¸€æ ·å¤„ç†ã€‚\n\nç¬¬äºŒä¸ªé—®é¢˜æ˜¯ï¼Œé›†ç¾¤çš„é¢†å¯¼äººå¯èƒ½ä¸æ˜¯æ–°é…ç½®çš„ä¸€å‘˜ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œé¢†å¯¼äººå°±ä¼šåœ¨æäº¤äº† C-new æ—¥å¿—ä¹‹åé€€ä½ï¼ˆå›åˆ°è·Ÿéšè€…çŠ¶æ€ï¼‰ã€‚è¿™æ„å‘³ç€æœ‰è¿™æ ·çš„ä¸€æ®µæ—¶é—´ï¼Œé¢†å¯¼äººç®¡ç†ç€é›†ç¾¤ï¼Œä½†æ˜¯ä¸åŒ…æ‹¬ä»–è‡ªå·±ï¼›ä»–å¤åˆ¶æ—¥å¿—ä½†æ˜¯ä¸æŠŠä»–è‡ªå·±ç®—ä½œæ˜¯å¤§å¤šæ•°ä¹‹ä¸€ã€‚å½“ C-new è¢«æäº¤æ—¶ï¼Œä¼šå‘ç”Ÿé¢†å¯¼äººè¿‡æ¸¡ï¼Œå› ä¸ºè¿™æ—¶æ˜¯æœ€æ—©æ–°çš„é…ç½®å¯ä»¥ç‹¬ç«‹å·¥ä½œçš„æ—¶é—´ç‚¹ï¼ˆå°†æ€»æ˜¯èƒ½å¤Ÿåœ¨ C-new é…ç½®ä¸‹é€‰å‡ºæ–°çš„é¢†å¯¼äººï¼‰ã€‚åœ¨æ­¤ä¹‹å‰ï¼Œå¯èƒ½åªèƒ½ä» C-old ä¸­é€‰å‡ºé¢†å¯¼äººã€‚\n\nç¬¬ä¸‰ä¸ªé—®é¢˜æ˜¯ï¼Œç§»é™¤ä¸åœ¨ C-new ä¸­çš„æœåŠ¡å™¨å¯èƒ½ä¼šæ‰°ä¹±é›†ç¾¤ã€‚è¿™äº›æœåŠ¡å™¨å°†ä¸ä¼šå†æ¥æ”¶åˆ°å¿ƒè·³ï¼Œæ‰€ä»¥å½“é€‰ä¸¾è¶…æ—¶ï¼Œä»–ä»¬å°±ä¼šè¿›è¡Œæ–°çš„é€‰ä¸¾è¿‡ç¨‹ã€‚ä»–ä»¬ä¼šå‘é€æ‹¥æœ‰æ–°çš„ä»»æœŸå·çš„è¯·æ±‚æŠ•ç¥¨ RPCsï¼Œè¿™æ ·ä¼šå¯¼è‡´å½“å‰çš„é¢†å¯¼äººå›é€€æˆè·Ÿéšè€…çŠ¶æ€ã€‚æ–°çš„é¢†å¯¼äººæœ€ç»ˆä¼šè¢«é€‰å‡ºæ¥ï¼Œä½†æ˜¯è¢«ç§»é™¤çš„æœåŠ¡å™¨å°†ä¼šå†æ¬¡è¶…æ—¶ï¼Œç„¶åè¿™ä¸ªè¿‡ç¨‹ä¼šå†æ¬¡é‡å¤ï¼Œå¯¼è‡´æ•´ä½“å¯ç”¨æ€§å¤§å¹…é™ä½ã€‚\n\nä¸ºäº†é¿å…è¿™ä¸ªé—®é¢˜ï¼Œå½“æœåŠ¡å™¨ç¡®è®¤å½“å‰é¢†å¯¼äººå­˜åœ¨æ—¶ï¼ŒæœåŠ¡å™¨ä¼šå¿½ç•¥è¯·æ±‚æŠ•ç¥¨ RPCsã€‚ç¡®åˆ‡åœ°è¯´ï¼Œå½“æœåŠ¡å™¨åœ¨å½“å‰æœ€å°é€‰ä¸¾è¶…æ—¶æ—¶é—´å†…æ”¶åˆ°ä¸€ä¸ªè¯·æ±‚æŠ•ç¥¨ RPCï¼Œä»–ä¸ä¼šæ›´æ–°å½“å‰çš„ä»»æœŸå·æˆ–è€…æŠ•å‡ºé€‰ç¥¨ã€‚è¿™ä¸ä¼šå½±å“æ­£å¸¸çš„é€‰ä¸¾ï¼Œæ¯ä¸ªæœåŠ¡å™¨åœ¨å¼€å§‹ä¸€æ¬¡é€‰ä¸¾ä¹‹å‰ï¼Œè‡³å°‘ç­‰å¾…ä¸€ä¸ªæœ€å°é€‰ä¸¾è¶…æ—¶æ—¶é—´ã€‚ç„¶è€Œï¼Œè¿™æœ‰åˆ©äºé¿å…è¢«ç§»é™¤çš„æœåŠ¡å™¨æ‰°ä¹±ï¼šå¦‚æœé¢†å¯¼äººèƒ½å¤Ÿå‘é€å¿ƒè·³ç»™é›†ç¾¤ï¼Œé‚£ä¹ˆä»–å°±ä¸ä¼šè¢«æ›´å¤§çš„ä»»æœŸå·åºŸé»œã€‚\n\n## 7 æ—¥å¿—å‹ç¼©\n\nRaft çš„æ—¥å¿—åœ¨æ­£å¸¸æ“ä½œä¸­ä¸æ–­åœ°å¢é•¿ï¼Œä½†æ˜¯åœ¨å®é™…çš„ç³»ç»Ÿä¸­ï¼Œæ—¥å¿—ä¸èƒ½æ— é™åˆ¶åœ°å¢é•¿ã€‚éšç€æ—¥å¿—ä¸æ–­å¢é•¿ï¼Œä»–ä¼šå ç”¨è¶Šæ¥è¶Šå¤šçš„ç©ºé—´ï¼ŒèŠ±è´¹è¶Šæ¥è¶Šå¤šçš„æ—¶é—´æ¥é‡ç½®ã€‚å¦‚æœæ²¡æœ‰ä¸€å®šçš„æœºåˆ¶å»æ¸…é™¤æ—¥å¿—é‡Œç§¯ç´¯çš„é™ˆæ—§çš„ä¿¡æ¯ï¼Œé‚£ä¹ˆä¼šå¸¦æ¥å¯ç”¨æ€§é—®é¢˜ã€‚\n\nå¿«ç…§æ˜¯æœ€ç®€å•çš„å‹ç¼©æ–¹æ³•ã€‚åœ¨å¿«ç…§ç³»ç»Ÿä¸­ï¼Œæ•´ä¸ªç³»ç»Ÿçš„çŠ¶æ€éƒ½ä»¥å¿«ç…§çš„å½¢å¼å†™å…¥åˆ°ç¨³å®šçš„æŒä¹…åŒ–å­˜å‚¨ä¸­ï¼Œç„¶ååˆ°é‚£ä¸ªæ—¶é—´ç‚¹ä¹‹å‰çš„æ—¥å¿—å…¨éƒ¨ä¸¢å¼ƒã€‚å¿«ç…§æŠ€æœ¯è¢«ä½¿ç”¨åœ¨ Chubby å’Œ ZooKeeper ä¸­ï¼Œæ¥ä¸‹æ¥çš„ç« èŠ‚ä¼šä»‹ç» Raft ä¸­çš„å¿«ç…§æŠ€æœ¯ã€‚\n\nå¢é‡å‹ç¼©çš„æ–¹æ³•ï¼Œä¾‹å¦‚æ—¥å¿—æ¸…ç†æˆ–è€…æ—¥å¿—ç»“æ„åˆå¹¶æ ‘ï¼Œéƒ½æ˜¯å¯è¡Œçš„ã€‚è¿™äº›æ–¹æ³•æ¯æ¬¡åªå¯¹ä¸€å°éƒ¨åˆ†æ•°æ®è¿›è¡Œæ“ä½œï¼Œè¿™æ ·å°±åˆ†æ•£äº†å‹ç¼©çš„è´Ÿè½½å‹åŠ›ã€‚é¦–å…ˆï¼Œä»–ä»¬å…ˆé€‰æ‹©ä¸€ä¸ªå·²ç»ç§¯ç´¯çš„å¤§é‡å·²ç»è¢«åˆ é™¤æˆ–è€…è¢«è¦†ç›–å¯¹è±¡çš„åŒºåŸŸï¼Œç„¶åé‡å†™é‚£ä¸ªåŒºåŸŸè¿˜æ´»è·ƒçš„å¯¹è±¡ï¼Œä¹‹åé‡Šæ”¾é‚£ä¸ªåŒºåŸŸã€‚å’Œç®€å•æ“ä½œæ•´ä¸ªæ•°æ®é›†åˆçš„å¿«ç…§ç›¸æ¯”ï¼Œéœ€è¦å¢åŠ å¤æ‚çš„æœºåˆ¶æ¥å®ç°ã€‚çŠ¶æ€æœºå¯ä»¥å®ç° LSM tree ä½¿ç”¨å’Œå¿«ç…§ç›¸åŒçš„æ¥å£ï¼Œä½†æ˜¯æ—¥å¿—æ¸…é™¤æ–¹æ³•å°±éœ€è¦ä¿®æ”¹ Raft äº†ã€‚\n\n![å›¾ 12](/img/2023-06-25-raft-zh_cn/raft-å›¾12.png)\n\n> å›¾ 12ï¼šä¸€ä¸ªæœåŠ¡å™¨ç”¨æ–°çš„å¿«ç…§æ›¿æ¢äº†ä» 1 åˆ° 5 çš„æ¡ç›®ï¼Œå¿«ç…§å€¼å­˜å‚¨äº†å½“å‰çš„çŠ¶æ€ã€‚å¿«ç…§ä¸­åŒ…å«äº†æœ€åçš„ç´¢å¼•ä½ç½®å’Œä»»æœŸå·ã€‚\n\nå›¾ 12 å±•ç¤ºäº† Raft ä¸­å¿«ç…§çš„åŸºç¡€æ€æƒ³ã€‚æ¯ä¸ªæœåŠ¡å™¨ç‹¬ç«‹åœ°åˆ›å»ºå¿«ç…§ï¼ŒåªåŒ…æ‹¬å·²ç»è¢«æäº¤çš„æ—¥å¿—ã€‚ä¸»è¦çš„å·¥ä½œåŒ…æ‹¬å°†çŠ¶æ€æœºçš„çŠ¶æ€å†™å…¥åˆ°å¿«ç…§ä¸­ã€‚Raft ä¹ŸåŒ…å«ä¸€äº›å°‘é‡çš„å…ƒæ•°æ®åˆ°å¿«ç…§ä¸­ï¼š**æœ€åè¢«åŒ…å«ç´¢å¼•**æŒ‡çš„æ˜¯è¢«å¿«ç…§å–ä»£çš„æœ€åçš„æ¡ç›®åœ¨æ—¥å¿—ä¸­çš„ç´¢å¼•å€¼ï¼ˆçŠ¶æ€æœºæœ€ååº”ç”¨çš„æ—¥å¿—ï¼‰ï¼Œ**æœ€åè¢«åŒ…å«çš„ä»»æœŸ**æŒ‡çš„æ˜¯è¯¥æ¡ç›®çš„ä»»æœŸå·ã€‚ä¿ç•™è¿™äº›æ•°æ®æ˜¯ä¸ºäº†æ”¯æŒå¿«ç…§åç´§æ¥ç€çš„ç¬¬ä¸€ä¸ªæ¡ç›®çš„é™„åŠ æ—¥å¿—è¯·æ±‚æ—¶çš„ä¸€è‡´æ€§æ£€æŸ¥ï¼Œå› ä¸ºè¿™ä¸ªæ¡ç›®éœ€è¦å‰ä¸€æ—¥å¿—æ¡ç›®çš„ç´¢å¼•å€¼å’Œä»»æœŸå·ã€‚ä¸ºäº†æ”¯æŒé›†ç¾¤æˆå‘˜æ›´æ–°ï¼ˆç¬¬ 6 èŠ‚ï¼‰ï¼Œå¿«ç…§ä¸­ä¹Ÿå°†æœ€åçš„ä¸€æ¬¡é…ç½®ä½œä¸ºæœ€åä¸€ä¸ªæ¡ç›®å­˜ä¸‹æ¥ã€‚ä¸€æ—¦æœåŠ¡å™¨å®Œæˆä¸€æ¬¡å¿«ç…§ï¼Œä»–å°±å¯ä»¥åˆ é™¤æœ€åç´¢å¼•ä½ç½®ä¹‹å‰çš„æ‰€æœ‰æ—¥å¿—å’Œå¿«ç…§äº†ã€‚\n\nå°½ç®¡é€šå¸¸æœåŠ¡å™¨éƒ½æ˜¯ç‹¬ç«‹åœ°åˆ›å»ºå¿«ç…§ï¼Œä½†æ˜¯é¢†å¯¼äººå¿…é¡»å¶å°”çš„å‘é€å¿«ç…§ç»™ä¸€äº›è½åçš„è·Ÿéšè€…ã€‚è¿™é€šå¸¸å‘ç”Ÿåœ¨å½“é¢†å¯¼äººå·²ç»ä¸¢å¼ƒäº†ä¸‹ä¸€æ¡éœ€è¦å‘é€ç»™è·Ÿéšè€…çš„æ—¥å¿—æ¡ç›®çš„æ—¶å€™ã€‚å¹¸è¿çš„æ˜¯è¿™ç§æƒ…å†µä¸æ˜¯å¸¸è§„æ“ä½œï¼šä¸€ä¸ªä¸é¢†å¯¼äººä¿æŒåŒæ­¥çš„è·Ÿéšè€…é€šå¸¸éƒ½ä¼šæœ‰è¿™ä¸ªæ¡ç›®ã€‚ç„¶è€Œä¸€ä¸ªè¿è¡Œéå¸¸ç¼“æ…¢çš„è·Ÿéšè€…æˆ–è€…æ–°åŠ å…¥é›†ç¾¤çš„æœåŠ¡å™¨ï¼ˆç¬¬ 6 èŠ‚ï¼‰å°†ä¸ä¼šæœ‰è¿™ä¸ªæ¡ç›®ã€‚è¿™æ—¶è®©è¿™ä¸ªè·Ÿéšè€…æ›´æ–°åˆ°æœ€æ–°çš„çŠ¶æ€çš„æ–¹å¼å°±æ˜¯é€šè¿‡ç½‘ç»œæŠŠå¿«ç…§å‘é€ç»™ä»–ä»¬ã€‚\n\n**å®‰è£…å¿«ç…§ RPC**ï¼š\n\nç”±é¢†å¯¼äººè°ƒç”¨ä»¥å°†å¿«ç…§çš„åˆ†å—å‘é€ç»™è·Ÿéšè€…ã€‚é¢†å¯¼äººæ€»æ˜¯æŒ‰é¡ºåºå‘é€åˆ†å—ã€‚\n\n| å‚æ•° | è§£é‡Š |\n|:----:|:----:|\n| term | é¢†å¯¼äººçš„ä»»æœŸå· |\n| leaderId | é¢†å¯¼äººçš„ IDï¼Œä»¥ä¾¿äºè·Ÿéšè€…é‡å®šå‘è¯·æ±‚ |\n| lastIncludedIndex | å¿«ç…§ä¸­åŒ…å«çš„æœ€åæ—¥å¿—æ¡ç›®çš„ç´¢å¼•å€¼ |\n| lastIncludedTerm | å¿«ç…§ä¸­åŒ…å«çš„æœ€åæ—¥å¿—æ¡ç›®çš„ä»»æœŸå· |\n| offset | åˆ†å—åœ¨å¿«ç…§ä¸­çš„å­—èŠ‚åç§»é‡ |\n| data[] | ä»åç§»é‡å¼€å§‹çš„å¿«ç…§åˆ†å—çš„åŸå§‹å­—èŠ‚ |\n| done | å¦‚æœè¿™æ˜¯æœ€åä¸€ä¸ªåˆ†å—åˆ™ä¸º true |\n\n| ç»“æœ | è§£é‡Š |\n|:----:|:----:|\n| term | å½“å‰ä»»æœŸå·ï¼ˆcurrentTermï¼‰ï¼Œä¾¿äºé¢†å¯¼äººæ›´æ–°è‡ªå·± |\n\n**æ¥æ”¶è€…å®ç°**ï¼š\n\n1. å¦‚æœ`term < currentTerm`å°±ç«‹å³å›å¤\n2. å¦‚æœæ˜¯ç¬¬ä¸€ä¸ªåˆ†å—ï¼ˆoffset ä¸º 0ï¼‰å°±åˆ›å»ºä¸€ä¸ªæ–°çš„å¿«ç…§\n3. åœ¨æŒ‡å®šåç§»é‡å†™å…¥æ•°æ®\n4. å¦‚æœ done æ˜¯ falseï¼Œåˆ™ç»§ç»­ç­‰å¾…æ›´å¤šçš„æ•°æ®\n5. ä¿å­˜å¿«ç…§æ–‡ä»¶ï¼Œä¸¢å¼ƒå…·æœ‰è¾ƒå°ç´¢å¼•çš„ä»»ä½•ç°æœ‰æˆ–éƒ¨åˆ†å¿«ç…§\n6. å¦‚æœç°å­˜çš„æ—¥å¿—æ¡ç›®ä¸å¿«ç…§ä¸­æœ€ååŒ…å«çš„æ—¥å¿—æ¡ç›®å…·æœ‰ç›¸åŒçš„ç´¢å¼•å€¼å’Œä»»æœŸå·ï¼Œåˆ™ä¿ç•™å…¶åçš„æ—¥å¿—æ¡ç›®å¹¶è¿›è¡Œå›å¤\n7. ä¸¢å¼ƒæ•´ä¸ªæ—¥å¿—\n8. ä½¿ç”¨å¿«ç…§é‡ç½®çŠ¶æ€æœºï¼ˆå¹¶åŠ è½½å¿«ç…§çš„é›†ç¾¤é…ç½®ï¼‰\n\n![å›¾ 13 ](/img/2023-06-25-raft-zh_cn/raft-å›¾13.png)\n\n> å›¾ 13ï¼šä¸€ä¸ªå…³äºå®‰è£…å¿«ç…§çš„ç®€è¦æ¦‚è¿°ã€‚ä¸ºäº†ä¾¿äºä¼ è¾“ï¼Œå¿«ç…§éƒ½æ˜¯è¢«åˆ†æˆåˆ†å—çš„ï¼›æ¯ä¸ªåˆ†å—éƒ½ç»™äº†è·Ÿéšè€…ç”Ÿå‘½çš„è¿¹è±¡ï¼Œæ‰€ä»¥è·Ÿéšè€…å¯ä»¥é‡ç½®é€‰ä¸¾è¶…æ—¶è®¡æ—¶å™¨ã€‚\n\nåœ¨è¿™ç§æƒ…å†µä¸‹é¢†å¯¼äººä½¿ç”¨ä¸€ç§å«åšå®‰è£…å¿«ç…§çš„æ–°çš„ RPC æ¥å‘é€å¿«ç…§ç»™å¤ªè½åçš„è·Ÿéšè€…ï¼›è§å›¾ 13ã€‚å½“è·Ÿéšè€…é€šè¿‡è¿™ç§  RPC æ¥æ”¶åˆ°å¿«ç…§æ—¶ï¼Œä»–å¿…é¡»è‡ªå·±å†³å®šå¯¹äºå·²ç»å­˜åœ¨çš„æ—¥å¿—è¯¥å¦‚ä½•å¤„ç†ã€‚é€šå¸¸å¿«ç…§ä¼šåŒ…å«æ²¡æœ‰åœ¨æ¥æ”¶è€…æ—¥å¿—ä¸­å­˜åœ¨çš„ä¿¡æ¯ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œè·Ÿéšè€…ä¸¢å¼ƒå…¶æ•´ä¸ªæ—¥å¿—ï¼›å®ƒå…¨éƒ¨è¢«å¿«ç…§å–ä»£ï¼Œå¹¶ä¸”å¯èƒ½åŒ…å«ä¸å¿«ç…§å†²çªçš„æœªæäº¤æ¡ç›®ã€‚å¦‚æœæ¥æ”¶åˆ°çš„å¿«ç…§æ˜¯è‡ªå·±æ—¥å¿—çš„å‰é¢éƒ¨åˆ†ï¼ˆç”±äºç½‘ç»œé‡ä¼ æˆ–è€…é”™è¯¯ï¼‰ï¼Œé‚£ä¹ˆè¢«å¿«ç…§åŒ…å«çš„æ¡ç›®å°†ä¼šè¢«å…¨éƒ¨åˆ é™¤ï¼Œä½†æ˜¯å¿«ç…§åé¢çš„æ¡ç›®ä»ç„¶æœ‰æ•ˆï¼Œå¿…é¡»ä¿ç•™ã€‚\n\nè¿™ç§å¿«ç…§çš„æ–¹å¼èƒŒç¦»äº† Raft çš„å¼ºé¢†å¯¼äººåŸåˆ™ï¼Œå› ä¸ºè·Ÿéšè€…å¯ä»¥åœ¨ä¸çŸ¥é“é¢†å¯¼äººæƒ…å†µä¸‹åˆ›å»ºå¿«ç…§ã€‚ä½†æ˜¯æˆ‘ä»¬è®¤ä¸ºè¿™ç§èƒŒç¦»æ˜¯å€¼å¾—çš„ã€‚é¢†å¯¼äººçš„å­˜åœ¨ï¼Œæ˜¯ä¸ºäº†è§£å†³åœ¨è¾¾æˆä¸€è‡´æ€§çš„æ—¶å€™çš„å†²çªï¼Œä½†æ˜¯åœ¨åˆ›å»ºå¿«ç…§çš„æ—¶å€™ï¼Œä¸€è‡´æ€§å·²ç»è¾¾æˆï¼Œè¿™æ—¶ä¸å­˜åœ¨å†²çªäº†ï¼Œæ‰€ä»¥æ²¡æœ‰é¢†å¯¼äººä¹Ÿæ˜¯å¯ä»¥çš„ã€‚æ•°æ®ä¾ç„¶æ˜¯ä»é¢†å¯¼äººä¼ ç»™è·Ÿéšè€…ï¼Œåªæ˜¯è·Ÿéšè€…å¯ä»¥é‡æ–°ç»„ç»‡ä»–ä»¬çš„æ•°æ®äº†ã€‚\n\næˆ‘ä»¬è€ƒè™‘è¿‡ä¸€ç§æ›¿ä»£çš„åŸºäºé¢†å¯¼äººçš„å¿«ç…§æ–¹æ¡ˆï¼Œå³åªæœ‰é¢†å¯¼äººåˆ›å»ºå¿«ç…§ï¼Œç„¶åå‘é€ç»™æ‰€æœ‰çš„è·Ÿéšè€…ã€‚ä½†æ˜¯è¿™æ ·åšæœ‰ä¸¤ä¸ªç¼ºç‚¹ã€‚ç¬¬ä¸€ï¼Œå‘é€å¿«ç…§ä¼šæµªè´¹ç½‘ç»œå¸¦å®½å¹¶ä¸”å»¶ç¼“äº†å¿«ç…§å¤„ç†çš„æ—¶é—´ã€‚æ¯ä¸ªè·Ÿéšè€…éƒ½å·²ç»æ‹¥æœ‰äº†æ‰€æœ‰äº§ç”Ÿå¿«ç…§éœ€è¦çš„ä¿¡æ¯ï¼Œè€Œä¸”å¾ˆæ˜¾ç„¶ï¼Œè‡ªå·±ä»æœ¬åœ°çš„çŠ¶æ€ä¸­åˆ›å»ºå¿«ç…§æ¯”é€šè¿‡ç½‘ç»œæ¥æ”¶åˆ«äººå‘æ¥çš„è¦ç»æµã€‚ç¬¬äºŒï¼Œé¢†å¯¼äººçš„å®ç°ä¼šæ›´åŠ å¤æ‚ã€‚ä¾‹å¦‚ï¼Œé¢†å¯¼äººéœ€è¦å‘é€å¿«ç…§çš„åŒæ—¶å¹¶è¡Œçš„å°†æ–°çš„æ—¥å¿—æ¡ç›®å‘é€ç»™è·Ÿéšè€…ï¼Œè¿™æ ·æ‰ä¸ä¼šé˜»å¡æ–°çš„å®¢æˆ·ç«¯è¯·æ±‚ã€‚\n\nè¿˜æœ‰ä¸¤ä¸ªé—®é¢˜å½±å“äº†å¿«ç…§çš„æ€§èƒ½ã€‚é¦–å…ˆï¼ŒæœåŠ¡å™¨å¿…é¡»å†³å®šä»€ä¹ˆæ—¶å€™åº”è¯¥åˆ›å»ºå¿«ç…§ã€‚å¦‚æœå¿«ç…§åˆ›å»ºçš„è¿‡äºé¢‘ç¹ï¼Œé‚£ä¹ˆå°±ä¼šæµªè´¹å¤§é‡çš„ç£ç›˜å¸¦å®½å’Œå…¶ä»–èµ„æºï¼›å¦‚æœåˆ›å»ºå¿«ç…§é¢‘ç‡å¤ªä½ï¼Œä»–å°±è¦æ‰¿å—è€—å°½å­˜å‚¨å®¹é‡çš„é£é™©ï¼ŒåŒæ—¶ä¹Ÿå¢åŠ äº†ä»æ—¥å¿—é‡å»ºçš„æ—¶é—´ã€‚ä¸€ä¸ªç®€å•çš„ç­–ç•¥å°±æ˜¯å½“æ—¥å¿—å¤§å°è¾¾åˆ°ä¸€ä¸ªå›ºå®šå¤§å°çš„æ—¶å€™å°±åˆ›å»ºä¸€æ¬¡å¿«ç…§ã€‚å¦‚æœè¿™ä¸ªé˜ˆå€¼è®¾ç½®çš„æ˜¾è‘—å¤§äºæœŸæœ›çš„å¿«ç…§çš„å¤§å°ï¼Œé‚£ä¹ˆå¿«ç…§å¯¹ç£ç›˜å‹åŠ›çš„å½±å“å°±ä¼šå¾ˆå°äº†ã€‚\n\nç¬¬äºŒä¸ªå½±å“æ€§èƒ½çš„é—®é¢˜å°±æ˜¯å†™å…¥å¿«ç…§éœ€è¦èŠ±è´¹æ˜¾è‘—çš„ä¸€æ®µæ—¶é—´ï¼Œå¹¶ä¸”æˆ‘ä»¬è¿˜ä¸å¸Œæœ›å½±å“åˆ°æ­£å¸¸æ“ä½œã€‚è§£å†³æ–¹æ¡ˆæ˜¯é€šè¿‡å†™æ—¶å¤åˆ¶çš„æŠ€æœ¯ï¼Œè¿™æ ·æ–°çš„æ›´æ–°å°±å¯ä»¥è¢«æ¥æ”¶è€Œä¸å½±å“åˆ°å¿«ç…§ã€‚ä¾‹å¦‚ï¼Œå…·æœ‰å‡½æ•°å¼æ•°æ®ç»“æ„çš„çŠ¶æ€æœºå¤©ç„¶æ”¯æŒè¿™æ ·çš„åŠŸèƒ½ã€‚å¦å¤–ï¼Œæ“ä½œç³»ç»Ÿçš„å†™æ—¶å¤åˆ¶æŠ€æœ¯çš„æ”¯æŒï¼ˆå¦‚ Linux ä¸Šçš„ forkï¼‰å¯ä»¥è¢«ç”¨æ¥åˆ›å»ºå®Œæ•´çš„çŠ¶æ€æœºçš„å†…å­˜å¿«ç…§ï¼ˆæˆ‘ä»¬çš„å®ç°å°±æ˜¯è¿™æ ·çš„ï¼‰ã€‚\n\n## 8 å®¢æˆ·ç«¯äº¤äº’\n\nè¿™ä¸€èŠ‚å°†ä»‹ç»å®¢æˆ·ç«¯æ˜¯å¦‚ä½•å’Œ Raft è¿›è¡Œäº¤äº’çš„ï¼ŒåŒ…æ‹¬å®¢æˆ·ç«¯å¦‚ä½•å‘ç°é¢†å¯¼äººå’Œ Raft æ˜¯å¦‚ä½•æ”¯æŒçº¿æ€§åŒ–è¯­ä¹‰çš„ã€‚è¿™äº›é—®é¢˜å¯¹äºæ‰€æœ‰åŸºäºä¸€è‡´æ€§çš„ç³»ç»Ÿéƒ½å­˜åœ¨ï¼Œå¹¶ä¸” Raft çš„è§£å†³æ–¹æ¡ˆå’Œå…¶ä»–çš„ä¹Ÿå·®ä¸å¤šã€‚\n\nRaft ä¸­çš„å®¢æˆ·ç«¯å‘é€æ‰€æœ‰è¯·æ±‚ç»™é¢†å¯¼äººã€‚å½“å®¢æˆ·ç«¯å¯åŠ¨çš„æ—¶å€™ï¼Œä»–ä¼šéšæœºæŒ‘é€‰ä¸€ä¸ªæœåŠ¡å™¨è¿›è¡Œé€šä¿¡ã€‚å¦‚æœå®¢æˆ·ç«¯ç¬¬ä¸€æ¬¡æŒ‘é€‰çš„æœåŠ¡å™¨ä¸æ˜¯é¢†å¯¼äººï¼Œé‚£ä¹ˆé‚£ä¸ªæœåŠ¡å™¨ä¼šæ‹’ç»å®¢æˆ·ç«¯çš„è¯·æ±‚å¹¶ä¸”æä¾›ä»–æœ€è¿‘æ¥æ”¶åˆ°çš„é¢†å¯¼äººçš„ä¿¡æ¯ï¼ˆé™„åŠ æ¡ç›®è¯·æ±‚åŒ…å«äº†é¢†å¯¼äººçš„ç½‘ç»œåœ°å€ï¼‰ã€‚å¦‚æœé¢†å¯¼äººå·²ç»å´©æºƒäº†ï¼Œé‚£ä¹ˆå®¢æˆ·ç«¯çš„è¯·æ±‚å°±ä¼šè¶…æ—¶ï¼›å®¢æˆ·ç«¯ä¹‹åä¼šå†æ¬¡é‡è¯•éšæœºæŒ‘é€‰æœåŠ¡å™¨çš„è¿‡ç¨‹ã€‚\n\næˆ‘ä»¬ Raft çš„ç›®æ ‡æ˜¯è¦å®ç°çº¿æ€§åŒ–è¯­ä¹‰ï¼ˆæ¯ä¸€æ¬¡æ“ä½œç«‹å³æ‰§è¡Œï¼Œåªæ‰§è¡Œä¸€æ¬¡ï¼Œåœ¨ä»–è°ƒç”¨å’Œæ”¶åˆ°å›å¤ä¹‹é—´ï¼‰ã€‚ä½†æ˜¯ï¼Œå¦‚ä¸Šè¿°ï¼ŒRaft æ˜¯å¯èƒ½æ‰§è¡ŒåŒä¸€æ¡å‘½ä»¤å¤šæ¬¡çš„ï¼šä¾‹å¦‚ï¼Œå¦‚æœé¢†å¯¼äººåœ¨æäº¤äº†è¿™æ¡æ—¥å¿—ä¹‹åï¼Œä½†æ˜¯åœ¨å“åº”å®¢æˆ·ç«¯ä¹‹å‰å´©æºƒäº†ï¼Œé‚£ä¹ˆå®¢æˆ·ç«¯ä¼šå’Œæ–°çš„é¢†å¯¼äººé‡è¯•è¿™æ¡æŒ‡ä»¤ï¼Œå¯¼è‡´è¿™æ¡å‘½ä»¤å°±è¢«å†æ¬¡æ‰§è¡Œäº†ã€‚è§£å†³æ–¹æ¡ˆå°±æ˜¯å®¢æˆ·ç«¯å¯¹äºæ¯ä¸€æ¡æŒ‡ä»¤éƒ½èµ‹äºˆä¸€ä¸ªå”¯ä¸€çš„åºåˆ—å·ã€‚ç„¶åï¼ŒçŠ¶æ€æœºè·Ÿè¸ªæ¯æ¡æŒ‡ä»¤æœ€æ–°çš„åºåˆ—å·å’Œç›¸åº”çš„å“åº”ã€‚å¦‚æœæ¥æ”¶åˆ°ä¸€æ¡æŒ‡ä»¤ï¼Œå®ƒçš„åºåˆ—å·å·²ç»è¢«æ‰§è¡Œäº†ï¼Œé‚£ä¹ˆå°±ç«‹å³è¿”å›ç»“æœï¼Œè€Œä¸é‡æ–°æ‰§è¡ŒæŒ‡ä»¤ã€‚\n\nåªè¯»çš„æ“ä½œå¯ä»¥ç›´æ¥å¤„ç†è€Œä¸éœ€è¦è®°å½•æ—¥å¿—ã€‚ä½†æ˜¯ï¼Œåœ¨ä¸å¢åŠ ä»»ä½•é™åˆ¶çš„æƒ…å†µä¸‹ï¼Œè¿™ä¹ˆåšå¯èƒ½ä¼šå†’ç€è¿”å›è„æ•°æ®çš„é£é™©ï¼Œå› ä¸ºå“åº”å®¢æˆ·ç«¯è¯·æ±‚çš„é¢†å¯¼äººå¯èƒ½åœ¨ä»–ä¸çŸ¥é“çš„æ—¶å€™å·²ç»è¢«æ–°çš„é¢†å¯¼äººå–ä»£äº†ã€‚çº¿æ€§åŒ–çš„è¯»æ“ä½œå¿…é¡»ä¸èƒ½è¿”å›è„æ•°æ®ï¼ŒRaft éœ€è¦ä½¿ç”¨ä¸¤ä¸ªé¢å¤–çš„æªæ–½åœ¨ä¸ä½¿ç”¨æ—¥å¿—çš„æƒ…å†µä¸‹ä¿è¯è¿™ä¸€ç‚¹ã€‚é¦–å…ˆï¼Œé¢†å¯¼äººå¿…é¡»æœ‰å…³äºè¢«æäº¤æ—¥å¿—çš„æœ€æ–°ä¿¡æ¯ã€‚é¢†å¯¼äººå®Œå…¨ç‰¹æ€§ä¿è¯äº†é¢†å¯¼äººä¸€å®šæ‹¥æœ‰æ‰€æœ‰å·²ç»è¢«æäº¤çš„æ—¥å¿—æ¡ç›®ï¼Œä½†æ˜¯åœ¨ä»–ä»»æœŸå¼€å§‹çš„æ—¶å€™ï¼Œä»–å¯èƒ½ä¸çŸ¥é“å“ªäº›æ˜¯å·²ç»è¢«æäº¤çš„ã€‚ä¸ºäº†çŸ¥é“è¿™äº›ä¿¡æ¯ï¼Œä»–éœ€è¦åœ¨ä»–çš„ä»»æœŸé‡Œæäº¤ä¸€æ¡æ—¥å¿—æ¡ç›®ã€‚Raft ä¸­é€šè¿‡é¢†å¯¼äººåœ¨ä»»æœŸå¼€å§‹çš„æ—¶å€™æäº¤ä¸€ä¸ªç©ºç™½çš„æ²¡æœ‰ä»»ä½•æ“ä½œçš„æ—¥å¿—æ¡ç›®åˆ°æ—¥å¿—ä¸­å»æ¥å®ç°ã€‚ç¬¬äºŒï¼Œé¢†å¯¼äººåœ¨å¤„ç†åªè¯»çš„è¯·æ±‚ä¹‹å‰å¿…é¡»æ£€æŸ¥è‡ªå·±æ˜¯å¦å·²ç»è¢«åºŸé»œäº†ï¼ˆä»–è‡ªå·±çš„ä¿¡æ¯å·²ç»å˜è„äº†å¦‚æœä¸€ä¸ªæ›´æ–°çš„é¢†å¯¼äººè¢«é€‰ä¸¾å‡ºæ¥ï¼‰ã€‚Raft ä¸­é€šè¿‡è®©é¢†å¯¼äººåœ¨å“åº”åªè¯»è¯·æ±‚ä¹‹å‰ï¼Œå…ˆå’Œé›†ç¾¤ä¸­çš„å¤§å¤šæ•°èŠ‚ç‚¹äº¤æ¢ä¸€æ¬¡å¿ƒè·³ä¿¡æ¯æ¥å¤„ç†è¿™ä¸ªé—®é¢˜ã€‚å¯é€‰çš„ï¼Œé¢†å¯¼äººå¯ä»¥ä¾èµ–å¿ƒè·³æœºåˆ¶æ¥å®ç°ä¸€ç§ç§Ÿçº¦çš„æœºåˆ¶ï¼Œä½†æ˜¯è¿™ç§æ–¹æ³•ä¾èµ–æ—¶é—´æ¥ä¿è¯å®‰å…¨æ€§ï¼ˆå‡è®¾æ—¶é—´è¯¯å·®æ˜¯æœ‰ç•Œçš„ï¼‰ã€‚\n\n## 9 ç®—æ³•å®ç°å’Œè¯„ä¼°\n\næˆ‘ä»¬å·²ç»ä¸º RAMCloud å®ç°äº† Raft ç®—æ³•ä½œä¸ºå­˜å‚¨é…ç½®ä¿¡æ¯çš„å¤åˆ¶çŠ¶æ€æœºçš„ä¸€éƒ¨åˆ†ï¼Œå¹¶ä¸”å¸®åŠ© RAMCloud åè°ƒæ•…éšœè½¬ç§»ã€‚è¿™ä¸ª Raft å®ç°åŒ…å«å¤§çº¦ 2000 è¡Œ C++ ä»£ç ï¼Œå…¶ä¸­ä¸åŒ…æ‹¬æµ‹è¯•ã€æ³¨é‡Šå’Œç©ºè¡Œã€‚è¿™äº›ä»£ç æ˜¯å¼€æºçš„ã€‚åŒæ—¶ä¹Ÿæœ‰å¤§çº¦ 25 ä¸ªå…¶ä»–ç‹¬ç«‹çš„ç¬¬ä¸‰æ–¹çš„åŸºäºè¿™ç¯‡è®ºæ–‡è‰ç¨¿çš„å¼€æºå®ç°ï¼Œé’ˆå¯¹ä¸åŒçš„å¼€å‘åœºæ™¯ã€‚åŒæ—¶ï¼Œå¾ˆå¤šå…¬å¸å·²ç»éƒ¨ç½²äº†åŸºäº Raft çš„ç³»ç»Ÿã€‚\n\nè¿™ä¸€èŠ‚ä¼šä»ä¸‰ä¸ªæ–¹é¢æ¥è¯„ä¼° Raft ç®—æ³•ï¼šå¯ç†è§£æ€§ã€æ­£ç¡®æ€§å’Œæ€§èƒ½ã€‚\n\n### 9.1 å¯ç†è§£æ€§\n\nä¸ºäº†å’Œ Paxos æ¯”è¾ƒ Raft ç®—æ³•çš„å¯ç†è§£èƒ½åŠ›ï¼Œæˆ‘ä»¬é’ˆå¯¹é«˜å±‚æ¬¡çš„æœ¬ç§‘ç”Ÿå’Œç ”ç©¶ç”Ÿï¼Œåœ¨æ–¯å¦ç¦å¤§å­¦çš„é«˜çº§æ“ä½œç³»ç»Ÿè¯¾ç¨‹å’ŒåŠ å·å¤§å­¦ä¼¯å…‹åˆ©åˆ†æ ¡çš„åˆ†å¸ƒå¼è®¡ç®—è¯¾ç¨‹ä¸Šï¼Œè¿›è¡Œäº†ä¸€æ¬¡å­¦ä¹ çš„å®éªŒã€‚æˆ‘ä»¬åˆ†åˆ«æ‹äº†é’ˆå¯¹ Raft å’Œ Paxos çš„è§†é¢‘è¯¾ç¨‹ï¼Œå¹¶å‡†å¤‡äº†ç›¸åº”çš„å°æµ‹éªŒã€‚Raft çš„è§†é¢‘è®²è¯¾è¦†ç›–äº†è¿™ç¯‡è®ºæ–‡çš„æ‰€æœ‰å†…å®¹é™¤äº†æ—¥å¿—å‹ç¼©ï¼›Paxos è®²è¯¾åŒ…å«äº†è¶³å¤Ÿçš„èµ„æ–™æ¥åˆ›å»ºä¸€ä¸ªç­‰ä»·çš„å¤åˆ¶çŠ¶æ€æœºï¼ŒåŒ…æ‹¬å•å†³ç­– Paxosï¼Œå¤šå†³ç­– Paxosï¼Œé‡æ–°é…ç½®å’Œä¸€äº›å®é™…ç³»ç»Ÿéœ€è¦çš„æ€§èƒ½ä¼˜åŒ–ï¼ˆä¾‹å¦‚é¢†å¯¼äººé€‰ä¸¾ï¼‰ã€‚å°æµ‹éªŒæµ‹è¯•ä¸€äº›å¯¹ç®—æ³•çš„åŸºæœ¬ç†è§£å’Œè§£é‡Šä¸€äº›è¾¹è§’çš„ç¤ºä¾‹ã€‚æ¯ä¸ªå­¦ç”Ÿéƒ½æ˜¯çœ‹å®Œç¬¬ä¸€ä¸ªè§†é¢‘ï¼Œå›ç­”ç›¸åº”çš„æµ‹è¯•ï¼Œå†çœ‹ç¬¬äºŒä¸ªè§†é¢‘ï¼Œå›ç­”ç›¸åº”çš„æµ‹è¯•ã€‚å¤§çº¦æœ‰ä¸€åŠçš„å­¦ç”Ÿå…ˆè¿›è¡Œ Paxos éƒ¨åˆ†ï¼Œç„¶åå¦ä¸€åŠå…ˆè¿›è¡Œ Raft éƒ¨åˆ†ï¼Œè¿™æ˜¯ä¸ºäº†è¯´æ˜ä¸¤è€…ä»ç¬¬ä¸€éƒ¨åˆ†çš„ç®—æ³•å­¦ä¹ ä¸­è·å¾—çš„è¡¨ç°å’Œç»éªŒçš„å·®å¼‚ã€‚æˆ‘ä»¬è®¡ç®—å‚åŠ äººå‘˜çš„æ¯ä¸€ä¸ªå°æµ‹éªŒçš„å¾—åˆ†æ¥çœ‹å‚ä¸è€…æ˜¯å¦åœ¨ Raft ç®—æ³•ä¸Šæ›´åŠ å®¹æ˜“ç†è§£ã€‚\n\næˆ‘ä»¬å°½å¯èƒ½çš„ä½¿å¾— Paxos å’Œ Raft çš„æ¯”è¾ƒæ›´åŠ å…¬å¹³ã€‚è¿™ä¸ªå®éªŒåçˆ± Paxos è¡¨ç°åœ¨ä¸¤ä¸ªæ–¹é¢ï¼š43 ä¸ªå‚åŠ è€…ä¸­æœ‰ 15 ä¸ªäººåœ¨ä¹‹å‰æœ‰ä¸€äº›  Paxos çš„ç»éªŒï¼Œå¹¶ä¸” Paxos çš„è§†é¢‘è¦é•¿ 14%ã€‚å¦‚è¡¨æ ¼ 1 æ€»ç»“çš„é‚£æ ·ï¼Œæˆ‘ä»¬é‡‡å–äº†ä¸€äº›æªæ–½æ¥å‡è½»è¿™ç§æ½œåœ¨çš„åè§ã€‚æˆ‘ä»¬æ‰€æœ‰çš„ææ–™éƒ½å¯ä¾›å®¡æŸ¥ã€‚\n\n| å…³å¿ƒ | ç¼“å’Œåè§é‡‡å–çš„æ‰‹æ®µ | å¯ä¾›æŸ¥çœ‹çš„ææ–™ |\n|:----:|:----:|:----:|\n| ç›¸åŒçš„è®²è¯¾è´¨é‡ | ä¸¤è€…ä½¿ç”¨åŒä¸€ä¸ªè®²å¸ˆã€‚Paxos ä½¿ç”¨çš„æ˜¯ç°åœ¨å¾ˆå¤šå¤§å­¦é‡Œç»å¸¸ä½¿ç”¨çš„ã€‚Paxos ä¼šé•¿ 14%ã€‚ | è§†é¢‘ |\n| ç›¸åŒçš„æµ‹éªŒéš¾åº¦ | é—®é¢˜ä»¥éš¾åº¦åˆ†ç»„ï¼Œåœ¨ä¸¤ä¸ªæµ‹éªŒé‡Œæˆå¯¹å‡ºç°ã€‚| å°æµ‹éªŒ |\n| å…¬å¹³è¯„åˆ† | ä½¿ç”¨è¯„ä»·é‡è§„ã€‚éšæœºé¡ºåºæ‰“åˆ†ï¼Œä¸¤ä¸ªæµ‹éªŒäº¤æ›¿è¿›è¡Œã€‚ | è¯„ä»·é‡è§„ï¼ˆrubricï¼‰ |\n\n> è¡¨ 1ï¼šè€ƒè™‘åˆ°å¯èƒ½ä¼šå­˜åœ¨çš„åè§ï¼Œå¯¹äºæ¯ç§æƒ…å†µçš„è§£å†³æ–¹æ³•ï¼Œå’Œç›¸åº”çš„ææ–™ã€‚\n\nå‚åŠ è€…å¹³å‡åœ¨ Raft çš„æµ‹éªŒä¸­æ¯” Paxos é«˜ 4.9 åˆ†ï¼ˆæ€»åˆ† 60ï¼Œé‚£ä¹ˆ Raft çš„å¹³å‡å¾—åˆ†æ˜¯ 25.7ï¼Œè€Œ Paxos æ˜¯ 20.8ï¼‰ï¼›å›¾ 14 å±•ç¤ºäº†æ¯ä¸ªå‚ä¸è€…çš„å¾—åˆ†ã€‚é…ç½®t-æ£€éªŒï¼ˆåˆç§°studentâ€˜s t-testï¼‰è¡¨æ˜ï¼Œåœ¨ 95% çš„å¯ä¿¡åº¦ä¸‹ï¼ŒçœŸå®çš„ Raft åˆ†æ•°åˆ†å¸ƒè‡³å°‘æ¯” Paxos é«˜ 2.5 åˆ†ã€‚\n\n![å›¾ 14](/img/2023-06-25-raft-zh_cn/raft-å›¾14.png)\n\n> å›¾ 14ï¼šä¸€ä¸ªæ•£ç‚¹å›¾è¡¨ç¤ºäº† 43 ä¸ªå­¦ç”Ÿåœ¨ Paxos å’Œ Raft çš„å°æµ‹éªŒä¸­çš„æˆç»©ã€‚åœ¨å¯¹è§’çº¿ä¹‹ä¸Šçš„ç‚¹è¡¨ç¤ºåœ¨ Raft è·å¾—äº†æ›´é«˜åˆ†æ•°çš„å­¦ç”Ÿã€‚\n\næˆ‘ä»¬ä¹Ÿå»ºç«‹äº†ä¸€ä¸ªçº¿æ€§å›å½’æ¨¡å‹æ¥é¢„æµ‹ä¸€ä¸ªæ–°çš„å­¦ç”Ÿçš„æµ‹éªŒæˆç»©ï¼ŒåŸºäºä»¥ä¸‹ä¸‰ä¸ªå› ç´ ï¼šä»–ä»¬ä½¿ç”¨çš„æ˜¯å“ªä¸ªå°æµ‹éªŒï¼Œä¹‹å‰å¯¹ Paxos çš„ç»éªŒï¼Œå’Œå­¦ä¹ ç®—æ³•çš„é¡ºåºã€‚æ¨¡å‹é¢„æµ‹ï¼Œå¯¹å°æµ‹éªŒçš„é€‰æ‹©ä¼šäº§ç”Ÿ 12.5 åˆ†çš„å·®åˆ«ã€‚è¿™æ˜¾è‘—çš„é«˜äºä¹‹å‰çš„ 4.9 åˆ†ï¼Œå› ä¸ºå¾ˆå¤šå­¦ç”Ÿåœ¨ä¹‹å‰éƒ½å·²ç»æœ‰äº†å¯¹äº Paxos çš„ç»éªŒï¼Œè¿™ç›¸å½“æ˜æ˜¾çš„å¸®åŠ© Paxosï¼Œå¯¹ Raft å°±æ²¡ä»€ä¹ˆå¤ªå¤§å½±å“äº†ã€‚ä½†æ˜¯å¥‡æ€ªçš„æ˜¯ï¼Œæ¨¡å‹é¢„æµ‹å¯¹äºå…ˆè¿›è¡Œ Paxos å°æµ‹éªŒçš„äººè€Œè¨€ï¼ŒRaftçš„å¾—åˆ†ä½äº†6.3åˆ†; è™½ç„¶æˆ‘ä»¬ä¸çŸ¥é“ä¸ºä»€ä¹ˆï¼Œè¿™ä¼¼ä¹åœ¨ç»Ÿè®¡ä¸Šæ˜¯æœ‰æ„ä¹‰çš„ã€‚\n\næˆ‘ä»¬åŒæ—¶ä¹Ÿåœ¨æµ‹éªŒä¹‹åè°ƒæŸ¥äº†å‚ä¸è€…ï¼Œä»–ä»¬è®¤ä¸ºå“ªä¸ªç®—æ³•æ›´åŠ å®¹æ˜“å®ç°å’Œè§£é‡Šï¼›è¿™ä¸ªçš„ç»“æœåœ¨å›¾ 15 ä¸Šã€‚å‹å€’æ€§çš„ç»“æœè¡¨æ˜ Raft ç®—æ³•æ›´åŠ å®¹æ˜“å®ç°å’Œè§£é‡Šï¼ˆ41 äººä¸­çš„ 33ä¸ªï¼‰ã€‚ä½†æ˜¯ï¼Œè¿™ç§è‡ªå·±æŠ¥å‘Šçš„ç»“æœä¸å¦‚å‚ä¸è€…çš„æˆç»©æ›´åŠ å¯ä¿¡ï¼Œå¹¶ä¸”å‚ä¸è€…å¯èƒ½å› ä¸ºæˆ‘ä»¬çš„ Raft æ›´åŠ æ˜“äºç†è§£çš„å‡è¯´è€Œäº§ç”Ÿåè§ã€‚\n\n![å›¾ 15](/img/2023-06-25-raft-zh_cn/raft-å›¾15.png)\n\n> å›¾ 15ï¼šé€šè¿‡ä¸€ä¸ª 5 åˆ†åˆ¶çš„é—®é¢˜ï¼Œå‚ä¸è€…ï¼ˆå·¦è¾¹ï¼‰è¢«é—®å“ªä¸ªç®—æ³•ä»–ä»¬è§‰å¾—åœ¨ä¸€ä¸ªé«˜æ•ˆæ­£ç¡®çš„ç³»ç»Ÿé‡Œæ›´å®¹æ˜“å®ç°ï¼Œå³è¾¹è¢«é—®å“ªä¸ªæ›´å®¹æ˜“å‘å­¦ç”Ÿè§£é‡Šã€‚\n\nå…³äº Raft ç”¨æˆ·å­¦ä¹ æœ‰ä¸€ä¸ªæ›´åŠ è¯¦ç»†çš„è®¨è®ºã€‚\n\n### 9.2 æ­£ç¡®æ€§\n\nåœ¨ç¬¬ 5 èŠ‚ï¼Œæˆ‘ä»¬å·²ç»åˆ¶å®šäº†æ­£å¼çš„è§„èŒƒï¼Œå’Œå¯¹ä¸€è‡´æ€§æœºåˆ¶çš„å®‰å…¨æ€§è¯æ˜ã€‚è¿™ä¸ªæ­£å¼è§„èŒƒä½¿ç”¨ TLA+ è§„èŒƒè¯­è¨€ä½¿å›¾ 2 ä¸­æ€»ç»“çš„ä¿¡æ¯éå¸¸æ¸…æ™°ã€‚å®ƒé•¿çº¦400è¡Œï¼Œå¹¶ä½œä¸ºè¯æ˜çš„ä¸»é¢˜ã€‚åŒæ—¶å¯¹äºä»»ä½•æƒ³å®ç° Raft çš„äººä¹Ÿæ˜¯ååˆ†æœ‰ç”¨çš„ã€‚æˆ‘ä»¬é€šè¿‡ TLA è¯æ˜ç³»ç»Ÿéå¸¸æœºæ¢°çš„è¯æ˜äº†æ—¥å¿—å®Œå…¨ç‰¹æ€§ã€‚ç„¶è€Œï¼Œè¿™ä¸ªè¯æ˜ä¾èµ–çš„çº¦æŸå‰æè¿˜æ²¡æœ‰è¢«æœºæ¢°è¯æ˜ï¼ˆä¾‹å¦‚ï¼Œæˆ‘ä»¬è¿˜æ²¡æœ‰è¯æ˜è§„èŒƒçš„ç±»å‹å®‰å…¨ï¼‰ã€‚è€Œä¸”ï¼Œæˆ‘ä»¬å·²ç»å†™äº†ä¸€ä¸ªéæ­£å¼çš„è¯æ˜å…³äºçŠ¶æ€æœºå®‰å…¨æ€§æ˜¯å®Œå¤‡çš„ï¼Œå¹¶ä¸”æ˜¯ç›¸å½“æ¸…æ™°çš„ï¼ˆå¤§çº¦ 3500 ä¸ªè¯ï¼‰ã€‚\n\n### 9.3 æ€§èƒ½\n\nRaft å’Œå…¶ä»–ä¸€è‡´æ€§ç®—æ³•ä¾‹å¦‚ Paxos æœ‰ç€å·®ä¸å¤šçš„æ€§èƒ½ã€‚åœ¨æ€§èƒ½æ–¹é¢ï¼Œæœ€é‡è¦çš„å…³æ³¨ç‚¹æ˜¯ï¼Œå½“é¢†å¯¼äººè¢«é€‰ä¸¾æˆåŠŸæ—¶ï¼Œä»€ä¹ˆæ—¶å€™å¤åˆ¶æ–°çš„æ—¥å¿—æ¡ç›®ã€‚Raft é€šè¿‡å¾ˆå°‘æ•°é‡çš„æ¶ˆæ¯åŒ…ï¼ˆä¸€è½®ä»é¢†å¯¼äººåˆ°é›†ç¾¤å¤§å¤šæ•°æœºå™¨çš„æ¶ˆæ¯ï¼‰å°±è¾¾æˆäº†è¿™ä¸ªç›®çš„ã€‚åŒæ—¶ï¼Œè¿›ä¸€æ­¥æå‡ Raft çš„æ€§èƒ½ä¹Ÿæ˜¯å¯è¡Œçš„ã€‚ä¾‹å¦‚ï¼Œå¾ˆå®¹æ˜“é€šè¿‡æ”¯æŒæ‰¹é‡æ“ä½œå’Œç®¡é“æ“ä½œæ¥æé«˜ååé‡å’Œé™ä½å»¶è¿Ÿã€‚å¯¹äºå…¶ä»–ä¸€è‡´æ€§ç®—æ³•å·²ç»æå‡ºè¿‡å¾ˆå¤šæ€§èƒ½ä¼˜åŒ–æ–¹æ¡ˆï¼›å…¶ä¸­æœ‰å¾ˆå¤šä¹Ÿå¯ä»¥åº”ç”¨åˆ° Raft ä¸­æ¥ï¼Œä½†æ˜¯æˆ‘ä»¬æš‚æ—¶æŠŠè¿™ä¸ªé—®é¢˜æ”¾åˆ°æœªæ¥çš„å·¥ä½œä¸­å»ã€‚\n\næˆ‘ä»¬ä½¿ç”¨æˆ‘ä»¬è‡ªå·±çš„ Raft å®ç°æ¥è¡¡é‡ Raft é¢†å¯¼äººé€‰ä¸¾çš„æ€§èƒ½å¹¶ä¸”å›ç­”ä¸¤ä¸ªé—®é¢˜ã€‚é¦–å…ˆï¼Œé¢†å¯¼äººé€‰ä¸¾çš„è¿‡ç¨‹æ”¶æ•›æ˜¯å¦å¿«é€Ÿï¼Ÿç¬¬äºŒï¼Œåœ¨é¢†å¯¼äººå®•æœºä¹‹åï¼Œæœ€å°çš„ç³»ç»Ÿå®•æœºæ—¶é—´æ˜¯å¤šä¹…ï¼Ÿ\n\n![å›¾ 16](/img/2023-06-25-raft-zh_cn/raft-å›¾16.png)\n\n> å›¾ 16ï¼šå‘ç°å¹¶æ›¿æ¢ä¸€ä¸ªå·²ç»å´©æºƒçš„é¢†å¯¼äººçš„æ—¶é—´ã€‚ä¸Šé¢çš„å›¾è€ƒå¯Ÿäº†åœ¨é€‰ä¸¾è¶…æ—¶æ—¶é—´ä¸Šçš„éšæœºåŒ–ç¨‹åº¦ï¼Œä¸‹é¢çš„å›¾è€ƒå¯Ÿäº†æœ€å°é€‰ä¸¾è¶…æ—¶æ—¶é—´ã€‚æ¯æ¡çº¿ä»£è¡¨äº† 1000 æ¬¡å®éªŒï¼ˆé™¤äº† 150-150 æ¯«ç§’åªè¯•äº† 100 æ¬¡ï¼‰ï¼Œå’Œç›¸åº”çš„ç¡®å®šçš„é€‰ä¸¾è¶…æ—¶æ—¶é—´ã€‚ä¾‹å¦‚ï¼Œ150-155 æ¯«ç§’æ„æ€æ˜¯ï¼Œé€‰ä¸¾è¶…æ—¶æ—¶é—´ä»è¿™ä¸ªåŒºé—´èŒƒå›´å†…éšæœºé€‰æ‹©å¹¶ç¡®å®šä¸‹æ¥ã€‚è¿™ä¸ªå®éªŒåœ¨ä¸€ä¸ªæ‹¥æœ‰ 5 ä¸ªèŠ‚ç‚¹çš„é›†ç¾¤ä¸Šè¿›è¡Œï¼Œå…¶å¹¿æ’­æ—¶å»¶å¤§çº¦æ˜¯ 15 æ¯«ç§’ã€‚å¯¹äº 9 ä¸ªèŠ‚ç‚¹çš„é›†ç¾¤ï¼Œç»“æœä¹Ÿå·®ä¸å¤šã€‚\n\nä¸ºäº†è¡¡é‡é¢†å¯¼äººé€‰ä¸¾ï¼Œæˆ‘ä»¬åå¤çš„ä½¿ä¸€ä¸ªæ‹¥æœ‰äº”ä¸ªèŠ‚ç‚¹çš„æœåŠ¡å™¨é›†ç¾¤çš„é¢†å¯¼äººå®•æœºï¼Œå¹¶è®¡ç®—éœ€è¦å¤šä¹…æ‰èƒ½å‘ç°é¢†å¯¼äººå·²ç»å®•æœºå¹¶é€‰å‡ºä¸€ä¸ªæ–°çš„é¢†å¯¼äººï¼ˆè§å›¾ 16ï¼‰ã€‚ä¸ºäº†æ„å»ºä¸€ä¸ªæœ€åçš„åœºæ™¯ï¼Œåœ¨æ¯ä¸€çš„å°è¯•é‡Œï¼ŒæœåŠ¡å™¨éƒ½æœ‰ä¸åŒé•¿åº¦çš„æ—¥å¿—ï¼Œæ„å‘³ç€æœ‰äº›å€™é€‰äººæ˜¯æ²¡æœ‰æˆä¸ºé¢†å¯¼äººçš„èµ„æ ¼çš„ã€‚å¦å¤–ï¼Œä¸ºäº†ä¿ƒæˆé€‰ç¥¨ç“œåˆ†çš„æƒ…å†µï¼Œæˆ‘ä»¬çš„æµ‹è¯•è„šæœ¬åœ¨ç»ˆæ­¢é¢†å¯¼äººä¹‹å‰åŒæ­¥çš„å‘é€äº†ä¸€æ¬¡å¿ƒè·³å¹¿æ’­ï¼ˆè¿™å¤§çº¦å’Œé¢†å¯¼äººåœ¨å´©æºƒå‰å¤åˆ¶ä¸€ä¸ªæ–°çš„æ—¥å¿—ç»™å…¶ä»–æœºå™¨å¾ˆåƒï¼‰ã€‚é¢†å¯¼äººå‡åŒ€çš„éšæœºçš„åœ¨å¿ƒè·³é—´éš”é‡Œå®•æœºï¼Œä¹Ÿå°±æ˜¯æœ€å°é€‰ä¸¾è¶…æ—¶æ—¶é—´çš„ä¸€åŠã€‚å› æ­¤ï¼Œæœ€å°å®•æœºæ—¶é—´å¤§çº¦å°±æ˜¯æœ€å°é€‰ä¸¾è¶…æ—¶æ—¶é—´çš„ä¸€åŠã€‚\n\nå›¾ 16 ä¸­ä¸Šé¢çš„å›¾è¡¨æ˜ï¼Œåªéœ€è¦åœ¨é€‰ä¸¾è¶…æ—¶æ—¶é—´ä¸Šä½¿ç”¨å¾ˆå°‘çš„éšæœºåŒ–å°±å¯ä»¥å¤§å¤§é¿å…é€‰ç¥¨è¢«ç“œåˆ†çš„æƒ…å†µã€‚åœ¨æ²¡æœ‰éšæœºåŒ–çš„æƒ…å†µä¸‹ï¼Œåœ¨æˆ‘ä»¬çš„æµ‹è¯•é‡Œï¼Œé€‰ä¸¾è¿‡ç¨‹å¾€å¾€éƒ½éœ€è¦èŠ±è´¹è¶…è¿‡ 10 ç§’é’Ÿç”±äºå¤ªå¤šçš„é€‰ç¥¨ç“œåˆ†çš„æƒ…å†µã€‚ä»…ä»…å¢åŠ  5 æ¯«ç§’çš„éšæœºåŒ–æ—¶é—´ï¼Œå°±å¤§å¤§çš„æ”¹å–„äº†é€‰ä¸¾è¿‡ç¨‹ï¼Œç°åœ¨å¹³å‡çš„å®•æœºæ—¶é—´åªæœ‰ 287 æ¯«ç§’ã€‚å¢åŠ æ›´å¤šçš„éšæœºåŒ–æ—¶é—´å¯ä»¥å¤§å¤§æ”¹å–„æœ€åæƒ…å†µï¼šé€šè¿‡å¢åŠ  50 æ¯«ç§’çš„éšæœºåŒ–æ—¶é—´ï¼Œæœ€åçš„å®Œæˆæƒ…å†µï¼ˆ1000 æ¬¡å°è¯•ï¼‰åªè¦ 513 æ¯«ç§’ã€‚\n\nå›¾ 16 ä¸­ä¸‹é¢çš„å›¾æ˜¾ç¤ºï¼Œé€šè¿‡å‡å°‘é€‰ä¸¾è¶…æ—¶æ—¶é—´å¯ä»¥å‡å°‘ç³»ç»Ÿçš„å®•æœºæ—¶é—´ã€‚åœ¨é€‰ä¸¾è¶…æ—¶æ—¶é—´ä¸º 12-24 æ¯«ç§’çš„æƒ…å†µä¸‹ï¼Œåªéœ€è¦å¹³å‡ 35 æ¯«ç§’å°±å¯ä»¥é€‰ä¸¾å‡ºæ–°çš„é¢†å¯¼äººï¼ˆæœ€é•¿çš„ä¸€æ¬¡èŠ±è´¹äº† 152 æ¯«ç§’ï¼‰ã€‚ç„¶è€Œï¼Œè¿›ä¸€æ­¥é™ä½é€‰ä¸¾è¶…æ—¶æ—¶é—´çš„è¯å°±ä¼šè¿å Raft çš„æ—¶é—´ä¸ç­‰å¼éœ€æ±‚ï¼šåœ¨é€‰ä¸¾æ–°é¢†å¯¼äººä¹‹å‰ï¼Œé¢†å¯¼äººå°±å¾ˆéš¾å‘é€å®Œå¿ƒè·³åŒ…ã€‚è¿™ä¼šå¯¼è‡´æ²¡æœ‰æ„ä¹‰çš„é¢†å¯¼äººæ”¹å˜å¹¶é™ä½äº†ç³»ç»Ÿæ•´ä½“çš„å¯ç”¨æ€§ã€‚æˆ‘ä»¬å»ºè®®ä½¿ç”¨æ›´ä¸ºä¿å®ˆçš„é€‰ä¸¾è¶…æ—¶æ—¶é—´ï¼Œæ¯”å¦‚ 150-300 æ¯«ç§’ï¼›è¿™æ ·çš„æ—¶é—´ä¸å¤§å¯èƒ½å¯¼è‡´æ²¡æœ‰æ„ä¹‰çš„é¢†å¯¼äººæ”¹å˜ï¼Œè€Œä¸”ä¾ç„¶æä¾›ä¸é”™çš„å¯ç”¨æ€§ã€‚\n\n## 10 ç›¸å…³å·¥ä½œ\n\nå·²ç»æœ‰å¾ˆå¤šå…³äºä¸€è‡´æ€§ç®—æ³•çš„å·¥ä½œè¢«å‘è¡¨å‡ºæ¥ï¼Œå…¶ä¸­å¾ˆå¤šéƒ½å¯ä»¥å½’åˆ°ä¸‹é¢çš„ç±»åˆ«ä¸­ï¼š\n\n* Lamport å…³äº Paxos çš„åŸå§‹æè¿°ï¼Œå’Œå°è¯•æè¿°çš„æ›´æ¸…æ™°ã€‚\n* å…³äº Paxos çš„æ›´è¯¦å°½çš„æè¿°ï¼Œè¡¥å……é—æ¼çš„ç»†èŠ‚å¹¶ä¿®æ”¹ç®—æ³•ï¼Œä½¿å¾—å¯ä»¥æä¾›æ›´åŠ å®¹æ˜“çš„å®ç°åŸºç¡€ã€‚\n* å®ç°ä¸€è‡´æ€§ç®—æ³•çš„ç³»ç»Ÿï¼Œä¾‹å¦‚ Chubbyï¼ŒZooKeeper å’Œ Spannerã€‚å¯¹äº Chubby å’Œ Spanner çš„ç®—æ³•å¹¶æ²¡æœ‰å…¬å¼€å‘è¡¨å…¶æŠ€æœ¯ç»†èŠ‚ï¼Œå°½ç®¡ä»–ä»¬éƒ½å£°ç§°æ˜¯åŸºäº Paxos çš„ã€‚ZooKeeper çš„ç®—æ³•ç»†èŠ‚å·²ç»å‘è¡¨ï¼Œä½†æ˜¯å’Œ Paxos ç€å®æœ‰ç€å¾ˆå¤§çš„å·®åˆ«ã€‚\n* Paxos å¯ä»¥åº”ç”¨çš„æ€§èƒ½ä¼˜åŒ–ã€‚\n* Oki å’Œ Liskov çš„ Viewstamped Replicationï¼ˆVRï¼‰ï¼Œä¸€ç§å’Œ Paxos å·®ä¸å¤šçš„æ›¿ä»£ç®—æ³•ã€‚åŸå§‹çš„ç®—æ³•æè¿°å’Œåˆ†å¸ƒå¼ä¼ è¾“åè®®è€¦åˆåœ¨äº†ä¸€èµ·ï¼Œä½†æ˜¯æ ¸å¿ƒçš„ä¸€è‡´æ€§ç®—æ³•åœ¨æœ€è¿‘çš„æ›´æ–°é‡Œè¢«åˆ†ç¦»äº†å‡ºæ¥ã€‚VR ä½¿ç”¨äº†ä¸€ç§åŸºäºé¢†å¯¼äººçš„æ–¹æ³•ï¼Œå’Œ Raft æœ‰å¾ˆå¤šç›¸ä¼¼ä¹‹å¤„ã€‚\n\nRaft å’Œ Paxos æœ€å¤§çš„ä¸åŒä¹‹å¤„å°±åœ¨äº Raft çš„å¼ºé¢†å¯¼ç‰¹æ€§ï¼šRaft ä½¿ç”¨é¢†å¯¼äººé€‰ä¸¾ä½œä¸ºä¸€è‡´æ€§åè®®é‡Œå¿…ä¸å¯å°‘çš„éƒ¨åˆ†ï¼Œå¹¶ä¸”å°†å°½å¯èƒ½å¤šçš„åŠŸèƒ½é›†ä¸­åˆ°äº†é¢†å¯¼äººèº«ä¸Šã€‚è¿™æ ·å°±å¯ä»¥ä½¿å¾—ç®—æ³•æ›´åŠ å®¹æ˜“ç†è§£ã€‚ä¾‹å¦‚ï¼Œåœ¨ Paxos ä¸­ï¼Œé¢†å¯¼äººé€‰ä¸¾å’ŒåŸºæœ¬çš„ä¸€è‡´æ€§åè®®æ˜¯æ­£äº¤çš„ï¼šé¢†å¯¼äººé€‰ä¸¾ä»…ä»…æ˜¯æ€§èƒ½ä¼˜åŒ–çš„æ‰‹æ®µï¼Œè€Œä¸”ä¸æ˜¯ä¸€è‡´æ€§æ‰€å¿…é¡»è¦æ±‚çš„ã€‚ä½†æ˜¯ï¼Œè¿™æ ·å°±å¢åŠ äº†å¤šä½™çš„æœºåˆ¶ï¼šPaxos åŒæ—¶åŒ…å«äº†é’ˆå¯¹åŸºæœ¬ä¸€è‡´æ€§è¦æ±‚çš„ä¸¤é˜¶æ®µæäº¤åè®®å’Œé’ˆå¯¹é¢†å¯¼äººé€‰ä¸¾çš„ç‹¬ç«‹çš„æœºåˆ¶ã€‚ç›¸æ¯”è¾ƒè€Œè¨€ï¼ŒRaft å°±ç›´æ¥å°†é¢†å¯¼äººé€‰ä¸¾çº³å…¥åˆ°ä¸€è‡´æ€§ç®—æ³•ä¸­ï¼Œå¹¶ä½œä¸ºä¸¤é˜¶æ®µä¸€è‡´æ€§çš„ç¬¬ä¸€æ­¥ã€‚è¿™æ ·å°±å‡å°‘äº†å¾ˆå¤šæœºåˆ¶ã€‚\n\nåƒ Raft ä¸€æ ·ï¼ŒVR å’Œ ZooKeeper ä¹Ÿæ˜¯åŸºäºé¢†å¯¼äººçš„ï¼Œå› æ­¤ä»–ä»¬ä¹Ÿæ‹¥æœ‰ä¸€äº› Raft çš„ä¼˜ç‚¹ã€‚ä½†æ˜¯ï¼ŒRaft æ¯” VR å’Œ ZooKeeper æ‹¥æœ‰æ›´å°‘çš„æœºåˆ¶å› ä¸º Raft å°½å¯èƒ½çš„å‡å°‘äº†éé¢†å¯¼äººçš„åŠŸèƒ½ã€‚ä¾‹å¦‚ï¼ŒRaft ä¸­æ—¥å¿—æ¡ç›®éƒ½éµå¾ªç€ä»é¢†å¯¼äººå‘é€ç»™å…¶ä»–äººè¿™ä¸€ä¸ªæ–¹å‘ï¼šé™„åŠ æ¡ç›® RPC æ˜¯å‘å¤–å‘é€çš„ã€‚åœ¨ VR ä¸­ï¼Œæ—¥å¿—æ¡ç›®çš„æµåŠ¨æ˜¯åŒå‘çš„ï¼ˆé¢†å¯¼äººå¯ä»¥åœ¨é€‰ä¸¾è¿‡ç¨‹ä¸­æ¥æ”¶æ—¥å¿—ï¼‰ï¼›è¿™å°±å¯¼è‡´äº†é¢å¤–çš„æœºåˆ¶å’Œå¤æ‚æ€§ã€‚æ ¹æ® ZooKeeper å…¬å¼€çš„èµ„æ–™çœ‹ï¼Œå®ƒçš„æ—¥å¿—æ¡ç›®ä¹Ÿæ˜¯åŒå‘ä¼ è¾“çš„ï¼Œä½†æ˜¯å®ƒçš„å®ç°æ›´åƒ Raftã€‚\n\nå’Œä¸Šè¿°æˆ‘ä»¬æåŠçš„å…¶ä»–åŸºäºä¸€è‡´æ€§çš„æ—¥å¿—å¤åˆ¶ç®—æ³•ä¸­ï¼ŒRaft çš„æ¶ˆæ¯ç±»å‹æ›´å°‘ã€‚ä¾‹å¦‚ï¼Œæˆ‘ä»¬æ•°äº†ä¸€ä¸‹ VR å’Œ ZooKeeper ä½¿ç”¨çš„ç”¨æ¥åŸºæœ¬ä¸€è‡´æ€§éœ€è¦å’Œæˆå‘˜æ”¹å˜çš„æ¶ˆæ¯æ•°ï¼ˆæ’é™¤äº†æ—¥å¿—å‹ç¼©å’Œå®¢æˆ·ç«¯äº¤äº’ï¼Œå› ä¸ºè¿™äº›éƒ½æ¯”è¾ƒç‹¬ç«‹ä¸”å’Œç®—æ³•å…³ç³»ä¸å¤§ï¼‰ã€‚VR å’Œ ZooKeeper éƒ½åˆ†åˆ«å®šä¹‰äº† 10 ç§ä¸åŒçš„æ¶ˆæ¯ç±»å‹ï¼Œç›¸å¯¹çš„ï¼ŒRaft åªæœ‰ 4 ç§æ¶ˆæ¯ç±»å‹ï¼ˆä¸¤ç§ RPC è¯·æ±‚å’Œå¯¹åº”çš„å“åº”ï¼‰ã€‚Raft çš„æ¶ˆæ¯éƒ½ç¨å¾®æ¯”å…¶ä»–ç®—æ³•çš„è¦ä¿¡æ¯é‡å¤§ï¼Œä½†æ˜¯éƒ½å¾ˆç®€å•ã€‚å¦å¤–ï¼ŒVR å’Œ ZooKeeper éƒ½åœ¨é¢†å¯¼äººæ”¹å˜æ—¶ä¼ è¾“äº†æ•´ä¸ªæ—¥å¿—ï¼›æ‰€ä»¥ä¸ºäº†èƒ½å¤Ÿå®è·µä¸­ä½¿ç”¨ï¼Œé¢å¤–çš„æ¶ˆæ¯ç±»å‹å°±å¾ˆå¿…è¦äº†ã€‚\n\nRaft çš„å¼ºé¢†å¯¼äººæ¨¡å‹ç®€åŒ–äº†æ•´ä¸ªç®—æ³•ï¼Œä½†æ˜¯åŒæ—¶ä¹Ÿæ’æ–¥äº†ä¸€äº›æ€§èƒ½ä¼˜åŒ–çš„æ–¹æ³•ã€‚ä¾‹å¦‚ï¼Œå¹³ç­‰ä¸»ä¹‰ Paxos ï¼ˆEPaxosï¼‰åœ¨æŸäº›æ²¡æœ‰é¢†å¯¼äººçš„æƒ…å†µä¸‹å¯ä»¥è¾¾åˆ°å¾ˆé«˜çš„æ€§èƒ½ã€‚å¹³ç­‰ä¸»ä¹‰ Paxos å……åˆ†å‘æŒ¥äº†åœ¨çŠ¶æ€æœºæŒ‡ä»¤ä¸­çš„äº¤æ¢æ€§ã€‚ä»»ä½•æœåŠ¡å™¨éƒ½å¯ä»¥åœ¨ä¸€è½®é€šä¿¡ä¸‹å°±æäº¤æŒ‡ä»¤ï¼Œé™¤éå…¶ä»–æŒ‡ä»¤åŒæ—¶è¢«æå‡ºäº†ã€‚ç„¶è€Œï¼Œå¦‚æœæŒ‡ä»¤éƒ½æ˜¯å¹¶å‘çš„è¢«æå‡ºï¼Œå¹¶ä¸”äº’ç›¸ä¹‹é—´ä¸é€šä¿¡æ²Ÿé€šï¼Œé‚£ä¹ˆ EPaxos å°±éœ€è¦é¢å¤–çš„ä¸€è½®é€šä¿¡ã€‚å› ä¸ºä»»ä½•æœåŠ¡å™¨éƒ½å¯ä»¥æäº¤æŒ‡ä»¤ï¼Œæ‰€ä»¥ EPaxos åœ¨æœåŠ¡å™¨ä¹‹é—´çš„è´Ÿè½½å‡è¡¡åšçš„å¾ˆå¥½ï¼Œå¹¶ä¸”å¾ˆå®¹æ˜“åœ¨ WAN ç½‘ç»œç¯å¢ƒä¸‹è·å¾—å¾ˆä½çš„å»¶è¿Ÿã€‚ä½†æ˜¯ï¼Œä»–åœ¨ Paxos ä¸Šå¢åŠ äº†éå¸¸æ˜æ˜¾çš„å¤æ‚æ€§ã€‚\n\nä¸€äº›é›†ç¾¤æˆå‘˜å˜æ¢çš„æ–¹æ³•å·²ç»è¢«æå‡ºæˆ–è€…åœ¨å…¶ä»–çš„å·¥ä½œä¸­è¢«å®ç°ï¼ŒåŒ…æ‹¬ Lamport çš„åŸå§‹çš„è®¨è®ºï¼ŒVR å’Œ SMARTã€‚æˆ‘ä»¬é€‰æ‹©ä½¿ç”¨å…±åŒä¸€è‡´çš„æ–¹æ³•å› ä¸ºä»–å¯¹ä¸€è‡´æ€§åè®®çš„å…¶ä»–éƒ¨åˆ†å½±å“å¾ˆå°ï¼Œè¿™æ ·æˆ‘ä»¬åªéœ€è¦å¾ˆå°‘çš„ä¸€äº›æœºåˆ¶å°±å¯ä»¥å®ç°æˆå‘˜å˜æ¢ã€‚Lamport çš„åŸºäº Î± çš„æ–¹æ³•ä¹‹æ‰€ä»¥æ²¡æœ‰è¢« Raft é€‰æ‹©æ˜¯å› ä¸ºå®ƒå‡è®¾åœ¨æ²¡æœ‰é¢†å¯¼äººçš„æƒ…å†µä¸‹ä¹Ÿå¯ä»¥è¾¾åˆ°ä¸€è‡´æ€§ã€‚å’Œ VR å’Œ SMART ç›¸æ¯”è¾ƒï¼ŒRaft çš„é‡æ–°é…ç½®ç®—æ³•å¯ä»¥åœ¨ä¸é™åˆ¶æ­£å¸¸è¯·æ±‚å¤„ç†çš„æƒ…å†µä¸‹è¿›è¡Œï¼›ç›¸æ¯”è¾ƒçš„ï¼ŒVR éœ€è¦åœæ­¢æ‰€æœ‰çš„å¤„ç†è¿‡ç¨‹ï¼ŒSMART å¼•å…¥äº†ä¸€ä¸ªå’Œ Î± ç±»ä¼¼çš„æ–¹æ³•ï¼Œé™åˆ¶äº†è¯·æ±‚å¤„ç†çš„æ•°é‡ã€‚Raft çš„æ–¹æ³•åŒæ—¶ä¹Ÿéœ€è¦æ›´å°‘çš„é¢å¤–æœºåˆ¶æ¥å®ç°ï¼Œå’Œ VRã€SMART æ¯”è¾ƒè€Œè¨€ã€‚\n\n## 11 ç»“è®º\n\nç®—æ³•çš„è®¾è®¡é€šå¸¸ä¼šæŠŠæ­£ç¡®æ€§ï¼Œæ•ˆç‡æˆ–è€…ç®€æ´ä½œä¸ºä¸»è¦çš„ç›®æ ‡ã€‚å°½ç®¡è¿™äº›éƒ½æ˜¯å¾ˆæœ‰æ„ä¹‰çš„ç›®æ ‡ï¼Œä½†æ˜¯æˆ‘ä»¬ç›¸ä¿¡ï¼Œå¯ç†è§£æ€§ä¹Ÿæ˜¯ä¸€æ ·çš„é‡è¦ã€‚åœ¨å¼€å‘è€…æŠŠç®—æ³•åº”ç”¨åˆ°å®é™…çš„ç³»ç»Ÿä¸­ä¹‹å‰ï¼Œè¿™äº›ç›®æ ‡æ²¡æœ‰ä¸€ä¸ªä¼šè¢«å®ç°ï¼Œè¿™äº›éƒ½ä¼šå¿…ç„¶çš„åç¦»å‘è¡¨æ—¶çš„å½¢å¼ã€‚é™¤éå¼€å‘äººå‘˜å¯¹è¿™ä¸ªç®—æ³•æœ‰ç€å¾ˆæ·±çš„ç†è§£å¹¶ä¸”æœ‰ç€ç›´è§‚çš„æ„Ÿè§‰ï¼Œå¦åˆ™å°†ä¼šå¯¹ä»–ä»¬è€Œè¨€å¾ˆéš¾åœ¨å®ç°çš„æ—¶å€™ä¿æŒåŸæœ‰æœŸæœ›çš„ç‰¹æ€§ã€‚\n\nåœ¨è¿™ç¯‡è®ºæ–‡ä¸­ï¼Œæˆ‘ä»¬å°è¯•è§£å†³åˆ†å¸ƒå¼ä¸€è‡´æ€§é—®é¢˜ï¼Œä½†æ˜¯ä¸€ä¸ªå¹¿ä¸ºæ¥å—ä½†æ˜¯ååˆ†ä»¤äººè´¹è§£çš„ç®—æ³• Paxos å·²ç»å›°æ‰°äº†æ— æ•°å­¦ç”Ÿå’Œå¼€å‘è€…å¾ˆå¤šå¹´äº†ã€‚æˆ‘ä»¬åˆ›é€ äº†ä¸€ç§æ–°çš„ç®—æ³• Raftï¼Œæ˜¾è€Œæ˜“è§çš„æ¯” Paxos è¦å®¹æ˜“ç†è§£ã€‚æˆ‘ä»¬åŒæ—¶ä¹Ÿç›¸ä¿¡ï¼ŒRaft ä¹Ÿå¯ä»¥ä¸ºå®é™…çš„å®ç°æä¾›åšå®çš„åŸºç¡€ã€‚æŠŠå¯ç†è§£æ€§ä½œä¸ºè®¾è®¡çš„ç›®æ ‡æ”¹å˜äº†æˆ‘ä»¬è®¾è®¡ Raft çš„æ–¹å¼ï¼›éšç€è®¾è®¡çš„è¿›å±•ï¼Œæˆ‘ä»¬å‘ç°è‡ªå·±é‡å¤ä½¿ç”¨äº†ä¸€äº›æŠ€æœ¯ï¼Œæ¯”å¦‚åˆ†è§£é—®é¢˜å’Œç®€åŒ–çŠ¶æ€ç©ºé—´ã€‚è¿™äº›æŠ€æœ¯ä¸ä»…æå‡äº† Raft çš„å¯ç†è§£æ€§ï¼ŒåŒæ—¶ä¹Ÿä½¿æˆ‘ä»¬åšä¿¡å…¶æ­£ç¡®æ€§ã€‚\n\n## 12 æ„Ÿè°¢\n\nè¿™é¡¹ç ”ç©¶å¿…é¡»æ„Ÿè°¢ä»¥ä¸‹äººå‘˜çš„æ”¯æŒï¼šAli Ghodsiï¼ŒDavid Mazie\\`resï¼Œå’Œä¼¯å…‹åˆ© CS 294-91 è¯¾ç¨‹ã€æ–¯å¦ç¦ CS 240 è¯¾ç¨‹çš„å­¦ç”Ÿã€‚Scott Klemmer å¸®æˆ‘ä»¬è®¾è®¡äº†ç”¨æˆ·è°ƒæŸ¥ï¼ŒNelson Ray å»ºè®®æˆ‘ä»¬è¿›è¡Œç»Ÿè®¡å­¦çš„åˆ†æã€‚åœ¨ç”¨æˆ·è°ƒæŸ¥æ—¶ä½¿ç”¨çš„å…³äº Paxos çš„å¹»ç¯ç‰‡å¾ˆå¤§ä¸€éƒ¨åˆ†æ˜¯ä» Lorenzo Alvisi çš„å¹»ç¯ç‰‡ä¸Šå€Ÿé‰´è¿‡æ¥çš„ã€‚ç‰¹åˆ«çš„ï¼Œéå¸¸æ„Ÿè°¢ DavidMazieres å’Œ Ezra Hochï¼Œä»–ä»¬æ‰¾åˆ°äº† Raft ä¸­ä¸€äº›éš¾ä»¥å‘ç°çš„æ¼æ´ã€‚è®¸å¤šäººæä¾›äº†å…³äºè¿™ç¯‡è®ºæ–‡ååˆ†æœ‰ç”¨çš„åé¦ˆå’Œç”¨æˆ·è°ƒæŸ¥ææ–™ï¼ŒåŒ…æ‹¬ Ed Bugnionï¼ŒMichael Chanï¼ŒHugues Evrardï¼ŒDaniel Giffinï¼ŒArjun Gopalanï¼ŒJon Howellï¼ŒVimalkumar Jeyakumarï¼ŒAnkita Kejriwalï¼ŒAleksandar Kracunï¼ŒAmit Levyï¼ŒJoel Martinï¼ŒSatoshi Matsushitaï¼ŒOleg Pesokï¼ŒDavid Ramosï¼ŒRobbert van Renesseï¼ŒMendel Rosenblumï¼ŒNicolas Schiperï¼ŒDeian Stefanï¼ŒAndrew Stoneï¼ŒRyan Stutsmanï¼ŒDavid Tereiï¼ŒStephen Yangï¼ŒMatei Zaharia ä»¥åŠ 24 ä½åŒ¿åçš„ä¼šè®®å®¡æŸ¥äººå‘˜ï¼ˆå¯èƒ½æœ‰é‡å¤ï¼‰ï¼Œå¹¶ä¸”ç‰¹åˆ«æ„Ÿè°¢æˆ‘ä»¬çš„é¢†å¯¼äºº Eddie Kohlerã€‚Werner Vogels å‘äº†ä¸€æ¡æ—©æœŸè‰ç¨¿é“¾æ¥çš„æ¨ç‰¹ï¼Œç»™ Raft å¸¦æ¥äº†æå¤§çš„å…³æ³¨ã€‚æˆ‘ä»¬çš„å·¥ä½œç”± Gigascale ç³»ç»Ÿç ”ç©¶ä¸­å¿ƒå’Œ Multiscale ç³»ç»Ÿç ”ç©¶ä¸­å¿ƒç»™äºˆæ”¯æŒï¼Œè¿™ä¸¤ä¸ªç ”ç©¶ä¸­å¿ƒç”±å…³æ³¨ä¸­å¿ƒç ”ç©¶ç¨‹åºèµ„é‡‘æ”¯æŒï¼Œä¸€ä¸ªæ˜¯åŠå¯¼ä½“ç ”ç©¶å…¬å¸çš„ç¨‹åºï¼Œç”± STARnet æ”¯æŒï¼Œä¸€ä¸ªåŠå¯¼ä½“ç ”ç©¶å…¬å¸çš„ç¨‹åºç”± MARCO å’Œ DARPA æ”¯æŒï¼Œåœ¨å›½å®¶ç§‘å­¦åŸºé‡‘ä¼šçš„ 0963859 å·æ‰¹å‡†ï¼Œå¹¶ä¸”è·å¾—äº†æ¥è‡ª Facebookï¼ŒGoogleï¼ŒMellanoxï¼ŒNECï¼ŒNetAppï¼ŒSAP å’Œ Samsung çš„æ”¯æŒã€‚Diego Ongaro ç”± Junglee å…¬å¸ï¼Œæ–¯å¦ç¦çš„æ¯•ä¸šå›¢ä½“æ”¯æŒã€‚\n\n## å‚è€ƒ\n\nç•¥\n\n## github é¡¹ç›®\n\nRaftä¸€è‡´æ€§ç®—æ³•è®ºæ–‡çš„ä¸­æ–‡ç¿»è¯‘\n\n<a href=\"https://ramcloud.atlassian.net/wiki/download/attachments/6586375/raft.pdf\">è‹±æ–‡è®ºæ–‡åœ°å€</a>\n\n<a href=\"https://github.com/maemual/raft-zh_cn/blob/master/raft-zh_cn.md\">ä¸­æ–‡ç¿»è¯‘åœ°å€</a>\n","tags":["Git","è®ºæ–‡å­¦ä¹ "]},{"title":"Jmeter Address already in use connect è§£å†³æ–¹æ¡ˆ","url":"/2023/05/08/2023-05-08-Jmeteré—®é¢˜ï¼ˆä¸€ï¼‰/","content":"\n## å‘ç”Ÿç¼˜æ•…\n\nwin10 ä¸‹ï¼Œjmeter é«˜å¹¶å‘å‹æµ‹ scope\n\n## æŠ¥é”™ä¿¡æ¯\n\n![error_information2](/img/2023-05-08-Jmeteré—®é¢˜ï¼ˆä¸€ï¼‰/pho2.png)\n\n## åŸå› \n\nJmeter é‡Œçš„ http sample å‹¾é€‰äº† keep aliveï¼Œå¯¼è‡´ä¼šè¯ä¸€ç›´ä¿æŒï¼Œè€Œ windows æœ¬èº«çš„ç«¯å£æœ‰é™ï¼Œå¯¼è‡´ç«¯å£è¢«å ç”¨å®Œåï¼Œæ— æ³•åˆ†é…æ–°çš„ç«¯å£ï¼Œå› æ­¤ä¼šäº§ç”Ÿ java.net.BindException: Address already in use: connect æŠ¥é”™ã€‚\n\n## è§£å†³æ–¹æ¡ˆ\n\nHTTP SAMPLE ä¸å‹¾é€‰ keep alive\n\n![solve_plan](/img/2023-05-08-Jmeteré—®é¢˜ï¼ˆä¸€ï¼‰/pho3.png)\n","tags":["jmeter"]},{"title":"Git add é—®é¢˜","url":"/2023/05/08/2023-05-08-git addé—®é¢˜/","content":"\n## é—®é¢˜ä¸€ï¼šä¸­æ–‡è·¯å¾„ä¸‹ï¼Œgit status åªæ˜¾ç¤ºæ•°å­—ä¸²\n\n### é—®é¢˜ç°è±¡\n\n![ä¸­æ–‡è·¯å¾„ä¹±ç ](/img/2023-05-08-git_addé—®é¢˜/git_add1.png)\n\n### åŸå›  \n\nåœ¨é»˜è®¤è®¾ç½®ä¸‹ï¼Œä¸­æ–‡æ–‡ä»¶ååœ¨å·¥ä½œåŒºçŠ¶æ€è¾“å‡ºï¼Œä¸­æ–‡åä¸èƒ½æ­£ç¡®æ˜¾ç¤ºï¼Œè€Œæ˜¯æ˜¾ç¤ºä¸ºå…«è¿›åˆ¶çš„å­—ç¬¦ç¼–ç ã€‚\n\n### è§£å†³æ–¹æ¡ˆ\n\n<ul>\n  <li>åœ¨ git bash çš„ç•Œé¢ä¸­å³å‡»ç©ºç™½å¤„ï¼Œå¼¹å‡ºèœå•ï¼Œé€‰æ‹© Options->Text->Locale æ”¹ä¸º zh_CNï¼ŒCharacter set æ”¹ä¸º UTF-8</li>\n  <li>git bash ç»ˆç«¯è¾“å…¥å‘½ä»¤ï¼šgit config --global core.quotepath false</li>\n</ul>\n\n![è§£å†³æ–¹æ¡ˆ](/img/2023-05-08-git_addé—®é¢˜/git_add2.gif)\n\n![é¢„æœŸç»“æœ](/img/2023-05-08-git_addé—®é¢˜/git_add3.png)\n\n## é—®é¢˜äºŒï¼š æ–‡ä»¶åå¸¦ç©ºæ ¼æ— æ³• add\n\n### é—®é¢˜ç°è±¡\n\n![addå¤±è´¥](/img/2023-05-08-git_addé—®é¢˜/git_add4.png)\n\n### è§£å†³æ–¹æ¡ˆ\n\næ–‡ä»¶åä¸¤ç«¯åŠ ä¸ŠåŒå¼•å·å³å¯, æ¯”å¦‚ â€‹â€‹git add \"demo copy\"â€‹â€‹\n\n","tags":["Git"]},{"title":"ES6.7 ä¸€äº›æœ‰è¶£çš„è¯­å¥","url":"/2023/04/17/2023-04-17-ESæœ‰è¶£çš„è¯­å¥/","content":"\n## 1ã€åˆ¤æ–­ date ç±»å‹æ˜¯ä¸æ˜¯ null å€¼ï¼Œä¸æ˜¯ null å€¼çš„åŠ  1 å¤©/æœˆå¹´\n\n```json\ncurl -XGET \"vqa132:19200/script_common/_search?&size=0&pretty\" -H 'Content-Type: application/json' -d'\n{\n  \"aggs\": {\n    \"agg_name\": {\n      \"date_histogram\": {\n        \"script\": {\n          \"lang\": \"painless\",\n          \"source\": \"if (doc[\\u0027class\\u0027].size()==0){return params.date}else {return doc[\\u0027birthday\\u0027].value.plusDays(1)}\",\n          \"params\": {\n            \"date\" : 2208960000000\n          }\n        },\n        \"interval\": \"year\",\n        \"min_doc_count\": 1\n      }\n    }\n  }\n}\n';\n```","tags":["Elasticsearch","é‚£äº›å¹´é‡åˆ°çš„å‘"],"categories":["Elasticsearch"]},{"title":"Compressor detection","url":"/2023/04/14/2023-04-14-ESé—®é¢˜ï¼ˆä¸€ï¼‰/","content":"\næŠ¥é”™ä¿¡æ¯ï¼š\nCompressor detection can only be called on some xcontent bytes or compressed xcontent bytes\n\n## å‘ç”Ÿç¼˜æ•…\n\njmeter å‹æµ‹ï¼Œå†™å…¥ elasticsearch æŠ¥é”™\n\n## è¿è¡Œç¯å¢ƒ\n\n<ul>\n    <li>elasticsearch 6.7.2</li>\n    <li>jmeter 5.5</li>\n    <li>jdbc 1.8</li>\n</ul>\n\n## æŠ¥é”™ä¿¡æ¯\n\n![error_information](/img/2023-04-14-ESé—®é¢˜ï¼ˆä¸€ï¼‰/error_information.png)\n\n## åˆ†ææ’æŸ¥\n\n<ul>\n    <li>Compressor detection can only be called on some xcontent bytes or compressed xcontent bytes</li>\n    <li>å‹ç¼©å™¨æ£€æµ‹åªèƒ½åœ¨æŸäº› xcontent å­—èŠ‚æˆ–å‹ç¼©çš„ xcontent å­—èŠ‚ä¸Šé¢è°ƒç”¨</li>\n</ul>\n\næ ¹æ®æŠ¥é”™åŸå› å¯ä»¥å°†é”™è¯¯å®šä½è‡³ io.xwt.BulkDoument.runTest(BulkDoument.java 87)ï¼Œä»£ç å¦‚ä¸‹ï¼š\n\n```json\n// è§£æ json\nfor(int i = 0; i < datas.length; ++i) {\n    datas[i] = datas[i].replace(\"{DATET}\", datasdf.format(System.currentTimeMillis()));\n    if (this.threadNum != 0) {\n        String id = \"t\" + this.threadNum + \"_\" + System.currentTimeMillis() + \"_\" + UUID.randomUUID();\n        br.add((new IndexRequest(this.indexName, default_type, id)).source(datas[i], XContentType.JSON));\n    } else {\nbr.add((new IndexRequest()).source(datas[i], XContentType.JSON));\n    }\n}\ntry {\n// ç”Ÿæˆ bulk è¿æ¥\n    sampleResult.sampleStart();\n    BulkResponse bulkResponse = this.client.bulk(br, RequestOptions.DEFAULT);\n    sampleResult.sampleEnd();\n    sampleResult.setSuccessful(true);\n    sampleResult.setResponseCodeOK();\n    if (bulkResponse.hasFailures()) {\n        sampleResult.setSuccessful(false);\n        sampleResult.setResponseCode(\"500\");\n        sampleResult.setResponseData(bulkResponse.buildFailureMessage(), \"utf-8\");\n    } else {\n        sampleResult.setResponseData(\"all in\", \"utf-8\");\n    }\n// æŠ¥é”™\n} catch (Exception var8) {\n    sampleResult.sampleEnd();\n    sampleResult.setSuccessful(false);\n    sampleResult.setResponseCode(\"500\");\n    sampleResult.setResponseMessage(var8.getMessage());\n    var8.printStackTrace();\n}\n```\n\né‚£ä¹ˆå°±å¯ä»¥å°†æŠ¥é”™ä¿¡æ¯è½¬ä¸ºäººè¯äº†ï¼šè¯­å¥çš„ç±»å‹ä¸æ˜¯JSONé£æ ¼çš„æˆ–è€…JSONæ ¼å¼åŒ–é”™è¯¯äº†ã€‚\n\nå®šä½å†™å…¥æ•°æ®ï¼Œæ•°æ®å¦‚ä¸‹ï¼š\n![eventdate](/img/2023-04-14-ESé—®é¢˜ï¼ˆä¸€ï¼‰/eventdate.png)\n\n@timestamp ä¸º dateç±»å‹ï¼Œè¿™é‡Œç”¨äº† stringï¼Œä¿®æ”¹è¿™ä¸ªå€¼/jmxä¸Šæ›¿æ¢ã€‚\n\næ³¨ï¼š\n<ul>\n    <li>æœ‰æ—¶ç½‘ç»œå·®ï¼Œä¹Ÿå¯èƒ½ä¼šå‡ºç°è¿™ä¸ªæŠ¥é”™</li>\n</ul>","tags":["Elasticsearch","é‚£äº›å¹´é‡åˆ°çš„å‘","jmter"]},{"title":"jmeter å¸¸ç”¨å‡½æ•°","url":"/2023/04/05/2023-04-05-jmeter å¸¸ç”¨å‡½æ•°/","content":"\n## è·å–ä½¿ç”¨æ—¶é—´æˆ³\n\n```bash\né»˜è®¤æ—¶é—´æˆ³ï¼š\n${__time(,)}ï¼šç²¾ç¡®åˆ°æ¯«ç§’çº§åˆ«ï¼Œ13ä½\n${__time(/1000,)}ï¼šç²¾ç¡®åˆ°ç§’çº§åˆ«ï¼Œ10ä½\n\nè®¾ç½®æ—¶é—´æ ¼å¼ï¼š\n${__time(yyyy-MM-dd,)}\n${__time(YMDHMS,)}\n```\n\n## è·å–çº¿ç¨‹ç›¸å…³\n\n```bash\n${__BeanShell(ctx.getThread().getThreadName())}ï¼šè·å–çº¿ç¨‹åç§°\n${__BeanShell(ctx.getThread().getThreadNum())}ï¼šè·å–çº¿ç¨‹å·\n```\n\n## è·å–å±æ€§å€¼\n\n```bash\n${__P(access_token,)}ï¼šä»å±æ€§ä¸­å–å‡ºå˜é‡å€¼\n```\n\n## å¤šèŠ‚ç‚¹ htpp è¯·æ±‚\n\n```bash\n${__RandomFromMultipleVars(adapterHost-single|adapterHost-single2|adapterHost-single3,schost)}\n```","tags":["jmeter"]},{"title":"ä¸ºä»€ä¹ˆæˆ‘ä»¬éœ€è¦ Pod","url":"/2023/02/24/2023-02-24-ä¸ºä»€ä¹ˆæˆ‘ä»¬éœ€è¦Pod/","content":"\n## å‰è¨€\n\nPodï¼Œæ˜¯ K8s é¡¹ç›®ä¸­æœ€å°çš„ API å¯¹è±¡ï¼Œæ¢å¥æ›´ä¸“ä¸šçš„è¯ï¼ŒPodï¼Œæ˜¯ K8s é¡¹ç›®çš„åŸå­è°ƒåº¦å•ä½ã€‚\n\nä¸ºäº†æ›´å¥½çš„ç†è§£ï¼Œæˆ‘ä»¬ä¸ºä»€ä¹ˆéœ€è¦ podï¼Œè¿™é‡ŒæŠ›å‡ºä¸€ä¸ªåœºæ™¯ï¼š\n\nå·²çŸ¥ rsyslogd ç”±ä¸‰ä¸ªè¿›ç¨‹ç»„æˆï¼šä¸€ä¸ª imklog æ¨¡å—ï¼Œä¸€ä¸ª imuxsock æ¨¡å—ï¼Œä¸€ä¸ª rsyslogd è‡ªå·±çš„ main å‡½æ•°ä¸»è¿›ç¨‹ã€‚**è¿™ä¸‰ä¸ªè¿›ç¨‹ä¸€å®šè¦è¿è¡Œåœ¨åŒä¸€å°æœºå™¨ä¸Šï¼Œå¦åˆ™ï¼Œå®ƒä»¬ä¹‹é—´åŸºäº Socket çš„é€šä¿¡å’Œæ–‡ä»¶äº¤æ¢ï¼Œéƒ½ä¼šå‡ºç°é—®é¢˜ã€‚**\n\n>æ³¨æ„ï¼šå®¹å™¨çš„â€œå•è¿›ç¨‹æ¨¡å‹â€ï¼Œå¹¶ä¸æ˜¯æŒ‡å®¹å™¨é‡Œåªèƒ½è¿è¡Œâ€œä¸€ä¸ªâ€è¿›ç¨‹ï¼Œè€Œæ˜¯æŒ‡å®¹å™¨æ²¡æœ‰ç®¡ç†å¤šä¸ªè¿›ç¨‹çš„èƒ½åŠ›ã€‚è¿™æ˜¯å› ä¸ºå®¹å™¨é‡Œ PID=1 çš„è¿›ç¨‹å°±æ˜¯åº”ç”¨æœ¬èº«ï¼Œå…¶ä»–çš„è¿›ç¨‹éƒ½æ˜¯è¿™ä¸ª PID=1 è¿›ç¨‹çš„å­è¿›ç¨‹ã€‚å¯æ˜¯ï¼Œç”¨æˆ·ç¼–å†™çš„åº”ç”¨ï¼Œå¹¶ä¸èƒ½å¤Ÿåƒæ­£å¸¸æ“ä½œç³»ç»Ÿé‡Œçš„ init è¿›ç¨‹æˆ–è€… systemd é‚£æ ·æ‹¥æœ‰è¿›ç¨‹ç®¡ç†çš„åŠŸèƒ½ã€‚æ¯”å¦‚ï¼Œä½ çš„åº”ç”¨æ˜¯ä¸€ä¸ª Java Web ç¨‹åºï¼ˆPID=1ï¼‰ï¼Œç„¶åä½ æ‰§è¡Œ docker exec åœ¨åå°å¯åŠ¨äº†ä¸€ä¸ª Nginx è¿›ç¨‹ï¼ˆPID=3ï¼‰ã€‚å¯æ˜¯ï¼Œå½“è¿™ä¸ª Nginx è¿›ç¨‹å¼‚å¸¸é€€å‡ºçš„æ—¶å€™ï¼Œä½ è¯¥æ€ä¹ˆçŸ¥é“å‘¢ï¼Ÿè¿™ä¸ªè¿›ç¨‹é€€å‡ºåçš„åƒåœ¾æ”¶é›†å·¥ä½œï¼Œåˆåº”è¯¥ç”±è°å»åšå‘¢ï¼Ÿ\n\nå‡è®¾æˆ‘ä»¬çš„ K8s é›†ç¾¤ä¸Šæœ‰ä¸¤ä¸ªèŠ‚ç‚¹ï¼šnode-1 ä¸Šæœ‰ 3 GB å¯ç”¨å†…å­˜ï¼Œnode-2 æœ‰ 2.5 GB å¯ç”¨å†…å­˜ã€‚\n\nè¿™æ—¶ï¼Œå‡è®¾æˆ‘è¦ç”¨ Docker Swarm æ¥è¿è¡Œè¿™ä¸ª rsyslogd ç¨‹åºã€‚ä¸ºäº†èƒ½å¤Ÿè®©è¿™ä¸‰ä¸ªå®¹å™¨éƒ½è¿è¡Œåœ¨åŒä¸€å°æœºå™¨ä¸Šï¼Œæˆ‘å°±å¿…é¡»åœ¨å¦å¤–ä¸¤ä¸ªå®¹å™¨ä¸Šè®¾ç½®ä¸€ä¸ª affinity=mainï¼ˆä¸ main å®¹å™¨æœ‰äº²å¯†æ€§ï¼‰çš„çº¦æŸï¼Œå³ï¼šå®ƒä»¬ä¿©å¿…é¡»å’Œ main å®¹å™¨è¿è¡Œåœ¨åŒä¸€å°æœºå™¨ä¸Šã€‚\n\nç„¶åï¼Œæˆ‘é¡ºåºæ‰§è¡Œï¼š\"docker run main\"ã€\"docker run imklog\" å’Œ \"docker run imuxsock\"ï¼Œåˆ›å»ºè¿™ä¸‰ä¸ªå®¹å™¨ã€‚\n\nè¿™æ ·ï¼Œè¿™ä¸‰ä¸ªå®¹å™¨éƒ½ä¼šè¿›å…¥ Swarm çš„å¾…è°ƒåº¦é˜Ÿåˆ—ã€‚ç„¶åï¼Œmain å®¹å™¨å’Œ imklog å®¹å™¨éƒ½å…ˆåå‡ºé˜Ÿå¹¶è¢«è°ƒåº¦åˆ°äº† node-2 ä¸Šï¼ˆè¿™ä¸ªæƒ…å†µæ˜¯å®Œå…¨æœ‰å¯èƒ½çš„ï¼‰ã€‚\n\nå¯æ˜¯ï¼Œå½“ imuxsock å®¹å™¨å‡ºé˜Ÿå¼€å§‹è¢«è°ƒåº¦æ—¶ï¼ŒSwarm å°±æœ‰ç‚¹æ‡µäº†ï¼šnode-2 ä¸Šçš„å¯ç”¨èµ„æºåªæœ‰ 0.5 GB äº†ï¼Œå¹¶ä¸è¶³ä»¥è¿è¡Œ imuxsock å®¹å™¨ï¼›å¯æ˜¯ï¼Œæ ¹æ® affinity=main çš„çº¦æŸï¼Œimuxsock å®¹å™¨åˆåªèƒ½è¿è¡Œåœ¨ node-2 ä¸Šã€‚\n\n**è¿™å°±æ˜¯ä¸€ä¸ªå…¸å‹çš„æˆç»„è°ƒåº¦ï¼ˆgang schedulingï¼‰æ²¡æœ‰è¢«å¦¥å–„å¤„ç†çš„ä¾‹å­ã€‚**\n\n## Pod çš„ä½œç”¨\n\nå¯¹äºä¸Šè¾¹çš„åœºæ™¯ï¼Œåœ¨å·¥ä¸šç•Œå’Œå­¦æœ¯ç•Œè®¨è®ºå¯è°“æ—·æ—¥æŒä¹…ï¼Œä¹Ÿäº§ç”Ÿäº†å¾ˆå¤šå¯ä¾›é€‰æ‹©çš„è§£å†³æ–¹æ¡ˆã€‚\n\næ¯”å¦‚ï¼ŒMesos ä¸­å°±æœ‰ä¸€ä¸ªèµ„æºå›¤ç§¯ï¼ˆresource hoardingï¼‰çš„æœºåˆ¶ï¼Œä¼šåœ¨æ‰€æœ‰è®¾ç½®äº† Affinity çº¦æŸçš„ä»»åŠ¡éƒ½è¾¾åˆ°æ—¶ï¼Œæ‰å¼€å§‹å¯¹å®ƒä»¬ç»Ÿä¸€è¿›è¡Œè°ƒåº¦ã€‚è€Œåœ¨ Google Omega è®ºæ–‡ä¸­ï¼Œåˆ™æå‡ºäº†ä½¿ç”¨ä¹è§‚è°ƒåº¦å¤„ç†å†²çªçš„æ–¹æ³•ï¼Œå³ï¼šå…ˆä¸ç®¡è¿™äº›å†²çªï¼Œè€Œæ˜¯é€šè¿‡ç²¾å¿ƒè®¾è®¡çš„å›æ»šæœºåˆ¶åœ¨å‡ºç°äº†å†²çªä¹‹åè§£å†³é—®é¢˜ã€‚\n\nå¯æ˜¯è¿™äº›æ–¹æ³•éƒ½è°ˆä¸ä¸Šå®Œç¾ã€‚èµ„æºå›¤ç§¯å¸¦æ¥äº†ä¸å¯é¿å…çš„è°ƒåº¦æ•ˆç‡æŸå¤±å’Œæ­»é”çš„å¯èƒ½æ€§ï¼›è€Œä¹è§‚è°ƒåº¦çš„å¤æ‚ç¨‹åº¦ï¼Œåˆ™ä¸æ˜¯å¸¸è§„æŠ€æœ¯å›¢é˜Ÿæ‰€èƒ½é©¾é©­çš„ã€‚\n\nä½†æ˜¯ï¼Œåˆ°äº† K8s é¡¹ç›®é‡Œï¼Œè¿™æ ·çš„é—®é¢˜å°±è¿åˆƒè€Œè§£äº†ï¼šPod æ˜¯ K8s é‡Œçš„åŸå­è°ƒåº¦å•ä½ã€‚è¿™å°±æ„å‘³ç€ï¼ŒK8s é¡¹ç›®çš„è°ƒåº¦å™¨ï¼Œæ˜¯ç»Ÿä¸€æŒ‰ç…§ Pod è€Œéå®¹å™¨çš„èµ„æºéœ€æ±‚è¿›è¡Œè®¡ç®—çš„ã€‚\n\næ‰€ä»¥ï¼Œåƒ imklogã€imuxsock å’Œ main å‡½æ•°ä¸»è¿›ç¨‹è¿™æ ·çš„ä¸‰ä¸ªå®¹å™¨ï¼Œæ­£æ˜¯ä¸€ä¸ªå…¸å‹çš„ç”±ä¸‰ä¸ªå®¹å™¨ç»„æˆçš„ Podã€‚K8s é¡¹ç›®åœ¨è°ƒåº¦æ—¶ï¼Œè‡ªç„¶å°±ä¼šå»é€‰æ‹©å¯ç”¨å†…å­˜ç­‰äº 3 GB çš„ node-1 èŠ‚ç‚¹è¿›è¡Œç»‘å®šï¼Œè€Œæ ¹æœ¬ä¸ä¼šè€ƒè™‘ node-2ã€‚\n\nåƒè¿™æ ·å®¹å™¨é—´çš„ç´§å¯†åä½œï¼Œæˆ‘ä»¬å¯ä»¥ç§°ä¸ºâ€œè¶…äº²å¯†å…³ç³»â€ã€‚è¿™äº›å…·æœ‰â€œè¶…äº²å¯†å…³ç³»â€å®¹å™¨çš„å…¸å‹ç‰¹å¾åŒ…æ‹¬ä½†ä¸é™äºï¼šäº’ç›¸ä¹‹é—´ä¼šå‘ç”Ÿç›´æ¥çš„æ–‡ä»¶äº¤æ¢ã€ä½¿ç”¨ localhost æˆ–è€… Socket æ–‡ä»¶è¿›è¡Œæœ¬åœ°é€šä¿¡ã€ä¼šå‘ç”Ÿéå¸¸é¢‘ç¹çš„è¿œç¨‹è°ƒç”¨ã€éœ€è¦å…±äº«æŸäº› Linux Namespaceï¼ˆæ¯”å¦‚ï¼Œä¸€ä¸ªå®¹å™¨è¦åŠ å…¥å¦ä¸€ä¸ªå®¹å™¨çš„ Network Namespaceï¼‰ç­‰ç­‰ã€‚\n\nè¿™ä¹Ÿå°±æ„å‘³ç€ï¼Œå¹¶ä¸æ˜¯æ‰€æœ‰æœ‰â€œå…³ç³»â€çš„å®¹å™¨éƒ½å±äºåŒä¸€ä¸ª Podã€‚æ¯”å¦‚ï¼ŒPHP åº”ç”¨å®¹å™¨å’Œ MySQL è™½ç„¶ä¼šå‘ç”Ÿè®¿é—®å…³ç³»ï¼Œä½†å¹¶æ²¡æœ‰å¿…è¦ã€ä¹Ÿä¸åº”è¯¥éƒ¨ç½²åœ¨åŒä¸€å°æœºå™¨ä¸Šï¼Œå®ƒä»¬æ›´é€‚åˆåšæˆä¸¤ä¸ª Podã€‚\n\n## Pod å®¹å™¨è®¾è®¡æ¨¡å¼\n\nå¯¹äºåˆå­¦è€…æ¥è¯´ï¼Œä¸€èˆ¬éƒ½æ˜¯å…ˆå­¦ä¼šäº†ç”¨ Docker è¿™ç§å•å®¹å™¨çš„å·¥å…·ï¼Œæ‰ä¼šå¼€å§‹æ¥è§¦ Podã€‚\n\nè€Œå¦‚æœ Pod çš„è®¾è®¡åªæ˜¯å‡ºäºè°ƒåº¦ä¸Šçš„è€ƒè™‘ï¼Œé‚£ä¹ˆ K8s é¡¹ç›®ä¼¼ä¹å®Œå…¨æ²¡æœ‰å¿…è¦éå¾—æŠŠ Pod ä½œä¸ºâ€œä¸€ç­‰å…¬æ°‘â€å§ï¼Ÿè¿™ä¸æ˜¯æ•…æ„å¢åŠ ç”¨æˆ·çš„å­¦ä¹ é—¨æ§›å—ï¼Ÿ\n\næ²¡é”™ï¼Œå¦‚æœåªæ˜¯å¤„ç†â€œè¶…äº²å¯†å…³ç³»â€è¿™æ ·çš„è°ƒåº¦é—®é¢˜ï¼Œæœ‰ Borg å’Œ Omega è®ºæ–‡ç ç‰åœ¨å‰ï¼ŒK8s é¡¹ç›®è‚¯å®šå¯ä»¥åœ¨è°ƒåº¦å™¨å±‚é¢ç»™å®ƒè§£å†³æ‰ã€‚\n\nä¸è¿‡ï¼ŒPod åœ¨ K8s é¡¹ç›®é‡Œè¿˜æœ‰æ›´é‡è¦çš„æ„ä¹‰ï¼Œé‚£å°±æ˜¯ï¼š**å®¹å™¨è®¾è®¡æ¨¡å¼**ã€‚\n\n### Pod å®ç°åŸç†\n\n**é¦–å…ˆï¼Œå…³äº Pod æœ€é‡è¦çš„ä¸€ä¸ªäº‹å®æ˜¯ï¼šå®ƒåªæ˜¯ä¸€ä¸ªé€»è¾‘æ¦‚å¿µã€‚**\n\nä¹Ÿå°±æ˜¯è¯´ï¼ŒK8s çœŸæ­£å¤„ç†çš„ï¼Œè¿˜æ˜¯å®¿ä¸»æœºæ“ä½œç³»ç»Ÿä¸Š Linux å®¹å™¨çš„ Namespace å’Œ Cgroupsï¼Œè€Œå¹¶ä¸å­˜åœ¨ä¸€ä¸ªæ‰€è°“çš„ Pod çš„è¾¹ç•Œæˆ–è€…éš”ç¦»ç¯å¢ƒã€‚\n\né‚£ä¹ˆï¼ŒPod åˆæ˜¯æ€ä¹ˆè¢«â€œåˆ›å»ºâ€å‡ºæ¥çš„å‘¢ï¼Ÿ\n\nç­”æ¡ˆæ˜¯ï¼šPodï¼Œå…¶å®æ˜¯ä¸€ç»„å…±äº«äº†æŸäº›èµ„æºçš„å®¹å™¨ã€‚\n\nå…·ä½“çš„è¯´ï¼š**Pod é‡Œçš„æ‰€æœ‰å®¹å™¨ï¼Œå…±äº«çš„æ˜¯åŒä¸€ä¸ª Network Namespaceï¼Œå¹¶ä¸”å¯ä»¥å£°æ˜å…±äº«åŒä¸€ä¸ª Volumeï¼ˆç£ç›˜ç›®å½•ï¼‰**ã€‚\n\né‚£è¿™ä¹ˆæ¥çœ‹çš„è¯ï¼Œä¸€ä¸ªæœ‰ Aã€B ä¸¤ä¸ªå®¹å™¨çš„ Podï¼Œä¸å°±æ˜¯ç­‰åŒäºä¸€ä¸ªå®¹å™¨ï¼ˆå®¹å™¨ Aï¼‰å…±äº«å¦å¤–ä¸€ä¸ªå®¹å™¨ï¼ˆå®¹å™¨ Bï¼‰çš„ç½‘ç»œå’Œ Volume çš„ç©å„¿æ³•ä¹ˆï¼Ÿ\n\nè¿™å¥½åƒé€šè¿‡ docker run --net --volumes-from è¿™æ ·çš„å‘½ä»¤å°±èƒ½å®ç°å˜›ï¼Œæ¯”å¦‚ï¼š\n\n```bash\n$ docker run --net=B --volumes-from=B --name=A image-A ...\n```\n\nä½†æ˜¯ï¼Œè¿™æ ·åšå­˜åœ¨ä¸€ä¸ªé—®é¢˜ï¼Œé‚£å°±æ˜¯å®¹å™¨ B å°±å¿…é¡»æ¯”å®¹å™¨ A å…ˆå¯åŠ¨ï¼Œè¿™æ ·ä¸€ä¸ª Pod é‡Œçš„å¤šä¸ªå®¹å™¨å°±ä¸æ˜¯å¯¹ç­‰å…³ç³»ï¼Œè€Œæ˜¯æ‹“æ‰‘å…³ç³»äº†ã€‚\n\næ‰€ä»¥ï¼Œåœ¨ Kubernetes é¡¹ç›®é‡Œï¼ŒPod çš„å®ç°éœ€è¦ä½¿ç”¨ä¸€ä¸ªä¸­é—´å®¹å™¨ï¼Œè¿™ä¸ªå®¹å™¨å«ä½œ Infra å®¹å™¨ã€‚åœ¨è¿™ä¸ª Pod ä¸­ï¼ŒInfra å®¹å™¨æ°¸è¿œéƒ½æ˜¯ç¬¬ä¸€ä¸ªè¢«åˆ›å»ºçš„å®¹å™¨ï¼Œè€Œå…¶ä»–ç”¨æˆ·å®šä¹‰çš„å®¹å™¨ï¼Œåˆ™é€šè¿‡ Join Network Namespace çš„æ–¹å¼ï¼Œä¸ Infra å®¹å™¨å…³è”åœ¨ä¸€èµ·ã€‚è¿™æ ·çš„ç»„ç»‡å…³ç³»ï¼Œå¯ä»¥ç”¨ä¸‹é¢è¿™æ ·ä¸€ä¸ªç¤ºæ„å›¾æ¥è¡¨è¾¾ï¼š\n\n![Podç»“æ„å›¾](/img/2023-02-24-ä¸ºä»€ä¹ˆæˆ‘ä»¬éœ€è¦Pod/podæ¡†æ¶.png)\n\nå¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œè¿™ä¸ª Pod é‡Œæœ‰ä¸¤ä¸ªç”¨æˆ·å®¹å™¨ A å’Œ Bï¼Œè¿˜æœ‰ä¸€ä¸ª Infra å®¹å™¨ã€‚å¾ˆå®¹æ˜“ç†è§£ï¼Œåœ¨ Kubernetes é¡¹ç›®é‡Œï¼ŒInfra å®¹å™¨ä¸€å®šè¦å ç”¨æå°‘çš„èµ„æºï¼Œæ‰€ä»¥å®ƒä½¿ç”¨çš„æ˜¯ä¸€ä¸ªéå¸¸ç‰¹æ®Šçš„é•œåƒï¼Œå«ä½œï¼šk8s.gcr.io/pauseã€‚è¿™ä¸ªé•œåƒæ˜¯ä¸€ä¸ªç”¨æ±‡ç¼–è¯­è¨€ç¼–å†™çš„ã€æ°¸è¿œå¤„äºâ€œæš‚åœâ€çŠ¶æ€çš„å®¹å™¨ï¼Œè§£å‹åçš„å¤§å°ä¹Ÿåªæœ‰ 100~200 KB å·¦å³ã€‚\n\nè€Œåœ¨ Infra å®¹å™¨ â€œHold ä½â€ Network Namespace åï¼Œç”¨æˆ·å®¹å™¨å°±å¯ä»¥åŠ å…¥åˆ° Infra å®¹å™¨çš„ Network Namespace å½“ä¸­äº†ã€‚æ‰€ä»¥ï¼Œå¦‚æœä½ æŸ¥çœ‹è¿™äº›å®¹å™¨åœ¨å®¿ä¸»æœºä¸Šçš„ Namespace æ–‡ä»¶ï¼ˆè¿™ä¸ª Namespace æ–‡ä»¶çš„è·¯å¾„ï¼Œæˆ‘å·²ç»åœ¨å‰é¢çš„å†…å®¹ä¸­ä»‹ç»è¿‡ï¼‰ï¼Œå®ƒä»¬æŒ‡å‘çš„å€¼ä¸€å®šæ˜¯å®Œå…¨ä¸€æ ·çš„ã€‚\n\nè¿™ä¹Ÿå°±æ„å‘³ç€ï¼Œå¯¹äº Pod é‡Œçš„å®¹å™¨ A å’Œå®¹å™¨ B æ¥è¯´ï¼š\n\nå®ƒä»¬å¯ä»¥ç›´æ¥ä½¿ç”¨ localhost è¿›è¡Œé€šä¿¡ï¼›\n\nå®ƒä»¬çœ‹åˆ°çš„ç½‘ç»œè®¾å¤‡è·Ÿ Infra å®¹å™¨çœ‹åˆ°çš„å®Œå…¨ä¸€æ ·ï¼›\n\nä¸€ä¸ª Pod åªæœ‰ä¸€ä¸ª IP åœ°å€ï¼Œä¹Ÿå°±æ˜¯è¿™ä¸ª Pod çš„ Network Namespace å¯¹åº”çš„ IP åœ°å€ï¼›å½“ç„¶ï¼Œå…¶ä»–çš„æ‰€æœ‰ç½‘ç»œèµ„æºï¼Œéƒ½æ˜¯ä¸€ä¸ª Pod ä¸€ä»½ï¼Œå¹¶ä¸”è¢«è¯¥ Pod ä¸­çš„æ‰€æœ‰å®¹å™¨å…±äº«ï¼›Pod çš„ç”Ÿå‘½å‘¨æœŸåªè·Ÿ Infra å®¹å™¨ä¸€è‡´ï¼Œè€Œä¸å®¹å™¨ A å’Œ B æ— å…³ã€‚\n\nè€Œå¯¹äºåŒä¸€ä¸ª Pod é‡Œé¢çš„æ‰€æœ‰ç”¨æˆ·å®¹å™¨æ¥è¯´ï¼Œå®ƒä»¬çš„è¿›å‡ºæµé‡ï¼Œä¹Ÿå¯ä»¥è®¤ä¸ºéƒ½æ˜¯é€šè¿‡ Infra å®¹å™¨å®Œæˆçš„ã€‚è¿™ä¸€ç‚¹å¾ˆé‡è¦ï¼Œå› ä¸º**å°†æ¥å¦‚æœä½ è¦ä¸º Kubernetes å¼€å‘ä¸€ä¸ªç½‘ç»œæ’ä»¶æ—¶ï¼Œåº”è¯¥é‡ç‚¹è€ƒè™‘çš„æ˜¯å¦‚ä½•é…ç½®è¿™ä¸ª Pod çš„ Network Namespaceï¼Œè€Œä¸æ˜¯æ¯ä¸€ä¸ªç”¨æˆ·å®¹å™¨å¦‚ä½•ä½¿ç”¨ä½ çš„ç½‘ç»œé…ç½®ï¼Œè¿™æ˜¯æ²¡æœ‰æ„ä¹‰çš„**ã€‚\n\nè¿™å°±æ„å‘³ç€ï¼Œå¦‚æœä½ çš„ç½‘ç»œæ’ä»¶éœ€è¦åœ¨å®¹å™¨é‡Œå®‰è£…æŸäº›åŒ…æˆ–è€…é…ç½®æ‰èƒ½å®Œæˆçš„è¯ï¼Œæ˜¯ä¸å¯å–çš„ï¼šInfra å®¹å™¨é•œåƒçš„ rootfs é‡Œå‡ ä¹ä»€ä¹ˆéƒ½æ²¡æœ‰ï¼Œæ²¡æœ‰ä½ éšæ„å‘æŒ¥çš„ç©ºé—´ã€‚å½“ç„¶ï¼Œè¿™åŒæ—¶ä¹Ÿæ„å‘³ç€ä½ çš„ç½‘ç»œæ’ä»¶å®Œå…¨ä¸å¿…å…³å¿ƒç”¨æˆ·å®¹å™¨çš„å¯åŠ¨ä¸å¦ï¼Œè€Œåªéœ€è¦å…³æ³¨å¦‚ä½•é…ç½® Podï¼Œä¹Ÿå°±æ˜¯ Infra å®¹å™¨çš„ Network Namespace å³å¯ã€‚\n\næœ‰äº†è¿™ä¸ªè®¾è®¡ä¹‹åï¼Œå…±äº« Volume å°±ç®€å•å¤šäº†ï¼šKubernetes é¡¹ç›®åªè¦æŠŠæ‰€æœ‰ Volume çš„å®šä¹‰éƒ½è®¾è®¡åœ¨ Pod å±‚çº§å³å¯ã€‚\n\nè¿™æ ·ï¼Œä¸€ä¸ª Volume å¯¹åº”çš„å®¿ä¸»æœºç›®å½•å¯¹äº Pod æ¥è¯´å°±åªæœ‰ä¸€ä¸ªï¼ŒPod é‡Œçš„å®¹å™¨åªè¦å£°æ˜æŒ‚è½½è¿™ä¸ª Volumeï¼Œå°±ä¸€å®šå¯ä»¥å…±äº«è¿™ä¸ª Volume å¯¹åº”çš„å®¿ä¸»æœºç›®å½•ã€‚æ¯”å¦‚ä¸‹é¢è¿™ä¸ªä¾‹å­ï¼š\n\n```yaml\napiVersion: v1\nkind: Pod\nmetadata:\n  name: two-containers\nspec:\n  restartPolicy: Never\n  volumes:\n  - name: shared-data\n    hostPath: \n      path: /data\n  containers:\n  - name: nginx-container\n    image: nginx\n    volumeMounts:\n    - name: shared-data\n      mountPath: /usr/share/nginx/html\n  - name: debian-container\n    image: debian\n    volumeMounts:\n    - name: shared-data\n      mountPath: /pod-data\n    command: [\"/bin/sh\"]\n    args: [\"-c\", \"echo Hello from the debian container > /pod-data/index.html\"]\n```\n\nåœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œdebian-container å’Œ nginx-container éƒ½å£°æ˜æŒ‚è½½äº† shared-data è¿™ä¸ª Volumeã€‚è€Œ shared-data æ˜¯ hostPath ç±»å‹ã€‚æ‰€ä»¥ï¼Œå®ƒå¯¹åº”åœ¨å®¿ä¸»æœºä¸Šçš„ç›®å½•å°±æ˜¯ï¼š/dataã€‚è€Œè¿™ä¸ªç›®å½•ï¼Œå…¶å®å°±è¢«åŒæ—¶ç»‘å®šæŒ‚è½½è¿›äº†ä¸Šè¿°ä¸¤ä¸ªå®¹å™¨å½“ä¸­ã€‚\n\nè¿™å°±æ˜¯ä¸ºä»€ä¹ˆï¼Œnginx-container å¯ä»¥ä»å®ƒçš„ /usr/share/nginx/html ç›®å½•ä¸­ï¼Œè¯»å–åˆ° debian-container ç”Ÿæˆçš„ index.html æ–‡ä»¶çš„åŸå› ã€‚\n\n### Pod è®¾è®¡æ¨¡å¼\n\nPod è¿™ç§â€œè¶…äº²å¯†å…³ç³»â€å®¹å™¨çš„è®¾è®¡æ€æƒ³ï¼Œå®é™…ä¸Šå°±æ˜¯å¸Œæœ›ï¼Œå½“ç”¨æˆ·æƒ³åœ¨ä¸€ä¸ªå®¹å™¨é‡Œè·‘å¤šä¸ªåŠŸèƒ½å¹¶ä¸ç›¸å…³çš„åº”ç”¨æ—¶ï¼Œåº”è¯¥ä¼˜å…ˆè€ƒè™‘å®ƒä»¬æ˜¯ä¸æ˜¯æ›´åº”è¯¥è¢«æè¿°æˆä¸€ä¸ª Pod é‡Œçš„å¤šä¸ªå®¹å™¨ã€‚\n\nä¸ºäº†èƒ½å¤ŸæŒæ¡è¿™ç§æ€è€ƒæ–¹å¼ï¼Œä½ å°±åº”è¯¥å°½é‡å°è¯•ä½¿ç”¨å®ƒæ¥æè¿°ä¸€äº›ç”¨å•ä¸ªå®¹å™¨éš¾ä»¥è§£å†³çš„é—®é¢˜ã€‚\n\n**ä¸€ä¸ªæœ€å…¸å‹çš„ä¾‹å­æ˜¯ï¼šWAR åŒ…ä¸ Web æœåŠ¡å™¨ã€‚**\n\næˆ‘ä»¬ç°åœ¨æœ‰ä¸€ä¸ª Java Web åº”ç”¨çš„ WAR åŒ…ï¼Œå®ƒéœ€è¦è¢«æ”¾åœ¨ Tomcat çš„ webapps ç›®å½•ä¸‹è¿è¡Œèµ·æ¥ã€‚\n\nå‡å¦‚ï¼Œä½ ç°åœ¨åªèƒ½ç”¨ Docker æ¥åšè¿™ä»¶äº‹æƒ…ï¼Œé‚£è¯¥å¦‚ä½•å¤„ç†è¿™ä¸ªç»„åˆå…³ç³»å‘¢ï¼Ÿ\n\n<ul>\n    <li>\n        ä¸€ç§æ–¹æ³•æ˜¯ï¼ŒæŠŠ WAR åŒ…ç›´æ¥æ”¾åœ¨ Tomcat é•œåƒçš„ webapps ç›®å½•ä¸‹ï¼Œåšæˆä¸€ä¸ªæ–°çš„é•œåƒè¿è¡Œèµ·æ¥ã€‚å¯æ˜¯ï¼Œè¿™æ—¶å€™ï¼Œå¦‚æœä½ è¦æ›´æ–° WAR åŒ…çš„å†…å®¹ï¼Œæˆ–è€…è¦å‡çº§ Tomcat é•œåƒï¼Œå°±è¦é‡æ–°åˆ¶ä½œä¸€ä¸ªæ–°çš„å‘å¸ƒé•œåƒï¼Œéå¸¸éº»çƒ¦ã€‚\n    </li>\n    <li>\n        å¦ä¸€ç§æ–¹æ³•æ˜¯ï¼Œä½ å‹æ ¹å„¿ä¸ç®¡ WAR åŒ…ï¼Œæ°¸è¿œåªå‘å¸ƒä¸€ä¸ª Tomcat å®¹å™¨ã€‚ä¸è¿‡ï¼Œè¿™ä¸ªå®¹å™¨çš„ webapps ç›®å½•ï¼Œå°±å¿…é¡»å£°æ˜ä¸€ä¸ª hostPath ç±»å‹çš„ Volumeï¼Œä»è€ŒæŠŠå®¿ä¸»æœºä¸Šçš„WAR åŒ…æŒ‚è½½è¿› Tomcat å®¹å™¨å½“ä¸­è¿è¡Œèµ·æ¥ã€‚ä¸è¿‡ï¼Œè¿™æ ·ä½ å°±å¿…é¡»è¦è§£å†³ä¸€ä¸ªé—®é¢˜ï¼Œå³ï¼šå¦‚ä½•è®©æ¯ä¸€å°å®¿ä¸»æœºï¼Œéƒ½é¢„å…ˆå‡†å¤‡å¥½è¿™ä¸ªå­˜å‚¨æœ‰ WAR åŒ…çš„ç›®å½•å‘¢ï¼Ÿè¿™æ ·æ¥çœ‹ï¼Œä½ åªèƒ½ç‹¬ç«‹ç»´æŠ¤ä¸€å¥—åˆ†å¸ƒå¼å­˜å‚¨ç³»ç»Ÿäº†ã€‚\n    </li>\n</ul>\n\nå®é™…ä¸Šï¼Œæœ‰äº† Pod ä¹‹åï¼Œè¿™æ ·çš„é—®é¢˜å°±å¾ˆå®¹æ˜“è§£å†³äº†ã€‚æˆ‘ä»¬å¯ä»¥æŠŠ WAR åŒ…å’Œ Tomcat åˆ†åˆ«åšæˆé•œåƒï¼Œç„¶åæŠŠå®ƒä»¬ä½œä¸ºä¸€ä¸ª Pod é‡Œçš„ä¸¤ä¸ªå®¹å™¨â€œç»„åˆâ€åœ¨ä¸€èµ·ã€‚è¿™ä¸ª Pod çš„é…ç½®æ–‡ä»¶å¦‚ä¸‹æ‰€ç¤ºï¼š\n\n```yaml\napiVersion: v1\nkind: Pod\nmetadata:\n  name: javaweb-2\nspec:\n  initContainers:\n  - image: geektime/sample:v2\n    name: war\n    command: [\"cp\", \"/sample.war\", \"/app\"]\n    volumeMounts:\n    - mountPath: /app\n        name: app-volume\n  containers:\n  - image: geektime/tomcat:7.0\n    name: tomcat\n    command: [\"sh\",\"-c\",\"/root/apache-tomcat-7.0.42-v2/bin/start.sh\"]\n    volumeMounts:\n    - mountPath: /root/apache-tomcat-7.0.42-v2/webapps\n      name: app-volume\n    ports:\n    - containerPort: 8080\n      hostPort: 8001 \n  volumes:\n  - name: app-volume\n    emptyDir: {}\n```\n\nåœ¨è¿™ä¸ª Pod ä¸­ï¼Œæˆ‘ä»¬å®šä¹‰äº†ä¸¤ä¸ªå®¹å™¨ï¼Œç¬¬ä¸€ä¸ªå®¹å™¨ä½¿ç”¨çš„é•œåƒæ˜¯ geektime/sample:v2ï¼Œè¿™ä¸ªé•œåƒé‡Œåªæœ‰ä¸€ä¸ª WAR åŒ…ï¼ˆsample.warï¼‰æ”¾åœ¨æ ¹ç›®å½•ä¸‹ã€‚è€Œç¬¬äºŒä¸ªå®¹å™¨åˆ™ä½¿ç”¨çš„æ˜¯ä¸€ä¸ªæ ‡å‡†çš„ Tomcat é•œåƒã€‚\n\nä¸è¿‡ï¼Œä½ å¯èƒ½å·²ç»æ³¨æ„åˆ°ï¼ŒWAR åŒ…å®¹å™¨çš„ç±»å‹ä¸å†æ˜¯ä¸€ä¸ªæ™®é€šå®¹å™¨ï¼Œè€Œæ˜¯ä¸€ä¸ª Init Container ç±»å‹çš„å®¹å™¨ã€‚\n\nåœ¨ Pod ä¸­ï¼Œæ‰€æœ‰ Init Container å®šä¹‰çš„å®¹å™¨ï¼Œéƒ½ä¼šæ¯” spec.containers å®šä¹‰çš„ç”¨æˆ·å®¹å™¨å…ˆå¯åŠ¨ã€‚å¹¶ä¸”ï¼ŒInit Container å®¹å™¨ä¼šæŒ‰é¡ºåºé€ä¸€å¯åŠ¨ï¼Œè€Œç›´åˆ°å®ƒä»¬éƒ½å¯åŠ¨å¹¶ä¸”é€€å‡ºäº†ï¼Œç”¨æˆ·å®¹å™¨æ‰ä¼šå¯åŠ¨ã€‚\n\næ‰€ä»¥ï¼Œè¿™ä¸ª Init Container ç±»å‹çš„ WAR åŒ…å®¹å™¨å¯åŠ¨åï¼Œæˆ‘æ‰§è¡Œäº†ä¸€å¥\"cp /sample.war/app\"ï¼ŒæŠŠåº”ç”¨çš„ WAR åŒ…æ‹·è´åˆ° /app ç›®å½•ä¸‹ï¼Œç„¶åé€€å‡ºã€‚\n\nè€Œåè¿™ä¸ª /app ç›®å½•ï¼Œå°±æŒ‚è½½äº†ä¸€ä¸ªåå« app-volume çš„ Volumeã€‚\n\næ¥ä¸‹æ¥å°±å¾ˆå…³é”®äº†ã€‚Tomcat å®¹å™¨ï¼ŒåŒæ ·å£°æ˜äº†æŒ‚è½½ app-volume åˆ°è‡ªå·±çš„ webapps ç›®å½•ä¸‹ã€‚\n\næ‰€ä»¥ï¼Œç­‰ Tomcat å®¹å™¨å¯åŠ¨æ—¶ï¼Œå®ƒçš„ webapps ç›®å½•ä¸‹å°±ä¸€å®šä¼šå­˜åœ¨ sample.war æ–‡ä»¶ï¼šè¿™ä¸ªæ–‡ä»¶æ­£æ˜¯ WAR åŒ…å®¹å™¨å¯åŠ¨æ—¶æ‹·è´åˆ°è¿™ä¸ª Volume é‡Œé¢çš„ï¼Œè€Œè¿™ä¸ª Volume æ˜¯è¢«è¿™ä¸¤ä¸ªå®¹å™¨å…±äº«çš„ã€‚\n\nåƒè¿™æ ·ï¼Œæˆ‘ä»¬å°±ç”¨ä¸€ç§â€œç»„åˆâ€æ–¹å¼ï¼Œè§£å†³äº† WAR åŒ…ä¸ Tomcat å®¹å™¨ä¹‹é—´è€¦åˆå…³ç³»çš„é—®é¢˜ã€‚\n\nå®é™…ä¸Šï¼Œè¿™ä¸ªæ‰€è°“çš„â€œç»„åˆâ€æ“ä½œï¼Œæ­£æ˜¯å®¹å™¨è®¾è®¡æ¨¡å¼é‡Œæœ€å¸¸ç”¨çš„ä¸€ç§æ¨¡å¼ï¼Œå®ƒçš„åå­—å«ï¼šsidecarã€‚\n\né¡¾åæ€ä¹‰ï¼Œsidecar æŒ‡çš„å°±æ˜¯æˆ‘ä»¬å¯ä»¥åœ¨ä¸€ä¸ª Pod ä¸­ï¼Œå¯åŠ¨ä¸€ä¸ªè¾…åŠ©å®¹å™¨ï¼Œæ¥å®Œæˆä¸€äº›ç‹¬ç«‹äºä¸»è¿›ç¨‹ï¼ˆä¸»å®¹å™¨ï¼‰ä¹‹å¤–çš„å·¥ä½œã€‚\n\næ¯”å¦‚ï¼Œåœ¨æˆ‘ä»¬çš„è¿™ä¸ªåº”ç”¨ Pod ä¸­ï¼ŒTomcat å®¹å™¨æ˜¯æˆ‘ä»¬è¦ä½¿ç”¨çš„ä¸»å®¹å™¨ï¼Œè€Œ WAR åŒ…å®¹å™¨çš„å­˜åœ¨ï¼Œåªæ˜¯ä¸ºäº†ç»™å®ƒæä¾›ä¸€ä¸ª WAR åŒ…è€Œå·²ã€‚æ‰€ä»¥ï¼Œæˆ‘ä»¬ç”¨ Init Container çš„æ–¹å¼ä¼˜å…ˆè¿è¡Œ WAR åŒ…å®¹å™¨ï¼Œæ‰®æ¼”äº†ä¸€ä¸ª sidecar çš„è§’è‰²ã€‚","tags":["å­¦ä¹ ç¬”è®°","k8s"]},{"title":"DSLå¤‡å¿˜ï¼ˆä¸€ï¼‰ï¼šConstant score query å’Œ Bool Query","url":"/2023/02/23/2023-02-23-DSLå¤‡å¿˜ï¼ˆä¸€ï¼‰ï¼šConstant score queryå’ŒBool Query/","content":"\n## Constant score query\n\nå¸¸é‡åˆ†å€¼æŸ¥è¯¢ï¼Œç›®çš„å°±æ˜¯è¿”å›æŒ‡å®šçš„ scoreï¼ˆé»˜è®¤1ï¼‰ï¼Œä¸€èˆ¬éƒ½ç»“åˆ filter ä½¿ç”¨ï¼Œå› ä¸º filter context å¿½ç•¥ scoreã€‚\n\n### åŸºæœ¬è¯­æ³•\n\nå¤šç”¨äºç»“åˆboolæŸ¥è¯¢å®ç°è‡ªå®šä¹‰å¾—åˆ†ï¼Œå…¶åŸºæœ¬è¯­æ³•å¦‚ä¸‹:\n\n```json\nPOST /index_name/_search\n```\n\n```json\n{\n  \"query\": {\n    \"constant_score\": {\n      \"filter\": {\n        \"match\": {\n          \"field_name\": \"query_clause\"\n        }\n      },\n      \"boost\": score\n    }\n  }\n}\n```\n\n<ul>\n    <li>const_scoreï¼šå…³é”®å­—</li>\n    <li>filterï¼šåªèƒ½æœ‰ä¸€ä¸ª</li>\n    <li>field_nameï¼šå­—æ®µå</li>\n    <li>query_clauseï¼šå¾…æŸ¥è¯¢çš„è¯­å¥</li>\n    <li>boostï¼šè‡ªå®šä¹‰å¾—åˆ†</li>\n</ul>\n\n### å®ä¾‹\n\n```json\nGET /customer/_search\n{\n  \"query\": {\n    \"constant_score\": {\n      \"filter\": {\n        \"range\": {\n          \"age\": {\n            \"gt\": 25\n          }\n        }\n      },\n      \"boost\": 8.8\n    }\n  }\n}\n\nresult:è¿”å›ç»“æœä¸­scoreéƒ½æ˜¯è¢«æŒ‡å®šçš„8.8\n{\n  \"took\" : 8,\n  \"timed_out\" : false,\n  \"_shards\" : {\n    \"total\" : 1,\n    \"successful\" : 1,\n    \"skipped\" : 0,\n    \"failed\" : 0\n  },\n   \"hits\": {\n    \"total\": 4,\n    \"max_score\": 8.8,\n    \"hits\": [\n      {\n        \"_index\": \"constant_index\",\n        \"_type\": \"default_type_\",\n        \"_id\": \"1\",\n        \"_score\": 8.8,\n        \"_source\": {\n          \"name\": \"Emma Edgar\"\n        }\n      },\n      {\n        \"_index\": \"constant_index\",\n        \"_type\": \"default_type_\",\n        \"_id\": \"2\",\n        \"_score\": 8.8,\n        \"_source\": {\n          \"name\": \"Underwood Verda\"\n        }\n      },\n      {\n        \"_index\": \"constant_index\",\n        \"_type\": \"default_type_\",\n        \"_id\": \"4\",\n        \"_score\": 8.8,\n        \"_source\": {\n          \"name\": \"Rivera Interpreter\"\n        }\n      },\n      {\n        \"_index\": \"constant_index\",\n        \"_type\": \"default_type_\",\n        \"_id\": \"6\",\n        \"_score\": 8.8,\n        \"_source\": {\n          \"name\": \"Lucy Seaman\"\n        }\n      }\n    ]\n  }\n}\n```\n\n## bool query \n\nå¸ƒå°”æŸ¥è¯¢ï¼Œç”±ä¸€ä¸ªæˆ–è€…å¤šä¸ªå­å¥ç»„æˆï¼Œæ¯ä¸ªå­å¥éƒ½æœ‰ç‰¹å®šçš„ç±»å‹ã€‚\n<ul>\n    <li>\n        mustï¼šè¿”å›çš„æ–‡æ¡£å¿…é¡»æ»¡è¶³ must å­å¥çš„æ¡ä»¶ï¼Œå¹¶ä¸”å‚ä¸è®¡ç®—åˆ†å€¼\n    </li>\n    <li>\n        filterï¼šè¿”å›çš„æ–‡æ¡£å¿…é¡»æ»¡è¶³ filter å­å¥çš„æ¡ä»¶ã€‚ä½†ä¸ä¼šåƒ must ä¸€æ ·å‚ä¸è®¡ç®—åˆ†å€¼\n    </li>\n    <li>\n        shouldï¼šè¿”å›çš„æ–‡æ¡£å¯èƒ½æ»¡è¶³ should å­å¥çš„æ¡ä»¶ã€‚å¸ƒå°”æŸ¥è¯¢åœ¨ query context ä¸­ï¼Œå¦‚æœæŸæ¡æ–‡æ¡£æœªåŒ¹é… should çš„æ¡ä»¶ï¼Œä½†æ˜¯åŒ¹é… must æˆ– filter çš„æ¡ä»¶ï¼Œåˆ™æ–‡æ¡£ä»ä¼šè¢«è¿”å›ï¼Œæ­¤æ—¶ should åªå½±å“åˆ†æ•°ï¼›å¦‚æœä¸å­˜åœ¨ must å’Œ filterï¼Œåˆ™å¿…é¡»åŒ¹é… shouldã€‚è¿™ç§è¡Œä¸ºç”± minimum_should_match å‚ä¸å†³å®šã€‚\n    </li>\n    <li>\n        must_notï¼šè¿”å›çš„æ–‡æ¡£å¿…é¡»ä¸æ»¡è¶³ must_not å®šä¹‰çš„æ¡ä»¶ã€‚\n    </li>\n</ul>\n\n### å®˜ç½‘ä¾‹å­\n\nç¬¬ä¸€æ­¥ï¼šæŸ¥è¯¢ name ä¸º \"æäº‘é¾™\" çš„æ–‡æ¡£\n\n```json\nGET /customer/_search\n{\n  \"query\": {\n    \"bool\": {\n      \"must\": {\n        \"term\":{\"name.keyword\":\"æäº‘é¾™\"}\n      }\n    }\n  }\n}\nè¿”å›ä¸‰ä¸ªæ–‡æ¡£ï¼š\n{\n  \"hits\" : {\n    \"total\" : 3,\n    \"max_score\" : 1.4916549,\n    \"hits\" : [\n      {\n        \"_index\" : \"customer\",\n        \"_type\" : \"doc\",\n        \"_id\" : \"4\",\n        \"_score\" : 1.4916549,\n        \"_source\" : {\n          \"name\" : \"æäº‘é¾™\",\n          \"id\" : \"510221197001013611\",\n          \"addr\" : \"æ˜†æ˜å¸‚æ»‡æ± è·¯é˜³å…‰æ—¶ä»£1æ ‹1å•å…ƒ\",\n          \"tel\" : \"13808712808\"\n        }\n      },\n      {\n        \"_index\" : \"customer\",\n        \"_type\" : \"doc\",\n        \"_id\" : \"224\",\n        \"_score\" : 1.4916549,\n        \"_source\" : {\n          \"name\" : \"æäº‘é¾™\",\n          \"id\" : \"224\",\n          \"addr\" : \"å¤©æ´¥å¸‚é˜³å…‰è·¯2008å·\",\n          \"tel\" : \"13908712808\"\n        }\n      },\n      {\n        \"_index\" : \"customer\",\n        \"_type\" : \"doc\",\n        \"_id\" : \"510221197001013611\",\n        \"_score\" : 1.4916549,\n        \"_source\" : {\n          \"name\" : \"æäº‘é¾™\",\n          \"id\" : \"510221197001013611\",\n          \"addr\" : \"ä¸Šæµ·å¸‚æµ¦ä¸œåŒºååŒ—è·¯8å·\",\n          \"tel\" : \"13908712808\"\n        }\n      }\n    ]\n  }\n}\n```\n\nç¬¬äºŒæ­¥ï¼šåŠ å…¥è¿‡æ»¤æ¡ä»¶ï¼Œåªä¿ç•™ id ä¸º 510221197001013611 çš„æ–‡æ¡£\n\n```json\nGET /customer/_search\n{\n  \"query\": {\n    \"bool\": {\n      \"must\": {\n        \"term\":{\n          \"name.keyword\":\"æäº‘é¾™\"\n        }\n      },\n      \"filter\": {\n        \"term\": {\n          \"id\": \"510221197001013611\"\n        }\n      }\n    }\n  }\n}\n\nè¿”å›ç»“æœå‡å°‘åˆ° 2 ä¸ªæ–‡æ¡£ï¼Œå¹¶ä¸” score ç›¸åŒï¼š\n{\n  \"hits\" : {\n    \"total\" : 2,\n    \"max_score\" : 1.4916549,\n    \"hits\" : [\n      {\n        \"_index\" : \"customer\",\n        \"_type\" : \"doc\",\n        \"_id\" : \"4\",\n        \"_score\" : 1.4916549,\n        \"_source\" : {\n          \"name\" : \"æäº‘é¾™\",\n          \"id\" : \"510221197001013611\",\n          \"addr\" : \"æ˜†æ˜å¸‚æ»‡æ± è·¯é˜³å…‰æ—¶ä»£1æ ‹1å•å…ƒ\",\n          \"tel\" : \"13808712808\"\n        }\n      },\n      {\n        \"_index\" : \"customer\",\n        \"_type\" : \"doc\",\n        \"_id\" : \"510221197001013611\",\n        \"_score\" : 1.4916549,\n        \"_source\" : {\n          \"name\" : \"æäº‘é¾™\",\n          \"id\" : \"510221197001013611\",\n          \"addr\" : \"ä¸Šæµ·å¸‚æµ¦ä¸œåŒºååŒ—è·¯8å·\",\n          \"tel\" : \"13908712808\"\n        }\n      }\n    ]\n  }\n}\n```\n\nç¬¬ä¸‰æ­¥ï¼šä½¿ç”¨ shouldï¼Œåˆ¤æ–­ addr ä¸­å¿…é¡»æœ‰æ˜†æ˜å¸‚ï¼Œè¿™ç§æƒ…å†µä¸‹ should å­å¥ä¼šå½±å“è®¡åˆ†\n\n```json\nGET /customer/_search\n{\n  \"query\": {\n    \"bool\": {\n      \"must\": {\n        \"term\":{\n          \"name.keyword\":\"æäº‘é¾™\"\\\n        }\n      },\n      \"filter\": {\n        \"term\": {\n          \"id\": \"510221197001013611\"\n        }\n      },\n      \"should\": [\n        {\n          \"match\": {\n            \"addr\": \"æ˜†æ˜å¸‚\"\n          }\n        }\n      ]\n    }\n  }\n}\nè¿”å›ç»“æœä¸­ï¼Œåœ°å€æ˜¯æ˜†æ˜å¸‚çš„æ–‡æ¡£ score åŠ é‡\n{\n  \"hits\" : {\n    \"total\" : 2,\n    \"max_score\" : 3.408528,\n    \"hits\" : [\n      {\n        \"_index\" : \"customer\",\n        \"_type\" : \"doc\",\n        \"_id\" : \"4\",\n        \"_score\" : 3.408528,\n        \"_source\" : {\n          \"name\" : \"æäº‘é¾™\",\n          \"id\" : \"510221197001013611\",\n          \"addr\" : \"æ˜†æ˜å¸‚æ»‡æ± è·¯é˜³å…‰æ—¶ä»£1æ ‹1å•å…ƒ\",\n          \"tel\" : \"13808712808\"\n        }\n      },\n      {\n        \"_index\" : \"customer\",\n        \"_type\" : \"doc\",\n        \"_id\" : \"510221197001013611\",\n        \"_score\" : 1.5720221,\n        \"_source\" : {\n          \"name\" : \"æäº‘é¾™\",\n          \"id\" : \"510221197001013611\",\n          \"addr\" : \"ä¸Šæµ·å¸‚æµ¦ä¸œåŒºååŒ—è·¯8å·\",\n          \"tel\" : \"13908712808\"\n        }\n      }\n    ]\n  }\n}\n```\n\nç¬¬å››æ­¥ï¼šåŠ å…¥ must_not æ’é™¤ä¸Šæµ·\n\n```json\nGET /customer/_search\n{\n  \"query\": {\n    \"bool\": {\n      \"must\": {\n        \"term\":{\n          \"name.keyword\":\"æäº‘é¾™\"\n        }\n      },\n      \"filter\": {\n        \"term\": {\n          \"id\": \"510221197001013611\"\n        }\n      },\n      \"should\": [\n        {\"match\": {\n          \"addr\": \"æ˜†æ˜å¸‚\"\n        }}\n      ],\n      \"must_not\": [\n        {\"match\": {\n          \"addr\": \"ä¸Šæµ·\"\n        }}\n      ]\n    }\n  }\n}\n\nåªè¿”å›ä¸€ä¸ªæ–‡æ¡£ï¼š\n{\n  \"hits\" : {\n    \"total\" : 1,\n    \"max_score\" : 3.408528,\n    \"hits\" : [\n      {\n        \"_index\" : \"customer\",\n        \"_type\" : \"doc\",\n        \"_id\" : \"4\",\n        \"_score\" : 3.408528,\n        \"_source\" : {\n          \"name\" : \"æäº‘é¾™\",\n          \"id\" : \"510221197001013611\",\n          \"addr\" : \"æ˜†æ˜å¸‚æ»‡æ± è·¯é˜³å…‰æ—¶ä»£1æ ‹1å•å…ƒ\",\n          \"tel\" : \"13808712808\"\n        }\n      }\n    ]\n  }\n}\n```","tags":["Elasticsearch"]},{"title":"tokenizer å’Œ analyzer çš„å…³ç³»","url":"/2023/02/15/2023-02-15-åˆ†è¯å™¨ç›¸å…³/","content":"\nTokenizerã€Token-filter å’Œ analyzerï¼š\n\n<ul>\n    <li>tokenizerï¼šåˆ†è¯å™¨</li>\n    <li>analyzerï¼šåˆ†æå™¨</li>\n    <li>token-filterï¼šåˆ†è¯è¿‡æ»¤å™¨</li>\n</ul>\n\n1ã€Tokenizerï¼ˆåˆ†è¯å™¨ï¼‰\n\nåˆ†è¯ï¼Œå°±æ˜¯å°†ä¸€ä¸ªå­—ç¬¦ä¸²ï¼ŒæŒ‰ç…§æŸç§ç‰¹å®šè§„åˆ™æ‰“æ•£ä¸ºå¤šä¸ªå­—ç¬¦ä¸²çš„è¿‡ç¨‹ã€‚\n\n2ã€Token-filterï¼ˆåˆ†è¯è¿‡æ»¤å™¨ï¼‰\n\nåˆ†è¯è¿‡æ»¤å™¨ï¼Œæ˜¯å¯¹åˆ†è¯å™¨å¤„ç†åå¾—åˆ°çš„å­å­—ç¬¦ä¸²ï¼Œè¿›è¡Œå­—ç¬¦çš„ä¿®æ”¹ã€‚ ï¼ˆä¾‹å¦‚ï¼šå¤§å°å†™è½¬æ¢ã€æ—¶æ€ã€å¤æ•°â€¦â€¦ï¼‰\n\n3ã€Analyzerï¼ˆåˆ†æå™¨ï¼‰\n\nåˆ†æå™¨æ˜¯åˆ†è¯å™¨å’Œåˆ†è¯è¿‡æ»¤å™¨çš„ç»“åˆã€‚\n\nES ä½¿ç”¨åˆ†æå™¨ï¼ˆAnalyzerï¼‰å¯¹æ–‡æ¡£è¿›è¡Œåˆ†è¯ï¼ŒES ä¸­å†…ç½®äº†å¾ˆå¤šåˆ†æå™¨ä¾›æˆ‘ä»¬ä½¿ç”¨ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥å®šåˆ¶è‡ªå·±çš„åˆ†æå™¨ã€‚\n\nä¸€ä¸ªåˆ†æå™¨æœ‰ 3 ä¸ªç»„æˆéƒ¨åˆ†ï¼Œåˆ†æè¿‡ç¨‹ä¼šä¾æ¬¡ç»è¿‡è¿™äº›éƒ¨åˆ†ï¼š\n\n<ol>\n    <li>Character Filtersï¼šå­—ç¬¦è¿‡æ»¤ï¼Œç”¨äºåˆ å»æŸäº›å­—ç¬¦ã€‚è¯¥ç»„ä»¶å¯ä»¥æœ‰ 0 æˆ–å¤šä¸ªã€‚</li>\n    <li>Tokenizerï¼šåˆ†è¯è¿‡ç¨‹ï¼ŒæŒ‰ç…§æŸä¸ªè§„åˆ™å°†æ–‡æ¡£åˆ‡åˆ†ä¸ºå•è¯ï¼Œæ¯”å¦‚ç”¨ç©ºæ ¼æ¥åˆ‡åˆ†ã€‚è¯¥ç»„ä»¶æœ‰ä¸”åªèƒ½æœ‰ä¸€ä¸ªã€‚</li>\n    <li>Token Filterï¼šå¯¹åˆ‡åˆ†å¥½çš„å•è¯è¿›ä¸€æ­¥åŠ å·¥ï¼Œæ¯”å¦‚å¤§å°å†™è½¬æ¢ï¼Œåˆ é™¤åœç”¨è¯ç­‰ã€‚è¯¥ç»„ä»¶å¯ä»¥æœ‰ 0 æˆ–å¤šä¸ªã€‚</li>\n</ol>\n\nä¹Ÿå°±æ˜¯è¯´ï¼Œåˆ†è¯å™¨å°±æ˜¯åˆ’åˆ†å­å­—ç¬¦ä¸²ï¼Œåˆ†è¯è¿‡æ»¤å™¨å°±æ˜¯å­å­—ç¬¦ä¸²çš„æ ¼å¼è½¬æ¢ï¼Œåˆ†æå™¨æ˜¯ä¸¤è€…ç»“åˆã€‚\n\n![tokenizerå’Œanalyzerçš„å…³ç³»å›¾](/img/2023-02-15-åˆ†è¯å™¨ç›¸å…³/pho1.png)\n","tags":["Elasticsearch"]},{"title":"curl å¸¸ç”¨å‘½ä»¤ä½¿ç”¨æ–¹æ³•","url":"/2023/02/01/2023-02-01-curlå¸¸ç”¨å‘½ä»¤ä½¿ç”¨æ–¹æ³•/","content":"\n## ä»€ä¹ˆæ˜¯ curl\n\nå…¨ç§° CommandLine Uniform Resource Locatorã€‚å®ƒåœ¨å‘½ä»¤è¡Œæ–¹å¼ä¸‹å·¥ä½œï¼Œåˆ©ç”¨ URL çš„è¯­æ³•è¿›è¡Œæ•°æ®çš„ä¼ è¾“æˆ–è€…æ–‡ä»¶çš„ä¼ è¾“ï¼›ç”¨äºåœ¨æœ¬åœ°è®¡ç®—æœºä¸è¿œç¨‹æœåŠ¡å™¨ä¹‹é—´ä¼ è¾“æ•°æ®çš„å‘½ä»¤è¡Œå·¥å…·ã€‚\n\ncurl çš„å®˜æ–¹ç½‘ç«™ï¼š<a href='https://curl.se/'>https://curl.se/</a>\n\nä»å®˜ç½‘ä¸­ï¼Œå¯ä»¥å¾—çŸ¥ curl æ”¯æŒå„ç§å„æ ·çš„åè®®ï¼Œå…¶ä¸­å¸¸è§çš„åè®®æœ‰ FILEã€FTPã€HTTPã€HTTPSç­‰\n\ncurlçš„ç”¨æ³•è·Ÿä¸€èˆ¬çš„linux/Unixå‘½ä»¤æ— å¼‚ï¼Œä¸€èˆ¬è¯­æ³•å¦‚ä¸‹ï¼š\n\n```bash\ncrul -[é€‰é¡¹] [URL]\n```\n\n<hr/>\n\nä»¥ä¸‹æ˜¯å¸¸ç”¨çš„ curl å‘½ä»¤ï¼š\n\n1ã€-v é€‰é¡¹ï¼ˆverboseï¼‰ï¼šæŒ‡å®šè¯¥é€‰é¡¹åï¼Œå¯ä»¥è·Ÿè¸ªURLçš„è¿æ¥ä¿¡æ¯ï¼›è¿”å›ç«¯å£è¿æ¥ä¿¡æ¯ï¼Œhttpè¯·æ±‚å¤´éƒ¨ä¿¡æ¯ï¼Œç½‘é¡µhtmlä¿¡æ¯ã€‚\n<ul>\n    <li>-v å‚æ•°è¡¨ç¤ºæ˜¾ç¤ºä¸€æ¬¡ http é€šä¿¡çš„æ•´ä¸ªè¿‡ç¨‹ï¼ŒåŒ…æ‹¬ç«¯å£è¿æ¥å’Œ http request å¤´ä¿¡æ¯ </li>\n    <li>-vv å°±è¡¨ç¤ºæ˜¾ç¤ºä¸¤æ¬¡ http é€šä¿¡çš„è¿‡ç¨‹ </li>\n</ul>\n\n2ã€-u é€‰é¡¹ï¼Œå¸¦ç”¨æˆ·éªŒè¯çš„è¿æ¥ã€‚å¯ä»¥è®¿é—®æˆ–è·å–å¸¦ç”¨æˆ·éªŒè¯çš„URLã€‚\n\n3ã€-X é€‰é¡¹ï¼ŒæŒ‡å®šè¯·æ±‚æ–¹å¼ï¼Œæˆ‘ä»¬åªèƒ½URLå¯ä»¥æœ‰å¤šç§è¯·æ±‚æ–¹å¼ï¼Œæœ€å¸¸è§çš„æ˜¯GETå’ŒPOSTï¼Œä½†è¯·æ±‚çš„æ–¹å¼ï¼ŒåŒ…æ‹¬GETã€PUTã€POSTã€DELETEå››ç§æ–¹å¼ã€‚\n\n4ã€-d é€‰é¡¹ï¼Œå¸¦è¯·æ±‚å‚æ•°çš„è¿æ¥ã€‚\n\n5ã€-i é€‰é¡¹ï¼ˆincludeï¼‰ï¼šæŠŠå›åº”çš„å¤´ä¿¡æ¯åŒ…å«åœ¨å†…ï¼Œä¹Ÿå°±æ˜¯è¿”å›è¯¥ç½‘å€çš„htmlä¿¡æ¯å’Œåè®®å¤´éƒ¨ä¿¡æ¯ï¼›-I ï¼ˆå¤§å†™iï¼‰é€‰é¡¹ï¼ˆheadï¼‰ï¼šåªæ˜¾ç¤ºè¿”å›çš„å¤´ä¿¡æ¯ï¼›å®ƒä»¬è·Ÿ -v å¤§åŒå°å¼‚ï¼Œæ˜¯ -v çš„å­é›†ã€‚\n\n\n","tags":["linux"]},{"title":"ä»å®¹å™¨åˆ°å®¹å™¨äº‘ï¼šè°ˆè°ˆ Kubernetes çš„æœ¬è´¨","url":"/2023/01/23/2023-01-23-ä»å®¹å™¨åˆ°å®¹å™¨äº‘ï¼šè°ˆè°ˆKubernetesçš„æœ¬è´¨/","content":"\né€šè¿‡é˜…è¯»ç™½è¯å®¹å™¨åŸºç¡€é‚£å‡ ç¯‡æ–‡ç« ï¼Œä¸éš¾å‘ç°ï¼Œä¸€ä¸ªâ€œå®¹å™¨â€ï¼Œå®é™…ä¸Šæ˜¯ä¸€ä¸ªç”± Linux Namespaceã€Linux Cgroups å’Œ rootfs ä¸‰ç§æŠ€æœ¯æ„å»ºå‡ºæ¥çš„è¿›ç¨‹çš„éš”ç¦»ç¯å¢ƒã€‚\n\nä»è¿™ä¸ªç»“æ„ä¸­æˆ‘ä»¬ä¸éš¾çœ‹å‡ºï¼Œä¸€ä¸ªæ­£åœ¨è¿è¡Œçš„ Linux å®¹å™¨ï¼Œå…¶å®å¯ä»¥è¢«â€œä¸€åˆ†ä¸ºäºŒâ€åœ°çœ‹å¾…ï¼š\n\n<ol>\n    <li>ä¸€ç»„è”åˆæŒ‚è½½åœ¨ /var/lib/docker/aufs/mnt ä¸Šçš„ rootfsï¼Œè¿™ä¸€éƒ¨åˆ†æˆ‘ä»¬ç§°ä¸ºâ€œå®¹å™¨é•œåƒâ€ï¼ˆContainer Imageï¼‰ï¼Œæ˜¯å®¹å™¨çš„é™æ€è§†å›¾</li>\n    <li>ä¸€ä¸ªç”± Namespace+Cgroups æ„æˆçš„éš”ç¦»ç¯å¢ƒï¼Œè¿™ä¸€éƒ¨åˆ†æˆ‘ä»¬ç§°ä¸ºâ€œå®¹å™¨è¿è¡Œæ—¶â€ï¼ˆContainer Runtimeï¼‰ï¼Œæ˜¯å®¹å™¨çš„åŠ¨æ€è§†å›¾</li>\n</ol>\n\næ›´è¿›ä¸€æ­¥è¯´ï¼Œä½œä¸ºä¸€ä¸ªå¼€å‘è€…ï¼Œæˆ‘å¹¶ä¸å…³å¿ƒå®¹å™¨è¿è¡Œæ—¶çš„å·®å¼‚ã€‚å› ä¸ºï¼Œåœ¨æ•´ä¸ªâ€œå¼€å‘ - æµ‹è¯• - å‘å¸ƒâ€çš„æµç¨‹ä¸­ï¼ŒçœŸæ­£æ‰¿è½½ç€å®¹å™¨ä¿¡æ¯è¿›è¡Œä¼ é€’çš„ï¼Œæ˜¯å®¹å™¨é•œåƒï¼Œè€Œä¸æ˜¯å®¹å™¨è¿è¡Œæ—¶ã€‚\n\nä»ä¸€ä¸ªå¼€å‘è€…å’Œå•ä¸€çš„å®¹å™¨é•œåƒï¼Œåˆ°æ— æ•°å¼€å‘è€…å’Œåºå¤§çš„å®¹å™¨é›†ç¾¤ï¼Œå®¹å™¨æŠ€æœ¯å®ç°äº†ä»â€œå®¹å™¨â€åˆ°â€œå®¹å™¨äº‘â€çš„é£è·ƒï¼Œæ ‡å¿—ç€å®ƒçœŸæ­£å¾—åˆ°äº†å¸‚åœºå’Œç”Ÿæ€çš„è®¤å¯ã€‚\n\nè¿™æ ·ï¼Œ**å®¹å™¨å°±ä»ä¸€ä¸ªå¼€å‘è€…æ‰‹é‡Œçš„å°å·¥å…·ï¼Œä¸€è·ƒæˆä¸ºäº†äº‘è®¡ç®—é¢†åŸŸçš„ç»å¯¹ä¸»è§’ï¼›è€Œèƒ½å¤Ÿå®šä¹‰å®¹å™¨ç»„ç»‡å’Œç®¡ç†è§„èŒƒçš„â€œå®¹å™¨ç¼–æ’â€æŠ€æœ¯ï¼Œåˆ™å½“ä»ä¸è®©åœ°åä¸Šäº†å®¹å™¨æŠ€æœ¯é¢†åŸŸçš„â€œå¤´æŠŠäº¤æ¤…â€ã€‚**\n\nè¿™å…¶ä¸­ï¼Œæœ€å…·ä»£è¡¨æ€§çš„å®¹å™¨ç¼–æ’å·¥å…·ï¼Œå½“å± Docker å…¬å¸çš„ Compose+Swarm ç»„åˆï¼Œä»¥åŠ Google ä¸ RedHat å…¬å¸å…±åŒä¸»å¯¼çš„ Kubernetes é¡¹ç›®ã€‚\n\nè·Ÿå¾ˆå¤šåŸºç¡€è®¾æ–½é¢†åŸŸå…ˆæœ‰å·¥ç¨‹å®è·µã€åæœ‰æ–¹æ³•è®ºçš„å‘å±•è·¯çº¿ä¸åŒï¼ŒKubernetes é¡¹ç›®çš„ç†è®ºåŸºç¡€åˆ™è¦æ¯”å·¥ç¨‹å®è·µèµ°å¾—é å‰å¾—å¤šï¼Œè¿™å½“ç„¶è¦å½’åŠŸäº Google å…¬å¸åœ¨ 2015 å¹´ 4 æœˆå‘å¸ƒçš„Borg è®ºæ–‡äº†ã€‚\n\nBorg ç³»ç»Ÿï¼Œä¸€ç›´ä»¥æ¥éƒ½è¢«èª‰ä¸º Google å…¬å¸å†…éƒ¨æœ€å¼ºå¤§çš„â€œç§˜å¯†æ­¦å™¨â€ã€‚å› ä¸ºï¼Œç›¸æ¯”äº Spannerã€BigTable ç­‰ç›¸å¯¹ä¸Šå±‚çš„é¡¹ç›®ï¼ŒBorg è¦æ‰¿æ‹…çš„è´£ä»»ï¼Œæ˜¯æ‰¿è½½ Google å…¬å¸æ•´ä¸ªåŸºç¡€è®¾æ–½çš„æ ¸å¿ƒä¾èµ–ã€‚åœ¨ Google å…¬å¸å·²ç»å…¬å¼€å‘è¡¨çš„åŸºç¡€è®¾æ–½ä½“ç³»è®ºæ–‡ä¸­ï¼ŒBorg é¡¹ç›®å½“ä»ä¸è®©åœ°ä½å±…æ•´ä¸ªåŸºç¡€è®¾æ–½æŠ€æœ¯æ ˆçš„æœ€åº•å±‚ã€‚\n\nBorg æ•´ä½“æ¶æ„ï¼šå¯ä»¥å»çœ‹<a href=\"https://zhuanlan.zhihu.com/p/30355957\">ã€ŠBorgï¼šGoogleå†…éƒ¨çš„å¤§å‹é›†ç¾¤ç®¡ç†ç³»ç»Ÿã€‹</a>è¿™ç¯‡æ–‡ç« ã€‚\n\nè™½ç„¶åœ¨ Master èŠ‚ç‚¹çš„å®ç°ç»†èŠ‚ä¸Šï¼ŒBorg é¡¹ç›®ä¸ Kubernetes é¡¹ç›®ä¸å°½ç›¸åŒï¼Œä½†å®ƒä»¬çš„å‡ºå‘ç‚¹æ˜¯ä¸€è‡´çš„ï¼Œå³ï¼šå¦‚ä½•ç¼–æ’ã€ç®¡ç†ã€è°ƒåº¦ç”¨æˆ·æäº¤çš„ä½œä¸šã€‚\n\nK8sæ¶æ„å›¾ï¼š\n\n![K8sæ¶æ„å›¾](/img/2023-01-23-ä»å®¹å™¨åˆ°å®¹å™¨äº‘ï¼šè°ˆè°ˆKubernetesçš„æœ¬è´¨/pho1.jpg)\n\næ§åˆ¶èŠ‚ç‚¹ï¼Œå³ Master èŠ‚ç‚¹ï¼Œç”±ä¸‰ä¸ªç´§å¯†åä½œçš„ç‹¬ç«‹ç»„ä»¶ç»„åˆè€Œæˆï¼Œå®ƒä»¬åˆ†åˆ«æ˜¯ï¼š\n\n<ul>\n    <li>kube-apiserverï¼šè´Ÿè´£ API æœåŠ¡</li>\n    <li>kube-schedulerï¼šè´Ÿè´£è°ƒåº¦</li>\n    <li>kube-controller-managerï¼šè´Ÿè´£å®¹å™¨ç¼–æ’</li>\n</ul>\n\næ•´ä¸ªé›†ç¾¤çš„æŒä¹…åŒ–æ•°æ®ï¼Œåˆ™ç”± kube-apiserver å¤„ç†åä¿å­˜åœ¨ Etcd ä¸­ã€‚\n\nè€Œè®¡ç®—èŠ‚ç‚¹ä¸Šæœ€æ ¸å¿ƒçš„éƒ¨åˆ†ï¼Œåˆ™æ˜¯ä¸€ä¸ªå«ä½œ **kubelet** çš„ç»„ä»¶ã€‚\n\n**åœ¨ Kubernetes é¡¹ç›®ä¸­ï¼Œkubelet ä¸»è¦è´Ÿè´£åŒå®¹å™¨è¿è¡Œæ—¶ï¼ˆæ¯”å¦‚ Docker é¡¹ç›®ï¼‰æ‰“äº¤é“ã€‚** è€Œè¿™ä¸ªäº¤äº’æ‰€ä¾èµ–çš„ï¼Œæ˜¯ä¸€ä¸ªç§°ä½œ CRIï¼ˆContainer Runtime Interfaceï¼‰çš„è¿œç¨‹è°ƒç”¨æ¥å£ï¼Œè¿™ä¸ªæ¥å£å®šä¹‰äº†å®¹å™¨è¿è¡Œæ—¶çš„å„é¡¹æ ¸å¿ƒæ“ä½œï¼Œæ¯”å¦‚ï¼šå¯åŠ¨ä¸€ä¸ªå®¹å™¨éœ€è¦çš„æ‰€æœ‰å‚æ•°ã€‚\n\nè¿™ä¹Ÿæ˜¯ä¸ºä½•ï¼ŒKubernetes é¡¹ç›®å¹¶ä¸å…³å¿ƒä½ éƒ¨ç½²çš„æ˜¯ä»€ä¹ˆå®¹å™¨è¿è¡Œæ—¶ã€ä½¿ç”¨çš„ä»€ä¹ˆæŠ€æœ¯å®ç°ï¼Œåªè¦ä½ çš„è¿™ä¸ªå®¹å™¨è¿è¡Œæ—¶èƒ½å¤Ÿè¿è¡Œæ ‡å‡†çš„å®¹å™¨é•œåƒï¼Œå®ƒå°±å¯ä»¥é€šè¿‡å®ç° CRI æ¥å…¥åˆ° Kubernetes é¡¹ç›®å½“ä¸­ã€‚\n\nè€Œå…·ä½“çš„å®¹å™¨è¿è¡Œæ—¶ï¼Œæ¯”å¦‚ Docker é¡¹ç›®ï¼Œåˆ™ä¸€èˆ¬é€šè¿‡ OCI è¿™ä¸ªå®¹å™¨è¿è¡Œæ—¶è§„èŒƒåŒåº•å±‚çš„ Linux æ“ä½œç³»ç»Ÿè¿›è¡Œäº¤äº’ï¼Œå³ï¼šæŠŠ CRI è¯·æ±‚ç¿»è¯‘æˆå¯¹ Linux æ“ä½œç³»ç»Ÿçš„è°ƒç”¨ï¼ˆæ“ä½œ Linux Namespace å’Œ Cgroups ç­‰ï¼‰ã€‚\n\n**æ­¤å¤–ï¼Œkubelet è¿˜é€šè¿‡ gRPC åè®®åŒä¸€ä¸ªå«ä½œ Device Plugin çš„æ’ä»¶è¿›è¡Œäº¤äº’ã€‚** è¿™ä¸ªæ’ä»¶ï¼Œæ˜¯ Kubernetes é¡¹ç›®ç”¨æ¥ç®¡ç† GPU ç­‰å®¿ä¸»æœºç‰©ç†è®¾å¤‡çš„ä¸»è¦ç»„ä»¶ï¼Œä¹Ÿæ˜¯åŸºäº Kubernetes é¡¹ç›®è¿›è¡Œæœºå™¨å­¦ä¹ è®­ç»ƒã€é«˜æ€§èƒ½ä½œä¸šæ”¯æŒç­‰å·¥ä½œå¿…é¡»å…³æ³¨çš„åŠŸèƒ½ã€‚\n\n**è€Œ kubelet çš„å¦ä¸€ä¸ªé‡è¦åŠŸèƒ½ï¼Œåˆ™æ˜¯è°ƒç”¨ç½‘ç»œæ’ä»¶å’Œå­˜å‚¨æ’ä»¶ä¸ºå®¹å™¨é…ç½®ç½‘ç»œå’ŒæŒä¹…åŒ–å­˜å‚¨ã€‚** è¿™ä¸¤ä¸ªæ’ä»¶ä¸ kubelet è¿›è¡Œäº¤äº’çš„æ¥å£ï¼Œåˆ†åˆ«æ˜¯ CNIï¼ˆContainer Networking Interfaceï¼‰å’Œ CSIï¼ˆContainer Storage Interfaceï¼‰ã€‚\n\nä½†å®é™…ä¸Šï¼Œè™½ç„¶ kubelet è¿™ä¸ªå¥‡æ€ªçš„åå­—ï¼Œæ¥è‡ªäº Borg é¡¹ç›®é‡Œçš„åŒæºç»„ä»¶ Borgletã€‚ä¸è¿‡ï¼Œå¦‚æœä½ æµè§ˆè¿‡ Borg è®ºæ–‡çš„è¯ï¼Œå°±ä¼šå‘ç°ï¼Œè¿™ä¸ªå‘½åæ–¹å¼å¯èƒ½æ˜¯ kubelet ç»„ä»¶ä¸ Borglet ç»„ä»¶çš„å”¯ä¸€ç›¸ä¼¼ä¹‹å¤„ã€‚å› ä¸º Borg é¡¹ç›®ï¼Œå¹¶ä¸æ”¯æŒæˆ‘ä»¬è¿™é‡Œæ‰€è®²çš„å®¹å™¨æŠ€æœ¯ï¼Œè€Œåªæ˜¯ç®€å•åœ°ä½¿ç”¨äº† Linux Cgroups å¯¹è¿›ç¨‹è¿›è¡Œé™åˆ¶ã€‚\n\nBorg å¯¹äº Kubernetes é¡¹ç›®çš„æŒ‡å¯¼ä½œç”¨ä¸»è¦ä½“ç°åœ¨ Master èŠ‚ç‚¹ã€‚\n\nè™½ç„¶åœ¨ Master èŠ‚ç‚¹çš„å®ç°ç»†èŠ‚ä¸Š Borg é¡¹ç›®ä¸ Kubernetes é¡¹ç›®ä¸å°½ç›¸åŒï¼Œä½†å®ƒä»¬çš„å‡ºå‘ç‚¹å´é«˜åº¦ä¸€è‡´ï¼Œå³ï¼šå¦‚ä½•ç¼–æ’ã€ç®¡ç†ã€è°ƒåº¦ç”¨æˆ·æäº¤çš„ä½œä¸šï¼Ÿ\n\n\n\n","tags":["å­¦ä¹ ç¬”è®°","k8s"]},{"title":"chrootã€pivot_root å’Œ switch_root çš„åŒºåˆ«","url":"/2023/01/12/2023-01-12-chrootã€pivot_rootå’Œswitch_rootçš„åŒºåˆ«/","content":"\n## chroot\n\nchroot : change to root\n\nä¸ºäº†è¿›ä¸€æ­¥æé«˜ç³»ç»Ÿçš„å®‰å…¨æ€§ï¼Œlinux å¼•å…¥äº† chroot æœºåˆ¶ï¼Œchroot æ˜¯ä¸€ä¸ªç³»ç»Ÿè°ƒç”¨ï¼Œå¯ä»¥æ›´æ”¹ä¸€ä¸ªè¿›ç¨‹æ‰€èƒ½çœ‹åˆ°çš„æ ¹ç›®å½•ã€‚\n\nç±»ä¼¼åˆ›å»ºä¸€ä¸ªæ²™ç›’ï¼Œè¿›ç¨‹è¿è¡Œåœ¨æ²™ç›’ä¹‹å†…ï¼Œè¿›ç¨‹è¿è¡Œæ­£å¸¸ä¸å¦ï¼Œå¹¶ä¸ä¼šå½±å“è¿™å°è™šæ‹Ÿæœºçš„å…¶ä»–è¿›ç¨‹ã€‚\n\n```bash\n# åˆ‡æ¢åˆ°æœ‰æ•ˆçš„ filesystem bundle ç›®å½•\n$ ls\nbin  dev  lib  media  opt  root  sbin  sys  var  boot\netc  home  mnt  proc  run  srv  tmp  usr\n$ cd /mycontainer\n$ chroot rootfs /bin/sh\n# è¿›å…¥åˆ°ä¸€ä¸ªæ–°çš„shellä¸­\n$ ls /\nbin  dev  lib \n```\n\nå¯ä»¥çœ‹å‡ºï¼Œls å‘½ä»¤å‚è€ƒçš„æ ¹æ˜¯ä¸åŒ, ä»¥æ­¤æ¥å½¢æˆç®€å•çš„éš”ç¦».\n\n## pivot_root\n\næ”¹å˜å½“å‰å·¥ä½œç›®å½•çš„æ‰€æœ‰è¿›ç¨‹æˆ–çº¿ç¨‹çš„å·¥ä½œç›®å½•. è¿™ä¸ªè·Ÿchrootçš„å°±æœ‰å¾ˆå¤§çš„åŒºåˆ«ï¼Œchrootæ˜¯åªæ”¹å˜å³å°†è¿è¡Œçš„æŸè¿›ç¨‹çš„æ ¹ç›®å½•ã€‚\n\npviot_root ä¸»è¦æ˜¯æŠŠæ•´ä¸ªç³»ç»Ÿåˆ‡æ¢åˆ°ä¸€ä¸ªæ–°çš„ root ç›®å½•ï¼Œç„¶åå»æ‰å¯¹ä¹‹å‰rootfsçš„ä¾èµ–ï¼Œä»¥ä¾¿äºå¯ä»¥ umount ä¹‹å‰çš„æ–‡ä»¶ç³»ç»Ÿï¼ˆpivot_root éœ€è¦ root æƒé™ï¼‰\n\nç”¨æ³•ï¼špivot_root new_root put_old\n\nä¾‹å­ï¼š\n\n   ä» 127.0.0.1:/home/puser/nfsroot æŒ‚è½½æ–°çš„æ–‡ä»¶ç³»ç»Ÿå¹¶ä¸”è¿è¡Œ init\n\n<ul>\n    <li> æ‹·è´ sh, ls è‡³ nfsroot/binï¼Œä»¥åŠç›¸å…³çš„å…±äº«åº“è‡³ nfsroot/lib </li>\n    <li> åœ¨ nfsroot ä¸‹é¢å»ºç«‹ç›®å½• old_root </li>\n    <li> mount -o ro 127.0.0.1:/home/puser/nfsroot /mnt </li>\n    <li> cd /mnt </li>\n    <li>\n        pivot_root . old_root <br/>\n        è¿™ä¸ªæ—¶å€™ï¼Œä¼šå‘ç°æ¯”å¦‚ \"ls /\" æ˜¾ç¤ºçš„æ˜¯ nfsroot ä¸‹é¢çš„æ–‡ä»¶ï¼›\"ls old_root\" æ˜¾ç¤ºçš„æ˜¯ä¹‹å‰æ–‡ä»¶ç³»ç»Ÿ root ä¸‹é¢çš„æ–‡ä»¶ã€‚\n    </li>\n</ul>\n\npivot_root å’Œ chroot çš„ä¸»è¦åŒºåˆ«æ˜¯ï¼Œpivot_root ä¸»è¦æ˜¯æŠŠæ•´ä¸ªç³»ç»Ÿåˆ‡æ¢åˆ°ä¸€ä¸ªæ–°çš„ root ç›®å½•ï¼Œè€Œç§»é™¤å¯¹ä¹‹å‰ root æ–‡ä»¶ç³»ç»Ÿçš„ä¾èµ–ï¼Œè¿™æ ·ä½ å°±èƒ½å¤Ÿ umount åŸå…ˆçš„ root æ–‡ä»¶ç³»ç»Ÿã€‚è€Œ chroot æ˜¯é’ˆå¯¹æŸä¸ªè¿›ç¨‹ï¼Œè€Œç³»ç»Ÿçš„å…¶å®ƒéƒ¨åˆ†ä¾æ—§è¿è¡Œäºè€çš„ root ç›®å½•ã€‚\n\n## switch_root\n\nä¸“ä¸º initramfs è®¾è®¡, é€šå¸¸ initramfs éƒ½æ˜¯ä¸ºäº†å®‰è£…æœ€ç»ˆçš„æ ¹æ–‡ä»¶ç³»ç»Ÿåšå‡†å¤‡å·¥ä½œï¼Œç„¶ååˆ‡æ¢åˆ°æ–°çš„æ ¹æ–‡ä»¶ç³»ç»Ÿä¸Šå»ã€‚\n\ninitramfs æ˜¯ rootfsï¼Œ ä¸”ä¸èƒ½ umountï¼Œ æ‰€ä»¥ä¸èƒ½ä½¿ç”¨ pivot_rootã€‚\n\nswitch_rootåšçš„å·¥ä½œï¼š\n\n<ul>\n   <li> åˆ é™¤æ—©çš„ rootfs å†…çš„å…¨éƒ¨å†…å®¹ï¼Œç›®çš„æ˜¯ä¸ºäº†é‡Šæ”¾ç©ºé—´ï¼Œå› ä¸ºç”¨çš„å†…å­˜ç©ºé—´</li> \n   <li> å®‰è£…æ–°çš„æ ¹æ–‡ä»¶ç³»ç»Ÿ</li> \n   <li> åˆ‡æ¢åˆ°æ–°çš„æ–‡ä»¶ç³»ç»Ÿï¼Œå¹¶æ‰§è¡Œæ–°æ–‡ä»¶ç³»ç»Ÿçš„ init ç¨‹åº</li> \n</ul>\n\nï¼ˆswitch_root å¿…é¡»ç”± pid=1 çš„è¿›ç¨‹è°ƒç”¨ï¼Œå¦åˆ™ä¼šé”™è¯¯ï¼Œä¾‹å¦‚åœ¨ init è„šæœ¬: exec switch_root new_rootfs  /initï¼‰\n\n## å‚è€ƒ\n\n<ul>\n    <li>\n        <a href='https://blog.csdn.net/u012385733/article/details/102565591'>chrootï¼Œpivot_rootå’Œswitch_root åŒºåˆ«</a>\n    </li>\n    <li>\n        <a href=\"https://waynerv.com/posts/container-fundamentals-filesystem-isolation-and-sharing/#chroot-%E5%91%BD%E4%BB%A4%E7%9A%84%E4%BD%BF%E7%94%A8%E7%A4%BA%E4%BE%8B\">å®¹å™¨æŠ€æœ¯åŸç†(äº”)ï¼šæ–‡ä»¶ç³»ç»Ÿçš„éš”ç¦»å’Œå…±äº«</a>\n    </li>\n    <li>\n        <a href=\"https://blog.csdn.net/linuxchyu/article/details/21109335\">Linuxä¸­chrootä¸pivot_rootçš„åŒºåˆ«</a>\n    </li>\n</ul>","tags":["linux"]},{"title":"ç™½è¯å®¹å™¨åŸºç¡€ï¼ˆä¸‰ï¼‰ï¼šæ·±å…¥ç†è§£å®¹å™¨é•œåƒ","url":"/2023/01/04/2023-01-04-ç™½è¯å®¹å™¨åŸºç¡€ï¼ˆä¸‰ï¼‰ï¼šæ·±å…¥ç†è§£å®¹å™¨é•œåƒ/","content":"\nLinux å®¹å™¨æœ€åŸºç¡€çš„ä¸¤ç§æŠ€æœ¯ï¼šNamespace å’Œ Cgroupsï¼Œå…¶ä¸­ Namespace çš„ä½œç”¨æ˜¯â€œéš”ç¦»â€ï¼Œå®ƒè®©åº”ç”¨è¿›ç¨‹åªèƒ½çœ‹åˆ°è¯¥ Namespace å†…çš„â€œä¸–ç•Œâ€ï¼›è€Œ Cgroups çš„ä½œç”¨æ˜¯â€œé™åˆ¶â€ï¼Œå®ƒç»™è¿™ä¸ªâ€œä¸–ç•Œâ€å›´ä¸Šäº†ä¸€åœˆçœ‹ä¸è§çš„å¢™ã€‚\n\nè¿™ä¹ˆä¸€æŠ˜è…¾ï¼Œè¿›ç¨‹å°±çœŸçš„è¢«â€œè£…â€åœ¨äº†ä¸€ä¸ªä¸ä¸–éš”ç»çš„æˆ¿é—´é‡Œï¼Œè€Œè¿™äº›æˆ¿é—´å°±æ˜¯ PaaS é¡¹ç›®èµ–ä»¥ç”Ÿå­˜çš„åº”ç”¨â€œæ²™ç›’â€ã€‚\n\nå¯æ˜¯ï¼Œç°åœ¨è¿™ä¸ªæˆ¿é—´å››å‘¨è™½ç„¶æœ‰äº†å¢™ï¼Œä½†æ˜¯å¦‚æœå®¹å™¨è¿›ç¨‹ä½å¤´ä¸€çœ‹åœ°é¢ï¼Œåˆæ˜¯æ€æ ·ä¸€å‰¯æ™¯è±¡å‘¢ï¼Ÿ\n\næ¢å¥è¯è¯´ï¼Œå®¹å™¨é‡Œçš„è¿›ç¨‹çœ‹åˆ°çš„æ–‡ä»¶ç³»ç»Ÿåˆæ˜¯ä»€ä¹ˆæ ·å­çš„å‘¢ï¼Ÿ\n\nå¯èƒ½ä½ ç«‹åˆ»å°±èƒ½æƒ³åˆ°ï¼Œè¿™ä¸€å®šæ˜¯ä¸€ä¸ªå…³äº Mount Namespace çš„é—®é¢˜ï¼šå®¹å™¨é‡Œçš„åº”ç”¨è¿›ç¨‹ï¼Œç†åº”çœ‹åˆ°ä¸€ä»½å®Œå…¨ç‹¬ç«‹çš„æ–‡ä»¶ç³»ç»Ÿã€‚è¿™æ ·ï¼Œå®ƒå°±å¯ä»¥åœ¨è‡ªå·±çš„å®¹å™¨ç›®å½•ï¼ˆæ¯”å¦‚ /tmpï¼‰ä¸‹è¿›è¡Œæ“ä½œï¼Œè€Œå®Œå…¨ä¸ä¼šå—å®¿ä¸»æœºä»¥åŠå…¶ä»–å®¹å™¨çš„å½±å“ã€‚\n\nä½†æ˜¯ï¼ŒMount Namespace ä¿®æ”¹çš„æ˜¯å®¹å™¨è¿›ç¨‹å¯¹æ–‡ä»¶ç³»ç»Ÿâ€œæŒ‚è½½ç‚¹â€çš„è®¤çŸ¥ã€‚è¿™ä¹Ÿå°±æ„å‘³ç€ï¼Œåªæœ‰åœ¨â€œæŒ‚è½½â€è¿™ä¸ªæ“ä½œå‘ç”Ÿä¹‹åï¼Œè¿›ç¨‹çš„è§†å›¾æ‰ä¼šè¢«æ”¹å˜ã€‚è€Œåœ¨æ­¤ä¹‹å‰ï¼Œæ–°åˆ›å»ºçš„å®¹å™¨ä¼šç›´æ¥ç»§æ‰¿å®¿ä¸»æœºçš„å„ä¸ªæŒ‚è½½ç‚¹ã€‚\n\nå› æ­¤ï¼Œåˆ›å»ºæ–°è¿›ç¨‹æ—¶ï¼Œé™¤äº†å£°æ˜è¦å¯ç”¨ Mount Namespace ä¹‹å¤–ï¼Œæˆ‘ä»¬è¿˜åº”è¯¥å‘Šè¯‰å®¹å™¨è¿›ç¨‹ï¼Œæœ‰å“ªäº›ç›®å½•éœ€è¦é‡æ–°æŒ‚è½½ï¼Œå°±æ¯”å¦‚è¿™ä¸ª /tmp ç›®å½•ï¼›æ›´é‡è¦çš„æ˜¯ï¼Œå› ä¸ºæˆ‘ä»¬åˆ›å»ºçš„æ–°è¿›ç¨‹å¯ç”¨äº† Mount Namespaceï¼Œæ‰€ä»¥è¿™æ¬¡é‡æ–°æŒ‚è½½çš„æ“ä½œï¼Œåªåœ¨å®¹å™¨è¿›ç¨‹çš„ Mount Namespace ä¸­æœ‰æ•ˆã€‚è¿™å°±æ˜¯ Mount Namespace è·Ÿå…¶ä»– Namespace çš„ä½¿ç”¨ç•¥æœ‰ä¸åŒçš„åœ°æ–¹ï¼šå®ƒå¯¹å®¹å™¨è¿›ç¨‹è§†å›¾çš„æ”¹å˜ï¼Œä¸€å®šæ˜¯ä¼´éšç€æŒ‚è½½æ“ä½œï¼ˆmountï¼‰æ‰èƒ½ç”Ÿæ•ˆã€‚\n\nä½†æ˜¯ï¼Œä½œä¸ºä¸€ä¸ªæ™®é€šç”¨æˆ·ï¼Œæˆ‘ä»¬å¸Œæœ›çš„æ˜¯ä¸€ä¸ªæ›´å‹å¥½çš„æƒ…å†µï¼šæ¯å½“åˆ›å»ºä¸€ä¸ªæ–°å®¹å™¨æ—¶ï¼Œæˆ‘å¸Œæœ›å®¹å™¨è¿›ç¨‹çœ‹åˆ°çš„æ–‡ä»¶ç³»ç»Ÿå°±æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„éš”ç¦»ç¯å¢ƒï¼Œè€Œä¸æ˜¯ç»§æ‰¿è‡ªå®¿ä¸»æœºçš„æ–‡ä»¶ç³»ç»Ÿã€‚é‚£åº”è¯¥æ€ä¹ˆæ‰èƒ½åšåˆ°è¿™ä¸€ç‚¹å‘¢ï¼Ÿ\n\nä¸éš¾æƒ³åˆ°ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨å®¹å™¨è¿›ç¨‹å¯åŠ¨ä¹‹å‰é‡æ–°æŒ‚è½½å®ƒçš„æ•´ä¸ªæ ¹ç›®å½•â€œ/â€ã€‚è€Œç”±äº Mount Namespace çš„å­˜åœ¨ï¼Œè¿™ä¸ªæŒ‚è½½å¯¹å®¿ä¸»æœºä¸å¯è§ï¼Œæ‰€ä»¥å®¹å™¨è¿›ç¨‹å°±å¯ä»¥åœ¨é‡Œé¢éšä¾¿æŠ˜è…¾äº†ã€‚\n\nåœ¨ Linux æ“ä½œç³»ç»Ÿé‡Œï¼Œæœ‰ä¸€ä¸ªåä¸º chroot çš„å‘½ä»¤å¯ä»¥å¸®åŠ©ä½ åœ¨ shell ä¸­æ–¹ä¾¿åœ°å®Œæˆè¿™ä¸ªå·¥ä½œã€‚é¡¾åæ€ä¹‰ï¼Œå®ƒçš„ä½œç”¨å°±æ˜¯å¸®ä½ â€œchange root file systemâ€ï¼Œå³æ”¹å˜è¿›ç¨‹çš„æ ¹ç›®å½•åˆ°ä½ æŒ‡å®šçš„ä½ç½®ã€‚å®ƒçš„ç”¨æ³•ä¹Ÿéå¸¸ç®€å•ã€‚\n\nå‡è®¾ï¼Œç°åœ¨æœ‰ä¸€ä¸ª $HOME/test ç›®å½•ï¼Œè¦è®©å®ƒä½œä¸ºä¸€ä¸ª /bin/bash è¿›ç¨‹çš„æ ¹ç›®å½•ã€‚\n\né¦–å…ˆï¼Œåˆ›å»ºä¸€ä¸ª test ç›®å½•å’Œå‡ ä¸ª lib æ–‡ä»¶å¤¹ï¼š\n\n```bash\n$ mkdir -p $HOME/test\n$ mkdir -p $HOME/test/{bin,lib64,lib}\n$ cd $T\n```\n\nç„¶åï¼ŒæŠŠ bash å‘½ä»¤æ‹·è´åˆ° test ç›®å½•å¯¹åº”çš„ bin è·¯å¾„ä¸‹ï¼š\n\n```bash\ncp -v /bin/{bash,ls} $HOME/test/bin\n```\n\næ¥ä¸‹æ¥ï¼ŒæŠŠ bash å‘½ä»¤éœ€è¦çš„æ‰€æœ‰ so æ–‡ä»¶ï¼Œä¹Ÿæ‹·è´åˆ° test ç›®å½•å¯¹åº”çš„ lib è·¯å¾„ä¸‹ã€‚æ‰¾åˆ° so æ–‡ä»¶å¯ä»¥ç”¨ ldd å‘½ä»¤ï¼š\n\n```bash\n$ T=$HOME/test\n$ list=\"$(ldd /bin/ls | egrep -o '/lib.*\\.[0-9]')\"\n$ for i in $list; do cp -v \"$i\" \"${T}${i}\"; done\n```\n\næœ€åï¼Œæ‰§è¡Œ chroot å‘½ä»¤ï¼Œå‘Šè¯‰æ“ä½œç³»ç»Ÿï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ $HOME/test ç›®å½•ä½œä¸º /bin/bash è¿›ç¨‹çš„æ ¹ç›®å½•ï¼š\n\n```bash\n$ chroot $HOME/test /bin/bash\n```\n\nè¿™æ—¶ï¼Œä½ å¦‚æœæ‰§è¡Œ \"ls /\"ï¼Œå°±ä¼šçœ‹åˆ°ï¼Œå®ƒè¿”å›çš„éƒ½æ˜¯ $HOME/test ç›®å½•ä¸‹é¢çš„å†…å®¹ï¼Œè€Œä¸æ˜¯å®¿ä¸»æœºçš„å†…å®¹ã€‚\n\næ›´é‡è¦çš„æ˜¯ï¼Œå¯¹äºè¢« chroot çš„è¿›ç¨‹æ¥è¯´ï¼Œå®ƒå¹¶ä¸ä¼šæ„Ÿå—åˆ°è‡ªå·±çš„æ ¹ç›®å½•å·²ç»è¢«â€œä¿®æ”¹â€æˆ $HOME/test äº†ã€‚\n\nè¿™ç§è§†å›¾è¢«ä¿®æ”¹çš„åŸç†ï¼Œæ˜¯ä¸æ˜¯å’Œ Linux Namespace å¾ˆç±»ä¼¼å‘¢ï¼Ÿ\n\næ²¡é”™ï¼\n\n**å®é™…ä¸Šï¼ŒMount Namespace æ­£æ˜¯åŸºäºå¯¹ chroot çš„ä¸æ–­æ”¹è‰¯æ‰è¢«å‘æ˜å‡ºæ¥çš„ï¼Œå®ƒä¹Ÿæ˜¯ Linux æ“ä½œç³»ç»Ÿé‡Œçš„ç¬¬ä¸€ä¸ª Namespaceã€‚**\n\nå½“ç„¶ï¼Œä¸ºäº†èƒ½å¤Ÿè®©å®¹å™¨çš„è¿™ä¸ªæ ¹ç›®å½•çœ‹èµ·æ¥æ›´â€œçœŸå®â€ï¼Œæˆ‘ä»¬ä¸€èˆ¬ä¼šåœ¨è¿™ä¸ªå®¹å™¨çš„æ ¹ç›®å½•ä¸‹æŒ‚è½½ä¸€ä¸ªå®Œæ•´æ“ä½œç³»ç»Ÿçš„æ–‡ä»¶ç³»ç»Ÿï¼Œæ¯”å¦‚ Ubuntu16.04 çš„ ISOã€‚è¿™æ ·ï¼Œåœ¨å®¹å™¨å¯åŠ¨ä¹‹åï¼Œæˆ‘ä»¬åœ¨å®¹å™¨é‡Œé€šè¿‡æ‰§è¡Œ \"ls /\" æŸ¥çœ‹æ ¹ç›®å½•ä¸‹çš„å†…å®¹ï¼Œå°±æ˜¯ Ubuntu 16.04 çš„æ‰€æœ‰ç›®å½•å’Œæ–‡ä»¶ã€‚\n\n**è€Œè¿™ä¸ªæŒ‚è½½åœ¨å®¹å™¨æ ¹ç›®å½•ä¸Šã€ç”¨æ¥ä¸ºå®¹å™¨è¿›ç¨‹æä¾›éš”ç¦»åæ‰§è¡Œç¯å¢ƒçš„æ–‡ä»¶ç³»ç»Ÿï¼Œå°±æ˜¯æ‰€è°“çš„â€œå®¹å™¨é•œåƒâ€ã€‚å®ƒè¿˜æœ‰ä¸€ä¸ªæ›´ä¸ºä¸“ä¸šçš„åå­—ï¼Œå«ä½œï¼šrootfsï¼ˆæ ¹æ–‡ä»¶ç³»ç»Ÿï¼‰ã€‚**\n\næ‰€ä»¥ï¼Œä¸€ä¸ªæœ€å¸¸è§çš„ rootfsï¼Œæˆ–è€…è¯´å®¹å™¨é•œåƒï¼Œä¼šåŒ…æ‹¬å¦‚ä¸‹æ‰€ç¤ºçš„ä¸€äº›ç›®å½•å’Œæ–‡ä»¶ï¼Œæ¯”å¦‚ /binï¼Œ/etcï¼Œ/proc ç­‰ç­‰ï¼š\n\n```bash\n$ ls /\nbin dev etc home lib lib64 mnt opt proc root run sbin sys tmp usr var\n```\n\nè€Œä½ è¿›å…¥å®¹å™¨ä¹‹åæ‰§è¡Œçš„ /bin/bashï¼Œå°±æ˜¯ /bin ç›®å½•ä¸‹çš„å¯æ‰§è¡Œæ–‡ä»¶ï¼Œä¸å®¿ä¸»æœºçš„ /bin/bash å®Œå…¨ä¸åŒã€‚\n\nç°åœ¨ï¼Œä½ åº”è¯¥å¯ä»¥ç†è§£ï¼Œå¯¹ Docker é¡¹ç›®æ¥è¯´ï¼Œå®ƒæœ€æ ¸å¿ƒçš„åŸç†å®é™…ä¸Šå°±æ˜¯ä¸ºå¾…åˆ›å»ºçš„ç”¨æˆ·è¿›ç¨‹ï¼š\n\n<ol>\n    <li> å¯ç”¨ Linux Namespace é…ç½® </li>\n    <li> è®¾ç½®æŒ‡å®šçš„ Cgroups å‚æ•° </li>\n    <li> åˆ‡æ¢è¿›ç¨‹çš„æ ¹ç›®å½•ï¼ˆChange Rootï¼‰ </li>\n</ol>\n\nè¿™æ ·ï¼Œä¸€ä¸ªå®Œæ•´çš„å®¹å™¨å°±è¯ç”Ÿäº†ã€‚ä¸è¿‡ï¼ŒDocker é¡¹ç›®åœ¨æœ€åä¸€æ­¥çš„åˆ‡æ¢ä¸Šä¼šä¼˜å…ˆä½¿ç”¨ pivot_root ç³»ç»Ÿè°ƒç”¨ï¼Œå¦‚æœç³»ç»Ÿä¸æ”¯æŒï¼Œæ‰ä¼šä½¿ç”¨ chrootã€‚\n\nå¦å¤–ï¼Œ**éœ€è¦æ˜ç¡®çš„æ˜¯ï¼Œrootfs åªæ˜¯ä¸€ä¸ªæ“ä½œç³»ç»Ÿæ‰€åŒ…å«çš„æ–‡ä»¶ã€é…ç½®å’Œç›®å½•ï¼Œå¹¶ä¸åŒ…æ‹¬æ“ä½œç³»ç»Ÿå†…æ ¸ã€‚åœ¨ Linux æ“ä½œç³»ç»Ÿä¸­ï¼Œè¿™ä¸¤éƒ¨åˆ†æ˜¯åˆ†å¼€å­˜æ”¾çš„ï¼Œæ“ä½œç³»ç»Ÿåªæœ‰åœ¨å¼€æœºå¯åŠ¨æ—¶æ‰ä¼šåŠ è½½æŒ‡å®šç‰ˆæœ¬çš„å†…æ ¸é•œåƒã€‚**\n\næ‰€ä»¥è¯´ï¼Œrootfs åªåŒ…æ‹¬äº†æ“ä½œç³»ç»Ÿçš„â€œèº¯å£³â€ï¼Œå¹¶æ²¡æœ‰åŒ…æ‹¬æ“ä½œç³»ç»Ÿçš„â€œçµé­‚â€ã€‚\n\né‚£ä¹ˆï¼Œå¯¹äºå®¹å™¨æ¥è¯´ï¼Œè¿™ä¸ªæ“ä½œç³»ç»Ÿçš„â€œçµé­‚â€åˆåœ¨å“ªé‡Œå‘¢ï¼Ÿ\n\nå®é™…ä¸Šï¼ŒåŒä¸€å°æœºå™¨ä¸Šçš„æ‰€æœ‰å®¹å™¨ï¼Œéƒ½å…±äº«å®¿ä¸»æœºæ“ä½œç³»ç»Ÿçš„å†…æ ¸ã€‚\n\nè¿™å°±æ„å‘³ç€ï¼Œå¦‚æœä½ çš„åº”ç”¨ç¨‹åºéœ€è¦é…ç½®å†…æ ¸å‚æ•°ã€åŠ è½½é¢å¤–çš„å†…æ ¸æ¨¡å—ï¼Œä»¥åŠè·Ÿå†…æ ¸è¿›è¡Œç›´æ¥çš„äº¤äº’ï¼Œä½ å°±éœ€è¦æ³¨æ„äº†ï¼šè¿™äº›æ“ä½œå’Œä¾èµ–çš„å¯¹è±¡ï¼Œéƒ½æ˜¯å®¿ä¸»æœºæ“ä½œç³»ç»Ÿçš„å†…æ ¸ï¼Œå®ƒå¯¹äºè¯¥æœºå™¨ä¸Šçš„æ‰€æœ‰å®¹å™¨æ¥è¯´æ˜¯ä¸€ä¸ªâ€œå…¨å±€å˜é‡â€ï¼Œç‰µä¸€å‘è€ŒåŠ¨å…¨èº«ã€‚\n\nè¿™æ˜¯å®¹å™¨ç›¸è¾ƒäºè™šæ‹Ÿæœºçš„ç¼ºé™·ä¹‹ä¸€ï¼šæ¯•ç«Ÿåè€…ä¸ä»…æœ‰æ¨¡æ‹Ÿå‡ºæ¥çš„ç¡¬ä»¶æœºå™¨å½“ä½œæ²™ç›’ï¼Œè€Œä¸”æ¯ä¸ªæ²™ç›’é‡Œè¿˜è¿è¡Œç€ä¸€ä¸ªå®Œæ•´çš„ Guest OS ç»™åº”ç”¨éšä¾¿æŠ˜è…¾ã€‚\n\nä¸è¿‡ï¼Œ**æ­£æ˜¯ç”±äº rootfs çš„å­˜åœ¨ï¼Œå®¹å™¨æ‰æœ‰äº†ä¸€ä¸ªè¢«åå¤å®£ä¼ è‡³ä»Šçš„é‡è¦ç‰¹æ€§ï¼šä¸€è‡´æ€§ã€‚**\n\nä»€ä¹ˆæ˜¯å®¹å™¨çš„â€œä¸€è‡´æ€§â€å‘¢ï¼Ÿ\n\n## å®¹å™¨çš„ä¸€è‡´æ€§ \n\nç”±äºäº‘ç«¯ä¸æœ¬åœ°æœåŠ¡å™¨ç¯å¢ƒä¸åŒï¼Œåº”ç”¨çš„æ‰“åŒ…è¿‡ç¨‹ï¼Œä¸€ç›´æ˜¯ä½¿ç”¨ PaaS æ—¶æœ€â€œç—›è‹¦â€çš„ä¸€ä¸ªæ­¥éª¤ã€‚\n\nä½†æœ‰äº†å®¹å™¨ä¹‹åï¼Œæ›´å‡†ç¡®åœ°è¯´ï¼Œæœ‰äº†å®¹å™¨é•œåƒï¼ˆå³ rootfsï¼‰ä¹‹åï¼Œè¿™ä¸ªé—®é¢˜è¢«éå¸¸ä¼˜é›…åœ°è§£å†³äº†ã€‚\n\n**ç”±äº rootfs é‡Œæ‰“åŒ…çš„ä¸åªæ˜¯åº”ç”¨ï¼Œè€Œæ˜¯æ•´ä¸ªæ“ä½œç³»ç»Ÿçš„æ–‡ä»¶å’Œç›®å½•ï¼Œä¹Ÿå°±æ„å‘³ç€ï¼Œåº”ç”¨ä»¥åŠå®ƒè¿è¡Œæ‰€éœ€è¦çš„æ‰€æœ‰ä¾èµ–ï¼Œéƒ½è¢«å°è£…åœ¨äº†ä¸€èµ·ã€‚**\n\näº‹å®ä¸Šï¼Œå¯¹äºå¤§å¤šæ•°å¼€å‘è€…è€Œè¨€ï¼Œä»–ä»¬å¯¹åº”ç”¨ä¾èµ–çš„ç†è§£ï¼Œä¸€ç›´å±€é™åœ¨ç¼–ç¨‹è¯­è¨€å±‚é¢ã€‚æ¯”å¦‚Golang çš„ Godeps.jsonã€‚ä½†å®é™…ä¸Šï¼Œä¸€ä¸ªä¸€ç›´ä»¥æ¥å¾ˆå®¹æ˜“è¢«å¿½è§†çš„äº‹å®æ˜¯ï¼Œ**å¯¹ä¸€ä¸ªåº”ç”¨æ¥è¯´ï¼Œæ“ä½œç³»ç»Ÿæœ¬èº«æ‰æ˜¯å®ƒè¿è¡Œæ‰€éœ€è¦çš„æœ€å®Œæ•´çš„â€œä¾èµ–åº“â€**ã€‚\n\næœ‰äº†å®¹å™¨é•œåƒâ€œæ‰“åŒ…æ“ä½œç³»ç»Ÿâ€çš„èƒ½åŠ›ï¼Œè¿™ä¸ªæœ€åŸºç¡€çš„ä¾èµ–ç¯å¢ƒä¹Ÿç»ˆäºå˜æˆäº†åº”ç”¨æ²™ç›’çš„ä¸€éƒ¨åˆ†ã€‚è¿™å°±èµ‹äºˆäº†å®¹å™¨æ‰€è°“çš„ä¸€è‡´æ€§ï¼šæ— è®ºåœ¨æœ¬åœ°ã€äº‘ç«¯ï¼Œè¿˜æ˜¯åœ¨ä¸€å°ä»»ä½•åœ°æ–¹çš„æœºå™¨ä¸Šï¼Œç”¨æˆ·åªéœ€è¦è§£å‹æ‰“åŒ…å¥½çš„å®¹å™¨é•œåƒï¼Œé‚£ä¹ˆè¿™ä¸ªåº”ç”¨è¿è¡Œæ‰€éœ€è¦çš„å®Œæ•´çš„æ‰§è¡Œç¯å¢ƒå°±è¢«é‡ç°å‡º\næ¥äº†ã€‚\n\n**è¿™ç§æ·±å…¥åˆ°æ“ä½œç³»ç»Ÿçº§åˆ«çš„è¿è¡Œç¯å¢ƒä¸€è‡´æ€§ï¼Œæ‰“é€šäº†åº”ç”¨åœ¨æœ¬åœ°å¼€å‘å’Œè¿œç«¯æ‰§è¡Œç¯å¢ƒä¹‹é—´éš¾ä»¥é€¾è¶Šçš„é¸¿æ²Ÿã€‚**\n\nä¸è¿‡ï¼Œè¿™æ—¶ä½ å¯èƒ½å·²ç»å‘ç°äº†å¦ä¸€ä¸ªéå¸¸æ£˜æ‰‹çš„é—®é¢˜ï¼šéš¾é“æˆ‘æ¯å¼€å‘ä¸€ä¸ªåº”ç”¨ï¼Œæˆ–è€…å‡çº§ä¸€ä¸‹ç°æœ‰çš„åº”ç”¨ï¼Œéƒ½è¦é‡å¤åˆ¶ä½œä¸€æ¬¡ rootfs å—ï¼Ÿ\n\næ¯”å¦‚ï¼Œæˆ‘ç°åœ¨ç”¨ Ubuntu æ“ä½œç³»ç»Ÿçš„ ISO åšäº†ä¸€ä¸ª rootfsï¼Œç„¶ååˆåœ¨é‡Œé¢å®‰è£…äº† Java ç¯å¢ƒï¼Œç”¨æ¥éƒ¨ç½²æˆ‘çš„ Java åº”ç”¨ã€‚é‚£ä¹ˆï¼Œæˆ‘çš„å¦ä¸€ä¸ªåŒäº‹åœ¨å‘å¸ƒä»–çš„ Java åº”ç”¨æ—¶ï¼Œæ˜¾ç„¶å¸Œæœ›èƒ½å¤Ÿç›´æ¥ä½¿ç”¨æˆ‘å®‰è£…è¿‡ Java ç¯å¢ƒçš„ rootfsï¼Œè€Œä¸æ˜¯é‡å¤è¿™ä¸ªæµç¨‹ã€‚\n\nä¸€ç§æ¯”è¾ƒç›´è§‚çš„è§£å†³åŠæ³•æ˜¯ï¼Œæˆ‘åœ¨åˆ¶ä½œ rootfs çš„æ—¶å€™ï¼Œæ¯åšä¸€æ­¥â€œæœ‰æ„ä¹‰â€çš„æ“ä½œï¼Œå°±ä¿å­˜ä¸€ä¸ª rootfs å‡ºæ¥ï¼Œè¿™æ ·å…¶ä»–åŒäº‹å°±å¯ä»¥æŒ‰éœ€æ±‚å»ç”¨ä»–éœ€è¦çš„ rootfs äº†ã€‚\n\nä½†æ˜¯ï¼Œè¿™ä¸ªè§£å†³åŠæ³•å¹¶ä¸å…·å¤‡æ¨å¹¿æ€§ã€‚åŸå› åœ¨äºï¼Œä¸€æ—¦ä½ çš„åŒäº‹ä»¬ä¿®æ”¹äº†è¿™ä¸ª rootfsï¼Œæ–°æ—§ä¸¤ä¸ª rootfs ä¹‹é—´å°±æ²¡æœ‰ä»»ä½•å…³ç³»äº†ã€‚è¿™æ ·åšçš„ç»“æœå°±æ˜¯æåº¦çš„ç¢ç‰‡åŒ–ã€‚\n\né‚£ä¹ˆï¼Œæ—¢ç„¶è¿™äº›ä¿®æ”¹éƒ½åŸºäºä¸€ä¸ªæ—§çš„ rootfsï¼Œæˆ‘ä»¬èƒ½ä¸èƒ½ä»¥å¢é‡çš„æ–¹å¼å»åšè¿™äº›ä¿®æ”¹å‘¢ï¼Ÿè¿™æ ·åšçš„å¥½å¤„æ˜¯ï¼Œæ‰€æœ‰äººéƒ½åªéœ€è¦ç»´æŠ¤ç›¸å¯¹äº base rootfs ä¿®æ”¹çš„å¢é‡å†…å®¹ï¼Œè€Œä¸æ˜¯æ¯æ¬¡ä¿®æ”¹éƒ½åˆ¶é€ ä¸€ä¸ªâ€œforkâ€ã€‚\n\nç­”æ¡ˆå½“ç„¶æ˜¯è‚¯å®šçš„ã€‚\n\nè¿™ä¹Ÿæ­£æ˜¯ä¸ºä½•ï¼ŒDocker å…¬å¸åœ¨å®ç° Docker é•œåƒæ—¶å¹¶æ²¡æœ‰æ²¿ç”¨ä»¥å‰åˆ¶ä½œ rootfs çš„æ ‡å‡†æµç¨‹ï¼Œè€Œæ˜¯åšäº†ä¸€ä¸ªå°å°çš„åˆ›æ–°ï¼š\n\n>   Docker åœ¨é•œåƒçš„è®¾è®¡ä¸­ï¼Œå¼•å…¥äº†å±‚ï¼ˆlayerï¼‰çš„æ¦‚å¿µã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œç”¨æˆ·åˆ¶ä½œé•œåƒçš„æ¯ä¸€æ­¥æ“ä½œï¼Œéƒ½ä¼šç”Ÿæˆä¸€ä¸ªå±‚ï¼Œä¹Ÿå°±æ˜¯ä¸€ä¸ªå¢é‡ rootfsã€‚\n\nå½“ç„¶ï¼Œè¿™ä¸ªæƒ³æ³•ä¸æ˜¯å‡­ç©ºè‡†é€ å‡ºæ¥çš„ï¼Œè€Œæ˜¯ç”¨åˆ°äº†ä¸€ç§å«ä½œè”åˆæ–‡ä»¶ç³»ç»Ÿï¼ˆUnion File Systemï¼‰çš„èƒ½åŠ›ã€‚\n\nUnion File System ä¹Ÿå« UnionFSï¼Œæœ€ä¸»è¦çš„åŠŸèƒ½æ˜¯å°†å¤šä¸ªä¸åŒä½ç½®çš„ç›®å½•è”åˆæŒ‚è½½ï¼ˆunion mountï¼‰åˆ°åŒä¸€ä¸ªç›®å½•ä¸‹ã€‚æ¯”å¦‚ï¼Œæˆ‘ç°åœ¨æœ‰ä¸¤ä¸ªç›®å½• A å’Œ Bï¼Œå®ƒä»¬åˆ†åˆ«æœ‰ä¸¤ä¸ªæ–‡ä»¶ï¼š\n\n```bash\n$ tree\n.\nâ”œâ”€â”€ A\nâ”‚ â”œâ”€â”€ a\nâ”‚ â””â”€â”€ x\nâ””â”€â”€ B\n â”œâ”€â”€ b\n â””â”€â”€ x\n```\n\nç„¶åï¼Œæˆ‘ä½¿ç”¨è”åˆæŒ‚è½½çš„æ–¹å¼ï¼Œå°†è¿™ä¸¤ä¸ªç›®å½•æŒ‚è½½åˆ°ä¸€ä¸ªå…¬å…±çš„ç›®å½• C ä¸Šï¼š\n\n```bash\n$ mkdir C\n$ mount -t aufs -o dirs=./A:./B none ./C\n```\n\nè¿™æ—¶ï¼Œæˆ‘å†æŸ¥çœ‹ç›®å½• C çš„å†…å®¹ï¼Œå°±èƒ½çœ‹åˆ°ç›®å½• A å’Œ B ä¸‹çš„æ–‡ä»¶è¢«åˆå¹¶åˆ°äº†ä¸€èµ·ï¼š\n\n```bash\n$ tree ./C\n./C\nâ”œâ”€â”€ a\nâ”œâ”€â”€ b\nâ””â”€â”€ x\n```\n\nå¯ä»¥çœ‹åˆ°ï¼Œåœ¨è¿™ä¸ªåˆå¹¶åçš„ç›®å½• C é‡Œï¼Œæœ‰ aã€bã€x ä¸‰ä¸ªæ–‡ä»¶ï¼Œå¹¶ä¸” x æ–‡ä»¶åªæœ‰ä¸€ä»½ã€‚è¿™å°±æ˜¯â€œåˆå¹¶â€çš„å«ä¹‰ã€‚æ­¤å¤–ï¼Œå¦‚æœä½ åœ¨ç›®å½• C é‡Œå¯¹ aã€bã€x æ–‡ä»¶åšä¿®æ”¹ï¼Œè¿™äº›ä¿®æ”¹ä¹Ÿä¼šåœ¨å¯¹åº”çš„ç›®å½• Aã€B ä¸­ç”Ÿæ•ˆã€‚\n\né‚£ä¹ˆï¼Œåœ¨ Docker é¡¹ç›®ä¸­ï¼Œåˆæ˜¯å¦‚ä½•ä½¿ç”¨è¿™ç§ Union File System çš„å‘¢ï¼Ÿ\n\n## Union File System\n\nå¦‚æœä½ çš„ç¯å¢ƒæ˜¯ Ubuntu 16.04 å’Œ Docker CE 18.05ï¼Œè¿™å¯¹ç»„åˆé»˜è®¤ä½¿ç”¨çš„æ˜¯ AuFS è¿™ä¸ªè”åˆæ–‡ä»¶ç³»ç»Ÿçš„å®ç°ã€‚ä½ å¯ä»¥é€šè¿‡ docker info å‘½ä»¤ï¼ŒæŸ¥çœ‹åˆ°è¿™ä¸ªä¿¡æ¯ã€‚\n\nå¯¹äº AuFS æ¥è¯´ï¼Œå®ƒæœ€å…³é”®çš„ç›®å½•ç»“æ„åœ¨ /var/lib/docker è·¯å¾„ä¸‹çš„ diff ç›®å½•ï¼š\n\n```bash\n/var/lib/docker/aufs/diff/<layer_id>\n```\n\n**è€Œè¿™ä¸ªç›®å½•çš„ä½œç”¨ï¼Œæˆ‘ä»¬ä¸å¦¨é€šè¿‡ä¸€ä¸ªå…·ä½“ä¾‹å­æ¥çœ‹ä¸€ä¸‹ã€‚**\n\nç°åœ¨ï¼Œæˆ‘ä»¬å¯åŠ¨ä¸€ä¸ªå®¹å™¨ï¼Œæ¯”å¦‚ï¼š\n\n```bash\n$ docker run -d ubuntu:latest sleep 3600\n```\n\nè¿™æ—¶å€™ï¼ŒDocker å°±ä¼šä» Docker Hub ä¸Šæ‹‰å–ä¸€ä¸ª Ubuntu é•œåƒåˆ°æœ¬åœ°ã€‚\n\nè¿™ä¸ªæ‰€è°“çš„â€œé•œåƒâ€ï¼Œå®é™…ä¸Šå°±æ˜¯ä¸€ä¸ª Ubuntu æ“ä½œç³»ç»Ÿçš„ rootfsï¼Œå®ƒçš„å†…å®¹æ˜¯ Ubuntu æ“ä½œç³»ç»Ÿçš„æ‰€æœ‰æ–‡ä»¶å’Œç›®å½•ã€‚ä¸è¿‡ï¼Œä¸ä¹‹å‰æˆ‘ä»¬è®²è¿°çš„ rootfs ç¨å¾®ä¸åŒçš„æ˜¯ï¼ŒDocker é•œåƒä½¿ç”¨çš„ rootfsï¼Œå¾€å¾€ç”±å¤šä¸ªâ€œå±‚â€ç»„æˆï¼š\n\n```bash\n$ docker image inspect ubuntu:latest\n...\n    \"RootFS\": {\n        \"Type\": \"layers\",\n        \"Layers\": [\n            \"sha256:f49017d4d5ce9c0f544c...\",\n            \"sha256:8f2b771487e9d6354080...\",\n            \"sha256:ccd4d61916aaa2159429...\",\n            \"sha256:c01d74f99de40e097c73...\",\n            \"sha256:268a067217b5fe78e000...\"\n        ]\n    }\n```\n\nå¯ä»¥çœ‹åˆ°ï¼Œè¿™ä¸ª Ubuntu é•œåƒï¼Œå®é™…ä¸Šç”±äº”ä¸ªå±‚ç»„æˆã€‚è¿™äº”ä¸ªå±‚å°±æ˜¯äº”ä¸ªå¢é‡ rootfsï¼Œæ¯ä¸€å±‚éƒ½æ˜¯ Ubuntu æ“ä½œç³»ç»Ÿæ–‡ä»¶ä¸ç›®å½•çš„ä¸€éƒ¨åˆ†ï¼›è€Œåœ¨ä½¿ç”¨é•œåƒæ—¶ï¼ŒDocker ä¼šæŠŠè¿™äº›å¢é‡è”åˆæŒ‚è½½åœ¨ä¸€ä¸ªç»Ÿä¸€çš„æŒ‚è½½ç‚¹ä¸Šï¼ˆç­‰ä»·äºå‰é¢ä¾‹å­é‡Œçš„â€œ/Câ€ç›®å½•ï¼‰ã€‚\n\nè¿™ä¸ªæŒ‚è½½ç‚¹å°±æ˜¯ /var/lib/docker/aufs/mnt/ï¼Œæ¯”å¦‚ï¼š\n\n```bash\n/var/lib/docker/aufs/mnt/6e3be5d2ecccae7cc0fc...\n```\n\nä¸å‡ºæ„å¤–çš„è¯ï¼Œè¿™ä¸ªç›®å½•é‡Œé¢æ­£æ˜¯ä¸€ä¸ªå®Œæ•´çš„ Ubuntu æ“ä½œç³»ç»Ÿï¼š\n\n```bash\n$ ls /var/lib/docker/aufs/mnt/6e3be5d2ecccae7cc0fc...\nbin boot dev etc home lib lib64 media mnt opt proc root run sbin srv sys tmp usr var\n```\n\né‚£ä¹ˆï¼Œå‰é¢æåˆ°çš„äº”ä¸ªé•œåƒå±‚ï¼Œåˆæ˜¯å¦‚ä½•è¢«è”åˆæŒ‚è½½æˆè¿™æ ·ä¸€ä¸ªå®Œæ•´çš„ Ubuntu æ–‡ä»¶ç³»ç»Ÿçš„å‘¢ï¼Ÿ\n\nè¿™ä¸ªä¿¡æ¯è®°å½•åœ¨ AuFS çš„ç³»ç»Ÿç›®å½• /sys/fs/aufs ä¸‹é¢ã€‚\n\né¦–å…ˆï¼Œé€šè¿‡æŸ¥çœ‹ AuFS çš„æŒ‚è½½ä¿¡æ¯ï¼Œæˆ‘ä»¬å¯ä»¥æ‰¾åˆ°è¿™ä¸ªç›®å½•å¯¹åº”çš„ AuFS çš„å†…éƒ¨ IDï¼ˆä¹Ÿå«ï¼šsiï¼‰ï¼š\n\n```bash\n$ cat /proc/mounts| grep aufs\nnone /var/lib/docker/aufs/mnt/6e3be5d2ecccae7cc0fc... aufs rw,relatime,si=972c6d361e6b32ba\n```\n\nç„¶åä½¿ç”¨è¿™ä¸ª IDï¼Œä½ å°±å¯ä»¥åœ¨ /sys/fs/aufs ä¸‹æŸ¥çœ‹è¢«è”åˆæŒ‚è½½åœ¨ä¸€èµ·çš„å„ä¸ªå±‚çš„ä¿¡æ¯ï¼š\n\n```bash\n$ cat /sys/fs/aufs/si_972c6d361e6b32ba/br[0-9]*\n/var/lib/docker/aufs/diff/6e3be5d2ecccae7cc...=rw\n/var/lib/docker/aufs/diff/6e3be5d2ecccae7cc...-init=ro+wh\n/var/lib/docker/aufs/diff/32e8e20064858c0f2...=ro+wh\n/var/lib/docker/aufs/diff/2b8858809bce62e62...=ro+wh\n/var/lib/docker/aufs/diff/20707dce8efc0d267...=ro+wh\n/var/lib/docker/aufs/diff/72b0744e06247c7d0...=ro+wh\n/var/lib/docker/aufs/diff/a524a729adadedb90...=ro+wh\n```\n\nä»è¿™äº›ä¿¡æ¯é‡Œï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œé•œåƒçš„å±‚éƒ½æ”¾ç½®åœ¨ /var/lib/docker/aufs/diff ç›®å½•ä¸‹ï¼Œç„¶åè¢«è”åˆæŒ‚è½½åœ¨ /var/lib/docker/aufs/mnt é‡Œé¢ã€‚\n\n**è€Œä¸”ï¼Œä»è¿™ä¸ªç»“æ„å¯ä»¥çœ‹å‡ºæ¥ï¼Œè¿™ä¸ªå®¹å™¨çš„ rootfs ç”±å¦‚ä¸‹å›¾æ‰€ç¤ºçš„ä¸‰éƒ¨åˆ†ç»„æˆï¼š**\n\n![rootfs](/img/2023-01-04-ç™½è¯å®¹å™¨åŸºç¡€ï¼ˆä¸‰ï¼‰ï¼šæ·±å…¥ç†è§£å®¹å™¨é•œåƒ/pho1.png)\n\n### ç¬¬ä¸€éƒ¨åˆ†ï¼Œåªè¯»å±‚\n\nå®ƒæ˜¯è¿™ä¸ªå®¹å™¨çš„ rootfs æœ€ä¸‹é¢çš„äº”å±‚ï¼Œå¯¹åº”çš„æ­£æ˜¯ ubuntu:latest é•œåƒçš„äº”å±‚ã€‚å¯ä»¥çœ‹åˆ°ï¼Œå®ƒä»¬çš„æŒ‚è½½æ–¹å¼éƒ½æ˜¯åªè¯»çš„ï¼ˆro+whï¼Œå³ readonly+whiteoutï¼‰ã€‚\n\nè¿™æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥åˆ†åˆ«æŸ¥çœ‹ä¸€ä¸‹è¿™äº›å±‚çš„å†…å®¹ï¼š\n\n```bash\n$ ls /var/lib/docker/aufs/diff/72b0744e06247c7d0...\netc sbin usr var\n$ ls /var/lib/docker/aufs/diff/32e8e20064858c0f2...\nrun\n$ ls /var/lib/docker/aufs/diff/a524a729adadedb900...\nbin boot dev etc home lib lib64 media mnt opt proc root run sbin srv sys tmp usr var\n```\n\nå¯ä»¥çœ‹åˆ°ï¼Œè¿™äº›å±‚ï¼Œéƒ½ä»¥å¢é‡çš„æ–¹å¼åˆ†åˆ«åŒ…å«äº† Ubuntu æ“ä½œç³»ç»Ÿçš„ä¸€éƒ¨åˆ†ã€‚\n\n### ç¬¬äºŒéƒ¨åˆ†ï¼Œå¯è¯»å†™å±‚\n\nå®ƒæ˜¯è¿™ä¸ªå®¹å™¨çš„ rootfs æœ€ä¸Šé¢çš„ä¸€å±‚ï¼ˆ6e3be5d2ecccae7ccï¼‰ï¼Œå®ƒçš„æŒ‚è½½æ–¹å¼ä¸ºï¼šrwï¼Œå³ read writeã€‚åœ¨æ²¡æœ‰å†™å…¥æ–‡ä»¶ä¹‹å‰ï¼Œè¿™ä¸ªç›®å½•æ˜¯ç©ºçš„ã€‚è€Œä¸€æ—¦åœ¨å®¹å™¨é‡Œåšäº†å†™æ“ä½œï¼Œä½ ä¿®æ”¹æ‰€äº§ç”Ÿçš„å†…å®¹å°±ä¼šä»¥å¢é‡çš„æ–¹å¼å‡ºç°åœ¨è¿™ä¸ªå±‚ä¸­ã€‚\n\nå¯æ˜¯ï¼Œä½ æœ‰æ²¡æœ‰æƒ³åˆ°è¿™æ ·ä¸€ä¸ªé—®é¢˜ï¼šå¦‚æœæˆ‘ç°åœ¨è¦åšçš„æ˜¯ï¼Œåˆ é™¤åªè¯»å±‚é‡Œçš„ä¸€ä¸ªæ–‡ä»¶å‘¢ï¼Ÿ\n\n<font color='pink'>ä¸ºäº†å®ç°è¿™æ ·çš„åˆ é™¤æ“ä½œï¼ŒAuFS ä¼šåœ¨å¯è¯»å†™å±‚åˆ›å»ºä¸€ä¸ª whiteout æ–‡ä»¶ï¼ŒæŠŠåªè¯»å±‚é‡Œçš„æ–‡ä»¶â€œé®æŒ¡â€èµ·æ¥ã€‚</font>\n\næ¯”å¦‚ï¼Œä½ è¦åˆ é™¤åªè¯»å±‚é‡Œä¸€ä¸ªåå« foo çš„æ–‡ä»¶ï¼Œé‚£ä¹ˆè¿™ä¸ªåˆ é™¤æ“ä½œå®é™…ä¸Šæ˜¯åœ¨å¯è¯»å†™å±‚åˆ›å»ºäº†ä¸€ä¸ªåå« .wh.foo çš„æ–‡ä»¶ã€‚è¿™æ ·ï¼Œå½“è¿™ä¸¤ä¸ªå±‚è¢«è”åˆæŒ‚è½½ä¹‹åï¼Œfoo æ–‡ä»¶å°±ä¼šè¢« .wh.foo æ–‡ä»¶â€œé®æŒ¡â€èµ·æ¥ï¼Œâ€œæ¶ˆå¤±â€äº†ã€‚è¿™ä¸ªåŠŸèƒ½ï¼Œå°±æ˜¯â€œro+whâ€çš„æŒ‚è½½æ–¹å¼ï¼Œå³åªè¯» +whiteout çš„å«ä¹‰ã€‚\n\næ‰€ä»¥ï¼Œæœ€ä¸Šé¢è¿™ä¸ªå¯è¯»å†™å±‚çš„ä½œç”¨ï¼Œå°±æ˜¯ä¸“é—¨ç”¨æ¥å­˜æ”¾ä½ ä¿®æ”¹ rootfs åäº§ç”Ÿçš„å¢é‡ï¼Œæ— è®ºæ˜¯å¢ã€åˆ ã€æ”¹ï¼Œéƒ½å‘ç”Ÿåœ¨è¿™é‡Œã€‚è€Œå½“æˆ‘ä»¬ä½¿ç”¨å®Œäº†è¿™ä¸ªè¢«ä¿®æ”¹è¿‡çš„å®¹å™¨ä¹‹åï¼Œè¿˜å¯ä»¥ä½¿ç”¨docker commit å’Œ push æŒ‡ä»¤ï¼Œä¿å­˜è¿™ä¸ªè¢«ä¿®æ”¹è¿‡çš„å¯è¯»å†™å±‚ï¼Œå¹¶ä¸Šä¼ åˆ° Docker Hub ä¸Šï¼Œä¾›å…¶ä»–äººä½¿ç”¨ï¼›è€Œä¸æ­¤åŒæ—¶ï¼ŒåŸå…ˆçš„åªè¯»å±‚é‡Œçš„å†…å®¹åˆ™ä¸ä¼šæœ‰ä»»ä½•å˜åŒ–ã€‚è¿™ï¼Œå°±æ˜¯å¢é‡ rootfs çš„å¥½å¤„ã€‚\n\n### ç¬¬ä¸‰éƒ¨åˆ†ï¼ŒInit å±‚\n\nå®ƒæ˜¯ä¸€ä¸ªä»¥â€œ-initâ€ç»“å°¾çš„å±‚ï¼Œå¤¹åœ¨åªè¯»å±‚å’Œè¯»å†™å±‚ä¹‹é—´ã€‚Init å±‚æ˜¯ Docker é¡¹ç›®å•ç‹¬ç”Ÿæˆçš„ä¸€ä¸ªå†…éƒ¨å±‚ï¼Œä¸“é—¨ç”¨æ¥å­˜æ”¾ /etc/hostsã€/etc/resolv.conf ç­‰ä¿¡æ¯ã€‚\n\néœ€è¦è¿™æ ·ä¸€å±‚çš„åŸå› æ˜¯ï¼Œè¿™äº›æ–‡ä»¶æœ¬æ¥å±äºåªè¯»çš„ Ubuntu é•œåƒçš„ä¸€éƒ¨åˆ†ï¼Œä½†æ˜¯ç”¨æˆ·å¾€å¾€éœ€è¦åœ¨å¯åŠ¨å®¹å™¨æ—¶å†™å…¥ä¸€äº›æŒ‡å®šçš„å€¼æ¯”å¦‚ hostnameï¼Œæ‰€ä»¥å°±éœ€è¦åœ¨å¯è¯»å†™å±‚å¯¹å®ƒä»¬è¿›è¡Œä¿®æ”¹ã€‚\n\nå¯æ˜¯ï¼Œè¿™äº›ä¿®æ”¹å¾€å¾€åªå¯¹å½“å‰çš„å®¹å™¨æœ‰æ•ˆï¼Œæˆ‘ä»¬å¹¶ä¸å¸Œæœ›æ‰§è¡Œ docker commit æ—¶ï¼ŒæŠŠè¿™äº›ä¿¡æ¯è¿åŒå¯è¯»å†™å±‚ä¸€èµ·æäº¤æ‰ã€‚\n\næ‰€ä»¥ï¼ŒDocker åšæ³•æ˜¯ï¼Œåœ¨ä¿®æ”¹äº†è¿™äº›æ–‡ä»¶ä¹‹åï¼Œä»¥ä¸€ä¸ªå•ç‹¬çš„å±‚æŒ‚è½½äº†å‡ºæ¥ã€‚è€Œç”¨æˆ·æ‰§è¡Œdocker commit åªä¼šæäº¤å¯è¯»å†™å±‚ï¼Œæ‰€ä»¥æ˜¯ä¸åŒ…å«è¿™äº›å†…å®¹çš„ã€‚\n\næœ€ç»ˆï¼Œè¿™ 7 ä¸ªå±‚éƒ½è¢«è”åˆæŒ‚è½½åˆ° /var/lib/docker/aufs/mnt ç›®å½•ä¸‹ï¼Œè¡¨ç°ä¸ºä¸€ä¸ªå®Œæ•´çš„ Ubuntu æ“ä½œç³»ç»Ÿä¾›å®¹å™¨ä½¿ç”¨ã€‚\n\n## æ€»ç»“\nLinux å®¹å™¨æ–‡ä»¶ç³»ç»Ÿçš„å®ç°æ–¹å¼æœºåˆ¶ï¼šrootfsã€‚å®ƒåªæ˜¯ä¸€ä¸ªæ“ä½œç³»ç»Ÿçš„æ‰€æœ‰æ–‡ä»¶å’Œç›®å½•ï¼Œå¹¶ä¸åŒ…å«å†…æ ¸ï¼Œæœ€å¤šä¹Ÿå°±å‡ ç™¾å…†ã€‚è€Œç›¸æ¯”ä¹‹ä¸‹ï¼Œä¼ ç»Ÿè™šæ‹Ÿæœºçš„é•œåƒå¤§å¤šæ˜¯ä¸€ä¸ªç£ç›˜çš„â€œå¿«ç…§â€ï¼Œç£ç›˜æœ‰å¤šå¤§ï¼Œé•œåƒå°±è‡³å°‘æœ‰å¤šå¤§ã€‚\n\né€šè¿‡ç»“åˆä½¿ç”¨ Mount Namespace å’Œ rootfsï¼Œå®¹å™¨å°±èƒ½å¤Ÿä¸ºè¿›ç¨‹æ„å»ºå‡ºä¸€ä¸ªå®Œå–„çš„æ–‡ä»¶ç³»ç»Ÿéš”ç¦»ç¯å¢ƒã€‚å½“ç„¶ï¼Œè¿™ä¸ªåŠŸèƒ½çš„å®ç°è¿˜å¿…é¡»æ„Ÿè°¢ chroot å’Œ pivot_root è¿™ä¸¤ä¸ªç³»ç»Ÿè°ƒç”¨åˆ‡æ¢è¿›ç¨‹æ ¹ç›®å½•çš„èƒ½åŠ›ã€‚\n\nè€Œåœ¨ rootfs çš„åŸºç¡€ä¸Šï¼ŒDocker å…¬å¸åˆ›æ–°æ€§åœ°æå‡ºäº†ä½¿ç”¨å¤šä¸ªå¢é‡ rootfs è”åˆæŒ‚è½½ä¸€ä¸ªå®Œæ•´ rootfs çš„æ–¹æ¡ˆï¼Œè¿™å°±æ˜¯å®¹å™¨é•œåƒä¸­â€œå±‚â€çš„æ¦‚å¿µã€‚\n\né€šè¿‡â€œåˆ†å±‚é•œåƒâ€çš„è®¾è®¡ï¼Œä»¥ Docker é•œåƒä¸ºæ ¸å¿ƒï¼Œæ¥è‡ªä¸åŒå…¬å¸ã€ä¸åŒå›¢é˜Ÿçš„æŠ€æœ¯äººå‘˜è¢«ç´§å¯†åœ°è”ç³»åœ¨äº†ä¸€èµ·ã€‚è€Œä¸”ï¼Œç”±äºå®¹å™¨é•œåƒçš„æ“ä½œæ˜¯å¢é‡å¼çš„ï¼Œè¿™æ ·æ¯æ¬¡é•œåƒæ‹‰å–ã€æ¨é€çš„å†…å®¹ï¼Œæ¯”åŸæœ¬å¤šä¸ªå®Œæ•´çš„æ“ä½œç³»ç»Ÿçš„å¤§å°è¦å°å¾—å¤šï¼›è€Œå…±äº«å±‚çš„å­˜åœ¨ï¼Œå¯ä»¥ä½¿å¾—æ‰€æœ‰è¿™äº›å®¹å™¨é•œåƒéœ€è¦çš„æ€»ç©ºé—´ï¼Œä¹Ÿæ¯”æ¯ä¸ªé•œåƒçš„æ€»å’Œè¦å°ã€‚è¿™æ ·å°±ä½¿å¾—åŸºäºå®¹å™¨é•œåƒçš„å›¢é˜Ÿåä½œï¼Œè¦æ¯”åŸºäºåŠ¨åˆ™å‡ ä¸ª GB çš„è™šæ‹Ÿæœºç£ç›˜é•œåƒçš„åä½œè¦æ•æ·å¾—å¤šã€‚\n\næ›´é‡è¦çš„æ˜¯ï¼Œä¸€æ—¦è¿™ä¸ªé•œåƒè¢«å‘å¸ƒï¼Œé‚£ä¹ˆä½ åœ¨å…¨ä¸–ç•Œçš„ä»»ä½•ä¸€ä¸ªåœ°æ–¹ä¸‹è½½è¿™ä¸ªé•œåƒï¼Œå¾—åˆ°çš„å†…å®¹éƒ½å®Œå…¨ä¸€è‡´ï¼Œå¯ä»¥å®Œå…¨å¤ç°è¿™ä¸ªé•œåƒåˆ¶ä½œè€…å½“åˆçš„å®Œæ•´ç¯å¢ƒã€‚è¿™ï¼Œå°±æ˜¯å®¹å™¨æŠ€æœ¯â€œå¼ºä¸€è‡´æ€§â€çš„é‡è¦ä½“ç°ã€‚\n\nè€Œè¿™ç§ä»·å€¼æ­£æ˜¯æ”¯æ’‘ Docker å…¬å¸åœ¨ 2014~2016 å¹´é—´è¿…çŒ›å‘å±•çš„æ ¸å¿ƒåŠ¨åŠ›ã€‚å®¹å™¨é•œåƒçš„å‘æ˜ï¼Œä¸ä»…æ‰“é€šäº†â€œå¼€å‘ - æµ‹è¯• - éƒ¨ç½²â€æµç¨‹çš„æ¯ä¸€ä¸ªç¯èŠ‚ï¼Œæ›´é‡è¦çš„æ˜¯ï¼š\n\n<center>\n    <font color=\"red\">\n        å®¹å™¨é•œåƒå°†ä¼šæˆä¸ºæœªæ¥è½¯ä»¶çš„ä¸»æµå‘å¸ƒæ–¹å¼ã€‚\n    </font>\n</center>","tags":["docker","å­¦ä¹ ç¬”è®°"]},{"title":"ç™½è¯å®¹å™¨åŸºç¡€ï¼ˆäºŒï¼‰ï¼šéš”ç¦»ä¸é™åˆ¶","url":"/2022/12/19/2022-12-29-ç™½è¯å®¹å™¨åŸºç¡€ï¼ˆäºŒï¼‰ï¼šéš”ç¦»ä¸é™åˆ¶/","content":"\n## å®¹å™¨åŸºç¡€ â€”â€” éš”ç¦»\n\n### æ€è€ƒ\n\n![è™šæ‹Ÿæœºå’Œå®¹å™¨çš„å¯¹æ¯”å›¾](/img/2022-12-29-ç™½è¯å®¹å™¨åŸºç¡€ï¼ˆäºŒï¼‰ï¼šéš”ç¦»ä¸é™åˆ¶/pho1.png)\n\nåœ¨è¿™ä¸ªè™šæ‹Ÿæœºä¸å®¹å™¨æŠ€æœ¯çš„å¯¹æ¯”å›¾é‡Œï¼Œåº”ä¸åº”è¯¥æŠŠ Docker Engine æˆ–è€…ä»»ä½•å®¹å™¨ç®¡ç†å·¥å…·æ”¾åœ¨è·Ÿ Hypervisor ç›¸åŒçš„ä½ç½®ï¼Ÿ\n\nåœ¨<a href=\"../12/ç™½è¯å®¹å™¨åŸºç¡€-ä¸€-ä»è¿›ç¨‹è¯´å¼€å».html\">ã€Šç™½è¯å®¹å™¨åŸºç¡€ï¼ˆä¸€ï¼‰ï¼šä»è¿›ç¨‹è¯´å¼€å»ã€‹</a>ä¸­è¯¦ç»†ä»‹ç»äº† Linux å®¹å™¨ä¸­ç”¨æ¥å®ç°â€œéš”ç¦»â€çš„æŠ€æœ¯æ‰‹æ®µï¼š**Namespace**ã€‚è€Œé€šè¿‡è¿™äº›è®²è§£ï¼Œä½ åº”è¯¥èƒ½å¤Ÿæ˜ç™½ï¼ŒNamespace æŠ€æœ¯å®é™…ä¸Šåªæ˜¯ä¿®æ”¹äº†åº”ç”¨è¿›ç¨‹çœ‹å¾…æ•´ä¸ªè®¡ç®—æœºâ€œè§†å›¾â€ï¼Œå³å®ƒçš„â€œè§†çº¿â€è¢«æ“ä½œç³»ç»Ÿåšäº†é™åˆ¶ï¼Œåªèƒ½â€œçœ‹åˆ°â€æŸäº›æŒ‡å®šçš„å†…å®¹ã€‚ä½†å¯¹äºå®¿ä¸»æœºæ¥è¯´ï¼Œè¿™äº›è¢«â€œéš”ç¦»â€äº†çš„è¿›ç¨‹è·Ÿå…¶ä»–è¿›ç¨‹å¹¶æ²¡æœ‰å¤ªå¤§åŒºåˆ«ã€‚\n\næˆ‘ç›¸ä¿¡ä½ åº”è¯¥æœ‰äº†æ€è€ƒçš„ç­”æ¡ˆï¼Œé‚£å°±æ˜¯ä¸åº”è¯¥ã€‚å› ä¸ºå®ƒä»¬ï¼ˆDocker Engine æˆ–è€…ä»»ä½•å®¹å™¨ç®¡ç†å·¥å…·ï¼‰å¹¶ä¸åƒ Hypervisor é‚£æ ·å¯¹åº”ç”¨è¿›ç¨‹çš„éš”ç¦»ç¯å¢ƒè´Ÿè´£ï¼Œä¹Ÿä¸ä¼šåˆ›å»ºä»»ä½•å®ä½“çš„â€œå®¹å™¨â€ï¼ŒçœŸæ­£å¯¹éš”ç¦»ç¯å¢ƒè´Ÿè´£çš„æ˜¯å®¿ä¸»æœºæ“ä½œç³»ç»Ÿæœ¬èº«ï¼š\n\n![è™šæ‹Ÿæœºå’Œå®¹å™¨çš„å¯¹æ¯”å›¾](/img/2022-12-29-ç™½è¯å®¹å™¨åŸºç¡€ï¼ˆäºŒï¼‰ï¼šéš”ç¦»ä¸é™åˆ¶/pho2.png)\n\næ‰€ä»¥ï¼Œåœ¨è¿™ä¸ªå¯¹æ¯”å›¾é‡Œï¼Œæˆ‘ä»¬åº”è¯¥æŠŠ Docker ç”»åœ¨è·Ÿåº”ç”¨åŒçº§åˆ«å¹¶ä¸”é è¾¹çš„ä½ç½®ã€‚è¿™æ„å‘³ç€ï¼Œç”¨æˆ·è¿è¡Œåœ¨å®¹å™¨é‡Œçš„åº”ç”¨è¿›ç¨‹ï¼Œè·Ÿå®¿ä¸»æœºä¸Šçš„å…¶ä»–è¿›ç¨‹ä¸€æ ·ï¼Œéƒ½ç”±å®¿ä¸»æœºæ“ä½œç³»ç»Ÿç»Ÿä¸€ç®¡ç†ï¼Œåªä¸è¿‡è¿™äº›è¢«éš”ç¦»çš„è¿›ç¨‹æ‹¥æœ‰é¢å¤–è®¾ç½®è¿‡çš„ Namespace å‚æ•°ã€‚è€Œ Docker é¡¹ç›®åœ¨è¿™é‡Œæ‰®æ¼”çš„è§’è‰²ï¼Œæ›´å¤šçš„æ˜¯æ—è·¯å¼çš„è¾…åŠ©å’Œç®¡ç†å·¥ä½œï¼Œç”šè‡³åœ¨æŸäº›æƒ…å†µä¸‹å¯ä»¥è¢«å»æ‰ã€‚\n\n**è¿™æ ·çš„æ¶æ„ä¹Ÿè§£é‡Šäº†ä¸ºä»€ä¹ˆ Docker é¡¹ç›®æ¯”è™šæ‹Ÿæœºæ›´å—æ¬¢è¿çš„åŸå› ã€‚**\n\nè¿™æ˜¯å› ä¸ºï¼Œä½¿ç”¨è™šæ‹ŸåŒ–æŠ€æœ¯ä½œä¸ºåº”ç”¨æ²™ç›’ï¼Œå°±å¿…é¡»è¦ç”± Hypervisor æ¥è´Ÿè´£åˆ›å»ºè™šæ‹Ÿæœºï¼Œè¿™ä¸ªè™šæ‹Ÿæœºæ˜¯çœŸå®å­˜åœ¨çš„ï¼Œå¹¶ä¸”å®ƒé‡Œé¢å¿…é¡»è¿è¡Œä¸€ä¸ªå®Œæ•´çš„ Guest OS æ‰èƒ½æ‰§è¡Œç”¨æˆ·çš„åº”ç”¨è¿›ç¨‹ã€‚è¿™å°±ä¸å¯é¿å…åœ°å¸¦æ¥äº†é¢å¤–çš„èµ„æºæ¶ˆè€—å’Œå ç”¨ã€‚\n\næ ¹æ®å®éªŒï¼Œä¸€ä¸ªè¿è¡Œç€ CentOS çš„ KVM è™šæ‹Ÿæœºå¯åŠ¨åï¼Œåœ¨ä¸åšä¼˜åŒ–çš„æƒ…å†µä¸‹ï¼Œè™šæ‹Ÿæœºè‡ªå·±å°±éœ€è¦å ç”¨ 100~200 MB å†…å­˜ã€‚æ­¤å¤–ï¼Œç”¨æˆ·åº”ç”¨è¿è¡Œåœ¨è™šæ‹Ÿæœºé‡Œé¢ï¼Œå®ƒå¯¹å®¿ä¸»æœºæ“ä½œç³»ç»Ÿçš„è°ƒç”¨å°±ä¸å¯é¿å…åœ°è¦ç»è¿‡è™šæ‹ŸåŒ–è½¯ä»¶çš„æ‹¦æˆªå’Œå¤„ç†ï¼Œè¿™æœ¬èº«åˆæ˜¯ä¸€å±‚æ€§èƒ½æŸè€—ï¼Œå°¤å…¶å¯¹è®¡ç®—èµ„æºã€ç½‘ç»œå’Œç£ç›˜ I/O çš„æŸè€—éå¸¸å¤§ã€‚\n\nè€Œç›¸æ¯”ä¹‹ä¸‹ï¼Œå®¹å™¨åŒ–åçš„ç”¨æˆ·åº”ç”¨ï¼Œå´ä¾ç„¶è¿˜æ˜¯ä¸€ä¸ªå®¿ä¸»æœºä¸Šçš„æ™®é€šè¿›ç¨‹ï¼Œè¿™å°±æ„å‘³ç€è¿™äº›å› ä¸ºè™šæ‹ŸåŒ–è€Œå¸¦æ¥çš„æ€§èƒ½æŸè€—éƒ½æ˜¯ä¸å­˜åœ¨çš„ï¼›è€Œå¦ä¸€æ–¹é¢ï¼Œä½¿ç”¨ Namespace ä½œä¸ºéš”ç¦»æ‰‹æ®µçš„å®¹å™¨å¹¶ä¸éœ€è¦å•ç‹¬çš„ Guest OSï¼Œè¿™å°±ä½¿å¾—å®¹å™¨é¢å¤–çš„èµ„æºå ç”¨å‡ ä¹å¯ä»¥å¿½ç•¥ä¸è®¡ã€‚\n\næ‰€ä»¥è¯´ï¼Œ**ç›¸è¾ƒäºè™šæ‹Ÿæœºï¼Œå®¹å™¨æœ€å¤§çš„ä¼˜åŠ¿æ˜¯â€œæ•æ·â€å’Œâ€œé«˜æ€§èƒ½â€ï¼Œä¹Ÿæ˜¯å®ƒèƒ½å¤Ÿåœ¨ PaaS è¿™ç§æ›´ç»†ç²’åº¦çš„èµ„æºç®¡ç†å¹³å°ä¸Šè”šç„¶æˆé£çš„é‡è¦åŸå› ã€‚**\n\nä¸è¿‡ï¼Œæœ‰åˆ©å°±æœ‰å¼Šï¼ŒåŸºäº Linux Namespace çš„éš”ç¦»æœºåˆ¶ç›¸æ¯”äºè™šæ‹ŸåŒ–æŠ€æœ¯ä¹Ÿæœ‰å¾ˆå¤šä¸è¶³ä¹‹å¤„ï¼Œå…¶ä¸­æœ€ä¸»è¦çš„é—®é¢˜å°±æ˜¯ï¼š**éš”ç¦»å¾—ä¸å½»åº•**ã€‚\n\n<font color='pink'>é¦–å…ˆï¼Œæ—¢ç„¶å®¹å™¨åªæ˜¯è¿è¡Œåœ¨å®¿ä¸»æœºä¸Šçš„ä¸€ç§ç‰¹æ®Šçš„è¿›ç¨‹ï¼Œé‚£ä¹ˆå¤šä¸ªå®¹å™¨ä¹‹é—´ä½¿ç”¨çš„å°±è¿˜æ˜¯åŒä¸€ä¸ªå®¿ä¸»æœºçš„æ“ä½œç³»ç»Ÿå†…æ ¸ã€‚</font>\n\nå°½ç®¡ä½ å¯ä»¥åœ¨å®¹å™¨é‡Œé€šè¿‡ Mount Namespace å•ç‹¬æŒ‚è½½å…¶ä»–ä¸åŒç‰ˆæœ¬çš„æ“ä½œç³»ç»Ÿæ–‡ä»¶ï¼Œæ¯”å¦‚ CentOS æˆ–è€… Ubuntuï¼Œä½†è¿™å¹¶ä¸èƒ½æ”¹å˜å…±äº«å®¿ä¸»æœºå†…æ ¸çš„äº‹å®ã€‚è¿™æ„å‘³ç€ï¼Œå¦‚æœä½ è¦åœ¨ Windows å®¿ä¸»æœºä¸Šè¿è¡Œ Linux å®¹å™¨ï¼Œæˆ–è€…åœ¨ä½ç‰ˆæœ¬çš„ Linux å®¿ä¸»æœºä¸Šè¿è¡Œé«˜ç‰ˆæœ¬çš„ \nLinux å®¹å™¨ï¼Œéƒ½æ˜¯è¡Œä¸é€šçš„ã€‚\n\nè€Œç›¸æ¯”ä¹‹ä¸‹ï¼Œæ‹¥æœ‰ç¡¬ä»¶è™šæ‹ŸåŒ–æŠ€æœ¯å’Œç‹¬ç«‹ Guest OS çš„è™šæ‹Ÿæœºå°±è¦æ–¹ä¾¿å¾—å¤šäº†ã€‚æœ€æç«¯çš„ä¾‹å­æ˜¯ï¼ŒMicrosoft çš„äº‘è®¡ç®—å¹³å° Azureï¼Œå®é™…ä¸Šå°±æ˜¯è¿è¡Œåœ¨ Windows æœåŠ¡å™¨é›†ç¾¤ä¸Šçš„ï¼Œä½†è¿™å¹¶ä¸å¦¨ç¢ä½ åœ¨å®ƒä¸Šé¢åˆ›å»ºå„ç§ Linux è™šæ‹Ÿæœºå‡ºæ¥ã€‚\n\n<font color='pink'>å…¶æ¬¡ï¼Œåœ¨ Linux å†…æ ¸ä¸­ï¼Œæœ‰å¾ˆå¤šèµ„æºå’Œå¯¹è±¡æ˜¯ä¸èƒ½è¢« Namespace åŒ–çš„ï¼Œæœ€å…¸å‹çš„ä¾‹å­å°±æ˜¯ï¼šæ—¶é—´ã€‚</font>\n\nè¿™å°±æ„å‘³ç€ï¼Œå¦‚æœä½ çš„å®¹å™¨ä¸­çš„ç¨‹åºä½¿ç”¨ settimeofday(2) ç³»ç»Ÿè°ƒç”¨ä¿®æ”¹äº†æ—¶é—´ï¼Œæ•´ä¸ªå®¿ä¸»æœºçš„æ—¶é—´éƒ½ä¼šè¢«éšä¹‹ä¿®æ”¹ï¼Œè¿™æ˜¾ç„¶ä¸ç¬¦åˆç”¨æˆ·çš„é¢„æœŸã€‚ç›¸æ¯”äºåœ¨è™šæ‹Ÿæœºé‡Œé¢å¯ä»¥éšä¾¿æŠ˜è…¾çš„è‡ªç”±åº¦ï¼Œåœ¨å®¹å™¨é‡Œéƒ¨ç½²åº”ç”¨çš„æ—¶å€™ï¼Œâ€œä»€ä¹ˆèƒ½åšï¼Œä»€ä¹ˆä¸èƒ½åšâ€ï¼Œå°±æ˜¯ç”¨æˆ·å¿…é¡»è€ƒè™‘çš„ä¸€ä¸ªé—®é¢˜ã€‚\n\næ­¤å¤–ï¼Œç”±äºä¸Šè¿°é—®é¢˜ï¼Œå°¤å…¶æ˜¯å…±äº«å®¿ä¸»æœºå†…æ ¸çš„äº‹å®ï¼Œå®¹å™¨ç»™åº”ç”¨æš´éœ²å‡ºæ¥çš„æ”»å‡»é¢æ˜¯ç›¸å½“å¤§çš„ï¼Œåº”ç”¨â€œè¶Šç‹±â€çš„éš¾åº¦è‡ªç„¶ä¹Ÿæ¯”è™šæ‹Ÿæœºä½å¾—å¤šã€‚\n\næ›´ä¸ºæ£˜æ‰‹çš„æ˜¯ï¼Œå°½ç®¡åœ¨å®è·µä¸­æˆ‘ä»¬ç¡®å®å¯ä»¥ä½¿ç”¨ Seccomp ç­‰æŠ€æœ¯ï¼Œå¯¹å®¹å™¨å†…éƒ¨å‘èµ·çš„æ‰€æœ‰ç³»ç»Ÿè°ƒç”¨è¿›è¡Œè¿‡æ»¤å’Œç”„åˆ«æ¥è¿›è¡Œå®‰å…¨åŠ å›ºï¼Œä½†è¿™ç§æ–¹æ³•å› ä¸ºå¤šäº†ä¸€å±‚å¯¹ç³»ç»Ÿè°ƒç”¨çš„è¿‡æ»¤ï¼Œä¸€å®šä¼šæ‹–ç´¯å®¹å™¨çš„æ€§èƒ½ã€‚ä½•å†µï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œè°ä¹Ÿä¸çŸ¥é“åˆ°åº•è¯¥å¼€å¯å“ªäº›ç³»ç»Ÿè°ƒç”¨ï¼Œç¦æ­¢å“ªäº›ç³»ç»Ÿè°ƒç”¨ã€‚\n\næ‰€ä»¥ï¼Œåœ¨ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œæ²¡æœ‰äººæ•¢æŠŠè¿è¡Œåœ¨ç‰©ç†æœºä¸Šçš„ Linux å®¹å™¨ç›´æ¥æš´éœ²åˆ°å…¬ç½‘ä¸Šã€‚\n\n## å®¹å™¨åŸºç¡€ â€”â€” é™åˆ¶\n\n### æ€è€ƒ\næˆ‘ä»¬ä¸æ˜¯å·²ç»é€šè¿‡ Linux Namespace åˆ›å»ºäº†ä¸€ä¸ªâ€œå®¹å™¨â€å—ï¼Œä¸ºä»€ä¹ˆè¿˜éœ€è¦å¯¹å®¹å™¨åšâ€œé™åˆ¶â€å‘¢ï¼Ÿ\n\nä»¥ PID Namespace ä¸ºä¾‹ï¼š\n\n&emsp;&emsp;è™½ç„¶å®¹å™¨å†…çš„ç¬¬ 1 å·è¿›ç¨‹åœ¨â€œéšœçœ¼æ³•â€çš„å¹²æ‰°ä¸‹åªèƒ½çœ‹åˆ°å®¹å™¨é‡Œçš„æƒ…å†µï¼Œä½†æ˜¯å®¿ä¸»æœºä¸Šï¼Œå®ƒä½œä¸ºç¬¬ 100 å·è¿›ç¨‹ä¸å…¶ä»–æ‰€æœ‰è¿›ç¨‹ä¹‹é—´ä¾ç„¶æ˜¯å¹³ç­‰çš„ç«äº‰å…³ç³»ã€‚è¿™å°±æ„å‘³ç€ï¼Œè™½ç„¶ç¬¬ 100 å·è¿›ç¨‹è¡¨é¢ä¸Šè¢«éš”ç¦»äº†èµ·æ¥ï¼Œä½†æ˜¯å®ƒæ‰€èƒ½å¤Ÿä½¿ç”¨åˆ°çš„èµ„æºï¼ˆæ¯”å¦‚ CPUã€å†…å­˜ï¼‰ï¼Œå´æ˜¯å¯ä»¥éšæ—¶è¢«å®¿ä¸»æœºä¸Šçš„å…¶ä»–è¿›ç¨‹ï¼ˆæˆ–è€…å…¶ä»–å®¹å™¨ï¼‰å ç”¨çš„ã€‚å½“ç„¶ï¼Œè¿™ä¸ª 100 å·è¿›ç¨‹è‡ªå·±ä¹Ÿå¯èƒ½æŠŠæ‰€æœ‰èµ„æºåƒå…‰ã€‚è¿™äº›æƒ…å†µï¼Œæ˜¾ç„¶éƒ½ä¸æ˜¯ä¸€ä¸ªâ€œæ²™ç›’â€åº”è¯¥è¡¨ç°å‡ºæ¥çš„åˆç†è¡Œä¸ºã€‚\n\nè€Œ Linux Cgroupsï¼ˆ Linux Control Group ï¼‰å°±æ˜¯ Linux å†…æ ¸ä¸­ç”¨æ¥ä¸ºè¿›ç¨‹è®¾ç½®èµ„æºé™åˆ¶çš„ä¸€ä¸ªé‡è¦åŠŸèƒ½ã€‚**å®ƒæœ€ä¸»è¦çš„ä½œç”¨ï¼Œå°±æ˜¯é™åˆ¶ä¸€ä¸ªè¿›ç¨‹ç»„èƒ½å¤Ÿä½¿ç”¨çš„èµ„æºä¸Šé™ï¼ŒåŒ…æ‹¬ CPUã€å†…å­˜ã€ç£ç›˜ã€ç½‘ç»œå¸¦å®½ç­‰ç­‰ã€‚**\n\nåœ¨ Linux ä¸­ï¼ŒCgroups ç»™ç”¨æˆ·æš´éœ²å‡ºæ¥çš„æ“ä½œæ¥å£æ˜¯æ–‡ä»¶ç³»ç»Ÿï¼Œå³å®ƒä»¥æ–‡ä»¶å’Œç›®å½•çš„æ–¹å¼ç»„ç»‡åœ¨æ“ä½œç³»ç»Ÿçš„ /sys/fs/cgroup è·¯å¾„ä¸‹ã€‚åœ¨ Red Hat 4.8.5-36 æœºå™¨é‡Œï¼Œæˆ‘å¯ä»¥ç”¨ mount æŒ‡ä»¤æŠŠå®ƒä»¬å±•ç¤ºå‡ºæ¥ï¼Œè¿™æ¡å‘½ä»¤æ˜¯ï¼š\n```bash\n$ mount -t cgroup\ncgroup on /sys/fs/cgroup/systemd type cgroup (rw,nosuid,nodev,noexec,relatime,xattr,release_agent=/usr/lib/systemd/systemd-cgroups-agent,name=systemd)\ncgroup on /sys/fs/cgroup/cpuset type cgroup (rw,nosuid,nodev,noexec,relatime,cpuset)\ncgroup on /sys/fs/cgroup/blkio type cgroup (rw,nosuid,nodev,noexec,relatime,blkio)\ncgroup on /sys/fs/cgroup/net_cls,net_prio type cgroup (rw,nosuid,nodev,noexec,relatime,net_prio,net_cls)\ncgroup on /sys/fs/cgroup/cpu,cpuacct type cgroup (rw,nosuid,nodev,noexec,relatime,cpuacct,cpu)\ncgroup on /sys/fs/cgroup/freezer type cgroup (rw,nosuid,nodev,noexec,relatime,freezer)\ncgroup on /sys/fs/cgroup/perf_event type cgroup (rw,nosuid,nodev,noexec,relatime,perf_event)\ncgroup on /sys/fs/cgroup/pids type cgroup (rw,nosuid,nodev,noexec,relatime,pids)\ncgroup on /sys/fs/cgroup/hugetlb type cgroup (rw,nosuid,nodev,noexec,relatime,hugetlb)\ncgroup on /sys/fs/cgroup/memory type cgroup (rw,nosuid,nodev,noexec,relatime,memory)\ncgroup on /sys/fs/cgroup/devices type cgroup (rw,nosuid,nodev,noexec,relatime,devices)\n```\n\nå®ƒçš„è¾“å‡ºç»“æœï¼Œæ˜¯ä¸€ç³»åˆ—æ–‡ä»¶ç³»ç»Ÿç›®å½•ã€‚å¦‚æœä½ åœ¨è‡ªå·±çš„æœºå™¨ä¸Šæ²¡æœ‰çœ‹åˆ°è¿™äº›ç›®å½•ï¼Œé‚£ä½ å°±éœ€è¦è‡ªå·±å»æŒ‚è½½ Cgroupsï¼Œå…·ä½“åšæ³•å¯ä»¥è‡ªè¡Œ Googleã€‚\n\nå¯ä»¥çœ‹åˆ°ï¼Œåœ¨ /sys/fs/cgroup ä¸‹é¢æœ‰å¾ˆå¤šè¯¸å¦‚ cpusetã€cpuã€ memory è¿™æ ·çš„å­ç›®å½•ï¼Œä¹Ÿå«å­ç³»ç»Ÿã€‚è¿™äº›éƒ½æ˜¯æˆ‘è¿™å°æœºå™¨å½“å‰å¯ä»¥è¢« Cgroups è¿›è¡Œé™åˆ¶çš„èµ„æºç§ç±»ã€‚è€Œåœ¨å­ç³»ç»Ÿå¯¹åº”çš„èµ„æºç§ç±»ä¸‹ï¼Œä½ å°±å¯ä»¥çœ‹åˆ°è¯¥ç±»èµ„æºå…·ä½“å¯ä»¥è¢«é™åˆ¶çš„æ–¹æ³•ã€‚æ¯”å¦‚ï¼Œå¯¹ CPU å­ç³»ç»Ÿ\næ¥è¯´ï¼Œæˆ‘ä»¬å°±å¯ä»¥çœ‹åˆ°å¦‚ä¸‹å‡ ä¸ªé…ç½®æ–‡ä»¶ï¼Œè¿™ä¸ªæŒ‡ä»¤æ˜¯ï¼š\n\n```bash\n$ ls /sys/fs/cgroup/cpu\ncgroup.clone_children  cpuacct.stat          cpu.cfs_quota_us   cpu.stat       notify_on_release\ncgroup.event_control   cpuacct.usage         cpu.rt_period_us   docker         release_agent\ncgroup.procs           cpuacct.usage_percpu  cpu.rt_runtime_us  kubepods       tasks\ncgroup.sane_behavior   cpu.cfs_period_us     cpu.shares         machine.slice\n```\n\nå¦‚æœç†Ÿæ‚‰ Linux CPU ç®¡ç†çš„è¯ï¼Œä½ å°±ä¼šåœ¨å®ƒçš„è¾“å‡ºé‡Œæ³¨æ„åˆ° cfs_period å’Œ cfs_quota è¿™æ ·çš„å…³é”®è¯ã€‚è¿™ä¸¤ä¸ªå‚æ•°éœ€è¦ç»„åˆä½¿ç”¨ï¼Œå¯ä»¥ç”¨æ¥é™åˆ¶è¿›ç¨‹åœ¨é•¿åº¦ä¸º cfs_period çš„ä¸€æ®µæ—¶é—´å†…ï¼Œåªèƒ½è¢«åˆ†é…åˆ°æ€»é‡ä¸º cfs_quota çš„ CPU æ—¶é—´ã€‚\n\nè€Œè¿™æ ·çš„é…ç½®æ–‡ä»¶åˆå¦‚ä½•ä½¿ç”¨å‘¢ï¼Ÿ\n\nä½ éœ€è¦åœ¨å¯¹åº”çš„å­ç³»ç»Ÿä¸‹é¢åˆ›å»ºä¸€ä¸ªç›®å½•ï¼Œæ¯”å¦‚ï¼Œæˆ‘ä»¬ç°åœ¨è¿›å…¥ /sys/fs/cgroup/cpu ç›®å½•ä¸‹ï¼š\n\n```bash\n[root@vqa129 cpu]# mkdir container\n[root@vqa129 cpu]# ls container/\ncgroup.clone_children cpu.cfs_period_us cpu.rt_period_us cpu.shares notify_on_release\ncgroup.procs cpu.cfs_quota_us cpu.rt_runtime_us cpu.stat tasks\n```\n\nè¿™ä¸ªç›®å½•å°±ç§°ä¸ºä¸€ä¸ªâ€œæ§åˆ¶ç»„â€ã€‚ä½ ä¼šå‘ç°ï¼Œæ“ä½œç³»ç»Ÿä¼šåœ¨ä½ æ–°åˆ›å»ºçš„ container ç›®å½•ä¸‹ï¼Œè‡ªåŠ¨ç”Ÿæˆè¯¥å­ç³»ç»Ÿå¯¹åº”çš„èµ„æºé™åˆ¶æ–‡ä»¶ã€‚\n\nç°åœ¨ï¼Œæˆ‘ä»¬åœ¨åå°æ‰§è¡Œè¿™æ ·ä¸€æ¡è„šæœ¬ï¼š\n\n```bash\n$ while : ; do : ; done &\n[1] 226\n```\n\næ˜¾ç„¶ï¼Œå®ƒæ‰§è¡Œäº†ä¸€ä¸ªæ­»å¾ªç¯ï¼Œå¯ä»¥æŠŠè®¡ç®—æœºçš„ CPU åƒåˆ° 100%ï¼Œæ ¹æ®å®ƒçš„è¾“å‡ºï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°è¿™ä¸ªè„šæœ¬åœ¨åå°è¿è¡Œçš„è¿›ç¨‹å·ï¼ˆPIDï¼‰æ˜¯ 226ã€‚\n\nè¿™æ ·ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨ top æŒ‡ä»¤æ¥ç¡®è®¤ä¸€ä¸‹ CPU æœ‰æ²¡æœ‰è¢«æ‰“æ»¡ï¼š\n\n```bash\n$ top\n%Cpu0 :100.0 us, 0.0 sy, 0.0 ni, 0.0 id, 0.0 wa, 0.0 hi, 0.0 si, 0.0 st\n```\n\nåœ¨è¾“å‡ºé‡Œå¯ä»¥çœ‹åˆ°ï¼ŒCPU çš„ä½¿ç”¨ç‡å·²ç» 100% äº†ï¼ˆ%Cpu0 :100.0 usï¼‰ã€‚\n\nè€Œæ­¤æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡æŸ¥çœ‹ container ç›®å½•ä¸‹çš„æ–‡ä»¶ï¼Œçœ‹åˆ° container æ§åˆ¶ç»„é‡Œçš„ CPU quota è¿˜æ²¡æœ‰ä»»ä½•é™åˆ¶ï¼ˆå³ï¼š-1ï¼‰ï¼ŒCPU period åˆ™æ˜¯é»˜è®¤çš„ 100 msï¼ˆ100000 usï¼‰ï¼š\n\n```bash\n$ cat /sys/fs/cgroup/cpu/container/cpu.cfs_quota_us \n-1\n$ cat /sys/fs/cgroup/cpu/container/cpu.cfs_period_us \n100000\n```\n\næ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ä¿®æ”¹è¿™äº›æ–‡ä»¶çš„å†…å®¹æ¥è®¾ç½®é™åˆ¶ã€‚\n\næ¯”å¦‚ï¼Œå‘ container ç»„é‡Œçš„ cfs_quota æ–‡ä»¶å†™å…¥ 20 msï¼ˆ20000 usï¼‰ï¼š\n\n```bash\n$ echo 20000 > /sys/fs/cgroup/cpu/container/cpu.cfs_quota_us\n```\n\nç»“åˆå‰é¢çš„ä»‹ç»ï¼Œä½ åº”è¯¥èƒ½æ˜ç™½è¿™ä¸ªæ“ä½œçš„å«ä¹‰ï¼Œå®ƒæ„å‘³ç€åœ¨æ¯ 100 ms çš„æ—¶é—´é‡Œï¼Œè¢«è¯¥æ§åˆ¶ç»„é™åˆ¶çš„è¿›ç¨‹åªèƒ½ä½¿ç”¨ 20 ms çš„ CPU æ—¶é—´ï¼Œä¹Ÿå°±æ˜¯è¯´è¿™ä¸ªè¿›ç¨‹åªèƒ½ä½¿ç”¨åˆ° 20% çš„\nCPU å¸¦å®½ã€‚\n\næ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æŠŠè¢«é™åˆ¶çš„è¿›ç¨‹çš„ PID å†™å…¥ container ç»„é‡Œçš„ tasks æ–‡ä»¶ï¼Œä¸Šé¢çš„è®¾ç½®å°±ä¼š\nå¯¹è¯¥è¿›ç¨‹ç”Ÿæ•ˆäº†ï¼š\n\n```bash\n$ echo 226 > /sys/fs/cgroup/cpu/container/tasks \n```\n\næˆ‘ä»¬å¯ä»¥ç”¨ top æŒ‡ä»¤æŸ¥çœ‹ä¸€ä¸‹ï¼š\n\n```bash\n$ top\n%Cpu0 : 20.3 us, 0.0 sy, 0.0 ni, 79.7 id, 0.0 wa, 0.0 hi, 0.0 si, 0.0 st\n```\n\nå¯ä»¥çœ‹åˆ°ï¼Œè®¡ç®—æœºçš„ CPU ä½¿ç”¨ç‡ç«‹åˆ»é™åˆ°äº† 20%ï¼ˆ%Cpu0 : 20.3 usï¼‰ã€‚\n\né™¤ CPU å­ç³»ç»Ÿå¤–ï¼ŒCgroups çš„æ¯ä¸€é¡¹å­ç³»ç»Ÿéƒ½æœ‰å…¶ç‹¬æœ‰çš„èµ„æºé™åˆ¶èƒ½åŠ›ï¼Œæ¯”å¦‚ï¼š\n\n<ul>\n    <li>blkioï¼Œä¸º å— è®¾ å¤‡ è®¾ å®š I/O é™ åˆ¶ï¼Œä¸€èˆ¬ç”¨äºç£ç›˜ç­‰è®¾å¤‡</li>\n    <li>cpusetï¼Œä¸ºè¿›ç¨‹åˆ†é…å•ç‹¬çš„ CPU æ ¸å’Œå¯¹åº”çš„å†…å­˜èŠ‚ç‚¹</li>\n    <li>memoryï¼Œä¸ºè¿›ç¨‹è®¾å®šå†…å­˜ä½¿ç”¨çš„é™åˆ¶</li>\n</ul>\n\n**Linux Cgroups çš„è®¾è®¡è¿˜æ˜¯æ¯”è¾ƒæ˜“ç”¨çš„ï¼Œç®€å•ç²—æš´åœ°ç†è§£å‘¢ï¼Œå®ƒå°±æ˜¯ä¸€ä¸ªå­ç³»ç»Ÿç›®å½•åŠ ä¸Šä¸€ç»„èµ„æºé™åˆ¶æ–‡ä»¶çš„ç»„åˆã€‚**\nè€Œå¯¹äº Docker ç­‰ Linux å®¹å™¨é¡¹ç›®æ¥è¯´ï¼Œå®ƒä»¬åªéœ€è¦åœ¨æ¯ä¸ªå­ç³»ç»Ÿä¸‹é¢ï¼Œä¸ºæ¯ä¸ªå®¹å™¨åˆ›å»ºä¸€ä¸ªæ§åˆ¶ç»„ï¼ˆå³åˆ›å»ºä¸€ä¸ªæ–°ç›®å½•ï¼‰ï¼Œç„¶ååœ¨å¯åŠ¨å®¹å™¨è¿›ç¨‹ä¹‹åï¼ŒæŠŠè¿™ä¸ªè¿›ç¨‹çš„ PID å¡«å†™åˆ°å¯¹åº”æ§åˆ¶ç»„çš„ tasks æ–‡ä»¶ä¸­å°±å¯ä»¥äº†ã€‚\n\nè€Œè‡³äºåœ¨è¿™äº›æ§åˆ¶ç»„ä¸‹é¢çš„èµ„æºæ–‡ä»¶é‡Œå¡«ä¸Šä»€ä¹ˆå€¼ï¼Œå°±é ç”¨æˆ·æ‰§è¡Œ docker run æ—¶çš„å‚æ•°æŒ‡å®šäº†ï¼Œæ¯”å¦‚è¿™æ ·ä¸€æ¡å‘½ä»¤ï¼š\n\n```bash\n$ docker run -it --cpu-period=100000 --cpu-quota=20000 ubuntu /bin/bash\n```\n\nåœ¨å¯åŠ¨è¿™ä¸ªå®¹å™¨åï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡æŸ¥çœ‹ Cgroups æ–‡ä»¶ç³»ç»Ÿä¸‹ï¼ŒCPU å­ç³»ç»Ÿä¸­ï¼Œâ€œdockerâ€è¿™ä¸ªæ§åˆ¶ç»„é‡Œçš„èµ„æºé™åˆ¶æ–‡ä»¶çš„å†…å®¹æ¥ç¡®è®¤ï¼š\n\n```bash\n$ cat /sys/fs/cgroup/cpu/docker/5d5c9f67d/cpu.cfs_period_us\n100000\n$ cat /sys/fs/cgroup/cpu/docker/5d5c9f67d/cpu.cfs_quota_us \n20000\n```\n\nè¿™å°±æ„å‘³ç€è¿™ä¸ª Docker å®¹å™¨ï¼Œåªèƒ½ä½¿ç”¨åˆ° 20% çš„ CPU å¸¦å®½ã€‚\n\n## æ€»ç»“\n<ul>\n    <li>å®¹å™¨æ˜¯ä¸€ç§â€œç‰¹æ®Šâ€çš„è¿›ç¨‹ï¼šç”¨æˆ·çš„åº”ç”¨è¿›ç¨‹å®é™…ä¸Šå°±æ˜¯å®¹å™¨é‡Œ PID=1 çš„è¿›ç¨‹ï¼Œä¹Ÿæ˜¯å…¶ä»–åç»­åˆ›å»ºçš„æ‰€æœ‰è¿›ç¨‹çš„çˆ¶è¿›ç¨‹</li>\n    <li>å®¹å™¨æ˜¯ä¸€ä¸ªâ€œå•è¿›ç¨‹â€æ¨¡å‹ï¼šä¸€ä¸ªæ­£åœ¨è¿è¡Œçš„ Docker å®¹å™¨ï¼Œå…¶å®å°±æ˜¯ä¸€ä¸ªå¯ç”¨äº†å¤šä¸ª Linux Namespace çš„åº”ç”¨è¿›ç¨‹ï¼Œè€Œè¿™ä¸ªè¿›ç¨‹èƒ½å¤Ÿä½¿ç”¨çš„èµ„æºé‡ï¼Œåˆ™å— Cgroups é…ç½®çš„é™åˆ¶</li>\n</ul>\n","tags":["docker","å­¦ä¹ ç¬”è®°"]},{"title":"é˜³äº†ä¸ªé˜³","url":"/2022/12/17/2022-12-17-a_é˜³äº†/","content":"\nä¸Šå‘¨å¼€å§‹å°±æ„Ÿè§‰å–‰å’™ä¸èˆ’æœï¼Œå†²äº†å‡ åŒ…æ¿è“æ ¹å’Œ999ï¼Œæ— æœã€‚<br/>\nå‘¨ä¸‰ã€å‘¨å››å¼€å§‹å’³å—½ï¼Œä»¥ä¸ºæ˜¯å’½ç‚ã€‚<br/>\nå‘¨å››ï¼Œè·Ÿæˆ‘ä¸€å—çš„å°ä¼™ä¼´æ£€æµ‹ï¼šé˜´æ€§ã€‚<br/>\nå‘¨äº”ï¼Œå–‰å’™æ„Ÿè§‰æœ‰â€œä¸€å›¢ç«â€ï¼Œå»æ£€æµ‹ã€‚<br/>\n**2022-12-17 å‡Œæ™¨2ç‚¹ å•ç®¡æ£€æµ‹ï¼šé˜³æ€§**\n\né˜³æ€§åï¼Œæœªå‡ºç°å‘çƒ­ç—‡çŠ¶ï¼Œåªæ˜¯å–‰å’™è½»å¾®ä¸èˆ’æœã€‚<br/>\n**2022-12-17 å–‰å’™è½»å¾®ç–¼ç—›ï¼Œæ²¡å‘çƒ§**\n\nè€ƒè™‘åˆ°åŒäº‹éƒ½æœ‰å°å­©ï¼Œå†å»æ£€æµ‹ã€‚å¤©å¾ˆå†·ï¼Œåˆ®å¤§é£ï¼Œæ’é˜Ÿ 1 ä¸ªå¤šå°æ—¶ã€‚<br/>\n**2022-12-17 æ™šä¸Š8ç‚¹ å•ç®¡æ£€æµ‹ï¼šé˜³æ€§**\n\nå›å®¶åï¼Œä½“æ¸©é£™å‡åˆ°38~39ï¼Œå››è‚¢é…¸ç—›æ— åŠ›ã€ç¡è§‰<br/>\n**2022-12-18 æ™šä¸Š å‘çƒ§ã€æµ‘èº«é…¸ç—›ã€å’½ç‚**\n\nåŒäº‹é™†é™†ç»­ç»­å‡ºç°å‘çƒ­è¿¹è±¡ï¼Œå›¢ç­ï¼Œå±…å®¶åŠå…¬ã€‚<br/>\n**2022-12-19 ä½çƒ§ã€å’½ç‚ã€å’³å—½**\n\nå…¨å¤©37~38åº¦ï¼Œæ²¡æ•¢åƒå¸ƒæ´›èŠ¬ï¼Œè¯·äº†å¤©å‡ï¼Œç¡äº†ä¸€å¤©<br/>\n**2022-12-20 ä½çƒ§ã€å’³å—½ã€æµé¼»æ¶•**\n\nçœ‹ä¸Šå»å¥½äº†ï¼Œè½»å¾®å’³å—½ã€‚<br/>\n**2022-12-21 å’³å—½**","tags":["éšè®°"]},{"title":"å›¾è§£ Paxos ç®—æ³•","url":"/2022/12/14/2022-12-14-å›¾è§£Paxosç®—æ³•/","content":"\n&emsp;&emsp;Paxos ç®—æ³•æ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼å…±è¯†ç®—æ³•ï¼Œç”± Leslie Lamport åœ¨ 1989 å¹´æå‡ºï¼Œè¯¥ç®—æ³•ç†è§£èµ·æ¥æœ‰ä¸€å®šçš„éš¾åº¦ï¼Œæœ¬æ–‡å°è¯•å›¾å½¢åŒ–è§£æ Paxos ç®—æ³•ã€‚\n\nLamport æå‡ºçš„ Paxos ç®—æ³•åŒ…æ‹¬ä¸¤ä¸ªéƒ¨åˆ†ï¼š\n<ul>\n    <li>Basic Paxos ç®—æ³•ï¼šå¤šèŠ‚ç‚¹å¦‚ä½•å°±æŸä¸ªå€¼ï¼ˆææ¡ˆValueï¼‰è¾¾æˆå…±è¯†</li>\n    <li>Multi-Paxos æ€æƒ³ï¼šæ‰§è¡Œå¤šä¸ª Basic Paxos å®ä¾‹ï¼Œå°±ä¸€ç³»åˆ—çš„å€¼è¾¾æˆå…±è¯†</li>\n</ul>\n\n## Basic Paxos\n### æ€è€ƒé¢˜\n&emsp;&emsp;å‡è®¾ç°åœ¨æœ‰ä¸€ä¸ªä¸‰èŠ‚ç‚¹çš„åˆ†å¸ƒå¼é›†ç¾¤ï¼Œæä¾›åªè¯» KV å­˜å‚¨æœåŠ¡ã€‚åªè¯» KV æœåŠ¡ï¼Œæ—¢åˆ›å»ºåªè¯»å˜é‡ï¼ˆkeyï¼‰çš„æ—¶å€™ï¼Œå¿…é¡»è¦å¯¹å®ƒè¿›è¡Œèµ‹å€¼ï¼ˆvalueï¼‰ï¼Œè€Œä¸”è¿™ä¸ªå€¼åç»­æ²¡åŠæ³•ä¿®æ”¹ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œåªè¯»å˜é‡åœ¨åˆ›å»ºåå°±ä¸èƒ½è¢«ä¿®æ”¹äº†ï¼Œæ‰€ä»¥æ‰€æœ‰èŠ‚ç‚¹å¿…é¡»è¦å…ˆå¯¹åªè¯»å˜é‡çš„å€¼è¾¾æˆå…±è¯†ï¼Œç„¶åå†å»åˆ›å»ºè¿™ä¸ªåªè¯»å˜é‡ã€‚\n\n&emsp;&emsp;é‚£ä¹ˆï¼Œå½“æœ‰å¤šä¸ªå®¢æˆ·ç«¯ï¼ˆæ¯”å¦‚å®¢æˆ·ç«¯ 1ã€2ï¼‰è®¿é—®è¿™ä¸ªç³»ç»Ÿï¼Œè¯•å›¾åˆ›å»ºåŒä¸€ä¸ªåªè¯»å˜é‡ï¼ˆæ¯”å¦‚ Xï¼‰ï¼Œå®¢æˆ·ç«¯ 1 è¯•å›¾åˆ›å»ºå€¼ä¸º 5 çš„ Xï¼Œå®¢æˆ·ç«¯ 2 è¯•å›¾åˆ›å»ºå€¼ä¸º 7 çš„ Xï¼Œè¿™æ ·è¦å¦‚ä½•è¾¾æˆå…±è¯†ï¼Œå®ç°å„èŠ‚ç‚¹ä¸Š X å€¼çš„ä¸€è‡´å‘¢ï¼Ÿ\n\n![å¦‚ä½•åœ¨å¤šä¸ªèŠ‚ç‚¹é—´ç¡®å®šæŸå˜é‡çš„å€¼](/img/2022-12-14-å›¾è§£Paxosç®—æ³•/pho1.png \"å›¾1\")\n\nåœ¨è§£å†³è¿™ä¸ªé—®é¢˜ä¹‹å‰ï¼Œå…ˆäº†è§£ä¸€ä¸‹ Basic Paxos çš„å‡ ä¸ªæ¦‚å¿µã€‚\n\n### Paxos æ¶‰åŠçš„æ¦‚å¿µ\n\nåœ¨ Basic Paxos ä¸­ï¼Œæœ‰æè®®è€…ï¼ˆProposerï¼‰ã€æ¥å—è€…ï¼ˆAcceptorï¼‰ã€å­¦ä¹ è€…ï¼ˆLearnerï¼‰ä¸‰ç§è§’è‰²ï¼š\n<ul>\n    <li>æè®®è€…ï¼šæè®®ä¸€ä¸ªå€¼ï¼Œç”¨äºæŠ•ç¥¨è¡¨å†³ã€‚ä¸ºäº†æ–¹ä¾¿æ¼”ç¤ºï¼Œä½ å¯ä»¥æŠŠå›¾ 1 ä¸­çš„å®¢æˆ·ç«¯ 1 å’Œ 2 çœ‹ä½œæ˜¯æè®®è€…ã€‚ä½†åœ¨ç»å¤§å¤šæ•°åœºæ™¯ä¸­ï¼Œé›†ç¾¤ä¸­æ”¶åˆ°å®¢æˆ·ç«¯è¯·æ±‚çš„èŠ‚ç‚¹ï¼Œæ‰æ˜¯æè®®è€…ï¼ˆå›¾ 1 è¿™ä¸ªæ¶æ„ï¼Œæ˜¯ä¸ºäº†æ–¹ä¾¿æ¼”ç¤ºç®—æ³•åŸç†ï¼‰ã€‚</li>\n    <li>æ¥å—è€…ï¼šæ¯ä¸ªæè®®çš„å€¼è¿›è¡ŒæŠ•ç¥¨ï¼Œå¹¶å­˜å‚¨æ¥å—çš„å€¼ï¼Œæ¯”å¦‚ Aã€Bã€C ä¸‰ä¸ªèŠ‚ç‚¹ã€‚</li>\n    <li>å­¦ä¹ è€…ï¼šè¢«å‘ŠçŸ¥æŠ•ç¥¨çš„ç»“æœï¼Œæ¥å—è¾¾æˆå…±è¯†çš„å€¼ï¼Œå­˜å‚¨ä¿å­˜ï¼Œä¸å‚ä¸æŠ•ç¥¨çš„è¿‡ç¨‹ã€‚</li>\n</ul>\n\néœ€è¦æŒ‡å‡ºçš„æ˜¯ï¼Œ**ä¸€ä¸ªèŠ‚ç‚¹ï¼Œæ—¢å¯ä»¥æ˜¯æè®®è€…ï¼Œä¹Ÿå¯ä»¥æ˜¯æ¥å—è€…**ï¼›ä»–ä»¬ä¹‹é—´çš„å…³ç³»å¦‚ä¸‹ï¼š\n\n![è§’è‰²ä¹‹é—´çš„å…³ç³»](/img/2022-12-14-å›¾è§£Paxosç®—æ³•/pho2.png \"å›¾2\")\n\nå…¶å®ï¼Œè¿™ä¸‰ç§è§’è‰²ï¼Œåœ¨æœ¬è´¨ä¸Šä»£è¡¨çš„æ˜¯ä¸‰ç§åŠŸèƒ½ï¼š\n\n<ul>\n    <li>æè®®è€…ä»£è¡¨çš„æ˜¯æ¥å…¥å’Œåè°ƒåŠŸèƒ½ï¼Œæ”¶åˆ°å®¢æˆ·ç«¯è¯·æ±‚åï¼Œå‘èµ·äºŒé˜¶æ®µæäº¤ï¼Œè¿›è¡Œå…±è¯†åå•†</li>\n    <li>æ¥å—è€…ä»£è¡¨æŠ•ç¥¨åå•†å’Œå­˜å‚¨æ•°æ®ï¼Œå¯¹æè®®çš„å€¼è¿›è¡ŒæŠ•ç¥¨ï¼Œå¹¶æ¥å—è¾¾æˆå…±è¯†çš„å€¼ï¼Œå­˜å‚¨ä¿å­˜</li>\n    <li>å­¦ä¹ è€…ä»£è¡¨å­˜å‚¨æ•°æ®ï¼Œä¸å‚ä¸å…±è¯†åå•†ï¼Œåªæ¥å—è¾¾æˆå…±è¯†çš„å€¼ï¼Œå­˜å‚¨ä¿å­˜</li>\n</ul>\n\né‚£ä¹ˆæ¥ä¸‹æ¥ï¼Œå’±ä»¬çœ‹çœ‹å¦‚ä½•ä½¿ç”¨ Basic Paxos è¾¾æˆå…±è¯†ï¼Œè§£å†³å¼€ç¯‡æåˆ°çš„é‚£é“æ€è€ƒé¢˜ã€‚\n\n### å¦‚ä½•è¾¾æˆå…±è¯†\n\n&emsp;&emsp;åœ¨ Paxos ç®—æ³•ä¸­ï¼Œä½¿ç”¨ææ¡ˆè¡¨ç¤ºä¸€ä¸ªæè®®ï¼Œææ¡ˆåŒ…æ‹¬ææ¡ˆç¼–å·å’Œæè®®çš„å€¼ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬ä½¿ç”¨ [n, v] è¡¨ç¤ºä¸€ä¸ªææ¡ˆï¼Œå…¶ä¸­ï¼Œn æ˜¯ææ¡ˆç¼–å·ï¼Œv æ˜¯ææ¡ˆçš„å€¼ã€‚\n\n&emsp;&emsp;åœ¨ Basic Paxos ä¸­ï¼Œé›†ç¾¤ä¸­å„ä¸ªèŠ‚ç‚¹ä¸ºäº†è¾¾æˆå…±è¯†ï¼Œéœ€è¦è¿›è¡Œ 2 ä¸ªé˜¶æ®µçš„åå•†ï¼Œå³å‡†å¤‡ï¼ˆPrepareï¼‰é˜¶æ®µå’Œæ¥å—ï¼ˆAcceptï¼‰é˜¶æ®µã€‚ \n\n### å‡†å¤‡é˜¶æ®µ\n\n&emsp;&emsp;å‡è®¾å®¢æˆ·ç«¯ 1 çš„ææ¡ˆç¼–å·æ˜¯ 1ï¼Œå®¢æˆ·ç«¯ 2 çš„ææ¡ˆç¼–å·ä¸º 5ï¼Œå¹¶å‡è®¾èŠ‚ç‚¹ A, B å…ˆæ”¶åˆ°æ¥è‡ªå®¢æˆ·ç«¯ 1 çš„å‡†å¤‡è¯·æ±‚ï¼ŒèŠ‚ç‚¹ C å…ˆæ”¶åˆ°æ¥è‡ªå®¢æˆ·ç«¯ 2 çš„å‡†å¤‡è¯·æ±‚ã€‚\n\n&emsp;&emsp;å®¢æˆ·ç«¯ä½œä¸ºæè®®è€…ï¼Œå‘æ‰€æœ‰çš„æ¥å—è€…å‘é€åŒ…å«ææ¡ˆç¼–å·çš„å‡†å¤‡è¯·æ±‚ã€‚æ³¨æ„åœ¨å‡†å¤‡é˜¶æ®µï¼Œè¯·æ±‚ä¸­ä¸éœ€è¦æŒ‡å®šæè®®çš„å€¼ï¼Œåªéœ€è¦åŒ…å«ææ¡ˆç¼–å·å³å¯ã€‚\n\n![å‡†å¤‡æµç¨‹1](/img/2022-12-14-å›¾è§£Paxosç®—æ³•/pho3.png \"å›¾3\")\n\n&emsp;&emsp;æ¥ä¸‹æ¥ï¼ŒèŠ‚ç‚¹ Aï¼ŒB æ¥æ”¶åˆ°å®¢æˆ·ç«¯ 1 çš„å‡†å¤‡è¯·æ±‚ï¼ˆææ¡ˆç¼–å·ä¸º1ï¼‰ï¼ŒèŠ‚ç‚¹ C æ¥æ”¶åˆ°å®¢æˆ·ç«¯ 2 çš„å‡†å¤‡è¯·æ±‚ï¼ˆææ¡ˆç¼–å·ä¸º 5ï¼‰ã€‚\n\n![å‡†å¤‡æµç¨‹2](/img/2022-12-14-å›¾è§£Paxosç®—æ³•/pho4.png \"å›¾4\")\n\né›†ç¾¤ä¸­å„ä¸ªèŠ‚ç‚¹åœ¨æ¥æ”¶åˆ°ç¬¬ä¸€ä¸ªå‡†å¤‡è¯·æ±‚çš„å¤„ç†ï¼š\n<ul>\n    <li>èŠ‚ç‚¹ A, Bï¼šç”±äºä¹‹å‰æ²¡æœ‰é€šè¿‡ä»»ä½•ææ¡ˆï¼Œæ‰€ä»¥èŠ‚ç‚¹ Aï¼ŒB å°†è¿”å›â€œå°šæ— ææ¡ˆâ€çš„å‡†å¤‡å“åº”ï¼Œå¹¶æ‰¿è¯ºä»¥åä¸å†å“åº”ææ¡ˆç¼–å·å°äºç­‰äº 1 çš„å‡†å¤‡è¯·æ±‚ï¼Œä¸ä¼šé€šè¿‡ç¼–å·å°äº 1 çš„ææ¡ˆ\n    </li>\n    <li>èŠ‚ç‚¹ Cï¼šç”±äºä¹‹å‰æ²¡æœ‰é€šè¿‡ä»»ä½•ææ¡ˆï¼Œæ‰€ä»¥èŠ‚ç‚¹ C å°†è¿”å›â€œå°šæ— ææ¡ˆâ€çš„å‡†å¤‡å“åº”ï¼Œå¹¶æ‰¿è¯ºä»¥åä¸å†å“åº”ææ¡ˆç¼–å·å°äºç­‰äº 5 çš„å‡†å¤‡è¯·æ±‚ï¼Œä¸ä¼šé€šè¿‡ç¼–å·å°äº 5 çš„ææ¡ˆ\n    </li>\n</ul>\n\næ¥ä¸‹æ¥ï¼Œå½“èŠ‚ç‚¹ Aï¼ŒB æ¥æ”¶åˆ°ææ¡ˆç¼–å·ä¸º 5 çš„å‡†å¤‡è¯·æ±‚ï¼ŒèŠ‚ç‚¹ C æ¥æ”¶åˆ°ææ¡ˆç¼–å·ä¸º 1 çš„å‡†å¤‡è¯·æ±‚ï¼š\n\n![å‡†å¤‡æµç¨‹3](/img/2022-12-14-å›¾è§£Paxosç®—æ³•/pho5.png \"å›¾5\")\n\n<ul>\n    <li>èŠ‚ç‚¹ A, Bï¼šç”±äºææ¡ˆç¼–å· 5 å¤§äºä¹‹å‰å“åº”çš„å‡†å¤‡è¯·æ±‚çš„ææ¡ˆç¼–å· 1ï¼Œä¸”èŠ‚ç‚¹ A, B éƒ½æ²¡æœ‰é€šè¿‡ä»»ä½•ææ¡ˆï¼Œæ•…å‡è¿”å›â€œå°šæ— ææ¡ˆâ€çš„å“åº”ï¼Œå¹¶æ‰¿è¯ºä»¥åä¸å†å“åº”ææ¡ˆç¼–å·å°äºç­‰äº 5 çš„å‡†å¤‡è¯·æ±‚ï¼Œä¸ä¼šé€šè¿‡ç¼–å·å°äº 5 çš„ææ¡ˆ</li>\n    <li>èŠ‚ç‚¹ Cï¼šç”±äºèŠ‚ç‚¹ C æ¥æ”¶åˆ°ææ¡ˆç¼–å· 1 å°äºèŠ‚ç‚¹ C ä¹‹å‰å“åº”çš„å‡†å¤‡è¯·æ±‚çš„ææ¡ˆç¼–å· 5 ï¼Œæ‰€ä»¥ä¸¢å¼ƒè¯¥å‡†å¤‡è¯·æ±‚ï¼Œä¸ä½œå“åº”</li>\n</ul>\n\n### æ¥å—é˜¶æ®µ\n&emsp;&emsp;Basic Paxos ç®—æ³•ç¬¬äºŒé˜¶æ®µä¸ºæ¥å—é˜¶æ®µã€‚å½“å®¢æˆ·ç«¯ 1ï¼Œ2 åœ¨æ”¶åˆ°å¤§å¤šæ•°èŠ‚ç‚¹çš„å‡†å¤‡å“åº”ä¹‹åä¼šå¼€å§‹å‘é€æ¥å—è¯·æ±‚ã€‚\n\n![æ¥å—æµç¨‹1](/img/2022-12-14-å›¾è§£Paxosç®—æ³•/pho6.png \"å›¾6\")\n\n<ul>\n    <li>å®¢æˆ·ç«¯ 1ï¼šå®¢æˆ·ç«¯ 1 æ¥æ”¶åˆ°å¤§å¤šæ•°çš„æ¥å—è€…ï¼ˆèŠ‚ç‚¹ A, Bï¼‰çš„å‡†å¤‡å“åº”åï¼Œæ ¹æ®å“åº”ä¸­çš„ææ¡ˆç¼–å·æœ€å¤§çš„ææ¡ˆçš„å€¼ï¼Œè®¾ç½®æ¥å—è¯·æ±‚çš„å€¼ã€‚ç”±äºèŠ‚ç‚¹ A, B å‡è¿”å›â€œå°šæ— ææ¡ˆâ€ï¼Œå³ææ¡ˆå€¼ä¸ºç©ºï¼Œæ•…å®¢æˆ·ç«¯ 1 æŠŠè‡ªå·±çš„æè®®å€¼ \"5\" ä½œä¸ºææ¡ˆçš„å€¼ï¼Œå‘é€æ¥å—è¯·æ±‚ [1, \"5\"]</li>\n    <li>å®¢æˆ·ç«¯ 2ï¼šå®¢æˆ·ç«¯ 2 æ¥æ”¶åˆ°å¤§å¤šæ•°æ¥å—è€…çš„å‡†å¤‡å“åº”åï¼Œæ ¹æ®å“åº”ä¸­çš„ææ¡ˆç¼–å·æœ€å¤§çš„ææ¡ˆçš„å€¼ï¼Œè®¾ç½®æ¥å—è¯·æ±‚çš„å€¼ã€‚ç”±äºèŠ‚ç‚¹ A, B, C å‡è¿”å›â€œå°šæ— ææ¡ˆâ€ï¼Œå³ææ¡ˆå€¼ä¸ºç©ºï¼Œæ•…å®¢æˆ·ç«¯ 2 æŠŠè‡ªå·±çš„æè®®å€¼ \"7\" ä½œä¸ºææ¡ˆçš„å€¼ï¼Œå‘é€æ¥å—è¯·æ±‚ [5, \"7\"]</li>\n</ul>\n\n&emsp;&emsp;å½“èŠ‚ç‚¹ A, B, C æ¥æ”¶åˆ°å®¢æˆ·ç«¯ 1, 2 çš„æ¥å—è¯·æ±‚æ—¶ï¼Œå¯¹æ¥å—è¯·æ±‚è¿›è¡Œå¤„ç†ï¼š\n\n![æ¥å—æµç¨‹2](/img/2022-12-14-å›¾è§£Paxosç®—æ³•/pho7.png \"å›¾7\")\n\n<ul>\n    <li>èŠ‚ç‚¹ A, B, C æ¥æ”¶åˆ°æ¥å—è¯·æ±‚ [1, \"5\"] ï¼Œç”±äºææ¡ˆç¼–å· 1 å°äºä¸‰ä¸ªèŠ‚ç‚¹æ‰¿è¯ºå¯ä»¥é€šè¿‡çš„æœ€å°ææ¡ˆç¼–å· 5ï¼Œæ‰€ä»¥ææ¡ˆ [1, \"5\"] è¢«æ‹’ç»</li>\n    <li>èŠ‚ç‚¹ A, B, C æ¥æ”¶åˆ°æ¥å—è¯·æ±‚ [5, \"7\"]ï¼Œç”±äºææ¡ˆç¼–å· 5 ä¸å°äºä¸‰ä¸ªèŠ‚ç‚¹æ‰¿è¯ºå¯ä»¥é€šè¿‡çš„æœ€å°ææ¡ˆç¼–å· 5 ï¼Œæ‰€ä»¥é€šè¿‡ææ¡ˆ [5, \"7\"]ï¼Œå³ä¸‰ä¸ªèŠ‚ç‚¹è¾¾æˆå…±è¯†ï¼Œæ¥å— X çš„å€¼ä¸º \"7\"</li>\n</ul>\n\n&emsp;&emsp;å¦‚æœé›†ç¾¤ä¸­è¿˜æœ‰å­¦ä¹ è€…ï¼Œå½“æ¥å—è€…é€šè¿‡ä¸€ä¸ªææ¡ˆï¼Œå°±é€šçŸ¥å­¦ä¹ è€…ï¼Œå½“å­¦ä¹ è€…å‘ç°å¤§å¤šæ•°æ¥å—è€…éƒ½é€šè¿‡äº†æŸä¸ªææ¡ˆï¼Œé‚£ä¹ˆå­¦ä¹ è€…ä¹Ÿé€šè¿‡è¯¥ææ¡ˆï¼Œæ¥å—ææ¡ˆçš„å€¼ã€‚\n\n### æ¥å—è€…å­˜åœ¨å·²é€šè¿‡ææ¡ˆçš„æƒ…å†µ\n\n&emsp;&emsp;ä¸Šé¢ä¾‹å­ä¸­ï¼Œå‡†å¤‡é˜¶æ®µå’Œæ¥å—é˜¶æ®µå‡ä¸å­˜åœ¨æ¥å—è€…å·²ç»é€šè¿‡ææ¡ˆçš„æƒ…å†µã€‚è¿™é‡Œç»§ç»­ä½¿ç”¨ä¸Šé¢çš„ä¾‹å­ï¼Œä¸è¿‡å‡è®¾èŠ‚ç‚¹ A, B å·²é€šè¿‡ææ¡ˆ [5, \"7\"]ï¼ŒèŠ‚ç‚¹ C æœªé€šè¿‡ä»»ä½•ææ¡ˆï¼›å¢åŠ ä¸€ä¸ªæ–°çš„æè®®è€…å®¢æˆ·ç«¯ 3ï¼Œå®¢æˆ·ç«¯ 3 çš„ææ¡ˆä¸º [9ï¼Œ\"13\"] ã€‚\n\n&emsp;&emsp;æ¥ä¸‹æ¥ï¼Œå®¢æˆ·ç«¯ 3 æ‰§è¡Œå‡†å¤‡é˜¶æ®µå’Œæ¥å—é˜¶æ®µï¼›å®¢æˆ·ç«¯ 3 å‘èŠ‚ç‚¹ A, B, C å‘é€ææ¡ˆç¼–å·ä¸º 9 çš„å‡†å¤‡è¯·æ±‚ï¼š\n\n![æ–°å‡†å¤‡æµç¨‹1](/img/2022-12-14-å›¾è§£Paxosç®—æ³•/pho8.png \"å›¾8\")\n\n<ul>\n    <li>èŠ‚ç‚¹ A, B æ¥æ”¶åˆ°å®¢æˆ·ç«¯ 3 çš„å‡†å¤‡è¯·æ±‚ï¼Œç”±äºèŠ‚ç‚¹ A, B å·²é€šè¿‡ææ¡ˆ [5, \"7\"]ï¼Œæ•…åœ¨å‡†å¤‡å“åº”ä¸­ï¼ŒåŒ…å«æ­¤ææ¡ˆä¿¡æ¯ã€‚</li>\n    <li>èŠ‚ç‚¹ C æ¥æ”¶åˆ°å®¢æˆ·ç«¯ 3 çš„å‡†å¤‡è¯·æ±‚ï¼Œç”±äºèŠ‚ç‚¹ C æœªé€šè¿‡ä»»ä½•ææ¡ˆï¼Œæ•…èŠ‚ç‚¹ C å°†è¿”å›â€œå°šæ— ææ¡ˆâ€çš„å‡†å¤‡å“åº”ã€‚</li>\n</ul>\n\n![æ–°å‡†å¤‡æµç¨‹2](/img/2022-12-14-å›¾è§£Paxosç®—æ³•/pho9.png \"å›¾9\")\n\n<ul>\n    <li>å®¢æˆ·ç«¯ 3 æ¥æ”¶åˆ°èŠ‚ç‚¹ A, B, C çš„å‡†å¤‡å“åº”åï¼Œå‘èŠ‚ç‚¹ A, B, C å‘é€æ¥å—è¯·æ±‚ã€‚è¿™é‡Œéœ€è¦ç‰¹ç‚¹æŒ‡å‡ºï¼Œå®¢æˆ·ç«¯ 3 ä¼šæ ¹æ®å“åº”ä¸­çš„ææ¡ˆç¼–å·æœ€å¤§çš„ææ¡ˆçš„å€¼ï¼Œè®¾ç½®æ¥å—è¯·æ±‚çš„å€¼ã€‚</li>\n    <li>ç”±äºåœ¨å‡†å¤‡å“åº”ä¸­ï¼Œå·²åŒ…å«ææ¡ˆ [5, \"7\"]ï¼Œæ•…å®¢æˆ·ç«¯ 3 å°†æ¥å—è¯·æ±‚çš„ææ¡ˆç¼–å·è®¾ç½®ä¸º 9ï¼Œææ¡ˆå€¼è®¾ç½®ä¸º \"7\" å³æ¥å—è¯·æ±‚çš„ææ¡ˆä¸º [9, \"7\"]</li>\n</ul>\n\n![æ–°æ¥å—æµç¨‹1](/img/2022-12-14-å›¾è§£Paxosç®—æ³•/pho10.png \"å›¾10\")\n\n&emsp;&emsp;èŠ‚ç‚¹ A, B, C æ¥æ”¶åˆ°å®¢æˆ·ç«¯ 3 çš„æ¥å—è¯·æ±‚ï¼Œç”±äºææ¡ˆç¼–å· 9 ä¸å°äºä¸‰ä¸ªèŠ‚ç‚¹æ‰¿è¯ºå¯ä»¥é€šè¿‡çš„æœ€å°ææ¡ˆç¼–å·ï¼Œæ•…å‡é€šè¿‡ææ¡ˆ [9, \"7\"]ã€‚\n\n![æ–°æ¥å—æµç¨‹2](/img/2022-12-14-å›¾è§£Paxosç®—æ³•/pho11.png \"å›¾11\")\n\næ¦‚æ‹¬æ¥è¯´ï¼ŒBasic Paxos å…·æœ‰ä»¥ä¸‹ç‰¹ç‚¹ï¼š\n<ul>\n    <li>Basic Paxos é€šè¿‡äºŒé˜¶æ®µæ–¹å¼æ¥è¾¾æˆå…±è¯†ï¼Œå³å‡†å¤‡é˜¶æ®µå’Œæ¥å—é˜¶æ®µ</li>\n    <li>Basic Paxos é™¤äº†è¾¾æˆå…±è¯†åŠŸèƒ½ï¼Œè¿˜å®ç°äº†å®¹é”™ï¼Œåœ¨å°‘äºä¸€åŠèŠ‚ç‚¹å‡ºç°æ•…éšœæ—¶ï¼Œé›†ç¾¤ä¹Ÿèƒ½å·¥ä½œ</li>\n    <li>ææ¡ˆç¼–å·å¤§å°ä»£è¡¨ä¼˜å…ˆçº§ã€‚å¯¹äºææ¡ˆç¼–å·ï¼Œæ¥å—è€…æä¾›ä¸‰ä¸ªæ‰¿è¯ºï¼š</li>\n    <ul>\n        <li>å¦‚æœå‡†å¤‡è¯·æ±‚çš„ææ¡ˆç¼–å·ï¼Œå°äºç­‰äºæ¥å—è€…å·²ç»å“åº”çš„å‡†å¤‡è¯·æ±‚çš„ææ¡ˆç¼–å·ï¼Œé‚£ä¹ˆæ¥å—è€…æ‰¿è¯ºä¸å“åº”è¿™ä¸ªå‡†å¤‡è¯·æ±‚</li>\n        <li>å¦‚æœæ¥å—è¯·æ±‚ä¸­çš„ææ¡ˆç¼–å·ï¼Œå°äºæ¥å—è€…å·²ç»å“åº”çš„å‡†å¤‡è¯·æ±‚çš„ææ¡ˆç¼–å·ï¼Œé‚£ä¹ˆæ¥å—è€…æ‰¿è¯ºä¸é€šè¿‡è¿™ä¸ªææ¡ˆ</li>\n        <li>å¦‚æœæŒ‰å—è€…å·²é€šè¿‡ææ¡ˆï¼Œé‚£äº›æ¥å—è€…æ‰¿è¯ºä¼šåœ¨å‡†å¤‡è¯·æ±‚çš„å“åº”ä¸­ï¼ŒåŒ…å«å·²ç»é€šè¿‡çš„æœ€å¤§ç¼–å·çš„ææ¡ˆä¿¡æ¯</li>\n    </ul>\n</ul>\n\n>å‚è€ƒï¼š\n>1. <a href=\"https://time.geekbang.org/column/intro/279\">æå®¢æ—¶é—´ â€” â€”ã€Šåˆ†å¸ƒå¼åè®®ä¸ç®—æ³•ã€‹</a>\n>2. <a href=\"https://leehao.me/%E5%9B%BE%E8%A7%A3-Paxos-%E7%AE%97%E6%B3%95/\">å›¾è§£ Paxos ç®—æ³•</a>\n\n","tags":["å­¦ä¹ ç¬”è®°","paxos","åˆ†å¸ƒå¼æ¶æ„"]},{"title":"è½¬æ­£æˆåŠŸ","url":"/2022/12/12/2022-12-12-a_è½¬æ­£/","content":"\n**ç¬¬ä¸€ä»½å·¥ä½œï¼Œæµ‹è¯•å¼€å‘å·¥ç¨‹å¸ˆï¼Œè½¬æ­£æˆåŠŸï¼Œæ–°çš„ç”Ÿæ´»å¼€å§‹~~~**","tags":["éšè®°"]},{"title":"ç™½è¯å®¹å™¨åŸºç¡€ï¼ˆä¸€ï¼‰ï¼šä»è¿›ç¨‹è¯´å¼€å»","url":"/2022/12/12/2022-12-12-ç™½è¯å®¹å™¨åŸºç¡€ï¼ˆä¸€ï¼‰ï¼šä»è¿›ç¨‹è¯´å¼€å»/","content":"\n## å‰è¨€\ndocker çš„æ¥é¾™å»è„‰ï¼š\n<ul>\n    <li>å®¹å™¨æŠ€æœ¯çš„å…´èµ·æºäº PaaS æŠ€æœ¯çš„æ™®åŠ</li>\n    <li>Docker å…¬å¸å‘å¸ƒçš„ Docker é¡¹ç›®å…·æœ‰é‡Œç¨‹ç¢‘å¼çš„æ„ä¹‰</li>\n    <li>Docker é¡¹ç›®é€šè¿‡â€œå®¹å™¨é•œåƒâ€ï¼Œè§£å†³äº†åº”ç”¨æ‰“åŒ…è¿™ä¸ªæ ¹æœ¬æ€§éš¾é¢˜</li>\n</ul>\n\n~~å¤§ä½¬çœŸè¨€ï¼š~~\n<blockquote>\n&emsp;&emsp;å®¹å™¨æœ¬èº«æ²¡æœ‰ä»·å€¼ï¼Œæœ‰ä»·å€¼çš„æ˜¯â€œå®¹å™¨ç¼–æ’â€ã€‚\n</blockquote>\n\n## å®¹å™¨ï¼Œåˆ°åº•æ˜¯æ€ä¹ˆä¸€å›äº‹å„¿ï¼Ÿ\n&emsp;&emsp;å®¹å™¨å…¶å®æ˜¯ä¸€ç§æ²™ç›’æŠ€æœ¯ã€‚å®ƒèƒ½å¤Ÿåƒé›†è£…ç®±ä¸€æ ·ï¼ŒæŠŠä½ çš„åº”ç”¨â€œè£…â€èµ·æ¥ã€‚è¿™æ ·ï¼Œåº”ç”¨ä¸åº”ç”¨ä¹‹é—´å°±å­˜åœ¨â€œè¾¹ç•Œâ€ï¼Œè€Œä¸ä¼šç›¸äº’å¹²æ‰°ï¼›å¹¶ä¸”è¢«â€œè£…â€èµ·æ¥çš„åº”ç”¨ï¼Œä¹Ÿæ–¹ä¾¿è¢«æ¬æ¥æ¬å» â€”â€” è¿™ä¸å°±æ˜¯ PaaS æœ€ç†æƒ³çš„çŠ¶æ€å˜›ã€‚\n\nä¸è¿‡ï¼Œè¿™ä¸¤ä¸ªæŠ€æœ¯è¯´èµ·æ¥å®¹æ˜“ï¼Œåšèµ·æ¥éš¾ã€‚\n\n### æŠ€æœ¯ä¸€ï¼šâ€œè¾¹ç•Œâ€\n&emsp;&emsp;å‡å¦‚ï¼Œç°åœ¨ä½ è¦å†™ä¸€ä¸ªè®¡ç®—åŠ æ³•çš„å°ç¨‹åºï¼Œå…¶è¾“å…¥æ¥è‡ªä¸€ä¸ªæ–‡ä»¶ä½†è¾“å‡ºåˆ°å¦ä¸€ä¸ªæ–‡ä»¶ã€‚\n\n&emsp;&emsp;ç”±äºè®¡ç®—æœºåªè®¤è¯† 0 å’Œ 1ï¼Œæ‰€ä»¥æ— è®ºç”¨å“ªç§è¯­è¨€ç¼–å†™è¿™æ®µä»£ç ï¼Œæœ€åéƒ½éœ€è¦ç¼–è¯‘æˆäºŒè¿›åˆ¶æ–‡ä»¶ï¼Œæ‰èƒ½åœ¨è®¡ç®—æœºæ“ä½œç³»ç»Ÿä¸­è¿è¡Œã€‚\n\n&emsp;&emsp;è€Œä¸ºäº†èƒ½å¤Ÿè®©è¿™äº›ä»£ç æ­£å¸¸è¿è¡Œï¼Œæˆ‘ä»¬å¾€å¾€è¿˜è¦ç»™å®ƒæä¾›æ•°æ®ï¼Œæ¯”å¦‚è¿™ä¸ªåŠ æ³•ç¨‹åºæ‰€éœ€è¦çš„è¾“å…¥æ–‡ä»¶ã€‚è¿™äº›å­˜æ”¾åœ¨ç£ç›˜ä¸Šçš„ï¼Œæ•°æ®å’Œä»£ç æœ¬èº«çš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œå°±æ˜¯æˆ‘ä»¬å¹³å¸¸æ‰€è¯´çš„ä¸€ä¸ªâ€œç¨‹åºâ€ï¼Œä¹Ÿå«ä»£ç çš„å¯æ‰§è¡Œé•œåƒï¼ˆexecutable imageï¼‰ã€‚\n\nç„¶åï¼Œæˆ‘ä»¬å°±å¯ä»¥åœ¨è®¡ç®—æœºä¸Šè¿è¡Œè¿™ä¸ªâ€œç¨‹åºâ€äº†ã€‚\n \n&emsp;&emsp;é¦–å…ˆï¼Œæ“ä½œç³»ç»Ÿä»â€œç¨‹åºâ€ä¸­å‘ç°è¾“å…¥æ¥æºæ˜¯æ–‡ä»¶ï¼Œç„¶åè¿™äº›æ•°æ®è¢«åŠ è½½åˆ°å†…å­˜ä¸­å¾…å‘½ã€‚åŒæ—¶ï¼Œæ“ä½œç³»ç»Ÿåˆè¯»å–åˆ°äº†è®¡ç®—åŠ æ³•çš„æŒ‡ä»¤ï¼Œè¿™æ—¶ï¼Œå®ƒå°±éœ€è¦æŒ‡ç¤º CPU å®ŒæˆåŠ æ³•æ“ä½œã€‚è€Œ CPU ä¸å†…å­˜åä½œè¿›è¡ŒåŠ æ³•è®¡ç®—ï¼Œåˆä¼šä½¿ç”¨å¯„å­˜å™¨å­˜æ”¾æ•°å€¼ã€å†…å­˜å †æ ˆä¿å­˜æ‰§è¡Œçš„å‘½ä»¤å’Œå˜é‡ã€‚åŒæ—¶ï¼Œè®¡ç®—æœºé‡Œè¿˜æœ‰è¢«æ‰“å¼€çš„æ–‡ä»¶ï¼Œä»¥åŠå„ç§å„æ ·çš„ I/O è®¾å¤‡åœ¨ä¸æ–­åœ°è°ƒç”¨ä¸­ä¿®æ”¹è‡ªå·±çš„çŠ¶æ€ã€‚\n\n&emsp;&emsp;å°±è¿™æ ·ï¼Œä¸€æ—¦â€œç¨‹åºâ€è¢«æ‰§è¡Œèµ·æ¥ï¼Œå®ƒå°±ä»ç£ç›˜ä¸Šçš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œå˜æˆäº†è®¡ç®—æœºå†…å­˜ä¸­çš„æ•°æ®ã€å¯„å­˜å™¨é‡Œçš„å€¼ã€å †æ ˆä¸­çš„æŒ‡ä»¤ã€è¢«æ‰“å¼€çš„æ–‡ä»¶ï¼Œä»¥åŠå„ç§è®¾å¤‡çš„çŠ¶æ€ä¿¡æ¯çš„ä¸€ä¸ªé›†åˆã€‚\n\n&emsp;&emsp;åƒè¿™æ ·ä¸€ä¸ªç¨‹åºè¿èµ·æ¥åçš„è®¡ç®—æœºæ‰§è¡Œç¯å¢ƒçš„æ€»å’Œï¼Œå°±æ˜¯æˆ‘ä»¬ä»Šå¤©çš„ä¸»è§’ï¼š**è¿›ç¨‹**ã€‚\n\n&emsp;&emsp;æ‰€ä»¥ï¼Œå¯¹äºè¿›ç¨‹æ¥è¯´ï¼Œå®ƒçš„é™æ€è¡¨ç°å°±æ˜¯ç¨‹åºï¼Œå¹³å¸¸éƒ½å®‰å®‰é™é™åœ°å¾…åœ¨ç£ç›˜ä¸Šï¼›è€Œä¸€æ—¦è¿è¡Œèµ·æ¥ï¼Œå®ƒå°±å˜æˆäº†è®¡ç®—æœºé‡Œçš„æ•°æ®å’ŒçŠ¶æ€çš„æ€»å’Œï¼Œè¿™å°±æ˜¯å®ƒçš„åŠ¨æ€è¡¨ç°ã€‚\n\n&emsp;&emsp;è€Œå®¹å™¨æŠ€æœ¯çš„æ ¸å¿ƒåŠŸèƒ½ï¼Œå°±æ˜¯**é€šè¿‡çº¦æŸå’Œä¿®æ”¹è¿›ç¨‹çš„åŠ¨æ€è¡¨ç°ï¼Œä»è€Œä¸ºå…¶åˆ›é€ å‡ºä¸€ä¸ªâ€œè¾¹ç•Œâ€ã€‚**\n\n&emsp;&emsp;å¯¹äº Docker ç­‰å¤§å¤šæ•° Linux å®¹å™¨æ¥è¯´ï¼Œ**Cgroups** æŠ€æœ¯æ˜¯ç”¨æ¥åˆ¶é€ çº¦æŸçš„ä¸»è¦æ‰‹æ®µï¼Œè€Œ **Namespace** æŠ€æœ¯åˆ™æ˜¯ç”¨æ¥ä¿®æ”¹è¿›ç¨‹è§†å›¾çš„ä¸»è¦æ–¹æ³•ã€‚\n\n### é‚£ä»€ä¹ˆæ˜¯ Cgroups å’Œ Namespace ï¼Ÿ\n\n&emsp;&emsp;å‡è®¾ä½ å·²ç»æœ‰äº†ä¸€ä¸ª Linux æ“ä½œç³»ç»Ÿä¸Šçš„ Docker é¡¹ç›®åœ¨è¿è¡Œï¼Œæ¯”å¦‚æˆ‘çš„è™šæ‹Ÿæœºç¯å¢ƒæ˜¯ Ubuntu 16.04 å’Œ Docker CE 18.05ã€‚\n\n&emsp;&emsp;æ¥ä¸‹æ¥ï¼Œè®©æˆ‘ä»¬é¦–å…ˆåˆ›å»ºä¸€ä¸ªå®¹å™¨æ¥è¯•è¯•ã€‚\n\n```bash\ndocker run -it mydocker /bin/sh\n```\n\n&emsp;&emsp;è¿™ä¸ªå‘½ä»¤æ˜¯ Docker é¡¹ç›®æœ€é‡è¦çš„ä¸€ä¸ªæ“ä½œï¼Œå³å¤§åé¼é¼çš„ docker runã€‚\n\nå…¶ä¸­ï¼š\n<ul>\n    <li>-it å‚æ•°å‘Šè¯‰äº† Docker é¡¹ç›®åœ¨å¯åŠ¨å®¹å™¨åï¼Œéœ€è¦ç»™æˆ‘ä»¬åˆ†é…ä¸€ä¸ªæ–‡æœ¬è¾“å…¥/è¾“å‡ºç¯å¢ƒï¼ˆä¹Ÿå°±æ˜¯ TTYï¼‰ï¼Œè·Ÿå®¹å™¨çš„æ ‡å‡†è¾“å…¥ç›¸å…³è”\n    </li>\n    <li>\n    /bin/sh å°±æ˜¯æˆ‘ä»¬è¦åœ¨ Docker å®¹å™¨é‡Œè¿è¡Œçš„ç¨‹åº\n    </li>\n</ul>\n\n&emsp;&emsp;æ‰€ä»¥ï¼Œä¸Šé¢è¿™æ¡æŒ‡ä»¤â€œè¯´äººè¯â€å°±æ˜¯ï¼šè¯·å¸®æˆ‘å¯åŠ¨ä¸€ä¸ªå®¹å™¨ï¼Œåœ¨å®¹å™¨é‡Œæ‰§è¡Œ/bin/shï¼Œå¹¶ä¸”ç»™æˆ‘åˆ†é…ä¸€ä¸ªå‘½ä»¤è¡Œç»ˆç«¯è·Ÿè¿™ä¸ªå®¹å™¨äº¤äº’ã€‚\n\n&emsp;&emsp;è¿™æ ·ï¼Œæˆ‘çš„è™šæ‹Ÿæœºå°±å˜æˆäº†ä¸€ä¸ªå®¿ä¸»æœºï¼Œè€Œä¸€ä¸ªè¿è¡Œç€ /bin/sh çš„å®¹å™¨ï¼Œå°±è·‘åœ¨äº†è¿™ä¸ªå®¿ä¸»æœºé‡Œé¢ã€‚\n\n&emsp;&emsp;æ­¤æ—¶ï¼Œå¦‚æœæˆ‘ä»¬åœ¨å®¹å™¨é‡Œæ‰§è¡Œä¸€ä¸‹ ps æŒ‡ä»¤ï¼Œå°±ä¼šå‘ç°ï¼š\n\n```bash\n# ps\nPID USER TIME COMMAND\n 1 root 0:00 /bin/sh\n10 root 0:00 ps\n```\n\n&emsp;&emsp;å¯ä»¥çœ‹åˆ°ï¼ŒDocker é‡Œåªæœ‰ä¸¤ä¸ªè¿›ç¨‹åœ¨è¿è¡Œã€‚è¿™å°±æ„å‘³ç€ï¼Œå‰é¢æ‰§è¡Œçš„ /bin/shï¼Œä»¥åŠæˆ‘ä»¬åˆšåˆšæ‰§è¡Œçš„ psï¼Œå·²ç»è¢« Docker éš”ç¦»åœ¨äº†ä¸€ä¸ªè·Ÿå®¿ä¸»æœºå®Œå…¨ä¸åŒçš„ä¸–ç•Œå½“ä¸­ã€‚\n\nè¿™ç©¶ç«Ÿæ˜¯æ€ä¹ˆåšåˆ°å‘¢ï¼Ÿ\n\n&emsp;&emsp;æœ¬æ¥ï¼Œæ¯å½“æˆ‘ä»¬åœ¨å®¿ä¸»æœºä¸Šè¿è¡Œäº†ä¸€ä¸ª /bin/sh ç¨‹åºï¼Œæ“ä½œç³»ç»Ÿéƒ½ä¼šç»™å®ƒåˆ†é…ä¸€ä¸ªè¿›ç¨‹ç¼–å·ï¼Œæ¯”å¦‚ PID=100ã€‚è¿™ä¸ªç¼–å·æ˜¯è¿›ç¨‹çš„å”¯ä¸€æ ‡è¯†ï¼Œå°±åƒå‘˜å·¥çš„å·¥ç‰Œä¸€æ ·ã€‚æ‰€ä»¥ PID=100ï¼Œå¯ä»¥ç²—ç•¥åœ°ç†è§£ä¸ºè¿™ä¸ª /bin/sh æ˜¯æˆ‘ä»¬å…¬å¸é‡Œçš„ç¬¬ 100 å·å‘˜å·¥ï¼Œè€Œç¬¬ 1 å·å‘˜å·¥å°±è‡ªç„¶æ˜¯æ¯”å°” Â· ç›–èŒ¨è¿™æ ·ç»Ÿé¢†å…¨å±€çš„äººç‰©ã€‚\n\n&emsp;&emsp;è€Œç°åœ¨ï¼Œæˆ‘ä»¬è¦é€šè¿‡ Docker æŠŠè¿™ä¸ª /bin/sh ç¨‹åºè¿è¡Œåœ¨ä¸€ä¸ªå®¹å™¨å½“ä¸­ã€‚è¿™æ—¶å€™ï¼ŒDocker å°±ä¼šåœ¨è¿™ä¸ªç¬¬ 100 å·å‘˜å·¥å…¥èŒæ—¶ç»™ä»–æ–½ä¸€ä¸ªâ€œéšœçœ¼æ³•â€ï¼Œè®©ä»–æ°¸è¿œçœ‹ä¸åˆ°å‰é¢çš„å…¶ä»– 99 ä¸ªå‘˜å·¥ï¼Œæ›´çœ‹ä¸åˆ°æ¯”å°” Â· ç›–èŒ¨ã€‚è¿™æ ·ï¼Œä»–å°±ä¼šé”™è¯¯åœ°ä»¥ä¸ºè‡ªå·±å°±æ˜¯å…¬å¸é‡Œçš„ç¬¬ 1 å·å‘˜å·¥ã€‚\n\n&emsp;&emsp;è¿™ç§æœºåˆ¶ï¼Œå…¶å®å°±æ˜¯å¯¹è¢«éš”ç¦»åº”ç”¨çš„è¿›ç¨‹ç©ºé—´åšäº†æ‰‹è„šï¼Œä½¿å¾—è¿™äº›è¿›ç¨‹åªèƒ½çœ‹åˆ°é‡æ–°è®¡ç®—è¿‡çš„è¿›ç¨‹ç¼–å·ï¼Œæ¯”å¦‚ PID=1ã€‚å¯å®é™…ä¸Šï¼Œä»–ä»¬åœ¨å®¿ä¸»æœºçš„æ“ä½œç³»ç»Ÿé‡Œï¼Œè¿˜æ˜¯åŸæ¥çš„ç¬¬ 100 å·è¿›ç¨‹ã€‚\n\n&emsp;&emsp;è¿™ç§æŠ€æœ¯ï¼Œå°±æ˜¯ Linux é‡Œé¢çš„ Namespace æœºåˆ¶ã€‚è€Œ Namespace çš„ä½¿ç”¨æ–¹å¼ä¹Ÿéå¸¸æœ‰æ„æ€ï¼š**å®ƒå…¶å®åªæ˜¯ Linux åˆ›å»ºæ–°è¿›ç¨‹çš„ä¸€ä¸ªå¯é€‰å‚æ•°**ã€‚æˆ‘ä»¬çŸ¥é“ï¼Œåœ¨ Linux ç³»ç»Ÿä¸­åˆ›å»ºçº¿ç¨‹çš„ç³»ç»Ÿè°ƒç”¨æ˜¯ clone()ï¼Œæ¯”å¦‚ï¼š\n\n```java\nint pid = clone(main_function, stack_size, CLONE_NEWPID | SIGCHLD, NULL);\n```\n\n&emsp;&emsp;è¿™æ—¶ï¼Œæ–°åˆ›å»ºçš„è¿™ä¸ªè¿›ç¨‹å°†ä¼šâ€œçœ‹åˆ°â€ä¸€ä¸ªå…¨æ–°çš„è¿›ç¨‹ç©ºé—´ï¼Œåœ¨è¿™ä¸ªè¿›ç¨‹ç©ºé—´é‡Œï¼Œå®ƒçš„ PID æ˜¯ 1ã€‚ä¹‹æ‰€ä»¥è¯´â€œçœ‹åˆ°â€ï¼Œæ˜¯å› ä¸ºè¿™åªæ˜¯ä¸€ä¸ªâ€œéšœçœ¼æ³•â€ï¼Œåœ¨å®¿ä¸»æœºçœŸå®çš„è¿›ç¨‹ç©ºé—´é‡Œï¼Œè¿™ä¸ªè¿›ç¨‹çš„ PID è¿˜æ˜¯çœŸå®çš„æ•°å€¼ï¼Œæ¯”å¦‚ 100ã€‚\n\n&emsp;&emsp;å½“ç„¶ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥å¤šæ¬¡æ‰§è¡Œä¸Šé¢çš„ clone() è°ƒç”¨ï¼Œè¿™æ ·å°±ä¼šåˆ›å»ºå¤šä¸ª PID Namespaceï¼Œè€Œæ¯ä¸ª Namespace é‡Œçš„åº”ç”¨è¿›ç¨‹ï¼Œéƒ½ä¼šè®¤ä¸ºè‡ªå·±æ˜¯å½“å‰å®¹å™¨é‡Œçš„ç¬¬ 1 å·è¿›ç¨‹ï¼Œå®ƒä»¬æ—¢çœ‹ä¸åˆ°å®¿ä¸»æœºé‡ŒçœŸæ­£çš„è¿›ç¨‹ç©ºé—´ï¼Œä¹Ÿçœ‹ä¸åˆ°å…¶ä»– PID Namespace é‡Œçš„å…·ä½“æƒ…å†µã€‚\n\n&emsp;&emsp;è€Œ**é™¤äº†æˆ‘ä»¬åˆšåˆšç”¨åˆ°çš„ PID Namespaceï¼ŒLinux æ“ä½œç³»ç»Ÿè¿˜æä¾›äº† Mountã€UTSã€IPCã€Network å’Œ User è¿™äº› Namespaceï¼Œç”¨æ¥å¯¹å„ç§ä¸åŒçš„è¿›ç¨‹ä¸Šä¸‹æ–‡è¿›è¡Œâ€œéšœçœ¼æ³•â€æ“ä½œã€‚**\n\næ¯”å¦‚ï¼Œ\n<ul>\n    <li>Mount Namespaceï¼Œç”¨äºè®©è¢«éš”ç¦»è¿›ç¨‹åªçœ‹åˆ°å½“ Namespace é‡Œçš„æŒ‚è½½ç‚¹ä¿¡æ¯</li>\n    <li>Network Namespaceï¼Œç”¨äºè®©è¢«éš”ç¦»è¿›ç¨‹çœ‹åˆ°å½“å‰ Namespace é‡Œçš„ç½‘ç»œè®¾å¤‡å’Œé…ç½®</li>\n</ul>\n\n**è¿™ï¼Œå°±æ˜¯ Linux å®¹å™¨æœ€åŸºæœ¬çš„å®ç°åŸç†äº†ã€‚**\n\n&emsp;&emsp;æ‰€ä»¥ï¼ŒDocker å®¹å™¨è¿™ä¸ªå¬èµ·æ¥ç„è€Œåˆç„çš„æ¦‚å¿µï¼Œå®é™…ä¸Šæ˜¯åœ¨åˆ›å»ºå®¹å™¨è¿›ç¨‹æ—¶ï¼ŒæŒ‡å®šäº†è¿™ä¸ªè¿›ç¨‹æ‰€éœ€è¦å¯ç”¨çš„ä¸€ç»„ Namespace å‚æ•°ã€‚è¿™æ ·ï¼Œå®¹å™¨å°±åªèƒ½â€œçœ‹â€åˆ°å½“å‰ Namespace æ‰€é™å®šçš„èµ„æºã€æ–‡ä»¶ã€è®¾å¤‡ã€çŠ¶æ€ï¼Œæˆ–è€…é…ç½®ã€‚è€Œå¯¹äºå®¿ä¸»æœºä»¥åŠå…¶ä»–ä¸ç›¸å…³çš„ç¨‹åºï¼Œå®ƒå°±å®Œå…¨çœ‹ä¸åˆ°äº†ã€‚\n\n**æ‰€ä»¥è¯´ï¼Œå®¹å™¨ï¼Œå…¶å®æ˜¯ä¸€ç§ç‰¹æ®Šçš„è¿›ç¨‹è€Œå·²ã€‚**\n\n## æ€»ç»“\n&emsp;&emsp;è°ˆåˆ°ä¸ºâ€œè¿›ç¨‹åˆ’åˆ†ä¸€ä¸ªç‹¬ç«‹ç©ºé—´â€çš„æ€æƒ³ï¼Œç›¸ä¿¡ä½ ä¸€å®šä¼šè”æƒ³åˆ°è™šæ‹Ÿæœºã€‚è€Œä¸”ï¼Œä½ åº”è¯¥è¿˜çœ‹è¿‡ä¸€å¼ è™šæ‹Ÿæœºå’Œå®¹å™¨çš„å¯¹æ¯”å›¾ã€‚\n\n![è™šæ‹Ÿæœºå’Œå®¹å™¨çš„å¯¹æ¯”å›¾](/img/2022-12-12-ç™½è¯å®¹å™¨åŸºç¡€ï¼ˆä¸€ï¼‰ï¼šä»è¿›ç¨‹è¯´å¼€å»/pho1.png)\n\n&emsp;&emsp;è¿™å¹…å›¾çš„å·¦è¾¹ï¼Œç”»å‡ºäº†è™šæ‹Ÿæœºçš„å·¥ä½œåŸç†ã€‚å…¶ä¸­ï¼Œåä¸º **Hypervisor** çš„è½¯ä»¶æ˜¯è™šæ‹Ÿæœºæœ€ä¸»è¦çš„éƒ¨åˆ†ã€‚å®ƒé€šè¿‡ç¡¬ä»¶è™šæ‹ŸåŒ–åŠŸèƒ½ï¼Œæ¨¡æ‹Ÿå‡ºäº†è¿è¡Œä¸€ä¸ªæ“ä½œç³»ç»Ÿéœ€è¦çš„å„ç§ç¡¬ä»¶ï¼Œæ¯”å¦‚ CPUã€å†…å­˜ã€I/O è®¾å¤‡ç­‰ç­‰ã€‚ç„¶åï¼Œå®ƒåœ¨è¿™äº›è™šæ‹Ÿçš„ç¡¬ä»¶ä¸Šå®‰è£…äº†ä¸€ä¸ªæ–°çš„æ“ä½œç³»ç»Ÿï¼Œå³ Guest OSã€‚\n\n&emsp;&emsp;è¿™æ ·ï¼Œç”¨æˆ·çš„åº”ç”¨è¿›ç¨‹å°±å¯ä»¥è¿è¡Œåœ¨è¿™ä¸ªè™šæ‹Ÿçš„æœºå™¨ä¸­ï¼Œå®ƒèƒ½çœ‹åˆ°çš„è‡ªç„¶ä¹Ÿåªæœ‰ Guest OS çš„æ–‡ä»¶å’Œç›®å½•ï¼Œä»¥åŠè¿™ä¸ªæœºå™¨é‡Œçš„è™šæ‹Ÿè®¾å¤‡ã€‚è¿™å°±æ˜¯ä¸ºä»€ä¹ˆè™šæ‹Ÿæœºä¹Ÿèƒ½èµ·åˆ°å°†ä¸åŒçš„åº”ç”¨è¿›ç¨‹ç›¸äº’éš”ç¦»çš„ä½œç”¨ã€‚\n\n&emsp;&emsp;è€Œè¿™å¹…å›¾çš„å³è¾¹ï¼Œåˆ™ç”¨ä¸€ä¸ªåä¸º Docker Engine çš„è½¯ä»¶æ›¿æ¢äº† Hypervisorã€‚è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆï¼Œå¾ˆå¤šäººä¼šæŠŠ Docker é¡¹ç›®ç§°ä¸ºâ€œè½»é‡çº§â€è™šæ‹ŸåŒ–æŠ€æœ¯çš„åŸå› ï¼Œå®é™…ä¸Šå°±æ˜¯æŠŠè™šæ‹Ÿæœºçš„æ¦‚å¿µå¥—åœ¨äº†å®¹å™¨ä¸Šã€‚\n\n&emsp;&emsp;å¯æ˜¯è¿™æ ·çš„è¯´æ³•ï¼Œå´å¹¶ä¸ä¸¥è°¨ã€‚\n\n&emsp;&emsp;åœ¨ç†è§£äº† Namespace çš„å·¥ä½œæ–¹å¼ä¹‹åï¼Œä½ å°±ä¼šæ˜ç™½ï¼Œè·ŸçœŸå®å­˜åœ¨çš„è™šæ‹Ÿæœºä¸åŒï¼Œåœ¨ä½¿ç”¨ Docker çš„æ—¶å€™ï¼Œå¹¶æ²¡æœ‰ä¸€ä¸ªçœŸæ­£çš„â€œDocker å®¹å™¨â€è¿è¡Œåœ¨å®¿ä¸»æœºé‡Œé¢ã€‚Docker é¡¹ç›®å¸®åŠ©ç”¨æˆ·å¯åŠ¨çš„ï¼Œè¿˜æ˜¯åŸæ¥çš„åº”ç”¨è¿›ç¨‹ï¼Œåªä¸è¿‡åœ¨åˆ›å»ºè¿™äº›è¿›ç¨‹æ—¶ï¼ŒDocker ä¸ºå®ƒä»¬åŠ ä¸Šäº†å„ç§å„æ ·çš„ Namespace å‚æ•°ã€‚\n\n&emsp;&emsp;è¿™æ—¶ï¼Œè¿™äº›è¿›ç¨‹å°±ä¼šè§‰å¾—è‡ªå·±æ˜¯å„è‡ª PID Namespace é‡Œçš„ç¬¬ 1 å·è¿›ç¨‹ï¼Œåªèƒ½çœ‹åˆ°å„è‡ª Mount Namespace é‡ŒæŒ‚è½½çš„ç›®å½•å’Œæ–‡ä»¶ï¼Œåªèƒ½è®¿é—®åˆ°å„è‡ª Network Namespace é‡Œçš„ç½‘ç»œè®¾å¤‡ï¼Œå°±ä»¿ä½›è¿è¡Œåœ¨ä¸€ä¸ªä¸ªâ€œå®¹å™¨â€é‡Œé¢ï¼Œä¸ä¸–éš”ç»ã€‚\n\n&emsp;&emsp;ä¸è¿‡ï¼Œç›¸ä¿¡ä½ æ­¤åˆ»å·²ç»ä¼šå¿ƒä¸€ç¬‘ï¼šè¿™äº›ä¸è¿‡éƒ½æ˜¯â€œéšœçœ¼æ³•â€ç½¢äº†ã€‚","tags":["docker","å­¦ä¹ ç¬”è®°"]},{"title":"Docker å’Œ K8s åˆ°åº•æœ‰å•¥å…³ç³»","url":"/2022/12/08/2022-12-08-dockerå’Œk8sçš„å…³ç³»/","content":"\n&emsp;&emsp;å­¦äº†å’Œç”¨äº†ä¸€æ®µæ—¶é—´ Docker å’Œ K8sï¼Œè™½ç„¶å­¦çš„ä¸æ·±ã€ç”¨çš„å¾ˆæµ…ï¼Œä½†æ˜¯çœŸçœŸçœŸæ„Ÿè§‰ä¸¤è€…è”ç³»ç´§å¯†ã€‚ä¸ºäº†æ»¡è¶³è‡ªå·±çš„å¥½å¥‡å¿ƒï¼Œæœé›†äº†å†™èµ„æ–™ï¼Œæ±‡æ€»ä¸€ä¸‹ã€‚<br/>\n&emsp;&emsp;~~æ„Ÿè§‰è‡ªå·±çš„åˆé«˜ä¸­æ—¶ä»£ï¼Œè®¡ç®—æœºé¢†åŸŸçœŸçš„é£äº‘çªå˜å•Šï¼Œæœ‰ç‚¹æ˜¥ç§‹ç™¾å®¶äº‰é¸£çš„æ„Ÿè§‰ã€‚~~\n\n## è§‚ç‚¹\n<ul>\n    <li><b>Docker å’Œ K8s ä¸æ˜¯â€œéæ­¤å³å½¼â€çš„ç«äº‰å¯¹æ‰‹ï¼Œè€Œæ˜¯ä¸¤ç§ç›¸è¾…ç›¸æˆçš„æŠ€æœ¯ã€‚</b></li>\n    <li> Docker æ˜¯ä¸€å®¶æä¾›ä¸€ç³»åˆ—å·¥å…·çš„å…¬å¸ï¼Œè¿™äº›å·¥å…·ç”¨äºæ„å»ºå’Œå…±äº«å®¹å™¨é•œåƒï¼Œä»¥åŠè¿è¡Œå°è§„æ¨¡å’Œå¤§è§„æ¨¡çš„å®¹å™¨ã€‚</li>\n    <li> K8s æ˜¯ä¸€ä¸ªç®¡ç†ï¼ˆâ€œåè°ƒâ€ï¼‰åœ¨æœåŠ¡å™¨é›†ç¾¤ä¸Šè¿è¡Œçš„åŸºäºå®¹å™¨çš„åº”ç”¨ç¨‹åºçš„å·¥å…·ã€‚</li>\n</ul>\n\nå®˜æ–¹å®šä¹‰â€”â€”ç®€è¦ä»‹ç»ï¼š\n1. Docker æ˜¯ä¸€ä¸ªå¼€æºçš„åº”ç”¨å®¹å™¨å¼•æ“ï¼Œå¼€å‘è€…å¯ä»¥æ‰“åŒ…ä»–ä»¬çš„åº”ç”¨åŠä¾èµ–åˆ°ä¸€ä¸ªå¯ç§»æ¤çš„å®¹å™¨ä¸­ï¼Œå‘å¸ƒåˆ°æµè¡Œçš„ Linux æœºå™¨ä¸Šï¼Œä¹Ÿå¯å®ç°è™šæ‹ŸåŒ–ã€‚\n2. K8s æ˜¯ä¸€ä¸ªå¼€æºçš„å®¹å™¨é›†ç¾¤ç®¡ç†ç³»ç»Ÿï¼Œå¯ä»¥å®ç°å®¹å™¨é›†ç¾¤çš„è‡ªåŠ¨åŒ–éƒ¨ç½²ã€è‡ªåŠ¨æ‰©ç¼©å®¹ã€ç»´æŠ¤ç­‰åŠŸèƒ½ã€‚\n\n## ä»€ä¹ˆæ˜¯ Dockerï¼Ÿ\nå®ƒæ˜¯ä¸€ä¸ªå…¬å¸ï¼Œæ˜¯ä¸€å¥—å·¥å…·ï¼Œä¹Ÿæ˜¯ä¸ªå‘½ä»¤......<br/>\n~~Docker å…¬å¸çš„â€œæ­é›„â€æ•…äº‹ï¼Œå¯è‡ªè¡Œç™¾åº¦;~~<br/>\n~~åè¾¹çš„å†…å®¹ï¼ŒæŠŠ Docker çœ‹ä½œæ˜¯å¼€æºçš„æŠ€æœ¯ã€‚~~<br>\n**â€œåˆ†å‰²åº”ç”¨ï¼Œä½¿ä¹‹å®¹å™¨åŒ–ï¼Œä¾¿äºäº¤ä»˜â€**ï¼Œè¿™æ˜¯æˆ‘å¯¹ Docker çš„ç†è§£ã€‚<br/>\né‚£ä¹ˆï¼ŒDockeråˆ°åº•åšäº†ä»€ä¹ˆï¼Œè¿™é‡Œå€Ÿç”¨ Dirk Merkel çš„è¯ï¼š\n\n<blockquote>\n&nbsp;&nbsp;Docker promises the ability to package applications and their dependencies into lightweight containers that move easily between different distros, start up quickly and are isolated from each other.<br>\nï¼ˆDocker æ‰¿è¯ºå°†åº”ç”¨ç¨‹åºåŠå…¶ä¾èµ–æ€§æ‰“åŒ…åˆ°è½»é‡çº§å®¹å™¨ä¸­ï¼Œè½»é‡çº§å®¹å™¨å¯ä»¥åœ¨ä¸åŒå‘è¡Œç‰ˆä¹‹é—´è½»æ¾ç§»åŠ¨ã€å¿«é€Ÿå¯åŠ¨å¹¶å½¼æ­¤éš”ç¦»ã€‚ï¼‰\n</blockquote>\n\nè´¹è¯ä¸€ç‚¹æ¥è¯´ï¼Œä½¿ç”¨ Dockerï¼š<br/>\n&emsp;&emsp;å¼€å‘è€…å¯ä»¥è½»æ¾åœ°æ‰“åŒ…ä»»ä½•åº”ç”¨ä»¥åŠä¾èµ–åŒ…åˆ°ä¸€ä¸ªè½»é‡çº§çš„ã€å¯ç§»æ¤çš„ã€è‡ªç»™è‡ªè¶³çš„å®¹å™¨ä¸­ã€‚ç„¶åå‘å¸ƒåˆ°ä»»ä½•æµè¡Œçš„ Linux æœºå™¨ä¸Šï¼Œä¹Ÿå¯ä»¥å®ç°è™šæ‹ŸåŒ–ã€‚<br/>\n&emsp;&emsp;å¼€å‘è€…æŠŠç¼–è¯‘æµ‹è¯•é€šè¿‡çš„å®¹å™¨å¯ä»¥æ‰¹é‡åœ°åœ¨ç”Ÿäº§ç¯å¢ƒä¸­éƒ¨ç½²ï¼ŒåŒ…æ‹¬ VMsï¼ˆè™šæ‹Ÿæœºï¼‰ã€bare metalã€OpenStack é›†ç¾¤å’Œå…¶ä»–çš„åŸºç¡€åº”ç”¨å¹³å°ã€‚<br/>\n&emsp;&emsp;å®¹å™¨æ˜¯å®Œå…¨ä½¿ç”¨æ²™ç®±æœºåˆ¶ï¼Œç›¸äº’ä¹‹é—´ä¸ä¼šæœ‰ä»»ä½•æ¥å£ã€‚<br/>\n\nDocker ç”Ÿæ€æµç¨‹ï¼š\n\n![dockeræµç¨‹](/img/2022-12-08-dockerå’Œk8sçš„å…³ç³»/pho1.jpg)\n\n**ä¸€ä¸ªå®Œæ•´çš„Dockeræœ‰ä»¥ä¸‹å‡ ä¸ªéƒ¨åˆ†ç»„æˆï¼š**\n<ul>\n    <li> Docker Client å®¢æˆ·ç«¯</li>\n    <li> Docker Daemon å®ˆæŠ¤è¿›ç¨‹</li>\n    <li> Docker Image é•œåƒ</li>\n    <li>Docker Container å®¹å™¨</li>\n</ul>\n\nDockeré€šå¸¸ç”¨äºå¦‚ä¸‹åœºæ™¯ï¼š\n<ul>\n    <li> webåº”ç”¨çš„è‡ªåŠ¨åŒ–æ‰“åŒ…å’Œå‘å¸ƒ</li>\n    <li> è‡ªåŠ¨åŒ–æµ‹è¯•å’ŒæŒç»­é›†æˆã€å‘å¸ƒ</li>\n    <li> åœ¨æœåŠ¡å‹ç¯å¢ƒä¸­éƒ¨ç½²å’Œè°ƒæ•´æ•°æ®åº“æˆ–å…¶ä»–çš„åå°åº”ç”¨</li>\n    <li> ä»å¤´ç¼–è¯‘æˆ–è€…æ‰©å±•ç°æœ‰çš„ OpenShift æˆ– Cloud Foundry å¹³å°æ¥æ­å»ºè‡ªå·±çš„PaaSç¯å¢ƒ</li>\n</ul>\n\n&emsp;&emsp;è™½ç„¶ Docker æä¾›äº†ä¸€ç§é«˜æ•ˆæ–¹å¼æ¥æ‰“åŒ…å’Œå‘å¸ƒå®¹å™¨åŒ–åº”ç”¨ï¼Œä½†ä»…ä¾é  Docker æ¥å®ç°å¤§è§„æ¨¡éƒ¨ç½²å’Œç®¡ç†å®¹å™¨ä»é¢ä¸´æŒ‘æˆ˜ã€‚è·¨å¤šä¸ªæœåŠ¡å™¨/é›†ç¾¤åè°ƒå’Œè°ƒåº¦å®¹å™¨ï¼Œåœ¨é›¶åœæœºçš„å‰æä¸‹å‡çº§æˆ–éƒ¨ç½²åº”ç”¨ï¼Œä»¥åŠç›‘æ§å®¹å™¨çš„è¿è¡ŒçŠ¶å†µï¼Œè¿™äº›ä½¿ç”¨å§¿åŠ¿è¿˜æœ‰å¾…ä¼˜åŒ–ã€‚\n\n&emsp;&emsp;ä¸ºè§£å†³è¿™äº›é—®é¢˜ä»¥åŠå…¶ä»–é—®é¢˜ï¼Œå®¹å™¨ç¼–æ’è§£å†³æ–¹æ¡ˆä»¥ Kubernetesã€Docker Swarmã€Mesosã€HashiCorp Nomad ç­‰å½¢å¼é™†ç»­è¯ç”Ÿï¼Œå®ƒä»¬å¯è®©ç»„ç»‡ç®¡ç†å¤§é‡å®¹å™¨å’Œç”¨æˆ·ã€é«˜æ•ˆå¹³è¡¡è´Ÿè½½ã€æä¾›èº«ä»½éªŒè¯å’Œå®‰å…¨æ€§ï¼Œä»¥åŠå¼€å±•å¤šå¹³å°éƒ¨ç½²ç­‰ç­‰ã€‚\n\n## ä»€ä¹ˆæ˜¯ Kubernetesï¼Ÿ\n&emsp;&emsp;å¦‚æœ docker run æ˜¯åœ¨ç¬”è®°æœ¬ç”µè„‘ä¸Šè¿è¡Œå®¹å™¨çš„æ–¹å¼ï¼Œé‚£ä¹ˆ K8s å°±åƒä¸€ä¸ªæœºå™¨äººï¼Œåœ¨å‡ åä¸ªæˆ–å‡ ç™¾ä¸ªæœåŠ¡å™¨ä¸Šè¿è¡Œ docker runã€‚<br/>\n&emsp;&emsp;Kubernetesï¼ˆå¸¸ç®€ç§°ä¸ºK8sï¼‰æ˜¯ç”¨äºè‡ªåŠ¨éƒ¨ç½²ã€æ‰©å±•å’Œç®¡ç†â€œå®¹å™¨åŒ–åº”ç”¨ç¨‹åºâ€çš„å¼€æºç³»ç»Ÿã€‚å®ƒç›®æ ‡æ˜¯è®©éƒ¨ç½²å®¹å™¨åŒ–åº”ç”¨æ›´ç®€å•é«˜æ•ˆ,æ—¨åœ¨æä¾›ä¸€ä¸ªâ€œè·¨ä¸»æœºé›†ç¾¤çš„è‡ªåŠ¨éƒ¨ç½²ã€æ‰©å±•ä»¥åŠè¿è¡Œåº”ç”¨ç¨‹åºå®¹å™¨â€çš„å¹³å°ã€‚å®ƒæ”¯æŒä¸€ç³»åˆ—å®¹å™¨ç±»å·¥å…·ï¼Œå¯ä»¥è·¨è¶Šç½‘ç»œèµ„æºé›†ç¾¤æ¥ç¼–æ’å®¹å™¨è¿è¡Œæ—¶ç³»ç»Ÿã€‚ä¸è®ºæœ‰æ—  Dockerï¼Œå‡å¯ä½¿ç”¨ K8sã€‚<br/>\nK8s æ¶æ„å›¾ï¼š<br/>\n\n![K8sæ¶æ„](/img/2022-12-08-dockerå’Œk8sçš„å…³ç³»/pho2.jpg)\n\n&emsp;&emsp;åœ¨ K8s ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥åˆ›å»ºå¤šä¸ªå®¹å™¨ï¼Œæ¯ä¸ªå®¹å™¨é‡Œé¢è¿è¡Œä¸€ä¸ªåº”ç”¨å®ä¾‹ï¼Œç„¶åé€šè¿‡å†…ç½®çš„è´Ÿè½½å‡è¡¡ç­–ç•¥ï¼Œå®ç°å¯¹è¿™ä¸€ç»„åº”ç”¨å®ä¾‹çš„ç®¡ç†ã€å‘ç°ã€è®¿é—®ï¼Œè€Œè¿™äº›ç»†èŠ‚éƒ½ä¸éœ€è¦è¿ç»´äººå‘˜å»è¿›è¡Œå¤æ‚çš„æ‰‹å·¥é…ç½®å’Œå¤„ç†ã€‚<br/>\n**K8s ç‰¹ç‚¹**\n<ul>\n    <li> å¯ç§»æ¤: æ”¯æŒå…¬æœ‰äº‘ï¼Œç§æœ‰äº‘ï¼Œæ··åˆäº‘ï¼Œå¤šé‡äº‘ï¼ˆmulti-cloudï¼‰</li>\n    <li> å¯æ‰©å±•: æ¨¡å—åŒ–, æ’ä»¶åŒ–, å¯æŒ‚è½½, å¯ç»„åˆ</li>\n    <li> è‡ªåŠ¨åŒ–: è‡ªåŠ¨éƒ¨ç½²ï¼Œè‡ªåŠ¨é‡å¯ï¼Œè‡ªåŠ¨å¤åˆ¶ï¼Œè‡ªåŠ¨ä¼¸ç¼©/æ‰©å±•</li>\n</ul>\n\n## K8s ä¸ Docker\n![K8sä¸dockerå¯¹æ¯”å›¾](/img/2022-12-08-dockerå’Œk8sçš„å…³ç³»/pho3.jpg)\n\n&emsp;&emsp;Docker æ˜¯ä¸€ä¸ªå®¹å™¨è¿è¡Œç¯å¢ƒï¼ŒK8s åˆ™æ˜¯ä¸€ä¸ªè¿è¡Œå’Œç®¡ç†å®¹å™¨çš„å¹³å°ã€‚K8s æ”¯æŒä¼—å¤šå®¹å™¨è¿è¡Œç¯å¢ƒï¼Œä¾‹å¦‚ Dockerã€containerdã€CRI-O ä»¥åŠ K8s CRIï¼ˆå®¹å™¨è¿è¡Œæ—¶æ¥å£ï¼‰ã€‚åšä¸ªæ°å½“æ¯”å–»ï¼Œå¦‚æœ K8s æ˜¯â€œæ“ä½œç³»ç»Ÿâ€ï¼Œé‚£ä¹ˆ Docker å®¹å™¨å°±æ˜¯æ‚¨å®‰è£…åœ¨â€œæ“ä½œç³»ç»Ÿâ€ä¸Šçš„â€œåº”ç”¨â€ã€‚<br/>\n&emsp;&emsp;å°±å…¶æœ¬èº«è€Œè¨€ï¼ŒDocker å¯¹ç°ä»£åº”ç”¨å¼€å‘åŠ©ç›Šè‰¯å¤šã€‚å®ƒè§£å†³äº†â€œåœ¨æˆ‘çš„æœºå™¨ä¸Šå·¥ä½œâ€çš„å…¸å‹é—®é¢˜ï¼Œä½†å¹¶æœªæ¶‰è¶³å…¶ä»–åœ°æ–¹ã€‚å®¹å™¨ç¼–æ’å·¥å…· Docker Swarm èƒ½å¤Ÿåº”ä»˜éƒ¨ç½²æœ‰å°‘è®¸å®¹å™¨çš„ç”Ÿäº§å®¹å™¨å·¥ä½œè´Ÿè½½ã€‚å½“ç³»ç»Ÿæ‰©å¤§å¹¶éœ€è¦æ·»åŠ è®¸å¤šå½¼æ­¤è”ç½‘çš„å®¹å™¨æ—¶ï¼Œå•çº¯ä½¿ç”¨ Docker å¯èƒ½ä¼šé­é‡ä¸€äº›ä¸æ–­åŠ å‰§çš„éš¾é¢˜ï¼Œè€Œ K8s åˆ™å¯å¸®åŠ©è§£å†³è¿™äº›é—®é¢˜ã€‚<br/>\n&emsp;&emsp;è‹¥è¦æ¯”è¾ƒäºŒè€…ï¼Œæœ€å¥½æ˜¯å°† K8s ä¸ Docker Swarm è¿›è¡Œæ¯”è¾ƒã€‚Docker Swarm æ˜¯ä¸€ç§ç±»ä¼¼äº K8s çš„å®¹å™¨ç¼–æ’å·¥å…·ï¼Œè¿™æ„å‘³ç€å®ƒå…è®¸ç®¡ç†åœ¨è¿è¡Œ Docker æœåŠ¡å™¨çš„å¤šä¸ªä¸»æœºä¸Šéƒ¨ç½²çš„å¤šä¸ªå®¹å™¨ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼ŒSwarm æ¨¡å¼å¤„äºç¦ç”¨çŠ¶æ€ï¼Œéœ€è¦ç”± DevOps å›¢é˜Ÿè¿›è¡Œè®¾ç½®å’Œé…ç½®ã€‚<br/>\n&emsp;&emsp;K8s ç¼–æ’è®¡ç®—æœºé›†ç¾¤ä»¥ååŒå·¥ä½œï¼Œå¹¶æ ¹æ®å¯ç”¨çš„èµ„æºå®‰æ’å®¹å™¨åœ¨è¿™äº›æœºå™¨ä¸Šè¿è¡Œã€‚é€šè¿‡å£°æ˜å¼å®šä¹‰ï¼Œå°†å¤šä¸ªå®¹å™¨ç»„åˆæˆå®¹å™¨é›† (Pod)ï¼Œåè€…æ˜¯ K8s çš„åŸºæœ¬å•å…ƒã€‚K8s è‡ªåŠ¨ç®¡ç†è¯¸å¦‚æœåŠ¡å‘ç°ã€è´Ÿè½½å¹³è¡¡ã€èµ„æºåˆ†é…ã€éš”ç¦»ä»¥åŠå‚ç›´æˆ–æ°´å¹³æ‰©å±•å®¹å™¨é›†ä¸€ç±»çš„æ“ä½œã€‚å¦‚ä»Šå®ƒå·²è¢«å¼€æºç¤¾åŒºé‡‡çº³ï¼Œæˆä¸ºäº‘åŸç”Ÿè®¡ç®—åŸºé‡‘ä¼šçš„ä¸€éƒ¨åˆ†ã€‚Amazonã€Microsoft å’Œ Google å‡åœ¨è‡ªå·±çš„äº‘è®¡ç®—å¹³å°ä¸Šæä¾›æ‰˜ç®¡ K8s æœåŠ¡ï¼Œä»è€Œå¤§å¤§å‡è½»äº†è¿è¡Œå’Œç»´æŠ¤ K8s é›†ç¾¤åŠå…¶å®¹å™¨åŒ–å·¥ä½œè´Ÿè½½çš„è¿è¥è´Ÿæ‹…ã€‚\n\n>å‚è€ƒï¼š\n>1. <a href=\"https://www.atlassian.com/zh/microservices/microservices-architecture/kubernetes-vs-docker\">Kubernetes å’Œ Docker ä¹‹é—´çš„ä¸»è¦åŒºåˆ«ï¼Œä»¥åŠå®ƒä»¬ä¸å®¹å™¨åŒ–æœ‰ä½•å…³ç³»</a>\n>2. <a href=\"https://mp.weixin.qq.com/s?__biz=MzI1NzI5NDM4Mw==&mid=2247483724&idx=2&sn=7868943b1a31fc7bc65c97110ecfc97e&chksm=ea18e80cdd6f611acfea08392e87b1cfc79791b4eafa0e88607b53ab67f2e4f80891324b9a06&token=1662552961&lang=zh_CN&scene=21#wechat_redirect\">Kubernetes å’Œ Docker åˆ°åº•æœ‰å•¥å…³ç³»ï¼Ÿ</a>\n>3. <a href=\"https://www.tutorialworks.com/kubernetes-vs-docker/\">Kubernetes and Docker: Whatâ€™s the difference?</a>\n>4. <a href=\"https://www.huaweicloud.com/zhishi/suyu-docker.html\">å®¹å™¨åº”ç”¨</a>\n","tags":["docker","Kubernetes"]},{"title":"Python ç›´æ¥èµ‹å€¼ã€æµ…æ‹·è´å’Œæ·±åº¦æ‹·è´è§£æ","url":"/2022/12/06/2022-12-06-Pythonç›´æ¥èµ‹å€¼ã€æµ…æ‹·è´å’Œæ·±åº¦æ‹·è´è§£æ/","content":"## ç›´æ¥èµ‹å€¼\nå¯¹è±¡çš„å¼•ç”¨ï¼ˆåˆ«åï¼‰ â€”â€” çˆ¶å­å…±ç”¨<br/>\nå®ä¾‹ï¼š\n```python\n>>> a = {1:[1,2,3]}\n>>> b = a\n>>> # ä¿®æ”¹çˆ¶å¯¹è±¡ï¼Œç»™çˆ¶å¯¹è±¡æ·»åŠ å…ƒç´ ï¼ŒåŒæ—¶å½±å“ a å’Œ b\n>>> b[2] = [4, 5, 6]\n>>> print(\"a=\",a,\",b=\",b)\na= {1: [1, 2, 3], 2: [4, 5, 6]} ,b= {1: [1, 2, 3], 2: [4, 5, 6]}\n>>> # ä¿®æ”¹å†…éƒ¨å­å¯¹è±¡ï¼Œç»™å­å¯¹è±¡æ·»åŠ å…ƒç´ ï¼ŒåŒæ—¶å½±å“ a å’Œ b\n>>> b[1].append(7)\n>>> print(\"a=\",a,\",b=\",b)\na= {1: [1, 2, 3, 7], 2: [4, 5, 6]} ,b= {1: [1, 2, 3, 7], 2: [4, 5, 6]}\n```\nè§£é‡Šåˆ†æï¼š\nb = a: èµ‹å€¼å¼•ç”¨ï¼Œa å’Œ b éƒ½æŒ‡å‘åŒä¸€ä¸ªå¯¹è±¡ã€‚<br/>\n![ç›´æ¥èµ‹å€¼è§£æ](/img/2022-12-06-Pythonç›´æ¥èµ‹å€¼ã€æµ…æ‹·è´å’Œæ·±åº¦æ‹·è´è§£æ/pho1.png)\n\n## æµ…æ‹·è´ï¼ˆcopyï¼‰\næ‹·è´çˆ¶å¯¹è±¡ï¼Œä¸ä¼šæ‹·è´å¯¹è±¡çš„å†…éƒ¨å­å¯¹è±¡ â€”â€” çˆ¶éš”ç¦»ï¼Œå­å…¬ç”¨<br/>\nå®ä¾‹ï¼š\n```python\n>>> import copy\n>>> a = {1: [1, 2, 3]}\n>>> b = copy.copy(a)  # ç­‰åŒäº b = a.copy()\n>>> # ä¿®æ”¹çˆ¶å¯¹è±¡ï¼Œç»™çˆ¶å¯¹è±¡æ·»åŠ å…ƒç´ ï¼Œåªå½±å“ bï¼Œä¸å½±å“ a\n... b[2] = [4, 5, 6]\n>>> print(\"a=\",a,\",b=\",b)\na= {1: [1, 2, 3]} ,b= {1: [1, 2, 3], 2: [4, 5, 6]}\n>>> # ä¿®æ”¹å¯¹è±¡å†…éƒ¨å­å¯¹è±¡ï¼Œç»™å­å¯¹è±¡æ·»åŠ å…ƒç´ ï¼ŒåŒæ—¶å½±å“ a å’Œ b\n... b[1].append(7)\n>>> print(\"a=\",a,\",b=\",b)\na= {1: [1, 2, 3, 7]} ,b= {1: [1, 2, 3, 7], 2: [4, 5, 6]}\n```\n![æµ…æ‹·è´è§£æ](/img/2022-12-06-Pythonç›´æ¥èµ‹å€¼ã€æµ…æ‹·è´å’Œæ·±åº¦æ‹·è´è§£æ/pho2.png)\n\n## æ·±æ‹·è´ï¼ˆdeepcopyï¼‰\ncopyæ¨¡å—çš„ deepcopy æ–¹æ³•ï¼Œå®Œå…¨æ‹·è´äº†çˆ¶å¯¹è±¡åŠå…¶å­å¯¹è±¡ â€”â€” çˆ¶å­éš”ç¦»<br/>\nå®ä¾‹ï¼š\n```python\n>>> import copy\n>>> a = {1: [1, 2, 3]}\n>>> b = copy.deepcopy(a)\n>>> # ä¿®æ”¹çˆ¶å¯¹è±¡ï¼Œç»™çˆ¶å¯¹è±¡æ·»åŠ å…ƒç´ ï¼Œåªå½±å“ bï¼Œä¸å½±å“ a\n... b[2] = [4, 5, 6]\n>>> print(\"a=\",a,\",b=\",b)\na= {1: [1, 2, 3]} ,b= {1: [1, 2, 3], 2: [4, 5, 6]}\n>>>\n>>> # ä¿®æ”¹å¯¹è±¡å†…éƒ¨å­å¯¹è±¡ï¼Œç»™å­å¯¹è±¡æ·»åŠ å…ƒç´ ï¼Œåªå½±å“ bï¼Œä¸å½±å“ a\n... b[1].append(7)\n>>> print(\"a=\",a,\",b=\",b)\na= {1: [1, 2, 3]} ,b= {1: [1, 2, 3, 7], 2: [4, 5, 6]}\n```\n![æ·±æ‹·è´è§£æ](/img/2022-12-06-Pythonç›´æ¥èµ‹å€¼ã€æµ…æ‹·è´å’Œæ·±åº¦æ‹·è´è§£æ/pho3.png)","tags":["python"]},{"title":"å…¥é—¨ Python3 çš„å¿…å¤‡çŸ¥è¯†","url":"/2022/12/06/2022-12-06-ä¸€äº›åŸºç¡€çŸ¥è¯†/","content":"## ä¸€ã€å˜é‡\n### 1.1 å‘½åè§„åˆ™\n  - å˜é‡ååªèƒ½æ˜¯å­—æ¯ã€æ•°å­—æˆ–ä¸‹åˆ’çº¿\n  - å˜é‡åçš„ç¬¬ 1 ä¸ªå­—æ¯ä¸èƒ½æ˜¯æ•°å­—\n  - å˜é‡åä¹Ÿä¸èƒ½æ˜¯ Python çš„å…³é”®å­—\n  - å˜é‡ååŒºåˆ†å¤§å°å†™\n\n## äºŒã€æ•°æ®ç±»å‹\nå…­ç§ï¼šæ•°å­—ã€å­—ç¬¦ä¸²ã€å…ƒç»„ã€åˆ—è¡¨ã€é›†åˆã€å­—å…¸\n\n### 2.1 æ•°å­—\npy3æ”¯æŒ intã€floatã€boolã€complexï¼ˆå¤æ•°ï¼‰   <br/>\nåªæœ‰ä¸€ç§æ•´æ•°ç±»å‹ intï¼Œè¡¨ç¤ºä¸ºé•¿æ•´å‹  <br/>\nå†…ç½®çš„ type() å‡½æ•°å¯ä»¥ç”¨æ¥æŸ¥è¯¢å˜é‡æ‰€æŒ‡çš„å¯¹è±¡ç±»å‹ã€‚  <br/>\n```python\n>>> a,b,c,d=5,6.7,true,2+3j\nTraceback (most recent call last):\n  File \"<stdin>\", line 1, in <module>\nNameError: name 'true' is not defined\n>>> a,b,c,d=5,6.7,True,2+3j\n>>> print(type(a),type(b),type(c),type(d))\n<class 'int'> <class 'float'> <class 'bool'> <class 'complex'>\n```\n**æ³¨æ„** <br/>\n<ul>\n  <li> py å¯ä»¥åŒæ—¶ä¸ºå¤šä¸ªå˜é‡èµ‹å€¼ï¼Œå¦‚ a,b = 1,2</li>\n  <li> ä¸€ä¸ªå˜é‡å¯ä»¥é€šè¿‡èµ‹å€¼æŒ‡å‘ä¸åŒç±»å‹çš„å¯¹è±¡</li>\n  <li> æ•°å€¼çš„é™¤æ³•ï¼ˆ/ï¼‰æ€»æ˜¯è¿”å›ä¸€ä¸ªæµ®ç‚¹æ•°ï¼ˆprintï¼ˆ2/4ï¼‰è¾“å‡º0.5ï¼‰ï¼Œè¦è·å–æ•´æ•°ä½¿ç”¨//æ“ä½œç¬¦</li>\n  <li> åœ¨æ··åˆè®¡ç®—æ—¶ï¼ŒPythonä¼šæŠŠæ•´å‹è½¬æ¢æˆä¸ºæµ®ç‚¹æ•°</li>\n  <li> å¸ƒå°”å‹ï¼šTureå’ŒFalseã€1å’Œ0</li>\n  <li> delè¯­å¥å¯åˆ é™¤å®šä¹‰çš„å¯¹è±¡ï¼Œå¦‚ï¼šdel a,b</li>\n</ul>\n\n### 2.2 String\npyä¸­çš„å­—ç¬¦ä¸²ç”¨å•å¼•å·ï¼ˆ''ï¼‰æˆ–åŒå¼•å·ï¼ˆ\"\"ï¼‰æ‹¬èµ·æ¥ï¼ŒåŒæ—¶ä½¿ç”¨åæ–œæ è½¬ä¹‰ç‰¹æ®Šå­—ç¬¦ã€‚<br/>\nå­—ç¬¦ä¸²çš„æˆªå–çš„è¯­æ³•æ ¼å¼ï¼Œå¦‚ä¸‹ï¼š\n```python\nå˜é‡[å¤´ä¸‹æ ‡:å°¾ä¸‹æ ‡]\n```\nç´¢å¼•å€¼ä»¥ 0 ä¸ºå¼€å§‹å€¼ï¼Œ-1 ä¸ºæœ«å°¾çš„å¼€å§‹å€¼ã€‚<br/>\nåŠ å·ï¼ˆ+ï¼‰æ˜¯å­—ç¬¦ä¸²çš„è¿æ¥ç¬¦ï¼Œæ˜Ÿå·ï¼ˆ*ï¼‰è¡¨ç¤ºå¤åˆ¶å½“å‰å­—ç¬¦ï¼Œç´§è·Ÿçš„æ•°å­—ä¸ºå¤åˆ¶çš„æ¬¡æ•°ã€‚<br/>\nä¾‹å­ï¼š\n```python\n>>> str='hello,world!'\n>>> print(str)  \nhello,world!\n>>> print(str[0:-1])    # è¾“å‡ºç¬¬ä¸€ä¸ªåˆ°å€’æ•°ç¬¬äºŒä¸ªçš„æ‰€æœ‰å­—ç¬¦\nhello,world\n>>> print(str[0])\nh\n>>> print(str[-1])\n!\n>>> print(str[2:5])\nllo\n>>> print(str[2:])\nllo,world!\n>>> print(str * 2)\nhello,world!hello,world!\n>>> print(str + 'Hhhh')\nhello,world!Hhhh\n>>> print('hello\\nworld')\nhello\nworld\n>>> print(r'hello\\nworld')  # åœ¨å­—ç¬¦ä¸²å‰é¢æ·»åŠ ä¸€ä¸ª rï¼Œè¡¨ç¤ºåŸå§‹å­—ç¬¦ä¸²ï¼Œä¸ä¼šå‘ç”Ÿè½¬ä¹‰\nhello\\nworld\n```\n**æ³¨æ„** <br/>\n<ul>\n  <li> åæ–œæ å¯ä»¥ç”¨æ¥è½¬ä¹‰ï¼Œä½¿ç”¨ r å¯ä»¥è®©åæ–œæ ä¸å‘ç”Ÿè½¬ä¹‰</li>\n  <li> å­—ç¬¦ä¸²å¯ä»¥ç”¨ + è¿ç®—ç¬¦è¿æ¥åœ¨ä¸€èµ·ï¼Œç”¨ * è¿ç®—ç¬¦é‡å¤</li>\n  <li> pyä¸­çš„å­—ç¬¦ä¸²æœ‰ä¸¤ç§ç´¢å¼•æ–¹å¼ï¼Œä»å·¦åˆ°å³ä»¥ 0 å¼€å§‹ï¼Œä»å³å¾€å·¦ä»¥ -1 å¼€å§‹</li>\n  <li> pyä¸­çš„å­—ç¬¦ä¸²ä¸èƒ½æ”¹å˜</li>\n  <li> pyæ²¡æœ‰å•ç‹¬çš„å­—ç¬¦ç±»å‹ï¼Œä¸€ä¸ªå­—ç¬¦å°±æ˜¯é•¿åº¦ä¸º 1 çš„å­—ç¬¦ä¸²</li>\n</ul>\n\n### 2.3 Listï¼ˆåˆ—è¡¨ï¼‰\nåˆ—è¡¨ä¸­å…ƒç´ çš„ç±»å‹å¯ä»¥ä¸ç›¸åŒï¼Œå®ƒæ”¯æŒæ•°å­—ï¼Œå­—ç¬¦ä¸²ç”šè‡³å¯ä»¥åŒ…å«åˆ—è¡¨ï¼ˆæ‰€è°“åµŒå¥—ï¼‰ã€‚<br/>\nåˆ—è¡¨æ˜¯å†™åœ¨æ–¹æ‹¬å·[]ä¹‹é—´ã€ç”¨é€—å·åˆ†éš”å¼€çš„å…ƒç´ åˆ—è¡¨ã€‚<br/>\nå’Œå­—ç¬¦ä¸²ä¸€æ ·ï¼Œåˆ—è¡¨åŒæ ·å¯ä»¥è¢«ç´¢å¼•å’Œæˆªå–ï¼Œåˆ—è¡¨è¢«æˆªå–åè¿”å›ä¸€ä¸ªåŒ…å«æ‰€éœ€å…ƒç´ çš„æ–°åˆ—è¡¨ã€‚<br/>\nåˆ—è¡¨æˆªå–çš„è¯­æ³•æ ¼å¼å¦‚ä¸‹ï¼š<br/>\n```python\nå˜é‡[å¤´ä¸‹æ ‡:å°¾ä¸‹æ ‡]\n```\nç´¢å¼•å€¼ä»¥ 0 ä¸ºå¼€å§‹å€¼ï¼Œ-1 ä¸ºä»æœ«å°¾çš„å¼€å§‹ä½ç½®ã€‚<br/>\nåŠ å·ï¼ˆ+ï¼‰æ˜¯åˆ—è¡¨è¿æ¥è¿ç®—ç¬¦ï¼Œæ˜Ÿå·ï¼ˆ*ï¼‰æ˜¯é‡å¤æ“ä½œã€‚\n```python\n>>> list=['hello',357,6.6,'world']\n>>> ttlist=[123,'new']\n>>> print(list)\n['hello', 357, 6.6, 'world']\n>>> print(list[0])\nhello\n>>> print(list[1:3])\n[357, 6.6]\n>>> print(list[2:])\n[6.6, 'world']\n>>> print(ttlist * 2)\n[123, 'new', 123, 'new']\n>>> print(list + ttlist)\n['hello', 357, 6.6, 'world', 123, 'new']\n```\n**æ³¨æ„ï¼š**  <br/>\n<ul>\n  <li> Listå†™åœ¨æ–¹æ‹¬å·ä¹‹é—´ï¼Œå…ƒç´ ç”¨é€—å·éš”å¼€ã€‚</li>\n  <li> å’Œå­—ç¬¦ä¸²ä¸€æ ·ï¼Œlistå¯ä»¥è¢«ç´¢å¼•å’Œåˆ‡ç‰‡.</li>\n  <li> Listå¯ä»¥ä½¿ç”¨+æ“ä½œç¬¦è¿›è¡Œæ‹¼æ¥ã€‚</li>\n  <li> Listä¸­çš„å…ƒç´ æ˜¯å¯ä»¥æ”¹å˜çš„ã€‚</li>\n</ul>\n\n### 2.4 Tupleï¼ˆå…ƒç»„ï¼‰\nå…ƒç»„ï¼ˆtupleï¼‰ä¸åˆ—è¡¨ç±»ä¼¼ï¼Œä¸åŒä¹‹å¤„åœ¨äºå…ƒç»„çš„å…ƒç´ ä¸èƒ½ä¿®æ”¹ã€‚<br/>\nå…ƒç»„å†™åœ¨å°æ‹¬å·()é‡Œï¼Œå…ƒç´ ä¹‹é—´ç”¨é€—å·éš”å¼€ã€‚<br/>\nå…ƒç»„ä¸­çš„å…ƒç´ ç±»å‹ä¹Ÿå¯ä»¥ä¸ç›¸åŒã€‚<br/>\nå…ƒç»„ä¸å­—ç¬¦ä¸²ç±»ä¼¼ï¼Œå¯ä»¥è¢«ç´¢å¼•ä¸”ä¸‹æ ‡ç´¢å¼•ä»0å¼€å§‹ï¼Œ-1 ä¸ºä»æœ«å°¾å¼€å§‹çš„ä½ç½®ã€‚ä¹Ÿå¯ä»¥è¿›è¡Œæˆªå–ã€‚<br/>\nå…¶å®ï¼Œå¯ä»¥æŠŠå­—ç¬¦ä¸²çœ‹ä½œä¸€ç§ç‰¹æ®Šçš„å…ƒç»„ã€‚<br/>\næ„é€ åŒ…å« 0 ä¸ªæˆ– 1 ä¸ªå…ƒç´ çš„å…ƒç»„æ¯”è¾ƒç‰¹æ®Šï¼Œæ‰€ä»¥æœ‰ä¸€äº›é¢å¤–çš„è¯­æ³•è§„åˆ™ï¼š<br/>\n```python\ntup1 = ()     # ç©ºå…ƒç»„\ntup2 = (20,)  # ä¸€ä¸ªå…ƒç´ ï¼Œéœ€è¦åœ¨å…ƒç´ åæ·»åŠ é€—å·  \n```\nstringã€listå’Œtupleéƒ½å±äºsequenceï¼ˆåºåˆ—ï¼‰ã€‚<br/>\n**æ³¨æ„ï¼š**<br/>\n<ul>\n  <li> ä¸å­—ç¬¦ä¸²ä¸€æ ·ï¼Œå…ƒç»„çš„å…ƒç´ ä¸èƒ½ä¿®æ”¹</li>\n  <li> å…ƒç»„ä¹Ÿå¯ä»¥è¢«ç´¢å¼•å’Œåˆ‡ç‰‡ï¼Œæ–¹æ³•ä¸€æ ·</li>\n  <li> æ³¨æ„æ„é€ åŒ…å« 0 æˆ– 1 ä¸ªå…ƒç´ çš„å…ƒç»„çš„ç‰¹æ®Šè¯­æ³•è§„åˆ™</li>\n  <li> å…ƒç»„ä¹Ÿå¯ä»¥ä½¿ç”¨+æ“ä½œç¬¦è¿›è¡Œæ‹¼æ¥</li>\n</ul>\n\n### 2.5 Setsï¼ˆé›†åˆï¼‰\né›†åˆï¼ˆsetï¼‰æ˜¯ä¸€ä¸ªæ— åºä¸é‡å¤å…ƒç´ çš„åºåˆ—ã€‚<br/>\nåŸºæœ¬åŠŸèƒ½æ˜¯è¿›è¡Œæˆå‘˜å…³ç³»æµ‹è¯•å’Œåˆ é™¤é‡å¤å…ƒç´ ã€‚<br/>\nå¯ä»¥ä½¿ç”¨å¤§æ‹¬å· { } æˆ–è€… set() å‡½æ•°åˆ›å»ºé›†åˆï¼Œæ³¨æ„ï¼šåˆ›å»ºä¸€ä¸ªç©ºé›†åˆå¿…é¡»ç”¨ set() è€Œä¸æ˜¯ { }ï¼Œå› ä¸º { } æ˜¯ç”¨æ¥åˆ›å»ºä¸€ä¸ªç©ºå­—å…¸ã€‚<br/>\nä¾‹å­ï¼š<br/>\n```python\n>>> student = {'Tom', 'Jim', 'Mary', 'Tom', 'Jack', 'Rose'}\n>>> print(student)\n{'Mary', 'Jim', 'Rose', 'Jack', 'Tom'}\n>>> if ('Rose' in student):\n...     print('Rose åœ¨é›†åˆä¸­')\n... else:\n...     print('Rose ä¸åœ¨é›†åˆä¸­')\n...\nRose åœ¨é›†åˆä¸­\n>>> a = set('abracadabra')\n>>> b = set('alacazam')\n>>> print(a)\n{'c', 'b', 'r', 'a', 'd'}\n>>> print(b)\n{'c', 'z', 'm', 'a', 'l'}\n>>> print(a - b)  # a å’Œ b çš„å·®é›†\n{'b', 'r', 'd'}\n>>> print(b - a)  # b å’Œ a çš„å·®é›†\n{'l', 'm', 'z'}\n>>> print(a | b)  # a å’Œ b çš„å¹¶é›†\n{'c', 'z', 'b', 'r', 'm', 'a', 'l', 'd'}\n>>> print(a & b)  # a å’Œ b çš„äº¤é›†\n{'a', 'c'}\n>>> print(a ^ b)  # a å’Œ b ä¸­ä¸åŒæ—¶å­˜åœ¨çš„å…ƒç´ \n{'l', 'd', 'z', 'b', 'r', 'm'}\n```\n\n### 2.6 Dictionaryï¼ˆå­—å…¸ï¼‰\nåˆ—è¡¨æ˜¯æœ‰åºçš„å¯¹è±¡ç»“åˆï¼Œå­—å…¸æ˜¯æ— åºçš„å¯¹è±¡é›†åˆã€‚<br/>\nä¸¤è€…ä¹‹é—´çš„åŒºåˆ«åœ¨äºï¼šå­—å…¸å½“ä¸­çš„å…ƒç´ æ˜¯é€šè¿‡é”®æ¥å­˜å–çš„ï¼Œè€Œä¸æ˜¯é€šè¿‡åç§»å­˜å–ã€‚<br/>\nå­—å…¸æ˜¯ä¸€ç§æ˜ å°„ç±»å‹ï¼Œå­—å…¸ç”¨\"{ }\"æ ‡è¯†ï¼Œå®ƒæ˜¯ä¸€ä¸ªæ— åºçš„é”®(key) : å€¼(value)å¯¹é›†åˆã€‚<br/>\né”®(key)å¿…é¡»ä½¿ç”¨ä¸å¯å˜ç±»å‹ã€‚<br/>\nåœ¨åŒä¸€ä¸ªå­—å…¸ä¸­ï¼Œé”®(key)å¿…é¡»æ˜¯å”¯ä¸€çš„ã€‚<br/>\nä¾‹å­ï¼š<br/>\n```python\n>>> dict = {}\n>>> dict['one'] = \"1 - hello,world\"\n>>> dict[2] = \"2 - å˜¿å˜¿\"\n>>> tinydict = {'name': 'lucy', 'code': 100, 'class': '5å¹´çº§6ç­'}\n>>>\n>>> print(dict['one'])  # è¾“å‡ºé”®ä¸º 'one' çš„å€¼\n1 - hello,world\n>>> print(dict[2])  # è¾“å‡ºé”®ä¸º 2 çš„å€¼\n2 - å˜¿å˜¿\n>>> print(tinydict)  # è¾“å‡ºå®Œæ•´çš„å­—å…¸\n{'name': 'lucy', 'code': 100, 'class': '5å¹´çº§6ç­'}\n>>> print(tinydict.keys())  # è¾“å‡ºæ‰€æœ‰é”®\ndict_keys(['name', 'code', 'class'])\n>>> print(tinydict.values())  # è¾“å‡ºæ‰€æœ‰å€¼\ndict_values(['lucy', 100, '5å¹´çº§6ç­'])\n```\n\n**1ã€å†…ç½®å‡½æ•°ï¼š**<br>\nget æ ¹æ® key å€¼å»å–å¯¹åº”çš„ valueï¼Œå–ä¸åˆ°å€¼è¿”å› Noneï¼Œä¸æŠ¥é”™ã€‚\n```python\n>>> dic = {'k1':'v1','k2':'v2'}\n>>> v = dic.get('k1')\n>>> n = dic.get('k4')\n>>> print(v)\nv1\n>>> print(n)\nNone\n```\n\n**2ã€clear æ¸…ç©º**\n```python\n>>> dic = {'k1':'v1','k2':'v2'}\n>>> print(dic)\n{'k1': 'v1', 'k2': 'v2'}\n>>> dic.clear()\n>>> print(dic)\n{}\n```\n\n**2ã€copy æ‹·è´ï¼ˆæµ…æ‹·è´ï¼‰**\n```python\n>>> dic = {'k1':'v1','k2':'v2'}\n>>> v = dic.copy()\n>>> print(v)\n{'k1': 'v1', 'k2': 'v2'}\n```\n\n**3ã€pop åˆ é™¤å¹¶è·å–å¯¹åº”çš„ value å€¼**\n```python\n>>> dic = {'k1':'v1','k2':'v2'}\n>>> v = dic.pop('k1')\n>>> print(dic)\n{'k2': 'v2'}\n>>> print(v)\nv1\n```\n\n**4ã€popitem éšæœºåˆ é™¤é”®å€¼å¯¹ï¼Œå¹¶è·å–åˆ°åˆ é™¤çš„é”®å€¼**\n```python\n>>> dic = {'k1':'v1','k2':'v2'}\n>>> v = dic.popitem()\n>>> print(dic)\n{'k1': 'v1'}\n>>> print(v)\n('k2', 'v2')\n```\n\n**5ã€setdefault å¢åŠ ï¼Œå¦‚æœ key å€¼å­˜åœ¨ï¼Œåˆ™ä¸æ“ä½œ**\n```python\n>>> dic = {'k1':'v1','k2':'v2'}\n>>> dic.setdefault('k3','v3')\n'v3'\n>>> print(dic)\n{'k1': 'v1', 'k2': 'v2', 'k3': 'v3'}\n>>> dic.setdefault('k3','v3')\n'v3'\n>>> print(dic)\n{'k1': 'v1', 'k2': 'v2', 'k3': 'v3'}\n```\n\n**6ã€update æ‰¹é‡å¢åŠ æˆ–ä¿®æ”¹**\n```python\n>>> dic = {'k1':'v1','k2':'v2'}\n>>> dic.update({'k3':'v3','k4':'v4'})\n>>> print(dic)\n{'k1': 'v1', 'k2': 'v2', 'k3': 'v3', 'k4': 'v4'}\n```\n\n**æ³¨æ„ï¼š**<br/>\n<ul>\n  <li> å­—å…¸æ˜¯ä¸€ç§æ˜ å°„ç±»å‹ï¼Œå®ƒçš„å…ƒç´ æ˜¯é”®å€¼å¯¹ã€‚</li>\n  <li> å­—å…¸çš„å…³é”®å­—å¿…é¡»ä¸ºä¸å¯å˜ç±»å‹ï¼Œä¸”ä¸èƒ½é‡å¤ã€‚</li>\n  <li> åˆ›å»ºç©ºå­—å…¸ä½¿ç”¨ { }ã€‚</li>\n</ul>\n\n## ä¸‰ã€æ•°æ®ç±»å‹è½¬æ¢\næ•°æ®ç±»å‹çš„è½¬æ¢ï¼Œä½ åªéœ€è¦å°†æ•°æ®ç±»å‹ä½œä¸ºå‡½æ•°åå³å¯ã€‚<br/>\nä»¥ä¸‹å‡ ä¸ªå†…ç½®çš„å‡½æ•°å¯ä»¥æ‰§è¡Œæ•°æ®ç±»å‹ä¹‹é—´çš„è½¬æ¢ã€‚è¿™äº›å‡½æ•°è¿”å›ä¸€ä¸ªæ–°çš„å¯¹è±¡ï¼Œè¡¨ç¤ºè½¬æ¢çš„å€¼ã€‚<br/>\n\n|  å‡½æ•°  | æè¿°  |\n| :---: | :---: |\n| int(x [,base]) | å°†xè½¬æ¢ä¸ºä¸€ä¸ªæ•´æ•° |\n| float(x) | å°†xè½¬æ¢åˆ°ä¸€ä¸ªæµ®ç‚¹æ•° |\n| complex(real [,imag])\t| åˆ›å»ºä¸€ä¸ªå¤æ•° |\n| str(x) | å°†å¯¹è±¡ x è½¬æ¢ä¸ºå­—ç¬¦ä¸² |\n| repr(x) | å°†å¯¹è±¡ x è½¬æ¢ä¸ºè¡¨è¾¾å¼å­—ç¬¦ä¸² |\n| eval(str)\t| ç”¨æ¥è®¡ç®—åœ¨å­—ç¬¦ä¸²ä¸­çš„æœ‰æ•ˆPythonè¡¨è¾¾å¼,å¹¶è¿”å›ä¸€ä¸ªå¯¹è±¡ |\n| tuple(s) | å°†åºåˆ— s è½¬æ¢ä¸ºä¸€ä¸ªå…ƒç»„ |\n| list(s) | å°†åºåˆ— s è½¬æ¢ä¸ºä¸€ä¸ªåˆ—è¡¨ |\n| set(s) | è½¬æ¢ä¸ºå¯å˜é›†åˆ |\n| dict(d) | åˆ›å»ºä¸€ä¸ªå­—å…¸ã€‚d å¿…é¡»æ˜¯ä¸€ä¸ªåºåˆ— (key,value)å…ƒç»„ã€‚ |\n| frozenset(s) | è½¬æ¢ä¸ºä¸å¯å˜é›†åˆ |\n| chr(x) | å°†ä¸€ä¸ªæ•´æ•°è½¬æ¢ä¸ºä¸€ä¸ªå­—ç¬¦ |\n| unichr(x) | å°†ä¸€ä¸ªæ•´æ•°è½¬æ¢ä¸ºUnicodeå­—ç¬¦ |\n| ord(x) | å°†ä¸€ä¸ªå­—ç¬¦è½¬æ¢ä¸ºå®ƒçš„æ•´æ•°å€¼ |\n| hex(x) | å°†ä¸€ä¸ªæ•´æ•°è½¬æ¢ä¸ºä¸€ä¸ªåå…­è¿›åˆ¶å­—ç¬¦ä¸² |\n| oct(x) | å°†ä¸€ä¸ªæ•´æ•°è½¬æ¢ä¸ºä¸€ä¸ªå…«è¿›åˆ¶å­—ç¬¦ä¸² |\n\n>å‚è€ƒï¼š\nhttps://segmentfault.com/a/1190000009722187","tags":["python"]},{"title":"å›¾è§£SQLçš„æ‰§è¡Œé¡ºåº","url":"/2022/12/04/2022-12-04-å›¾è§£SQLçš„æ‰§è¡Œé¡ºåº/","content":"\nè¿™æ˜¯ä¸€æ¡æ ‡å‡†çš„æŸ¥è¯¢è¯­å¥ï¼š\n\n![æŸ¥è¯¢è¯­å¥](/img/2022-12-04-å›¾è§£SQLçš„æ‰§è¡Œé¡ºåº/pho1.jpg \"æŸ¥è¯¢è¯­å¥.jpg\")\n\nè¿™æ˜¯æˆ‘ä»¬å®é™…ä¸ŠSQLæ‰§è¡Œçš„é¡ºåºï¼š\n1. æ‰§è¡Œ fromï¼Œjoin æ¥ç¡®å®šè¡¨ä¹‹é—´çš„è¿æ¥å…³ç³»ï¼Œå¾—åˆ°åˆæ­¥çš„æ•°æ®ã€‚\n2. where å¯¹æ•°æ®è¿›è¡Œæ™®é€šçš„åˆæ­¥çš„ç­›é€‰\n3. group by åˆ†ç»„\n4. å„ç»„åˆ†åˆ«æ‰§è¡Œ having ä¸­çš„æ™®é€šç­›é€‰æˆ–è€…èšåˆå‡½æ•°ç­›é€‰\n5. è¿›è€Œå¾—åˆ°æˆ‘ä»¬è¦çš„æ•°æ®æºï¼Œå†è¿›è¡Œ selectï¼Œå¯ä»¥æ˜¯æ™®é€šå­—æ®µæŸ¥è¯¢ä¹Ÿå¯ä»¥æ˜¯è·å–èšåˆå‡½æ•°çš„æŸ¥è¯¢ç»“æœï¼Œå¦‚æœæ˜¯èšåˆå‡½æ•°ï¼Œselect çš„æŸ¥è¯¢ç»“æœä¼šæ–°å¢ä¸€ä¸ªå­—æ®µã€‚\n6. å°†æŸ¥è¯¢ç»“æœå»é‡ distinct\n7. æœ€ååˆå¹¶å„ç»„çš„æŸ¥è¯¢ç»“æœï¼ŒæŒ‰ç…§ oder by çš„æ¡ä»¶è¿›è¡Œæ’åº\n\n![æŸ¥è¯¢è¿‡ç¨‹](/img/2022-12-04-å›¾è§£SQLçš„æ‰§è¡Œé¡ºåº/pho2.jpg \"æŸ¥è¯¢è¿‡ç¨‹.jpg\")\n\n## æ•°æ®å…³è”è¿‡ç¨‹\næ•°æ®åº“ä¸­çš„ä¸¤å¼ è¡¨ï¼š\n\n![æ•°æ®è¡¨](/img/2022-12-04-å›¾è§£SQLçš„æ‰§è¡Œé¡ºåº/pho3.jpg \"æ•°æ®è¡¨.jpg\")\n\n### from&jion&where\nç”¨äºç¡®å®šæˆ‘ä»¬è¦æŸ¥è¯¢çš„è¡¨çš„èŒƒå›´ï¼Œæ¶‰åŠé‚£äº›è¡¨ã€‚\né€‰æ‹©ä¸€å¼ è¡¨ï¼Œç„¶å jion è¿æ¥\n```sql\nfrom table1 jion table2 on table1.id=table2.id\n```\nç”¨äºå¤šå¼ è¡¨ï¼Œç”¨ where åšå…³è”æ¡ä»¶\n```sql\nfrom table1 jion table2 where table1.id=table2.id\n```\næˆ‘ä»¬ä¼šå¾—åˆ°æ»¡è¶³å…³è”æ¡ä»¶çš„ä¸¤å¼ è¡¨çš„æ•°æ®ï¼Œä¸åŠ å…³è”æ¡ä»¶ä¼šå‡ºç°ç¬›å¡å°”ç§¯ã€‚\n\n![å…³è”è¡¨](/img/2022-12-04-å›¾è§£SQLçš„æ‰§è¡Œé¡ºåº/pho4.jpg \"å…³è”è¡¨.jpg\")\n\n### group by\næŒ‰ç…§æˆ‘ä»¬çš„åˆ†ç»„æ¡ä»¶ï¼Œå°†æ•°æ®è¿›è¡Œåˆ†ç»„ï¼Œä½†ä¸ä¼šç­›é€‰æ•°æ®ã€‚\næ¯”å¦‚æŒ‰ç…§ id çš„å¥‡å¶åˆ†ç»„ï¼š\n\n![id å¥‡å¶åˆ†ç»„](/img/2022-12-04-å›¾è§£SQLçš„æ‰§è¡Œé¡ºåº/pho5.jpg \"id å¥‡å¶åˆ†ç»„.jpg\")\n\n### having&where\nhaving ä¸­å¯ä»¥æ˜¯æ™®é€šæ¡ä»¶çš„ç­›é€‰ï¼Œä¹Ÿèƒ½æ˜¯èšåˆå‡½æ•°ï¼Œè€Œ where åªèƒ½æ˜¯èšåˆå‡½æ•°ï¼Œä¸€èˆ¬æƒ…å†µä¸‹ï¼Œæœ‰ having å¯ä»¥ä¸å†™ whereï¼ŒæŠŠ where çš„ç­›é€‰æ”¾åœ¨ having é‡Œï¼ŒSQL è¯­å¥çœ‹ä¸Šå»æ›´é¡ºæ»‘ã€‚\n\n### ä½¿ç”¨ where å† group by\nå…ˆæŠŠä¸æ»¡è¶³whereæ¡ä»¶çš„æ•°æ®åˆ é™¤ï¼Œå†å»åˆ†ç»„\n\n### ä½¿ç”¨ group by å† where \nå…ˆåˆ†ç»„å†åˆ é™¤ä¸æ»¡è¶³ having æ¡ä»¶çš„æ•°æ®ï¼Œè¿™ä¸¤ç§æ–¹æ³•æœ‰åŒºåˆ«å—ï¼Œå‡ ä¹æ²¡æœ‰ï¼\nä¸¾ä¸ªä¾‹å­ï¼š\n100/2=50ï¼Œæ­¤æ—¶æˆ‘ä»¬æŠŠ 100 æ‹†åˆ† (10+10+10+10+10â€¦)/2=5+5+5+â€¦+5=50,åªè¦ç­›é€‰æ¡ä»¶æ²¡å˜ï¼Œå³ä¾¿æ˜¯åˆ†ç»„äº†ä¹Ÿå¾—æ»¡è¶³ç­›é€‰æ¡ä»¶ï¼Œæ‰€ä»¥ whereå group by å’Œ group by å† having æ˜¯ä¸å½±å“ç»“æœçš„ï¼\n\nä¸åŒçš„æ˜¯ï¼Œhaving è¯­æ³•æ”¯æŒèšåˆå‡½æ•°,å…¶å® having çš„æ„æ€å°±æ˜¯é’ˆå¯¹æ¯ç»„çš„æ¡ä»¶è¿›è¡Œç­›é€‰ã€‚æˆ‘ä»¬ä¹‹å‰çœ‹åˆ°äº†æ™®é€šçš„ç­›é€‰æ¡ä»¶æ˜¯ä¸å½±å“çš„ï¼Œä½†æ˜¯having è¿˜æ”¯æŒèšåˆå‡½æ•°ï¼Œè¿™æ˜¯ where æ— æ³•å®ç°çš„ã€‚\nå½“å‰æ•°æ®åˆ†ç»„æƒ…å†µ\n\n![å½“å‰åˆ†ç»„æƒ…å†µ](/img/2022-12-04-å›¾è§£SQLçš„æ‰§è¡Œé¡ºåº/pho6.jpg \"å½“å‰åˆ†ç»„æƒ…å†µ.jpg\")\n\næ‰§è¡Œ having çš„ç­›é€‰æ¡ä»¶ï¼Œå¯ä»¥ä½¿ç”¨èšåˆå‡½æ•°ã€‚ç­›é€‰æ‰å·¥èµ„å°äºå„ç»„å¹³å‡å·¥èµ„çš„ having salary<avg(salary)\n\n![åˆ†ç»„åçš„æƒ…å†µ](/img/2022-12-04-å›¾è§£SQLçš„æ‰§è¡Œé¡ºåº/pho7.jpg \"åˆ†ç»„åçš„æƒ…å†µ.jpg\")\n\n### select\nåˆ†ç»„ç»“æŸä¹‹åï¼Œæˆ‘ä»¬å†æ‰§è¡Œ select è¯­å¥ï¼Œå› ä¸ºèšåˆå‡½æ•°æ˜¯ä¾èµ–äºåˆ†ç»„çš„ï¼Œèšåˆå‡½æ•°ä¼šå•ç‹¬æ–°å¢ä¸€ä¸ªæŸ¥è¯¢å‡ºæ¥çš„å­—æ®µï¼Œè¿™é‡Œç”¨ç´«è‰²è¡¨ç¤ºï¼Œè¿™é‡Œæˆ‘ä»¬ä¸¤ä¸ª id é‡å¤äº†ï¼Œæˆ‘ä»¬å°±ä¿ç•™ä¸€ä¸ª idï¼Œé‡å¤å­—æ®µåéœ€è¦æŒ‡å‘æ¥è‡ªå“ªå¼ è¡¨ï¼Œå¦åˆ™ä¼šå‡ºç°å”¯ä¸€æ€§é—®é¢˜ã€‚æœ€åæŒ‰ç…§ç”¨æˆ·åå»é‡ã€‚\n```sql\nselect employee.id,distinct name,salary, avg(salary)\n```\n\n![selectç¤ºæ„å›¾](/img/2022-12-04-å›¾è§£SQLçš„æ‰§è¡Œé¡ºåº/pho8.jpg \"selectç¤ºæ„å›¾.jpg\")\n\nå°†å„ç»„havingä¹‹åçš„æ•°æ®å†åˆå¹¶æ•°æ®ã€‚\n\n![havingç¤ºæ„å›¾](/img/2022-12-04-å›¾è§£SQLçš„æ‰§è¡Œé¡ºåº/pho9.jpg \"havingç¤ºæ„å›¾.jpg\")\n\n### order by\næœ€åæˆ‘ä»¬æ‰§è¡Œ order by å°†æ•°æ®æŒ‰ç…§ä¸€å®šé¡ºåºæ’åºï¼Œæ¯”å¦‚è¿™é‡ŒæŒ‰ç…§ id æ’åºã€‚å¦‚æœæ­¤æ—¶æœ‰ limit é‚£ä¹ˆæŸ¥è¯¢åˆ°ç›¸åº”çš„æˆ‘ä»¬éœ€è¦çš„è®°å½•æ•°æ—¶ï¼Œå°±ä¸ç»§ç»­å¾€ä¸‹æŸ¥äº†ã€‚\n\n![orderç¤ºæ„å›¾](/img/2022-12-04-å›¾è§£SQLçš„æ‰§è¡Œé¡ºåº/pho10.jpg \"orderç¤ºæ„å›¾.jpg\")\n\n### limit\nè®°ä½ limit æ˜¯æœ€åæŸ¥è¯¢çš„ï¼Œä¸ºä»€ä¹ˆå‘¢ï¼Ÿå‡å¦‚æˆ‘ä»¬è¦æŸ¥è¯¢å¹´çº§æœ€å°çš„ä¸‰ä¸ªæ•°æ®ï¼Œå¦‚æœåœ¨æ’åºä¹‹å‰å°±æˆªå–åˆ° 3 ä¸ªæ•°æ®ã€‚å®é™…ä¸ŠæŸ¥è¯¢å‡ºæ¥çš„ä¸æ˜¯æœ€å°çš„ä¸‰ä¸ªæ•°æ®è€Œæ˜¯å‰ä¸‰ä¸ªæ•°æ®äº†ï¼Œè®°ä½è¿™ä¸€ç‚¹ã€‚\n\næˆ‘ä»¬å¦‚æœlimit 0,3 çªƒå–å‰ä¸‰ä¸ªæ•°æ®å†æ’åºï¼Œå®é™…ä¸Šæœ€å°‘å·¥èµ„çš„æ˜¯2000,3000,4000ã€‚ä½ è¿™é‡Œåªèƒ½æ˜¯4000,5000,8000äº†ã€‚\n\n![limitç¤ºæ„å›¾](/img/2022-12-04-å›¾è§£SQLçš„æ‰§è¡Œé¡ºåº/pho11.jpg \"limitç¤ºæ„å›¾.jpg\")\n\n>å‚è€ƒ\nblog.csdn.net/weixin_44141495/article/details/108744720\n","tags":["sql"]},{"title":"vim å®ç”¨æŠ€å·§ï¼ˆäºŒï¼‰","url":"/2022/12/03/2022-12-03-vimå®ç”¨æŠ€å·§ï¼ˆäºŒï¼‰/","content":"\n## åŸºæœ¬å‘½ä»¤\n\nvim å‘½ä»¤é€ŸæŸ¥<br/>\n![vim å‘½ä»¤é€ŸæŸ¥](/img/2022-12-03-vimå®ç”¨æŠ€å·§ï¼ˆäºŒï¼‰/vim_orders.png \"vim_orders.png\")\n\n1. yy å¤åˆ¶ä¸€è¡Œï¼Œnyy å¤åˆ¶å½“å‰å…‰æ ‡ä¹‹åçš„ n è¡Œï¼Œp ç²˜è´´\n2. dd åˆ é™¤ä¸€è¡Œï¼Œndd åˆ é™¤å½“å‰å…‰æ ‡ä¹‹åçš„ n è¡Œ\n3. æ˜¾ç¤ºè¡Œå·ï¼šset number\n4. ä»ç¬¬ä¸€è¡Œå¼€å§‹å…¨æ–‡æ›¿æ¢ï¼š1,$s/<æºå­—ç¬¦ä¸²>/<ç›®æ ‡å­—ç¬¦ä¸²>/g \n5. æŸ¥æ‰¾æŸä¸ªå­—ç¬¦ä¸²ï¼š/<ç›®æ ‡å­—ç¬¦ä¸²>\n6. å›åˆ°æ–‡å°¾ï¼š$ è¡Œé¦–ï¼š0","tags":["linux","vim"],"categories":["linux å‘½ä»¤"]},{"title":"vim å®ç”¨æŠ€å·§ï¼ˆä¸€ï¼‰","url":"/2022/12/02/2022-12-02-vimå®ç”¨æŠ€å·§ï¼ˆä¸€ï¼‰/","content":"\n## å¯¼è¯­\n**vim å·ç§°ç¼–è¯‘ä¹‹ç¥ï¼Œå”¯å¿«ä¸ç ´ï¼Œå¯æ‹“å±•ï¼Œæ’ä»¶éå¤©ä¸‹ã€‚å­¦ä¹ æ›²çº¿è™½æ›²æŠ˜ï¼Œä½†æ˜¯å­¦æˆä¹‹åï¼ŒåŸºæœ¬å°±æˆè‚Œè‚‰è®°å¿†äº†ï¼Œå†™ç¨‹åºåŒæ‰‹ä¸ç¦»é”®ç›˜ï¼Œä¸Šä¸‹è…¾é£ï¼Œå¯è°“å¿«æ„ç¼–ç¨‹ã€‚**\n<br>\n<p style=\"text-align:right\"><b>--æå®¢æ—¶é—´</b></p>\n\n## ç®€ä»‹\n### å››ç§æ¨¡å¼\n<ul>\n  <li> æ™®é€šæ¨¡å¼ï¼švim å¯åŠ¨åçš„é»˜è®¤æ¨¡å¼ï¼Œç”¨æ¥ç§»åŠ¨å…‰æ ‡ã€åˆ é™¤æ–‡æœ¬ã€è¦†ç›–è¾“å…¥æ–‡æœ¬ã€å›å¤æ“ä½œã€ç²˜è´´æ–‡æœ¬ç­‰ç­‰ã€‚</li> \n  <li> æ’å…¥æ¨¡å¼ï¼šè¾“å…¥ i æˆ– a è¿›å…¥æ’å…¥æ¨¡å¼ï¼Œåœ¨è¿™ä¸ªæ¨¡å¼ä¸‹æ•²å‡»é”®ç›˜ä¼šå¾€æ–‡å­—ç¼“å†²åŒºå¢åŠ æ–‡å­—ï¼Œç›¸å½“äºæ™®é€šç¼–è¯‘å™¨çš„ç¼–è¾‘æ¨¡å¼ã€‚</li> \n  <li> å¯è§†æ¨¡å¼ï¼šé€‰æ‹©æ–‡æœ¬ï¼Œå¯ä»¥è¡Œé€‰ã€å—é€‰å’Œä¾æ¬¡é€‰æ‹©ï¼Œé€‰æ‹©åå¯ä»¥è¿›è¡Œå¤åˆ¶ã€åˆ é™¤ã€æ’åºç­‰æ“ä½œã€‚</li> \n  <li> å‘½ä»¤æ¨¡å¼ï¼šæ‰§è¡Œå†…éƒ¨å’Œå¤–éƒ¨å‘½ä»¤ï¼Œé€šè¿‡ \":\" \"/\" \"?\" \":!\" å¯ä»¥è¿›å…¥å‘½ä»¤æ¨¡å¼ï¼šæ‰§è¡Œå†…éƒ¨å‘½ä»¤ã€å‘ä¸Šæˆ–å‘ä¸‹æœç´¢ã€æ‰§è¡Œå¤–éƒ¨å‘½ä»¤ã€‚</li> \n</ul>\n\n## å®‰è£…\n\nä¸€èˆ¬æ˜¯é»˜è®¤å®‰è£…\n### Linux ä¸‹çš„å®‰è£…\n\n#### Red Hat å’Œ CentOS ç³»åˆ—\n\næŸ¥çœ‹å·²ç»å®‰è£…çš„ vim ç‰ˆæœ¬ï¼š\n\n```bash\nyum list installed | grep vim\n```\n\nå¦‚æœè¾“å‡ºå¦‚ä¸‹ï¼Œåˆ™è¯´æ˜å®‰è£…çš„ vim ç‰ˆæœ¬åªæœ‰åŸºæœ¬åŠŸèƒ½ï¼š\n\n```bash\nvim-minimal.x86_64 2:8.0.1763-13.el8 @System\n```\n\n~~æ¨è~~\n\n```bash\nsudo yum install vim-X11    # å®‰è£…å›¾å½¢ç•Œé¢vim\nsudo yum install vim-enhanced   # å®‰è£…å¢å¼ºç‰ˆæœ¬vim\n```\n\n#### Debin å’Œ Ubuntu ç³»åˆ—\n\næŸ¥çœ‹å·²ç»å®‰è£…çš„ vim ç‰ˆæœ¬ï¼š\n\n```bash\napt list --installed | grep vim\n```\n\n~~æ¨è~~\n\n```bash\nsudo apt update # æ›´æ–°ç¯å¢ƒ\nsudo apt install vim-gtk3 \n```\n\n### MacOS ä¸‹çš„å®‰è£…\n\nå®‰è£… MacVim æœ‰ä¸¤ç§å¸¸è§æ–¹å¼ï¼š\n<ul>\n  <li> ä½¿ç”¨ Homebrew ã€‚ï¼ˆæ¨èï¼‰ </li>\n  <li> ä½¿ç”¨ MacVim çš„ç‹¬ç«‹å®‰è£…åŒ…ã€‚</li>\n</ul>\n\nä½¿ç”¨ Homebrew å®‰è£… Macvimï¼š\n1. å®‰è£… Homebrew ã€‚<a href='https://brew.sh/index_zh-cn'>~~å®˜ç½‘ç½‘å€~~</a>\n2. é…ç½® .bash_profile\n\n```bash\nif [[ $PATH != \"$HOME/bin\"* ]]; then\n  PATH=~/bin:/usr/local/bin:/usr/local/sbin:`echo $PATH|sed -e \"s!:$HOME/bin!!\" -e 's!:/usr/local/bin!!'`\nfi\n```\n\nè¿™æ ·ï¼Œå¯ä»¥ç¡®ä¿ä¸ªäººçš„è·¯å¾„ä¼˜å…ˆäº /usr/localï¼Œè€Œ /usr/local ä¸‹çš„è·¯å¾„åˆä¼˜å…ˆäºç³»ç»Ÿçš„è·¯å¾„ã€‚\nç„¶åæ‰§è¡Œï¼š\n\n```bash\nbrew install macvim\nvim -g / gvim # å¯åŠ¨ vim å›¾å½¢ç•Œé¢\n```\n\n### windows ä¸‹çš„å®‰è£…\n\nvim ç½‘ç«™ä¸‹è½½ï¼š<a href='https://www.vim_.org/download.php#pc'>Downloading Vim</a>ã€‚å®‰è£…å®Œåï¼Œvim ä¼šç¼ºçœæ‰“å¼€ä¸€ä¸ª README æ–‡ä»¶ã€‚åœ¨è¿™ä¸ªçª—å£ï¼Œè¾“å…¥ï¼š\n\n```bash\n:e ~\\_vimrc \n```\n\nå›è½¦å†è¾“å…¥ï¼š\n\n```bash\nset enc=utf-8\nset nocompatible\nsource $VIMRUNTIME/vimrc_example.vim\n```\n\nç„¶ååœ¨è¾“å…¥\n\n```bash\nZZ\n```\nå­˜ç›˜é€€å‡ºå³å¯ã€‚\n\n## vim æ‰‹å†Œ\n\n<a href='https://github.com/yianwillis/vimcdoc/releases'>å¤§ä½¬ç½‘å€</a>\n\næœ‰ vim ä¸­æ–‡æ‰‹å†Œå’Œ vim ä¸­æ–‡ç”¨æˆ·æ‰‹å†Œ","tags":["linux","vim"]},{"title":"æ–°çš„å¼€å§‹","url":"/2022/12/01/2022-12-01-a_æ–°çš„å¼€å§‹/","content":"\n## ä¸€ä¸ªå­¤ç‹¬ç å†œçš„æ·±å¤œéæƒ³\n<p>å¤§å­¦æ—¶ä»£ï¼Œå°±ä¸€ç›´æƒ³è‡ªå·±å†™ä¸ªç½‘ç«™ã€‚ä¸€ç›´æ¨è„±ï¼Œæƒ³ç€æ˜å¤©å†å†™ã€æ˜å¤©å†å†™</p>\n<p>ç»“æœ...</p>\n<p>å°±æ¯•ä¸šäº†</p>\n\næ¯•ä¸šä»¿ä½›å°±åœ¨æ˜¨å¤©ï¼Œå“....ä¸çŸ¥é“è¯¥è¯´ä»€ä¹ˆ\n\nå‰å°˜å¾€äº‹ï¼Œè«å†æåŠ\n\nå¸Œæœ›æˆ‘èƒ½åšæŒä¸‹å»....\n\n2022-12-01 23:39:28\n\n","tags":["éšè®°"]}]