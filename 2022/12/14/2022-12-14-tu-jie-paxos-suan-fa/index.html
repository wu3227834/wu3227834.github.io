<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><meta property="og:description" content="这里是小布丁的私有小屋"><meta property="og:type" content="website"><meta name="description" content="这里是小布丁的私有小屋"><link rel="shortcut icon" href="/img/favicon.ico"><title>图解 Paxos 算法</title><link rel="stylesheet" href="/css/aircloud.css"><link rel="stylesheet" href="/css/gitment.css"><link rel="stylesheet" href="/css/prism.css"><link href="//at.alicdn.com/t/font_620856_28hi1hpxx24.css" rel="stylesheet" type="text/css"><script></script><script defer src="https://cloud.umami.is/script.js" data-website-id="bad0a741-25cb-4dd6-bbcf-f5710aeb243c"></script><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="Pudding 日常" type="application/atom+xml"></head><body><div class="site-nav-toggle" id="site-nav-toggle"><button><span class="btn-bar"></span> <span class="btn-bar"></span> <span class="btn-bar"></span></button></div><div class="index-about"><i>a week is 2% of the year</i></div><div class="index-container"><div class="index-left"><div class="nav" id="nav"><div class="avatar-name"><div class="avatar"><img src="/img/avatar.png"></div><div class="name"><i>Pudding</i></div></div><div class="contents" id="nav-content"><ul><li><a href="/"><i class="iconfont icon-shouye1"></i> <span>主页</span></a></li><li><a href="/tags"><i class="iconfont icon-biaoqian1"></i> <span>标签</span></a></li><li><a href="/archive"><i class="iconfont icon-guidang2"></i> <span>存档</span></a></li><li><a href="/about/"><i class="iconfont icon-guanyu2"></i> <span>关于</span></a></li><li><a id="search"><i class="iconfont icon-sousuo1"></i> <span>搜索</span></a></li></ul></div><div id="toc" class="toc-article"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Basic-Paxos"><span class="toc-text">Basic Paxos</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%80%9D%E8%80%83%E9%A2%98"><span class="toc-text">思考题</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Paxos-%E6%B6%89%E5%8F%8A%E7%9A%84%E6%A6%82%E5%BF%B5"><span class="toc-text">Paxos 涉及的概念</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E8%BE%BE%E6%88%90%E5%85%B1%E8%AF%86"><span class="toc-text">如何达成共识</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%87%86%E5%A4%87%E9%98%B6%E6%AE%B5"><span class="toc-text">准备阶段</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8E%A5%E5%8F%97%E9%98%B6%E6%AE%B5"><span class="toc-text">接受阶段</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8E%A5%E5%8F%97%E8%80%85%E5%AD%98%E5%9C%A8%E5%B7%B2%E9%80%9A%E8%BF%87%E6%8F%90%E6%A1%88%E7%9A%84%E6%83%85%E5%86%B5"><span class="toc-text">接受者存在已通过提案的情况</span></a></li></ol></li></ol></div></div><div class="search-field" id="search-field"><div class="search-bg" id="search-bg"></div><div class="search-container"><div class="search-input"><span id="esc-search"><i class="icon-fanhui iconfont"></i></span> <input id="search-input"> <span id="begin-search">搜索</span></div><div class="search-result-container" id="search-result-container"></div></div></div><div class="index-about-mobile"><i>a week is 2% of the year</i></div></div><div class="index-middle"><div class="post-container"><div class="post-title">图解 Paxos 算法</div><div class="post-meta"><span class="attr">发布于：<span>2022-12-14</span></span> <span class="attr">标签：/ <a class="tag" href="/tags/#学习笔记" title="学习笔记">学习笔记</a> <span>/</span> <a class="tag" href="/tags/#paxos" title="paxos">paxos</a> <span>/</span> <a class="tag" href="/tags/#分布式架构" title="分布式架构">分布式架构</a> <span>/</span> </span><span class="attr">访问：<span id="busuanzi_value_page_pv"></span></span></div><div class="post-content no-indent"><p>&emsp;&emsp;Paxos 算法是一个分布式共识算法，由 Leslie Lamport 在 1989 年提出，该算法理解起来有一定的难度，本文尝试图形化解析 Paxos 算法。</p><p>Lamport 提出的 Paxos 算法包括两个部分：</p><ul><li>Basic Paxos 算法：多节点如何就某个值（提案Value）达成共识</li><li>Multi-Paxos 思想：执行多个 Basic Paxos 实例，就一系列的值达成共识</li></ul><h2 id="Basic-Paxos"><a href="#Basic-Paxos" class="headerlink" title="Basic Paxos"></a>Basic Paxos</h2><h3 id="思考题"><a href="#思考题" class="headerlink" title="思考题"></a>思考题</h3><p>&emsp;&emsp;假设现在有一个三节点的分布式集群，提供只读 KV 存储服务。只读 KV 服务，既创建只读变量（key）的时候，必须要对它进行赋值（value），而且这个值后续没办法修改。也就是说，只读变量在创建后就不能被修改了，所以所有节点必须要先对只读变量的值达成共识，然后再去创建这个只读变量。</p><p>&emsp;&emsp;那么，当有多个客户端（比如客户端 1、2）访问这个系统，试图创建同一个只读变量（比如 X），客户端 1 试图创建值为 5 的 X，客户端 2 试图创建值为 7 的 X，这样要如何达成共识，实现各节点上 X 值的一致呢？</p><p><img src="/img/2022-12-14-%E5%9B%BE%E8%A7%A3Paxos%E7%AE%97%E6%B3%95/pho1.png" alt="如何在多个节点间确定某变量的值" title="图1"></p><p>在解决这个问题之前，先了解一下 Basic Paxos 的几个概念。</p><h3 id="Paxos-涉及的概念"><a href="#Paxos-涉及的概念" class="headerlink" title="Paxos 涉及的概念"></a>Paxos 涉及的概念</h3><p>在 Basic Paxos 中，有提议者（Proposer）、接受者（Acceptor）、学习者（Learner）三种角色：</p><ul><li>提议者：提议一个值，用于投票表决。为了方便演示，你可以把图 1 中的客户端 1 和 2 看作是提议者。但在绝大多数场景中，集群中收到客户端请求的节点，才是提议者（图 1 这个架构，是为了方便演示算法原理）。</li><li>接受者：每个提议的值进行投票，并存储接受的值，比如 A、B、C 三个节点。</li><li>学习者：被告知投票的结果，接受达成共识的值，存储保存，不参与投票的过程。</li></ul><p>需要指出的是，<strong>一个节点，既可以是提议者，也可以是接受者</strong>；他们之间的关系如下：</p><p><img src="/img/2022-12-14-%E5%9B%BE%E8%A7%A3Paxos%E7%AE%97%E6%B3%95/pho2.png" alt="角色之间的关系" title="图2"></p><p>其实，这三种角色，在本质上代表的是三种功能：</p><ul><li>提议者代表的是接入和协调功能，收到客户端请求后，发起二阶段提交，进行共识协商</li><li>接受者代表投票协商和存储数据，对提议的值进行投票，并接受达成共识的值，存储保存</li><li>学习者代表存储数据，不参与共识协商，只接受达成共识的值，存储保存</li></ul><p>那么接下来，咱们看看如何使用 Basic Paxos 达成共识，解决开篇提到的那道思考题。</p><h3 id="如何达成共识"><a href="#如何达成共识" class="headerlink" title="如何达成共识"></a>如何达成共识</h3><p>&emsp;&emsp;在 Paxos 算法中，使用提案表示一个提议，提案包括提案编号和提议的值。接下来，我们使用 [n, v] 表示一个提案，其中，n 是提案编号，v 是提案的值。</p><p>&emsp;&emsp;在 Basic Paxos 中，集群中各个节点为了达成共识，需要进行 2 个阶段的协商，即准备（Prepare）阶段和接受（Accept）阶段。</p><h3 id="准备阶段"><a href="#准备阶段" class="headerlink" title="准备阶段"></a>准备阶段</h3><p>&emsp;&emsp;假设客户端 1 的提案编号是 1，客户端 2 的提案编号为 5，并假设节点 A, B 先收到来自客户端 1 的准备请求，节点 C 先收到来自客户端 2 的准备请求。</p><p>&emsp;&emsp;客户端作为提议者，向所有的接受者发送包含提案编号的准备请求。注意在准备阶段，请求中不需要指定提议的值，只需要包含提案编号即可。</p><p><img src="/img/2022-12-14-%E5%9B%BE%E8%A7%A3Paxos%E7%AE%97%E6%B3%95/pho3.png" alt="准备流程1" title="图3"></p><p>&emsp;&emsp;接下来，节点 A，B 接收到客户端 1 的准备请求（提案编号为1），节点 C 接收到客户端 2 的准备请求（提案编号为 5）。</p><p><img src="/img/2022-12-14-%E5%9B%BE%E8%A7%A3Paxos%E7%AE%97%E6%B3%95/pho4.png" alt="准备流程2" title="图4"></p><p>集群中各个节点在接收到第一个准备请求的处理：</p><ul><li>节点 A, B：由于之前没有通过任何提案，所以节点 A，B 将返回“尚无提案”的准备响应，并承诺以后不再响应提案编号小于等于 1 的准备请求，不会通过编号小于 1 的提案</li><li>节点 C：由于之前没有通过任何提案，所以节点 C 将返回“尚无提案”的准备响应，并承诺以后不再响应提案编号小于等于 5 的准备请求，不会通过编号小于 5 的提案</li></ul><p>接下来，当节点 A，B 接收到提案编号为 5 的准备请求，节点 C 接收到提案编号为 1 的准备请求：</p><p><img src="/img/2022-12-14-%E5%9B%BE%E8%A7%A3Paxos%E7%AE%97%E6%B3%95/pho5.png" alt="准备流程3" title="图5"></p><ul><li>节点 A, B：由于提案编号 5 大于之前响应的准备请求的提案编号 1，且节点 A, B 都没有通过任何提案，故均返回“尚无提案”的响应，并承诺以后不再响应提案编号小于等于 5 的准备请求，不会通过编号小于 5 的提案</li><li>节点 C：由于节点 C 接收到提案编号 1 小于节点 C 之前响应的准备请求的提案编号 5 ，所以丢弃该准备请求，不作响应</li></ul><h3 id="接受阶段"><a href="#接受阶段" class="headerlink" title="接受阶段"></a>接受阶段</h3><p>&emsp;&emsp;Basic Paxos 算法第二阶段为接受阶段。当客户端 1，2 在收到大多数节点的准备响应之后会开始发送接受请求。</p><p><img src="/img/2022-12-14-%E5%9B%BE%E8%A7%A3Paxos%E7%AE%97%E6%B3%95/pho6.png" alt="接受流程1" title="图6"></p><ul><li>客户端 1：客户端 1 接收到大多数的接受者（节点 A, B）的准备响应后，根据响应中的提案编号最大的提案的值，设置接受请求的值。由于节点 A, B 均返回“尚无提案”，即提案值为空，故客户端 1 把自己的提议值 "5" 作为提案的值，发送接受请求 [1, "5"]</li><li>客户端 2：客户端 2 接收到大多数接受者的准备响应后，根据响应中的提案编号最大的提案的值，设置接受请求的值。由于节点 A, B, C 均返回“尚无提案”，即提案值为空，故客户端 2 把自己的提议值 "7" 作为提案的值，发送接受请求 [5, "7"]</li></ul><p>&emsp;&emsp;当节点 A, B, C 接收到客户端 1, 2 的接受请求时，对接受请求进行处理：</p><p><img src="/img/2022-12-14-%E5%9B%BE%E8%A7%A3Paxos%E7%AE%97%E6%B3%95/pho7.png" alt="接受流程2" title="图7"></p><ul><li>节点 A, B, C 接收到接受请求 [1, "5"] ，由于提案编号 1 小于三个节点承诺可以通过的最小提案编号 5，所以提案 [1, "5"] 被拒绝</li><li>节点 A, B, C 接收到接受请求 [5, "7"]，由于提案编号 5 不小于三个节点承诺可以通过的最小提案编号 5 ，所以通过提案 [5, "7"]，即三个节点达成共识，接受 X 的值为 "7"</li></ul><p>&emsp;&emsp;如果集群中还有学习者，当接受者通过一个提案，就通知学习者，当学习者发现大多数接受者都通过了某个提案，那么学习者也通过该提案，接受提案的值。</p><h3 id="接受者存在已通过提案的情况"><a href="#接受者存在已通过提案的情况" class="headerlink" title="接受者存在已通过提案的情况"></a>接受者存在已通过提案的情况</h3><p>&emsp;&emsp;上面例子中，准备阶段和接受阶段均不存在接受者已经通过提案的情况。这里继续使用上面的例子，不过假设节点 A, B 已通过提案 [5, “7”]，节点 C 未通过任何提案；增加一个新的提议者客户端 3，客户端 3 的提案为 [9，”13”] 。</p><p>&emsp;&emsp;接下来，客户端 3 执行准备阶段和接受阶段；客户端 3 向节点 A, B, C 发送提案编号为 9 的准备请求：</p><p><img src="/img/2022-12-14-%E5%9B%BE%E8%A7%A3Paxos%E7%AE%97%E6%B3%95/pho8.png" alt="新准备流程1" title="图8"></p><ul><li>节点 A, B 接收到客户端 3 的准备请求，由于节点 A, B 已通过提案 [5, "7"]，故在准备响应中，包含此提案信息。</li><li>节点 C 接收到客户端 3 的准备请求，由于节点 C 未通过任何提案，故节点 C 将返回“尚无提案”的准备响应。</li></ul><p><img src="/img/2022-12-14-%E5%9B%BE%E8%A7%A3Paxos%E7%AE%97%E6%B3%95/pho9.png" alt="新准备流程2" title="图9"></p><ul><li>客户端 3 接收到节点 A, B, C 的准备响应后，向节点 A, B, C 发送接受请求。这里需要特点指出，客户端 3 会根据响应中的提案编号最大的提案的值，设置接受请求的值。</li><li>由于在准备响应中，已包含提案 [5, "7"]，故客户端 3 将接受请求的提案编号设置为 9，提案值设置为 "7" 即接受请求的提案为 [9, "7"]</li></ul><p><img src="/img/2022-12-14-%E5%9B%BE%E8%A7%A3Paxos%E7%AE%97%E6%B3%95/pho10.png" alt="新接受流程1" title="图10"></p><p>&emsp;&emsp;节点 A, B, C 接收到客户端 3 的接受请求，由于提案编号 9 不小于三个节点承诺可以通过的最小提案编号，故均通过提案 [9, “7”]。</p><p><img src="/img/2022-12-14-%E5%9B%BE%E8%A7%A3Paxos%E7%AE%97%E6%B3%95/pho11.png" alt="新接受流程2" title="图11"></p><p>概括来说，Basic Paxos 具有以下特点：</p><ul><li>Basic Paxos 通过二阶段方式来达成共识，即准备阶段和接受阶段</li><li>Basic Paxos 除了达成共识功能，还实现了容错，在少于一半节点出现故障时，集群也能工作</li><li>提案编号大小代表优先级。对于提案编号，接受者提供三个承诺：</li><ul><li>如果准备请求的提案编号，小于等于接受者已经响应的准备请求的提案编号，那么接受者承诺不响应这个准备请求</li><li>如果接受请求中的提案编号，小于接受者已经响应的准备请求的提案编号，那么接受者承诺不通过这个提案</li><li>如果按受者已通过提案，那些接受者承诺会在准备请求的响应中，包含已经通过的最大编号的提案信息</li></ul></ul><blockquote><p>参考：</p><ol><li><a target="_blank" rel="noopener external nofollow noreferrer" href="https://time.geekbang.org/column/intro/279">极客时间 — —《分布式协议与算法》</a></li><li><a target="_blank" rel="noopener external nofollow noreferrer" href="https://leehao.me/%E5%9B%BE%E8%A7%A3-Paxos-%E7%AE%97%E6%B3%95/">图解 Paxos 算法</a></li></ol></blockquote><br><div id="comment-container"></div><div id="disqus_thread"></div><div id="lv-container"></div><div class="giscus"></div></div></div></div></div><footer class="footer"><ul class="list-inline text-center"><li><a target="_blank" href="https://github.com/wu3227834" rel="external nofollow noreferrer"><span class="fa-stack fa-lg"><i class="iconfont icon-github"></i></span></a></li></ul><p><span id="busuanzi_container_site_pv"><span id="busuanzi_value_site_pv"></span>PV </span><span id="busuanzi_container_site_uv"><span id="busuanzi_value_site_uv"></span>UV </span>Created By <a target="_blank" rel="noopener external nofollow noreferrer" href="https://hexo.io/">Hexo</a> Theme <a target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/aircloud/hexo-theme-aircloud">AirCloud</a></p></footer><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.js"></script><script type="text/javascript" src="https://apps.bdimg.com/libs/jquery/2.1.4/jquery.min.js"></script><script type="text/javascript" src="/js/clipboard.js"></script><script type="text/x-mathjax-config">MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [ ["$","$"], ["\\(","\\)"] ],
            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'],
            processEscapes: true
        }
    });
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax();
        for (var i = 0; i < all.length; ++i)
            all[i].SourceElement().parentNode.className += ' has-jax';
    });</script><script src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script></body><script>window.hexo_search_path="search.json",window.hexo_root="/",window.isPost=!0</script><script src="/js/index.js"></script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="/js/jquery.min.js"></script><script src="/js/prism.js"></script><script src="https://giscus.app/client.js" data-repo="wu3227834/wu3227834.github.io" data-repo-id="R_kgDOIh8vuA" data-category="General" data-category-id="DIC_kwDOIh8vuM4CpDjz" data-mapping="pathname" data-strict="0" data-reactions-enabled="1" data-emit-metadata="0" data-input-position="bottom" data-theme="preferred_color_scheme" data-lang="zh-CN" crossorigin="anonymous" async></script></html><script src="/js/fancybox/jquery.fancybox.min.js" key="fancybox_js"></script><script src="/js/fancybox/wrapImage.js" key="wrap_image_js"></script><link rel="stylesheet" href="/js/fancybox/jquery.fancybox.min.css" key="fancybox_css">